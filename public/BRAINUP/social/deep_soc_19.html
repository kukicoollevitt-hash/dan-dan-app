<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>BRAIN딥 | 사회문화 19</title>

  <!-- 공통 CSS -->
  <link rel="stylesheet" href="/assets/css/learning-common.css">
  
  <!-- 파비콘 404 방지 -->
  <link rel="icon" href="data:,">

  <!-- ✅ 단원 인식 (HTML에서 먼저 설정) -->
  <script>
  (function () {
    const qs = new URLSearchParams(location.search).get('unit');
    let unit = null;

    if (qs) {
      const m = qs.toLowerCase().match(/deep_soc[_-]?(\d{1,2})/);
      if (m) unit = `deep_soc_${m[1].padStart(2,'0')}`;
    }

    if (!unit) {
      const m2 = location.pathname.toLowerCase().match(/deep_soc[_-]?(\d{1,2})\.html/);
      if (m2) unit = `deep_soc_${m2[1].padStart(2,'0')}`;
    }

    if (!unit && document.title) {
      const m3 = document.title.match(/(\d{1,2})/);
      if (m3) unit = `deep_soc_${m3[1].padStart(2,'0')}`;
    }

    window.CUR_UNIT = unit || 'deep_soc_19';
    console.log('[soc_19.html] CUR_UNIT =', window.CUR_UNIT);

    // 분석리포트 탭으로 새로고침된 경우 스피너 즉시 숨김
    const savedTab = localStorage.getItem(`current-geo-tab:${window.CUR_UNIT}`);
    if (savedTab === 'report') {
      document.addEventListener('DOMContentLoaded', () => {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.remove('show');
      });
    }
  })();

  (function () {
    const cur = (window.CUR_UNIT || 'deep_soc_19');
    const m = cur.match(/soc_(\d{1,2})/);
    const no = m ? m[1].padStart(2,'0') : '01';

    window.PAGE_KEY = `BRAINUP_social_deep_soc_${no}`;
    console.log('[soc_19.html] PAGE_KEY =', window.PAGE_KEY);
  })();
  </script>

  <!-- 공통 JavaScript -->
  <script src="/assets/js/learning-common.js?v=20251202c"></script>

  <!-- AI 과제 복습 완료 처리 -->
  <script src="./ai-task-common.js"></script>

  <!-- 캡처 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <!-- 로딩 오버레이 -->
  <div id="loadingOverlay" class="show">
    <div class="loading-spinner"></div>
    <div class="loading-text">콘텐츠를 불러오는 중...</div>
  </div>

  <!-- 상단 탭 -->
  <div class="top-tabs">
    <div class="tab-btn active" data-tab="reading">✏️ 본문학습</div>
    <div class="tab-btn" data-tab="vocab">📖 어휘학습</div>
    <div class="tab-btn" data-tab="creative">💡 창의활동</div>
    <div class="tab-btn tab-report" data-tab="report">🔍 분석리포트</div>

    <!-- 오른쪽 고정 학생정보 -->
    <div class="student-info">
      <label>학년 :</label>
      <input type="text" id="student-grade" placeholder="예: 5학년">
      <label>이름 :</label>
      <input type="text" id="student-name" placeholder="이름">
    </div>
  </div>

  <!-- ===== 본문학습 탭 ===== -->
  <div id="tab-reading" class="tab-panel active">
    <div class="learning-layout" id="capture-reading">
      <!-- 왼쪽 지문 -->
      <div class="left-passage">
        <div class="passage-wrap">
          <!-- ✅ 사회문화 01 -->
          <div class="passage-label"><span>BRAIN딥ㅣ사회문화</span><strong>01</strong></div>
          <h1 class="passage-title"></h1>
          <div class="passage-text">
          </div>
          <div class="passage-vocab">
            <ol>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
            </ol>
          </div>
        </div>
      </div>

      <!-- 오른쪽 문제 -->
      <div class="right-quiz">
        <!-- 시간 입력 -->
        <div class="quiz-header">
          <div class="date-box">
            <span class="calendar-icon" id="calendar-icon" onclick="toggleCalendar()">📅</span>
            <div class="time-group date-group"><label>월</label><input id="month-input" type="number" placeholder="11"></div>
            <div class="time-group date-group"><label>일</label><input id="day-input" type="number" placeholder="10"></div>
          </div>
          <div class="timer-box">
            <span class="timer-icon" id="timer-icon" onclick="toggleTimer()">⏰</span>
            <div class="time-group timer-group"><label>분</label><input id="minute-input" type="number" placeholder="05"></div>
            <div class="time-group timer-group"><label>초</label><input id="second-input" type="number" placeholder="00"></div>
          </div>
        </div>

        <!-- 문제들 -->
        <div class="quiz-section">
          <div class="quiz-subtitle">객관식 문제</div>

          <!-- 1 -->
          <div class="quiz-block">
            <div class="quiz-num">01<div class="mark"></div></div>
            <div class="quiz-content">
              <p class="quiz-q">이 글에서 설명하는 가족의 특징으로 가장 알맞은 것은 무엇인가요?</p>
              <ul class="quiz-options">
                <li><label><input type="radio" name="q1" value="1"><span>① 가족은 반드시 피를 나눈 사람들끼리만 이루어진다.</span></label></li>
                <li><label><input type="radio" name="q1" value="2"><span>② 가족은 혼인, 혈연뿐 아니라 입양이나 재혼으로도 이루어질 수 있다.</span></label></li>
                <li><label><input type="radio" name="q1" value="3"><span>③ 가족은 반드시 한집에 함께 살아야만 가족이라 할 수 있다.</span></label></li>
                <li><label><input type="radio" name="q1" value="4"><span>④ 가족은 사회와 나라의 발전에 영향을 주지 않는다.</span></label></li>
              </ul>
            </div>
          </div>

          <!-- 2 -->
          <div class="quiz-block">
            <div class="quiz-num">02<div class="mark"></div></div>
            <div class="quiz-content">
              <p class="quiz-q">글에서 '가정'에 대한 설명으로 가장 적절한 것은 무엇인가요?</p>
              <ul class="quiz-options">
                <li><label><input type="radio" name="q2" value="1"><span>① 가정은 가족이 함께 살지 않아도 되는 공간이다.</span></label></li>
                <li><label><input type="radio" name="q2" value="2"><span>② 가정은 사회를 이루는 가장 큰 단위이다.</span></label></li>
                <li><label><input type="radio" name="q2" value="3"><span>③ 가정은 가족 구성원이 생활하는 공간이자 사회의 기본 단위이다.</span></label></li>
                <li><label><input type="radio" name="q2" value="4"><span>④ 가정은 가족과 전혀 관련이 없는 개념이다.</span></label></li>
              </ul>
            </div>
          </div>
<!-- 3 -->
          <div class="quiz-block">
            <div class="quiz-num">03<div class="mark"></div></div>
            <div class="quiz-content">
              <p class="quiz-q">다음 중 밑줄 친 어휘의 의미가 적절하지 않은 것은?</p>
              <ul class="quiz-options">
                <li><label><input type="radio" name="q3" value="1"><span>① <u>법치주의</u>는 권력자의 자의적 지배를 막고 모든 사람이 <u>법</u> 앞에 평등하게 대우받도록 보장한다. - 법치주의: 법에 의한 통치 원리, 법: 국가 권력에 의해 강제되는 사회 규범</span></label></li>
                <li><label><input type="radio" name="q3" value="2"><span>② <u>형식적 법치주의</u>는 법의 형식과 절차만 갖추면 합법적이라고 보지만, <u>실질적 법치주의</u>는 법의 내용도 정의와 인권에 부합해야 한다고 본다. - 형식적 법치주의: 형식 중심, 실질적 법치주의: 내용의 정당성까지 요구</span></label></li>
                <li><label><input type="radio" name="q3" value="3"><span>③ <u>공법</u>은 국가와 개인 간의 관계를 규율하고, <u>사법</u>은 개인 간의 관계를 규율한다. - 공법: 헌법, 형법, 행정법 등, 사법: 민법, 상법 등</span></label></li>
                <li><label><input type="radio" name="q3" value="4"><span>④ <u>사회법</u>은 형식적 평등만으로 실질적 정의를 실현할 수 있다는 인식에서 등장했으며, <u>국제법</u>은 국내법보다 항상 우선 적용된다. - 사회법: 형식적 평등으로 정의 실현 가능, 국제법: 국내법에 우선</span></label></li>
              </ul>
            </div>
          </div>


          <!-- 4 -->
          <div class="quiz-block">
            <div class="quiz-num">04<div class="mark"></div></div>
            <div class="quiz-content">
              <p class="quiz-q">글의 내용을 바탕으로 추론한 내용으로 적절하지 않은 것은?</p>
              <ul class="quiz-options">
                <li><label><input type="radio" name="q4" value="1"><span>① 죄형법정주의는 법률에 규정되지 않은 행위를 처벌할 수 없다고 규정함으로써, 국가가 형벌권을 자의적으로 행사하는 것을 막고 개인의 자유를 보장하는 역할을 한다.</span></label></li>
                <li><label><input type="radio" name="q4" value="2"><span>② 나치 독일의 사례는 합법적 절차를 거쳐 제정된 법이라도 인권을 침해할 수 있음을 보여주며, 이는 법의 내용까지 정의와 인권에 부합해야 한다는 실질적 법치주의의 필요성을 뒷받침한다.</span></label></li>
                <li><label><input type="radio" name="q4" value="3"><span>③ 사회법의 등장은 형식적으로 평등한 법만으로는 자본주의 발전 과정에서 발생한 사회적 불평등을 해결할 수 없다는 인식을 반영하며, 노동법과 사회보장법 등이 이에 해당한다.</span></label></li>
                <li><label><input type="radio" name="q4" value="4"><span>④ 민사법이 사적 자치의 원칙을 따른다는 것은 국가가 개인 간의 모든 법률 관계에 적극적으로 개입하여 결정하고, 당사자의 의사와 무관하게 법률 관계를 형성한다는 의미이다.</span></label></li>
              </ul>
            </div>
          </div>

          <div class="quiz-subtitle">서술형 문제</div>
          <!-- 5 -->
          <div class="quiz-block">
            <div class="quiz-num">05<div class="mark"></div></div>
            <div class="quiz-content">
              <p class="quiz-q">
                글에서 "가정이 기능을 제대로 잘해야 사회와 나라도 건강하게 발전할 수 있다"고 했습니다.
                이 말이 어떤 의미인지 자신의 말로 설명해 보세요.
              </p>
              <div class="answer-box">
                <textarea id="q5"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- 우측 하단 채점 -->
        <div id="grade-result" class="grade-result"></div>
        <div class="grade-area">
          <button id="reset-btn" class="reset-btn" style="display:none;" onclick="resetQuiz()">다시풀기</button>
          <button id="save-progress-btn" class="grade-btn" style="background:#d32f2f;" onclick="saveReadingProgress()">📋 채점 및 제출하기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== 어휘학습 탭 ===== -->
  <div id="tab-vocab" class="tab-panel">
    <div class="vocab-box" id="capture-vocab">
      <div class="vocab-header">
        <div class="vocab-badge">
          <svg class="vocab-badge-timer" viewBox="0 0 110 110">
            <circle cx="55" cy="55" r="51"></circle>
          </svg>
          <div class="vocab-badge-text">제한시간<br><span class="time-big">3분</span></div>
        </div>
        <div class="vocab-message">✏️ 본문학습 지문에 해당하는 어휘를 채워 봅시다.</div>
        <div class="vocab-char-box">
        </div>
      </div>

      <div class="vocab-fill-text">
        
      </div>

      <div id="vocab-result" class="vocab-result"></div>

      <div class="vocab-actions">
        <button id="vocab-reset" class="vocab-btn secondary" style="display:none;" onclick="vocabReset()">다시풀기</button>
        <button id="vocab-save" class="vocab-btn" style="background:#d32f2f;" onclick="vocabSaveToServer()">채점 및 제출하기</button>
      </div>

      <script>
      function vocabSaveToServer() {
        const blanks = document.querySelectorAll('#tab-vocab .blank-wrap');
        const vocabResultBox = document.getElementById('vocab-result');
        const vocabSaveBtn = document.getElementById('vocab-save');
        const vocabResetBtn = document.getElementById('vocab-reset');

        let correctCnt = 0;
        const total = blanks.length;
        const msgs = [];

        blanks.forEach((bw, idx) => {
          const ans = bw.dataset.answer.trim();
          const input = bw.querySelector('.blank-input');
          const userVal = input.value.trim();
          const mark = bw.querySelector('.blank-mark');

          bw.classList.remove('correct', 'wrong');

          const aliases = ans.split(',').map(a => a.trim().toLowerCase());
          const isCorrect = aliases.includes(userVal.toLowerCase());

          if (isCorrect) {
            correctCnt++;
            bw.classList.add('correct');
            if (mark) mark.textContent = '✔';
            msgs.push(`${idx + 1}. ${userVal} ✅`);
          } else {
            bw.classList.add('wrong');
            if (mark) mark.textContent = '✘';
            msgs.push(`${idx + 1}. ${userVal || '(미입력)'} ❌ → 정답: ${ans.split(',')[0]}`);
          }

          input.disabled = true;
        });

        const score = total > 0 ? Math.round((correctCnt / total) * 100) : 0;
        vocabResultBox.innerHTML = `<p><strong>점수: ${correctCnt} / ${total} (${score}점)</strong></p><p>${msgs.join('<br>')}</p>`;
        vocabResultBox.style.display = 'block';

        vocabSaveBtn.style.display = 'none';
        vocabResetBtn.style.display = 'inline-block';

        const stu = window.getStudentInfo ? window.getStudentInfo() : null;
        if (!stu || !stu.grade || !stu.name) {
          showSubmitOverlay('학년과 이름을 입력해주세요');
          return;
        }

        const vocabData = [];
        blanks.forEach(bw => {
          const input = bw.querySelector('.blank-input');
          const mark = bw.querySelector('.blank-mark');
          vocabData.push({
            value: input.value,
            isCorrect: bw.classList.contains('correct'),
            isWrong: bw.classList.contains('wrong'),
            markText: mark ? mark.textContent : ''
          });
        });

        const dataToSave = {
          vocabState: {
            vocabData: vocabData,
            resultHTML: vocabResultBox.innerHTML,
            isGraded: true,
            score: score,
            correctCount: correctCnt,
            totalCount: total
          }
        };

        if (typeof window.saveUnitProgressToServer === 'function') {
          window.saveUnitProgressToServer(dataToSave).then(() => {
            return captureElementToPDF('capture-vocab', '단단국어_어휘학습.pdf', { withStudentInfo: true });
          }).then(() => {
            showSubmitSuccess('어휘학습');
          }).catch(err => {
            console.error('[vocabSaveToServer] 실패:', err);
            alert('저장 실패: ' + err.message);
          });
        } else {
          captureElementToPDF('capture-vocab', '단단국어_어휘학습.pdf', { withStudentInfo: true }).then(() => {
            showSubmitSuccess('어휘학습');
          });
        }
      }

      function vocabReset() {
        const blanks = document.querySelectorAll('#tab-vocab .blank-wrap');
        const vocabResultBox = document.getElementById('vocab-result');
        const vocabSaveBtn = document.getElementById('vocab-save');
        const vocabResetBtn = document.getElementById('vocab-reset');

        blanks.forEach(bw => {
          const input = bw.querySelector('.blank-input');
          const mark = bw.querySelector('.blank-mark');
          input.value = '';
          input.disabled = false;
          bw.classList.remove('correct', 'wrong');
          if (mark) mark.textContent = '';
        });

        vocabResultBox.innerHTML = '';
        vocabResultBox.style.display = 'none';
        vocabSaveBtn.style.display = 'inline-block';
        vocabResetBtn.style.display = 'none';
      }
      </script>
    </div>
  </div>

  <!-- ===== 창의활동 탭 ===== -->
  <div id="tab-creative" class="tab-panel">
    <div class="creative-box" id="capture-creative">
      <div class="creative-title">Ai고래쌤과 함께하는 창의활동 — 우리 가족 이야기 소개하기</div>
      <div style="text-align: left; color: #666; font-size: 14px; margin-top: 8px; margin-bottom: 12px;">
        글쓰기 중 궁금하거나 어려운 점이 있으면 우측 하단 Ai고래쌤을 클릭 후 '글쓰기' 선택해서 물어보세요!
      </div>

      <!-- 주제/힌트 박스 -->
      <div class="creative-topic-box">
        <div>
          <strong>주제:</strong>
          <strong>"우리 가족만의 특별한 점이나 행복한 순간을 소개해 보자."</strong>
        </div>
        <div class="creative-hint">
          💡 힌트) '우리 가족만의 특별한 규칙', '가장 기억에 남는 가족 여행', '우리 집에서만 하는 재미있는 놀이', '가족과 함께할 때 가장 행복한 순간' 등 한 가지 주제로 쓰면 좋아요.
        </div>
      </div>

      <!-- 예시 박스 -->
      <div class="creative-examples-box">
        <div class="example-title">📝 작성 예시</div>
        <div>예시 1) 우리 가족은 매주 일요일 저녁에 다 같이 모여 보드게임을 하는 특별한 규칙이 있다. 이 시간이 일주일 중 가장 기다려지는 순간이다.</div>
        <div>예시 2) 작년 여름 할머니 댁에 갔을 때 온 가족이 함께 수박을 먹으며 별을 본 것이 가장 행복한 기억이다.</div>
        <div>예시 3) 우리 가족은 혈연으로 이어진 가족은 아니지만, 서로 사랑하고 돌봐주는 진짜 가족이라고 생각한다.</div>
      </div>

      <!-- 🔶 창의활동 입력/제출 영역 (교체본) -->
      <div id="creative-input-wrap">
        <!-- 🔸 창의활동 textarea -->
        <textarea id="creative-input"
                  class="creative-textarea"
                  rows="10"
                  placeholder="맞춤법과 띄어쓰기에 맞게 자유롭게 적어보세요."></textarea>

        <!-- 🔸 PDF 전용 렌더 박스 -->
        <div id="creative-render"
             style="display:none; white-space:pre-wrap; font-size:16px; line-height:1.8;"></div>

        <!-- 🔸 맞춤법 검사 결과 영역 -->
        <div id="spelling-result" class="creative-result">
          <div id="spelling-errors"></div>
        </div>

        <!-- 🔸 올바른 맞춤법 영역 -->
        <div id="spelling-correct" class="creative-result">
          <div id="spelling-corrected"></div>
        </div>

        <!-- 🔸 맞춤법 검사 & 제출 버튼 -->
        <div class="creative-actions">
          <button type="button" id="creative-check-btn" class="creative-btn">맞춤법 검사</button>
          <button type="button" id="creative-submit-btn" class="creative-btn">제출하기</button>
        </div>
      </div>

    </div>
  </div>

  <!-- 맞춤법 검사 로딩 팝업 -->
  <div id="spell-check-loading" class="spell-check-loading">
    <div class="spell-check-loading-content">
      <div class="spell-check-spinner"></div>
      <div class="spell-check-loading-text">맞춤법 검사 중입니다...</div>
    </div>
  </div>

  <!-- ===== 분석리포트 탭 ===== -->
  <div id="tab-report" class="tab-panel">
    <!-- ✅ 캡처용 래퍼 -->
    <div class="report-wrap" id="capture-report">
      <h2 class="report-title">분석리포트</h2>
      <p class="report-desc">
        본문학습 객관식 + 빈 칸 + 서술형 + 어휘학습으로 아래 5가지 문해역량을 진단합니다.
      </p>

      <!-- 레이더 차트 -->
      <div class="report-chart-box">
        <canvas id="report-radar" width="360" height="360"></canvas>
      </div>

      <!-- 기존 오각형 설명 (UI 보존) -->
      <div class="report-pentagon">
        <div class="rp rp-1"><span class="rp-label">① 핵심 이해력</span><span class="rp-sub">(객관식)</span></div>
        <div class="rp rp-2"><span class="rp-label">② 구조 파악력</span><span class="rp-sub">(객관식)</span></div>
        <div class="rp rp-3"><span class="rp-label">③ 어휘 맥락력</span><span class="rp-sub">(어휘학습)</span></div>
        <div class="rp rp-4"><span class="rp-label">④ 추론·통합력</span><span class="rp-sub">(빈칸)</span></div>
        <div class="rp rp-5"><span class="rp-label">⑤ 비판·적용력</span><span class="rp-sub">(서술형)</span></div>
      </div>

      <!-- 결과 로그 -->
      <div class="report-log" id="report-log">
        아직 채점 결과가 없습니다. 먼저 ‘본문학습’에서 채점을 해주세요.
      </div>

      <!-- ✅ 제출하기 버튼 -->
      <div class="report-actions">
        <button class="report-btn-remedial" onclick="openRemedial && openRemedial()" style="display:none;">
          보완학습 하기
        </button>
        <button class="report-btn-submit" onclick="submitReport()">
          분석리포트 제출하기
        </button>
      </div>
    </div>
  </div>

  <!-- 제출 오버레이 -->
  <div id="submit-overlay">
    <div class="box" id="submit-overlay-text">제출되었습니다 ✅</div>
  </div>

  <!-- 뒤로 가기 확인 팝업 -->
  <div id="back-confirm-overlay">
    <div class="back-confirm-box">
      <div class="back-confirm-icon">🐬</div>
      <div class="back-confirm-title">학습을 종료하시겠어요?</div>
      <div class="back-confirm-message">
        지금까지 작성한 내용이<br>저장되지 않을 수 있습니다.
      </div>
      <div class="back-confirm-buttons">
        <button class="back-confirm-btn cancel" onclick="hideBackConfirm()">계속 학습하기</button>
        <button class="back-confirm-btn confirm" onclick="goToMenu()">메뉴로 이동</button>
      </div>
    </div>
  </div>

  <script>
    console.log('[soc_19.html] 메인 스크립트 시작');

    /* ===== 전역 리포트 상태 ===== */
    let reportState = { q1ok:false, q2ok:false, q3ok:false, q4ok:false, q5ok:false, vocabScoreRatio:0 };

    /* ===== 탭 전환 ===== */
    // 분석리포트 새로고침 함수
    function refreshReportTab() {
      try {
        const saved = localStorage.getItem(`dan-soc-report-state:${window.CUR_UNIT}`);
        if (saved) {
          const savedReportState = JSON.parse(saved);

          // 리포트 패널 업데이트
          updateReportPanel({
            q1ok: savedReportState.q1ok || false,
            q2ok: savedReportState.q2ok || false,
            q3ok: savedReportState.q3ok || false,
            q4ok: savedReportState.q4ok || false,
            q5ok: savedReportState.q5ok || false
          });

          // 레이더 차트 업데이트
          drawRadarChart({
            literal: savedReportState.literal || 0,
            structural: savedReportState.structural || 0,
            lexical: savedReportState.lexical || 0,
            inferential: savedReportState.inferential || 0,
            critical: savedReportState.critical || 0
          });
        }
      } catch(e) {
        console.error('Failed to refresh report:', e);
      }
    }

    // 탭 활성화 함수
    function activateTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

      const targetBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      const targetPanel = document.getElementById('tab-' + tabName);

      if (targetBtn && targetPanel) {
        targetBtn.classList.add('active');
        targetPanel.classList.add('active');

        // 분석리포트 탭인 경우 데이터 새로고침
        if (tabName === 'report') {
          refreshReportTab();
        }

        // 어휘학습 탭인 경우 지문 렌더링
        if (tabName === 'vocab') {
          const fn = window.renderVocabFromContent || window.renderVocabFill;
          if (typeof fn === 'function') {
            fn();
          }
        }
      }
    }

    // 탭 버튼 클릭 이벤트
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tab;
        const unit = window.CUR_UNIT || 'deep_soc_19';;
        activateTab(target);
        // 현재 탭을 단원별로 localStorage에 저장
        localStorage.setItem(`current-geo-tab:${unit}`, target);
      });
    });

    // 페이지 로드 시 항상 본문학습 탭으로 시작
    window.addEventListener('DOMContentLoaded', () => {
      const unit = window.CUR_UNIT || 'deep_soc_19';
      const savedTab = localStorage.getItem(`current-geo-tab:${unit}`);
      if (savedTab === 'report') {
        activateTab('report');
      } else {
        activateTab('reading');
      }
    });

    /* ===== 뒤로 가기 확인 팝업 ===== */
    function showBackConfirm() {
      const overlay = document.getElementById('back-confirm-overlay');
      if (overlay) {
        overlay.classList.add('show');
      }
    }

    function hideBackConfirm() {
      const overlay = document.getElementById('back-confirm-overlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    function goToMenu() {
      // iframe 내부에서 실행 중인지 확인
      if (window.parent && window.parent !== window) {
        // 부모 창(menu.html)의 모달 닫기 함수 호출
        try {
          if (window.parent.closeUnitModal) {
            window.parent.closeUnitModal();
          }
        } catch (e) {
          console.log('모달 닫기 실패, 페이지 이동:', e);
          window.location.href = '/menu.html';
        }
      } else {
        // 일반 브라우저에서 직접 열었을 때는 메뉴로 이동
        window.location.href = '/menu.html';
      }
    }

    // 브라우저 뒤로 가기 감지
    window.addEventListener('popstate', (e) => {
      e.preventDefault();
      showBackConfirm();
      // 히스토리를 다시 앞으로 밀어서 뒤로 가기를 막음
      history.pushState(null, '', location.href);
    });

    // 페이지 로드 시 히스토리 상태 추가
    window.addEventListener('load', () => {
      history.pushState(null, '', location.href);
    });

    /* ===== 원형 스탑워치 ===== */
    let timer, seconds = 0, isRunning = false;
    const RADIUS = 45;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
    const TOTAL_SECONDS = 600; // 10분
    function formatTime(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }
    function updateDisplay(){ const t=document.getElementById("timer-text"); if (t) t.textContent = formatTime(seconds); updateRing(); }
    function updateRing(){ const c=document.querySelector(".timer-ring .progress"); if(!c) return; const r=(seconds%TOTAL_SECONDS)/TOTAL_SECONDS; c.style.strokeDashoffset = CIRCUMFERENCE - r*CIRCUMFERENCE; }
    function startTimer(){ if(!isRunning){ isRunning=true; const b=document.getElementById("timer-display"); b.classList.remove("paused","reset"); b.classList.add("active"); timer=setInterval(()=>{ seconds++; updateDisplay(); },1000);} }
    function pauseTimer(){ clearInterval(timer); isRunning=false; const b=document.getElementById("timer-display"); b.classList.remove("active"); b.classList.add("paused"); }
    function resetTimer(){ clearInterval(timer); isRunning=false; const m=document.getElementById("minute-input"), s=document.getElementById("second-input"); if(m) m.value=Math.floor(seconds/60); if(s) s.value=seconds%60; seconds=0; updateDisplay(); const b=document.getElementById("timer-display"); b.classList.remove("active","paused"); b.classList.add("reset"); }

    /* ===== 공통: 학생정보/파일명 ===== */
    function getStudentInfo(){ const grade=document.getElementById('student-grade')?.value.trim()||''; const name=document.getElementById('student-name')?.value.trim()||''; return {grade,name}; }
    function ensureStudentInfo(){ const {grade,name}=getStudentInfo(); return grade!=='' && name!==''; }
    function buildFilename(base){ const {grade,name}=getStudentInfo(); let extra=''; if(grade) extra+='_'+grade; if(name) extra+='_'+name; extra=extra.replace(/[\/\\\s]+/g,'_'); return base.replace(/\.pdf$/,'')+extra+'.pdf'; }

    /* ===== 캡처 → PDF ===== */
    async function captureElementToPDF(elementId, filenameBase, options = {}) {
      try {
        window.scrollTo(0,0);
        const target = document.getElementById(elementId);
        if (!target) return;

        const finalFilename = buildFilename(filenameBase);

        const prevPosition = target.style.position;
        let tempInfo = null;
        if (options.withStudentInfo) {
          const { grade, name } = getStudentInfo();
          if (!target.style.position || target.style.position === '') target.style.position = 'relative';

          tempInfo = document.createElement('div');
          tempInfo.innerHTML = `<strong>학년:</strong> ${grade || '-'} &nbsp; | &nbsp; <strong>이름:</strong> ${name || '-'}`;
          tempInfo.style.position = 'absolute';
          tempInfo.style.top = '0'; tempInfo.style.left = '0'; tempInfo.style.right = '0';
          tempInfo.style.background = '#fff7ea'; tempInfo.style.borderBottom = '1px solid #f3d3b4';
          tempInfo.style.padding = '6px 12px'; tempInfo.style.fontSize = '13px'; tempInfo.style.color = '#5b4334';
          tempInfo.style.zIndex = '999'; tempInfo.style.pointerEvents = 'none';
          target.appendChild(tempInfo);
        }

        const canvas = await html2canvas(target, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = pdf.internal.pageSize.getHeight();

        const imgW = pdfW;
        const imgH = canvas.height * imgW / canvas.width;

        let heightLeft = imgH;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgW, imgH);
        heightLeft -= pdfH;

        while (heightLeft > 0) {
          position = heightLeft - imgH;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgW, imgH);
          heightLeft -= pdfH;
        }

        if (tempInfo) target.removeChild(tempInfo);
        target.style.position = prevPosition;

        pdf.save(finalFilename);
      } catch (e) {
        console.error(e);
        alert("PDF 만드는 중에 이미지 때문에 캡처가 막혔어. BRAINON.png를 빼거나 같은 경로로 옮겨줘!");
      }
    }

    /* ===== 오버레이 ===== */
    function showSubmitOverlay(message) {
      const overlay = document.getElementById("submit-overlay");
      const textBox = document.getElementById("submit-overlay-text");
      textBox.textContent = message;
      overlay.style.display = "flex";
      overlay.classList.add("show");
      setTimeout(() => { overlay.classList.remove("show"); overlay.style.display = "none"; }, 2600);
    }
    function showSubmitSuccess(kind) {
      const { grade, name } = getStudentInfo();
      const who = (grade || name) ? `${grade ? grade + ' ' : ''}${name ? name + ' ' : ''}`.trim() + ' ' : '';
      showSubmitOverlay(`${who}${kind} 제출되었습니다 ✅`);
    }

    /* ===== 분석리포트 갱신 ===== */
    // feedbackMessages, getRandomMessage, updateReportPanel은 learning-common.js에서 정의됨

    /* ===== 레이더 차트 ===== */
    function drawRadarChart(scores) {
      const canvas = document.getElementById('report-radar');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      const cx = w/2, cy = h/2, maxR = 130, steps = 5, maxScore = 10;

      const labels = ["① 핵심 이해력","② 구조 파악력","③ 어휘 맥락력","④ 추론·통합력","⑤ 비판·적용력"];
      const values = [scores.literal, scores.structural, scores.lexical, scores.inferential, scores.critical];

      ctx.strokeStyle = "#d3c9bd"; ctx.lineWidth = 1;
      for (let s=1; s<=steps; s++){
        const r = (maxR/steps)*s; ctx.beginPath();
        for (let i=0;i<5;i++){
          const ang = -Math.PI/2 + (Math.PI*2/5)*i;
          const x = cx + r*Math.cos(ang), y = cy + r*Math.sin(ang);
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath(); ctx.stroke();
      }

      ctx.fillStyle = "#3b2f27"; ctx.font = "bold 12px sans-serif";
      for (let i=0;i<5;i++){
        const ang = -Math.PI/2 + (Math.PI*2/5)*i;
        const x = cx + maxR*Math.cos(ang), y = cy + maxR*Math.sin(ang);
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
        const lx = cx + (maxR+22)*Math.cos(ang), ly = cy + (maxR+22)*Math.sin(ang);
        ctx.textAlign = "center"; ctx.fillText(labels[i], lx, ly);
      }

      ctx.beginPath();
      for (let i=0;i<5;i++){
        const ang = -Math.PI/2 + (Math.PI*2/5)*i;
        const ratio = Math.max(0, Math.min(values[i]/maxScore, 1));
        const r = maxR * ratio;
        const x = cx + r*Math.cos(ang), y = cy + r*Math.sin(ang);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.closePath(); ctx.fillStyle="rgba(192,74,59,0.25)"; ctx.fill();
      ctx.strokeStyle="#c04a3b"; ctx.lineWidth=2; ctx.stroke();

      ctx.fillStyle="#c04a3b";
      for (let i=0;i<5;i++){
        const ang = -Math.PI/2 + (Math.PI*2/5)*i;
        const ratio = Math.max(0, Math.min(values[i]/maxScore, 1));
        const r = maxR * ratio;
        const x = cx + r*Math.cos(ang), y = cy + r*Math.sin(ang);
        ctx.beginPath(); ctx.arc(x,y,3.5,0,Math.PI*2); ctx.fill();
      }
    }

    /* ===== 본문 채점 ===== */
    let readingResultHTML = "";
    function gradeQuiz() {
      const answerKey = {
        q1: "2",
        q2: "3",
        q3_1: ["경계"],
        q3_2: ["일반도"],
        q4_1: ["디지털", "디지털지도", "디지털 지도"],
        q4_2: ["실시간"]
      };
      const explain = {
        q1: "해설: 지도에는 단순 길 안내를 넘어 지역의 생활 모습과 자연환경 정보가 들어 있어 세상을 이해하는 창이 됨.",
        q2: "해설: 주제도는 교통·관광·기후처럼 한 주제에 집중해 정보를 표현하는 지도.",
        q3: "해설: 산과 강, 도시와 나라의 경계를 보여 주는 지도는 '일반도'라고 합니다.",
        q4: "해설: 디지털 지도는 전자기기에서 실시간으로 정보를 확인할 수 있는 지도입니다.",
        q5: "서술형 예시: 지도를 통해 지역의 구조, 사람들의 생활, 자연환경을 함께 읽어내는 사람이라는 뜻."
      };

      const quizBlocks = document.querySelectorAll('#tab-reading .quiz-block');
      const numLabels = ["01","02","03","04","05"];
      quizBlocks.forEach((block, idx) => {
        const numEl = block.querySelector('.quiz-num');
        const markEl = numEl.querySelector('.mark');
        numEl.textContent = numLabels[idx];
        numEl.appendChild(markEl);
        numEl.classList.remove('correct','wrong');
        markEl.textContent = "";
      });

      let score = 0;
      let totalAuto = 4;
      let shortMsgs = [];
      let fullMsgs = [];

      // 1번
      const q1 = document.querySelector('input[name="q1"]:checked');
      const q1Num = quizBlocks[0].querySelector('.quiz-num');
      const q1Mark = q1Num.querySelector('.mark');
      const q1ok = (q1 && q1.value === answerKey.q1);
      if (q1ok) { score++; q1Num.classList.add('correct'); q1Mark.textContent="⭕"; shortMsgs.push("① 정답 ✅"); fullMsgs.push("① 정답 ✅ " + explain.q1); }
      else { q1Num.classList.add('wrong'); q1Mark.textContent="✖"; shortMsgs.push("① 오답 ❌"); fullMsgs.push("① 오답 ❌ " + explain.q1); }

      // 2번
      const q2 = document.querySelector('input[name="q2"]:checked');
      const q2Num = quizBlocks[1].querySelector('.quiz-num');
      const q2Mark = q2Num.querySelector('.mark');
      const q2ok = (q2 && q2.value === answerKey.q2);
      if (q2ok) { score++; q2Num.classList.add('correct'); q2Mark.textContent="⭕"; shortMsgs.push("② 정답 ✅"); fullMsgs.push("② 정답 ✅ " + explain.q2); }
      else { q2Num.classList.add('wrong'); q2Mark.textContent="✖"; shortMsgs.push("② 오답 ❌"); fullMsgs.push("② 오답 ❌ " + explain.q2); }

      // 3번
      const q3_1 = document.getElementById("q3-1").value.trim();
      const q3_2 = document.getElementById("q3-2").value.trim();
      const q3Num = quizBlocks[2].querySelector('.quiz-num');
      const q3Mark = q3Num.querySelector('.mark');
      const ok3_1 = answerKey.q3_1.some(a => a.replace(/\s+/g,"").toLowerCase() === q3_1.replace(/\s+/g,"").toLowerCase());
      const ok3_2 = answerKey.q3_2.some(a => a.replace(/\s+/g,"").toLowerCase() === q3_2.replace(/\s+/g,"").toLowerCase());
      const q3ok = (ok3_1 && ok3_2);
      if (q3ok) { score++; q3Num.classList.add('correct'); q3Mark.textContent="⭕"; shortMsgs.push("③ 정답 ✅"); fullMsgs.push("③ 정답 ✅ " + explain.q3); }
      else { q3Num.classList.add('wrong'); q3Mark.textContent="✖"; shortMsgs.push("③ 오답 ❌"); fullMsgs.push("③ 오답 ❌ " + explain.q3); }

      // 4번
      const q4_1 = document.getElementById("q4-1").value.trim();
      const q4_2 = document.getElementById("q4-2").value.trim();
      const q4Num = quizBlocks[3].querySelector('.quiz-num');
      const q4Mark = q4Num.querySelector('.mark');
      const ok4_1 = answerKey.q4_1.some(a => a.replace(/\s+/g,"").toLowerCase() === q4_1.replace(/\s+/g,"").toLowerCase());
      const ok4_2 = answerKey.q4_2.some(a => a.replace(/\s+/g,"").toLowerCase() === q4_2.replace(/\s+/g,"").toLowerCase());
      const q4ok = (ok4_1 && ok4_2);
      if (q4ok) { score++; q4Num.classList.add('correct'); q4Mark.textContent="⭕"; shortMsgs.push("④ 정답 ✅"); fullMsgs.push("④ 정답 ✅ " + explain.q4); }
      else { q4Num.classList.add('wrong'); q4Mark.textContent="✖"; shortMsgs.push("④ 오답 ❌"); fullMsgs.push("④ 오답 ❌ " + explain.q4); }

      // 5번 서술형
      const essay = document.getElementById("q5").value.trim().toLowerCase();
      const q5Num = quizBlocks[4].querySelector('.quiz-num');
      const q5Mark = q5Num.querySelector('.mark');
      const essayKeywords = ["지도의 정보를 통해","생활","자연환경","구조","공간","세상","다양성","이해","지역","특징","주제도","일반도"];
      let hit = 0;
      essayKeywords.forEach(kw => { if (essay.includes(kw.replace(/\s+/g,""))) hit++; });
      let q5ok = false;

      if (essay.length === 0) {
        q5Num.classList.add('wrong'); q5Mark.textContent="✖";
        shortMsgs.push("⑤ 서술형: 미작성 ❌");
        fullMsgs.push("⑤ 서술형: 미작성 ❌ " + explain.q5);
      } else if (hit >= 1) {
        q5Num.classList.add('correct'); q5Mark.textContent="⭕";
        shortMsgs.push("⑤ 서술형: 핵심어 표현 감지 ✅");
        fullMsgs.push("⑤ 서술형: 핵심어 표현 감지 ✅ " + explain.q5);
        q5ok = true;
      } else {
        q5Num.classList.add('wrong'); q5Mark.textContent="✖";
        shortMsgs.push("⑤ 서술형: 핵심어 표현 부족 ❌");
        fullMsgs.push("⑤ 서술형: 핵심어 표현 부족 ❌ " + explain.q5);
      }

      const box = document.getElementById("grade-result");
      box.style.display = "block";
      box.innerHTML = `<p><strong>점수: ${score} / ${totalAuto}</strong></p>` + shortMsgs.map(m => `<p>${m}</p>`).join("");
      readingResultHTML = `<p><strong>점수: ${score} / ${totalAuto}</strong></p>` + fullMsgs.map(m => `<p>${m}</p>`).join("");

      document.getElementById("save-progress-btn").style.display = "none";
      document.getElementById("reset-btn").style.display = "inline-block";

      // ★ 전역 상태에 저장
      reportState.q1ok = q1ok;
      reportState.q2ok = q2ok;
      reportState.q3ok = q3ok;
      reportState.q4ok = q4ok;
      reportState.q5ok = q5ok;

      // ★ 분석리포트 텍스트/박스 동기화
      updateReportPanel({
        q1ok: reportState.q1ok,
        q2ok: reportState.q2ok,
        q3ok: reportState.q3ok,
        q4ok: reportState.q4ok,
        q5ok: reportState.q5ok,
        messages: (function(){
          const lexicalRatio = (typeof reportState.vocabScoreRatio === "number") ? reportState.vocabScoreRatio : 0;
          const lexicalOk = lexicalRatio >= 0.7;
          return [
            "① 핵심 이해력(객관식): " + (reportState.q1ok ? "핵심 이해력이 좋아요! ✅" : "보완 필요해요 ❗"),
            "② 구조 파악력(객관식): " + (reportState.q2ok ? "구조 파악력이 좋아요! ✅" : "보완 필요해요 ❗"),
            "③ 어휘 맥락력(빈칸): " + (lexicalOk ? "어휘 맥락력이 좋아요! ✅" : "어휘 복습이 필요해요 ❗"),
            "④ 추론·통합력(빈칸): " + (reportState.q4ok ? "추론·통합력이 좋아요! ✅" : "보완 필요해요 ❗"),
            "⑤ 비판·적용력(서술형): " + (reportState.q5ok ? "비판·적용력이 좋아요! ✅" : "보완 필요해요 ❗")
          ];
        })()
      });

      // 레이더 차트
      drawRadarChart({
        literal:     reportState.q1ok ? 10 : 6,
        structural:  reportState.q2ok ? 10 : 6,
        lexical:     reportState.q3ok ? 10 : 6,
        inferential: reportState.q4ok ? 10 : 6,
        critical:    reportState.q5ok ? 10 : 6
      });

      // 어휘 피드백 반영
      const lexicalRatio = (typeof reportState.vocabScoreRatio === "number") ? reportState.vocabScoreRatio : 0;
      const lexicalFromRatio = Math.round(lexicalRatio * 10);
      renderFeedback({
        literal:    reportState.q1ok ? 10 : 6,
        structural: reportState.q2ok ? 10 : 6,
        lexical:    lexicalFromRatio,
        inferential:reportState.q4ok ? 10 : 6,
        critical:   reportState.q5ok ? 10 : 6
      });

      // ★ localStorage에 분석리포트 상태 저장 (분석리포트 탭 즉시 반영용)
      localStorage.setItem(`dan-soc-report-state:${window.CUR_UNIT}`, JSON.stringify({
        q1ok: reportState.q1ok,
        q2ok: reportState.q2ok,
        q3ok: reportState.q3ok,
        q4ok: reportState.q4ok,
        q5ok: reportState.q5ok,
        vocabScoreRatio: reportState.vocabScoreRatio,
        literal: reportState.q1ok ? 10 : 6,
        structural: reportState.q2ok ? 10 : 6,
        lexical: lexicalFromRatio,
        inferential: reportState.q4ok ? 10 : 6,
        critical: reportState.q5ok ? 10 : 6
      }));

      // ★ 분석리포트 탭 즉시 업데이트
      refreshReportTab();
    }

    function resetQuiz() {
      document.querySelectorAll('#tab-reading input[type="radio"]').forEach(r => r.checked = false);
      // q3, q4 라디오버튼 초기화 (객관식)
      document.querySelectorAll('input[name="q3"]').forEach(r => { r.checked = false; r.disabled = false; });
      document.querySelectorAll('input[name="q4"]').forEach(r => { r.checked = false; r.disabled = false; });
      document.getElementById("q5").value = "";

      const quizBlocks = document.querySelectorAll('#tab-reading .quiz-block');
      const numLabels = ["01","02","03","04","05"];
      quizBlocks.forEach((block, idx) => {
        const numEl = block.querySelector('.quiz-num');
        const markEl = numEl.querySelector('.mark');
        numEl.textContent = numLabels[idx];
        numEl.appendChild(markEl);
        numEl.classList.remove('correct','wrong');
        markEl.textContent = "";
      });

      const resultBox = document.getElementById("grade-result");
      resultBox.style.display = "none";
      resultBox.innerHTML = "";
      readingResultHTML = "";

      // solutions-box 제거 (제출하기에서 생성된 해설 박스)
      const solutionsBox = document.getElementById("solutions-box");
      if (solutionsBox) {
        solutionsBox.remove();
      }

      document.getElementById("save-progress-btn").style.display = "inline-block";
      document.getElementById("reset-btn").style.display = "none";
      enableQuizInputs();

      reportState = { q1ok:false, q2ok:false, q3ok:false, q4ok:false, q5ok:false, vocabScoreRatio:0 };

      updateReportPanel({ q1ok:false, q2ok:false, q3ok:false, q4ok:false, q5ok:false, messages: ["채점 결과가 초기화되었습니다. 다시 풀고 채점해 주세요."] });

      drawRadarChart({ literal:0, structural:0, lexical:0, inferential:0, critical:0 });
    }

    // disableQuizInputs/enableQuizInputs - 본문학습 입력 비활성화/활성화
    function disableQuizInputs() {
      document.querySelectorAll('#tab-reading input[type="radio"]').forEach(r => r.disabled = true);
      // q3, q4 라디오버튼 비활성화 (객관식)
      document.querySelectorAll('input[name="q3"]').forEach(r => r.disabled = true);
      document.querySelectorAll('input[name="q4"]').forEach(r => r.disabled = true);
      const q5 = document.getElementById('q5');
      if (q5) q5.disabled = true;
    }

    function enableQuizInputs() {
      document.querySelectorAll('#tab-reading input[type="radio"]').forEach(r => r.disabled = false);
      // q3, q4 라디오버튼 활성화 (객관식)
      document.querySelectorAll('input[name="q3"]').forEach(r => r.disabled = false);
      document.querySelectorAll('input[name="q4"]').forEach(r => r.disabled = false);
      const q5 = document.getElementById('q5');
      if (q5) q5.disabled = false;
    }

    // saveReadingProgress - 채점 + 서버 저장 + PDF + 해설
    console.log('[soc_19.html] saveReadingProgress 함수 정의 시작');
    async function saveReadingProgress() {
      console.log('[saveReadingProgress] 함수 호출됨');
      if (!ensureStudentInfo()) {
        showSubmitOverlay('학년과 이름을 입력해주세요');
        return;
      }

      // 1) 채점 먼저 실행
      gradeQuiz();

      // 2) 서버 저장 데이터 준비
      const inputs = {
        q1: document.querySelector('input[name="q1"]:checked')?.value || '',
        q2: document.querySelector('input[name="q2"]:checked')?.value || '',
        q3_1: document.getElementById('q3-1')?.value || '',
        q3_2: document.getElementById('q3-2')?.value || '',
        q4_1: document.getElementById('q4-1')?.value || '',
        q4_2: document.getElementById('q4-2')?.value || '',
        q5: document.getElementById('q5')?.value || ''
      };

      const quizBlocks = document.querySelectorAll('#tab-reading .quiz-block');
      const results = [];
      quizBlocks.forEach((block, idx) => {
        const numEl = block.querySelector('.quiz-num');
        results.push({
          index: idx + 1,
          isCorrect: numEl.classList.contains('correct'),
          isWrong: numEl.classList.contains('wrong')
        });
      });

      const gradeResultBox = document.getElementById('grade-result');
      const dataToSave = {
        readingState: {
          inputs: inputs,
          results: results,
          resultHTML: gradeResultBox ? gradeResultBox.innerHTML : '',
          isGraded: true
        }
      };

      try {
        if (typeof window.saveUnitProgressToServer === 'function') {
          await window.saveUnitProgressToServer(dataToSave);
        }
        disableQuizInputs();
        await captureElementToPDF('capture-reading', '단단국어_본문학습.pdf', { withStudentInfo: true });
        if (typeof renderSolutions === 'function') {
          const unit = window.CUR_UNIT || 'deep_soc_19';
          const content = window.CONTENTS[window.CUR_UNIT];
          if (content) renderSolutions(content);
        }
        document.getElementById('save-progress-btn').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'inline-block';
        showSubmitSuccess('본문학습');
      } catch (err) {
        console.error('[saveReadingProgress] 실패:', err);
        alert('저장 실패: ' + err.message);
      }
    }

    /* ===== 어휘학습 상태 저장/복원 ===== */
    function saveVocabState() {
      const stu = getCurrentStudent();
      if (!stu) return;
      const stuKey = buildStudentKey(stu);
      const unit = window.CUR_UNIT || 'deep_soc_19';
      const stateKey = `vocab-state:${stuKey}:${unit}`;

      const blanks = document.querySelectorAll('#tab-vocab .blank-wrap');
      const vocabResultBox = document.getElementById('vocab-result');
      const vocabSaveBtn = document.getElementById('vocab-save');

      const vocabData = [];
      blanks.forEach(bw => {
        const input = bw.querySelector('.blank-input');
        const mark = bw.querySelector('.blank-mark');
        vocabData.push({
          value: input ? input.value : '',
          isCorrect: bw.classList.contains('correct'),
          isWrong: bw.classList.contains('wrong'),
          markText: mark ? mark.textContent : ''
        });
      });

      localStorage.setItem(stateKey, JSON.stringify({
        vocabData: vocabData,
        resultHTML: vocabResultBox ? vocabResultBox.innerHTML : '',
        isGraded: vocabSaveBtn ? vocabSaveBtn.style.display === "none" : false
      }));
      console.log('[saveVocabState] 저장 완료:', stateKey);
    }

    function loadVocabState() {
      const stu = getCurrentStudent();
      if (!stu) return;
      const stuKey = buildStudentKey(stu);
      const unit = window.CUR_UNIT || 'deep_soc_19';
      const stateKey = `vocab-state:${stuKey}:${unit}`;

      const saved = localStorage.getItem(stateKey);
      if (!saved) return;

      try {
        const state = JSON.parse(saved);
        const blanks = document.querySelectorAll('#tab-vocab .blank-wrap');
        const vocabResultBox = document.getElementById('vocab-result');
        const vocabSaveBtn = document.getElementById('vocab-save');
        const vocabResetBtn = document.getElementById('vocab-reset');

        blanks.forEach((bw, idx) => {
          if (state.vocabData && state.vocabData[idx]) {
            const data = state.vocabData[idx];
            const input = bw.querySelector('.blank-input');
            const mark = bw.querySelector('.blank-mark');

            if (input) input.value = data.value;
            if (data.isCorrect) bw.classList.add('correct');
            if (data.isWrong) bw.classList.add('wrong');
            if (mark) mark.textContent = data.markText;
          }
        });

        if (state.isGraded) {
          if (vocabResultBox) {
            vocabResultBox.innerHTML = state.resultHTML;
            vocabResultBox.style.display = "block";
          }
          if (vocabSaveBtn) vocabSaveBtn.style.display = "none";
          if (vocabResetBtn) vocabResetBtn.style.display = "inline-block";
        }

        console.log('[loadVocabState] 복원 완료:', stateKey);
      } catch (e) {
        console.warn('[loadVocabState] 복원 실패:', e);
      }
    }

    /* ===== 창의활동 저장/복원 함수 ===== */
    function saveCreativeState() {
      const stu = getCurrentStudent();
      if (!stu) return;
      const stuKey = buildStudentKey(stu);
      const unit = window.CUR_UNIT || 'deep_soc_19';
      const stateKey = `creative-state:${stuKey}:${unit}`;

      const textarea = document.getElementById('creative-input');
      if (!textarea) return;

      localStorage.setItem(stateKey, textarea.value);
      console.log('[saveCreativeState] 저장 완료:', stateKey);
    }

    function loadCreativeState() {
      const stu = getCurrentStudent();
      if (!stu) return;
      const stuKey = buildStudentKey(stu);
      const unit = window.CUR_UNIT || 'deep_soc_19';
      const stateKey = `creative-state:${stuKey}:${unit}`;

      const saved = localStorage.getItem(stateKey);
      if (!saved) return;

      const textarea = document.getElementById('creative-input');
      if (textarea) {
        textarea.value = saved;
        console.log('[loadCreativeState] 복원 완료:', stateKey);
      }
    }

    /* ===== 한글 맞춤법 검사 함수 ===== */
    async function checkSpelling(text) {
      try {
        // 서버의 맞춤법 검사 API 호출
        const response = await fetch('/api/spell-check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ text: text })
        });

        if (!response.ok) {
          throw new Error('서버 응답 오류');
        }

        const data = await response.json();
        return data;

      } catch (error) {
        console.error('맞춤법 검사 오류:', error);
        // API 실패 시 간단한 폴백: 원본 텍스트 반환
        return { errata_count: 0, origin_html: text, html: text, notag_html: text };
      }
    }

    // 창의활동 관련 기능은 learning-common.js에서 처리됨
    // saveCreativeState, loadCreativeState, creativeBtn, creativeCheckBtn 등

    // 시작: 빈 레이더
    drawRadarChart({ literal:0, structural:0, lexical:0, inferential:0, critical:0 });

    // ✅ 어휘학습 상태 복원
    loadVocabState();

    // ✅ 창의활동 상태 복원
    loadCreativeState();

    /* ===== ✅ 최종본 submitReport()만 남김 (중복/전역 병합 블록 삭제) ===== */
    async function submitReport() {
      // 0) 로그인 정보 확인
      const stu = getCurrentStudent();
      if (!stu) {
        alert('로그인한 학생 정보가 없습니다. 먼저 로그인 해주세요.');
        return;
      }

      // 1) 리포트 PDF 저장
      await captureElementToPDF('capture-report', '단단국어_분석리포트.pdf', { withStudentInfo: true });

      // 2) 학생 고유키
      const studentKey = buildStudentKey(stu); // 예: "4학년_사사사_01044444444"

      // 3) 현재 단원 번호와 PAGE_KEY
      const cur = (window.CUR_UNIT || 'deep_soc_19');                  // 예: 'deep_soc_02'
      const m = cur.match(/soc_(\d{1,2})/);
      const no = m ? m[1].padStart(2, '0') : '01';
      const pk = window.PAGE_KEY || `BRAINUP_social_deep_soc_${no}`;   // 예: 'BRAINUP_social_soc_02'

      // 4) 과거/변형 키까지 한 번에 흡수
      const legacyPath = `./BRAINUP/social/deep_soc_${no}.html`;
      const pageIds = [
        pk,
        legacyPath,
        `BRAINUP_deep_soc_${no}`,
        `BRAINUP_social_soc${no}`
      ];
      console.log('[study page] PAGE_IDs =', pageIds);

      // 5) localStorage 내 dan-progress* 전부 병합 저장
      const allKeys = Object.keys(localStorage);
      const progressKeys = new Set([
        `dan-progress:${studentKey}`,
        `dan-progress-${studentKey}`
      ]);
      allKeys.forEach(k => { if (k.startsWith('dan-progress')) progressKeys.add(k); });

      progressKeys.forEach(storeKey => {
        let saved;
        try {
          saved = JSON.parse(localStorage.getItem(storeKey) || '[]');
          // 배열이 아니면 빈 배열로 초기화
          if (!Array.isArray(saved)) saved = [];
        }
        catch(e) { saved = []; }
        pageIds.forEach(id => { if (!saved.includes(id)) saved.push(id); });
        localStorage.setItem(storeKey, JSON.stringify(saved));
        console.log('[study page] wrote to', storeKey, '=>', saved);
      });

      // 6) 부모 창에 완료 메시지 전송 (코인 지급 및 UI 업데이트)
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'UNIT_COMPLETED'
        }, window.location.origin);
        console.log('[study page] Sent UNIT_COMPLETED to parent');
      }

      // 7) AI 추천 과제 복습 완료 처리
      try {
        const unitId = cur; // 예: 'deep_soc_04'
        await markAITaskAsCompleted(stu.grade, stu.name, unitId);
      } catch (error) {
        console.error('[AI 과제 복습 완료 처리 오류]', error);
      }

      // 8) 완료 표시
      showSubmitSuccess('분석리포트');
    }
  </script>

  <!-- 보완학습 표시 영역 -->
  <div id="remedial-panel" style="display:none; position:fixed; right:20px; bottom:20px; width:360px; max-height:70vh; background:#fffdf8; border:1px solid #e5d0ac; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.15); z-index:99999; flex-direction:column;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px 6px;">
      <strong style="color:#7b3d1a;">보완학습 문제</strong>
      <button onclick="document.getElementById('remedial-panel').style.display='none';" style="background:none; border:none; font-size:16px; cursor:pointer;">×</button>
    </div>
    <div id="remedial-panel-body" style="flex:1 1 auto; overflow:auto; padding:0 14px 6px; max-height: calc(70vh - 110px);"></div>
    <div style="display:flex; justify-content:flex-end; gap:8px; padding:8px 14px 12px; border-top:1px solid #f0dfc8; background:#fffaf3; border-bottom-left-radius:12px; border-bottom-right-radius:12px;">
      <button onclick="resetRemedial()" style="background:#f1e0c8; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px;">다시 풀기</button>
      <button onclick="gradeRemedial()" style="background:#8b2f2f; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px;">채점하기</button>
    </div>
  </div>
<!-- ✅ 어휘 자동 렌더링 / 채점 / 저장 JS -->
<script>
/* ================================================
   🧩 어휘학습 자동 렌더링 (+탭 전환 자동 반영)
   - CONTENTS[CUR_UNIT].vocabFill 사용
   - 입력값 학생/단원별 자동 저장/복원
=================================================== */

// ✅ 학생 키 (있을 경우 localStorage 저장용)
function _getStudentKey() {
  try {
    if (typeof getCurrentStudent === 'function' && typeof buildStudentKey === 'function') {
      const stu = getCurrentStudent();
      if (stu) return 'dan-vfill:' + buildStudentKey(stu);
    }
  } catch(e){}
  return 'dan-vfill:guest';
}
function _storeKey(unit){ return `${_getStudentKey()}::${unit||window.CUR_UNIT||'deep_soc_19'}`; }

// ✅ 비교용 정규화 (대소문/공백/기호 제거)
function _norm(s){
  return (s||'')
    .normalize('NFC')
    .toLowerCase()
    .replace(/\s+/g,'')
    .replace(/[~!@#$%^&*()\-\=_+[\]{};:'",.<>/?\\|·`]/g,'');
}

// ✅ 입력값 저장/복원
function _saveVocabInputs(unit){
  const key = _storeKey(unit);
  const inputs = [...document.querySelectorAll('#vocab-fill .vocab-input')].map(inp => ({
    id: inp.id, v: inp.value
  }));
  localStorage.setItem(key, JSON.stringify(inputs));
}
function _loadVocabInputs(unit){
  const key = _storeKey(unit);
  try {
    const saved = JSON.parse(localStorage.getItem(key) || '[]');
    saved.forEach(({id,v})=>{
      const el = document.getElementById(id);
      if (el) el.value = v || '';
    });
  } catch(e){}
}

// ✅ 초성 자동 생성
function _initialsFromKorean(word){
  const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
  const base = '가'.charCodeAt(0);
  const choUnit = 588;
  let out = '';
  for (const ch of (word||'')) {
    const code = ch.charCodeAt(0);
    if (code >= 0xAC00 && code <= 0xD7A3) {
      const idx = Math.floor((code - base) / choUnit);
      out += CHO[idx] || ch;
    } else if (/\s/.test(ch)) {
      out += ' ';
    } else {
      out += ch;
    }
  }
  return out.replace(/\s+/g,'');
}

/* =========================================================
   📘 렌더링
========================================================= */
function renderVocabFill() {
  const unit = window.CUR_UNIT;
  const data = (window.CONTENTS && window.CONTENTS[window.CUR_UNIT] && window.CONTENTS[window.CUR_UNIT].vocabFill) || null;
  const container = document.getElementById('vocab-fill');
  if (!data || !container) return;

  container.innerHTML = '';

  const inst = document.createElement('p');
  inst.className = 'vocab-instruction';
  inst.textContent = data.instructions || '빈칸에 알맞은 낱말을 쓰세요.';
  container.appendChild(inst);

  (data.items || []).forEach((item) => {
    const row = document.createElement('div');
    row.className = 'vocab-item';
    const initials = item.initials || _initialsFromKorean(item.answer);

    const html = (item.text || '').replace(
      '(      )',
      `<input type="text" id="fill-${item.no}" data-ans="${item.answer}" data-alias='${JSON.stringify(item.aliases||[])}' placeholder="${initials}" class="vocab-input">`
    );

    row.innerHTML = `<span class="vocab-num">${item.no}.</span> ${html}`;
    container.appendChild(row);
  });

  const btnWrap = document.createElement('div');
  btnWrap.style.marginTop = '12px';

  const btnCheck = document.createElement('button');
  btnCheck.textContent = '채점하기';
  btnCheck.className = 'check-btn';
  btnCheck.onclick = checkVocabFill;
  btnWrap.appendChild(btnCheck);

  const btnReset = document.createElement('button');
  btnReset.textContent = '초기화';
  btnReset.className = 'check-btn';
  btnReset.style.marginLeft = '8px';
  btnReset.onclick = () => {
    [...container.querySelectorAll('.vocab-input')].forEach(inp => {
      inp.value = '';
      inp.style.background = '';
    });
    _saveVocabInputs(unit);
  };
  btnWrap.appendChild(btnReset);
  container.appendChild(btnWrap);

  _loadVocabInputs(unit);
  container.addEventListener('input', (e)=>{
    if (e.target && e.target.classList.contains('vocab-input')) {
      e.target.style.background = '';
      _saveVocabInputs(unit);
    }
  });

  container.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && e.target.classList.contains('vocab-input')) {
      const inputs = [...container.querySelectorAll('.vocab-input')];
      const idx = inputs.indexOf(e.target);
      const next = inputs[idx+1];
      if (next) next.focus();
    }
  });
}

/* =========================================================
   🧮 채점
========================================================= */
function checkVocabFill() {
  const unit = window.CUR_UNIT;
  const data = (window.CONTENTS && window.CONTENTS[window.CUR_UNIT] && window.CONTENTS[window.CUR_UNIT].vocabFill && window.CONTENTS[window.CUR_UNIT].vocabFill.items) || [];
  let score = 0;

  data.forEach((item) => {
    const input = document.getElementById(`fill-${item.no}`);
    if (!input) return;
    const user = _norm(input.value);
    const answers = [item.answer, ...(item.aliases||[])].map(_norm);
    const correct = answers.some(v => v === user);

    input.style.background = correct ? '#d9f7be' : '#ffd6d6';
    if (correct) score++;
  });

  alert(`정답 ${score}개 / 총 ${data.length}개`);
}

/* =========================================================
   탭 전환 시 자동 렌더링
========================================================= */
function _bindTabEvents() {
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('[data-tab]');
    if (!btn) return;
    var tab = btn.getAttribute('data-tab');

    // data-tab 값이 'vocab'일 때만 렌더
    if (tab === 'vocab') {
      var fn = window.renderVocabFromContent || window.renderVocabFill;
      if (typeof fn === 'function') fn();
    }
  });
}
</script>


<!-- 외부 JS: 단원 콘텐츠 로드 -->
<script src="./deep_soc_content.js?v=20251212a" defer></script>

<!-- 달력 팝업 -->
<div class="calendar-overlay" id="calendar-overlay"></div>
<div class="calendar-popup" id="calendar-popup">
  <div class="calendar-header">
    <span class="calendar-nav" onclick="changeMonth(-1)">◀</span>
    <span id="calendar-title">2024년 11월</span>
    <span class="calendar-nav" onclick="changeMonth(1)">▶</span>
  </div>
  <div class="calendar-grid" id="calendar-grid">
    <!-- 요일 헤더 -->
    <div class="calendar-day-header">일</div>
    <div class="calendar-day-header">월</div>
    <div class="calendar-day-header">화</div>
    <div class="calendar-day-header">수</div>
    <div class="calendar-day-header">목</div>
    <div class="calendar-day-header">금</div>
    <div class="calendar-day-header">토</div>
    <!-- 날짜들은 JavaScript로 동적 생성 -->
  </div>
</div>

</body>
</html>