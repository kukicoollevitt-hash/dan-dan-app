<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¨ë‹¨êµ­ì–´ í•™ì› ì„ ìƒë‹˜ ë¡œê·¸ì¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f0eaf5;
      --card: #ffffff;
      --primary: #6B5B95;
      --primary-dark: #5a4a85;
      --text: #2f2f2f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: url('/images/ìŠˆí¼ê´€ë¦¬ìë°°ê²½.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: "Apple SD Gothic Neo", "Noto Sans KR", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--text);
    }
    .card {
      position: relative;
      width: min(420px, 94vw);
      background: var(--card);
      border-radius: 16px;
      padding: 24px 24px 26px;
      box-shadow: 0 16px 40px rgba(107, 91, 149, 0.15);
      border: 1px solid rgba(107, 91, 149, 0.1);
    }
    .title {
      margin: 0 0 6px;
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
    }
    .subtitle {
      margin: 0 0 18px;
      font-size: 13px;
      text-align: center;
      color: #7a6b8b;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="tel"],
    input[type="password"] {
      width: 100%;
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #c8b8e0;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(107, 91, 149, 0.2);
    }
    /* í•™ì› ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ */
    .academy-search-wrapper {
      position: relative;
    }
    .academy-search-input {
      width: 100%;
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #c8b8e0;
      font-size: 14px;
      outline: none;
    }
    .academy-search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(107, 91, 149, 0.2);
    }
    .academy-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 180px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #c8b8e0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 100;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .academy-dropdown.show {
      display: block;
    }
    .academy-option {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      color: #2f2f2f;
      border-bottom: 1px solid #f0e8f8;
    }
    .academy-option:last-child {
      border-bottom: none;
    }
    .academy-option:hover,
    .academy-option.highlighted {
      background: #f5f0ff;
    }
    .academy-option.selected {
      background: #e8e0f5;
      font-weight: 600;
    }
    .academy-option.new-entry {
      color: var(--primary);
      font-style: italic;
    }
    .academy-no-result {
      padding: 10px 12px;
      color: #999;
      font-size: 13px;
      text-align: center;
    }
    .btn-main {
      margin-top: 20px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 10px 0;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #8B7BB5 0%, #6B5B95 100%);
      color: #fff;
      cursor: pointer;
    }
    .btn-main:hover { opacity: .92; }
    .bottom {
      margin-top: 12px;
      font-size: 13px;
      text-align: center;
      color: #6b5a8c;
    }
    .bottom a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }
    .mode-switch {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(107, 91, 149, 0.2);
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
    }
    .mode-switch:hover {
      background: #f5f0ff;
    }
    .error-msg {
      background: #fdecea;
      color: #c0392b;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 14px;
      text-align: center;
      display: none;
    }
    .error-msg.show {
      display: block;
    }
    .success-msg {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 14px;
      text-align: center;
      display: none;
    }
    .success-msg.show {
      display: block;
    }
    .tab-container {
      display: flex;
      margin-bottom: 18px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #c8b8e0;
    }
    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: #f5f0ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      color: #7a6b8b;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: var(--primary);
      color: #fff;
    }
    .tab-btn:hover:not(.active) {
      background: #e8e0f5;
    }
    .panel {
      display: none;
    }
    .panel.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="card">
    <a href="/academy" class="mode-switch">í•™ìƒëª¨ë“œ</a>

    <h1 class="title">ğŸ¢ í•™ì› ì„ ìƒë‹˜</h1>
    <p class="subtitle">í•™ì›ìš© ì„ ìƒë‹˜ ì „ìš© ë¡œê·¸ì¸ì…ë‹ˆë‹¤.</p>

    <div class="error-msg" id="errorMsg"></div>
    <div class="success-msg" id="successMsg"></div>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="tab-container">
      <button type="button" class="tab-btn active" id="loginTab">ë¡œê·¸ì¸</button>
      <button type="button" class="tab-btn" id="registerTab">íšŒì›ê°€ì…</button>
    </div>

    <!-- ë¡œê·¸ì¸ íŒ¨ë„ -->
    <div class="panel active" id="loginPanel">
      <form action="/academy-admin-login" method="post">
        <label>
          í•™ì›ëª…
          <div class="academy-search-wrapper">
            <input type="text" class="academy-search-input" id="loginAcademySearch" placeholder="í•™ì›ëª… ê²€ìƒ‰..." autocomplete="off" />
            <input type="hidden" name="academyName" id="loginAcademyValue" required />
            <div class="academy-dropdown" id="loginAcademyDropdown"></div>
          </div>
        </label>

        <label>
          ì„±í•¨
          <input type="text" name="name" placeholder="ì˜ˆ) í™ê¸¸ë™" required />
        </label>

        <label>
          ì „í™”ë²ˆí˜¸ (11ìë¦¬)
          <input type="tel" name="phone" placeholder="ì˜ˆ) 01012345678" maxlength="11" pattern="[0-9]{11}" required />
        </label>

        <button type="submit" class="btn-main">ë¡œê·¸ì¸</button>
      </form>
    </div>

    <!-- íšŒì›ê°€ì… íŒ¨ë„ -->
    <div class="panel" id="registerPanel">
      <form action="/academy-admin-register" method="post">
        <label>
          í•™ì›ëª…
          <div class="academy-search-wrapper">
            <input type="text" class="academy-search-input" id="registerAcademySearch" placeholder="í•™ì›ëª… ê²€ìƒ‰ ë˜ëŠ” ì…ë ¥..." autocomplete="off" />
            <input type="hidden" name="academyName" id="registerAcademyValue" required />
            <div class="academy-dropdown" id="registerAcademyDropdown"></div>
          </div>
        </label>

        <label>
          ì„±í•¨
          <input type="text" name="name" placeholder="ì˜ˆ) í™ê¸¸ë™" required />
        </label>

        <label>
          ì „í™”ë²ˆí˜¸ (11ìë¦¬)
          <input type="tel" name="phone" placeholder="ì˜ˆ) 01012345678" maxlength="11" pattern="[0-9]{11}" required />
        </label>

        <button type="submit" class="btn-main">íšŒì›ê°€ì… ì‹ ì²­</button>
      </form>

      <div class="bottom" style="margin-top: 16px; font-size: 12px; color: #999;">
        íšŒì›ê°€ì… í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script>
    // URLì—ì„œ ì—ëŸ¬/ì„±ê³µ íŒŒë¼ë¯¸í„° í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    const success = urlParams.get('success');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');

    if (error === 'invalid') {
      errorMsg.textContent = 'ì…ë ¥í•˜ì‹  ì •ë³´ì™€ ì¼ì¹˜í•˜ëŠ” ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
      errorMsg.classList.add('show');
    } else if (error === 'pending') {
      errorMsg.textContent = 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
      errorMsg.classList.add('show');
    } else if (error === 'duplicate') {
      errorMsg.textContent = 'ì´ë¯¸ ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.';
      errorMsg.classList.add('show');
      // íšŒì›ê°€ì… íƒ­ìœ¼ë¡œ ì „í™˜
      document.getElementById('registerTab').click();
    }

    if (success === 'registered') {
      successMsg.textContent = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
      successMsg.classList.add('show');
    }

    // ========== íƒ­ ì „í™˜ ==========
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginPanel = document.getElementById('loginPanel');
    const registerPanel = document.getElementById('registerPanel');

    loginTab.addEventListener('click', () => {
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginPanel.classList.add('active');
      registerPanel.classList.remove('active');
    });

    registerTab.addEventListener('click', () => {
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      registerPanel.classList.add('active');
      loginPanel.classList.remove('active');
    });

    // ========== í•™ì› ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ==========
    let academyList = [];

    // ì„œë²„ì—ì„œ í•™ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function loadAcademies() {
      try {
        const res = await fetch('/api/academies');
        const data = await res.json();
        if (data.ok && data.academies) {
          academyList = data.academies;
        }
      } catch (err) {
        console.error('í•™ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', err);
      }
    }

    // í•™ì› ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function initAcademySearch(searchInputId, hiddenInputId, dropdownId, allowCustom = false) {
      const searchInput = document.getElementById(searchInputId);
      const hiddenInput = document.getElementById(hiddenInputId);
      const dropdown = document.getElementById(dropdownId);

      if (!searchInput || !hiddenInput || !dropdown) return;

      let highlightIndex = -1;

      // ë“œë¡­ë‹¤ìš´ ë Œë”ë§
      function renderDropdown(filter = '') {
        if (!filter || filter.trim() === '') {
          dropdown.innerHTML = '<div class="academy-no-result">í•™ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>';
          dropdown.classList.add('show');
          return;
        }

        const filtered = academyList.filter(s => s.toLowerCase().includes(filter.toLowerCase()));

        if (filtered.length === 0) {
          if (allowCustom) {
            dropdown.innerHTML = '<div class="academy-option new-entry" data-value="' + filter.trim() + '">"' + filter.trim() + '" (ìƒˆ í•™ì›ìœ¼ë¡œ ë“±ë¡)</div>';
          } else {
            dropdown.innerHTML = '<div class="academy-no-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          }
        } else {
          dropdown.innerHTML = filtered.map((academy, idx) =>
            '<div class="academy-option' + (hiddenInput.value === academy ? ' selected' : '') + '" data-value="' + academy + '" data-index="' + idx + '">' + academy + '</div>'
          ).join('');
        }
        highlightIndex = -1;
      }

      // ì…ë ¥ ì‹œ í•„í„°ë§
      searchInput.addEventListener('input', () => {
        const val = searchInput.value.trim();
        // ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‘ ì…ë ¥ê°’ì„ hiddenì— ë°˜ì˜ (ìŠˆí¼ê´€ë¦¬ì "ì–´ë“œë¯¼" ë“± ì§ì ‘ ì…ë ¥ ì§€ì›)
        hiddenInput.value = val;

        if (val.length > 0) {
          renderDropdown(val);
          dropdown.classList.add('show');
        } else {
          dropdown.classList.remove('show');
        }
      });

      // í¬ì»¤ìŠ¤ ì‹œ
      searchInput.addEventListener('focus', () => {
        const val = searchInput.value.trim();
        if (val.length > 0) {
          renderDropdown(val);
          dropdown.classList.add('show');
        }
      });

      // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
          // íšŒì›ê°€ì… ì‹œ ì…ë ¥ê°’ ìœ ì§€
          if (allowCustom && searchInput.value.trim() && !hiddenInput.value) {
            hiddenInput.value = searchInput.value.trim();
          }
        }
      });

      // ì˜µì…˜ í´ë¦­
      dropdown.addEventListener('click', (e) => {
        const option = e.target.closest('.academy-option');
        if (option) {
          const value = option.dataset.value;
          searchInput.value = value;
          hiddenInput.value = value;
          dropdown.classList.remove('show');
        }
      });

      // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
      searchInput.addEventListener('keydown', (e) => {
        const options = dropdown.querySelectorAll('.academy-option');
        if (options.length === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightIndex = Math.min(highlightIndex + 1, options.length - 1);
          updateHighlight(options);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightIndex = Math.max(highlightIndex - 1, 0);
          updateHighlight(options);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (highlightIndex >= 0 && options[highlightIndex]) {
            const value = options[highlightIndex].dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdown.classList.remove('show');
          } else if (allowCustom && searchInput.value.trim()) {
            hiddenInput.value = searchInput.value.trim();
            dropdown.classList.remove('show');
          }
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('show');
        }
      });

      function updateHighlight(options) {
        options.forEach((opt, idx) => {
          opt.classList.toggle('highlighted', idx === highlightIndex);
        });
        if (highlightIndex >= 0) {
          options[highlightIndex].scrollIntoView({ block: 'nearest' });
        }
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAcademies();
      initAcademySearch('loginAcademySearch', 'loginAcademyValue', 'loginAcademyDropdown', false);
      initAcademySearch('registerAcademySearch', 'registerAcademyValue', 'registerAcademyDropdown', true);
    });
  </script>
</body>
</html>
