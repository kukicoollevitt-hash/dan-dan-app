<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>BRAIN UP í˜•ì„±í‰ê°€ ê´€ë¬¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    /* ë°°ê²½ íš¨ê³¼ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 80%, rgba(139, 47, 47, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(139, 47, 47, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .quiz-container {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      padding: 40px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
      animation: slideIn 0.5s ease-out;
      position: relative;
      z-index: 1;
    }

    /* ë‹«ê¸° ë²„íŠ¼ */
    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border: none;
      background: #f5f0eb;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #8b2f2f;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .close-btn:hover {
      background: #8b2f2f;
      color: #fff;
      transform: scale(1.1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* í­ì£½ íš¨ê³¼ */
    .confetti {
      position: fixed;
      pointer-events: none;
      z-index: 10000;
      animation: confetti-fall linear forwards;
    }

    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(0) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }

    .quiz-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .quiz-header h1 {
      font-size: 28px;
      color: #8b2f2f;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .quiz-header .gate-number {
      font-size: 18px;
      color: #555;
      font-weight: 600;
    }

    .quiz-header .gate-info {
      font-size: 14px;
      color: #888;
      margin-top: 5px;
    }

    .progress-bar-container {
      width: 100%;
      height: 10px;
      background: #e0e0e0;
      border-radius: 10px;
      margin-bottom: 25px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #8b2f2f 0%, #c0392b 100%);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .unit-info {
      background: #f8f4f0;
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }

    .unit-info strong {
      color: #8b2f2f;
    }

    /* ì•„ì½”ë””ì–¸ ë³¸ë¬¸ ë³´ê¸° */
    .unit-title-btn {
      background: #fff8f0;
      border: 2px solid #e8d4c4;
      padding: 14px 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }
    .unit-title-btn:hover {
      background: #fff0e0;
      border-color: #d4b8a0;
    }
    .unit-title-btn .title-text {
      font-size: 15px;
      color: #8b2f2f;
      font-weight: 600;
    }
    .unit-title-btn .title-hint {
      font-size: 12px;
      color: #999;
      margin-left: 8px;
    }
    .unit-title-btn .arrow {
      font-size: 14px;
      color: #8b2f2f;
      transition: transform 0.3s ease;
    }
    .unit-title-btn.open .arrow {
      transform: rotate(180deg);
    }

    /* ë³¸ë¬¸ ë‚´ìš© ì˜ì—­ */
    .passage-content {
      display: none;
      background: #fffaf5;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .passage-content.open {
      display: block;
      padding: 20px;
      border: 1px solid #f0e0d0;
      max-height: 50vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .passage-content p {
      font-size: 18px !important;
      color: #4a3728;
      line-height: 2.0;
      margin-bottom: 16px;
      text-align: justify;
    }
    .passage-content p:last-child {
      margin-bottom: 0;
    }
    .passage-content b {
      color: #8b2f2f;
      font-weight: 600;
    }

    .question-box {
      background: #faf8f6;
      padding: 25px;
      border-radius: 16px;
      margin-bottom: 25px;
      border-left: 5px solid #8b2f2f;
    }

    .question-text {
      font-size: 18px;
      color: #333;
      font-weight: 600;
      line-height: 1.7;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }

    .option-btn {
      background: white;
      border: 2px solid #e0e0e0;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 16px;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      font-weight: 500;
      line-height: 1.5;
    }

    .option-btn:hover {
      border-color: #8b2f2f;
      background: #fef5f5;
      transform: translateX(5px);
    }

    .option-btn.selected {
      border-color: #8b2f2f;
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      color: white;
    }

    .option-btn.correct {
      border-color: #27ae60;
      background: #27ae60;
      color: white;
    }

    .option-btn.wrong {
      border-color: #e74c3c;
      background: #e74c3c;
      color: white;
    }

    .option-btn:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(139, 47, 47, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .result-message {
      text-align: center;
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 16px;
      font-weight: 600;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .result-message.correct {
      background: #d4edda;
      color: #155724;
      border: 2px solid #28a745;
    }

    .result-message.wrong {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #dc3545;
    }

    .congrats-container {
      text-align: center;
      animation: scaleIn 0.6s ease-out;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .congrats-container h2 {
      font-size: 42px;
      margin-bottom: 20px;
    }

    .congrats-container p {
      font-size: 18px;
      color: #555;
      margin-bottom: 30px;
      line-height: 1.8;
    }

    .back-btn {
      background: white;
      border: 2px solid #8b2f2f;
      color: #8b2f2f;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #8b2f2f;
      color: white;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-container {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f0f0f0;
      border-top-color: #8b2f2f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #666;
      font-size: 16px;
    }

    /* ì ê¸ˆ ìƒíƒœ */
    .locked-container {
      text-align: center;
      padding: 40px 20px;
    }

    .locked-container .lock-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .locked-container h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .locked-container p {
      color: #666;
      font-size: 16px;
      line-height: 1.7;
      margin-bottom: 25px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .quiz-container {
        padding: 25px 20px;
        border-radius: 20px;
      }
      .quiz-header h1 {
        font-size: 22px;
      }
      .question-text {
        font-size: 16px;
      }
      .option-btn {
        font-size: 15px;
        padding: 14px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="quiz-container" id="quizContainer">
    <!-- ë‹«ê¸° ë²„íŠ¼ -->
    <button class="close-btn" onclick="closeQuiz()" title="ë‹«ê¸°">âœ•</button>

    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">í˜•ì„±í‰ê°€ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <script>
    // ===== ì „ì—­ ë³€ìˆ˜ =====
    let quizData = [];        // ë¬¸ì œ ë°°ì—´
    let currentGate = 0;      // í˜„ì¬ ë¬¸ì œ ë²ˆí˜¸ (0~4)
    let selectedAnswer = null;
    let gateLevel = 1;        // ê´€ë¬¸ ë ˆë²¨ (1, 2, 3, ...)
    let completedUnits = [];  // ì™„ë£Œëœ ë‹¨ì› ëª©ë¡

    // ===== ì‹œê°„ ë° ì˜¤ë‹µ ì¶”ì  ë³€ìˆ˜ =====
    let quizStartTime = null;        // ì „ì²´ í€´ì¦ˆ ì‹œì‘ ì‹œê°„
    let questionStartTime = null;    // í˜„ì¬ ë¬¸í•­ ì‹œì‘ ì‹œê°„
    let questionDetails = [];        // ê° ë¬¸í•­ë³„ ìƒì„¸ ê¸°ë¡
    let currentWrongClicks = 0;      // í˜„ì¬ ë¬¸í•­ ì˜¤ë‹µ í´ë¦­ íšŸìˆ˜
    let totalWrongClicks = 0;        // ì „ì²´ ì˜¤ë‹µ í´ë¦­ íšŸìˆ˜

    // ===== ë‹«ê¸° ë²„íŠ¼ =====
    function closeQuiz() {
      if (confirm('í˜•ì„±í‰ê°€ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní†µê³¼í•˜ì§€ ëª»í•˜ë©´ ë‹¤ìŒ ë‹¨ì› í•™ìŠµì´ ì œí•œë©ë‹ˆë‹¤.')) {
        window.location.href = 'menu.html';
      }
    }

    // ===== í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸° =====
    function getCurrentStudent() {
      const saved = localStorage.getItem('currentStudent');
      if (!saved) return null;
      try {
        return JSON.parse(saved);
      } catch (e) {
        return null;
      }
    }

    // ===== URL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸° =====
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        gate: parseInt(params.get('gate')) || 1,
        units: params.get('units') ? params.get('units').split(',') : [],
        grade: params.get('grade') || '',
        name: params.get('name') || ''
      };
    }

    // ===== ì„œë²„ì—ì„œ ê´€ë¬¸ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸° =====
    async function fetchGateQuizData() {
      const student = getCurrentStudent();
      const params = getUrlParams();
      gateLevel = params.gate;

      if (!student) {
        showLockedState('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'í•™ìŠµì„ ì§„í–‰í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        // ì„œë²„ì—ì„œ ì™„ë£Œëœ ë‹¨ì›ê³¼ ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`/api/gate-quiz/generate?grade=${encodeURIComponent(student.grade)}&name=${encodeURIComponent(student.name)}&gate=${gateLevel}`);
        const result = await response.json();

        if (!result.ok) {
          showLockedState('ê´€ë¬¸ ì‹œí—˜ ì¤€ë¹„ ì¤‘', result.message || 'ì•„ì§ ê´€ë¬¸ ì‹œí—˜ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        quizData = result.quizzes;
        completedUnits = result.units;

        if (quizData.length < 5) {
          showLockedState('ë¬¸ì œ ë¶€ì¡±', `5ê°œ ë‹¨ì›ì„ ì™„ë£Œí•´ì•¼ ê´€ë¬¸ ì‹œí—˜ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${quizData.length}ê°œ)`);
          return;
        }

        renderQuiz();
      } catch (err) {
        console.error('ê´€ë¬¸ ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', err);
        showLockedState('ì˜¤ë¥˜ ë°œìƒ', 'ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== ì ê¸ˆ ìƒíƒœ í‘œì‹œ =====
    function showLockedState(title, message) {
      const container = document.getElementById('quizContainer');
      container.innerHTML = `
        <div class="locked-container">
          <div class="lock-icon">ğŸ”’</div>
          <h2>${title}</h2>
          <p>${message}</p>
          <button class="back-btn" onclick="goBack()">â† ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      `;
    }

    // ===== í€´ì¦ˆ ë Œë”ë§ =====
    function renderQuiz() {
      const container = document.getElementById('quizContainer');
      const quiz = quizData[currentGate];
      const gateNum = currentGate + 1;

      // ì‹œê°„ ì¸¡ì • ì‹œì‘
      if (!quizStartTime) {
        quizStartTime = Date.now();
      }
      questionStartTime = Date.now();
      currentWrongClicks = 0;  // í˜„ì¬ ë¬¸í•­ ì˜¤ë‹µ ì´ˆê¸°í™”

      // ë³¸ë¬¸ HTML ìƒì„±
      const passageHTML = quiz.passage && quiz.passage.length > 0
        ? quiz.passage.map(p => `<p>${p}</p>`).join('')
        : '<p>ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';

      container.innerHTML = `
        <div class="quiz-header">
          <h1>ğŸ“ í˜•ì„±í‰ê°€ ê´€ë¬¸ ${gateLevel}</h1>
          <p class="gate-number">10ê°œ ë¬¸ì œ ì¤‘ ${gateNum}ë²ˆì§¸</p>
          <p class="gate-info">ëª¨ë“  ë¬¸ì œë¥¼ ì—°ì†ìœ¼ë¡œ ë§ì¶°ì•¼ í†µê³¼í•©ë‹ˆë‹¤</p>
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar" style="width: ${(gateNum / 10) * 100}%"></div>
        </div>

        <div class="unit-title-btn" onclick="togglePassage()">
          <div>
            <span class="title-text">ğŸ“– ${quiz.unitTitle}</span>
            <span class="title-hint">ì—ì„œ ì¶œì œ (í´ë¦­í•˜ì—¬ ë³¸ë¬¸ ë³´ê¸°)</span>
          </div>
          <span class="arrow">â–¼</span>
        </div>

        <div class="passage-content" id="passageContent">
          ${passageHTML}
        </div>

        <div class="question-box">
          <p class="question-text">${quiz.question}</p>
        </div>

        <div class="options-container">
          ${quiz.options.map((option, index) => `
            <button class="option-btn" onclick="selectAnswer(${index})">
              ${['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][index]} ${option}
            </button>
          `).join('')}
        </div>

        <button class="submit-btn" onclick="submitAnswer()" disabled>
          ë‹µì•ˆ ì œì¶œ
        </button>
      `;
    }

    // ===== ë³¸ë¬¸ ì•„ì½”ë””ì–¸ í† ê¸€ =====
    function togglePassage() {
      const btn = document.querySelector('.unit-title-btn');
      const content = document.getElementById('passageContent');

      btn.classList.toggle('open');
      content.classList.toggle('open');
    }

    // ===== ë‹µì•ˆ ì„ íƒ =====
    function selectAnswer(index) {
      selectedAnswer = index;

      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => btn.classList.remove('selected'));
      buttons[index].classList.add('selected');

      document.querySelector('.submit-btn').disabled = false;
    }

    // ===== ë‹µì•ˆ ì œì¶œ =====
    function submitAnswer() {
      const quiz = quizData[currentGate];
      const buttons = document.querySelectorAll('.option-btn');
      const submitBtn = document.querySelector('.submit-btn');

      buttons.forEach(btn => btn.disabled = true);
      submitBtn.disabled = true;

      // í˜„ì¬ ë¬¸í•­ ì‹œê°„ ê³„ì‚°
      const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);

      // ì •ë‹µ ì¸ë±ìŠ¤ (1~4 -> 0~3ìœ¼ë¡œ ë³€í™˜)
      const correctIndex = quiz.correct - 1;
      const isCorrect = selectedAnswer === correctIndex;

      // ì˜¤ë‹µì¼ ê²½ìš° ë¨¼ì € ì¹´ìš´íŠ¸ ì¦ê°€ (ì €ì¥ ì „ì—)
      if (!isCorrect) {
        currentWrongClicks++;
        totalWrongClicks++;
      }

      // ë¬¸í•­ ìƒì„¸ ê¸°ë¡ ì €ì¥ (ì˜¤ë‹µ í´ë¦­ íšŸìˆ˜ í¬í•¨)
      questionDetails[currentGate] = {
        questionNo: currentGate + 1,
        unitCode: quiz.unitCode || quiz.unit || '',
        unitTitle: quiz.unitTitle || '',
        qType: quiz.qType || 'q1',
        timeSpent: timeSpent,
        wrongClicks: currentWrongClicks,
        correct: isCorrect
      };

      if (isCorrect) {
        buttons[selectedAnswer].classList.remove('selected');
        buttons[selectedAnswer].classList.add('correct');
        showResult(true);
      } else {
        buttons[selectedAnswer].classList.remove('selected');
        buttons[selectedAnswer].classList.add('wrong');
        buttons[correctIndex].classList.add('correct');
        showResult(false);
      }
    }

    // ===== í­ì£½ íš¨ê³¼ =====
    function showConfetti(count = 30) {
      const colors = ['#8b2f2f', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
      const shapes = ['â—', 'â– ', 'â–²', 'â˜…', 'â™¦', 'â™¥'];

      for (let i = 0; i < count; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-20px';
        confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.fontSize = (Math.random() * 16 + 10) + 'px';
        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
        confetti.style.animationDelay = (Math.random() * 0.5) + 's';

        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4500);
      }
    }

    // ===== ê²°ê³¼ í‘œì‹œ =====
    function showResult(isCorrect) {
      const container = document.getElementById('quizContainer');

      if (isCorrect) {
        // ì •ë‹µ í­ì£½ íš¨ê³¼
        showConfetti(30);

        const resultMsg = document.createElement('div');
        resultMsg.className = 'result-message correct';
        resultMsg.innerHTML = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™í•©ë‹ˆë‹¤...';
        container.insertBefore(resultMsg, container.firstChild);

        setTimeout(() => {
          currentGate++;
          selectedAnswer = null;

          if (currentGate >= quizData.length) {
            // í†µê³¼ - ì‹œë„ ê¸°ë¡ ì €ì¥
            saveAttemptRecord(true);
            showCongratulations();
            saveGatePass();
          } else {
            renderQuiz();
          }
        }, 1500);
      } else {
        const resultMsg = document.createElement('div');
        resultMsg.className = 'result-message wrong';
        resultMsg.innerHTML = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤! 1ë²ˆ ë¬¸ì œë¡œ ëŒì•„ê°‘ë‹ˆë‹¤...';
        container.insertBefore(resultMsg, container.firstChild);

        // ì‹¤íŒ¨ - ì‹œë„ ê¸°ë¡ ì €ì¥
        saveAttemptRecord(false);

        setTimeout(() => {
          // ì‹œê°„ ë° ê¸°ë¡ ì´ˆê¸°í™” (ì¬ì‹œë„)
          quizStartTime = Date.now();
          questionDetails = [];
          totalWrongClicks = 0;

          currentGate = 0;
          selectedAnswer = null;
          renderQuiz();
        }, 2000);
      }
    }

    // ===== ì‹œë„ ê¸°ë¡ ì €ì¥ =====
    async function saveAttemptRecord(passed) {
      // localStorageì—ì„œ í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í´ë°±: URL íŒŒë¼ë¯¸í„°)
      let student = getCurrentStudent();
      if (!student) {
        const params = getUrlParams();
        if (params.grade && params.name) {
          student = { grade: params.grade, name: params.name };
        }
      }

      if (!student) {
        console.error('saveAttemptRecord: í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
      }

      const totalTime = Math.floor((Date.now() - quizStartTime) / 1000);
      console.log('[saveAttemptRecord] grade=' + student.grade + ', name=' + student.name + ', gate=' + gateLevel + ', passed=' + passed);

      try {
        const response = await fetch('/api/gate-quiz/attempt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            grade: student.grade,
            name: student.name,
            gate: gateLevel,
            passed: passed,
            totalTime: totalTime,
            totalWrongClicks: totalWrongClicks,
            questionDetails: questionDetails.filter(q => q)  // null ì œê±°
          })
        });
        const result = await response.json();
        console.log('[saveAttemptRecord] saved successfully, gate=' + gateLevel + ', passed=' + passed, result);
      } catch (err) {
        console.error('ì‹œë„ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', err);
      }
    }

    // ===== ê´€ë¬¸ í†µê³¼ ì €ì¥ =====
    async function saveGatePass() {
      // localStorageì—ì„œ í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í´ë°±: URL íŒŒë¼ë¯¸í„°)
      let student = getCurrentStudent();
      if (!student) {
        const params = getUrlParams();
        if (params.grade && params.name) {
          student = { grade: params.grade, name: params.name };
        }
      }

      if (!student) {
        console.error('saveGatePass: í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
      }

      try {
        const res = await fetch('/api/gate-quiz/pass', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            grade: student.grade,
            name: student.name,
            gate: gateLevel,
            units: completedUnits
          })
        });
        const result = await res.json();
        console.log('[saveGatePass] saved successfully, gate=' + gateLevel);

        // ğŸ³ ê³ ë˜ ë°°ì§€ ì§€ê¸‰ ì‹œ ë¶€ëª¨ ì°½ì— ë©”ì‹œì§€ ì „ì†¡
        if (result.badgesAwarded && result.badgesAwarded > 0) {
          console.log(`ğŸ‹ [saveGatePass] ê³ ë˜ ë°°ì§€ ${result.badgesAwarded}ê°œ ì§€ê¸‰ë¨!`);

          // ì„œë²„ì—ì„œ ìµœì‹  ë°°ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          try {
            const badgeRes = await fetch(`/api/user-progress/whale-badges?grade=${encodeURIComponent(student.grade)}&name=${encodeURIComponent(student.name)}`);
            const badgeData = await badgeRes.json();

            if (badgeData.ok && window.parent) {
              window.parent.postMessage({
                type: 'WHALE_BADGE_AWARDED',
                badgesAwarded: result.badgesAwarded,
                newTotal: badgeData.totalCoins || result.badgesAwarded
              }, window.location.origin);
            }
          } catch (badgeErr) {
            console.error('ë°°ì§€ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', badgeErr);
          }
        }
      } catch (err) {
        console.error('ê´€ë¬¸ í†µê³¼ ì €ì¥ ì‹¤íŒ¨:', err);
      }
    }

    // ===== ì¶•í•˜ í™”ë©´ =====
    function showCongratulations() {
      const container = document.getElementById('quizContainer');
      const nextGate = gateLevel + 1;

      container.innerHTML = `
        <div class="congrats-container">
          <h2>ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸŠ</h2>
          <p>
            í˜•ì„±í‰ê°€ ê´€ë¬¸ ${gateLevel}ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!<br>
            10ê°œ ë¬¸ì œë¥¼ ëª¨ë‘ ë§ì¶”ì…¨ë„¤ìš”.<br><br>
            <strong>ì´ì œ ${gateLevel * 10 + 1}~${(gateLevel + 1) * 10}ë²ˆ ë‹¨ì›ì„<br>í•™ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</strong>
          </p>
          <button class="back-btn" onclick="goBack()">
            ğŸ“š í•™ìŠµ ê³„ì†í•˜ê¸°
          </button>
        </div>
      `;
    }

    // ===== ë’¤ë¡œê°€ê¸° =====
    function goBack() {
      const student = getCurrentStudent();
      if (student) {
        window.location.href = `/menu?grade=${encodeURIComponent(student.grade)}&name=${encodeURIComponent(student.name)}`;
      } else {
        window.location.href = '/';
      }
    }

    // ===== í˜ì´ì§€ ë¡œë“œ =====
    window.addEventListener('DOMContentLoaded', () => {
      fetchGateQuizData();
    });

    // ESC í‚¤ë¡œ ë’¤ë¡œê°€ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (confirm('ê´€ë¬¸ ì‹œí—˜ì„ ì¢…ë£Œí•˜ê³  ë©”ë‰´ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          goBack();
        }
      }
    });
  </script>
</body>
</html>
