<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ í•™ìŠµ ì´ë ¥ ë³´ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f2ede5;
      --panel: #fffaf3;
      --accent: #8b2f2f;
      --line: #e5d4c1;
      --text: #3b2a1a;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      min-height:100vh;
      background:var(--bg);
      font-family:"Apple SD Gothic Neo","Noto Sans KR",-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      color:var(--text);
      padding:20px 10px;
      display:flex;
      justify-content:center;
    }
    .wrap {
      width:min(980px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 14px 36px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.04);
      padding:18px 20px 24px;
    }
    h1 {
      margin:0 0 4px;
      font-size:20px;
      color:var(--accent);
    }
    .small {
      margin:0 0 12px;
      font-size:13px;
      color:#766555;
    }
    .top-actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 12px;
      font-size:13px;
      border-radius:999px;
      border:1px solid var(--accent);
      color:var(--accent);
      background:#fff;
      text-decoration:none;
      cursor:pointer;
    }
    .btn:hover { background:#fcefe9; }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td {
      border:1px solid #e1d3c4;
      padding:7px 8px;
      text-align:left;
      white-space:nowrap;
    }
    th {
      background:#f7f1e5;
      font-weight:600;
    }
    tr:nth-child(even) td {
      background:#fffaf3;
    }
    hr {
      margin:26px 0 18px;
      border:none;
      border-top:1px solid #e5d4c1;
    }
    #radar-wrap {
      display:flex;
      flex-wrap:wrap;
      gap:18px;
    }
    .radar-card {
      flex:0 0 260px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel);
      padding:10px;
    }
    .radar-card-header {
      font-size:13px;
      margin-bottom:6px;
    }
    .radar-card-header span {
      display:block;
      font-size:11px;
      color:#777;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>í•™ìƒ í•™ìŠµ ì´ë ¥</h1>
    <p class="small">
      URL ì˜ˆì‹œ: <code>/admin/branch/logs?grade=ì´ˆ6&name=í™ê¸¸ë™</code><br>
      ì„œë²„ì—ì„œ í•´ë‹¹ í•™ìƒì˜ <b>LearningLog</b>ë¥¼ ì¡°íšŒí•´ ì•„ë˜ í‘œì™€ ë ˆì´ë” ì°¨íŠ¸ì— ì±„ì›Œë„£ì„ ì˜ˆì •ì…ë‹ˆë‹¤.
    </p>

    <div class="top-actions">
      <div>
        <a href="/admin/branch/users" class="btn">â† í•™ìƒ ëª©ë¡ìœ¼ë¡œ</a>
        <a href="/admin/dashboard" class="btn">ëŒ€ì‹œë³´ë“œ</a>
      </div>
      <div>
        <!-- ë‚˜ì¤‘ì— CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë“± ì¶”ê°€ ê°€ëŠ¥ -->
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ë‚ ì§œ/ì‹œê°„</th>
          <th>ì‹œë¦¬ì¦ˆ</th>
          <th>ë‹¨ì› ì½”ë“œ</th>
        </tr>
      </thead>
      <tbody id="logs-tbody">
        <!-- ì„œë²„ì—ì„œ logs ë°°ì—´ë¡œ ë Œë”ë§ ì˜ˆì • -->
        <tr>
          <td colspan="4" style="text-align:center;">í•™ìŠµ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h3 style="margin:0 0 10px; font-size:16px;">ğŸ§  ë‹¨ì›ë³„ ë¬¸í•´ë ¥ ë ˆì´ë” ì°¨íŠ¸</h3>
    <p class="small">
      ê°€ì¥ ìµœê·¼ ê¸°ë¡ì´ ìœ„ì— ì˜¤ë„ë¡ ì •ë ¬ë˜ì–´ ìˆì–´ìš”.<br>
      (â€» ì•„ì§ radar ë°ì´í„°ê°€ ì—†ëŠ” ê¸°ë¡ì€ ê·¸ë˜í”„ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
    </p>

    <div id="radar-wrap">
      <!-- Chart.jsë¡œ ë ˆì´ë” ì°¨íŠ¸ ë™ì  ìƒì„± -->
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // URLì—ì„œ grade, name íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    const params = new URLSearchParams(window.location.search);
    const grade = params.get('grade');
    const name = params.get('name');

    if (!grade || !name) {
      document.getElementById('logs-tbody').innerHTML =
        '<tr><td colspan="4" style="text-align:center; color:red;">gradeì™€ name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.</td></tr>';
    } else {
      // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
      document.querySelector('h1').textContent = `í•™ìƒ í•™ìŠµ ì´ë ¥ â€” ${grade} ${name}`;

      // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetchLogs(grade, name);
    }

    async function fetchLogs(grade, name) {
      try {
        const response = await fetch(`/api/branch/logs?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

        const logs = data.logs || [];

        // í…Œì´ë¸” ë Œë”ë§
        renderTable(logs);

        // ë ˆì´ë” ì°¨íŠ¸ ë Œë”ë§
        renderRadarCharts(logs);

      } catch (err) {
        console.error('í•™ìŠµ ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('logs-tbody').innerHTML =
          `<tr><td colspan="4" style="text-align:center; color:red;">âŒ í•™ìŠµ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</td></tr>`;
      }
    }

    function renderTable(logs) {
      const tbody = document.getElementById('logs-tbody');

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">í•™ìŠµ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map((log, idx) => {
        const timestamp = log.timestamp ?
          new Date(log.timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }) : '-';

        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${timestamp}</td>
            <td>${log.series || ''}</td>
            <td>${log.unit || ''}</td>
          </tr>
        `;
      }).join('');
    }

    function renderRadarCharts(logs) {
      const wrap = document.getElementById('radar-wrap');
      wrap.innerHTML = ''; // ì´ˆê¸°í™”

      logs.forEach((log, idx) => {
        // radar ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
        if (!log.radar) return;

        // ì¹´ë“œ ìƒì„±
        const card = document.createElement('div');
        card.className = 'radar-card';

        // í—¤ë”
        const header = document.createElement('div');
        header.className = 'radar-card-header';

        const title = document.createElement('strong');
        title.textContent = (log.unit || 'ë‹¨ì› ë¯¸ì§€ì •') + ' ë¶„ì„ ë¦¬í¬íŠ¸';

        const time = document.createElement('span');
        time.style.display = 'block';
        time.textContent = log.timestamp ?
          new Date(log.timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }) : '-';

        header.appendChild(title);
        header.appendChild(time);
        card.appendChild(header);

        // ìº”ë²„ìŠ¤
        const canvas = document.createElement('canvas');
        canvas.id = 'radar-' + idx;
        canvas.width = 260;
        canvas.height = 260;
        card.appendChild(canvas);

        wrap.appendChild(card);

        // Chart.jsë¡œ ë ˆì´ë” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        const r = log.radar || {};

        new Chart(canvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
            datasets: [{
              label: (log.unit || 'ë‹¨ì›') + ' ë¶„ì„ë¦¬í¬íŠ¸',
              data: [
                r.literal || 0,
                r.structural || 0,
                r.lexical || 0,
                r.inferential || 0,
                r.critical || 0
              ],
              backgroundColor: 'rgba(139,47,47,0.18)',
              borderColor: '#8b2f2f',
              borderWidth: 2,
              pointBackgroundColor: '#8b2f2f'
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 10,
                ticks: {
                  stepSize: 2,
                  backdropColor: 'transparent'
                },
                grid: { color: '#e5d4c1' },
                angleLines: { color: '#e5d4c1' }
              }
            }
          }
        });
      });

      // radar ë°ì´í„°ê°€ ìˆëŠ” ì¹´ë“œê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
      if (wrap.children.length === 0) {
        wrap.innerHTML = '<p style="color:#777; font-size:13px;">ì•„ì§ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìˆëŠ” í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }
  </script>
</body>
</html>
