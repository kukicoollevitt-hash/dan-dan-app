<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìŠµ ì´ë ¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      padding: 50px;
    }

    .header {
      text-align: center;
      margin-bottom: 50px;
      padding-bottom: 30px;
      border-bottom: 3px solid #e5d4c1;
    }

    h1 {
      font-size: 42px;
      font-weight: 800;
      color: #2c3e50;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 16px;
      color: #7f8c8d;
      font-weight: 500;
    }

    .nav-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .btn {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-back {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-download {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
    }

    .btn-trash {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: white;
    }

    .btn-trash:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .stats-badge {
      display: inline-block;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
    }

    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: #2c3e50;
      margin: 50px 0 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-description {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .table-container {
      background: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 50px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      padding: 16px 20px;
      font-size: 15px;
      text-align: left;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 13px;
    }

    td {
      border-bottom: 1px solid #ecf0f1;
      color: #2c3e50;
    }

    tr:hover td {
      background: #f8f9fa;
    }

    tr:last-child td {
      border-bottom: none;
    }

    hr {
      margin: 60px 0;
      border: none;
      border-top: 2px solid #e5d4c1;
    }

    #summary-radar-wrap,
    #radar-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 30px;
      justify-content: center;
    }

    .radar-card {
      flex: 0 0 320px;
      border: 2px solid #e5d4c1;
      border-radius: 20px;
      padding: 24px;
      background: linear-gradient(135deg, #ffffff 0%, #fffaf3 100%);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .radar-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }

    .radar-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      border-color: #d4b89c;
    }

    .radar-card-header {
      margin-bottom: 20px;
      text-align: center;
      position: relative;
    }

    .delete-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: white;
      border: 2px solid white;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(238, 90, 111, 0.4);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .delete-btn:hover {
      transform: scale(1.1);
      background: linear-gradient(135deg, #ee5a6f 0%, #ff4757 100%);
      box-shadow: 0 6px 15px rgba(238, 90, 111, 0.6);
    }

    .table-delete-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(238, 90, 111, 0.3);
    }

    .table-delete-btn:hover {
      background: linear-gradient(135deg, #ee5a6f 0%, #ff4757 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(238, 90, 111, 0.5);
    }

    .radar-card-title {
      display: block;
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .radar-card-time {
      color: #95a5a6;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .radar-card-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
      gap: 10px;
    }

    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-label {
      font-size: 11px;
      color: #95a5a6;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 700;
      margin-top: 10px;
    }

    .badge-excellent {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #2d3436;
    }

    .badge-good {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
    }

    .badge-normal {
      background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
      color: #2d3436;
    }

    /* ì¢…í•© ë ˆì´ë” ì¹´ë“œ - ë¶‰ì€ ê³„ì—´ */
    .radar-card.summary-card::before {
      background: linear-gradient(90deg, #f093fb 0%, #f5576c 50%, #e74c3c 100%) !important;
    }

    .radar-card.summary-card {
      border-color: #f5c6cb;
    }

    .radar-card.summary-card:hover {
      border-color: #f5576c;
    }

    .radar-card.summary-card .stat-value {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
    }

    /* ë”ë³´ê¸° ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
    .hidden-row {
      display: none;
    }

    .hidden-card {
      display: none !important;
    }

    .toggle-btn {
      display: block;
      margin: 20px auto;
      padding: 12px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .toggle-btn:active {
      transform: translateY(0);
    }

    /* ì¤‘ì•™ ì•¡ì…˜ ë²„íŠ¼ */
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 40px 0 30px 0;
    }

    .btn-send {
      padding: 14px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-send:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-download-action {
      padding: 14px 32px;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-download-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>í•™ìŠµ ì´ë ¥</h1>
      <p class="subtitle" id="student-info">ë¡œë”© ì¤‘...</p>

      <div class="nav-buttons">
        <a class="btn btn-back" href="/admin/branch/users">
          â† í•™ìƒ ëª©ë¡ìœ¼ë¡œ
        </a>
        <a class="btn btn-download" id="csv-download-link" href="#" style="display:none;">
          ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
        </a>
        <a class="btn btn-trash" id="trash-link" href="#" style="display:none;">
          ğŸ—‘ï¸ íœ´ì§€í†µ
        </a>
      </div>
    </div>

    <div style="text-align: center;">
      <span class="stats-badge" id="stats-badge">ğŸ“š ì´ 0ê±´ì˜ í•™ìŠµ ê¸°ë¡</span>
    </div>

    <div class="section-title">
      ğŸ“ í•™ìŠµ ê¸°ë¡ ëª©ë¡
    </div>
    <p class="section-description">
      ëª¨ë“  í•™ìŠµ í™œë™ì´ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>ë‚ ì§œ/ì‹œê°„</th>
            <th>ì‹œë¦¬ì¦ˆ</th>
            <th>ë‹¨ì› ì½”ë“œ</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="logs-tbody">
          <tr>
            <td colspan="5" style="text-align:center;">í•™ìŠµ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <button class="toggle-btn" id="toggleBtn" onclick="toggleRows()" style="display:none;">ë”ë³´ê¸° â–¼</button>

    <hr>

    <div class="section-title">
      ğŸ“Š ê³¼ëª©ë³„ ì¢…í•© ë ˆì´ë”
    </div>
    <p class="section-description">
      ê³¼ëª©ë³„ë¡œ ëª¨ë“  í•™ìŠµ ë°ì´í„°ì˜ í‰ê· ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.<br/>
      (â€» radar ë°ì´í„°ê°€ ìˆëŠ” ê¸°ë¡ë“¤ë§Œ í‰ê· ì— í¬í•¨ë©ë‹ˆë‹¤.)
    </p>

    <div id="summary-radar-wrap"></div>
    <button class="toggle-btn" id="toggleSummaryBtn" onclick="toggleSummaryRadar()" style="display:none;">ë”ë³´ê¸° â–¼</button>

    <hr>

    <div class="section-title">
      ğŸ§  ë‹¨ì›ë³„ ë¬¸í•´ë ¥ ë ˆì´ë” ì°¨íŠ¸
    </div>
    <p class="section-description">
      ê°€ì¥ ìµœê·¼ ê¸°ë¡ì´ ìœ„ì— ì˜¤ë„ë¡ ì •ë ¬ë˜ì–´ ìˆì–´ìš”.<br/>
      (â€» ì•„ì§ radar ë°ì´í„°ê°€ ì—†ëŠ” ê¸°ë¡ì€ ê·¸ë˜í”„ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
    </p>

    <div id="radar-wrap"></div>
    <button class="toggle-btn" id="toggleRadarBtn" onclick="toggleRadar()" style="display:none;">ë”ë³´ê¸° â–¼</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // URLì—ì„œ grade, name íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    const params = new URLSearchParams(window.location.search);
    const grade = params.get('grade');
    const name = params.get('name');

    if (!grade || !name) {
      document.getElementById('logs-tbody').innerHTML =
        '<tr><td colspan="5" style="text-align:center; color:red;">gradeì™€ name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.</td></tr>';
    } else {
      // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
      document.querySelector('h1').textContent = 'í•™ìŠµ ì´ë ¥';
      document.getElementById('student-info').textContent = `${grade} ${name}`;

      // CSV ë‹¤ìš´ë¡œë“œ ë§í¬ í™œì„±í™” (ë‚˜ì¤‘ì— êµ¬í˜„)
      // document.getElementById('csv-download-link').style.display = 'inline-block';
      // document.getElementById('csv-download-link').href = `/admin/branch/logs-export?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}`;

      // íœ´ì§€í†µ ë§í¬ í™œì„±í™” (ë‚˜ì¤‘ì— êµ¬í˜„)
      // document.getElementById('trash-link').style.display = 'inline-block';

      // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetchLogs(grade, name);
    }

    async function fetchLogs(grade, name) {
      try {
        const response = await fetch(`/api/branch/logs?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

        const logs = data.logs || [];
        window.logsData = logs; // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥

        // í†µê³„ ë°°ì§€ ì—…ë°ì´íŠ¸
        document.getElementById('stats-badge').textContent = `ğŸ“š ì´ ${logs.length}ê±´ì˜ í•™ìŠµ ê¸°ë¡`;

        // í…Œì´ë¸” ë Œë”ë§
        renderTable(logs);

        // ì¢…í•© ë ˆì´ë” ì°¨íŠ¸ ë Œë”ë§
        renderSummaryRadar(logs);

        // ê°œë³„ ë ˆì´ë” ì°¨íŠ¸ ë Œë”ë§
        renderRadarCharts(logs);

      } catch (err) {
        console.error('í•™ìŠµ ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('logs-tbody').innerHTML =
          `<tr><td colspan="5" style="text-align:center; color:red;">âŒ í•™ìŠµ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</td></tr>`;
      }
    }

    // ===== ì‚­ì œ ê¸°ëŠ¥ (ê´€ë¦¬ì ì „ìš©) =====
    function deleteLog(logId) {
      if (!confirm('ì´ í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì‚­ì œëœ í•­ëª©ì€ íœ´ì§€í†µì—ì„œ ë³µêµ¬í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
        return;
      }

      fetch(`/admin/log/delete/${logId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
          window.location.reload();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
        }
      })
      .catch(err => {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      });
    }

    function renderTable(logs) {
      const tbody = document.getElementById('logs-tbody');

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">í•™ìŠµ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map((log, idx) => {
        const timestamp = log.timestamp ?
          new Date(log.timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }) : '-';

        const hiddenClass = idx >= 6 ? ' class="hidden-row"' : '';
        return `
          <tr${hiddenClass}>
            <td>${idx + 1}</td>
            <td>${timestamp}</td>
            <td>${log.series || ''}</td>
            <td>${log.unit || ''}</td>
            <td>
              <button class="table-delete-btn" onclick="deleteLog('${log._id}')">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (logs.length > 6) {
        document.getElementById('toggleBtn').style.display = 'block';
      }
    }

    // ===== í•™ìŠµ ê¸°ë¡ ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
    function toggleRows() {
      const hiddenRows = document.querySelectorAll('.hidden-row');
      const toggleBtn = document.getElementById('toggleBtn');

      if (hiddenRows.length === 0) return;

      const isHidden = hiddenRows[0].style.display === 'none' || hiddenRows[0].style.display === '';

      hiddenRows.forEach(row => {
        row.style.display = isHidden ? 'table-row' : 'none';
      });

      toggleBtn.textContent = isHidden ? 'ì ‘ê¸° â–²' : 'ë”ë³´ê¸° â–¼';
    }

    // ===== ì¢…í•© ë ˆì´ë” ì°¨íŠ¸ ìƒì„± =====
    function renderSummaryRadar(logs) {
      const summaryWrap = document.getElementById('summary-radar-wrap');

      // ê³¼ëª© ì½”ë“œ â†’ ê³¼ëª©ëª… ë§¤í•‘
      const subjectNames = {
        'geo': 'ì§€ë¦¬',
        'soc': 'ì¼ë°˜ì‚¬íšŒ',
        'law': 'ë²•ê³¼ì •ì¹˜',
        'pol': 'ì •ì¹˜'
      };

      // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™” (unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ: geo, history ë“±)
      const subjectGroups = {};
      logs.forEach(log => {
        if (!log.radar || !log.unit) return;

        // unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ (geo_01 -> geo, history_01 -> history)
        const subjectCode = log.unit.split('_')[0];
        const subjectKey = (log.series || 'BRAINì—…') + '_' + subjectCode;

        if (!subjectGroups[subjectKey]) {
          subjectGroups[subjectKey] = {
            series: log.series || 'BRAINì—…',
            subjectCode: subjectCode,
            logs: []
          };
        }
        subjectGroups[subjectKey].logs.push(log);
      });

      // ê° ê³¼ëª©ë³„ë¡œ í‰ê·  ê³„ì‚° ë° ì°¨íŠ¸ ìƒì„±
      let summaryIndex = 0;
      Object.keys(subjectGroups).forEach(key => {
        const group = subjectGroups[key];
        const seriesLogs = group.logs;
        const subjectName = subjectNames[group.subjectCode] || group.subjectCode;
        const displayTitle = group.series + ' ' + subjectName;

        // í‰ê·  ê³„ì‚°
        let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
        let totalInferential = 0, totalCritical = 0;
        let count = 0;

        seriesLogs.forEach(log => {
          if (log.radar) {
            totalLiteral += log.radar.literal || 0;
            totalStructural += log.radar.structural || 0;
            totalLexical += log.radar.lexical || 0;
            totalInferential += log.radar.inferential || 0;
            totalCritical += log.radar.critical || 0;
            count++;
          }
        });

        if (count === 0) return;

        const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
        const avgStructural = Math.round((totalStructural / count) * 10) / 10;
        const avgLexical = Math.round((totalLexical / count) * 10) / 10;
        const avgInferential = Math.round((totalInferential / count) * 10) / 10;
        const avgCritical = Math.round((totalCritical / count) * 10) / 10;

        const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
        const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
        const maxScore = Math.max(...scores).toFixed(1);
        const minScore = Math.min(...scores).toFixed(1);

        // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
        let badgeClass = 'badge-normal';
        let badgeText = 'ë³´í†µ';
        if (avgScore >= 9) {
          badgeClass = 'badge-excellent';
          badgeText = 'ìš°ìˆ˜';
        } else if (avgScore >= 8) {
          badgeClass = 'badge-good';
          badgeText = 'ì–‘í˜¸';
        } else if (avgScore >= 7) {
          badgeClass = 'badge-normal';
          badgeText = 'ë³´í†µ';
        }

        // ì°¨íŠ¸ ì¹´ë“œ ìƒì„±
        const card = document.createElement('div');
        card.className = 'radar-card summary-card' + (summaryIndex >= 6 ? ' hidden-card' : '');
        summaryIndex++;

        const header = document.createElement('div');
        header.className = 'radar-card-header';

        const title = document.createElement('div');
        title.className = 'radar-card-title';
        title.textContent = displayTitle;

        const subtitle = document.createElement('div');
        subtitle.className = 'radar-card-time';
        subtitle.innerHTML = 'ğŸ“š ì´ ' + count + 'íšŒ í•™ìŠµ';

        const badge = document.createElement('div');
        badge.className = 'score-badge ' + badgeClass;
        badge.textContent = badgeText + ' ë“±ê¸‰';

        header.appendChild(title);
        header.appendChild(subtitle);
        header.appendChild(badge);
        card.appendChild(header);

        const canvas = document.createElement('canvas');
        canvas.width = 280;
        canvas.height = 280;
        card.appendChild(canvas);

        // í†µê³„ ì •ë³´
        const stats = document.createElement('div');
        stats.className = 'radar-card-stats';
        stats.innerHTML =
          '<div class="stat-item">' +
            '<div class="stat-label">í‰ê· </div>' +
            '<div class="stat-value">' + avgScore + '</div>' +
          '</div>' +
          '<div class="stat-item">' +
            '<div class="stat-label">ìµœê³ </div>' +
            '<div class="stat-value">' + maxScore + '</div>' +
          '</div>' +
          '<div class="stat-item">' +
            '<div class="stat-label">ìµœì €</div>' +
            '<div class="stat-value">' + minScore + '</div>' +
          '</div>';
        card.appendChild(stats);

        summaryWrap.appendChild(card);

        // ì°¨íŠ¸ ìƒì„±
        new Chart(canvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
            datasets: [{
              label: displayTitle,
              data: scores,
              backgroundColor: 'rgba(245, 87, 108, 0.2)',
              borderColor: '#f5576c',
              borderWidth: 3,
              pointBackgroundColor: '#f5576c',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 10,
                ticks: {
                  stepSize: 2,
                  backdropColor: 'transparent',
                  font: { size: 11 }
                },
                pointLabels: {
                  font: { size: 12, weight: 'bold' }
                },
                grid: { color: '#e5d4c1' },
                angleLines: { color: '#e5d4c1' }
              }
            }
          }
        });
      });

      // ì¢…í•© ë ˆì´ë” ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (summaryIndex > 6) {
        document.getElementById('toggleSummaryBtn').style.display = 'block';
      }

      // ì¢…í•© ë ˆì´ë”ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
      if (summaryIndex === 0) {
        summaryWrap.innerHTML = '<p style="color:#777; font-size:13px;">ì•„ì§ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìˆëŠ” í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ===== ì¢…í•© ë ˆì´ë” ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
    function toggleSummaryRadar() {
      const allCards = document.querySelectorAll('#summary-radar-wrap .radar-card');
      const toggleBtn = document.getElementById('toggleSummaryBtn');
      const isExpanded = toggleBtn.textContent.includes('ì ‘ê¸°');

      allCards.forEach((card, index) => {
        if (index >= 6) {
          if (isExpanded) {
            card.classList.add('hidden-card');
          } else {
            card.classList.remove('hidden-card');
          }
        }
      });

      toggleBtn.textContent = isExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
    }

    function renderRadarCharts(logs) {
      const wrap = document.getElementById('radar-wrap');
      let radarIndex = 0;

      logs.forEach(function(log, idx) {
        if (!log.radar) return;

        const r = log.radar || {};

        // í‰ê·  ì ìˆ˜ ê³„ì‚°
        const scores = [
          r.literal || 0,
          r.structural || 0,
          r.lexical || 0,
          r.inferential || 0,
          r.critical || 0
        ];
        const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
        const maxScore = Math.max(...scores).toFixed(1);
        const minScore = Math.min(...scores).toFixed(1);

        // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
        let badgeClass = 'badge-normal';
        let badgeText = 'ë³´í†µ';
        if (avgScore >= 9) {
          badgeClass = 'badge-excellent';
          badgeText = 'ìš°ìˆ˜';
        } else if (avgScore >= 8) {
          badgeClass = 'badge-good';
          badgeText = 'ì–‘í˜¸';
        } else if (avgScore >= 7) {
          badgeClass = 'badge-normal';
          badgeText = 'ë³´í†µ';
        }

        const card = document.createElement('div');
        card.className = 'radar-card' + (radarIndex >= 6 ? ' hidden-card' : '');

        const header = document.createElement('div');
        header.className = 'radar-card-header';

        // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'âœ•';
        deleteBtn.onclick = function() {
          deleteLog(log._id);
        };
        header.appendChild(deleteBtn);

        const title = document.createElement('div');
        title.className = 'radar-card-title';
        title.textContent = (log.unit || 'ë‹¨ì› ë¯¸ì§€ì •');

        const time = document.createElement('div');
        time.className = 'radar-card-time';
        time.innerHTML = 'ğŸ• ' + (log.timestamp ? new Date(log.timestamp).toLocaleString('ko-KR') : '-');

        const badge = document.createElement('div');
        badge.className = 'score-badge ' + badgeClass;
        badge.textContent = badgeText + ' ë“±ê¸‰';

        header.appendChild(title);
        header.appendChild(time);
        header.appendChild(badge);
        card.appendChild(header);

        const canvas = document.createElement('canvas');
        canvas.id = 'radar-' + idx;
        canvas.width = 280;
        canvas.height = 280;
        card.appendChild(canvas);

        // í†µê³„ ì •ë³´
        const stats = document.createElement('div');
        stats.className = 'radar-card-stats';
        stats.innerHTML =
          '<div class="stat-item">' +
            '<div class="stat-label">í‰ê· </div>' +
            '<div class="stat-value">' + avgScore + '</div>' +
          '</div>' +
          '<div class="stat-item">' +
            '<div class="stat-label">ìµœê³ </div>' +
            '<div class="stat-value">' + maxScore + '</div>' +
          '</div>' +
          '<div class="stat-item">' +
            '<div class="stat-label">ìµœì €</div>' +
            '<div class="stat-value">' + minScore + '</div>' +
          '</div>';
        card.appendChild(stats);

        wrap.appendChild(card);

        new Chart(canvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
            datasets: [{
              label: (log.unit || 'ë‹¨ì›') + ' ë¶„ì„ë¦¬í¬íŠ¸',
              data: scores,
              backgroundColor: 'rgba(102, 126, 234, 0.2)',
              borderColor: '#667eea',
              borderWidth: 3,
              pointBackgroundColor: '#667eea',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 10,
                ticks: {
                  stepSize: 2,
                  backdropColor: 'transparent',
                  font: { size: 11 }
                },
                pointLabels: {
                  font: { size: 12, weight: 'bold' }
                },
                grid: { color: '#e5d4c1' },
                angleLines: { color: '#e5d4c1' }
              }
            }
          }
        });

        radarIndex++;
      });

      // ê°œë³„ ë ˆì´ë” ì°¨íŠ¸ ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (radarIndex > 6) {
        document.getElementById('toggleRadarBtn').style.display = 'block';
      }

      // radar ë°ì´í„°ê°€ ìˆëŠ” ì¹´ë“œê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
      if (wrap.children.length === 0) {
        wrap.innerHTML = '<p style="color:#777; font-size:13px;">ì•„ì§ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìˆëŠ” í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ===== ë‹¨ì›ë³„ ë ˆì´ë” ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
    function toggleRadar() {
      const allCards = document.querySelectorAll('#radar-wrap .radar-card');
      const toggleBtn = document.getElementById('toggleRadarBtn');
      const isExpanded = toggleBtn.textContent.includes('ì ‘ê¸°');

      allCards.forEach((card, index) => {
        if (index >= 6) {
          if (isExpanded) {
            card.classList.add('hidden-card');
          } else {
            card.classList.remove('hidden-card');
          }
        }
      });

      toggleBtn.textContent = isExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
    }

    // ===== PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ =====
    async function downloadPDF() {
      const container = document.querySelector('.container');
      const { jsPDF } = window.jspdf;

      try {
        // ëª¨ë“  hidden ìš”ì†Œë¥¼ ì„ì‹œë¡œ í‘œì‹œ
        const hiddenRows = document.querySelectorAll('.hidden-row');
        const hiddenCards = document.querySelectorAll('.hidden-card');
        const toggleBtns = document.querySelectorAll('.toggle-btn');

        hiddenRows.forEach(row => row.style.display = 'table-row');
        hiddenCards.forEach(card => card.classList.remove('hidden-card'));
        toggleBtns.forEach(btn => btn.style.display = 'none');

        const canvas = await html2canvas(container, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });

        // ì›ë˜ëŒ€ë¡œ ë³µêµ¬
        hiddenRows.forEach((row, idx) => {
          if (idx >= 6) row.style.display = 'none';
        });
        hiddenCards.forEach(card => card.classList.add('hidden-card'));
        toggleBtns.forEach(btn => {
          if (btn.textContent.includes('ë”ë³´ê¸°') || btn.textContent.includes('ì ‘ê¸°')) {
            btn.style.display = 'block';
          }
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.5);
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        const fileName = `í•™ìŠµì´ë ¥_${grade}_${name}_${new Date().toISOString().slice(0, 10)}.pdf`;
        pdf.save(fileName);
      } catch (error) {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>

  <script>
    // í•™ìŠµì´ë ¥ ì „ì†¡ (mailto ë°©ì‹)
    function openSendModal() {
      const subject = `[ë‹¨ë‹¨êµì‹¤] ${grade} ${name} í•™ìƒ í•™ìŠµì´ë ¥`;
      const body = `ì•ˆë…•í•˜ì„¸ìš”,\n\n${grade} ${name} í•™ìƒì˜ í•™ìŠµì´ë ¥ ë¦¬í¬íŠ¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.\n\nğŸ“Š í•™ìŠµ ë¶„ì„ ë‚´ìš©:\n- í•™ìŠµ ê¸°ë¡ ë° ì ìˆ˜\n- ë‹¨ì›ë³„ ë¬¸ì œë³„ ë ˆì´ë” ì°¨íŠ¸\n- ì¢…í•© ë¶„ì„ ê²°ê³¼\n\nìì„¸í•œ ë‚´ìš©ì€ ì²¨ë¶€ëœ PDF íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nâ€» PDF íŒŒì¼ì€ 'ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¨¼ì € ì €ì¥í•œ í›„ ì´ë©”ì¼ì— ì²¨ë¶€í•´ì£¼ì„¸ìš”.\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;

      const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

      console.log('ğŸ“§ ì´ë©”ì¼ ì•± ì—´ê¸°:', mailtoLink);
      window.location.href = mailtoLink;
    }
  </script>

  <div class="action-buttons">
    <button class="btn-send" onclick="openSendModal()">
      ğŸ“¤ ì „ì†¡í•˜ê¸°
    </button>
    <button class="btn-download-action" onclick="downloadPDF()">
      ğŸ“¥ ë‹¤ìš´ë¡œë“œ
    </button>
  </div>

</body>
</html>
