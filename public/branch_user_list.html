<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¨ë‹¨êµ­ì–´í•™ì› í•™ìƒ ëª©ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      --panel: #ffffff;
      --accent: #495057;
      --accent-hover: #212529;
      --text: #212529;
      --text-light: #495057;
      --line: #dee2e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      font-family: "Gmarket Sans", "Noto Sans KR", -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      padding: 40px 20px;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 32px;
      font-weight: 700;
      color: #212529;
      text-shadow: none;
    }
    .desc {
      font-size: 15px;
      color: #495057;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .top-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 24px;
    }

    .btn-back {
      font-size: 14px;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 12px;
      border: 2px solid rgba(73, 80, 87, 0.2);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      color: #212529;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }
    .btn-back:hover {
      background: rgba(255,255,255,1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
      flex-wrap: wrap;
    }
    .left-info {
      background: rgba(255,255,255,0.95);
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 14px;
      color: var(--text);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .right-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    input[type="text"] {
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid rgba(6, 182, 212, 0.2);
      font-size: 14px;
      min-width: 200px;
      transition: all 0.3s ease;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }
    button, .btn {
      font-size: 14px;
      font-weight: 600;
      padding: 10px 18px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    .btn-outline {
      background: white;
      border: 2px solid rgba(6, 182, 212, 0.3);
      color: var(--accent);
    }
    .btn-outline:hover {
      background: rgba(6, 182, 212, 0.05);
      border-color: var(--accent);
    }

    .panel {
      background: var(--panel);
      border-radius: 20px;
      border: 2px solid rgba(6, 182, 212, 0.2);
      padding: 24px;
      overflow-x: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }
    th, td {
      border-bottom: 1px solid var(--line);
      padding: 14px 12px;
      font-size: 14px;
      text-align: left;
      font-weight: 500;
      color: var(--text);
    }
    th {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
      color: white;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tbody tr {
      transition: all 0.2s ease;
    }
    tbody tr:hover {
      background: #f9fafb;
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    tr.empty-row td {
      text-align: center;
      color: #dc2626;
    }
    .num-col { width: 50px; text-align: center; }
    .center { text-align: center; }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      vertical-align: middle;
    }
    .badge-approved {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }
    .badge-pending {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }

    .link-text {
      color: var(--accent);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .link-text:hover {
      color: var(--accent-hover);
      text-decoration: underline;
    }

    .error-msg {
      font-size: 14px;
      color: #dc2626;
      margin-top: 12px;
      padding: 12px 18px;
      background: #fee2e2;
      border-radius: 12px;
      border: 2px solid #fca5a5;
    }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .checkbox-col {
      width: 50px;
      text-align: center;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
    }
    .btn-delete-selected {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: #fff;
      display: none;
    }
    .btn-delete-selected:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
    }
    .btn-delete-selected.show {
      display: inline-flex;
    }

    /* ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999;
    }
    .modal-overlay.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-box {
      background: #fff;
      border-radius: 20px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(6, 182, 212, 0.2);
    }
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent);
    }
    .modal-subtitle {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .checkbox-list {
      margin-bottom: 24px;
    }
    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      padding: 14px;
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      border-radius: 12px;
      border: 2px solid rgba(6, 182, 212, 0.1);
      transition: all 0.3s ease;
    }
    .checkbox-item:hover {
      background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
    }
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-top: 2px;
      flex-shrink: 0;
      accent-color: var(--accent);
    }
    .checkbox-item label {
      font-size: 14px;
      cursor: pointer;
      flex: 1;
      line-height: 1.5;
    }
    .series-name {
      font-weight: 700;
      color: var(--accent);
      display: block;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .series-desc {
      font-size: 13px;
      color: var(--text-light);
      display: block;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    .modal-btn-submit {
      background: var(--accent);
      color: #fff;
    }

    /* ìë™ê³¼ì œ ìŠ¤ì¼€ì¤„ ìŠ¤íƒ€ì¼ */
    .auto-schedule-cell {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 600px;
    }
    .no-schedule {
      color: #9ca3af;
      font-size: 14px;
    }
    .schedule-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #f3f4f6;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      font-size: 12px;
      min-width: 200px;
      max-width: 280px;
      flex: 0 0 auto;
    }
    .schedule-item.paused {
      border-left-color: #9ca3af;
      background: #f9fafb;
    }
    .schedule-info {
      flex: 1;
    }
    .schedule-subject {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .schedule-details {
      font-size: 12px;
      color: #6b7280;
    }
    .schedule-status {
      display: inline-block;
      margin-top: 4px;
      padding: 2px 8px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .schedule-item.paused .schedule-status {
      background: #e5e7eb;
      color: #6b7280;
    }
    .schedule-actions {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }
    .btn-icon {
      width: 28px;
      height: 28px;
      border: none;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      background: #e5e7eb;
    }
    .btn-icon.btn-delete:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    /* í•™ìƒ ì´ë¦„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-student {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .btn-student:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* ìë™ ê³¼ì œ ë¶€ì—¬ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .auto-task-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .auto-task-modal.show {
      display: flex;
    }
    .auto-task-modal .modal-box {
      max-width: 600px;
      width: 90%;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--accent);
    }
    .form-group select,
    .form-group input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
    }
    .days-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .day-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .day-checkbox:hover {
      background: #f0fdfa;
      border-color: var(--accent);
    }
    .day-checkbox input[type="checkbox"]:checked + label {
      font-weight: 600;
      color: var(--accent);
    }
  </style>
  <!-- ì¹´ì¹´ì˜¤ SDK -->
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body>
  <div class="wrap">

    <!-- âœ… ë²„íŠ¼ì„ ì œëª© ìœ„ë¡œ ì´ë™ -->

    <h1 id="page-title">í•™ìƒ ëª©ë¡ ë¡œë”© ì¤‘...</h1>
    <p class="desc" id="page-desc">
      í•™ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </p>

      <div class="top-row">
      <a class="btn-back" href="/admin/dashboard">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="toolbar">
      <div class="left-info">
        ì´ <span id="total-count">0</span>ëª…ì˜ í•™ìƒì´ ìˆìŠµë‹ˆë‹¤.
      </div>
      <div class="right-actions">
        <button id="btn-add-student" class="btn btn-primary" style="background: #10b981; border-color: #10b981;" onclick="openAddStudentModal()">+ í•™ìƒ ì¶”ê°€</button>
        <button id="btn-delete-selected" class="btn-delete-selected">ì„ íƒ ì‚­ì œ (<span id="selected-count">0</span>)</button>
        <input type="text" id="search-input" placeholder="ì´ë¦„ ê²€ìƒ‰" />
        <select id="sort-select" class="btn btn-outline">
          <option value="lastLoginDesc">ìµœê·¼ ë¡œê·¸ì¸ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)</option>
          <option value="lastLoginAsc">ìµœê·¼ ë¡œê·¸ì¸ìˆœ(ì˜¤ë¦„ì°¨ìˆœ)</option>
          <option value="gradeAsc">í•™ë…„ ì˜¤ë¦„ì°¨ìˆœ</option>
          <option value="gradeDesc">í•™ë…„ ë‚´ë¦¼ì°¨ìˆœ</option>
          <option value="nameAsc">ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ</option>
          <option value="nameDesc">ì´ë¦„ ì—­ìˆœ</option>
        </select>
        <button id="search-btn">ê²€ìƒ‰</button>
        <button id="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
        <button id="btn-ai-tasks" class="btn btn-outline" style="display: none; background: #667eea; color: #fff; border-color: #667eea;">ğŸ¤– AI ì¶”ì²œê³¼ì œ ëª©ë¡</button>
        <button id="btn-auto-task" class="btn btn-primary" style="display: none; background: #667eea; color: #fff; border-color: #667eea;">ğŸ“š ìë™ ê³¼ì œ ë¶€ì—¬</button>
        <button id="btn-delete-all" style="background: #dc2626; color: #fff; border-color: #dc2626;">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
        <a id="btn-export" class="btn btn-outline" href="#">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
        <a id="btn-trash" class="btn btn-outline" href="#">íœ´ì§€í†µ ë³´ê¸°</a>
      </div>
    </div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th class="checkbox-col"><input type="checkbox" id="select-all" /></th>
            <th class="num-col">#</th>
            <th>í•™ë…„</th>
            <th>ë°˜</th>
            <th>ë²ˆí˜¸</th>
            <th>ì´ë¦„</th>
            <th>í•™êµëª…</th>
            <th>í•™ë…„ë°˜ë²ˆí˜¸(ID)</th>
            <th style="cursor: pointer;" onclick="sortByPendingTasks()" title="í´ë¦­í•˜ë©´ ë¯¸ì™„ë£Œ ê³¼ì œìˆœìœ¼ë¡œ ì •ë ¬">
              í•™ìŠµì‹¤ ìƒíƒœ <span id="studyRoomSortIcon" style="font-size: 12px;">â†•</span>
            </th>
            <th>ìƒíƒœ</th>
            <th>ì‹œë¦¬ì¦ˆ ë¶€ì—¬</th>
            <th>ê³¼ì œ ì•Œë¦¼</th>
            <th>ìˆ˜ì •</th>
            <th>íœ´ì§€í†µ</th>
          </tr>
        </thead>
        <tbody id="student-tbody">
          <tr class="empty-row">
            <td colspan="14">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="error-box" class="error-msg" style="display:none;"></div>
  </div>

  <!-- í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="add-student-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box" style="max-width: 500px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div class="modal-title">+ í•™ìƒ ì¶”ê°€</div>
        <button onclick="closeAddStudentModal()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">âœ•</button>
      </div>
      <form id="add-student-form" onsubmit="submitAddStudent(event)">
        <!-- í•™êµ/í•™ë…„/ë°˜ ìë™ í‘œì‹œ (ì½ê¸°ì „ìš©) -->
        <div style="margin-bottom: 16px; padding: 12px 14px; background: #f3f4f6; border-radius: 8px; color: #666; font-size: 14px;">
          <span id="add-info-display">í•™êµ/í•™ë…„/ë°˜ ì •ë³´ ë¡œë”© ì¤‘...</span>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">ì´ë¦„ *</label>
          <input type="text" id="add-name" placeholder="í•™ìƒ ì´ë¦„" required style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">ì „í™”ë²ˆí˜¸ ë’¤4ìë¦¬ *</label>
          <input type="text" id="add-number" placeholder="ì˜ˆ: 1234" maxlength="4" required style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          <div style="margin-top: 6px; font-size: 12px; color: #888;">* ë¹„ë°€ë²ˆí˜¸(ID)ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</div>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" onclick="closeAddStudentModal()" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; color: #666; font-weight: 600; cursor: pointer;">ì·¨ì†Œ</button>
          <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: #10b981; color: #fff; font-weight: 600; cursor: pointer;">ì¶”ê°€í•˜ê¸°</button>
        </div>
      </form>
    </div>
  </div>

  <!-- AI ì¶”ì²œê³¼ì œ ëª©ë¡ ëª¨ë‹¬ -->
  <div id="ai-tasks-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div class="modal-title">ğŸ¤– AI ì¶”ì²œê³¼ì œ ëª©ë¡</div>
        <button id="close-ai-tasks-modal" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #666;">âœ•</button>
      </div>
      <div style="margin-bottom: 16px; color: #666; font-size: 14px;">
        ì´ <span id="ai-tasks-count">0</span>ê°œì˜ AI ì¶”ì²œê³¼ì œê°€ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">#</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">í•™ë…„</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ì´ë¦„</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">í•™êµëª…</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 200px;">ê³¼ì œëª…</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ì‹œë¦¬ì¦ˆ</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ë¶„ì•¼</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ê³¼ëª©</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ë¶€ì—¬ì‹œê°„</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ìƒíƒœ</th>
            </tr>
          </thead>
          <tbody id="ai-tasks-tbody">
            <tr>
              <td colspan="10" style="padding: 40px; text-align: center; color: #999;">ë¡œë”© ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ìë™ ê³¼ì œ ë¶€ì—¬ ëª¨ë‹¬ -->
  <div id="auto-task-modal" class="auto-task-modal">
    <div class="modal-box">
      <div class="modal-title">ğŸ“š ìë™ ê³¼ì œ ë¶€ì—¬</div>
      <div class="modal-subtitle">ì„ íƒí•œ í•™ìƒë“¤ì—ê²Œ ìë™ìœ¼ë¡œ ê³¼ì œë¥¼ ë¶€ì—¬í•˜ëŠ” ìŠ¤ì¼€ì¤„ì„ ì„¤ì •í•©ë‹ˆë‹¤.</div>

      <div class="form-group">
        <label>ìš”ì¼ ì„ íƒ</label>
        <div class="days-group">
          <div class="day-checkbox">
            <input type="checkbox" id="day-all" value="all" />
            <label for="day-all">ë§¤ì¼</label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-1" value="1" />
            <label for="day-1">ì›”</label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-2" value="2" />
            <label for="day-2">í™”</label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-3" value="3" />
            <label for="day-3">ìˆ˜</label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-4" value="4" />
            <label for="day-4">ëª©</label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-5" value="5" />
            <label for="day-5">ê¸ˆ</label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-6" value="6" />
            <label for="day-6">í† </label>
          </div>
          <div class="day-checkbox">
            <input type="checkbox" id="day-0" value="0" />
            <label for="day-0">ì¼</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>ì‹œë¦¬ì¦ˆ ì„ íƒ</label>
        <select id="auto-series-select">
          <option value="all">ì „ì²´</option>
          <option value="BRAINì€">BRAIN ON</option>
          <option value="BRAINì•”">BRAIN UP</option>
          <option value="BRAINë¹›">BRAIN FIT</option>
          <option value="BRAINë‹µ">BRAIN DEEP</option>
          <option value="BRAINì¤‘ë“±">ì‹¤ì „</option>
        </select>
      </div>

      <div class="form-group">
        <label>ê³¼ëª© ì„ íƒ</label>
        <select id="auto-subject-select">
          <option value="">ì „ì²´</option>
          <option value="science">ê³¼í•™</option>
          <option value="social">ì‚¬íšŒ</option>
          <option value="korlit">êµ­ë¬¸í•™</option>
        </select>
      </div>

      <div class="form-group">
        <label>1ì¼ ê³¼ì œ ê°œìˆ˜</label>
        <input type="number" id="auto-task-count" min="1" max="5" value="1" />
      </div>

      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeAutoTaskModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-btn-submit" onclick="submitAutoTask()">ì„¤ì •í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ëª¨ë‹¬ -->
  <div id="series-modal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">ì‹œë¦¬ì¦ˆ ë¶€ì—¬</div>
      <div class="modal-subtitle" id="modal-student-name">í•™ìƒ: </div>

      <div class="checkbox-list">
        <div class="checkbox-item">
          <input type="checkbox" id="series-brainun" value="BRAINì€" />
          <label for="series-brainun">
            <span class="series-name">BRAIN ON</span>
            <span class="series-desc">ê°œë…ì´í•´ (3/4/5í•™ë…„ ì¶”ì²œ)</span>
          </label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="series-brainam" value="BRAINì•”" />
          <label for="series-brainam">
            <span class="series-name">BRAIN UP</span>
            <span class="series-desc">ì‘ìš©ì ìš© (4/5/6í•™ë…„ ì¶”ì²œ)</span>
          </label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="series-brainbit" value="BRAINë¹›" />
          <label for="series-brainbit">
            <span class="series-name">BRAIN FIT</span>
            <span class="series-desc">ì‚¬ê³ ì—°ê²° (ì¤‘1/ì¤‘2 ì¶”ì²œ)</span>
          </label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="series-braindap" value="BRAINë‹µ" />
          <label for="series-braindap">
            <span class="series-name">BRAIN DEEP</span>
            <span class="series-desc">ì‹¬í™”ì¶”ë¡  (ì¤‘3/ê³ 1 ì¶”ì²œ)</span>
          </label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="series-brainjung" value="BRAINì¤‘ë“±" />
          <label for="series-brainjung">
            <span class="series-name">ì‹¤ì „</span>
            <span class="series-desc">ì‹¤ì „í•™ìŠµ(ìˆ˜ëŠ¥ëª¨ê³ )</span>
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeSeriesModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-btn-submit" onclick="submitSeries()">ë¶€ì—¬í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_KEY = "DandanAdminKey!";
    let currentAcademyName = "";

    async function fetchBranchStudents(q = "", sort = "") {
      const tbody = document.getElementById("student-tbody");
      const errorBox = document.getElementById("error-box");
      errorBox.style.display = "none";

      tbody.innerHTML = `
        <tr class="empty-row">
          <td colspan="14">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</td>
        </tr>
      `;

      try {
        let params = "";
        if (q) params += "?q=" + encodeURIComponent(q);
        if (sort) params += (params ? "&" : "?") + "sort=" + encodeURIComponent(sort);

        const res = await fetch("/api/branch/users" + params, {
          credentials: "include",
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        const list = data.students || data.users || [];

        // ì„ ìƒë‹˜ í•™ë…„/ë°˜ ì •ë³´ ì €ì¥ (ì œëª© í‘œì‹œìš©)
        window.adminGrade = data.adminGrade || "";
        window.adminClassNum = data.adminClassNum || "";

        renderTable(list);
      } catch (err) {
        tbody.innerHTML = `
          <tr class="empty-row">
            <td colspan="14">âŒ í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td>
          </tr>
        `;
        errorBox.textContent = "ì˜¤ë¥˜: " + err.message;
        errorBox.style.display = "block";
      }
    }

    function renderTable(list) {
      const tbody = document.getElementById("student-tbody");
      const totalEl = document.getElementById("total-count");

      if (!Array.isArray(list) || list.length === 0) {
        totalEl.textContent = "0";
        tbody.innerHTML = `
          <tr class="empty-row"><td colspan="14">í‘œì‹œí•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        `;
        return;
      }

      totalEl.textContent = list.length;

      const firstSchool = list[0].school || "";
      if (firstSchool) {
        currentAcademyName = firstSchool;
        // í•™ë…„/ë°˜ ì •ë³´ê°€ ìˆìœ¼ë©´ í•¨ê»˜ í‘œì‹œ (ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ 4í•™ë…„ 7ë°˜ í•™ìƒ ëª©ë¡)
        let titleText = firstSchool;
        let descText = firstSchool;
        if (window.adminGrade || window.adminClassNum) {
          const gradeClassText = [window.adminGrade, window.adminClassNum].filter(Boolean).join(" ");
          if (gradeClassText) {
            titleText = firstSchool + " " + gradeClassText;
            descText = firstSchool + " " + gradeClassText;
          }
        }
        document.getElementById("page-title").textContent = titleText + " í•™ìƒ ëª©ë¡";
        document.getElementById("page-desc").innerHTML =
          "ì´ í™”ë©´ì—ëŠ” <b>" + descText + "</b>ì— ì†Œì†ëœ ìŠ¹ì¸ í•™ìƒë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
      }

      updateTopLinks();

      tbody.innerHTML = "";
      list.forEach((u, idx) => {
        const tr = document.createElement("tr");
        const phone = u.phone || u.id || "";
        const status = u.status || "approved";
        const statusLabel = status === "approved" ? "ìŠ¹ì¸" : "ëŒ€ê¸°";
        const statusClass =
          status === "approved" ? "badge-approved" : "badge-pending";

        const toggleStatus = status === "approved" ? "pending" : "approved";
        const toggleText = status === "approved" ? "ëŒ€ê¸° ì „í™˜" : "ìŠ¹ì¸í•˜ê¸°";

        const statusHref =
          "/admin/status?id=" +
          encodeURIComponent(phone) +
          "&status=" +
          encodeURIComponent(toggleStatus) +
          "&key=" +
          encodeURIComponent(ADMIN_KEY) +
          "&return=" +
          encodeURIComponent("/admin/branch/users");

        const logsHref =
          "/admin/branch/logs?grade=" +
          encodeURIComponent(u.grade || "") +
          "&name=" +
          encodeURIComponent(u.name || "");

        const editHref =
          "/admin/user-edit?id=" +
          encodeURIComponent(phone) +
          "&key=" +
          encodeURIComponent(ADMIN_KEY) +
          "&view=branch";

        const trashHref =
          "/trash-user?id=" +
          encodeURIComponent(phone) +
          "&key=" +
          encodeURIComponent(ADMIN_KEY) +
          "&return=" +
          encodeURIComponent("/admin/branch/users") +
          "&view=branch";

        // í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ì „ì— ì´ìŠ¤ì¼€ì´í”„ëœ ê°’ì„ ë¯¸ë¦¬ ê³„ì‚°
        const escapedName = (u.name || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
        const escapedSeriesData = JSON.stringify(u.assignedSeries || [])
          .replace(/'/g, "\\'")
          .replace(/"/g, "&quot;");

        // í•™ìŠµì‹¤ ìƒíƒœ ê³„ì‚° (LearningLog ê¸°ë°˜ - ìŠˆí¼ê´€ë¦¬ìì™€ ì™„ì „íˆ ë™ì¼)
        const assignedTasks = u.studyRoom?.assignedTasks || [];
        const totalTasks = assignedTasks.length;
        // completedUnitsë¥¼ Setìœ¼ë¡œ ë³€í™˜ (ë¹ ë¥¸ ì¡°íšŒ)
        const completedUnitsSet = new Set(u.completedUnits || []);

        // ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°: AI ê³¼ì œëŠ” status, ì¼ë°˜ ê³¼ì œëŠ” LearningLog í™•ì¸ (ìŠˆí¼ê´€ë¦¬ìì™€ ë™ì¼)
        const completedTasks = assignedTasks.filter(t => {
          if (t.isAI) {
            // AI ê³¼ì œëŠ” statusê°€ 'completed'ì¸ ê²½ìš°
            return t.status === 'completed';
          } else {
            // ì¼ë°˜ ê³¼ì œëŠ” LearningLogì—ì„œ í™•ì¸
            // unitIdì—ì„œ ë‹¨ì› ì½”ë“œ ì¶”ì¶œ: ./BRAINUP/science/bio_01.html â†’ bio_01
            const unitId = t.unitId || t.id || '';
            const match = unitId.match(/([a-z_]+_\d+)\.html$/i) || unitId.match(/([a-z_]+_\d+)$/i);
            const unitCode = match ? match[1] : unitId;
            return completedUnitsSet.has(unitCode);
          }
        }).length;
        const pendingTasks = totalTasks - completedTasks;

        // í•™ìŠµì‹¤ ìƒíƒœ í‘œì‹œ (ì™„ë£Œ/ì „ì²´)
        let studyRoomStatusHtml = '<span style="color: #9ca3af;">-</span>';
        if (totalTasks > 0) {
          const statusColor = pendingTasks > 0 ? '#dc2626' : '#10b981';
          studyRoomStatusHtml = `
            <a href="/menu?grade=${encodeURIComponent(u.grade || '')}&name=${encodeURIComponent(u.name || '')}&openStudyRoom=true"
               target="_blank"
               style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 8px; text-decoration: none; font-weight: 600; color: ${statusColor}; border: 1px solid ${statusColor}20; transition: all 0.2s;"
               title="í´ë¦­í•˜ë©´ í•™ìŠµì‹¤ë¡œ ì´ë™">
              ğŸ“š ${completedTasks}/${totalTasks}
            </a>
          `;
        }

        // data-pending ì†ì„± ì¶”ê°€ (ì •ë ¬ìš©)
        tr.setAttribute('data-pending', pendingTasks);

        tr.innerHTML = `
          <td class="checkbox-col center">
            <input type="checkbox" class="student-checkbox" data-id="${phone}" data-grade="${u.grade || ''}" data-name="${u.name || ''}" />
          </td>
          <td class="num-col center">${idx + 1}</td>
          <td class="center">${u.grade || ""}</td>
          <td class="center">${u.classNum || ""}</td>
          <td class="center">
            <a class="btn-student"
               href="/menu?grade=${encodeURIComponent(u.grade || '')}&name=${encodeURIComponent(u.name || '')}&openStudyRoom=true"
               target="_blank"
               title="í•™ìƒ í™”ë©´ìœ¼ë¡œ ì´ë™ (í•™ìŠµì‹¤ ìë™ ì—´ê¸°)">
              ğŸ‘¤ ${u.name || ""}
            </a>
          </td>
          <td>${u.school || ""}</td>
          <td>${phone}</td>
          <td class="center">
            ${studyRoomStatusHtml}
          </td>
          <td>
            <span class="badge ${statusClass}">${statusLabel}</span>
            <a class="link-text"
               href="${statusHref}"
               onclick="return confirm('ì´ íšŒì›ì˜ ìƒíƒœë¥¼ ${toggleText} ìƒíƒœë¡œ ë³€ê²½í• ê¹Œìš”?');">
              ${toggleText}
            </a>
          </td>
          <td class="center">
            ${(u.assignedSeries && u.assignedSeries.length > 0)
              ? `<a href="#" onclick="openSeriesModal('${u._id}', '${escapedName}', '${escapedSeriesData}'); return false;"
                   style="display: inline-block; padding: 4px 10px; background: #10b981; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; text-decoration: none;">
                  ë¶€ì—¬ë¨ (${u.assignedSeries.length})
                 </a>`
              : `<a href="#" onclick="openSeriesModal('${u._id}', '${escapedName}', '${escapedSeriesData}'); return false;"
                   style="display: inline-block; padding: 4px 10px; background: #9ca3af; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; text-decoration: none;">
                  ë¯¸ë¶€ì—¬
                 </a>`
            }
          </td>
          <td class="center">
            <button class="btn-kakao-alert"
               onclick="sendKakaoTaskAlert('${encodeURIComponent(u.grade || '')}', '${encodeURIComponent(u.name || '')}')"
               style="padding: 6px 12px; background: #FEE500; color: #3C1E1E; border: none; border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s;"
               title="ê³¼ì œ ì•Œë¦¼ ì „ì†¡">
              ğŸ’¬ ì•Œë¦¼
            </button>
          </td>
          <td class="center">
            <a class="link-text" href="${editHref}">ìˆ˜ì •</a>
          </td>
          <td class="center">
            <a class="link-text"
               href="${trashHref}"
               onclick="return confirm('ì´ íšŒì›ì„ íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚¼ê¹Œìš”? [${u.name || ""} / ${phone}]');">
              íœ´ì§€í†µ
            </a>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      updateCheckboxListeners();
    }

    // ì²´í¬ë°•ìŠ¤ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateCheckboxListeners() {
      const selectAllCheckbox = document.getElementById('select-all');
      const studentCheckboxes = document.querySelectorAll('.student-checkbox');
      const deleteSelectedBtn = document.getElementById('btn-delete-selected');
      const selectedCountSpan = document.getElementById('selected-count');

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
      selectAllCheckbox.addEventListener('change', function() {
        studentCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateSelectedCount();
      });

      // ê°œë³„ ì²´í¬ë°•ìŠ¤
      studentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateSelectedCount();

          // ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒë˜ë©´ ì „ì²´ ì„ íƒë„ ì²´í¬
          const allChecked = Array.from(studentCheckboxes).every(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
        });
      });

      // ì„ íƒëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ í‘œì‹œ
      function updateSelectedCount() {
        const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
        selectedCountSpan.textContent = checkedCount;

        if (checkedCount > 0) {
          deleteSelectedBtn.classList.add('show');
        } else {
          deleteSelectedBtn.classList.remove('show');
        }
      }

      // ì„ íƒ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      deleteSelectedBtn.addEventListener('click', async function() {
        const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id'));

        if (selectedIds.length === 0) {
          alert('ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        const confirmMsg = `ì„ íƒí•œ ${selectedIds.length}ëª…ì˜ í•™ìƒì„ íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`;
        if (!confirm(confirmMsg)) return;

        try {
          // ê° í•™ìƒì„ ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ
          for (const id of selectedIds) {
            const trashUrl = `/trash-user?id=${encodeURIComponent(id)}&key=${encodeURIComponent(ADMIN_KEY)}&return=${encodeURIComponent('/admin/branch/users')}&view=branch`;
            await fetch(trashUrl);
          }

          alert(`${selectedIds.length}ëª…ì˜ í•™ìƒì„ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          location.reload();
        } catch (error) {
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      });
    }

    function updateTopLinks() {
      const btnExport = document.getElementById("btn-export");
      const btnTrash = document.getElementById("btn-trash");

      const q = currentAcademyName || "";
      btnExport.href =
        "/admin/users-export?key=" +
        encodeURIComponent(ADMIN_KEY) +
        (q ? "&q=" + encodeURIComponent(q) : "");

      btnTrash.href =
        "/admin/trash?key=" +
        encodeURIComponent(ADMIN_KEY) +
        "&view=branch";
    }

    document.addEventListener("DOMContentLoaded", function () {
      const input = document.getElementById("search-input");
      const btnSearch = document.getElementById("search-btn");
      const btnRefresh = document.getElementById("refresh-btn");

      btnSearch.addEventListener("click", () => {
        fetchBranchStudents(input.value.trim());
      });

      input.addEventListener("keyup", (e) => {
        if (e.key === "Enter") fetchBranchStudents(input.value.trim());
      });

      btnRefresh.addEventListener("click", () => {
        input.value = "";
        fetchBranchStudents("");
      });

      // ì „ì²´ ë°ì´í„° ì‚­ì œ ë²„íŠ¼
      const btnDeleteAll = document.getElementById("btn-delete-all");
      btnDeleteAll.addEventListener("click", async () => {
        const confirmMsg = "âš ï¸ ê²½ê³ : ëª¨ë“  íšŒì› ì •ë³´ì™€ í•™ìŠµ ê¸°ë¡ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!";

        if (!confirm(confirmMsg)) {
          return;
        }

        // 2ì°¨ í™•ì¸
        const doubleConfirm = prompt("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œë ¤ë©´ 'ì‚­ì œí•©ë‹ˆë‹¤'ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (doubleConfirm !== "ì‚­ì œí•©ë‹ˆë‹¤") {
          alert("ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          return;
        }

        try {
          btnDeleteAll.disabled = true;
          btnDeleteAll.textContent = "ì‚­ì œ ì¤‘...";

          const res = await fetch("/api/delete-all-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key: ADMIN_KEY })
          });

          const data = await res.json();

          if (data.success) {
            alert(`âœ… ì „ì²´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ!\n\nì‚­ì œëœ íšŒì›: ${data.deletedUsers}ëª…\nì‚­ì œëœ í•™ìŠµ ê¸°ë¡: ${data.deletedRecords}ê°œ`);
            fetchBranchStudents("");
          } else {
            alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        } catch (err) {
          console.error("ì‚­ì œ ì—ëŸ¬:", err);
          alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          btnDeleteAll.disabled = false;
          btnDeleteAll.textContent = "ì „ì²´ ë°ì´í„° ì‚­ì œ";
        }
      });

      fetchBranchStudents("");
    });

    // ===== ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ëª¨ë‹¬ ê´€ë ¨ =====
    let currentUserId = null;

    function openSeriesModal(userId, userName, assignedSeriesStr) {
      currentUserId = userId;
      document.getElementById("modal-student-name").textContent = "í•™ìƒ: " + userName;

      // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
      document.querySelectorAll('#series-modal input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });

      // ë¬¸ìì—´ì„ ë°°ì—´ë¡œ íŒŒì‹±
      let assignedSeries = [];
      try {
        assignedSeries = JSON.parse(assignedSeriesStr);
      } catch (e) {
        console.error('Failed to parse assignedSeries:', e);
      }

      // í˜„ì¬ ë¶€ì—¬ëœ ì‹œë¦¬ì¦ˆ ì²´í¬
      if (Array.isArray(assignedSeries)) {
        assignedSeries.forEach(series => {
          const checkbox = document.querySelector(`#series-modal input[value="${series}"]`);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
      }

      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById("series-modal").classList.add("show");
    }

    function closeSeriesModal() {
      document.getElementById("series-modal").classList.remove("show");
      currentUserId = null;
    }

    async function submitSeries() {
      if (!currentUserId) {
        alert("ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // ì„ íƒëœ ì‹œë¦¬ì¦ˆ ìˆ˜ì§‘
      const selectedSeries = [];
      document.querySelectorAll('#series-modal input[type="checkbox"]:checked').forEach(cb => {
        selectedSeries.push(cb.value);
      });

      try {
        const res = await fetch("/admin/assign-series", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            key: ADMIN_KEY,
            userId: currentUserId,
            series: selectedSeries
          })
        });

        const data = await res.json();

        if (data.success) {
          alert("ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì™„ë£Œ!");
          closeSeriesModal();
          // í˜„ì¬ ê²€ìƒ‰ì–´ë¥¼ ìœ ì§€í•˜ë©´ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          const currentSearch = document.getElementById("search-input").value.trim();
          fetchBranchStudents(currentSearch);
        } else {
          alert("ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì‹¤íŒ¨: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch (err) {
        console.error("ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì—ëŸ¬:", err);
        alert("ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById("series-modal").addEventListener("click", function(e) {
      if (e.target === this) {
        closeSeriesModal();
      }
    });

    // ===== AI ì¶”ì²œê³¼ì œ ëª©ë¡ ëª¨ë‹¬ =====
    const aiTasksModal = document.getElementById('ai-tasks-modal');
    const btnAiTasks = document.getElementById('btn-ai-tasks');
    const closeBtnAiTasks = document.getElementById('close-ai-tasks-modal');

    // AI ì¶”ì²œê³¼ì œ ëª©ë¡ ì—´ê¸°
    btnAiTasks.addEventListener('click', async () => {
      aiTasksModal.style.display = 'flex';
      await loadAITasks();
    });

    // ë‹«ê¸° ë²„íŠ¼
    closeBtnAiTasks.addEventListener('click', () => {
      aiTasksModal.style.display = 'none';
    });

    // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
    aiTasksModal.addEventListener('click', (e) => {
      if (e.target === aiTasksModal) {
        aiTasksModal.style.display = 'none';
      }
    });

    // AI ì¶”ì²œê³¼ì œ ëª©ë¡ ë¡œë“œ
    async function loadAITasks() {
      const tbody = document.getElementById('ai-tasks-tbody');
      const countSpan = document.getElementById('ai-tasks-count');

      try {
        // ë¸Œëœì¹˜ ê´€ë¦¬ììš© API í˜¸ì¶œ (í•™ì›ë³„ í•„í„°ë§)
        const response = await fetch(`/api/branch/ai-tasks`, {
          credentials: 'include'
        });
        const result = await response.json();

        if (!result.ok) {
          tbody.innerHTML = `<tr><td colspan="10" style="padding: 40px; text-align: center; color: #dc2626;">ì˜¤ë¥˜: ${result.message}</td></tr>`;
          return;
        }

        const tasks = result.tasks || [];
        countSpan.textContent = result.total || 0;

        if (tasks.length === 0) {
          tbody.innerHTML = `<tr><td colspan="10" style="padding: 40px; text-align: center; color: #999;">ì•„ì§ ë¶€ì—¬ëœ AI ì¶”ì²œê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
          return;
        }

        // í…Œì´ë¸” ë Œë”ë§
        tbody.innerHTML = tasks.map((task, index) => {
          const assignedTime = task.assignedAt ? formatAssignedTime(task.assignedAt) : '-';
          const statusText = getStatusText(task.status);
          const statusColor = getStatusColor(task.status);

          return `
            <tr style="border-bottom: 1px solid #e5e7eb;">
              <td style="padding: 12px; color: #666;">${index + 1}</td>
              <td style="padding: 12px;">${task.grade}</td>
              <td style="padding: 12px; font-weight: 600;">${task.name}</td>
              <td style="padding: 12px;">${task.school}</td>
              <td style="padding: 12px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${task.taskTitle}">${task.taskTitle}</td>
              <td style="padding: 12px;">${task.series || '-'}</td>
              <td style="padding: 12px;">${task.field || '-'}</td>
              <td style="padding: 12px;">${task.subject || '-'}</td>
              <td style="padding: 12px; white-space: nowrap;">${assignedTime}</td>
              <td style="padding: 12px;">
                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${statusColor}; color: #fff; white-space: nowrap;">
                  ${statusText}
                </span>
              </td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('AI ì¶”ì²œê³¼ì œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        tbody.innerHTML = `<tr><td colspan="10" style="padding: 40px; text-align: center; color: #dc2626;">ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>`;
      }
    }

    // ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatAssignedTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${month}ì›” ${day}ì¼ ${hours}:${minutes}`;
    }

    // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
    function getStatusText(status) {
      const statusMap = {
        'pending': 'ë¯¸ì™„ë£Œ',
        'in_progress': 'ì§„í–‰ì¤‘',
        'completed': 'ì™„ë£Œ'
      };
      return statusMap[status] || 'ë¯¸ì™„ë£Œ';
    }

    // ìƒíƒœ ìƒ‰ìƒ
    function getStatusColor(status) {
      const colorMap = {
        'pending': '#94a3b8',
        'in_progress': '#3b82f6',
        'completed': '#10b981'
      };
      return colorMap[status] || '#94a3b8';
    }

    // ===== ìë™ ê³¼ì œ ë¶€ì—¬ ëª¨ë‹¬ =====
    const autoTaskModal = document.getElementById('auto-task-modal');
    const btnAutoTask = document.getElementById('btn-auto-task');

    // ìë™ ê³¼ì œ ë¶€ì—¬ ëª¨ë‹¬ ì—´ê¸°
    btnAutoTask.addEventListener('click', () => {
      const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
      if (checkedBoxes.length === 0) {
        alert('í•™ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      autoTaskModal.classList.add('show');
    });

    // ìë™ ê³¼ì œ ë¶€ì—¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeAutoTaskModal() {
      autoTaskModal.classList.remove('show');
    }

    // ìë™ ê³¼ì œ ë¶€ì—¬ ì œì¶œ
    async function submitAutoTask() {
      const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
      if (checkedBoxes.length === 0) {
        alert('í•™ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // ìš”ì¼ ì„ íƒ
      const dayAll = document.getElementById('day-all').checked;
      let days = [];
      if (dayAll) {
        days = [0, 1, 2, 3, 4, 5, 6];
      } else {
        for (let i = 0; i <= 6; i++) {
          const checkbox = document.getElementById(`day-${i}`);
          if (checkbox && checkbox.checked) {
            days.push(parseInt(checkbox.value));
          }
        }
      }

      if (days.length === 0) {
        alert('ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const series = document.getElementById('auto-series-select').value;
      const subject = document.getElementById('auto-subject-select').value;
      const count = parseInt(document.getElementById('auto-task-count').value);

      // ì„ íƒëœ í•™ìƒ ì •ë³´
      const students = Array.from(checkedBoxes).map(cb => ({
        grade: cb.dataset.grade,
        name: cb.dataset.name
      }));

      try {
        const response = await fetch('/api/auto-task-schedule/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            key: ADMIN_KEY,
            students,
            schedule: {
              days,
              series: series === 'all' ? undefined : series,
              subject: subject || undefined,
              count
            }
          })
        });

        const result = await response.json();

        if (result.success) {
          alert(`âœ… ${students.length}ëª…ì˜ í•™ìƒì—ê²Œ ìë™ ê³¼ì œ ìŠ¤ì¼€ì¤„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          closeAutoTaskModal();
          location.reload();
        } else {
          alert(`âŒ ì˜¤ë¥˜: ${result.message}`);
        }
      } catch (error) {
        console.error('ìë™ ê³¼ì œ ë¶€ì—¬ ì˜¤ë¥˜:', error);
        alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    autoTaskModal.addEventListener('click', (e) => {
      if (e.target === autoTaskModal) {
        closeAutoTaskModal();
      }
    });

    // ë§¤ì¼ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
    document.getElementById('day-all').addEventListener('change', function() {
      for (let i = 0; i <= 6; i++) {
        const checkbox = document.getElementById(`day-${i}`);
        if (checkbox) {
          checkbox.checked = this.checked;
        }
      }
    });

    // ìŠ¤ì¼€ì¤„ ì¼ì‹œì •ì§€/ì¬ê°œ
    async function toggleSchedule(scheduleId, grade, name) {
      try {
        const res = await fetch(`/api/auto-task-schedule/${scheduleId}/toggle`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grade, name })
        });

        const data = await res.json();

        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert(`âŒ ì˜¤ë¥˜: ${data.message}`);
        }
      } catch (err) {
        console.error('ìŠ¤ì¼€ì¤„ í† ê¸€ ì˜¤ë¥˜:', err);
        alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìŠ¤ì¼€ì¤„ ì‚­ì œ
    async function deleteSchedule(scheduleId, grade, name) {
      if (!confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const res = await fetch(`/api/auto-task-schedule/${scheduleId}?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert(`âŒ ì˜¤ë¥˜: ${data.message}`);
        }
      } catch (err) {
        console.error('ìŠ¤ì¼€ì¤„ ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì •ë ¬ ê¸°ëŠ¥ ì¶”ê°€
    document.getElementById('sort-select').addEventListener('change', function() {
      const currentSearch = document.getElementById('search-input').value.trim();
      fetchBranchStudents(currentSearch, this.value);
    });

    // ===== í•™ìŠµì‹¤ ìƒíƒœ ì •ë ¬ ê¸°ëŠ¥ (ìŠˆí¼ê´€ë¦¬ìì™€ ë™ì¼) =====
    let pendingSortOrder = 'desc'; // ê¸°ë³¸: ë¯¸ì™„ë£Œ ê³¼ì œ ë§ì€ ìˆœ

    function sortByPendingTasks() {
      const tbody = document.getElementById('student-tbody');
      const rows = Array.from(tbody.querySelectorAll('tr:not(.empty-row)'));
      const sortIcon = document.getElementById('studyRoomSortIcon');

      if (rows.length === 0) return;

      // ì •ë ¬ ë°©í–¥ í† ê¸€
      pendingSortOrder = pendingSortOrder === 'desc' ? 'asc' : 'desc';
      sortIcon.textContent = pendingSortOrder === 'desc' ? 'â†“' : 'â†‘';

      // data-pending ì†ì„± ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
      rows.sort((a, b) => {
        const pendingA = parseInt(a.getAttribute('data-pending') || '0');
        const pendingB = parseInt(b.getAttribute('data-pending') || '0');

        if (pendingSortOrder === 'desc') {
          return pendingB - pendingA; // ë¯¸ì™„ë£Œ ë§ì€ ìˆœ
        } else {
          return pendingA - pendingB; // ë¯¸ì™„ë£Œ ì ì€ ìˆœ
        }
      });

      // ì •ë ¬ëœ ìˆœì„œë¡œ ë‹¤ì‹œ ì¶”ê°€
      rows.forEach(row => tbody.appendChild(row));

      // ë²ˆí˜¸ ì¬ì •ë ¬
      rows.forEach((row, idx) => {
        const numCell = row.querySelector('.num-col');
        if (numCell) {
          numCell.textContent = idx + 1;
        }
      });
    }

    // ===== ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” (ìŠˆí¼ê´€ë¦¬ìì™€ ë™ì¼) =====
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
      Kakao.init('6ad10cc6680c7a5829a4fd7a3cbb4a7e');
    }

    // ===== í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ ê¸°ëŠ¥ =====
    function openAddStudentModal() {
      document.getElementById('add-student-modal').style.display = 'flex';
      document.getElementById('add-name').value = '';
      document.getElementById('add-number').value = '';

      // í•™êµ/í•™ë…„/ë°˜ ì •ë³´ ìë™ í‘œì‹œ
      const school = currentAcademyName || '(í•™êµ ì •ë³´ ì—†ìŒ)';
      const grade = window.adminGrade || '';
      const classNum = window.adminClassNum || '';
      const infoText = [school, grade, classNum].filter(Boolean).join(' ');
      document.getElementById('add-info-display').textContent = infoText || 'í•™êµ/í•™ë…„/ë°˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    }

    function closeAddStudentModal() {
      document.getElementById('add-student-modal').style.display = 'none';
    }

    async function submitAddStudent(event) {
      event.preventDefault();

      const name = document.getElementById('add-name').value.trim();
      const number = document.getElementById('add-number').value.trim();

      // í•™êµ/í•™ë…„/ë°˜ì€ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜´
      const school = currentAcademyName || '';
      const grade = window.adminGrade || '';
      const classNum = window.adminClassNum || '';

      if (!name || !number) {
        alert('ì´ë¦„ê³¼ ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const response = await fetch('/api/admin/branch/add-student', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grade, name, school, number, classNum })
        });

        const result = await response.json();

        if (result.success) {
          alert('í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeAddStudentModal();
          fetchBranchStudents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(result.message || 'í•™ìƒ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('í•™ìƒ ì¶”ê°€ ì˜¤ë¥˜:', error);
        alert('í•™ìƒ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== ê³¼ì œ ì•Œë¦¼ ì „ì†¡ ê¸°ëŠ¥ =====
    function sendKakaoTaskAlert(grade, name) {
      grade = decodeURIComponent(grade);
      name = decodeURIComponent(name);

      if (!grade || !name) {
        alert('í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
        alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const baseUrl = 'https://dan-dan-app.onrender.com';
        const studyRoomUrl = baseUrl + '/menu.html?openStudyRoom=true&grade=' + encodeURIComponent(grade) + '&name=' + encodeURIComponent(name);

        Kakao.Share.sendDefault({
          objectType: 'feed',
          content: {
            title: 'ğŸ“š ' + name + ' í•™ìƒ ê³¼ì œ ì•Œë¦¼',
            description: grade + ' ' + name + ' í•™ìƒ, í•™ìŠµì‹¤ì˜ ê³¼ì œë¥¼ ê¼­ í™•ì¸í•´ ì£¼ì„¸ìš”!',
            imageUrl: 'https://dan-dan-app.onrender.com/images/dandan_logo.png',
            link: {
              mobileWebUrl: studyRoomUrl,
              webUrl: studyRoomUrl
            }
          },
          buttons: [
            {
              title: 'ë‚˜ì˜ í•™ìŠµì‹¤ ì—´ê¸°',
              link: {
                mobileWebUrl: studyRoomUrl,
                webUrl: studyRoomUrl
              }
            }
          ]
        });
      } catch (error) {
        console.error('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì˜¤ë¥˜:', error);
        alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
</body>
</html>
