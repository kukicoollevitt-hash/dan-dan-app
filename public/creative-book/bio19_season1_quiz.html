<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¡ï¸ ëœ¨ê±°ìš´ ì§€êµ¬ SOS - ê´€ë¬¸í‰ê°€</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
      background: linear-gradient(135deg, #0D47A1 0%, #1976D2 50%, #2196F3 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .quiz-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; padding: 40px; max-width: 700px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .quiz-header { text-align: center; margin-bottom: 30px; }
    .quiz-header h1 { font-size: 24px; color: #0D47A1; margin-bottom: 10px; }
    .quiz-header p { color: #666; font-size: 14px; }
    .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-bottom: 30px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #1976D2, #42A5F5); border-radius: 4px; transition: width 0.3s ease; }
    .question-number { display: inline-block; padding: 6px 16px; background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%); color: white; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 15px; }
    .category-tag { display: inline-block; padding: 4px 12px; background: rgba(25, 118, 210, 0.1); color: #1976D2; border-radius: 12px; font-size: 12px; margin-left: 10px; }
    .question-text { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 25px; line-height: 1.6; }
    .options { display: flex; flex-direction: column; gap: 12px; }
    .option { padding: 16px 20px; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; color: #444; }
    .option:hover { border-color: #1976D2; background: rgba(25, 118, 210, 0.05); }
    .option.selected { border-color: #1976D2; background: rgba(25, 118, 210, 0.1); color: #0D47A1; font-weight: 600; }
    .option.correct { border-color: #27ae60; background: rgba(39, 174, 96, 0.15); color: #1e8449; }
    .option.wrong { border-color: #e74c3c; background: rgba(231, 76, 60, 0.15); color: #c0392b; }
    .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
    .nav-btn { flex: 1; padding: 14px 24px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .nav-btn.prev { background: #e9ecef; color: #666; }
    .nav-btn.next { background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%); color: white; }
    .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
    .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .result-container { display: none; text-align: center; }
    .result-container.show { display: block; }
    .result-title { font-size: 32px; color: #0D47A1; margin-bottom: 10px; }
    .result-score { font-size: 64px; font-weight: 700; color: #1976D2; margin: 20px 0; }
    .result-message { font-size: 18px; color: #666; margin-bottom: 30px; }
    .radar-container { width: 300px; height: 300px; margin: 0 auto 30px; }
    .category-scores { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px; }
    .category-score { padding: 8px 16px; background: rgba(25, 118, 210, 0.1); border-radius: 20px; font-size: 13px; color: #0D47A1; }
    .restart-btn { padding: 16px 40px; background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .restart-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
    .close-btn { position: fixed; top: 20px; right: 20px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
    @media (max-width: 768px) { .quiz-container { padding: 25px; margin: 10px; } .quiz-header h1 { font-size: 20px; } .question-text { font-size: 16px; } .option { padding: 14px 16px; font-size: 14px; } .result-score { font-size: 48px; } .radar-container { width: 250px; height: 250px; } }
  </style>
</head>
<body>
  <button class="close-btn" onclick="closeQuiz()">Ã—</button>
  <div class="quiz-container">
    <div id="quiz-screen">
      <div class="quiz-header">
        <h1>ğŸŒ¡ï¸ ëœ¨ê±°ìš´ ì§€êµ¬ SOS: ë™ë¬¼ íšŒì˜ê°€ ì—´ë¦¬ë˜ ë‚ </h1>
        <p>ê´€ë¬¸í‰ê°€ - ì´ì•¼ê¸°ë¥¼ ì˜ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”!</p>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
      <div id="question-container">
        <span class="question-number" id="question-number">1/10</span>
        <span class="category-tag" id="category-tag">ì¸ë¬¼íŒŒì•…</span>
        <p class="question-text" id="question-text"></p>
        <div class="options" id="options"></div>
      </div>
      <div class="nav-buttons">
        <button class="nav-btn prev" id="prev-btn" onclick="prevQuestion()">ì´ì „</button>
        <button class="nav-btn next" id="next-btn" onclick="nextQuestion()">ë‹¤ìŒ</button>
      </div>
    </div>
    <div class="result-container" id="result-screen">
      <h2 class="result-title">ğŸ‰ í‰ê°€ ì™„ë£Œ!</h2>
      <div class="result-score" id="result-score">0ì </div>
      <p class="result-message" id="result-message"></p>
      <div class="radar-container"><canvas id="radar-chart" width="300" height="300"></canvas></div>
      <div class="category-scores" id="category-scores"></div>
      <button class="restart-btn" onclick="closeQuiz()">ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <script>
    const quizData = [
      { category: "ì¸ë¬¼íŒŒì•…", question: "ë¶ê·¹ì—ì„œ íƒœì–´ë‚œ ì–´ë¦° ë¶ê·¹ê³°ìœ¼ë¡œ, ì „ ì„¸ê³„ ë™ë¬¼ë“¤ì—ê²Œ ë„ì›€ì„ ìš”ì²­í•˜ëŠ” ì—¬í–‰ì„ ë– ë‚˜ëŠ” ì£¼ì¸ê³µì€?", options: ["ì´ˆë¡ì´", "í•˜ëŠ˜ë°”ëŒ", "ëˆˆê½ƒ", "ì†Œìœ¨"], answer: 2 },
      { category: "ì¸ë¬¼íŒŒì•…", question: "ë¶ê·¹ì—ì„œ ë‚¨ê·¹ê¹Œì§€ ë§¤ë…„ 7ë§Œ kmë¥¼ ì´ë™í•˜ë©° ì§€êµ¬ ì „ì²´ì˜ ë³€í™”ë¥¼ ëª©ê²©í•œ ì² ìƒˆëŠ”?", options: ["ëˆˆê½ƒ", "í•˜ëŠ˜ë°”ëŒ", "ì´ˆë¡ì´", "í• ì•„ë²„ì§€ ë‚˜ë¬´"], answer: 1 },
      { category: "ë‚´ìš©ì¼ì¹˜", question: "ì§€êµ¬ ì˜¨ë‚œí™”ì˜ ì£¼ìš” ì›ì¸ìœ¼ë¡œ ì–¸ê¸‰ëœ ê¸°ì²´ëŠ”?", options: ["ì‚°ì†Œ", "ì§ˆì†Œ", "ì´ì‚°í™”íƒ„ì†Œ", "í—¬ë¥¨"], answer: 2 },
      { category: "ë‚´ìš©ì¼ì¹˜", question: "ë°”ë‹·ë¬¼ ì˜¨ë„ê°€ ì˜¬ë¼ê°€ë©´ ì‚°í˜¸ê°€ ìƒ‰ì„ ìƒê³  ì£½ì–´ê°€ëŠ” í˜„ìƒì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", options: ["êµ°ì§‘ë¶•ê´´í˜„ìƒ", "ë°±í™” í˜„ìƒ", "ì‚¬ë§‰í™” í˜„ìƒ", "ì˜¨ì‹¤ íš¨ê³¼"], answer: 1 },
      { category: "ë‚´ìš©êµ¬ì¡°", question: "ê¸°ì˜¨ ë³€í™”ë¡œ ì‹ë¬¼ì˜ ì„±ì¥ ì‹œê¸°ê°€ ë°”ë€Œë©´ì„œ ë™ë¬¼ë“¤ì˜ ì´ë™ ì‹œê¸°ì™€ ë§ì§€ ì•Šê²Œ ë˜ëŠ” í˜„ìƒì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", options: ["ì˜¨ì‹¤ íš¨ê³¼", "ë¬¼í›„í•™ì  ë¶ˆì¼ì¹˜", "ë°±í™” í˜„ìƒ", "êµ°ì§‘ë¶•ê´´í˜„ìƒ"], answer: 1 },
      { category: "ë‚´ìš©êµ¬ì¡°", question: "ì´ ì´ì•¼ê¸°ì—ì„œ ì´ì‚°í™”íƒ„ì†Œê°€ ì§€êµ¬ë¥¼ ë”°ëœ»í•˜ê²Œ ë§Œë“œëŠ” ì›ë¦¬ë¥¼ ë¬´ì—‡ì— ë¹„ìœ í–ˆë‚˜ìš”?", options: ["ìš°ì‚°", "ë‘êº¼ìš´ ì´ë¶ˆ", "ì„ í’ê¸°", "ì—ì–´ì»¨"], answer: 1 },
      { category: "ë‚´ìš©ì–´íœ˜", question: "'ê¸°í›„ë³€í™”'ë€ ë¬´ì—‡ì¸ê°€ìš”?", options: ["í•˜ë£¨ì˜ ë‚ ì”¨ ë³€í™”", "ì˜¤ëœ ê¸°ê°„ì— ê±¸ì¹œ ê¸°í›„ íŒ¨í„´ì˜ ë³€í™”", "ë°”ëŒì˜ ë°©í–¥ ë³€í™”", "ë¹„ì˜ ì–‘ ë³€í™”ë§Œ"], answer: 1 },
      { category: "ë‚´ìš©ì–´íœ˜", question: "'ì˜¨ì‹¤íš¨ê³¼'ë€ ë¬´ì—‡ì¸ê°€ìš”?", options: ["ì‹ë¬¼ì´ ì˜ ìë¼ëŠ” íš¨ê³¼", "ëŒ€ê¸° ì¤‘ ì˜¨ì‹¤ê°€ìŠ¤ê°€ ì—´ì„ ê°€ë‘ì–´ ì§€êµ¬ê°€ ë”°ëœ»í•´ì§€ëŠ” í˜„ìƒ", "ê²¨ìš¸ì— ëˆˆì´ ì˜¤ëŠ” í˜„ìƒ", "ë°”ë‹¤ê°€ ì°¨ê°€ì›Œì§€ëŠ” í˜„ìƒ"], answer: 1 },
      { category: "ë‚´ìš©ì¶”ë¡ ", question: "ì§€êµ¬ í‰ê·  ê¸°ì˜¨ì´ 1ë„ ì˜¤ë¥´ë©´ ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚  ìˆ˜ ìˆì„ê¹Œìš”?", options: ["ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤", "ë¶ê·¹ì˜ ì–¼ìŒì´ ë…¹ê³  í­í’ì´ ê±°ì„¸ì§€ë©° ê°€ë­„ê³¼ í™ìˆ˜ê°€ ì¼ì–´ë‚œë‹¤", "ë‚ ì”¨ê°€ ë” ì¢‹ì•„ì§„ë‹¤", "ë™ë¬¼ë“¤ì´ ë” ê±´ê°•í•´ì§„ë‹¤"], answer: 1 },
      { category: "ë‚´ìš©ì¶”ë¡ ", question: "ì´ ì´ì•¼ê¸°ê°€ ì „í•˜ëŠ” í•µì‹¬ ë©”ì‹œì§€ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?", options: ["ê¸°í›„ë³€í™”ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í˜„ìƒì´ë‹¤", "ì¸ê°„ì˜ ì„ íƒì´ ì§€êµ¬ì˜ ë¯¸ë˜ë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤", "ë™ë¬¼ë“¤ë§Œ ë…¸ë ¥í•˜ë©´ ëœë‹¤", "ê¸°í›„ë³€í™”ëŠ” ë¶ê·¹ì—ì„œë§Œ ì¼ì–´ë‚œë‹¤"], answer: 1 }
    ];

    let currentQuestion = 0;
    let userAnswers = new Array(quizData.length).fill(null);
    let answered = new Array(quizData.length).fill(false);
    const categoryScores = { "ì¸ë¬¼íŒŒì•…": { correct: 0, total: 2 }, "ë‚´ìš©ì¼ì¹˜": { correct: 0, total: 2 }, "ë‚´ìš©êµ¬ì¡°": { correct: 0, total: 2 }, "ë‚´ìš©ì–´íœ˜": { correct: 0, total: 2 }, "ë‚´ìš©ì¶”ë¡ ": { correct: 0, total: 2 } };

    function renderQuestion() {
      const q = quizData[currentQuestion];
      document.getElementById('question-number').textContent = `${currentQuestion + 1}/${quizData.length}`;
      document.getElementById('category-tag').textContent = q.category;
      document.getElementById('question-text').textContent = q.question;
      document.getElementById('progress-fill').style.width = `${((currentQuestion + 1) / quizData.length) * 100}%`;
      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const optDiv = document.createElement('div');
        optDiv.className = 'option';
        if (userAnswers[currentQuestion] === idx) optDiv.classList.add('selected');
        if (answered[currentQuestion]) {
          if (idx === q.answer) optDiv.classList.add('correct');
          else if (userAnswers[currentQuestion] === idx) optDiv.classList.add('wrong');
        }
        optDiv.textContent = opt;
        optDiv.onclick = () => selectOption(idx);
        optionsContainer.appendChild(optDiv);
      });
      document.getElementById('prev-btn').disabled = currentQuestion === 0;
      document.getElementById('next-btn').textContent = currentQuestion === quizData.length - 1 ? 'ê²°ê³¼ ë³´ê¸°' : 'ë‹¤ìŒ';
    }

    function selectOption(idx) {
      if (answered[currentQuestion]) return;
      userAnswers[currentQuestion] = idx;
      answered[currentQuestion] = true;
      const q = quizData[currentQuestion];
      if (idx === q.answer) categoryScores[q.category].correct++;
      renderQuestion();
    }

    function prevQuestion() { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } }
    function nextQuestion() {
      if (userAnswers[currentQuestion] === null) { alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
      if (currentQuestion < quizData.length - 1) { currentQuestion++; renderQuestion(); }
      else showResult();
    }

    function convertToRadarScore(correct) { if (correct === 2) return 10; if (correct === 1) return 5; return 1; }

    function showResult() {
      document.getElementById('quiz-screen').style.display = 'none';
      document.getElementById('result-screen').classList.add('show');
      const radarScores = { "ì¸ë¬¼íŒŒì•…": convertToRadarScore(categoryScores["ì¸ë¬¼íŒŒì•…"].correct), "ë‚´ìš©ì¼ì¹˜": convertToRadarScore(categoryScores["ë‚´ìš©ì¼ì¹˜"].correct), "ë‚´ìš©êµ¬ì¡°": convertToRadarScore(categoryScores["ë‚´ìš©êµ¬ì¡°"].correct), "ë‚´ìš©ì–´íœ˜": convertToRadarScore(categoryScores["ë‚´ìš©ì–´íœ˜"].correct), "ë‚´ìš©ì¶”ë¡ ": convertToRadarScore(categoryScores["ë‚´ìš©ì¶”ë¡ "].correct) };
      const totalScore = Object.values(radarScores).reduce((a, b) => a + b, 0) * 2;
      document.getElementById('result-score').textContent = `${totalScore}ì `;
      let message = '';
      if (totalScore >= 90) message = 'ğŸŒŸ ì™„ë²½í•´ìš”! ê¸°í›„ë³€í™”ì˜ ì¤‘ìš”ì„±ì„ ì˜ ì´í•´í–ˆì–´ìš”!';
      else if (totalScore >= 70) message = 'ğŸ‘ ì˜í–ˆì–´ìš”! ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ì™„ë²½í•´ì§ˆ ê±°ì˜ˆìš”!';
      else if (totalScore >= 50) message = 'ğŸ“š ê´œì°®ì•„ìš”! ì´ì•¼ê¸°ë¥¼ ë‹¤ì‹œ ì½ì–´ë³´ë©´ ë” ì˜ ì´í•´í•  ìˆ˜ ìˆì–´ìš”!';
      else message = 'ğŸ’ª í˜ë‚´ì„¸ìš”! ë‹¤ì‹œ ë„ì „í•´ ë³´ì•„ìš”!';
      document.getElementById('result-message').textContent = message;
      const scoresContainer = document.getElementById('category-scores');
      scoresContainer.innerHTML = '';
      Object.entries(radarScores).forEach(([cat, score]) => {
        const span = document.createElement('span');
        span.className = 'category-score';
        span.textContent = `${cat}: ${score}ì `;
        scoresContainer.appendChild(span);
      });
      drawRadarChart(radarScores);
      saveQuizResult(totalScore, radarScores);
    }

    function drawRadarChart(scores) {
      const canvas = document.getElementById('radar-chart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2, centerY = canvas.height / 2, radius = 100;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const categories = ["ì¸ë¬¼íŒŒì•…", "ë‚´ìš©ì¼ì¹˜", "ë‚´ìš©êµ¬ì¡°", "ë‚´ìš©ì–´íœ˜", "ë‚´ìš©ì¶”ë¡ "];
      const numCategories = categories.length;
      ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1;
      for (let level = 1; level <= 5; level++) {
        ctx.beginPath();
        for (let i = 0; i < numCategories; i++) {
          const angle = (Math.PI * 2 * i / numCategories) - Math.PI / 2;
          const r = (radius * level) / 5;
          const x = centerX + r * Math.cos(angle), y = centerY + r * Math.sin(angle);
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.closePath(); ctx.stroke();
      }
      ctx.strokeStyle = '#ccc';
      for (let i = 0; i < numCategories; i++) {
        const angle = (Math.PI * 2 * i / numCategories) - Math.PI / 2;
        ctx.beginPath(); ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + radius * Math.cos(angle), centerY + radius * Math.sin(angle)); ctx.stroke();
      }
      ctx.fillStyle = 'rgba(25, 118, 210, 0.3)'; ctx.strokeStyle = '#1976D2'; ctx.lineWidth = 2;
      ctx.beginPath();
      categories.forEach((cat, i) => {
        const angle = (Math.PI * 2 * i / numCategories) - Math.PI / 2;
        const value = scores[cat] / 10, r = radius * value;
        const x = centerX + r * Math.cos(angle), y = centerY + r * Math.sin(angle);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.closePath(); ctx.fill(); ctx.stroke();
      ctx.fillStyle = '#333'; ctx.font = '12px "Noto Sans KR", sans-serif'; ctx.textAlign = 'center';
      categories.forEach((cat, i) => {
        const angle = (Math.PI * 2 * i / numCategories) - Math.PI / 2;
        const x = centerX + (radius + 25) * Math.cos(angle), y = centerY + (radius + 25) * Math.sin(angle);
        ctx.fillText(cat, x, y + 4);
      });
    }

    async function saveQuizResult(totalScore, radarScores) {
      try {
        const userInfo = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || '{}');
        const grade = userInfo.grade || '', name = userInfo.name || '';
        if (!grade || !name) { console.log('[saveQuizResult] ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ'); return; }
        const urlParams = new URLSearchParams(window.location.search);
        const season = urlParams.get('season') || 'season1';
        const response = await fetch('/api/creative-quiz/save', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grade, name, storyId: 'bio19', season, scores: radarScores, totalScore })
        });
        const result = await response.json();
        if (result.ok) console.log('[saveQuizResult] ì €ì¥ ì™„ë£Œ:', result);
        else console.error('[saveQuizResult] ì €ì¥ ì‹¤íŒ¨:', result.message);
      } catch (err) { console.error('[saveQuizResult] ì˜¤ë¥˜:', err); }
    }

    function closeQuiz() {
      if (window.parent && window.parent !== window) window.parent.postMessage({ type: 'closeStory' }, '*');
      else window.history.back();
    }

    renderQuestion();
  </script>
</body>
</html>
