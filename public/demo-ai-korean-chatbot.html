<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI êµ­ì–´ í•™ìŠµ ì±—ë´‡ ë°ëª¨ - Dan Dan Korean</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        .scenario-selector {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            justify-content: center;
        }

        .scenario-btn {
            padding: 6px 12px;
            border: 2px solid #56ab2f;
            background: white;
            color: #56ab2f;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
        }

        .scenario-btn:hover {
            background: #56ab2f;
            color: white;
            transform: translateY(-2px);
        }

        .scenario-btn.active {
            background: #56ab2f;
            color: white;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            overflow: hidden;
            animation: float-avatar 3s ease-in-out infinite;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
            margin-right: 12px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            margin-left: 12px;
            order: 2;
        }

        /* ì•„ë°”íƒ€ ë‘¥ë‘¥ ë– ë‹¤ë‹ˆëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes float-avatar {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }

        .message-content {
            max-width: 70%;
            padding: 15px 18px;
            border-radius: 18px;
            line-height: 1.8;
            font-size: 15px;
            word-wrap: break-word;
            word-break: keep-all;
            overflow-wrap: break-word;
            white-space: pre-line;
        }

        .message.ai .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .feedback {
            margin-top: 12px;
            padding: 14px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }

        .feedback.correction {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            color: #e65100;
        }

        .feedback.praise {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #1b5e20;
        }

        .feedback.grammar {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #0d47a1;
        }

        .feedback.vocabulary {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            color: #4a148c;
        }

        .feedback-title {
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-replies {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-reply-btn {
            padding: 8px 14px;
            background: white;
            border: 2px solid #56ab2f;
            color: #56ab2f;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .quick-reply-btn:hover {
            background: #56ab2f;
            color: white;
            transform: scale(1.05);
        }

        .input-area {
            padding: 20px 25px;
            background: white;
            border-top: 2px solid #e9ecef;
            display: flex;
            gap: 12px;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        #userInput {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #56ab2f;
        }

        .send-btn, .voice-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .send-btn:hover, .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .voice-btn {
            width: 42px;
            padding: 10px;
            font-size: 16px;
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .typing-indicator.show {
            display: flex;
            gap: 5px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #56ab2f;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .stats {
            padding: 15px 25px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-around;
            border-top: 2px solid #e9ecef;
            font-size: 14px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #56ab2f;
            display: block;
        }

        .stat-label {
            color: #6c757d;
            font-size: 12px;
        }

        .example-box {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 13px;
            color: #495057;
            border-left: 3px solid #56ab2f;
        }

        .example-title {
            font-weight: 600;
            color: #56ab2f;
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .container {
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .message-content {
                max-width: 85%;
            }

            .scenario-selector {
                padding: 10px 15px;
            }

            .scenario-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‹ AI ê³ ë˜ìŒ¤</h1>
            <p>AI ê³ ë˜ìŒ¤ì—ê²Œ ê³µë¶€í•˜ë‹¤ ëª¨ë¥´ëŠ” ê±¸ ë¬¼ì–´ë³´ì„¸ìš”!</p>
        </div>

        <div class="scenario-selector">
            <button class="scenario-btn active" data-scenario="conversation">ëŒ€í™”</button>
            <button class="scenario-btn" data-scenario="grammar">ë¬¸ë²•</button>
            <button class="scenario-btn" data-scenario="writing">ê¸€ì“°ê¸°</button>
            <button class="scenario-btn" data-scenario="reading">ë…í•´</button>
            <button class="scenario-btn" data-scenario="vocabulary">ì–´íœ˜</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="message-avatar"><img src="/images/whale-ai-teacher.png" alt="ê³ ë˜ìŒ¤"></div>
                <div class="message-content">
                    ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” êµ­ì–´ í•™ìŠµì„ ë„ì™€ì£¼ëŠ” AI ê³ ë˜ìŒ¤ì´ì—ìš”! ì˜¤ëŠ˜ì€ êµ­ì–´ ê³µë¶€ ì¤‘ ì–´ë–¤ ê²Œ ê¶ê¸ˆí• ê¹Œìš”?
                </div>
            </div>
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <span class="stat-value" id="totalCoins">0</span>
                <span class="stat-label">ì´ íšë“ ê³ ë˜ Coin</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="remainingCoins">0</span>
                <span class="stat-label">ë³´ìœ  ê³ ë˜ Coin</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="usedCoins">0</span>
                <span class="stat-label">ì‚¬ìš©í•œ ê³ ë˜ Coin</span>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                <button class="voice-btn" id="voiceBtn">ğŸ¤</button>
                <button class="send-btn" id="sendBtn">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        const scenarios = {
            grammar: {
                intro: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” êµ­ì–´ í•™ìŠµì„ ë„ì™€ì£¼ëŠ” AI ì„ ìƒë‹˜ì´ì—ìš”. ì˜¤ëŠ˜ì€ ë§ì¶¤ë²•ê³¼ ë¬¸ë²•ì— ëŒ€í•´ ë°°ì›Œë³¼ê¹Œìš”?<br><br>ì˜ˆë¥¼ ë“¤ì–´, \"ì•ˆë…•í•˜ì„¸ìš”\"ì™€ \"ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ\"ì˜ ì°¨ì´ë¥¼ ì•Œê³  ê³„ì‹ ê°€ìš”?",
                quickReplies: [
                    "ì°¨ì´ê°€ ë­ì˜ˆìš”?",
                    "ë§ì¶¤ë²• ê³µë¶€í•˜ê³  ì‹¶ì–´ìš”",
                    "ë¬¸ì¥ ì²¨ì‚­í•´ ì£¼ì„¸ìš”"
                ],
                responses: {
                    ì°¨ì´: "ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”! \"ì•ˆë…•í•˜ì„¸ìš”\"ëŠ” ì¼ë°˜ì ì¸ ì¡´ëŒ“ë§ì´ê³ , \"ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ\"ëŠ” ë” ë†’ì„ì˜ ê²©ì‹ì²´ì˜ˆìš”. ìƒí™©ì— ë”°ë¼ ì ì ˆíˆ ì‚¬ìš©í•˜ë©´ ì¢‹ì•„ìš”.",
                    ë§ì¶¤ë²•: "ë§ì¶¤ë²•ì„ ê³µë¶€í•˜ê³  ì‹¶ìœ¼ì‹œêµ°ìš”! ìì£¼ í‹€ë¦¬ëŠ” ë§ì¶¤ë²•ì„ ì•Œë ¤ë“œë¦´ê²Œìš”. ì˜ˆë¥¼ ë“¤ì–´ \"ë˜\"ì™€ \"ë¼\"ì˜ ì°¨ì´ë¥¼ ì•„ì‹œë‚˜ìš”?",
                    ë¬¸ì¥: "ë¬¼ë¡ ì´ì£ ! ì²¨ì‚­ë°›ê³  ì‹¶ì€ ë¬¸ì¥ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. ë¬¸ë²•, ë§ì¶¤ë²•, í‘œí˜„ì„ ëª¨ë‘ ì ê²€í•´ ë“œë¦´ê²Œìš”.",
                    ë˜: "\"ë˜\"ëŠ” ë™ì‚¬ \"ë˜ë‹¤\"ì˜ ì–´ê°„ì´ê³ , \"ë¼\"ëŠ” \"ë˜ì–´\"ì˜ ì¤„ì„ë§ì´ì—ìš”. \"ì•ˆ ë¼\"ì²˜ëŸ¼ ì“°ì´ì£ !",
                    default: "ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”! ë” ìì„¸íˆ ì„¤ëª…í•´ ë“œë¦´ê²Œìš”."
                }
            },
            writing: {
                intro: "ê¸€ì“°ê¸° ì—°ìŠµì„ í•´ë³¼ê¹Œìš”? ì¼ê¸°, í¸ì§€, ë˜ëŠ” ì§§ì€ ì´ì•¼ê¸°ë¥¼ ì¨ë³´ì„¸ìš”. ì œê°€ ì¹œì ˆí•˜ê²Œ ì²¨ì‚­í•´ ë“œë¦´ê²Œìš”!",
                quickReplies: [
                    "ì¼ê¸° ì“°ê¸° ë„ì™€ì£¼ì„¸ìš”",
                    "ê°ì‚¬ í¸ì§€ ì“°ê³  ì‹¶ì–´ìš”",
                    "ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ê³  ì‹¶ì–´ìš”"
                ],
                responses: {
                    ì¼ê¸°: "ì¢‹ì•„ìš”! ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ ì¤‘ ê¸°ì–µì— ë‚¨ëŠ” ê²ƒì„ ììœ ë¡­ê²Œ ì¨ë³´ì„¸ìš”. ë¬¸ì¥ êµ¬ì„±ê³¼ í‘œí˜„ì„ í•¨ê»˜ ë´ë“œë¦´ê²Œìš”.",
                    í¸ì§€: "ê°ì‚¬ í¸ì§€ëŠ” ë§ˆìŒì„ ì „í•˜ëŠ” ì¢‹ì€ ë°©ë²•ì´ì—ìš”. ëˆ„êµ¬ì—ê²Œ ì“°ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? ì„ ìƒë‹˜, ë¶€ëª¨ë‹˜, ì¹œêµ¬?",
                    ì´ì•¼ê¸°: "ë©‹ì ¸ìš”! ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ê³  ì‹¶ìœ¼ì„¸ìš”? ì£¼ì œë‚˜ ì¸ë¬¼ì„ ë¨¼ì € ì •í•´ë³¼ê¹Œìš”?",
                    ì„ ìƒë‹˜: "ì„ ìƒë‹˜ê»˜ ê°ì‚¬ í¸ì§€ë¥¼ ì“°ì‹œëŠ”êµ°ìš”! \"ì„ ìƒë‹˜, í•­ìƒ ê°ì‚¬í•©ë‹ˆë‹¤\" ê°™ì€ í‘œí˜„ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ì¢‹ì•„ìš”.",
                    default: "ì •ë§ ì¢‹ì€ ìƒê°ì´ì—ìš”! ììœ ë¡­ê²Œ ì¨ë³´ì„¸ìš”."
                }
            },
            reading: {
                intro: "ë…í•´ë ¥ì„ í‚¤ì›Œë³¼ê¹Œìš”? ì§§ì€ ê¸€ì„ ì½ê³  ë‚´ìš©ì„ ì´í•´í•˜ëŠ” ì—°ìŠµì„ í•´ë´ìš”!",
                quickReplies: [
                    "ê¸€ ì½ê³  ì§ˆë¬¸ ë°›ê¸°",
                    "ìš”ì•½í•˜ëŠ” ë²• ë°°ìš°ê¸°",
                    "ì£¼ì œ ì°¾ëŠ” ë²• ì•Œë ¤ì£¼ì„¸ìš”"
                ],
                responses: {
                    ê¸€: "ì¢‹ì•„ìš”! ì´ ê¸€ì„ ì½ì–´ë³´ì„¸ìš”: \"ë´„ì´ ë˜ì ê½ƒë“¤ì´ í”¼ì–´ë‚¬ë‹¤. ë”°ëœ»í•œ í–‡ì‚´ ì•„ë˜ ë‚˜ë¹„ë“¤ì´ ë‚ ì•„ë‹¤ë…”ë‹¤.\" ì´ ê¸€ì˜ ë°°ê²½ì€ ì–¸ì œì¼ê¹Œìš”?",
                    ìš”ì•½: "ìš”ì•½í•  ë•ŒëŠ” ê°€ì¥ ì¤‘ìš”í•œ ë‚´ìš©ì„ ê°„ì¶”ë ¤ì•¼ í•´ìš”. 'ëˆ„ê°€, ë¬´ì—‡ì„, ì–¸ì œ, ì–´ë””ì„œ, ì™œ, ì–´ë–»ê²Œ'ë¥¼ ìƒê°í•˜ë©´ ì¢‹ì•„ìš”!",
                    ì£¼ì œ: "ê¸€ì˜ ì£¼ì œëŠ” ê¸€ì“´ì´ê°€ ê°€ì¥ ë§í•˜ê³  ì‹¶ì€ ê²ƒì´ì—ìš”. ë°˜ë³µë˜ëŠ” ë‹¨ì–´ë‚˜ ë¬¸ì¥ì— ì£¼ëª©í•˜ë©´ ì°¾ê¸° ì‰¬ì›Œìš”!",
                    ë´„: "ì •ë‹µì´ì—ìš”! 'ê½ƒë“¤ì´ í”¼ì–´ë‚¬ë‹¤', 'ë”°ëœ»í•œ í–‡ì‚´' ê°™ì€ í‘œí˜„ì—ì„œ ë´„ì´ë¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆì£ !",
                    default: "ì˜ ìƒê°í•´ë´¤ì–´ìš”! í•¨ê»˜ ë” ì•Œì•„ë³¼ê¹Œìš”?"
                }
            },
            vocabulary: {
                intro: "ì–´íœ˜ë ¥ì„ í‚¤ì›Œë³¼ê¹Œìš”? ìƒˆë¡œìš´ ë‹¨ì–´ë¥¼ ë°°ìš°ê³  ë¬¸ì¥ì—ì„œ ì–´ë–»ê²Œ ì“°ëŠ”ì§€ ì—°ìŠµí•´ë´ìš”!",
                quickReplies: [
                    "ìƒˆë¡œìš´ ë‹¨ì–´ ë°°ìš°ê¸°",
                    "ì†ë‹´ ì•Œë ¤ì£¼ì„¸ìš”",
                    "ë¹„ìŠ·í•œ ë§ ì°¾ê¸°"
                ],
                responses: {
                    ë‹¨ì–´: "ì˜¤ëŠ˜ì˜ ë‹¨ì–´ëŠ” 'ë°°ë ¤'ì˜ˆìš”! ë‹¤ë¥¸ ì‚¬ëŒì„ ìƒê°í•˜ê³  ë„ì™€ì£¼ëŠ” ë§ˆìŒì„ ëœ»í•´ìš”. \"ì¹œêµ¬ë¥¼ ë°°ë ¤í•˜ë‹¤\"ì²˜ëŸ¼ ì“°ì´ì£ .",
                    ì†ë‹´: "ì¢‹ì•„ìš”! \"í‹°ëŒ ëª¨ì•„ íƒœì‚°\"ì´ë¼ëŠ” ì†ë‹´ì„ ì•„ì‹œë‚˜ìš”? ì‘ì€ ê²ƒë„ ëª¨ìœ¼ë©´ í° ê²ƒì´ ëœë‹¤ëŠ” ëœ»ì´ì—ìš”!",
                    ë¹„ìŠ·í•œ: "'ê¸°ì˜ë‹¤'ì™€ ë¹„ìŠ·í•œ ë§ì—ëŠ” 'ì¦ê²ë‹¤', 'í–‰ë³µí•˜ë‹¤', 'ì‹ ë‚˜ë‹¤' ë“±ì´ ìˆì–´ìš”. ìƒí™©ì— ë§ê²Œ ì¨ë³´ì„¸ìš”!",
                    ë°°ë ¤: "ì˜í•˜ì…¨ì–´ìš”! \"ë™ìƒì„ ë°°ë ¤í–ˆë‹¤\"ì²˜ëŸ¼ ë¬¸ì¥ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.",
                    default: "í›Œë¥­í•´ìš”! ì–´íœ˜ë ¥ì´ ì ì  ëŠ˜ê³  ìˆì–´ìš”!"
                }
            },
            conversation: {
                intro: "ììœ ë¡­ê²Œ ëŒ€í™”í•˜ë©° êµ­ì–´ ì‹¤ë ¥ì„ í‚¤ì›Œë´ìš”! ê¶ê¸ˆí•œ ê²ƒì´ë‚˜ ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ì´ì•¼ê¸°í•´ ì£¼ì„¸ìš”.",
                quickReplies: [
                    "ì˜¤ëŠ˜ í•™êµì—ì„œ ì¬ë¯¸ìˆì—ˆì–´ìš”",
                    "êµ­ì–´ ê³µë¶€ê°€ ì–´ë ¤ì›Œìš”",
                    "ì±… ì¶”ì²œí•´ ì£¼ì„¸ìš”"
                ],
                responses: {
                    í•™êµ: "ì˜¤! ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ìì„¸íˆ ì´ì•¼ê¸°í•´ ì£¼ì„¸ìš”. ë¬¸ì¥ìœ¼ë¡œ ì˜ í‘œí˜„í•˜ëŠ” ê²ƒë„ ì—°ìŠµì´ì—ìš”!",
                    ì–´ë ¤ì›Œ: "ê´œì°®ì•„ìš”! ì–´ë ¤ìš´ ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì œê°€ ë„ì™€ë“œë¦´ê²Œìš”. ì–´ë–¤ ë¶€ë¶„ì´ ê°€ì¥ ì–´ë µë‚˜ìš”?",
                    ì±…: "ì¢‹ì€ ì±…ë“¤ì´ ë§ì•„ìš”! ë‚˜ì´ì™€ ê´€ì‹¬ì‚¬ì— ë”°ë¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”. ì–´ë–¤ ì¢…ë¥˜ì˜ ì±…ì„ ì¢‹ì•„í•˜ì„¸ìš”?",
                    ì¹œêµ¬: "ì¹œêµ¬ì™€ ìˆì—ˆë˜ ì¼ì´êµ°ìš”! ê·¸ ì¼ì— ëŒ€í•œ ëŠë‚Œì„ í‘œí˜„í•´ ë³´ì„¸ìš”. ê¸°ë»¤ë‚˜ìš”, ìŠ¬íë‚˜ìš”?",
                    default: "ê·¸ë ‡êµ°ìš”! ë” ìì„¸íˆ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?"
                }
            }
        };

        let currentScenario = 'conversation';
        let totalCoins = 0; // ë‚˜ì˜ ê³ ë˜ Coin (ë‹¨ì› ì™„ë£Œ ì‹œ +10)
        let usedCoins = 0; // ì‚¬ìš©í•œ ê³ ë˜ Coin (ëŒ€í™” 1íšŒë‹¹ -1)
        let conversationHistory = [];

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì½”ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadCoins() {
            const savedTotalCoins = localStorage.getItem('whaleTotalCoins');
            const savedUsedCoins = localStorage.getItem('whaleUsedCoins');
            const isFirstVisit = localStorage.getItem('whaleFirstVisit');

            // ìµœì´ˆ ë°©ë¬¸ ì‹œ 10 coin ì§€ê¸‰
            if (!isFirstVisit) {
                totalCoins = 10;
                usedCoins = 0;
                localStorage.setItem('whaleFirstVisit', 'true');
                saveCoins();
            } else {
                if (savedTotalCoins) totalCoins = parseInt(savedTotalCoins);
                if (savedUsedCoins) usedCoins = parseInt(savedUsedCoins);
            }

            updateStats();
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì½”ì¸ ì •ë³´ ì €ì¥
        function saveCoins() {
            localStorage.setItem('whaleTotalCoins', totalCoins.toString());
            localStorage.setItem('whaleUsedCoins', usedCoins.toString());
        }

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const typingIndicator = document.querySelector('.typing-indicator');

        // ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
        document.querySelectorAll('.scenario-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentScenario = btn.dataset.scenario;
                resetChat();
            });
        });

        function resetChat() {
            chatContainer.innerHTML = '';
            conversationHistory = [];
            // ì´ˆê¸° ë©”ì‹œì§€
            addAIMessage("ì•ˆë…•í•˜ì„¸ìš”!<br>ì €ëŠ” êµ­ì–´ í•™ìŠµì„ ë„ì™€ì£¼ëŠ” AI ê³ ë˜ìŒ¤ì´ì—ìš”!<br><br>ì˜¤ëŠ˜ì€ êµ­ì–´ ê³µë¶€ ì¤‘ ì–´ë–¤ ê²Œ ê¶ê¸ˆí• ê¹Œìš”?");
            updateStats();
        }

        function addAIMessage(text, quickReplies = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';

            let quickReplyHTML = '';
            if (quickReplies && quickReplies.length > 0) {
                quickReplyHTML = '<div class="quick-replies">';
                quickReplies.forEach(reply => {
                    quickReplyHTML += `<button class="quick-reply-btn">${reply}</button>`;
                });
                quickReplyHTML += '</div>';
            }

            messageDiv.innerHTML = `
                <div class="message-avatar"><img src="/images/whale-ai-teacher.png" alt="ê³ ë˜ìŒ¤"></div>
                <div class="message-content">
                    ${text}
                    ${quickReplyHTML}
                </div>
            `;

            if (typingIndicator && typingIndicator.parentNode === chatContainer) {
                chatContainer.insertBefore(messageDiv, typingIndicator);
            } else {
                chatContainer.appendChild(messageDiv);
            }

            // Quick reply ë²„íŠ¼ ì´ë²¤íŠ¸
            messageDiv.querySelectorAll('.quick-reply-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    sendMessage(btn.textContent);
                });
            });

            scrollToBottom();
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
                <div class="message-avatar"><img src="/images/student-whale.png" alt="í•™ìƒ"></div>
            `;
            if (typingIndicator && typingIndicator.parentNode === chatContainer) {
                chatContainer.insertBefore(messageDiv, typingIndicator);
            } else {
                chatContainer.appendChild(messageDiv);
            }
            scrollToBottom();
        }

        // ì½”ì¸ ë¶€ì¡± ì²´í¬
        function checkCoinsBeforeSend() {
            const remainingCoins = totalCoins - usedCoins;
            if (remainingCoins <= 0) {
                showCoinWarning();
                return false;
            }
            return true;
        }

        // ì½”ì¸ ë¶€ì¡± ê²½ê³  ë©”ì‹œì§€
        function showCoinWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-size: 16px;
                font-weight: 600;
                animation: fadeInOut 3s ease;
            `;
            warningDiv.innerHTML = 'âš ï¸<br>ì¶”ê°€ í•™ìŠµ ì™„ë£Œ í›„<br>ê³ ë˜ Coin ë°›ê¸°!';
            document.body.appendChild(warningDiv);

            setTimeout(() => {
                warningDiv.remove();
            }, 3000);
        }

        function addFeedback(message, type = 'feedback', title = '') {
            const lastAIMessage = chatContainer.querySelector('.message.ai:last-of-type .message-content');
            if (lastAIMessage) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = `feedback ${type}`;

                let titleHTML = title ? `<div class="feedback-title">${title}</div>` : '';
                feedbackDiv.innerHTML = titleHTML + message;

                lastAIMessage.appendChild(feedbackDiv);
            }
        }

        function analyzeKoreanText(userText) {
            const feedbacks = [];

            // ë§ì¶¤ë²• ê²€ì‚¬
            if (userText.includes('ë¬ì–´') || userText.includes('ë¬ë‹¤')) {
                feedbacks.push({
                    type: 'correction',
                    title: 'âŒ ë§ì¶¤ë²• ì˜¤ë¥˜',
                    message: '"ë¬ì–´"ëŠ” ì˜ëª»ëœ í‘œí˜„ì´ì—ìš”. "ëì–´" ë˜ëŠ” "ë˜ì—ˆì–´"ê°€ ë§ì•„ìš”!<div class="example-box"><div class="example-title">ì˜¬ë°”ë¥¸ ì˜ˆë¬¸</div>"ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•„ì¡Œì–´ìš”" âœ“</div>'
                });
            }

            if (userText.includes('ì•Šë˜') || userText.includes('ì•ˆë˜')) {
                feedbacks.push({
                    type: 'correction',
                    title: 'âŒ ë„ì–´ì“°ê¸° ì˜¤ë¥˜',
                    message: '"ì•ˆë˜"ëŠ” "ì•ˆ ë¼" ë˜ëŠ” "ì•ˆ ë˜ì–´"ë¡œ ë„ì–´ ì¨ì•¼ í•´ìš”!<div class="example-box"><div class="example-title">ì˜¬ë°”ë¥¸ ì˜ˆë¬¸</div>"ì´ê±´ ì•ˆ ë¼ìš”" âœ“</div>'
                });
            }

            if (userText.includes('ì›¬ì§€') && userText.includes('ì´ìœ ')) {
                feedbacks.push({
                    type: 'grammar',
                    title: 'ğŸ’¡ ì–´íœ˜ íŒ',
                    message: '"ì›¬ì§€"ì™€ "ì™ ì§€"ëŠ” ë‹¤ë¥¸ ëœ»ì´ì—ìš”. "ì›¬ì§€ ëª¨ë¥¼ ì´ìœ "ëŠ” "ì™ ì§€ ëª¨ë¥´ê²Œ"ê°€ ë” ìì—°ìŠ¤ëŸ¬ì›Œìš”!'
                });
            }

            // ê¸ì •ì  í”¼ë“œë°±
            if (userText.length > 15 && userText.includes('.') || userText.includes('!') || userText.includes('?')) {
                correctCount++;
                learningPoints += 10;
                feedbacks.push({
                    type: 'praise',
                    title: 'ğŸŒŸ í›Œë¥­í•´ìš”!',
                    message: 'ì™„ì „í•œ ë¬¸ì¥ì„ ë¬¸ì¥ë¶€í˜¸ì™€ í•¨ê»˜ ì˜ ì‘ì„±í–ˆì–´ìš”! ì´ë ‡ê²Œ ì •í™•í•˜ê²Œ ì“°ëŠ” ìŠµê´€ì´ ì¤‘ìš”í•´ìš”.'
                });
            }

            // ì¡´ëŒ“ë§ ì‚¬ìš©
            if ((userText.includes('ìš”') || userText.includes('ìŠµë‹ˆë‹¤')) && userText.length > 5) {
                correctCount++;
                learningPoints += 5;
                feedbacks.push({
                    type: 'praise',
                    title: 'ğŸ‘ ì˜ˆì˜ë°”ë¥¸ í‘œí˜„',
                    message: 'ì¡´ëŒ“ë§ì„ ì •í™•í•˜ê²Œ ì‚¬ìš©í–ˆì–´ìš”! ìƒí™©ì— ë§ëŠ” ì–¸ì–´ ì‚¬ìš©ì´ ì •ë§ ì¢‹ì•„ìš”.'
                });
            }

            // ì–´íœ˜ í’ë¶€ì„±
            const richWords = ['ì•„ë¦„ë‹µ', 'í™˜ìƒì ', 'ë©‹ì§„', 'í›Œë¥­', 'ê°ì‚¬', 'ë°°ë ¤', 'ì¡´ì¤‘', 'ë…¸ë ¥'];
            if (richWords.some(word => userText.includes(word))) {
                learningPoints += 15;
                feedbacks.push({
                    type: 'vocabulary',
                    title: 'ğŸ“š í’ë¶€í•œ ì–´íœ˜',
                    message: 'ìˆ˜ì¤€ ë†’ì€ ì–´íœ˜ë¥¼ ì‚¬ìš©í–ˆì–´ìš”! ë‹¤ì–‘í•œ í‘œí˜„ì„ ì•„ëŠ” ê²ƒì´ êµ­ì–´ ì‹¤ë ¥ì˜ í•µì‹¬ì´ì—ìš”.'
                });
            }

            // ë¬¸ì¥ êµ¬ì¡°
            if (userText.includes('ë•Œë¬¸ì—') || userText.includes('ê·¸ë˜ì„œ') || userText.includes('í•˜ì§€ë§Œ')) {
                learningPoints += 8;
                feedbacks.push({
                    type: 'grammar',
                    title: 'âœï¸ ì¢‹ì€ ë¬¸ì¥ êµ¬ì¡°',
                    message: 'ì ‘ì†ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ë…¼ë¦¬ì ìœ¼ë¡œ ë¬¸ì¥ì„ ì—°ê²°í–ˆì–´ìš”! ê¸€ì˜ íë¦„ì´ ìì—°ìŠ¤ëŸ¬ì›Œìš”.'
                });
            }

            return feedbacks;
        }

        function getAIResponse(userText) {
            const scenario = scenarios[currentScenario];
            const lowerText = userText;

            // í‚¤ì›Œë“œ ê¸°ë°˜ ì‘ë‹µ
            for (let key in scenario.responses) {
                if (lowerText.includes(key)) {
                    return scenario.responses[key];
                }
            }

            // ì‹œë‚˜ë¦¬ì˜¤ë³„ íŠ¹ë³„ ì‘ë‹µ
            if (currentScenario === 'grammar') {
                if (lowerText.includes('ì–´ë–»ê²Œ') || lowerText.includes('ë°©ë²•')) {
                    return "ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”! ë§ì¶¤ë²•ì„ ì˜ ì“°ë ¤ë©´ ìì£¼ ì±…ì„ ì½ê³ , ëª¨ë¥´ëŠ” í‘œí˜„ì€ ì‚¬ì „ì„ ì°¾ì•„ë³´ëŠ” ìŠµê´€ì„ ë“¤ì´ë©´ ì¢‹ì•„ìš”.";
                }
            }

            if (currentScenario === 'writing') {
                if (userText.length > 20) {
                    return "ì™€! ë¬¸ì¥ì„ ì •ë§ ì˜ ì¼ì–´ìš”. í‘œí˜„ë ¥ì´ ì¢‹ë„¤ìš”. ì´ëŸ° ì‹ìœ¼ë¡œ ê³„ì† ì—°ìŠµí•˜ë©´ ê¸€ì“°ê¸° ì‹¤ë ¥ì´ ë§ì´ ëŠ˜ ê±°ì˜ˆìš”!";
                }
            }

            // ê¸°ë³¸ ì‘ë‹µ
            return scenario.responses.default || "ì¢‹ì•„ìš”! ê³„ì† ì´ì•¼ê¸°í•´ ì£¼ì„¸ìš”.";
        }

        function showTypingIndicator() {
            typingIndicator.classList.add('show');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.classList.remove('show');
        }

        async function sendMessage(text = null) {
            const message = text || userInput.value.trim();
            if (!message) return;

            // ì½”ì¸ ì²´í¬
            if (!checkCoinsBeforeSend()) {
                userInput.value = '';
                return;
            }

            // ë©”ì‹œì§€ ì „ì†¡ ë° ì½”ì¸ ì°¨ê°
            addUserMessage(message);
            usedCoins++;
            saveCoins();
            updateStats();

            userInput.value = '';

            conversationHistory.push({ role: 'user', content: message });

            // AI ì‘ë‹µ ë°›ê¸°
            showTypingIndicator();

            try {
                const response = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        scenario: currentScenario,
                        conversationHistory: conversationHistory.slice(-10) // ìµœê·¼ 10ê°œë§Œ ì „ì†¡
                    })
                });

                const data = await response.json();

                hideTypingIndicator();

                if (data.success) {
                    addAIMessage(data.response);

                    // ì„œë²„ì—ì„œ ë°›ì€ í”¼ë“œë°± í‘œì‹œ
                    if (data.feedbacks && data.feedbacks.length > 0) {
                        data.feedbacks.forEach((feedback, index) => {
                            setTimeout(() => {
                                addFeedback(feedback.message, feedback.type, feedback.title);
                                if (feedback.type === 'praise') {
                                    correctCount++;
                                    learningPoints += 10;
                                    updateStats();
                                }
                            }, 300 * (index + 1));
                        });
                    }

                    conversationHistory.push({ role: 'assistant', content: data.response });
                } else {
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì‘ë‹µ
                    addAIMessage('ì£„ì†¡í•´ìš”, ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    console.error('AI ì‘ë‹µ ì˜¤ë¥˜:', data.error);
                }

            } catch (error) {
                hideTypingIndicator();
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                addAIMessage('ì£„ì†¡í•´ìš”, ì„œë²„ì™€ì˜ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
        }

        function updateStats() {
            const remainingCoins = totalCoins - usedCoins;
            document.getElementById('totalCoins').textContent = totalCoins;
            document.getElementById('usedCoins').textContent = usedCoins;
            document.getElementById('remainingCoins').textContent = remainingCoins;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ìŒì„± ì…ë ¥ ì‹œë®¬ë ˆì´ì…˜
        let isRecording = false;
        voiceBtn.addEventListener('click', () => {
            isRecording = !isRecording;
            voiceBtn.classList.toggle('recording', isRecording);

            if (isRecording) {
                voiceBtn.textContent = 'â¸ï¸';
                setTimeout(() => {
                    isRecording = false;
                    voiceBtn.classList.remove('recording');
                    voiceBtn.textContent = 'ğŸ¤';
                    userInput.value = "ì„ ìƒë‹˜, ë§ì¶¤ë²•ì´ ì–´ë ¤ì›Œìš”. ë„ì™€ì£¼ì„¸ìš”!";
                }, 2000);
            } else {
                voiceBtn.textContent = 'ğŸ¤';
            }
        });

        sendBtn.addEventListener('click', () => sendMessage());

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ì´ˆê¸°í™”
        loadCoins(); // ì €ì¥ëœ ì½”ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        scrollToBottom();

        // postMessage ë¦¬ìŠ¤ë„ˆ - ë‹¨ì› ì™„ë£Œ ì‹œ ì½”ì¸ ì—…ë°ì´íŠ¸ ë°›ê¸°
        window.addEventListener('message', function(event) {
            // ë³´ì•ˆ: ê°™ì€ originì—ì„œ ì˜¨ ë©”ì‹œì§€ë§Œ ì²˜ë¦¬
            if (event.origin !== window.location.origin) return;

            if (event.data && event.data.type === 'WHALE_COIN_UPDATE') {
                // localStorageì—ì„œ ìµœì‹  ì½”ì¸ ì •ë³´ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                const savedTotalCoins = localStorage.getItem('whaleTotalCoins');
                if (savedTotalCoins) {
                    totalCoins = parseInt(savedTotalCoins);
                    updateStats();
                }
            }
        });

        // localStorage ë³€ê²½ ê°ì§€ - ê°™ì€ í˜ì´ì§€ ë‚´ì—ì„œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        window.addEventListener('storage', function(event) {
            if (event.key === 'whaleTotalCoins' && event.newValue) {
                totalCoins = parseInt(event.newValue);
                updateStats();
            }
        });

        // ê°™ì€ window ë‚´ ì½”ì¸ ë³€ê²½ ê°ì§€ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
        setInterval(function() {
            const savedTotalCoins = localStorage.getItem('whaleTotalCoins');
            if (savedTotalCoins && parseInt(savedTotalCoins) !== totalCoins) {
                console.log('[ì±—ë´‡] ì½”ì¸ ë³€ê²½ ê°ì§€:', {
                    ì´ì „ì½”ì¸: totalCoins,
                    ìƒˆë¡œìš´ì½”ì¸: parseInt(savedTotalCoins),
                    localStorageê°’: savedTotalCoins
                });
                totalCoins = parseInt(savedTotalCoins);
                updateStats();
            }
        }, 500); // 0.5ì´ˆë§ˆë‹¤ ì²´í¬
    </script>
</body>
</html>
