<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>단단국어 BRAIN 문해원 | 메인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <!-- Open Graph 메타 태그 (카카오톡, SNS 공유용) -->
  <meta property="og:title" content="단단국어 BRAIN 문해원" />
  <meta property="og:description" content="AI 기반 맞춤형 국어 학습 플랫폼" />
  <meta property="og:image" content="https://dan-dan-app.onrender.com/images/brain-main-hero.jpg" />
  <meta property="og:url" content="https://dan-dan-app.onrender.com" />
  <meta property="og:type" content="website" />

  <!-- 🎉 Confetti 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* 🔄 로딩 스피너 - 인라인 크리티컬 CSS (즉시 로드) */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      transition: opacity 0.5s ease;
      will-change: opacity;
    }

    #loading-overlay.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .spinner-container {
      background: rgba(255, 250, 243, 0.98);
      border: 2px solid rgba(139, 117, 87, 0.2);
      border-radius: 24px;
      padding: 50px 70px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(139, 117, 87, 0.2);
      border-top: 5px solid #8b7557;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
      will-change: transform;
      transform: translateZ(0);
    }

    .loading-text {
      color: #5a4a3a;
      font-size: 20px;
      font-weight: 700;
      font-family: "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    :root {
      --bg: #f2ede5;
      --panel: #fffaf3;
      --accent: #8b2f2f;
      --line: #e5d4c1;
      --text: #3b2a1a;
    }
    * { box-sizing: border-box; }

    /* 🔥 아이패드 터치 딜레이 제거 */
    button, a, [onclick], .clickable, .tab, .menu-item, .study-room-item {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

body {
  margin: 0;
  min-height: 100vh;
  font-family: "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
  background: #f2ede5;   /* 기본 배경색만 남기기 (비디오 로딩 실패 시용) */
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  position: relative;
  overflow-x: hidden;
  opacity: 1;
  transition: opacity 0.5s ease, background-image 0.8s ease;
}


/* 🔥 메뉴 전체에 까는 MP4 배경 영상 */
.menu-bg-video {
  position: fixed;
  inset: 0;              /* top:0; right:0; bottom:0; left:0; 와 같음 */
  width: 100%;
  height: 100%;
  object-fit: cover;     /* 화면 가득 채우기 */
  z-index: -1;           /* 모든 내용 뒤로 보내기 */
  pointer-events: auto;  /* 클릭 가능하게 변경 */
  cursor: pointer;       /* 마우스 커서를 포인터로 변경 */
}

    header {
      background: #f7f1e5;
      border-bottom: 3px solid #c58a45;
      padding: 8px 20px 10px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      position: relative;
      z-index: 1;
    }
    .brand-title { font-size: 22px; font-weight: 700; color: #7f2b2b; }
    .brand-sub { font-size: 12px; color: #a57145; }

    /* 🔹 헤더 오른쪽(유저정보 + 로그아웃 버튼) */
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .layout {
      display: grid;
  grid-template-columns: 220px 210px 220px 1fr;  /* 🔥 첫 컬럼 폭만 220px로 확대 */
      min-height: calc(100vh - 65px);
      position: relative;
      z-index: 1;
    }
.col {
  border-right: 1px solid #e1d3c0;
  background: rgba(255, 250, 240, 0.85);
  overflow-y: auto;
}
    .col-title {
      padding: 12px 14px 6px;
      font-weight: 700;
      font-size: 13px;
      color: #5b3a22;
    }
    .series-list, .domain-list, .subject-list, .unit-list {
      list-style: none;
      margin: 0;
      padding: 4px 8px 16px;
    }
    .series-item,
    .domain-item,
    .subject-item,
    .unit-item {
      padding: 14px 18px;
      margin-bottom: 6px;
  background: rgba(248, 238, 214, 0.9);  /* ✅ 여기만 교체 */
      border: 1px solid transparent;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }
    .series-item:hover,
    .domain-item:hover,
    .subject-item:hover,
    .unit-item:hover {
      border-color: rgba(139,47,47,0.5);
      background: rgba(255,248,240,0.8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139,47,47,0.15);
    }
    .series-item.active,
    .domain-item.active,
    .subject-item.active,
    .unit-item.active {
      background: #af4604;
      color: #fff;
      border-color: #8b2f2f;
    }
    /* 비활성화된 시리즈 */
    .series-item.disabled {
      opacity: 0.4;
      filter: grayscale(1);
      cursor: not-allowed;
      pointer-events: none;
    }
    .meta { font-size: 11px; opacity: 0.6; }
    .detail-panel {
      padding: 14px 18px 40px;
      background: #fffdf8;
      overflow-y: auto;
    }
    .detail-title { font-weight: 700; margin-bottom: 2px; }
    .detail-desc { font-size: 12px; color: #9b7a54; margin-bottom: 10px; }
    

    /* 단원 오른쪽 묶음(번호 + 상태) */
    .unit-right {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .unit-list .unit-item { border-radius: 7px; font-size: 14px; }

    .badge {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 999px;
      padding: 1px 8px 2px;
      font-size: 10px;
    }

    /* ✅ 상태 뱃지 */
    .status-badge {
      display: inline-block;
      border-radius: 8px;
      padding: 3px 8px 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    /* 일반 과제 - ✏️ 미완료 */
    .status-default {
      background: #f8d4d4;
      color: #7f2525;
    }
    /* 일반 과제 - 🏆 학습완료 */
    .status-done {
      background: #aef3ae;
      color: #18622e;
    }
    /* AI 과제 - 🔄 학습필요 */
    .status-ai-pending {
      background: #e9d5ff;
      color: #6b21a8;
    }
    /* 별점 표시 */
    .unit-stars {
      display: inline-block;
      margin-right: 8px;
      font-size: 14px;
      color: #fbbf24;
      text-shadow: 0 0 2px rgba(251, 191, 36, 0.3);
    }

    /* AI 과제 - 🏆 학습완료 */
    .status-ai-done {
      background: #d1fae5;
      color: #065f46;
    }

    /* 모달 (준비중) */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(2px);
    }
    .overlay.show { display: flex; }
    .modal-box {
      background: #fffaf3;
      border: 1px solid rgba(139,47,47,0.08);
      border-radius: 18px;
      padding: 22px 24px 20px;
      width: 330px;
      text-align: center;
      box-shadow: 0 15px 45px rgba(0,0,0,0.12);
      animation: pop 0.25s ease;
    }
    @keyframes pop {
      from { transform: translateY(10px) scale(0.97); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal-emoji { font-size: 34px; margin-bottom: 6px; }
    .modal-title { font-weight: 700; margin-bottom: 6px; color: #6f2e2e; }
    .modal-msg { font-size: 12.5px; color: #8d6f51; line-height: 1.5; margin-bottom: 14px; }
    .modal-btn { background: #8b2f2f; color: #fff; border: none; border-radius: 999px; padding: 7px 16px 8px; font-size: 12.5px; cursor: pointer; }
    .modal-btn:hover { opacity: 0.9; }
    .modal-btn-danger {
      background: #b02a2a;
      border: 1px solid rgba(176,42,42,0.3);
    }
    .modal-btn-danger:hover {
      opacity: 0.95;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    /* 상단 사용자 표시 */
    #user-info {
      font-size: 12px;
      color: #8d6f51;
      background: rgba(255,255,255,0.3);
      padding: 6px 12px 7px;
      border-radius: 999px;
      border: 1px solid rgba(197,138,69,0.15);
      white-space: nowrap;
    }

    /* 🔴 로그아웃 버튼 */
    .logout-btn {
      padding: 6px 14px 7px;
      border-radius: 999px;
      border: 1px solid rgba(139,47,47,0.25);
      background: #8b2f2f;
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s;
    }
    .logout-btn:hover {
      opacity: 0.95;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }
    .logout-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .logout-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }


    /* 🔋 로딩 오버레이 */
    .overlay-loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    .overlay-loading.show {
      display: flex;
    }
    .loading-box {
      background: #fffaf3;
      border: 1px solid rgba(139,47,47,0.12);
      border-radius: 18px;
      width: 320px;
      text-align: center;
      padding: 28px 30px 26px;
      box-shadow: 0 15px 45px rgba(0,0,0,0.12);
    }
    .loading-emoji {
      font-size: 56px;
      margin-bottom: 8px;
    }
    .loading-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #6f2e2e;
    }
    .loading-msg {
      font-size: 13px;
      color: #8d6f51;
      margin-bottom: 14px;
    }
    .loading-progress {
      width: 100%;
      height: 10px;
      background: #e0d2c1;
      border-radius: 999px;
      position: relative;
      overflow: hidden;
    }
    .loading-bar {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: #8b2f2f;
      border-radius: 999px;
      transition: width 0.25s ease;
    }
    .loading-percent {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #8b2f2f;
    }

    .brand-sub-wrap {
      position: relative;      /* 루돌프의 기준점 */
      display: inline-block;
    }

    .brand-sub {
      white-space: nowrap;     /* 줄바꿈 방지 */
      line-height: 1.2;        /* 현재 줄 높이 유지 */
    }

    .brand-rudolph {
      position: absolute;
      right: -60px;
      top: -35px;
      transform: translateY(-50%);
      height: 50px;
      width: auto;
      display: block;
      pointer-events: none;
    }
    .bottom-snow {
      position: fixed;
      bottom: -100px;
      left: 0;
      width: 100%;
      pointer-events: none;
      z-index: 1;
    }
    /* === 메뉴 컬럼과 상세 패널을 투명하게 === */
.col {
  background: transparent !important;
}

.detail-panel {
  background: transparent !important;
}
/* 브랜드 서브 + 루돌프를 한 줄 정렬 */
.brand-sub-wrap {
  display: flex;
  align-items: center;
  justify-content: space-between;  /* 왼쪽 텍스트, 오른쪽 루돌프 */
}

/* 루돌프 영상 아이콘 스타일 */
.brand-rudolph {
  width: 100px;          /* 원하는 크기 */
  height: 100px;
  object-fit: contain;  /* 비율 유지 */
  display: block;
  margin-left: auto;    /* 오른쪽으로 밀기 */
  margin-right: -60px;  /* 더 오른쪽으로 */
  pointer-events: auto; /* 클릭 가능하도록 변경 */
  border: none;
  background: none;
  animation: float-whale 3s ease-in-out infinite;
  cursor: pointer;      /* 마우스 커서 변경 */
}

/* 고래 둥둥 떠다니는 애니메이션 */
@keyframes float-whale {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* 스토리 레이블 이미지 */
.story-label {
  width: 90px;
  height: auto;
  object-fit: contain;
  display: block;
  margin-left: -30px;
  pointer-events: none;
  animation: float-label 2.5s ease-in-out infinite;
  animation-delay: 0.3s;
}

/* 스토리 레이블 둥둥 애니메이션 (고래와 약간 다른 타이밍) */
@keyframes float-label {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-8px);
  }
}

/* 레이더 차트 아이콘 */
.radar-chart-icon {
  position: fixed;
  bottom: 30px;
  left: 30px;
  width: 120px;
  height: 120px;
  cursor: pointer;
  z-index: 1000;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
  animation: float-icon 3s ease-in-out infinite;
}

.radar-chart-icon:hover {
  animation-play-state: paused;
  transform: scale(1.1) translateY(-5px);
  filter: drop-shadow(0 8px 20px rgba(139, 47, 47, 0.4));
}

.radar-chart-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* 노트 아이콘 */
.note-icon {
  position: fixed;
  bottom: 30px;
  left: 140px;
  width: 120px;
  height: 130px;
  cursor: pointer;
  z-index: 1000;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
  user-select: none;
  animation: float-icon-delay 3s ease-in-out infinite;
}

.note-icon:hover {
  animation-play-state: paused;
  transform: scale(1.1);
  filter: drop-shadow(0 8px 20px rgba(139, 47, 47, 0.4));
}

.note-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* 레이더 등급 뱃지 */
/* 펀핑 애니메이션 */
@keyframes badgePump {
  0%, 100% {
    transform: translateX(-50%) scale(1);
  }
  50% {
    transform: translateX(-50%) scale(1.1);
  }
}

.radar-grade-badge {
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  background: #ff8c42;
  color: white;
  border-radius: 999px;
  padding: 8px 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  border: 3px solid white;
  z-index: 10;
  min-width: 70px;
  white-space: nowrap;
  animation: badgePump 2s ease-in-out infinite;
}

.radar-grade-badge.excellent {
  background: #5dade2;
  color: white;
}

.radar-grade-badge.good {
  background: #f1c40f;
  color: #333;
}

.radar-grade-badge.average {
  background: #ff8c42;
  color: white;
}

.radar-grade-badge.encourage {
  background: #e74c3c;
  color: white;
}

/* 어휘퀴즈 어휘력 지수 뱃지 */
.vocab-avg-badge {
  position: absolute;
  top: -5px;
  left: 25px;
  background: linear-gradient(135deg, #ff1493 0%, #ff69b4 100%);
  color: white;
  border-radius: 999px;
  min-width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 3px 8px rgba(255, 20, 147, 0.5);
  border: 2px solid white;
  animation: badge-pulse 2s ease-in-out infinite;
  padding: 0 6px;
}

/* 학습실 아이콘 */
.study-room-icon {
  position: fixed;
  bottom: 30px;
  left: 250px;
  width: 130px;
  height: 130px;
  cursor: pointer;
  z-index: 1000;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
  user-select: none;
  animation: float-icon 3s ease-in-out infinite;
  animation-delay: 0.5s;
}

.study-room-icon:hover {
  animation-play-state: paused;
  transform: scale(1.1);
  filter: drop-shadow(0 8px 20px rgba(139, 47, 47, 0.4));
}

.study-room-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* 학습실 과제 개수 뱃지 */
.study-room-badge {
  position: absolute;
  top: -5px;
  left: 25px;
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
  color: white;
  border-radius: 999px;
  min-width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 3px 8px rgba(238, 90, 82, 0.5);
  border: 2px solid white;
  animation: badge-pulse 2s ease-in-out infinite;
  padding: 0 6px;
}

@keyframes badge-pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

/* 아이콘 둥둥 떠다니는 애니메이션 */
@keyframes float-icon {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-12px);
  }
}

/* 노트 아이콘은 약간 시차를 둠 */
@keyframes float-icon-delay {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* 학습 분석 모달 */
.learning-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(3px);
  /* GPU 가속 */
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000px;
  will-change: transform, opacity;
}

.learning-modal.show {
  display: flex;
}

.learning-modal-content {
  background: #fff;
  width: 90vw;
  height: 90vh;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(20px) translateZ(0);
    opacity: 0;
  }
  to {
    transform: translateY(0) translateZ(0);
    opacity: 1;
  }
}

.learning-modal-header {
  position: absolute;
  top: 16px;
  right: 16px;
  z-index: 10;
}

.learning-modal-title {
  display: none;
}

.learning-modal-footer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.95);
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
}

.learning-action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  white-space: nowrap;
}

.learning-action-btn svg {
  flex-shrink: 0;
}

.send-btn {
  background: linear-gradient(135deg, #4A90E2 0%, #5CB3FF 100%);
  color: white;
}

.send-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(74, 144, 226, 0.4);
}

.download-btn {
  background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
  color: white;
}

.download-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(86, 171, 47, 0.4);
}

.learning-modal-close {
  background: rgba(0, 0, 0, 0.5);
  border: none;
  color: #fff;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.learning-modal-close:hover {
  background: rgba(0, 0, 0, 0.7);
  transform: scale(1.1);
}

.learning-modal-iframe {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
  /* GPU 가속 */
  transform: translateZ(0);
  backface-visibility: hidden;
  will-change: transform;
  /* 로딩 중 배경색 (깜박임 방지) */
  background: #ffffff;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.learning-modal-iframe[src]:not([src=""]) {
  opacity: 1;
}

/* 단원 학습 모달 */
.unit-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000px;
}

.unit-modal.show {
  display: flex;
}

.unit-modal-content {
  background: #fff;
  width: 90vw;
  height: 90vh;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  animation: modalSlideIn 0.3s ease;
  transform: translateZ(0);
  will-change: transform;
  -webkit-overflow-scrolling: touch;
}

.unit-modal-header {
  position: absolute;
  top: 16px;
  right: 16px;
  z-index: 10;
}

.unit-modal-close {
  background: rgba(0, 0, 0, 0.5);
  border: none;
  color: #fff;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.unit-modal-close:hover {
  background: rgba(0, 0, 0, 0.7);
  transform: scale(1.1);
}

.unit-modal-iframe {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
  background: #f5f5f5;
  transform: translateZ(0);
  will-change: contents;
}

/* AI 챗봇 플로팅 버튼 */
.ai-chatbot-floating-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 120px;
  height: 120px;
  cursor: pointer;
  z-index: 10002;
  transition: transform 0.3s ease;
  animation: floatingBounce 3s ease-in-out infinite;
}

.ai-chatbot-floating-btn:hover {
  animation: floatingHover 1s ease-in-out infinite;
}

.ai-chatbot-floating-btn img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
}

.ai-chatbot-speech-bubble {
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: bold;
  color: #333;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  animation: bubblePulse 2s ease-in-out infinite;
}

.ai-chatbot-speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 8px 6px 0 6px;
  border-style: solid;
  border-color: white transparent transparent transparent;
}

@keyframes floatingBounce {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-15px);
  }
}

@keyframes floatingHover {
  0%, 100% {
    transform: translateY(-5px) scale(1.05);
  }
  50% {
    transform: translateY(-20px) scale(1.1);
  }
}

@keyframes bubblePulse {
  0%, 100% {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }
  50% {
    opacity: 0.8;
    transform: translateX(-50%) scale(1.05);
  }
}

/* AI 챗봇 모달 - 핸드폰 형태 */
.ai-chatbot-modal {
  position: fixed;
  bottom: 160px;
  right: 30px;
  display: none;
  z-index: 10003;
}

.ai-chatbot-modal.show {
  display: block;
  animation: chatbotSlideUp 0.3s ease;
}

.ai-chatbot-modal-content {
  background: transparent;
  width: 400px;
  height: 650px;
  border-radius: 24px;
  overflow: visible;
  box-shadow: none;
  display: flex;
  flex-direction: column;
  position: relative;
  pointer-events: auto;
}

.ai-chatbot-modal-header {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 10;
  cursor: move;
}

.ai-chatbot-modal-close {
  background: rgba(0, 0, 0, 0.5);
  border: none;
  color: #fff;
  font-size: 24px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.ai-chatbot-modal-close:hover {
  background: rgba(0, 0, 0, 0.7);
  transform: scale(1.1);
}

.ai-chatbot-modal-iframe {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
  border-radius: 24px;
}

@keyframes chatbotSlideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 아이패드용 고정 배경 레이어 */
#tablet-fixed-bg {
  display: none;
}

/* 반응형: 태블릿 (아이패드 세로/가로) */
@media (max-width: 1400px) and (min-width: 769px) {
  #tablet-fixed-bg {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-color: #f5efe6;
    z-index: -1;
  }

  .ai-chatbot-modal-content {
    width: 320px;
    height: 600px;
  }

  .ai-chatbot-modal {
    right: 20px;
    bottom: 80px;
  }
}

/* 반응형: 작은 화면에서는 크기 조정 */
@media (max-width: 768px) {
  .ai-chatbot-modal-content {
    width: calc(100vw - 40px);
    height: calc(100vh - 200px);
    max-width: 400px;
  }

  .ai-chatbot-modal {
    right: 20px;
    bottom: 140px;
  }
}

/* 어휘력 퀴즈쇼 모달 - 중앙 팝업 */
.vocab-quiz-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10005;
}

.vocab-quiz-modal.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

.vocab-quiz-modal-content {
  background: #fff;
  width: 1000px;
  height: 750px;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  position: relative;
}

.vocab-quiz-modal-header {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 10;
}

.vocab-quiz-modal-close {
  background: rgba(0, 0, 0, 0.5);
  border: none;
  color: #fff;
  font-size: 28px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.vocab-quiz-modal-close:hover {
  background: rgba(0, 0, 0, 0.7);
  transform: scale(1.1);
}

.vocab-quiz-modal-iframe {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
  border-radius: 16px;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* 학습실 모달 */
.study-room-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10002;
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000px;
}

.study-room-modal.show {
  display: flex;
}

.study-room-modal-content {
  background: linear-gradient(135deg, #fffaf3 0%, #fff5e6 100%);
  width: 700px;
  max-height: 85vh;
  border-radius: 20px;
  overflow: visible;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  animation: modalSlideIn 0.3s ease;
}

.study-room-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  background: linear-gradient(135deg, #c94b4b 0%, #8b2f2f 50%, #5a1f1f 100%);
  background-size: 200% 200%;
  animation: gradientShift 8s ease infinite;
  color: white;
  border-bottom: 2px solid rgba(139, 47, 47, 0.3);
  box-shadow: 0 4px 15px rgba(139, 47, 47, 0.3);
  position: relative;
  overflow: hidden;
}

.study-room-modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
  animation: shimmer 3s infinite;
}

@keyframes gradientShift {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

@keyframes shimmer {
  0% {
    left: -100%;
  }
  100% {
    left: 100%;
  }
}

.study-room-modal-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  position: relative;
  z-index: 1;
}

.study-room-modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: #fff;
  font-size: 28px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
  z-index: 1;
}

.study-room-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* 자동과제부여 드롭다운 스타일 */
.auto-task-dropdown-wrapper {
  position: relative;
  display: inline-block;
  margin-left: 12px;
}

.auto-task-btn {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.auto-task-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.auto-task-btn .arrow {
  font-size: 10px;
  transition: transform 0.2s ease;
}

.auto-task-btn.open .arrow {
  transform: rotate(180deg);
}

.auto-task-dropdown {
  position: fixed;
  width: 360px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 999999;
  display: none;
  overflow: hidden;
}

.auto-task-dropdown.show {
  display: block;
  animation: dropdownSlide 0.2s ease;
}

@keyframes dropdownSlide {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.auto-task-dropdown-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px 20px;
  font-weight: 700;
  font-size: 15px;
}

.auto-task-dropdown-body {
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
}

.auto-task-section {
  margin-bottom: 20px;
}

.auto-task-section:last-child {
  margin-bottom: 0;
}

.auto-task-section-title {
  font-size: 13px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.auto-task-btn-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.series-btn, .day-btn {
  padding: 8px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  background: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #374151;
}

.series-btn:hover:not(:disabled), .day-btn:hover:not(:disabled) {
  border-color: #667eea;
  color: #667eea;
}

.series-btn.selected, .day-btn.selected {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
  color: white;
}

.series-btn:disabled, .day-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  background: #f3f4f6;
}

.task-count-input {
  display: flex;
  align-items: center;
  gap: 10px;
}

.task-count-input input {
  width: 80px;
  padding: 10px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.task-count-input input:focus {
  outline: none;
  border-color: #667eea;
}

.task-count-input span {
  font-size: 13px;
  color: #6b7280;
}

.auto-task-actions {
  display: flex;
  gap: 8px;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}

.auto-task-action-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.auto-task-action-btn.start {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
}

.auto-task-action-btn.start:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.auto-task-action-btn.pause {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.auto-task-action-btn.pause:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.auto-task-action-btn.stop {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
}

.auto-task-action-btn.stop:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

.auto-task-action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

.auto-task-status {
  margin-top: 16px;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  text-align: center;
}

.auto-task-status.running {
  background: #d1fae5;
  color: #065f46;
}

.auto-task-status.paused {
  background: #fef3c7;
  color: #92400e;
}

.auto-task-status.stopped {
  background: #f3f4f6;
  color: #6b7280;
}

.study-room-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.study-room-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.study-room-item {
  background: white;
  border: 2px solid #e0d2c1;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.study-room-item:not(.empty):hover {
  border-color: #8b2f2f;
  box-shadow: 0 4px 12px rgba(139, 47, 47, 0.15);
  transform: translateY(-2px);
}

.study-room-item.empty {
  background: repeating-linear-gradient(
    45deg,
    #fafafa,
    #fafafa 10px,
    #f0f0f0 10px,
    #f0f0f0 20px
  );
  border-style: dashed;
  border-color: #d0d0d0;
  justify-content: center;
}

.study-room-item.empty .empty-text {
  color: #999;
  font-size: 14px;
  font-weight: 500;
}

.study-room-item-left {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.study-room-item-title {
  font-size: 16px;
  font-weight: 700;
  color: #2c2c2c;
}

.study-room-item-meta {
  font-size: 13px;
  color: #888;
}

.study-room-item-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.trash-btn {
  background: transparent;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s ease;
}

.trash-btn:hover {
  transform: scale(1.2);
}

/* 오버레이 모달 공통 스타일 */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10003;
  backdrop-filter: blur(3px);
}

.overlay.show {
  display: flex;
}

/* 관리자 비밀번호 모달 */
.password-modal,
.assign-modal {
  background: white;
  border-radius: 16px;
  padding: 24px;
  width: 400px;
  max-width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease;
}

.password-modal-header h3,
.assign-modal-header h3 {
  margin: 0 0 16px 0;
  font-size: 18px;
  font-weight: 700;
  color: #2c2c2c;
}

.password-modal-body,
.assign-modal-body {
  margin-bottom: 20px;
}

.password-modal-body p,
.assign-modal-body p {
  margin: 0 0 16px 0;
  font-size: 14px;
  color: #666;
}

.password-modal-body input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0d2c1;
  border-radius: 8px;
  font-size: 16px;
  box-sizing: border-box;
  transition: border-color 0.2s ease;
}

.password-modal-body input:focus {
  outline: none;
  border-color: #8b2f2f;
}

.password-modal-footer,
.assign-modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn-cancel,
.btn-confirm {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-cancel {
  background: #f0f0f0;
  color: #666;
}

.btn-cancel:hover {
  background: #e0e0e0;
}

.btn-confirm {
  background: linear-gradient(135deg, #8b2f2f 0%, #6f2e2e 100%);
  color: white;
}

.btn-confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 47, 47, 0.3);
}

/* 드래그 중 시각 효과 */
.dragging {
  opacity: 0.5;
  transform: scale(0.98);
}

.drag-over {
  border-color: #4A90E2 !important;
  background: rgba(74, 144, 226, 0.05);
  transform: scale(1.02);
}

/* 반응형: 태블릿 (아이패드) */
@media (max-width: 1024px) and (min-width: 901px) {
  .vocab-quiz-modal-content {
    width: 70%;
    height: 65%;
    max-width: 650px;
    max-height: 550px;
  }
}

/* 반응형: 작은 태블릿 및 모바일 */
@media (max-width: 900px) {
  .vocab-quiz-modal-content {
    width: 90%;
    height: 80%;
  }
}

/* 아이패드 전용 - 메인 메뉴 화면 축소 (1024px 이하) */
@media (max-width: 1024px) and (min-width: 901px) {
  body {
    transform: scale(0.75);
    transform-origin: top center;
    min-height: 100vh;
  }

  header {
    padding: 10px 18px 8px;
  }

  .brand-title {
    font-size: 20px;
  }

  .brand-sub {
    font-size: 11px;
  }

  .layout {
    grid-template-columns: 200px 190px 200px 1fr;
  }

  .col-title {
    font-size: 12px;
    padding: 10px 12px 5px;
  }

  .series-item,
  .domain-item,
  .subject-item,
  .unit-item {
    font-size: 14px;
    padding: 12px 16px;
  }
}

/* 고래섬 이야기 팝업 모달 */
.whale-story-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.whale-story-modal.show {
  display: flex;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.whale-story-modal-content {
  background: transparent;
  border-radius: 30px;
  padding: 50px;
  max-width: 800px;
  width: 90%;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
  animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
  overflow: hidden;
}

/* Carousel wrapper */
.story-carousel-wrapper {
  position: relative;
  overflow: hidden;
  width: 100%;
}

.story-carousel-container {
  display: flex;
  transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.story-slide {
  min-width: 100%;
  width: 100%;
  flex-shrink: 0;
  border-radius: 30px;
  padding: 50px;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  position: relative;
}

/* Whale story background image */
.story-slide.whale-story {
  background-image: url(https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/whale-story/main.jpg);
}

/* Semi-transparent overlay for readability */
.story-slide::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 30px;
  z-index: 0;
}

.story-slide > * {
  position: relative;
  z-index: 1;
}

/* Carousel navigation arrows */
.carousel-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.9);
  border: 3px solid rgba(255, 255, 255, 1);
  width: 60px;
  height: 60px;
  border-radius: 50%;
  font-size: 36px;
  font-weight: bold;
  color: #333;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.carousel-nav:hover {
  background: white;
  transform: translateY(-50%) scale(1.15);
  box-shadow: 0 6px 30px rgba(0, 0, 0, 0.4);
}

.carousel-nav.prev {
  left: 10px;
}

.carousel-nav.next {
  right: 10px;
}

.carousel-nav:disabled {
  opacity: 0;
  cursor: default;
  pointer-events: none;
}

/* Jungle story background image */
.story-slide.jungle-story {
  background-image: url(https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/jungle-story/jungle_s1_main.jpg);
}

.story-slide.library-story {
  background-image: url(https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/library-story/library_part1_main.jpg);
}

/* Time Library story background image */
.story-slide.time-library-story {
  background-image: url(https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/time-library-story/time_part1_main.jpg);
}

/* Cat Island story background image */
.story-slide.cat-island-story {
  background-image: url(https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/cat-island-story/cat_part1_main.jpg);
}

/* Cat Transform story background image */
.story-slide.cat-transform-story {
  background-image: url(https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/cat-transform-story/transform_part1-main.jpg);
}

.story-slide.sonagi-story {
  background-image: url('/rain/rain_01.jpg');
}

.story-slide.goodday-story {
  background-image: url('/good/good1_01.jpg');
}

.story-slide.dongbaek-story {
  background-image: url('/flower/flower01.jpg');
}

.story-slide.samdae-story {
  background-image: url('/three/three01.jpg');
}

.story-slide.chunhyang-story {
  background-image: url('/girl/girl01.jpg');
}

@keyframes scaleIn {
  0% {
    transform: scale(0.5) rotate(-5deg);
    opacity: 0;
  }
  50% {
    transform: scale(1.05) rotate(2deg);
  }
  100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

.whale-story-modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.whale-story-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.whale-story-header {
  text-align: center;
  margin-bottom: 40px;
}

.whale-story-header h2 {
  font-size: 42px;
  color: white;
  margin-bottom: 10px;
  text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

.whale-story-header p {
  font-size: 18px;
  color: rgba(255, 255, 255, 0.9);
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.whale-story-seasons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-top: 30px;
}

/* 독서 감상문 제출 버튼 */
.book-report-btn-container {
  display: flex;
  justify-content: center;
  margin-top: 25px;
}

.book-report-btn {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.4);
  border-radius: 50px;
  padding: 14px 35px;
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 8px;
}

.book-report-btn:hover {
  background: rgba(255, 255, 255, 0.4);
  transform: translateY(-3px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
  border-color: rgba(255, 255, 255, 0.6);
}

.book-report-btn:active {
  transform: translateY(-1px);
}

.season-card {
  background: transparent;
  border-radius: 20px;
  padding: 30px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 3px solid transparent;
  position: relative;
  overflow: hidden;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

/* Remove card backgrounds - using slide background instead */
.season-card {
  background: transparent !important;
  background-image: none !important;
}

.season-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transform: rotate(45deg);
  transition: all 0.6s ease;
  z-index: 1;
}

.season-card:hover::before {
  left: 100%;
}

.season-card:hover {
  transform: translateY(-10px) scale(1.05);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  border-color: #ffd700;
}

.season-card.locked {
  opacity: 0.6;
  cursor: not-allowed;
  filter: grayscale(0.5);
}

.season-card.locked:hover {
  transform: none;
  box-shadow: none;
  border-color: transparent;
}

/* 단독 시즌 카드 스타일 */
.single-season-container {
  display: flex !important;
  justify-content: center !important;
}

.season-card.single-season {
  min-width: 200px;
  padding: 40px 30px;
}

.season-number {
  font-size: 48px;
  margin-bottom: 15px;
  animation: float 3s ease-in-out infinite;
  position: relative;
  z-index: 2;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

.season-card:nth-child(2) .season-number {
  animation-delay: 0.3s;
}

.season-card:nth-child(3) .season-number {
  animation-delay: 0.6s;
}

.season-title {
  font-size: 20px;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
}

.season-subtitle {
  font-size: 14px;
  color: #ffffff;
  font-weight: 600;
  margin-bottom: 15px;
  position: relative;
  z-index: 2;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
}

/* Jungle story subtitle color */
.jungle-story .season-subtitle {
  color: #ffffff;
}

.season-desc {
  font-size: 13px;
  color: #ffffff;
  line-height: 1.6;
  position: relative;
  z-index: 2;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
}

.season-lock-icon {
  font-size: 32px;
  margin-top: 10px;
  opacity: 0.5;
}

@media (max-width: 768px) {
  .whale-story-seasons {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  .whale-story-modal-content {
    padding: 30px 20px;
  }

  .whale-story-header h2 {
    font-size: 32px;
  }

  .carousel-nav {
    width: 50px;
    height: 50px;
    font-size: 30px;
  }

  .carousel-nav.prev {
    left: 5px;
  }

  .carousel-nav.next {
    right: 5px;
  }
}

/* 스토리 콘텐츠 팝업 모달 */
.story-content-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.story-content-modal.show {
  display: flex;
}

.story-content-modal-inner {
  width: 95%;
  height: 95%;
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
  animation: zoomIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
}

@keyframes zoomIn {
  0% {
    transform: scale(0.3);
    opacity: 0;
  }
  50% {
    transform: scale(1.03);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.story-content-close {
  position: fixed;
  top: 2.5%;
  right: 2.5%;
  background: rgba(255, 0, 0, 0.9);
  border: 3px solid white;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  font-size: 32px;
  font-weight: bold;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10001;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  pointer-events: auto;
}

.story-content-close:hover {
  background: rgba(255, 50, 50, 1);
  transform: rotate(90deg) scale(1.2);
  box-shadow: 0 6px 30px rgba(255, 0, 0, 0.6);
}

.story-content-iframe {
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 20px;
}

/* ========== 독서 감상문 팝업 스타일 ========== */
.reading-report-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10004;
}

.reading-report-modal.show {
  display: flex;
}

.reading-report-container {
  position: relative;
  width: 1000px;
  max-width: 90%;
  height: 700px;
  max-height: 90%;
  background: #fff;
  border-radius: 20px;
  display: flex;
  overflow: hidden;
  box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
}

.reading-report-close {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  background: rgba(255, 50, 50, 0.8);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  z-index: 10;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.reading-report-close:hover {
  background: rgba(255, 50, 50, 1);
  transform: rotate(90deg) scale(1.2);
}

/* 왼쪽 히스토리 사이드바 */
.reading-history-sidebar {
  width: 33.33%;
  background: #f8f9fa;
  border-right: 2px solid #e9ecef;
  overflow-y: auto;
  padding: 20px;
}

.history-header {
  font-size: 18px;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.history-item {
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.history-item:hover {
  border-color: #667eea;
  box-shadow: 0 2px 10px rgba(102, 126, 234, 0.2);
}

.history-item-title {
  font-size: 14px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.history-item-date {
  font-size: 12px;
  color: #6b7280;
}

.history-item-month {
  font-size: 11px;
  color: #9ca3af;
  margin-top: 4px;
}

.history-item-story {
  font-size: 11px;
  color: #667eea;
  font-weight: 600;
  margin-top: 6px;
  padding: 4px 8px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 6px;
  display: inline-block;
}

.history-load-more {
  width: 100%;
  padding: 12px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 12px;
  transition: all 0.3s ease;
}

.history-load-more:hover {
  background: #5568d3;
}

/* 오른쪽 메인 작성 영역 */
.reading-report-main {
  flex: 1;
  padding: 40px;
  overflow-y: auto;
  position: relative;
  background-image: url('https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/rudolph.png');
  background-position: center center;
  background-repeat: no-repeat;
  background-size: 400px;
  background-attachment: local;
}

.reading-report-main::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.92);
  pointer-events: none;
  z-index: 0;
}

.reading-report-main > * {
  position: relative;
  z-index: 1;
}

.report-form-header {
  text-align: center;
  margin-bottom: 30px;
}

.report-form-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 10px;
}

.report-form-header p {
  font-size: 14px;
  color: #6b7280;
}

.report-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.form-row {
  display: flex;
  gap: 15px;
}

.form-group {
  flex: 1;
}

.form-group label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 8px;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e9ecef;
  border-radius: 10px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.3s ease;
}

.form-group select {
  cursor: pointer;
  background-color: white;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 20px;
  padding-right: 40px;
  appearance: none;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input:disabled {
  background: #f8f9fa;
  color: #6b7280;
  cursor: not-allowed;
}

.form-group textarea {
  min-height: 250px;
  resize: vertical;
  line-height: 1.6;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 10px;
}

.btn-submit {
  padding: 14px 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
}

.btn-submit:active {
  transform: translateY(0);
}

.btn-kakao {
  padding: 14px 30px;
  background: linear-gradient(135deg, #FEE500 0%, #FFCD00 100%);
  color: #3C1E1E;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 205, 0, 0.3);
}

.btn-kakao:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 205, 0, 0.5);
  background: linear-gradient(135deg, #FFED4E 0%, #FFD700 100%);
}

.btn-kakao:active {
  transform: translateY(0);
}

.btn-new {
  padding: 14px 30px;
  background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-new:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
  background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
}

.btn-new:active {
  transform: translateY(0);
}

.auto-save-indicator {
  text-align: center;
  font-size: 12px;
  color: #10b981;
  margin-top: 10px;
}

/* 맞춤법 검사 결과 모달 */
.spell-check-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10005;
  align-items: center;
  justify-content: center;
}

.spell-check-modal.show {
  display: flex;
}

.spell-check-modal-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 700px;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
}

.spell-check-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px;
  border-bottom: 2px solid #e9ecef;
}

.spell-check-header h3 {
  margin: 0;
  font-size: 24px;
  color: #2c3e50;
}

.spell-check-close {
  background: none;
  border: none;
  font-size: 32px;
  color: #6b7280;
  cursor: pointer;
  transition: color 0.3s;
}

.spell-check-close:hover {
  color: #ef4444;
}

.spell-check-body {
  padding: 30px;
  overflow-y: auto;
  flex: 1;
}

.error-section {
  background: #fef2f2;
  border: 2px solid #fecaca;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.error-section h4 {
  color: #dc2626;
  margin: 0 0 15px 0;
  font-size: 18px;
}

.error-item {
  margin-bottom: 12px;
  font-size: 15px;
  line-height: 1.6;
}

.error-item .wrong-text {
  color: #dc2626;
  text-decoration: underline wavy #dc2626;
  font-weight: 600;
}

.correct-section {
  background: #f0fdf4;
  border: 2px solid #bbf7d0;
  border-radius: 12px;
  padding: 20px;
}

.correct-section h4 {
  color: #16a34a;
  margin: 0 0 15px 0;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.correct-text {
  font-size: 15px;
  line-height: 1.8;
  color: #2c3e50;
  white-space: pre-wrap;
}

.correct-text .highlight-correct {
  background: #bbf7d0;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #16a34a;
}

.spell-check-footer {
  display: flex;
  gap: 15px;
  padding: 20px 30px;
  border-top: 2px solid #e9ecef;
  justify-content: center;
}

.btn-recheck {
  padding: 14px 30px;
  background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-recheck:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
}

.btn-submit-final {
  padding: 14px 30px;
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

.btn-submit-final:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
}

.no-error-message {
  text-align: center;
  padding: 40px 20px;
  color: #16a34a;
  font-size: 18px;
}

/* 맞춤법 검사 로딩 */
.spell-check-loading {
  margin-top: 20px;
  text-align: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  margin: 0 auto 10px;
  border: 4px solid #f3f4f6;
  border-top: 4px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.spell-check-loading p {
  color: #6b7280;
  font-size: 14px;
  margin: 0;
}

/* 맞춤법 검사 인라인 표시 (박스 없이) */
.spell-check-inline {
  margin-top: 20px;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 폭죽 효과가 모든 요소 위에 표시되도록 z-index 설정 */
canvas[id^="confetti-canvas"] {
  z-index: 99999 !important;
  pointer-events: none;
}

    /* 🎆 폭죽 애니메이션 */
    .fireworks-container {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 80px;
      height: 80px;
      pointer-events: none;
      z-index: 9999;
    }

    .firework {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: firework-animation 2s ease-out infinite;
    }

    .firework:nth-child(1) {
      background: linear-gradient(45deg, #ff6b6b, #feca57);
      animation-delay: 0s;
      left: 40%;
      top: 40%;
    }

    .firework:nth-child(2) {
      background: linear-gradient(45deg, #5f27cd, #00d2d3);
      animation-delay: 0.5s;
      left: 60%;
      top: 30%;
    }

    .firework:nth-child(3) {
      background: linear-gradient(45deg, #ff9ff3, #feca57);
      animation-delay: 1s;
      left: 30%;
      top: 50%;
    }

    .firework:nth-child(4) {
      background: linear-gradient(45deg, #48dbfb, #0abde3);
      animation-delay: 1.5s;
      left: 50%;
      top: 35%;
    }

    @keyframes firework-animation {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      25% {
        transform: translate(var(--tx), var(--ty)) scale(1.5);
        opacity: 0.8;
      }
      50% {
        transform: translate(calc(var(--tx) * 1.5), calc(var(--ty) * 1.5)) scale(2);
        opacity: 0.6;
        box-shadow: 0 0 20px currentColor;
      }
      75% {
        transform: translate(calc(var(--tx) * 2), calc(var(--ty) * 2)) scale(1.2);
        opacity: 0.3;
      }
      100% {
        transform: translate(calc(var(--tx) * 2.5), calc(var(--ty) * 2.5)) scale(0);
        opacity: 0;
      }
    }

    /* 각 폭죽마다 다른 방향으로 터지도록 */
    .firework:nth-child(1) { --tx: -15px; --ty: -20px; }
    .firework:nth-child(2) { --tx: 18px; --ty: -15px; }
    .firework:nth-child(3) { --tx: -20px; --ty: 10px; }
    .firework:nth-child(4) { --tx: 15px; --ty: 12px; }

    /* 반짝이는 별 효과 추가 */
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #ffd700;
      border-radius: 50%;
      animation: sparkle-animation 1.5s ease-in-out infinite;
    }

    .sparkle:nth-child(5) {
      left: 20%;
      top: 20%;
      animation-delay: 0.2s;
    }

    .sparkle:nth-child(6) {
      left: 70%;
      top: 60%;
      animation-delay: 0.8s;
    }

    @keyframes sparkle-animation {
      0%, 100% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.5);
        opacity: 1;
        box-shadow: 0 0 10px #ffd700;
      }
    }

  </style>

  <!-- html2canvas and jsPDF for PDF generation with Korean support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- JS Confetti for celebration effects -->
  <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

  <!-- 브레인딥 콘텐츠 로드 -->
  <script src="./BRAINUP/science/deep_bio_content.js"></script>
  <script src="./BRAINUP/science/deep_earth_content.js"></script>
  <script src="./BRAINUP/science/deep_chem_content.js"></script>
  <script src="./BRAINUP/science/deep_physics_content.js"></script>
</head>
<body>
  <!-- 📱 아이패드용 고정 배경 레이어 -->
  <div id="tablet-fixed-bg"></div>

  <!-- 🔄 로딩 오버레이 -->
  <div id="loading-overlay">
    <div class="spinner-container">
      <div class="spinner"></div>
      <div class="loading-text">AI 학습 인식 중...</div>
    </div>
  </div>

  <!-- 🔥 MP4 메뉴 배경 영상 -->
  <video class="menu-bg-video" autoplay muted loop playsinline>
    <source src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/brain-menu-bg-a.mp4" type="video/mp4" />
  </video>

  <!-- 🎆 폭죽 애니메이션 -->
  <div class="fireworks-container">
    <div class="firework"></div>
    <div class="firework"></div>
    <div class="firework"></div>
    <div class="firework"></div>
    <div class="sparkle"></div>
    <div class="sparkle"></div>
  </div>

  <header id="menuHeader">
    <div>
      <div class="brand-title">단단국어 BRAIN 문해력 시리즈</div>

      <div class="brand-sub-wrap">
        <div class="brand-sub">
          BRAIN온 → BRAIN업 → BRAIN핏 → BRAIN딥 → BRAIN중등 → BRAIN고등 → 분야 → 세부 과목 → 단원
        </div>

        <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/rudolph.png" class="brand-rudolph" alt="루돌프" onclick="goToWhaleStory()" style="cursor: pointer;" title="푸른 고래섬 이야기 시작하기">
      </div>
    </div>

    <!-- 🔹 오른쪽: 사용자 정보 + 로그아웃 버튼 -->
    <div class="header-right">
      <div id="user-info">성인 안유빈님 환영합니다!</div>
      <button id="logoutBtn" class="logout-btn" type="button">로그아웃</button>
    </div>
  </header>

  <div class="layout">
    <!-- ① 시리즈 -->
    <div class="col" id="colSeries">
      <div class="col-title">① 시리즈 선택</div>
      <ul class="series-list" id="seriesList">
        <li class="series-item" data-series="BRAINON"><span>💡 BRAIN온</span><span class="meta">개념이해</span></li>
        <li class="series-item active" data-series="BRAINUP"><span>🚀 BRAIN업</span><span class="meta">응용적용</span></li>
        <li class="series-item" data-series="BRAINFIT"><span>🔗 BRAIN핏</span><span class="meta">논리연결</span></li>
        <li class="series-item" data-series="BRAINDEEP"><span>🔎 BRAIN딥</span><span class="meta">심화추론</span></li>
        <li class="series-item" data-series="BRAINM"><span>📘 BRAIN중등</span><span class="meta">중등교과</span></li>
        <li class="series-item" data-series="BRAINH"><span>📕 BRAIN고등</span><span class="meta">고등교과</span></li>
      </ul>
    </div>

    <!-- ② 분야 -->
    <div class="col" id="colDomain">
      <div class="col-title">② 분야 선택</div>
      <ul class="domain-list" id="domainList"></ul>
    </div>

    <!-- ③ 세부 과목 -->
    <div class="col" id="colSubject">
      <div class="col-title">③ 세부 과목</div>
      <ul class="subject-list" id="subjectList"></ul>
    </div>

    <!-- ④ 단원 + 검색 -->
    <div class="detail-panel" id="detailPanel">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
        <div>
          <div class="detail-title" id="unitTitle">단원 선택</div>
          <div class="detail-desc" id="unitDesc">[본문학습] → [어휘학습] → [창의활동]을 완료 후 제출해주세요!</div>
        </div>
        <input
          type="text"
          id="unitSearch"
          placeholder="단원 검색"
          style="padding:5px 8px; border:1px solid #e2d5c3; border-radius:6px; font-size:12px; min-width:140px; background:#ffffff;">
      </div>
      <ul class="unit-list" id="unitList"></ul>
    </div>
  </div>

  <!-- 준비중 모달 -->
  <div class="overlay" id="pendingModal">
    <div class="modal-box">
      <div class="modal-emoji">📚✨</div>
      <div class="modal-title">아직 준비 중입니다.</div>
      <div class="modal-msg">곧 지문이 오픈됩니다. 기대해주세요!</div>
      <button class="modal-btn" id="closeModalBtn">확인</button>
    </div>
  </div>

  <!-- ⚠️ 모달 관련 함수와 이벤트 리스너는 메인 스크립트 블록에서 처리됩니다 (라인 3250+ 참고) -->

  <!-- 🔥 세션 정보를 sessionStorage에 저장 -->
  <script>
    (async function() {
      try {
        const response = await fetch('/api/session');
        const data = await response.json();

        if (data.ok && data.user) {
          // 서버 세션 정보를 sessionStorage에 저장
          sessionStorage.setItem('user', JSON.stringify(data.user));
          console.log('✅ Session data saved to sessionStorage:', data.user);

          // ✅ 현재 학생이 아닌 localStorage 데이터 삭제 (이전 학생 어휘퀴즈 뱃지 등)
          const currentStudent = JSON.parse(localStorage.getItem('currentStudent') || '{}');
          const currentGrade = currentStudent.grade || data.user.grade;
          const currentName = currentStudent.name || data.user.name;

          // localStorage의 모든 키를 확인하여 다른 학생 데이터 삭제
          const keysToRemove = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            // vocabAvgScore_, studyRoomBadge_ 등 학생별 데이터 키 패턴
            if (key && (key.startsWith('vocabAvgScore_') || key.startsWith('studyRoomBadge_') || key.startsWith('학생_'))) {
              // 현재 학생의 키가 아니면 삭제 대상
              if (!key.includes(`${currentGrade}_${currentName}`)) {
                keysToRemove.push(key);
              }
            }
          }

          // 삭제 실행
          keysToRemove.forEach(key => {
            console.log('🗑️ 이전 학생 데이터 삭제:', key);
            localStorage.removeItem(key);
          });

          // ✅ 세션 저장 완료 플래그 설정 + 서버에서 어휘지수 불러와서 뱃지 업데이트
          window.sessionReady = true;

          // 서버에서 어휘퀴즈 데이터 불러와서 뱃지 업데이트
          const updateVocabBadgeFromServer = async () => {
            try {
              const res = await fetch(`/api/user-progress?grade=${encodeURIComponent(data.user.grade)}&name=${encodeURIComponent(data.user.name)}`);
              const result = await res.json();

              if (result.ok && result.data?.vocabularyQuiz) {
                const vq = result.data.vocabularyQuiz;
                // 어휘력 지수 계산: (총점 / 100) * (평균점수 / 10)
                const rating = (vq.totalScore / 100) * (vq.avgScore / 10);
                const ratingStr = rating.toFixed(1);

                // localStorage에도 저장 (다른 곳에서 사용)
                const ratingKey = `vocabRatingScore_${data.user.grade}_${data.user.name}`;
                localStorage.setItem(ratingKey, ratingStr);

                // 뱃지 업데이트
                const badge = document.getElementById('vocabAvgBadge');
                if (badge) {
                  badge.textContent = ratingStr;
                  console.log('✅ 어휘지수 뱃지 업데이트 (서버):', ratingStr);
                }
              }
            } catch (e) {
              console.error('어휘지수 로드 오류:', e);
            }
          };

          if (document.readyState === 'complete' || document.readyState === 'interactive') {
            updateVocabBadgeFromServer();
          } else {
            document.addEventListener('DOMContentLoaded', updateVocabBadgeFromServer);
          }

        } else {
          console.log('❌ No session data available');
        }
      } catch (error) {
        console.error('❌ Error fetching session:', error);
      }
    })();
  </script>

  <!-- 🚀 API 캐싱 레이어 (중복 호출 방지 & 병렬 로딩 최적화) -->
  <script>
    window.ApiCache = (function() {
      const cache = {};
      const pending = {};
      const CACHE_TTL = 30000; // 30초 캐시

      return {
        // 캐시된 데이터 가져오기 (없으면 fetch)
        async fetch(url, options = {}) {
          const cacheKey = url;
          const now = Date.now();

          // 캐시에 유효한 데이터가 있으면 반환
          if (cache[cacheKey] && (now - cache[cacheKey].time) < CACHE_TTL) {
            console.log('⚡ [Cache Hit]', cacheKey);
            return cache[cacheKey].data;
          }

          // 이미 동일한 요청이 진행 중이면 그 Promise 반환 (중복 호출 방지)
          if (pending[cacheKey]) {
            console.log('⏳ [Pending]', cacheKey);
            return pending[cacheKey];
          }

          // 새 요청 시작
          console.log('🌐 [Fetch]', cacheKey);
          pending[cacheKey] = fetch(url, options)
            .then(res => res.json())
            .then(data => {
              cache[cacheKey] = { data, time: Date.now() };
              delete pending[cacheKey];
              return data;
            })
            .catch(err => {
              delete pending[cacheKey];
              throw err;
            });

          return pending[cacheKey];
        },

        // 캐시 무효화
        invalidate(urlPattern) {
          Object.keys(cache).forEach(key => {
            if (key.includes(urlPattern)) {
              delete cache[key];
              console.log('🗑️ [Cache Invalidated]', key);
            }
          });
        },

        // 전체 캐시 클리어
        clear() {
          Object.keys(cache).forEach(key => delete cache[key]);
          console.log('🗑️ [Cache Cleared]');
        }
      };
    })();

    // 🚀 페이지 로드 시 필요한 API들을 병렬로 미리 로드
    window.preloadUserData = async function() {
      const saved = localStorage.getItem('currentStudent');
      if (!saved) return;

      try {
        const user = JSON.parse(saved);
        if (!user.grade || !user.name) return;

        const grade = encodeURIComponent(user.grade);
        const name = encodeURIComponent(user.name);

        console.log('🚀 [Preload] 사용자 데이터 병렬 로딩 시작...');
        const startTime = Date.now();

        // 모든 API를 병렬로 호출
        await Promise.all([
          ApiCache.fetch(`/api/gate-quiz/status?grade=${grade}&name=${name}`),
          ApiCache.fetch(`/api/unit-grades?grade=${grade}&name=${name}`),
          ApiCache.fetch(`/api/ai-task/last-assigned?grade=${grade}&name=${name}`),
          ApiCache.fetch(`/api/user-progress/study-room?grade=${grade}&name=${name}`),
          ApiCache.fetch(`/api/completion-status?grade=${grade}&name=${name}&series=BRAIN업`)
        ]);

        console.log('✅ [Preload] 완료! 소요시간:', Date.now() - startTime, 'ms');
      } catch (err) {
        console.error('❌ [Preload] 실패:', err);
      }
    };

    // 페이지 로드 즉시 preload 시작
    window.preloadUserData();
  </script>

  <!-- 로그아웃 확인 모달 -->
  <div class="overlay" id="logoutConfirm">
    <div class="modal-box">
      <div class="modal-emoji">🚪</div>
      <div class="modal-title">로그아웃 하시겠어요?</div>
      <div class="modal-msg">
        로그아웃하면 이 학습 메뉴를 다시 보려면<br>
        다시 로그인해야 해요.
      </div>
      <div style="display:flex; gap:8px; justify-content:center;">
        <button type="button" class="modal-btn" id="logoutCancelBtn">취소</button>
        <button type="button" class="modal-btn modal-btn-danger" id="logoutOkBtn">로그아웃</button>
      </div>
    </div>
  </div>

    <!-- 🚪 로그아웃 확인 모달 -->
  <div class="overlay" id="logoutModal">
    <div class="modal-box">
      <div style="font-size:32px; margin-bottom:8px;">🚪</div>
      <div class="modal-title">로그아웃 하시겠어요?</div>
      <div class="modal-msg">
        로그아웃하면 이 학습 메뉴를 다시 보려면<br>
        다시 로그인해야 해요.
      </div>
      <div style="display:flex; justify-content:center; gap:10px; margin-top:8px;">
        <button
          type="button"
          class="modal-btn"
          id="logoutCancelBtn"
          style="background:#b9a090;"
        >
          취소
        </button>
        <button
          type="button"
          class="modal-btn"
          id="logoutConfirmBtn"
        >
          로그아웃
        </button>
      </div>
    </div>
  </div>



  <!-- 🔋 로딩 오버레이 -->
  <div class="overlay-loading" id="loadingOverlay">
    <div class="loading-box">
      <div class="loading-emoji">🐋</div>
      <div class="loading-title">로딩 중...</div>
      <div class="loading-msg">학습 자료를 준비하고 있어요.</div>
      <div class="loading-progress">
        <div class="loading-bar" id="loadingBar"></div>
      </div>
      <div class="loading-percent" id="loadingPercent">0%</div>
    </div>
  </div>

  <!-- 카카오 SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
  <script>
    // 카카오 SDK 초기화 (SDK 로드 직후 바로 실행)
    if (!Kakao.isInitialized()) {
      Kakao.init('6ad10cc6680c7a5829a4fd7a3cbb4a7e');
      console.log('✅ Kakao SDK 초기화 완료:', Kakao.isInitialized());
    }
  </script>

  <script>

    /* 🔒 관문 시스템 전역 변수 및 함수 */
    let passedGates = 0;  // 통과한 관문 수 (페이지 로드 시 API에서 가져옴)
    let completedUnitsCount = 0;  // 완료한 단원 수
    let completedUnitIds = [];  // 완료한 단원 ID 목록

    // 단원 접근 가능 여부 확인 (완료 단원 수 기준)
    function canAccessUnit(unitId) {
      // 이미 완료한 단원은 항상 접근 가능 (복습)
      if (completedUnitIds.includes(unitId)) {
        console.log(`[canAccessUnit] ${unitId} - 이미 완료한 단원, 접근 허용`);
        return true;
      }

      // 완료 단원 수가 관문 기준에 도달했는지 확인
      // 10개 완료 + 관문 1 미통과 → 새 단원 잠금
      // 20개 완료 + 관문 2 미통과 → 새 단원 잠금
      const requiredGate = Math.floor(completedUnitsCount / 10);

      const canAccess = passedGates >= requiredGate;
      console.log(`[canAccessUnit] ${unitId} - 완료:${completedUnitsCount}, 통과관문:${passedGates}, 필요관문:${requiredGate}, 접근:${canAccess}`);

      // 필요한 관문을 모두 통과했으면 접근 가능
      return canAccess;
    }

    // 필요한 관문 번호 계산 (완료 단원 수 기준)
    function getRequiredGate() {
      // 완료 10개 → 관문 1 필요
      // 완료 20개 → 관문 2 필요
      return Math.floor(completedUnitsCount / 10);
    }

    // 잠금 모달 표시
    function showLockModal(requiredGate) {
      document.getElementById('lockGateLevel').textContent = requiredGate;
      document.getElementById('lockModal').classList.add('active');
    }

    // 잠금 모달 닫기
    function closeLockModal() {
      const modal = document.getElementById('lockModal');
      if (modal) modal.classList.remove('active');
    }

    // 잠금 모달에서 관문 시험으로 이동 (모달 형태)
    function goToGateFromLock() {
      const gateLevel = parseInt(document.getElementById('lockGateLevel').textContent);
      closeLockModal();
      // 약간의 딜레이 후 형성평가 모달 열기
      setTimeout(() => openGateQuizModal(gateLevel), 300);
    }

    /* 0. 시리즈 정보 */
    const seriesInfo = {
      BRAINON: { name: "BRAIN온", desc: "개념 이해" },
      BRAINUP: { name: "BRAIN업", desc: "응용 적용" },
      BRAINFIT: { name: "BRAIN핏", desc: "논리 연결" },
      BRAINDEEP: { name: "BRAIN딥", desc: "심화 추론" },
      BRAINM: { name: "BRAIN중등", desc: "중등 교과" },
      BRAINH: { name: "BRAIN고등", desc: "고등 교과" }
    };

    /* 1. 시리즈별 분야/과목 */
    const domainsBySeries = {
      BRAINON: [
        {
          id: "science",
          label: "과학분야",
          subs: [
            { id: "bio", label: "생물", count: 20 },
            { id: "earth", label: "지구과학", count: 20 },
            { id: "physics", label: "물리", count: 20 },
            { id: "chem", label: "화학", count: 20 }
          ]
        },
        {
          id: "social",
          label: "사회분야",
          subs: [
            { id: "soc", label: "사회문화", count: 20 },
            { id: "geo", label: "지리", count: 20 },
            { id: "law", label: "법", count: 20 },
            { id: "pol", label: "정치경제", count: 20 }
          ]
        },
        {
          id: "korlit",
          label: "한국문학분야",
          subs: [
            { id: "modern", label: "현대문학", count: 40 },
            { id: "classic", label: "고전문학", count: 40 }
          ]
        },
        {
          id: "worldlit",
          label: "세계문학분야",
          subs: [
            { id: "world1", label: "세계문학(1)", count: 40 },
            { id: "world2", label: "세계문학(2)", count: 40 }
          ]
        },
        {
          id: "person",
          label: "인물분야",
          subs: [
            { id: "people1", label: "한국인물", count: 40 },
            { id: "people2", label: "세계인물", count: 40 }
          ]
        }
      ],
      // 나머지는 세종 구조 재사용
      BRAINUP: null,
      BRAINFIT: null,
      BRAINDEEP: null,
      // 성균관
      BRAINM: [
        {
          id: "nonfiction",
          label: "비문학분야",
          subs: [
            { id: "naesin", label: "내신교과", count: 20 },
            { id: "suneung", label: "수능모고", count: 20 }
          ]
        },
        {
          id: "modernlit",
          label: "현대문학분야",
          subs: [
            { id: "poem", label: "현대시", count: 20 },
            { id: "novel", label: "현대소설", count: 20 },
            { id: "etc", label: "극·수필·희곡", count: 20 }
          ]
        },
        {
          id: "classiclit",
          label: "고전문학분야",
          subs: [
            { id: "gosi", label: "고전시가", count: 20 },
            { id: "gonovel", label: "고전소설", count: 20 },
            { id: "goessay", label: "고전수필", count: 20 }
          ]
        },
        {
          id: "grammar",
          label: "문법분야",
          subs: [
            { id: "modern", label: "현대", count: 12 },
            { id: "middle", label: "중세", count: 12 }
          ]
        }
      ],
      // 국자감
      BRAINH: [
        {
          id: "nonfiction",
          label: "비문학분야",
          subs: [
            { id: "naesin", label: "내신교과", count: 24 },
            { id: "suneung", label: "수능모고", count: 24 }
          ]
        },
        {
          id: "modernlit",
          label: "현대문학분야",
          subs: [
            { id: "poem", label: "현대시", count: 20 },
            { id: "novel", label: "현대소설", count: 20 },
            { id: "etc", label: "극·수필·희곡", count: 15 }
          ]
        },
        {
          id: "classiclit",
          label: "고전문학분야",
          subs: [
            { id: "gosi", label: "고전시가", count: 20 },
            { id: "gonovel", label: "고전소설", count: 20 },
            { id: "goessay", label: "고전수필", count: 15 }
          ]
        },
        {
          id: "grammar",
          label: "문법분야",
          subs: [
            { id: "modern", label: "현대", count: 12 },
            { id: "middle", label: "중세", count: 12 }
          ]
        }
      ]
    };

    /* 1.5 과목별 배경 이미지 매핑 (PC용) */
    const subjectBackgrounds = {
      'bio': './images/생물.mp4',  // 비디오로 변경
      'earth': './images/지구과학.mp4',  // 비디오로 변경
      'physics': './images/물리.mp4',  // 비디오로 변경
      'chem': './images/화학.mp4',  // 비디오로 변경
      'soc': './images/사회문화.mp4',  // 비디오로 변경
      'geo': './images/지리.mp4',  // 비디오로 변경
      'law': './images/법배경.jpg',
      'pol': './images/정치경제배경.jpg',
      'modern': './images/현대문학배경.jpg',
      'classic': './images/고전문학배경.jpg',
      'world': './images/세계문학1배경.jpg',
      'world1': './images/세계문학1배경.jpg',
      'world2': './images/세계문학2배경.jpg',
      'people': './images/인물1배경.jpg',
      'people1': './images/인물1배경.jpg',
      'people2': './images/인물2배경.jpg'
    };

    /* 과목별 배경 비디오 매핑 (태블릿용) */
    const subjectBackgroundVideos = {
      'bio': './images/생물.mp4',
      'earth': './images/지구과학.mp4',
      'physics': './images/물리.mp4',
      'chem': './images/화학.mp4',
      'soc': './images/사회문화.mp4',
      'geo': './images/지리.mp4'
    };

    /* 과목별 배경 이미지 매핑 (태블릿용) */
    const subjectBackgroundsTablet = {
      'bio': './images/생물.mp4',  // 비디오로 변경
      'earth': './images/지구과학.mp4',  // 비디오로 변경
      'physics': './images/물리.mp4',  // 비디오로 변경
      'chem': './images/화학.mp4',  // 비디오로 변경
      'soc': './images/사회문화.mp4',  // 비디오로 변경
      'geo': './images/지리.mp4',  // 비디오로 변경
      'law': './images/법배경_tablet.jpg',
      'pol': './images/정치경제배경_tablet.jpg',
      'modern': './images/현대문학배경_tablet.jpg',
      'classic': './images/고전문학배경_tablet.jpg',
      'world': './images/세계문학1배경_tablet.jpg',
      'world1': './images/세계문학1배경_tablet.jpg',
      'world2': './images/세계문학2배경_tablet.jpg',
      'people': './images/인물1배경_tablet.jpg',
      'people1': './images/인물1배경_tablet.jpg',
      'people2': './images/인물2배경_tablet.jpg'
    };

    /* 배경 이미지 변경 함수 */
    function changeBackgroundImage(subjectObj) {
      console.log('🎨 배경 변경 요청:', subjectObj);

      // 태블릿(아이패드) 감지
      const isTablet = window.innerWidth >= 769 && window.innerWidth <= 1400;

      // offset이 있으면 (2)번 이미지 사용
      let subjectId = subjectObj.id;
      if (subjectObj.offset && subjectObj.offset > 0) {
        // world + offset → world2, people + offset → people2
        if (subjectId === 'world') {
          subjectId = 'world2';
        } else if (subjectId === 'people') {
          subjectId = 'people2';
        }
      }

      // PC와 태블릿에 따라 다른 이미지 사용
      let imageUrl;
      if (isTablet) {
        imageUrl = subjectBackgroundsTablet[subjectId];
        // world2, people2 태블릿 매핑
        if (!imageUrl) {
          if (subjectId === 'world2') {
            imageUrl = './images/세계문학2배경_tablet.jpg';
          } else if (subjectId === 'people2') {
            imageUrl = './images/인물2배경_tablet.jpg';
          }
        }
      } else {
        imageUrl = subjectBackgrounds[subjectId];
        // world2, people2 PC 매핑
        if (!imageUrl) {
          if (subjectId === 'world2') {
            imageUrl = './images/세계문학2배경.jpg';
          } else if (subjectId === 'people2') {
            imageUrl = './images/인물2배경.jpg';
          }
        }
      }

      console.log('🖼️ 이미지/비디오 URL:', imageUrl);
      if (imageUrl) {
        // 비디오인지 이미지인지 확인
        const isVideo = imageUrl.endsWith('.mp4') || imageUrl.endsWith('.webm');

        if (isVideo) {
          // 비디오 배경 처리
          console.log('🎬 비디오 배경 적용:', imageUrl);

          // 기존 subject-bg-video가 있으면 제거
          let existingSubjectVideo = document.getElementById('subject-bg-video');
          if (existingSubjectVideo) {
            existingSubjectVideo.remove();
          }

          // 새 비디오 요소 생성
          const video = document.createElement('video');
          video.id = 'subject-bg-video';
          video.autoplay = true;
          video.loop = true;
          video.muted = true;
          video.playsInline = true;
          video.setAttribute('webkit-playsinline', 'true');  // iOS Safari 지원
          video.setAttribute('playsinline', 'true');  // iOS Safari 지원
          video.src = imageUrl;

          console.log('📱 isTablet:', isTablet, 'width:', window.innerWidth);

          if (isTablet) {
            // 아이패드: tablet-fixed-bg 안에 비디오 삽입
            const tabletBg = document.getElementById('tablet-fixed-bg');
            console.log('📱 tabletBg 찾음:', tabletBg);
            if (tabletBg) {
              // 아이패드에서 로딩 스피너 표시
              const loadingOverlay = document.getElementById('loading-overlay');
              if (loadingOverlay) {
                loadingOverlay.classList.remove('fade-out');
                loadingOverlay.style.display = 'flex';
              }

              tabletBg.style.backgroundImage = 'none';
              tabletBg.innerHTML = '';  // 기존 비디오 제거

              video.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                z-index: 1;
              `;

              // 비디오가 재생 시작하면 로딩 스피너 숨기기
              video.oncanplay = function() {
                if (loadingOverlay) {
                  loadingOverlay.classList.add('fade-out');
                  setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                  }, 500);
                }
              };

              tabletBg.appendChild(video);
              console.log('📱 비디오를 tabletBg에 추가함');

              // iOS Safari에서 비디오 로드 강제
              video.load();
            }
          } else {
            // PC: body에 비디오 삽입
            video.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              object-fit: cover;
              z-index: 0;
              pointer-events: none;
            `;
            document.body.style.background = 'transparent';
            document.body.style.backgroundImage = 'none';
            document.body.insertBefore(video, document.body.firstChild);
          }

          // iOS에서 자동재생 시도
          video.play().catch(function(error) {
            console.log('비디오 자동재생 실패:', error);
          });

          // 기존 메뉴 배경 동영상 숨기기
          const bgVideo = document.querySelector('.menu-bg-video');
          if (bgVideo) {
            bgVideo.style.display = 'none';
          }

          console.log('✅ 비디오 배경 변경 완료');
        } else {
          // 이미지 배경 처리 (기존 로직)
          // 기존 subject-bg-video가 있으면 제거
          let existingSubjectVideo = document.getElementById('subject-bg-video');
          if (existingSubjectVideo) {
            existingSubjectVideo.remove();
          }

          const img = new Image();
          img.onload = function() {
            // 태블릿에서는 고정 배경 div에 이미지 설정
            if (isTablet) {
              const tabletBg = document.getElementById('tablet-fixed-bg');
              if (tabletBg) {
                tabletBg.style.backgroundImage = `url('${imageUrl}')`;
              }
              // body 배경은 투명하게 (CSS에서 처리)
            } else {
              // PC에서는 body에 배경 설정
              document.body.style.backgroundImage = `url('${imageUrl}')`;
              document.body.style.backgroundSize = '110%';
              document.body.style.backgroundPosition = 'center bottom';
              document.body.style.backgroundAttachment = 'fixed';
            }

            // 배경 동영상 숨기기
            const bgVideo = document.querySelector('.menu-bg-video');
            if (bgVideo) {
              bgVideo.style.display = 'none';
            }
            console.log('✅ 배경 변경 완료:', document.body.style.backgroundImage);

          };
          img.onerror = function() {
            console.warn('❌ 이미지 로드 실패:', imageUrl);
          };
          img.src = imageUrl;
        }
      } else {
        console.warn('❌ 해당 과목의 배경 이미지를 찾을 수 없습니다:', subjectId);
      }
    }

    // 글로벌 스코프에 함수와 객체 노출 (디버깅 및 외부 접근용)
    window.changeBackgroundImage = changeBackgroundImage;
    window.subjectBackgrounds = subjectBackgrounds;

    /* 2. 과목별 테마 */
    const titleThemes = {
      bio: [
        "🧬 생물과 무생물의 구분과 관계",
        "🦁 동물의 몸과 생활 방식은 왜 다를까?",
        "다양한 생물의 구조와 기능",
        "유전과 번식의 비밀",
        "환경과 생물의 상호작용",
        "적응과 진화의 과정",
        "생태계의 구성과 순환",
        "인간과 생태계의 조화",
        "질병과 면역의 이해",
        "생명공학의 기초 살펴보기"
      ],
      earth: [
        "🌍 지구는 어떻게 만들어졌을까?",
        "🌋 마그마가 들려주는 지구의 이야기",
        "지질 구조의 원리",
        "해양의 흐름과 생태",
        "기상 재해와 대비",
        "기후 변화의 이해",
        "별과 우주의 관찰",
        "지구 내부의 비밀",
        "자연자원의 형성과 이용",
        "지구 환경의 보전"
      ],
      physics: [
        "💪 힘, 세상을 움직이는 보이지 않는 손",
        "🌍 사과가 떨어진 이유, 중력의 발견",
        "🌙 달에서는 점프왕! 무게 vs 질량",
        "⚖️ 시소의 과학, 지렛대와 균형",
        "🚗 속력, 거리, 시간의 삼각관계",
        "⚡ 전자들의 대이동, 전류와 전압",
        "🔌 불이 켜지는 길, 전기 회로",
        "🧲 끌어당기고 밀어내는 자석의 힘",
        "⚡ 자석으로 전기를 만든다! 전자기 유도",
        "🌊 출렁이며 퍼져나가는 파동",
        "💡 거울 속 세상, 빛의 반사",
        "🔍 물속 다리가 꺾여 보이는 이유",
        "🔊 진동이 만들어낸 소리의 세계",
        "🌡️ 뜨거움의 정체, 열과 온도",
        "⚡ 에너지는 변할 뿐, 사라지지 않는다",
        "⚛️ 눈에 보이지 않는 작은 세계",
        "🎈 배가 뜨고 풍선이 날아오르는 원리",
        "🔌 감전을 피하라! 전기 안전 수칙",
        "🌟 밤하늘 별빛 속에 담긴 우주",
        "🚀 SF가 현실이 되는 미래 기술"
      ],
      chem: [
        "🧪 연필이 물질이라고? 물체와 물질 구별법",
        "🍬 사라진 설탕은 어디로 갔을까?",
        "💧 물과 기름이 절대 친해질 수 없는 이유",
        "🎈 풍선이 빵빵해지는 진짜 이유",
        "🧊 얼음 → 물 → 수증기, 물의 3단 변신",
        "⚗️ 우주의 레고 블록, 원소 118가지",
        "⚛️ 눈에 안 보이는 알갱이, 원자의 정체",
        "🔗 원자들이 손잡고 분자가 되는 순간",
        "⚖️ 태워도 녹여도 무게는 똑같다!",
        "🍋 레몬은 시큼, 비누는 미끈! 왜?",
        "🔥 산소가 범인! 녹과 불의 공통점",
        "⚡ 물에 전기를 넣으면 뿅! 기체가 나와",
        "🌡️ 설탕을 무한정 녹일 수 있을까?",
        "💨 주사기를 누르면 공기는 어디로?",
        "🔬 손난로가 뜨거워지는 화학의 비밀",
        "🧬 500년이 지나도 안 썩는 플라스틱",
        "⚙️ 철+탄소=강철! 금속 합체의 마법",
        "🌿 미세먼지와 산성비, 화학의 역습",
        "🧴 세제, 치약, 샴푸 속 화학 이야기",
        "🚀 그래핀부터 나노까지, 미래 소재 대탐험"
      ],
      soc: [
        "👨‍👩‍👧‍👦 우리 가족은 어떻게 이루어질까요?",
        "👨‍👩‍👧 시대에 따라 달라진 가족 이야기",
        "💕 배려로 완성되는 가족 관계",
        "🚂 시간을 단축한 발명들, 더 넓어진 생활권",
        "🏘️ 우리 동네 문제, 함께 해결해요",
        "🎮 게임 속 나 vs 현실의 나, 정체성 이야기",
        "📱 SNS가 바꾼 우리의 관계",
        "🤖 AI와 함께 사는 법, 인간다움이란?",
        "👥 인싸와 아싸, 집단 속 우리의 모습",
        "🍜 라면은 문화일까? 문화의 의미 탐구",
        "🎬 K-드라마는 왜 세계를 사로잡았을까?",
        "📰 가짜 뉴스를 구별하는 법",
        "🗳️ 18세 선거권, 우리의 목소리",
        "⚖️ 정의란 무엇인가? 공정한 사회를 향하여",
        "🌍 기후 위기와 미래 세대의 책임",
        "🌍 국제사회와 글로벌 시민",
        "🔬 과학기술이 바꾸는 일상",
        "🏥 복지란 무엇인가? 함께 사는 사회",
        "♻️ 지속가능한 삶, 환경과 경제의 균형",
        "🔮 미래 사회, 우리가 만들어갈 세상"
      ],
      geo: [
        "🗺️ 지도를 통해 세상을 이해하다",
        "📍 지도에 담긴 약속과 표현",
        "🏘️ 우리 고장의 상징과 유래",
        "🏙️ 우리 동네는 왜 불편할까? 지역 문제 살펴보기",
        "🌾 시대와 함께 발전하는 시골 마을",
        "🧭 지구에 주소가 있다고? 위도와 경도의 비밀",
        "🌍 지구의 얼굴, 대륙과 바다 이야기",
        "🇰🇷 우리나라는 어디에 있을까? 한반도의 위치",
        "🏔️ 백두산에서 한라산까지, 국토 여행",
        "☀️ 왜 제주도는 서울보다 따뜻할까?",
        "🏙️ 도시는 왜 커질까? 도시화의 빛과 그림자",
        "👨‍👩‍👧‍👦 인구 이동, 사람들은 왜 움직일까?",
        "🚄 세계는 하나로, 교통과 통신의 발달",
        "🗺️ 지도 속 보물찾기, 지리 정보 기술",
        "⛽ 자원은 어디에? 에너지와 자원의 분포",
        "⚡ 석유가 사라진다면? 에너지의 미래",
        "🐟 바다는 무한한 보물창고일까?",
        "🌋 땅이 흔들리고 하늘이 무너질 때",
        "🌐 전 세계가 이웃이 된 시대, 세계화",
        "🌏 100년 후에도 살 수 있을까? 지구의 미래"
      ],
      law: [
        "🤝 사람이라면 누구나 누리는 소중한 권리, 인권",
        "⚖️ 평등을 향한 오랜 여정",
        "🛡️ 우리 곁의 인권, 어떻게 지켜졌을까?",
        "🛡️ 사이버 폭력에서 아동 학대까지, 인권 보호의 중요성",
        "⚖️ 삼복 제도와 조선의 신중한 재판 방식",
        "📜 헌법, 나라의 가장 높은 약속",
        "🏛️ 법은 어떻게 만들어질까?",
        "👨‍⚖️ 법원과 재판, 정의를 찾아서",
        "🚔 범죄와 형벌, 왜 처벌할까?",
        "👶 청소년도 법의 보호를 받아요",
        "📝 계약과 소비자의 권리",
        "⚠️ 불법 행위와 손해 배상",
        "👨‍👩‍👧 가족과 법, 함께 사는 규칙",
        "👷 일하는 사람의 권리, 노동법",
        "🌍 국제법과 세계 시민의 권리",
        "🌿 환경을 지키는 법, 환경법",
        "💡 아이디어를 보호하는 법, 지식재산권",
        "📱 디지털 시대의 법, 정보와 개인정보",
        "🤝 분쟁을 해결하는 방법, 소송과 조정",
        "⚖️ 법과 정의, 더 나은 사회를 향해"
      ],
      pol: [
        "🏛️ 정치는 왜 필요할까?",
        "🗳️ 국민이 주인이 되는 나라, 민주주의",
        "✊ 4·19에서 6월 항쟁까지, 민주주의의 성장",
        "⚖️ 다수결만으로 충분할까? 민주주의의 진짜 원리",
        "🗳️ 한 표의 힘이 모여 만드는 민주주의",
        "⚖️ 권력을 나누는 지혜, 삼권분립",
        "🏠 우리 동네를 우리 손으로, 지방자치",
        "📜 시민의 권리와 책임",
        "🌍 세계 속의 대한민국, 국제정치",
        "☮️ 평화 통일을 향한 여정",
        "💰 경제 활동의 시작, 희소성과 선택",
        "🏪 시장에서 만나는 수요와 공급",
        "📈 가격은 어떻게 정해질까?",
        "🏦 돈의 흐름, 금융과 저축",
        "💳 신용과 합리적 소비",
        "🏭 기업의 역할과 사회적 책임",
        "📊 국가 경제와 경제 성장",
        "💵 세금과 정부의 역할",
        "🌍 무역과 세계 경제",
        "🌱 미래 경제와 지속 가능한 발전"
      ],
      econ: [
        "경제 활동의 기본 원리",
        "시장과 수요·공급",
        "가격이 결정되는 과정",
        "금융과 화폐의 역할",
        "국가 경제의 순환",
        "무역과 세계 경제",
        "소비자와 합리적 선택",
        "기업의 역할과 경영",
        "경제 문제와 정책",
        "미래 산업과 경제 변화"
      ],
      modern: [
        "🌙 메밀꽃 필 무렵, 달빛 아래 피어난 인연",
        "🌧️ 소나기, 짧지만 강렬했던 첫사랑",
        "📖 봄봄, 장인에게 속은 데릴사위의 분노",
        "🚗 운수 좋은 날, 행운 뒤에 숨은 비극",
        "🌸 동백꽃, 닭싸움으로 시작된 풋사랑",
        "💕 사랑손님과 어머니, 옥희 눈에 비친 어른들",
        "🥔 감자, 가난이 무너뜨린 한 여인의 삶",
        "⛵ 배따라기, 바다 위에 떠도는 슬픈 노래",
        "💔 빈처, 가난 속에서도 빛나는 아내의 사랑",
        "🎓 레디메이드 인생, 지식인의 좌절과 자조",
        "🌊 탁류, 흐린 물에 휩쓸린 초봉이의 운명",
        "👨‍👩‍👦 삼대, 세 세대가 부딪히는 가치관",
        "😏 태평천하, 윤 직원의 기막힌 처세술",
        "🏙️ 천변풍경, 청계천 사람들의 희로애락",
        "💔 무정, 근대를 향한 청춘의 방황",
        "🚂 만세전, 조선으로 돌아온 지식인의 눈",
        "🕊️ 날개, 박제된 천재의 비극적 외침",
        "💫 봉별기, 기생 금홍과의 이별 이야기",
        "🚶 삼포 가는 길, 고향 잃은 떠돌이들",
        "🌧️ 장마, 이념을 넘어선 두 할머니",
        "🏛️ 광장, 남과 북 사이에서 길을 잃다",
        "💥 오발탄, 전쟁이 남긴 상처투성이 가족",
        "👨‍👦 수난이대, 아버지와 아들의 잃어버린 팔다리",
        "🌾 카인의 후예, 토지개혁이 빼앗은 삶",
        "🐴 역마, 떠돌이 운명을 타고난 성기",
        "🏘️ 사하촌, 절 아래 마을의 가난한 사람들",
        "🦢 학, 하얀 날개에 담긴 그리움",
        "🌾 황만근은 이렇게 말했다, 순박한 농부의 최후",
        "👞 아홉 켤레의 구두로 남은 사내, 가장의 무게",
        "🏠 엄마의 말뚝, 어머니가 박은 삶의 터전",
        "🎈 난장이가 쏘아올린 작은 공, 철거민의 꿈",
        "👤 우리들의 일그러진 영웅, 엄석대의 왕국",
        "🏃 깃발 없는 기수, 달리기와 좌절 사이",
        "🔨 객지, 공사판을 떠도는 노동자들",
        "🎶 서편제, 소리에 바친 송화의 눈",
        "🌏 토지, 최참판댁 5대의 대하드라마",
        "🔥 혼불, 꺼지지 않는 종가의 불씨",
        "⛰️ 태백산맥, 분단을 가른 이념의 산맥",
        "🔮 무녀도, 무당 어머니와 기독교 아들",
        "🌺 동백꽃, 알싸한 향기 속 풋풋한 고백"
      ],
      classic: [
        "📜 춘향과 몽룡의 약속, 춘향전",
        "⚖️ 어사 이도령과 춘향의 재회, 춘향전",
        "🌊 홍계월, 물에서 건져 올린 운명, 홍계월전",
        "✨ 백성을 위해 나선 신비한 선비, 전우치전",
        "🐢 숙향의 기이한 탄생과 잃어버린 어린 시절, 숙향전",
        "👁️ 아버지의 눈을 뜨게 한 효녀의 희생, 심청전",
        "🐦 제비가 물어다 준 복과 벌, 흥부전",
        "🐢 용궁에서 살아 돌아온 토끼의 지혜, 별주부전",
        "👻 원혼이 되어 밝힌 억울한 죽음, 장화홍련전",
        "👟 하늘이 도운 착한 콩쥐의 행복, 콩쥐팥쥐전",
        "🎭 제주 기생에게 놀아난 위선자의 최후, 배비장전",
        "👤 도깨비에게 혼쭐난 고집쟁이, 옹고집전",
        "💪 못생긴 며느리에서 나라를 구한 영웅으로, 박씨전",
        "💔 궁녀와 선비의 이루지 못한 사랑, 운영전",
        "🎨 신분을 넘은 기생과 양반의 사랑, 채봉감별곡",
        "🌙 팔선녀와 함께한 덧없는 영화의 꿈, 구운몽",
        "👸 쫓겨난 본처가 되찾은 명예, 사씨남정기",
        "👨‍👩‍👧‍👦 효성과 우애로 가문을 지킨 형제, 창선감의록",
        "⚔️ 왜적을 물리친 조선의 영웅들, 임진록",
        "📚 장사로 세상을 비판한 선비, 허생전",
        "💰 돈으로 사고판 양반의 신분, 양반전",
        "🐅 범에게 꾸지람 들은 위선자, 호질",
        "🎭 기생에게 빠져 패가망신한 한량, 이춘풍전",
        "💕 고난 끝에 다시 만난 두 연인, 옥단춘전",
        "🌸 하늘이 맺어준 인연의 시련과 결실, 숙영낭자전",
        "🌊 전쟁이 갈라놓은 가족의 기적 같은 재회, 최척전",
        "🌍 세 나라를 떠돈 파란만장한 삶, 김영철전",
        "⚔️ 서자로 태어나 새 나라를 세우다, 홍길동전",
        "🤦 어리석은 사위의 좌충우돌 실수담, 서동지전",
        "🐦 욕심 부리다 목숨을 잃은 꿩, 장끼전",
        "🐍 뱀 신랑의 비밀과 진정한 사랑, 구렁덩덩 신선비",
        "👸 버려진 공주가 부모를 살리다, 바리데기",
        "🔔 금방울로 나라를 구한 영웅, 금방울전",
        "⚔️ 간신에 맞서 충성을 다한 영웅, 유충렬전",
        "🗡️ 부모의 원수를 갚은 효자 장수, 조웅전",
        "👦 고아에서 대장군이 된 소년, 소대성전",
        "🏴 나라를 위해 목숨을 바친 충신 장군, 임경업전",
        "💎 역경을 딛고 일어선 충신의 후손, 적성의전",
        "🌙 달빛 아래 피어난 신비로운 사랑, 월영낭자전",
        "👻 죽음도 가르지 못한 사랑, 이생규장전"
      ],
      world: [
        "📚 두려움을 넘어선 새로운 시작",
        "🏝️ 섬의 비밀과 소년들의 결심",
        "동양 문학의 정서",
        "🎭 타미노와 파파게노에게 내려진 첫 번째 시험",
        "신화와 전설의 변주",
        "현대 세계문학의 흐름",
        "전쟁과 평화를 노래하다",
        "사랑과 인간 내면의 표현",
        "사회 비판적 시각의 문학",
        "여성과 문학의 목소리",
        "세계문학 11", "세계문학 12", "세계문학 13", "세계문학 14", "세계문학 15",
        "세계문학 16", "세계문학 17", "세계문학 18", "세계문학 19", "세계문학 20",
        "세계문학 21", "세계문학 22", "세계문학 23", "세계문학 24", "세계문학 25",
        "세계문학 26", "세계문학 27", "세계문학 28", "세계문학 29", "세계문학 30",
        "세계문학 31", "세계문학 32", "세계문학 33", "세계문학 34", "세계문학 35",
        "세계문학 36", "세계문학 37", "세계문학 38", "세계문학 39", "세계문학 40",
        "🏹 텔의 용기와 두려움",
        "💪 소년들의 용기와 케이트의 눈물",
        "세계문학(2) 43", "세계문학(2) 44", "세계문학(2) 45",
        "세계문학(2) 46", "세계문학(2) 47", "세계문학(2) 48", "세계문학(2) 49", "세계문학(2) 50",
        "세계문학(2) 51", "세계문학(2) 52", "세계문학(2) 53", "세계문학(2) 54", "세계문학(2) 55",
        "세계문학(2) 56", "세계문학(2) 57", "세계문학(2) 58", "세계문학(2) 59", "세계문학(2) 60",
        "세계문학(2) 61", "세계문학(2) 62", "세계문학(2) 63", "세계문학(2) 64", "세계문학(2) 65",
        "세계문학(2) 66", "세계문학(2) 67", "세계문학(2) 68", "세계문학(2) 69", "세계문학(2) 70",
        "세계문학(2) 71", "세계문학(2) 72", "세계문학(2) 73", "세계문학(2) 74", "세계문학(2) 75",
        "세계문학(2) 76", "세계문학(2) 77", "세계문학(2) 78", "세계문학(2) 79", "세계문학(2) 80"
      ],
      people: [
        "역사를 바꾼 인물들",
        "사상가들의 생각 따라가기",
        "과학 발전에 기여한 사람들",
        "문화예술을 빛낸 인물",
        "독립과 평화를 위한 지도자",
        "교육과 복지를 이끈 이들",
        "세계 무대의 리더십",
        "도전과 혁신의 사례",
        "인물비교로 보는 시대",
        "인물 이야기로 읽는 역사"
      ],
      naesin: [
        "교과 개념을 정리하다",
        "지문 구조를 파악하다",
        "문단 전개를 이해하다",
        "중요 어휘를 익히다",
        "자료와 표를 해석하다",
        "출제 포인트를 정리하다",
        "서술형 답안을 연습하다",
        "비판적 읽기로 확장하다",
        "유형별 문제에 적응하다",
        "학습한 내용을 마무리하다"
      ],
      suneung: [
        "수능 지문의 전개 방식",
        "사설·평론 지문 독해",
        "정보 확인 문제 공략",
        "추론형 문제 접근법",
        "간접 연계 지문 연습",
        "시간 관리 전략 세우기",
        "보기 자료와 함께 읽기",
        "오답 유형 분석하기",
        "수능 어휘 보충하기",
        "실전처럼 풀어보기"
      ],
      poem: [
        "시적 화자와 정서 파악",
        "이미지와 상징 읽기",
        "리듬과 운율 느끼기",
        "비유법의 효과 이해",
        "현대시의 주제 정리",
        "화자의 태도 변화 보기",
        "대상과 시선의 거리",
        "제목과 내용의 관계",
        "유형별 문제 접근",
        "감상문으로 옮겨보기"
      ],
      novel: [
        "인물과 갈등 구조",
        "시점과 서술 방식",
        "배경과 주제의 연결",
        "대화와 행동의 의미",
        "현대소설의 표현 기법",
        "결말을 통한 주제 확인",
        "반전과 복선 파악",
        "인물의 심리 읽기",
        "상징적 장면 해석",
        "서사 구조 정리하기"
      ],
      etc: [
        "극의 구조 이해하기",
        "희곡 인물의 대사 분석",
        "수필의 화자와 태도",
        "희곡 무대지시 읽기",
        "수필의 중심 생각 찾기",
        "극의 갈등과 해결",
        "희곡 장르의 특징",
        "삶을 담은 수필 읽기",
        "표현상의 특징 정리",
        "내용을 바탕으로 쓰기"
      ],
      gosi: [
        "시조의 형식과 정서",
        "향가와 고려가요의 미",
        "고전시가의 화자 이해",
        "표현법과 부사어 해석",
        "시대별 시가의 특징",
        "자연과 인간의 교감",
        "연군·연군가의 의미",
        "여성 화자의 목소리",
        "운율과 어조 파악",
        "현대어 풀이 연습"
      ],
      gonovel: [
        "고전소설의 구조",
        "영웅소설의 전개",
        "애정소설의 갈등",
        "가정소설과 교훈",
        "우화적 표현 읽기",
        "여성 인물의 형상화",
        "권선징악 구조 이해",
        "서사 단위로 나누기",
        "고전소설의 배경",
        "현대적 의미로 확장"
      ],
      goessay: [
        "고전 수필의 어조",
        "자연과 은일의 정서",
        "인물 평가와 교훈",
        "역사적 일화 읽기",
        "자기 성찰의 글",
        "간결한 표현의 미",
        "비유와 한자어 해석",
        "글쓴이의 삶과 태도",
        "문장 고쳐 쓰기",
        "감상 정리하기"
      ],
      modernGrammar: [
        "현대 국어의 음운",
        "품사와 형태소 분석",
        "단어의 형성 방식",
        "문장의 성분 이해",
        "문장 호응과 어순",
        "높임법과 공손 표현",
        "어휘의 의미 관계",
        "표준어와 맞춤법",
        "띄어쓰기 규칙",
        "담화와 담화 표지"
      ],
      middleGrammar: [
        "중세국어의 문자와 소리",
        "훈민정음 창제 배경",
        "중세국어의 문법 요소",
        "옛말 어미와 선어말어미",
        "중세국어 어휘 살펴보기",
        "시대별 문헌 읽기",
        "중세국어 문장 분석",
        "현대국어와의 차이",
        "의미 변천 이해",
        "고어 해석 연습"
      ]
    };

    /* 3. 전체 과목 임시 제목 자동 생성 */
    function buildUnitTitleOverrides() {
      const overrides = {};

      for (const [seriesKey, domains] of Object.entries(domainsBySeries)) {
        const realDomains = domains || domainsBySeries["BRAINON"];

        realDomains.forEach(domainObj => {
          domainObj.subs.forEach(subObj => {
            // offset이 있는 경우 (예: 세계문학(2), 인물(2)) 별도 키 사용
            const keyId = subObj.offset ? `${subObj.id}_part2` : subObj.id;
            const key = `${seriesKey}.${domainObj.id}.${keyId}`;
            const count = subObj.count;

            const theme =
              titleThemes[subObj.id] ||
              titleThemes[subObj.label] ||
              ["내용을 이해하고 정리하기", "핵심어를 중심으로 읽기", "문단 전개 파악하기", "자료와 함께 생각하기"];

            const arr = [];
            for (let i = 1; i <= count; i++) {
              const picked = theme[(i - 1) % theme.length];
              arr.push(`${picked}`);
            }
            overrides[key] = arr;
          });
        });
      }

      // 실제 알고 있는 제목 덮어쓰기 (정조/사회/지리)
      // ✅ BRAINDEEP 딥지구과학 제목
      overrides["BRAINDEEP.science.earth"] = [
        "🌍 태양계 성운에서 분화까지, 지구 형성의 천문학적 과정",
        "🌋 맨틀 대류에서 화산 분출까지, 지구 내부 열역학의 지표 표현",
        "🪨 암석 순환과 광물 조성, 지각 물질의 기원과 변환",
        "🏜️ 풍화와 토양 생성, 암석권에서 생물권으로의 물질 전환",
        "🌊 하천 작용과 지형 발달, 유수의 침식·운반·퇴적 역학",
        "🌋 판 경계와 지진 발생 메커니즘, 탄성 반발설과 지진파 해석",
        "🏔️ 판구조론과 조산운동, 해저 확장에서 대륙 충돌까지",
        "📚 지층 누중과 퇴적 구조, 층서학적 기록 해석의 원리",
        "🦴 화석의 형성과 고생물학, 생명 진화의 지질학적 기록",
        "🧲 지구 자기장과 다이나모 이론, 고지자기의 지질학적 응용",
        "🌤️ 대기 순환과 기단의 상호작용, 종관 기상학의 원리",
        "☁️ 구름 물리학과 강수 과정, 대기 수문학의 메커니즘",
        "💨 해양 순환과 열염분 대류, 기후 조절자로서의 해양",
        "🌡️ 기후 시스템의 복잡성과 인위적 기후 변화의 과학",
        "🪐 태양계의 구조와 행성 과학, 비교 행성학의 관점",
        "⛏️ 지구 자원의 형성과 분포, 에너지 전환의 지구과학적 기반",
        "🌊 조석 역학과 해양 파동, 천체와 해양의 상호작용",
        "⏳ 지질 연대학과 생물 진화사, 대멸종과 생태계 재편",
        "🚀 우주 탐사의 과학과 기술, 천문학적 관측의 지구과학적 의의",
        "🌋 자연재해의 발생 메커니즘과 방재 과학, 재해 경감 기술의 발전"
      ];

      // ✅ BRAINDEEP 딥물리 제목
      overrides["BRAINDEEP.science.physics"] = [
        "🔬 물리량의 측정과 국제단위계(SI)의 이해",
        "📐 벡터와 스칼라, 물리량의 분류와 연산",
        "🚀 직선 운동의 기술, 속도와 가속도의 물리학",
        "🍎 뉴턴의 운동 법칙, 고전역학의 기초",
        "🎯 포물선 운동, 2차원에서의 물체 운동 분석",
        "🔄 원운동과 구심력, 회전하는 물체의 역학",
        "⚡ 일과 에너지, 역학적 에너지 보존의 원리",
        "💥 운동량과 충격량, 충돌의 물리학",
        "🔥 열과 열역학, 에너지 전환의 법칙",
        "🌊 파동의 기초, 진동이 전파되는 원리",
        "🔊 소리와 음파, 진동이 만들어내는 청각 세계",
        "💡 빛과 광학, 반사와 굴절의 물리학",
        "⚡ 전기와 전하, 정전기 현상과 쿨롱의 법칙",
        "🔌 전류와 전기회로, 옴의 법칙과 회로 해석",
        "🧲 자기와 전자기 유도, 전기와 자기의 통합",
        "🚀 상대성 이론, 시간과 공간의 혁명",
        "⚛️ 양자역학의 기초, 미시 세계의 새로운 물리학",
        "☢️ 원자와 핵물리, 물질의 가장 깊은 구조",
        "💻 반도체와 전자소자, 현대 전자공학의 물리적 기초",
        "🌐 물리학과 현대 기술, 과학이 만든 일상의 혁신"
      ];

      // ✅ BRAINDEEP 딥화학 제목
      overrides["BRAINDEEP.science.chem"] = [
        "⚗️ 물질의 분류 체계와 순물질, 혼합물의 화학적 특성",
        "🔬 원자의 구조와 전자 배치, 주기율표의 화학적 의미",
        "🔗 화학 결합의 원리와 이온 결합, 공유 결합의 특성",
        "⚖️ 화학 반응식과 몰의 개념, 양적 관계의 이해",
        "🌡️ 용액의 농도와 묽은 용액의 총괄성",
        "⚗️ 산과 염기의 정의, 중화 반응과 pH의 화학",
        "🔥 산화-환원 반응의 원리와 전자 이동의 화학",
        "🔋 전기화학의 원리와 화학 전지의 작동 메커니즘",
        "⏱️ 화학 반응 속도와 반응 속도에 영향을 미치는 요인",
        "⚖️ 화학 평형의 원리와 르샤틀리에의 법칙",
        "🌡️ 열화학과 엔탈피 변화의 원리",
        "💨 기체의 성질과 기체 법칙의 원리",
        "🧬 유기화합물의 세계와 탄소 화학의 기초",
        "🧪 고분자 화합물과 합성 고분자의 세계",
        "🧬 생화학의 기초와 생명체의 화학 반응",
        "🌍 화학과 환경 - 대기 오염과 녹색 화학의 미래",
        "🔬 분석화학의 기초와 화학 분석 방법",
        "⚙️ 금속의 화학과 합금의 원리",
        "🧴 화학과 일상생활 - 생활 속 화학의 원리",
        "🚀 신소재와 나노화학, 미래 기술의 화학적 기반"
      ];

      // ✅ BRAINDEEP 딥사회문화 제목
      overrides["BRAINDEEP.social.soc"] = [
        "🔍 사회를 보는 눈",
        "🎭 진실을 찾는 여정",
        "⚖️ 연구자의 윤리적 딜레마",
        "🧩 나는 누구인가",
        "🎪 보이지 않는 무대",
        "👥 함께 살아가는 법",
        "🏛️ 관료제의 두 얼굴",
        "📱 연결된 세상의 명암",
        "🚨 왜 규칙을 어기는가",
        "🎓 학교는 평등한가",
        "📊 숫자로 보는 사회",
        "🏘️ 우리 동네가 변하고 있다",
        "📺 미디어가 만드는 세상",
        "🌍 지구촌 시대의 빛과 그림자",
        "🗳️ 한 표의 힘",
        "🔍 우리 사회의 민낯",
        "🏥 함께 만드는 안전망",
        "🌱 지구와 함께 살아가기",
        "⚖️ 법의 지배와 정의",
        "✊ 인권의 역사와 시민사회"
      ];

      // ✅ BRAINDEEP 딥지리 제목
      overrides["BRAINDEEP.social.geo"] = [
        "🗺️ 세상을 읽는 지도",
        "🌍 위치가 운명을 바꾼다",
        "🏔️ 땅이 들려주는 이야기",
        "🌊 물이 빚어낸 지형",
        "☀️ 기후가 삶을 결정한다",
        "👥 사람은 왜 모여 살까",
        "🏙️ 도시의 빛과 그림자",
        "🌾 마을이 사라지고 있다",
        "🏗️ 국토의 균형을 찾아서",
        "⚡ 에너지, 미래를 바꾸다",
        "🌐 세계가 하나로 연결되다",
        "✈️ 시간과 공간을 넘어",
        "🌍 지구촌 기후 여행",
        "👥 80억 인류의 불균형한 지도",
        "🏙️ 도시의 빛과 그림자",
        "🗺️ 디지털 지구를 읽다",
        "⚔️ 국경선에 새겨진 갈등의 역사",
        "🌿 지구를 살리는 선택",
        "⚡ 에너지 전환의 시대",
        "📍 지역이 브랜드가 되는 시대"
      ];

      // ✅ BRAINDEEP 딥법 제목
      overrides["BRAINDEEP.social.law"] = [
        "⚖️ 왜 우리에게 법이 필요한가",
        "📜 대한민국의 설계도",
        "🗽 나의 권리는 어디까지인가",
        "🏛️ 권력을 나누는 이유",
        "🗳️ 한 표가 세상을 바꾼다",
        "👤 법 앞에 선 나, 권리의 주체",
        "📝 약속은 지켜야 한다",
        "🏠 내 것과 네 것의 경계",
        "💍 가족, 법으로 묶인 인연",
        "🚨 무엇이 범죄인가",
        "💥 피해를 입었다면 배상받자",
        "⚖️ 법정에서는 무슨 일이",
        "🤝 싸우지 않고 해결하는 법",
        "💼 일하는 사람을 지키는 법",
        "🌍 세계를 묶는 약속",
        "🛒 현명한 소비자가 되려면",
        "💡 아이디어도 재산이다",
        "🌿 자연을 지키는 법",
        "👦 미성년자의 법적 지위",
        "📋 알아두면 좋은 법"
      ];

      // ✅ BRAINDEEP 딥정치경제 제목
      overrides["BRAINDEEP.social.pol"] = [
        "🗳️ 민주주의란 무엇인가",
        "🏛️ 대통령제와 의원내각제",
        "✋ 한 표의 힘, 선거",
        "🤝 정치를 움직이는 집단들",
        "🏘️ 우리 지역은 우리 손으로",
        "💰 경제활동의 기초",
        "📊 수요와 공급의 만남",
        "🏪 경쟁 시장과 독점 시장",
        "⚖️ 보이지 않는 손의 한계",
        "📈 GDP로 보는 나라 경제",
        "💸 왜 과자가 점점 작아지는 걸까?",
        "👷 일자리와 실업률",
        "📊 호황과 불황의 반복",
        "🚢 왜 나라끼리 물건을 사고팔까?",
        "💱 원화와 달러의 관계",
        "🏭 기업은 어떻게 돈을 벌까?",
        "🏦 은행은 우리 돈으로 무엇을 할까?",
        "💰 세금은 어디에 쓰일까?",
        "🏛️ 정부는 왜 경제에 개입할까?",
        "🌐 세계는 어떻게 연결되어 있을까?"
      ];

      // ✅ BRAINDEEP 딥현대문학 제목
      overrides["BRAINDEEP.korlit.modern"] = [
        "🌙 메밀꽃 필 무렵, 달빛 아래 피어난 인연",
        "🌧️ 소나기, 짧지만 강렬했던 첫사랑",
        "📖 봄봄, 장인에게 속은 데릴사위의 분노",
        "🚗 운수 좋은 날, 행운 뒤에 숨은 비극",
        "🌸 동백꽃, 닭싸움으로 시작된 풋사랑",
        "💕 사랑손님과 어머니, 옥희 눈에 비친 어른들",
        "🥔 감자, 가난이 무너뜨린 한 여인의 삶",
        "⛵ 배따라기, 바다 위에 떠도는 슬픈 노래",
        "💔 빈처, 가난 속에서도 빛나는 아내의 사랑",
        "🎓 레디메이드 인생, 지식인의 좌절과 자조",
        "🌊 탁류, 흐린 물에 휩쓸린 초봉이의 운명",
        "👨‍👩‍👦 삼대, 세 세대가 부딪히는 가치관",
        "😏 태평천하, 윤 직원의 기막힌 처세술",
        "🏙️ 천변풍경, 청계천 사람들의 희로애락",
        "💔 무정, 근대를 향한 청춘의 방황",
        "🚂 만세전, 조선으로 돌아온 지식인의 눈",
        "🕊️ 날개, 박제된 천재의 비극적 외침",
        "💫 봉별기, 기생 금홍과의 이별 이야기",
        "🚶 삼포 가는 길, 고향 잃은 떠돌이들",
        "🌧️ 장마, 이념을 넘어선 두 할머니",
        "🏛️ 광장, 남과 북 사이에서 길을 잃다",
        "💥 오발탄, 전쟁이 남긴 상처투성이 가족",
        "👨‍👦 수난이대, 아버지와 아들의 잃어버린 팔다리",
        "🌾 카인의 후예, 토지개혁이 빼앗은 삶",
        "🐴 역마, 떠돌이 운명을 타고난 성기",
        "🏘️ 사하촌, 절 아래 마을의 가난한 사람들",
        "🦢 학, 하얀 날개에 담긴 그리움",
        "🌾 황만근은 이렇게 말했다, 순박한 농부의 최후",
        "👞 아홉 켤레의 구두로 남은 사내, 가장의 무게",
        "🏠 엄마의 말뚝, 어머니가 박은 삶의 터전",
        "🎈 난장이가 쏘아올린 작은 공, 철거민의 꿈",
        "👤 우리들의 일그러진 영웅, 엄석대의 왕국",
        "🏃 깃발 없는 기수, 달리기와 좌절 사이",
        "🔨 객지, 공사판을 떠도는 노동자들",
        "🎶 서편제, 소리에 바친 송화의 눈",
        "🌏 토지, 최참판댁 5대의 대하드라마",
        "🔥 혼불, 꺼지지 않는 종가의 불씨",
        "⛰️ 태백산맥, 분단을 가른 이념의 산맥",
        "🔮 무녀도, 무당 어머니와 기독교 아들",
        "🌺 동백꽃, 알싸한 향기 속 풋풋한 고백"
      ];

      // ✅ BRAINDEEP 딥고전문학 제목
      overrides["BRAINDEEP.korlit.classic"] = [
        "📜 춘향과 몽룡의 약속",
        "⚖️ 어사 이도령과 춘향의 재회",
        "🌊 홍계월, 물에서 건져 올린 운명",
        "✨ 백성을 위해 나선 신비한 선비",
        "🐢 숙향의 기이한 탄생과 잃어버린 어린 시절",
        "👁️ 아버지의 눈을 뜨게 한 효녀의 희생",
        "🐦 제비가 물어다 준 복과 벌",
        "🐢 용궁에서 살아 돌아온 토끼의 지혜",
        "👻 원혼이 되어 밝힌 억울한 죽음",
        "👟 하늘이 도운 착한 콩쥐의 행복",
        "🎭 제주 기생에게 놀아난 위선자의 최후",
        "👥 가짜에게 빼앗긴 진짜의 자리",
        "💪 못생긴 며느리에서 나라를 구한 영웅으로",
        "💔 궁녀와 선비의 이루지 못한 사랑",
        "🎨 신분을 넘은 기생과 양반의 사랑",
        "🌙 팔선녀와 함께한 덧없는 영화의 꿈",
        "👸 쫓겨난 본처가 되찾은 명예",
        "👨‍👩‍👧‍👦 효성과 우애로 가문을 지킨 형제",
        "⚔️ 왜적을 물리친 조선의 영웅들",
        "📚 장사로 세상을 비판한 선비",
        "💰 돈으로 사고판 양반의 신분",
        "🐅 범에게 꾸지람 들은 위선자",
        "🎭 기생에게 빠져 패가망신한 한량",
        "💕 고난 끝에 다시 만난 두 연인",
        "🌸 하늘이 맺어준 인연의 시련과 결실",
        "🌊 전쟁이 갈라놓은 가족의 기적 같은 재회",
        "🌍 세 나라를 떠돈 파란만장한 삶",
        "⚔️ 서자로 태어나 새 나라를 세우다",
        "🤦 어리석은 사위의 좌충우돌 실수담",
        "🐦 욕심 부리다 목숨을 잃은 꿩",
        "🐍 뱀 신랑의 비밀과 진정한 사랑",
        "👸 버려진 공주가 부모를 살리다",
        "🔔 금방울로 나라를 구한 영웅",
        "⚔️ 간신에 맞서 충성을 다한 영웅",
        "🗡️ 부모의 원수를 갚은 효자 장수",
        "👦 고아에서 대장군이 된 소년",
        "🏴 나라를 위해 목숨을 바친 충신 장군",
        "💎 역경을 딛고 일어선 충신의 후손",
        "🌙 달빛 아래 피어난 신비로운 사랑",
        "👻 죽음도 가르지 못한 사랑"
      ];

      // ✅ BRAINDEEP 딥세계문학1 제목
      overrides["BRAINDEEP.worldlit.world1"] = [
        "📚 두려움을 넘어선 새로운 시작",
        "🏝️ 섬의 비밀과 소년들의 결심",
        "🌸 꽃의 요정이 이룬 소원",
        "🎭 타미노와 파파게노에게 내려진 첫 번째 시험",
        "🦊 어린 왕자와 여우의 특별한 만남",
        "🏴‍☠️ 보물 지도를 손에 넣은 소년",
        "🪵 나무 인형이 사람이 되기까지",
        "🌪️ 회오리바람을 타고 마법의 나라로",
        "🐰 토끼 굴 속으로 떨어진 소녀",
        "🐺 늑대에게 키워진 아이",
        "🧚 영원히 어른이 되지 않는 소년",
        "🏝️ 무인도에서 살아남은 사나이",
        "🔍 거인이 되었다가 난쟁이가 된 사나이",
        "🧢 미시시피강가의 말썽꾸러기",
        "🍎 일곱 난쟁이와 독사과",
        "👠 유리구두의 주인을 찾아서",
        "🧜‍♀️ 바다 밑에서 온 공주",
        "🌹 백 년 동안 잠든 공주",
        "🐺 숲속의 무서운 늑대",
        "🍬 과자로 만든 집",
        "💇 높은 탑에 갇힌 소녀",
        "🌱 하늘까지 자란 콩나무",
        "🐷 세 마리 아기 돼지",
        "🦢 아름다운 백조가 된 오리",
        "🔥 추운 밤의 작은 불꽃",
        "🎵 동물들의 음악 여행",
        "🐸 황금 공과 개구리",
        "🎶 쥐를 쫓아낸 피리",
        "🥾 영리한 고양이의 계략",
        "👸 꽃에서 태어난 작은 소녀",
        "🐐 엄마 염소와 아기 염소들",
        "🎄 크리스마스의 마법 인형",
        "👠 멈출 수 없는 춤",
        "⚔️ 정직한 나무꾼",
        "💎 슬픔을 아는 황금 동상",
        "🦢 마법에 걸린 오빠들",
        "❄️ 얼음 궁전으로 간 소년",
        "⭐ 작은 별에서 온 소년",
        "🐑 거짓말의 대가",
        "🐢 느림보의 승리"
      ];

      // ✅ BRAINDEEP 딥세계문학2 제목
      overrides["BRAINDEEP.worldlit.world2"] = [
        "🏹 텔의 용기와 두려움",
        "💪 소년들의 용기와 케이트의 눈물",
        "🏹 로빈 후드의 은밀한 재판",
        "💃 말괄량이 카타리나를 둘러싼 오해와 진실",
        "🍲 올리버의 용기 있는 한마디",
        "🚣 자유를 찾아 떠난 소년",
        "🌸 잠든 정원이 깨어나다",
        "🌍 시간을 다투는 대모험",
        "🐚 신비로운 바닷속 세계",
        "👑 바뀐 운명, 바뀐 세상",
        "🎣 미시시피 강의 장난꾸러기",
        "🐺 정글의 아이 모글리",
        "✨ 영원히 자라지 않는 소년",
        "🏴‍☠️ 보물을 찾아 떠난 모험",
        "🌈 무지개 너머 마법의 나라",
        "🎭 두 얼굴을 가진 의사",
        "👧 네 자매의 성장 이야기",
        "🌪️ 황야의 비극적 사랑",
        "📖 자존심을 지킨 여인",
        "⚔️ 복수의 백작",
        "🏝️ 무인도에서 살아남기",
        "🧭 거인과 소인의 나라",
        "🛡️ 이상과 현실 사이의 기사",
        "🔴 가슴에 새긴 죄의 글자",
        "💕 첫인상을 넘어서",
        "😈 악마와의 거래",
        "🕯️ 은촛대의 기적",
        "🚂 운명의 기차",
        "⚖️ 양심의 무게",
        "🪲 어느 날 아침 벌레가 되다",
        "🐰 토끼굴 속으로",
        "🐋 하얀 고래를 쫓아서",
        "🌊 마법사의 섬",
        "🌾 어른이 되기 싫어",
        "🎣 포기하지 않는 노인",
        "🐷 동물들의 혁명",
        "💚 초록빛 불빛을 향해",
        "⚖️ 정의를 위한 변호",
        "👁️ 빅 브라더가 보고 있다",
        "🐚 소년들의 섬"
      ];

      // ✅ BRAINDEEP 딥한국인물 제목
      overrides["BRAINDEEP.person.people1"] = [
        "⚔️ 다짐으로 다시 태어난 김유신",
        "👑 아버지의 뜻을 잇는 왕, 문무왕",
        "💀 해골 물에서 얻은 깨달음",
        "🌏 우물 안 개구리를 벗어난 혜초의 모험",
        "⚙️ 노비 출신 천재 과학자 장영실",
        "⚓ 바다를 지킨 영웅 이순신",
        "📚 백성을 사랑한 임금 세종대왕",
        "💊 백성의 병을 고친 의원 허준",
        "🎨 그림과 학문으로 빛난 신사임당",
        "📖 조선 성리학의 거장 이황",
        "💡 실천하는 학자 율곡 이이",
        "🔬 백성을 위한 실학자 정약용",
        "🏹 영토를 넓힌 광개토대왕",
        "⚔️ 살수대첩의 영웅 을지문덕",
        "🛡️ 귀주대첩의 명장 강감찬",
        "💣 화약을 만든 최무선",
        "🌸 충절의 선비 정몽주",
        "⚖️ 청렴한 재상 황희",
        "🦁 우산국을 정복한 장군 이사부",
        "🗺️ 대동여지도를 만든 김정호",
        "🔫 독립을 위해 싸운 안중근",
        "🇰🇷 만세를 외친 유관순",
        "💪 조국을 위해 목숨 바친 윤봉길",
        "🕊️ 독립운동의 지도자 김구",
        "✍️ 명필의 대가 한석봉",
        "🖌️ 서민의 삶을 그린 김홍도",
        "👘 아름다움을 그린 신윤복",
        "📝 열하일기를 쓴 박지원",
        "✝️ 첫 한국인 신부 김대건",
        "🔤 한글 연구의 아버지 주시경",
        "👶 어린이날을 만든 방정환",
        "🚢 해상왕 장보고",
        "👑 신라의 첫 여왕 선덕여왕",
        "🏰 고구려의 명장 연개소문",
        "⚔️ 황산벌의 영웅 계백",
        "🗡️ 고려의 충신 최영",
        "🏯 행주대첩의 명장 권율",
        "🔥 의병장 곽재우",
        "🌱 목화씨를 가져온 문익점",
        "📜 조선 최고의 여류 시인 허난설헌"
      ];

      // ✅ BRAINDEEP 딥세계인물 제목
      overrides["BRAINDEEP.person.people2"] = [
        "🎨 관찰로 세상을 그린 소년, 레오나르도",
        "🎨 천장을 그린 남자, 미켈란젤로",
        "🎭 극장으로 들어간 한 남자의 이야기",
        "🎵 놀라운 재능을 지닌 어린 음악가",
        "🔬 상상력으로 우주를 탐험한 과학자, 아인슈타인",
        "⚗️ 방사능의 비밀을 밝힌 여성 과학자, 마리 퀴리",
        "☮️ 비폭력으로 세상을 바꾼 지도자, 간디",
        "✈️ 하늘을 나는 꿈을 이룬 형제, 라이트 형제",
        "💡 어둠 속에서 빛을 찾은 헬렌 켈러",
        "🎨 붓으로 감정을 그린 화가, 반 고흐",
        "🏥 백의의 천사, 나이팅게일",
        "✊ 27년의 감옥, 용서로 나라를 바꾼 넬슨 만델라",
        "💻 다르게 생각하라, 스티브 잡스",
        "🙏 가난한 이들의 어머니, 마더 테레사",
        "🎨 세상을 새롭게 본 화가, 피카소",
        "🏰 꿈의 왕국을 세운 월트 디즈니",
        "🔬 세균을 발견한 과학자, 루이 파스퇴르",
        "👩‍🏫 기적을 만든 선생님, 앤 설리번",
        "🎬 웃음으로 세상을 위로한 찰리 채플린",
        "🐵 침팬지와 함께 살다, 제인 구달",
        "🎻 악기의 명장, 안토니오 스트라디바리",
        "🎼 운명을 극복한 음악가, 베토벤",
        "🎨 천재의 대명사, 레오나르도 다빈치",
        "💊 페니실린을 발견한 알렉산더 플레밍",
        "🎩 노예를 해방한 대통령, 링컨",
        "⚔️ 유럽을 정복한 황제, 나폴레옹",
        "✊ 나에게는 꿈이 있습니다, 마틴 루터 킹",
        "📖 돈키호테를 쓴 세르반테스",
        "📚 인을 가르친 스승, 공자",
        "🗡️ 세계를 정복한 젊은 왕, 알렉산더 대왕",
        "👑 이집트의 마지막 여왕, 클레오파트라",
        "🏹 세계 최대 제국을 세운 징기스칸",
        "🦎 진화론을 발견한 찰스 다윈",
        "👗 패션을 바꾼 여성, 코코 샤넬",
        "💻 컴퓨터 혁명을 이끈 빌 게이츠",
        "🏀 농구의 신, 마이클 조던",
        "⚔️ 전설의 왕, 아서왕",
        "🏺 황금 마스크의 주인, 투탕카멘",
        "🔭 지동설의 아버지, 갈릴레오 갈릴레이",
        "⚡ 전기의 마법사, 니콜라 테슬라"
      ];

      overrides["BRAINUP.social.geo"] = [
        "🗺️ 지도를 통해 세상을 이해하다",
        "📍 지도에 담긴 약속과 표현",
        "🏘️ 우리 고장의 상징과 유래",
        "🏙️ 우리 동네는 왜 불편할까? 지역 문제 살펴보기",
        "🌾 시대와 함께 발전하는 시골 마을",
        "🧭 지구에 주소가 있다고? 위도와 경도의 비밀",
        "🌍 지구의 얼굴, 대륙과 바다 이야기",
        "🇰🇷 우리나라는 어디에 있을까? 한반도의 위치",
        "🏔️ 백두산에서 한라산까지, 국토 여행",
        "☀️ 왜 제주도는 서울보다 따뜻할까?",
        "🏙️ 도시는 왜 커질까? 도시화의 빛과 그림자",
        "👨‍👩‍👧‍👦 인구 이동, 사람들은 왜 움직일까?",
        "🚄 세계는 하나로, 교통과 통신의 발달",
        "🗺️ 지도 속 보물찾기, 지리 정보 기술",
        "⛽ 자원은 어디에? 에너지와 자원의 분포",
        "⚡ 석유가 사라진다면? 에너지의 미래",
        "🐟 바다는 무한한 보물창고일까?",
        "🌋 땅이 흔들리고 하늘이 무너질 때",
        "🌐 전 세계가 이웃이 된 시대, 세계화",
        "🌏 100년 후에도 살 수 있을까? 지구의 미래"
      ];

      // BRAINFIT 핏법 제목 (새 제목)
      overrides["BRAINFIT.social.law"] = [
        "🌟 태어나면서 받는 선물, 인권이란?",
        "🚀 '모두 평등하다'가 당연해지기까지",
        "🦸 인권 지킴이들의 위대한 도전",
        "🔒 보이지 않는 폭력, 어떻게 막을까?",
        "🏯 조선시대에도 억울함을 풀 수 있었다고?",
        "👑 대통령도 지켜야 하는 법, 헌법",
        "📝 내 아이디어가 법이 된다면?",
        "🔨 판사의 망치가 내려오기까지",
        "⛓️ 나쁜 짓을 하면 왜 벌을 받을까?",
        "🎒 미성년자라서 괜찮다? 착각이야!",
        "🛒 환불받고 싶을 때, 어떻게 해야 할까?",
        "💸 친구가 내 물건을 망가뜨렸다면?",
        "💍 결혼하면 법적으로 뭐가 달라질까?",
        "💰 알바비 못 받았을 때 이렇게 하세요!",
        "🌐 국경을 넘는 약속, 국제법",
        "🌱 지구를 지키는 법의 힘",
        "🎨 내 창작물, 누가 훔쳐가면?",
        "🔐 내 개인정보, 어디까지 알고 있을까?",
        "⚔️ 싸움이 생겼을 때, 법원 말고 다른 방법",
        "🌈 법이 없다면 세상은 어떻게 될까?"
      ];

      // BRAINFIT 핏지리 제목 (새 제목)
      overrides["BRAINFIT.social.geo"] = [
        "🗺️ 종이 한 장에 담긴 세상, 지도의 비밀",
        "🗺️ 등고선의 비밀, 지도는 어떻게 읽을까?",
        "🏛️ 땅에 새겨진 이야기, 우리 고장 탐험",
        "🚌 버스가 안 와요! 우리 동네 문제 해결하기",
        "🚜 드론이 농사짓는 시대, 촌락의 변신",
        "🌍 지구에도 주소가 있다고? 위도와 경도의 비밀",
        "🌊 70% 바다, 30% 땅! 지구의 얼굴 탐험",
        "🇰🇷 반도의 나라, 대륙과 바다를 잇다",
        "🏔️ 동쪽은 높고 서쪽은 낮다! 국토의 비밀",
        "☀️ 같은 날, 다른 날씨? 기후의 비밀을 풀다",
        "🏙️ 사람들은 왜 도시로 모일까?",
        "🚚 고향을 떠나는 사람들, 인구 이동의 비밀",
        "🚀 KTX로 2시간, 세상이 가까워지다",
        "📱 스마트폰이 길을 찾는 법, GPS의 비밀",
        "⛽ 석유 한 방울, 어디서 왔을까?",
        "⚡ 50년 후 석유가 없다면? 에너지의 미래",
        "🐟 물고기가 사라지고 있다? 바다의 SOS",
        "🌋 불의 고리 위의 지구, 지진과 화산",
        "🌐 베트남 쌀국수, 일본 애니! 지구촌 시대",
        "🌏 빙하가 녹고 있다! 지구를 구하라"
      ];

      // BRAINFIT 정치경제 제목 덮어쓰기
      overrides["BRAINFIT.social.pol"] = [
        "🎭 정치가 사라진 학급에서 벌어지는 하루",
        "🏛️ 모두가 직접 투표한다면? 고대 아테네의 민주주의 실험",
        "📰 1987년 6월, 거리로 나선 사람들의 이야기",
        "🎲 51% vs 49%, 이 결정이 정말 옳을까?",
        "🗳️ 단 한 표 차이로 뒤바뀐 역사적 선거들",
        "👑 왕에게 모든 권력이 집중됐던 시대의 비극",
        "🏘️ 내가 살고 싶은 동네, 주민들이 직접 바꾼 성공 사례",
        "📱 내 SNS 게시물, 표현의 자유일까 명예훼손일까?",
        "🌐 전염병이 국경을 넘을 때, 세계가 협력하는 방법",
        "🚂 서울에서 평양까지 기차로 3시간, 통일 후 달라지는 것들",
        "⏰ 만 원의 행복: 게임 vs 맛집, 나의 기회비용은?",
        "🍦 여름에 아이스크림 값이 오르는 진짜 이유",
        "🎮 한정판은 왜 비쌀까? 가격의 비밀 파헤치기",
        "💰 복리의 마법: 용돈 1만 원이 100만 원 되는 비결",
        "🛒 \"지금 안 사면 품절!\" 광고 속 숨겨진 심리 트릭",
        "🦸 돈도 벌고 세상도 바꾸는 착한 기업의 비밀",
        "📉 불황이 오면 뜨는 의외의 인기 상품들",
        "💵 세금이 사라진다면? 하루 동안 생기는 일들",
        "🍫 초콜릿 한 조각 속에 담긴 세계 여행 이야기",
        "🌍 2050년 지구의 하루: 우리가 바꿀 수 있는 미래"
      ];

      // 핏사회문화 제목 덮어쓰기
      overrides["BRAINFIT.social.soc"] = [
        "🏠 피보다 진한 사랑, 가족이란 무엇일까?",
        "👨‍👩‍👧 할머니 시대 vs 우리 시대, 가족의 변신",
        "💕 우리 집 화목 비결, 배려의 마법",
        "🚀 말이 끌던 시대에서 비행기 시대까지",
        "🙋 내 목소리가 동네를 바꾼다!",
        "🎭 가면 뒤의 진짜 나는 누구일까?",
        "📱 좋아요 1000개보다 진짜 친구 한 명",
        "🤖 로봇이 할 수 없는 것, 인간만의 특별함",
        "👥 끼리끼리? 나만의 색깔을 찾아서",
        "🍜 라면도 문화다! 일상 속 숨은 문화 찾기",
        "🎬 K-콘텐츠, 전 세계를 사로잡다",
        "📰 진짜와 가짜를 구별하는 탐정 되기",
        "🗳️ 나도 한 표! 민주주의의 주인공",
        "⚖️ 공정한 세상을 만드는 방법",
        "🌍 지구가 보내는 SOS, 기후 위기",
        "🌐 지구촌 한 가족, 세계 시민 되기",
        "🔬 기술이 바꾼 우리의 하루",
        "🏥 모두가 행복한 사회의 비밀, 복지",
        "♻️ 오늘과 내일을 함께 생각하는 삶",
        "🔮 내가 만들어갈 10년 후의 세상"
      ];

      // 한국인물 제목 덮어쓰기
      const people1Titles = [
        "⚔️ 다짐으로 다시 태어난 김유신",
        "👑 아버지의 뜻을 잇는 왕, 문무왕",
        "💀 해골 물에서 얻은 깨달음",
        "🌏 우물 안 개구리를 벗어난 혜초의 모험",
        "⚙️ 노비 출신 천재 과학자 장영실",
        "⚓ 바다를 지킨 영웅 이순신",
        "📚 백성을 사랑한 임금 세종대왕",
        "💊 백성의 병을 고친 의원 허준",
        "🎨 그림과 학문으로 빛난 신사임당",
        "📖 조선 성리학의 거장 이황",
        "💡 실천하는 학자 율곡 이이",
        "🔬 백성을 위한 실학자 정약용",
        "🏹 영토를 넓힌 광개토대왕",
        "⚔️ 살수대첩의 영웅 을지문덕",
        "🛡️ 귀주대첩의 명장 강감찬",
        "💣 화약을 만든 최무선",
        "🌸 충절의 선비 정몽주",
        "⚖️ 청렴한 재상 황희",
        "🦁 우산국을 정복한 장군 이사부",
        "🗺️ 대동여지도를 만든 김정호",
        "🔫 독립을 위해 싸운 안중근",
        "🇰🇷 만세를 외친 유관순",
        "💪 조국을 위해 목숨 바친 윤봉길",
        "🕊️ 독립운동의 지도자 김구",
        "✍️ 명필의 대가 한석봉",
        "🖌️ 서민의 삶을 그린 김홍도",
        "👘 아름다움을 그린 신윤복",
        "📝 열하일기를 쓴 박지원",
        "✝️ 첫 한국인 신부 김대건",
        "🔤 한글 연구의 아버지 주시경",
        "👶 어린이날을 만든 방정환",
        "🚢 해상왕 장보고",
        "👑 신라의 첫 여왕 선덕여왕",
        "🏰 고구려의 명장 연개소문",
        "⚔️ 황산벌의 영웅 계백",
        "🗡️ 고려의 충신 최영",
        "🏯 행주대첩의 명장 권율",
        "🔥 의병장 곽재우",
        "🌱 목화씨를 가져온 문익점",
        "📜 조선 최고의 여류 시인 허난설헌"
      ];
      overrides["BRAINUP.person.people1"] = people1Titles;
      overrides["BRAINFIT.person.people1"] = people1Titles;

      // 세계인물 제목 덮어쓰기
      const people2Titles = [
        "🎨 관찰로 세상을 그린 소년, 레오나르도",
        "🎨 천장을 그린 남자, 미켈란젤로",
        "🎭 극장으로 들어간 한 남자의 이야기",
        "🎵 놀라운 재능을 지닌 어린 음악가",
        "🔬 상상력으로 우주를 탐험한 과학자, 아인슈타인",
        "⚗️ 방사능의 비밀을 밝힌 여성 과학자, 마리 퀴리",
        "☮️ 비폭력으로 세상을 바꾼 지도자, 간디",
        "✈️ 하늘을 나는 꿈을 이룬 형제, 라이트 형제",
        "💡 어둠 속에서 빛을 찾은 헬렌 켈러",
        "🎨 붓으로 감정을 그린 화가, 반 고흐",
        "🏥 백의의 천사, 나이팅게일",
        "✊ 27년의 감옥, 용서로 나라를 바꾼 넬슨 만델라",
        "💻 다르게 생각하라, 스티브 잡스",
        "🙏 가난한 이들의 어머니, 마더 테레사",
        "🎨 세상을 새롭게 본 화가, 피카소",
        "🏰 꿈의 왕국을 세운 월트 디즈니",
        "🔬 세균을 발견한 과학자, 루이 파스퇴르",
        "👩‍🏫 기적을 만든 선생님, 앤 설리번",
        "🎬 웃음으로 세상을 위로한 찰리 채플린",
        "🐵 침팬지와 함께 살다, 제인 구달",
        "🎻 악기의 명장, 안토니오 스트라디바리",
        "🎼 운명을 극복한 음악가, 베토벤",
        "🎨 천재의 대명사, 레오나르도 다빈치",
        "💊 페니실린을 발견한 알렉산더 플레밍",
        "🎩 노예를 해방한 대통령, 링컨",
        "⚔️ 유럽을 정복한 황제, 나폴레옹",
        "✊ 나에게는 꿈이 있습니다, 마틴 루터 킹",
        "📖 돈키호테를 쓴 세르반테스",
        "📚 인을 가르친 스승, 공자",
        "🗡️ 세계를 정복한 젊은 왕, 알렉산더 대왕",
        "👑 이집트의 마지막 여왕, 클레오파트라",
        "🏹 세계 최대 제국을 세운 징기스칸",
        "🦎 진화론을 발견한 찰스 다윈",
        "👗 패션을 바꾼 여성, 코코 샤넬",
        "💻 컴퓨터 혁명을 이끈 빌 게이츠",
        "🏀 농구의 신, 마이클 조던",
        "⚔️ 전설의 왕, 아서왕",
        "🏺 황금 마스크의 주인, 투탕카멘",
        "🔭 지동설의 아버지, 갈릴레오 갈릴레이",
        "⚡ 전기의 마법사, 니콜라 테슬라"
      ];
      overrides["BRAINUP.person.people2"] = people2Titles;
      overrides["BRAINFIT.person.people2"] = people2Titles;

      // 세계문학(1) 제목 덮어쓰기
      overrides["BRAINUP.worldlit.world1"] = [
        "📚 두려움을 넘어선 새로운 시작",
        "🏝️ 섬의 비밀과 소년들의 결심",
        "🌸 꽃의 요정이 이룬 소원",
        "🎭 타미노와 파파게노에게 내려진 첫 번째 시험",
        "🦊 어린 왕자와 여우의 특별한 만남",
        "🏴‍☠️ 보물 지도를 손에 넣은 소년",
        "🪵 나무 인형이 사람이 되기까지",
        "🌪️ 회오리바람을 타고 마법의 나라로",
        "🐰 토끼 굴 속으로 떨어진 소녀",
        "🐺 늑대에게 키워진 아이",
        "🧚 영원히 어른이 되지 않는 소년",
        "🏝️ 무인도에서 살아남은 사나이",
        "🔍 거인이 되었다가 난쟁이가 된 사나이",
        "🧢 미시시피강가의 말썽꾸러기",
        "🍎 일곱 난쟁이와 독사과",
        "👠 유리구두의 주인을 찾아서",
        "🧜‍♀️ 바다 밑에서 온 공주",
        "🌹 백 년 동안 잠든 공주",
        "🐺 숲속의 무서운 늑대",
        "🍬 과자로 만든 집",
        "💇 높은 탑에 갇힌 소녀",
        "🌱 하늘까지 자란 콩나무",
        "🐷 세 마리 돼지와 늑대",
        "🦢 못생긴 아기 오리의 비밀",
        "🔥 성냥불 속에서 본 꿈",
        "🎵 음악대를 꿈꾼 동물들",
        "🐸 개구리가 된 왕자",
        "🎶 피리 소리를 따라간 아이들",
        "👢 장화를 신은 영리한 고양이",
        "🔬 작아졌다 커졌다 하는 모험",
        "🐺 늑대와 일곱 마리 아기 염소",
        "🍫 황금 티켓과 초콜릿 공장",
        "👑 행복한 왕자의 눈물",
        "🪓 정직한 나무꾼과 도끼",
        "👻 크리스마스의 유령들",
        "❄️ 얼음 성의 여왕",
        "🌸 잠긴 문 뒤의 비밀 정원",
        "🌹 어린 왕자와 장미",
        "🐑 양치기 소년과 늑대",
        "🐢 토끼와 거북이의 경주"
      ];

      // BRAINFIT 세계문학(1) 제목 덮어쓰기
      overrides["BRAINFIT.worldlit.world1"] = [
        "📚 두려움을 넘어선 새로운 시작",
        "🏝️ 섬의 비밀과 소년들의 결심",
        "🌸 꽃의 요정이 이룬 소원",
        "🎭 타미노와 파파게노에게 내려진 첫 번째 시험",
        "🦊 어린 왕자와 여우의 특별한 만남",
        "🏴‍☠️ 보물 지도를 손에 넣은 소년",
        "🪵 나무 인형이 사람이 되기까지",
        "🌪️ 회오리바람을 타고 마법의 나라로",
        "🐰 토끼 굴 속으로 떨어진 소녀",
        "🐺 늑대에게 키워진 아이",
        "🧚 영원히 어른이 되지 않는 소년",
        "🏝️ 무인도에서 살아남은 사나이",
        "🔍 거인이 되었다가 난쟁이가 된 사나이",
        "🧢 미시시피강가의 말썽꾸러기",
        "🍎 일곱 난쟁이와 독사과",
        "👠 유리구두의 주인을 찾아서",
        "🧜‍♀️ 바다 밑에서 온 공주",
        "🌹 백 년 동안 잠든 공주",
        "🐺 숲속의 무서운 늑대",
        "🍬 과자로 만든 집",
        "💇 높은 탑에 갇힌 소녀",
        "🌱 하늘까지 자란 콩나무",
        "🐷 세 마리 돼지와 늑대",
        "🦢 못생긴 아기 오리의 비밀",
        "🔥 성냥불 속에서 본 꿈",
        "🎵 음악대를 꿈꾼 동물들",
        "🐸 개구리가 된 왕자",
        "🎶 피리 소리를 따라간 아이들",
        "👢 장화를 신은 영리한 고양이",
        "🔬 작아졌다 커졌다 하는 모험",
        "🐺 늑대와 일곱 마리 아기 염소",
        "🍫 황금 티켓과 초콜릿 공장",
        "👑 행복한 왕자의 눈물",
        "🪓 정직한 나무꾼과 도끼",
        "👻 크리스마스의 유령들",
        "❄️ 얼음 성의 여왕",
        "🌸 잠긴 문 뒤의 비밀 정원",
        "🌹 어린 왕자와 장미",
        "🐑 양치기 소년과 늑대",
        "🐢 토끼와 거북이의 경주"
      ];

      // 세계문학(2) 제목 덮어쓰기
      overrides["BRAINUP.worldlit.world2"] = [
        "🏹 텔의 용기와 두려움",
        "💪 소년들의 용기와 케이트의 눈물",
        "🏹 로빈 후드의 은밀한 재판",
        "💃 말괄량이 카타리나를 둘러싼 오해와 진실",
        "🍲 올리버의 용기 있는 한마디",
        "🚣 자유를 찾아 떠난 소년",
        "🌸 잠든 정원이 깨어나다",
        "🌍 시간을 다투는 대모험",
        "🐚 신비로운 바닷속 세계",
        "👑 바뀐 운명, 바뀐 세상",
        "🎣 미시시피 강의 장난꾸러기",
        "🐺 정글의 아이 모글리",
        "✨ 영원히 자라지 않는 소년",
        "🏴‍☠️ 보물을 찾아 떠난 모험",
        "🌈 무지개 너머 마법의 나라",
        "🎭 두 얼굴을 가진 의사",
        "👧 네 자매의 성장 이야기",
        "🌪️ 황야의 비극적 사랑",
        "📖 자존심을 지킨 여인",
        "⚔️ 복수의 백작",
        "🏝️ 무인도에서 살아남기",
        "🧭 거인과 소인의 나라",
        "🛡️ 이상과 현실 사이의 기사",
        "🔴 가슴에 새긴 죄의 글자",
        "💕 첫인상을 넘어서",
        "😈 악마와의 거래",
        "🕯️ 은촛대의 기적",
        "🚂 운명의 기차",
        "⚖️ 양심의 무게",
        "🪲 어느 날 아침 벌레가 되다",
        "🐰 토끼굴 속으로",
        "🐋 하얀 고래를 쫓아서",
        "🌊 마법사의 섬",
        "🌾 어른이 되기 싫어",
        "🎣 포기하지 않는 노인",
        "🐷 동물들의 혁명",
        "💚 초록빛 불빛을 향해",
        "⚖️ 정의를 위한 변호",
        "👁️ 빅 브라더가 보고 있다",
        "🐚 소년들의 섬"
      ];

      // BRAINFIT 세계문학(2) 제목 덮어쓰기
      overrides["BRAINFIT.worldlit.world2"] = [
        "🏹 텔의 용기와 두려움",
        "💪 소년들의 용기와 케이트의 눈물",
        "🏹 로빈 후드의 은밀한 재판",
        "💃 말괄량이 카타리나를 둘러싼 오해와 진실",
        "🍲 올리버의 용기 있는 한마디",
        "🚣 자유를 찾아 떠난 소년",
        "🌸 잠든 정원이 깨어나다",
        "🌍 시간을 다투는 대모험",
        "🐚 신비로운 바닷속 세계",
        "👑 바뀐 운명, 바뀐 세상",
        "🎣 미시시피 강의 장난꾸러기",
        "🐺 정글의 아이 모글리",
        "✨ 영원히 자라지 않는 소년",
        "🏴‍☠️ 보물을 찾아 떠난 모험",
        "🌈 무지개 너머 마법의 나라",
        "🎭 두 얼굴을 가진 의사",
        "👧 네 자매의 성장 이야기",
        "🌪️ 황야의 비극적 사랑",
        "📖 자존심을 지킨 여인",
        "⚔️ 복수의 백작",
        "🏝️ 무인도에서 살아남기",
        "🧭 거인과 소인의 나라",
        "🛡️ 이상과 현실 사이의 기사",
        "🔴 가슴에 새긴 죄의 글자",
        "💕 첫인상을 넘어서",
        "😈 악마와의 거래",
        "🕯️ 은촛대의 기적",
        "🚂 운명의 기차",
        "⚖️ 양심의 무게",
        "🪲 어느 날 아침 벌레가 되다",
        "🐰 토끼굴 속으로",
        "🐋 하얀 고래를 쫓아서",
        "🌊 마법사의 섬",
        "🌾 어른이 되기 싫어",
        "🎣 포기하지 않는 노인",
        "🐷 동물들의 혁명",
        "💚 초록빛 불빛을 향해",
        "⚖️ 정의를 위한 변호",
        "👁️ 빅 브라더가 보고 있다",
        "🐚 소년들의 섬"
      ];

      // 과학분야 생물 제목 덮어쓰기
      overrides["BRAINUP.science.bio"] = [
        "🧬 생물과 무생물의 구분과 관계",
        "🦁 동물의 몸과 생활 방식은 왜 다를까?",
        "🐙 숨은 주인공, 무척추동물의 세계",
        "🐜 작지만 위대한 존재, 곤충의 세계",
        "🦋 완전 탈바꿈과 불완전 탈바꿈의 차이",
        "🌿 식물의 구조와 생존 전략",
        "☀️ 광합성, 지구를 살리는 마법",
        "🔬 세포, 생명의 기본 단위",
        "🧫 세포는 어떻게 분열할까?",
        "🍽️ 음식물의 여행, 소화의 비밀",
        "🩸 온몸을 도는 혈액의 순환",
        "💨 숨 쉬고 내보내는 호흡과 배설",
        "🧠 자극과 반응, 신경계의 작동",
        "🦴 뼈와 근육이 만드는 움직임",
        "🧬 부모를 닮는 이유, 유전의 원리",
        "🔗 DNA, 생명의 설계도",
        "🌍 생태계와 먹이 그물",
        "🔄 자연 속 물질의 순환",
        "🦠 세균과 바이러스의 세계",
        "🧪 생명공학과 미래 사회"
      ];

      // 과학분야 지구과학 제목 덮어쓰기
      overrides["BRAINUP.science.earth"] = [
        "🌍 지구는 어떻게 만들어졌을까?",
        "🌋 마그마가 들려주는 지구의 이야기",
        "🪨 돌은 어떻게 만들어질까?",
        "🏜️ 작은 알갱이가 되기까지, 암석의 삶",
        "🌊 강의 흐름이 빚어낸 자연 조각품",
        "🌋 땅이 흔들리고 불이 솟는다",
        "🏔️ 산과 바다는 어떻게 만들어졌을까",
        "🪨 돌멩이 속에 숨은 지구의 역사",
        "🦴 화석이 들려주는 옛날 이야기",
        "🧲 지구가 거대한 자석이라고?",
        "🌤️ 날씨는 왜 매일 달라질까?",
        "☁️ 구름은 어떻게 만들어질까?",
        "💨 기압과 바람의 관계",
        "🌡️ 기후와 기후 변화",
        "🪐 태양계와 지구의 위치",
        "⛏️ 자원의 분포와 이용",
        "🌊 해류와 조석, 바다의 움직임",
        "⏳ 지구의 역사와 지질 시대",
        "🚀 우주 탐사와 인류의 도전",
        "🌪️ 자연재해와 방재"
      ];

      // ✅ BRAINFIT 과학분야 생물 제목 덮어쓰기
      overrides["BRAINFIT.science.bio"] = [
        "🌱 살아 있다는 건 뭘까?",
        "🐾 왜 치타는 빠르고 나무늘보는 느릴까?",
        "🦑 뼈 없이도 살 수 있어!",
        "🐝 지구의 진짜 지배자, 곤충",
        "🦋 애벌레는 어떻게 나비가 될까?",
        "🌳 움직이지 않고 살아남는 법",
        "☀️ 햇빛을 먹는 생물",
        "🔬 모든 생명은 여기서 시작됐다",
        "✂️ 세포가 자신을 복사하는 방법",
        "🍕 피자 한 조각의 대모험",
        "❤️ 멈추지 않는 심장의 펌프질",
        "💨 들숨과 날숨 사이에 일어나는 일",
        "⚡ 뇌에서 발끝까지 전기 신호",
        "🦴 206개의 뼈가 춤을 춘다",
        "👨‍👩‍👧 왜 나는 부모님을 닮았을까?",
        "🦁 누가 누구를 먹을까?",
        "🏭 지구가 아프면 우리도 아파",
        "🌈 다양한 생물이 지구를 지킨다",
        "🌡️ 지구가 뜨거워지면 생물은 어떻게 될까?",
        "🚀 내일의 생명 과학, 어디까지 갈까?"
      ];

      // ✅ BRAINFIT 과학분야 지구과학 제목 덮어쓰기
      overrides["BRAINFIT.science.earth"] = [
        "🌍 46억 살 지구의 탄생 비밀",
        "🌋 펄펄 끓는 지구 속 용암 여행",
        "🪨 세 가지 얼굴을 가진 암석",
        "🏜️ 바위가 모래가 되는 마법",
        "🌊 물방울이 만든 거대한 협곡",
        "🌋 지구가 화났을 때 일어나는 일",
        "🏔️ 움직이는 땅, 판의 대충돌",
        "🪨 지층이 써 내려간 지구 일기장",
        "🦴 공룡 뼈가 전하는 비밀 메시지",
        "🧲 나침반이 북쪽을 가리키는 이유",
        "🌤️ 하늘이 매일 옷을 갈아입는 이유",
        "☁️ 하늘에 떠다니는 솜사탕의 정체",
        "💨 보이지 않는 공기의 힘겨루기",
        "🌡️ 지구가 열이 나면 생기는 일",
        "🪐 태양의 세 번째 행성, 지구",
        "⛏️ 땅속에 숨겨진 보물을 찾아서",
        "🌊 바다도 강처럼 흐른다고?",
        "⏳ 46억 년을 24시간으로 압축하면",
        "🚀 별을 향해 날아간 사람들",
        "🌪️ 지구의 분노를 피하는 방법"
      ];

      return overrides;
    }

    const unitTitleOverrides = buildUnitTitleOverrides();

    // 단원별 등급 데이터 저장 객체
    let unitGradesData = {};

    /* 4. DOM 캐싱 */
    const domainList = document.getElementById("domainList");
    const subjectList = document.getElementById("subjectList");
    const unitList = document.getElementById("unitList");
    const modal = document.getElementById("pendingModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const unitSearch = document.getElementById("unitSearch");
    let currentUnits = [];

    // 현재 선택된 시리즈/도메인/과목 추적
    let currentSelectedSeries = null;
    let currentSelectedDomain = null;
    let currentSelectedSubject = null;



    // 🚪 로그아웃 모달 관련
const logoutModal = document.getElementById("logoutModal");
const logoutCancelBtn = document.getElementById("logoutCancelBtn");
const logoutConfirmBtn = document.getElementById("logoutConfirmBtn");
let logoutCallback = null;


    function showPendingModal() {
      modal.classList.add("show");
    }

    function hidePendingModal() {
      modal.classList.remove("show");
    }

    // X 버튼 클릭 시: 팝업 닫고 1.5초 후 페이지 새로고침
    closeModalBtn.addEventListener("click", () => {
      hidePendingModal();
      setTimeout(() => {
        location.reload();
      }, 1500);
    });

    modal.addEventListener("click", e => {
      if (e.target === modal) hidePendingModal();
    });

/* 🚪 로그아웃 모달 열기/닫기 */
function showLogoutModal(cb) {
  logoutCallback = cb || null;
  if (logoutModal) logoutModal.classList.add("show");
}
function hideLogoutModal() {
  if (logoutModal) logoutModal.classList.remove("show");
}

if (logoutCancelBtn) {
  logoutCancelBtn.addEventListener("click", () => {
    hideLogoutModal();
    if (logoutCallback) logoutCallback(false);  // 취소
  });
}

if (logoutConfirmBtn) {
  logoutConfirmBtn.addEventListener("click", () => {
    hideLogoutModal();
    if (logoutCallback) logoutCallback(true);   // 확인
  });
}


    

    /* 5. 시리즈 클릭 */
    // 오픈된 시리즈 목록 (BRAINUP, BRAINFIT 오픈)
    const openedSeries = ['BRAINUP', 'BRAINFIT', 'BRAINDEEP'];

    document.querySelectorAll("#seriesList .series-item").forEach(li => {
      li.addEventListener("click", () => {
        const series = li.dataset.series;

        // 오픈되지 않은 시리즈는 준비중 팝업 표시
        if (!openedSeries.includes(series)) {
          showComingSoonPopup();
          return;
        }

        document.querySelectorAll("#seriesList .series-item").forEach(x => x.classList.remove("active"));
        li.classList.add("active");
        currentSelectedSeries = series;
        currentSelectedDomain = null;
        currentSelectedSubject = null;
        renderDomains(series);
        subjectList.innerHTML = "";
        unitList.innerHTML = "";
        document.getElementById("unitTitle").textContent = "단원 선택";
        document.getElementById("unitDesc").textContent =
          seriesInfo[series].desc + " · 분야와 과목을 선택하세요.";
        unitSearch.value = "";

        // ✅ 시리즈 선택을 localStorage에 저장 (새로고침 후 복원용)
        localStorage.setItem('selectedMenuSeries', series);
        console.log('✅ 시리즈 선택 저장:', series);

        // ✅ 시리즈 선택 시 종합리포트 뱃지도 해당 시리즈로 업데이트
        updateRadarGradeBadgeForSeries(series);
      });
    });

    /* ✅ 저장된 메뉴 상태 복원 */
    function restoreMenuState() {
      const savedState = sessionStorage.getItem('menuState');

      // ✅ localStorage에서 저장된 시리즈 확인 (새로고침 후 복원용)
      const savedSeries = localStorage.getItem('selectedMenuSeries');

      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          console.log('🔄 메뉴 상태 복원 시도:', state);

          // 메뉴 상태 사용 후 삭제 (한 번만 복원)
          sessionStorage.removeItem('menuState');

          const seriesKey = state.series || 'BRAINUP';
          currentSelectedSeries = seriesKey;

          // 1. 시리즈 렌더링 및 활성화
          renderDomains(seriesKey);
          document.querySelectorAll("#seriesList .series-item").forEach(li => {
            li.classList.remove("active");
            if (li.dataset.series === seriesKey) {
              li.classList.add("active");
            }
          });

          // 2. 분야(도메인) 복원
          if (state.domainId) {
            const domainData = domainsBySeries[seriesKey] || domainsBySeries["BRAINON"];
            const targetDomain = domainData.find(d => d.id === state.domainId);

            if (targetDomain) {
              currentSelectedDomain = targetDomain;

              // 분야 활성화
              document.querySelectorAll(".domain-item").forEach(li => {
                li.classList.remove("active");
                if (li.dataset.domain === state.domainId) {
                  li.classList.add("active");
                }
              });

              // 세부 과목 렌더링
              renderSubjects(seriesKey, targetDomain);

              // 3. 세부 과목 복원
              if (state.subjectId) {
                const targetSubject = targetDomain.subs.find(s =>
                  s.id === state.subjectId &&
                  (s.offset || null) === (state.subjectOffset || null)
                );

                if (targetSubject) {
                  currentSelectedSubject = targetSubject;

                  // 세부 과목 활성화
                  setTimeout(() => {
                    document.querySelectorAll(".subject-item").forEach(li => {
                      li.classList.remove("active");
                      // offset도 함께 확인하여 정확한 과목 선택 (세계문학(1) vs 세계문학(2) 구분)
                      const liOffset = li.dataset.offset ? parseInt(li.dataset.offset) : null;
                      const stateOffset = state.subjectOffset || null;
                      if (li.dataset.sub === state.subjectId && liOffset === stateOffset) {
                        li.classList.add("active");
                      }
                    });

                    // 배경 이미지 변경 및 단원 목록 렌더링
                    changeBackgroundImage(targetSubject);
                    renderUnits(seriesKey, targetDomain, targetSubject);

                    console.log('✅ 메뉴 상태 복원 완료:', state);
                  }, 100);
                }
              }
            }
          }

          return; // 복원 성공
        } catch (e) {
          console.error('❌ 메뉴 상태 복원 실패:', e);
        }
      }

      // ✅ sessionStorage 상태가 없으면 localStorage의 시리즈 선택 복원
      if (savedSeries && openedSeries.includes(savedSeries)) {
        console.log('🔄 저장된 시리즈 복원:', savedSeries);
        currentSelectedSeries = savedSeries;
        renderDomains(savedSeries);

        // 시리즈 UI 활성화
        document.querySelectorAll("#seriesList .series-item").forEach(li => {
          li.classList.remove("active");
          if (li.dataset.series === savedSeries) {
            li.classList.add("active");
          }
        });

        // 설명 텍스트 업데이트
        document.getElementById("unitTitle").textContent = "단원 선택";
        document.getElementById("unitDesc").textContent =
          seriesInfo[savedSeries].desc + " · 분야와 과목을 선택하세요.";
        return;
      }

      // 저장된 상태 없으면 기본값으로 시작
      currentSelectedSeries = "BRAINUP";
      renderDomains("BRAINUP");
    }

    /* 6. 분야 표시 */
    function renderDomains(seriesKey) {
      domainList.innerHTML = "";
      const domainData = domainsBySeries[seriesKey] || domainsBySeries["BRAINON"];

      domainData.forEach(dom => {
        const li = document.createElement("li");
        li.className = "domain-item";
        li.dataset.domain = dom.id;
        li.innerHTML = `<span>${dom.label}</span><span class="meta">${dom.subs.length}과목</span>`;
        li.addEventListener("click", () => {
          document.querySelectorAll(".domain-item").forEach(x => x.classList.remove("active"));
          li.classList.add("active");
          currentSelectedDomain = dom;
          currentSelectedSubject = null;
          renderSubjects(seriesKey, dom);
          unitList.innerHTML = "";
          document.getElementById("unitTitle").textContent = dom.label;
          document.getElementById("unitDesc").textContent = "세부 과목을 선택하면 01~번호가 표시됩니다.";
          unitSearch.value = "";
        });
        domainList.appendChild(li);
      });
    }

    /* 7. 세부 과목 표시 */
    function renderSubjects(seriesKey, domainObj) {
      subjectList.innerHTML = "";
      domainObj.subs.forEach(sub => {
        const li = document.createElement("li");
        li.className = "subject-item";
        li.dataset.sub = sub.id;
        li.dataset.offset = sub.offset || ''; // ✅ offset 정보 추가
        // 완료 개수 계산 - BRAINUP, BRAINFIT, BRAINDEEP 시리즈 지원
        let completedCount = 0;
        if (seriesKey === 'BRAINUP') {
          completedCount = getCompletedCountForSubject(sub.id, sub.count, sub.offset || 0);
        } else if (seriesKey === 'BRAINFIT') {
          completedCount = getCompletedCountForFitSubject(sub.id, sub.count);
        } else if (seriesKey === 'BRAINDEEP') {
          completedCount = getCompletedCountForDeepSubject(sub.id, sub.count);
        }
        li.innerHTML = `<span>${sub.label}</span><span class="meta">${completedCount}/${sub.count}개</span>`;
        li.addEventListener("click", () => {
          document.querySelectorAll(".subject-item").forEach(x => x.classList.remove("active"));
          li.classList.add("active");
          currentSelectedSubject = sub;
          changeBackgroundImage(sub);  // 배경 이미지 변경 (sub 전체 전달)
          renderUnits(seriesKey, domainObj, sub);
        });
        subjectList.appendChild(li);
      });
    }

    /* 8. 단원 표시 */
    function renderUnits(seriesKey, domainObj, subObj) {
      unitList.innerHTML = "";
      document.getElementById("unitTitle").textContent =
        `${seriesInfo[seriesKey].name} / ${domainObj.label} / ${subObj.label}`;
      document.getElementById("unitDesc").textContent =
        `${subObj.label} ${subObj.count}개 단원입니다.`;

      unitSearch.value = "";
      currentUnits = [];

      // offset이 있는 경우 (예: 세계문학(2), 인물(2)) 별도 키 사용
      const keyId = subObj.offset ? `${subObj.id}_part2` : subObj.id;
      const key = `${seriesKey}.${domainObj.id}.${keyId}`;
      const titles = unitTitleOverrides[key] || [];
      const startNum = (subObj.offset || 0) + 1; // offset이 있으면 시작 번호 조정

      for (let i = 1; i <= subObj.count; i++) {
        const actualNum = startNum + i - 1; // 실제 파일 번호
        const num = String(actualNum).padStart(2, "0");
        // offset이 있는 경우 i-1 인덱스 사용 (1~40 → 0~39)
        const titleIndex = subObj.offset ? (i - 1) : (actualNum - 1);
        let title = titles[titleIndex] || `${subObj.label} ${num} 학습하기`;

        // 파일명 변환: soc→soc_, geo→geo_, law→law_, pol→pol_, bio→bio_, earth→earth_, physics→physics_, chem→chem_, modern→modern_, classic→classic_, world→world_, people→people_
        let filename = `${subObj.id}_${num}.html`;
        if (subObj.id === 'soc') {
          filename = `soc_${num}.html`;
        } else if (subObj.id === 'geo') {
          filename = `geo_${num}.html`;
        } else if (subObj.id === 'law') {
          filename = `law_${num}.html`;
        } else if (subObj.id === 'pol') {
          filename = `pol_${num}.html`;
        } else if (subObj.id === 'bio') {
          filename = `bio_${num}.html`;
        } else if (subObj.id === 'earth') {
          filename = `earth_${num}.html`;
        } else if (subObj.id === 'physics') {
          filename = `physics_${num}.html`;
        } else if (subObj.id === 'chem') {
          filename = `chem_${num}.html`;
        } else if (subObj.id === 'modern') {
          filename = `modern_${num}.html`;
        } else if (subObj.id === 'classic') {
          filename = `classic_${num}.html`;
        } else if (subObj.id === 'world1') {
          filename = `world1_${num}.html`;
        } else if (subObj.id === 'world2') {
          filename = `world2_${num}.html`;
        } else if (subObj.id === 'people') {
          filename = `people_${num}.html`;
        } else if (subObj.id === 'people1') {
          filename = `people1_${num}.html`;
        } else if (subObj.id === 'people2') {
          filename = `people2_${num}.html`;
        }

        // ✅ BRAINFIT/BRAINDEEP 시리즈: BRAINUP 폴더의 fit_/deep_ 파일 사용
        let actualSeriesKey = seriesKey;

        if (seriesKey === 'BRAINFIT') {
          actualSeriesKey = 'BRAINUP';
          filename = `fit_${filename}`;
        } else if (seriesKey === 'BRAINDEEP') {
          actualSeriesKey = 'BRAINUP';
          filename = `deep_${filename}`;
        }

        currentUnits.push({
          label: `${subObj.label} ${num} ${title}`.trim(),
          num,
          path: `./${actualSeriesKey}/${domainObj.id}/${filename}`
        });
      }

      renderUnitList(currentUnits);
    }

    /* 9. 단원 리스트 출력 */
    async function renderUnitList(units) {
      // 단원 등급 데이터 로드
      unitGradesData = await fetchUnitGrades();
      unitList.innerHTML = "";
      units.forEach((u, unitIndex) => {
        const li = document.createElement("li");
        li.className = "unit-item";
        li.dataset.page = u.path;
        li.dataset.unitIndex = unitIndex;  // 단원 인덱스 저장

        // 과제 데이터 저장 (드래그/모바일 추가용)
        li.dataset.taskData = JSON.stringify({
          unitId: u.path,
          title: u.label,
          series: currentSelectedSeries ? seriesInfo[currentSelectedSeries].name : '',
          domain: currentSelectedDomain ? currentSelectedDomain.label : '',
          subject: currentSelectedSubject ? currentSelectedSubject.label : ''
        });

        // 단원 ID 추출 (예: "BRAINUP/social/geo_01.html" → "geo_01")
        let unitId = u.path.split('/').pop().replace('.html', '');
        li.dataset.unitId = unitId;  // 단원 ID 저장

        // ✅ world2_XX, people2_XX 형식 그대로 사용 (서버 API와 동일하게)
        // 서버에서 world2_XX 형식 그대로 저장하므로 변환하지 않음

        // 해당 단원의 등급 정보 가져오기
        const gradeInfo = unitGradesData[unitId];
        const stars = gradeInfo ? getStarsForGrade(gradeInfo.grade) : '';

        // 단원 렌더링 (잠금 표시는 클릭 시 체크)
        li.innerHTML = `
          <span>${u.label}</span>
          <span class="unit-right">
            ${stars ? `<span class="unit-stars">${stars}</span>` : ''}
            <span class="status-badge status-default" draggable="true">✏️ 미완료</span>
          </span>
        `;

        // 단원 클릭 이벤트
        li.addEventListener("click", async (e) => {
          // 상태 뱃지 클릭 시에는 단원 열기 방지
          if (e.target.classList.contains('status-badge')) {
            return;
          }

          // 🔒 실시간 잠금 체크 (캐시 사용)
          const saved = localStorage.getItem('currentStudent');
          if (saved) {
            try {
              const student = JSON.parse(saved);
              const data = await ApiCache.fetch(`/api/gate-quiz/status?grade=${encodeURIComponent(student.grade)}&name=${encodeURIComponent(student.name)}`);

              if (data && data.ok) {
                // 전역 변수 업데이트
                passedGates = data.highestPassedGate || 0;
                completedUnitsCount = data.completedUnits || 0;
                completedUnitIds = data.completedUnitIds || [];

                console.log(`[Lock Check] API 응답 - 통과관문:${passedGates}, 완료단원:${completedUnitsCount}, 클릭단원:${unitId}`);

                // 잠금 체크
                if (!canAccessUnit(unitId)) {
                  const requiredGate = getRequiredGate();
                  showLockModal(requiredGate);
                  return;
                }
              }
            } catch (err) {
              console.error('[Lock Check Error]', err);
            }
          }

          // 단원 파일 존재 여부 확인
          fetch(u.path, { method: "HEAD" })
            .then(res => {
              if (res.ok) {
                openUnitModal(u.path);
              } else {
                showPendingModal();
              }
            })
            .catch(() => showPendingModal());
        });

        // 상태 뱃지 드래그 이벤트
        const statusBadge = li.querySelector('.status-badge');

        // PC: 드래그 앤 드롭
        statusBadge.addEventListener('dragstart', (e) => {
          e.stopPropagation();
          li.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'copy';
          e.dataTransfer.setData('text/plain', li.dataset.taskData);
        });

        statusBadge.addEventListener('dragend', (e) => {
          li.classList.remove('dragging');
        });

        // 모바일: 클릭으로 과제부여 팝업
        statusBadge.addEventListener('click', (e) => {
          e.stopPropagation();
          showAssignTaskModal(li.dataset.taskData);
        });

        unitList.appendChild(li);
      });

      // 목록 그릴 때마다 저장된 완료 상태 다시 반영
      restoreProgressOnRenderedList();
    }

    /* 10. 검색 */
    unitSearch.addEventListener("input", (e) => {
      const q = e.target.value.trim();
      if (!q) {
        renderUnitList(currentUnits);
        return;
      }
      const filtered = currentUnits.filter(u =>
        u.label.includes(q) || u.num.includes(q)
      );
      renderUnitList(filtered);
    });

    // ✅ 상태를 바꾸는 공용 함수
    function updateLessonStatus(pageKey, status) {
      const li = document.querySelector(`.unit-item[data-page="${pageKey}"]`);
      if (!li) return;
      const badge = li.querySelector('.status-badge');
      if (!badge) return;

      badge.classList.remove('status-default', 'status-done');

      if (status === 'done') {
        badge.classList.add('status-done');
        badge.textContent = '🏆 학습완료';
      } else {
        badge.classList.add('status-default');
        badge.textContent = '✏️ 미완료';
      }
    }

    /* 🔐 학생 정보 가져오기 */
    function getCurrentStudent() {
      const saved = localStorage.getItem('currentStudent');
      if (!saved) return null;
      try { return JSON.parse(saved); }
      catch(e) { return null; }
    }

    /* 🔐 학생키 만들기 (로그인 페이지랑 같은 규칙) */
    function buildStudentKey(stu) {
      const cleanPhone = (stu.phone || '').replace(/\D/g, '');
      const cleanName = (stu.name || '').trim();
      const cleanGrade = (stu.grade || '').trim();
      return `${cleanGrade}_${cleanName}_${cleanPhone}`;
    }

    /* ⭐ 단원별 등급 데이터 가져오기 (캐시 사용) */
    async function fetchUnitGrades() {
      try {
        const stu = getCurrentStudent();
        if (!stu) {
          console.log('⭐ 로그인된 학생 정보 없음');
          return {};
        }

        const url = `/api/unit-grades?grade=${encodeURIComponent(stu.grade || '')}&name=${encodeURIComponent(stu.name || '')}`;
        const data = await ApiCache.fetch(url);
        console.log('⭐ 단원 등급 데이터 로드:', Object.keys(data).length, '개');
        // 디버그: fit_world1 관련 키 모두 출력
        const world1Keys = Object.keys(data).filter(k => k.includes('world1'));
        console.log('⭐ [디버그] fit_world1 관련 키:', world1Keys);
        return data;
      } catch (error) {
        console.error('⭐ 단원 등급 조회 오류:', error);
        return {};
      }
    }

    /* ⭐ 등급별 별 개수 반환 */
    function getStarsForGrade(grade) {
      const starsMap = {
        '우수': '⭐⭐⭐⭐⭐',
        '양호': '⭐⭐⭐⭐',
        '보통': '⭐⭐⭐',
        '격려': '⭐⭐'
      };
      return starsMap[grade] || '';
    }

    /* ✅ 현재 로그인한 학생의 완료 리스트 불러오기 */
    function getStudentProgressList() {
      const stu = getCurrentStudent();
      if (!stu) return [];  // 로그인 안 되어 있으면 빈배열
      const stuKey = buildStudentKey(stu);
      const progressKey = `dan-progress:${stuKey}`;
      return JSON.parse(localStorage.getItem(progressKey) || '[]');
    }

    // ⭐ 세부 과목별 완료된 단원 개수 계산
    function getCompletedCountForSubject(subjectId, totalCount, offset = 0) {
      const stu = getCurrentStudent();
      if (!stu) return 0;

      const stuKey = buildStudentKey(stu);
      const keyPrefix = `dan-progress:${stuKey}:`;

      let completedCount = 0;
      // offset이 있으면 (offset+1)부터 시작 (예: 세계문학(2)는 41~80)
      for (let i = offset + 1; i <= offset + totalCount; i++) {
        const num = String(i).padStart(2, "0");
        const unitCode = `${subjectId}_${num}`; // world_41, world_42, ...
        const storageKey = keyPrefix + unitCode;

        try {
          const data = localStorage.getItem(storageKey);
          if (data) {
            const saved = JSON.parse(data);
            if (Array.isArray(saved) && saved.length > 0) {
              completedCount++;
            }
          }
        } catch(e) {
          // ignore
        }
      }
      return completedCount;
    }

    // ⭐ BRAINFIT 시리즈 과목별 완료된 단원 개수 계산 (fit_bio_01 형태)
    function getCompletedCountForFitSubject(subjectId, totalCount) {
      const stu = getCurrentStudent();
      if (!stu) return 0;

      const stuKey = buildStudentKey(stu);
      const keyPrefix = `dan-progress:${stuKey}:`;

      let completedCount = 0;
      for (let i = 1; i <= totalCount; i++) {
        const num = String(i).padStart(2, "0");
        const unitCode = `fit_${subjectId}_${num}`; // fit_bio_01, fit_earth_02, ...
        const storageKey = keyPrefix + unitCode;

        try {
          const data = localStorage.getItem(storageKey);
          if (data) {
            // '1' 형식(레거시)과 배열 형식 모두 지원
            if (data === '1' || data === '"1"') {
              completedCount++;
            } else {
              const saved = JSON.parse(data);
              if (Array.isArray(saved) && saved.length > 0) {
                completedCount++;
              }
            }
          }
        } catch(e) {
          // ignore
        }
      }
      return completedCount;
    }

    // ⭐ BRAINDEEP 시리즈 과목별 완료된 단원 개수 계산 (deep_bio_01 형태)
    function getCompletedCountForDeepSubject(subjectId, totalCount) {
      const stu = getCurrentStudent();
      if (!stu) return 0;

      const stuKey = buildStudentKey(stu);
      const keyPrefix = `dan-progress:${stuKey}:`;

      let completedCount = 0;
      for (let i = 1; i <= totalCount; i++) {
        const num = String(i).padStart(2, "0");
        const unitCode = `deep_${subjectId}_${num}`; // deep_bio_01, deep_earth_02, ...
        const storageKey = keyPrefix + unitCode;

        try {
          const data = localStorage.getItem(storageKey);
          if (data) {
            // '1' 형식(레거시)과 배열 형식 모두 지원
            if (data === '1' || data === '"1"') {
              completedCount++;
            } else {
              const saved = JSON.parse(data);
              if (Array.isArray(saved) && saved.length > 0) {
                completedCount++;
              }
            }
          }
        } catch(e) {
          // ignore
        }
      }
      return completedCount;
    }

    // 🔄 서버에서 최신 완료 상태 가져와서 localStorage에 저장
    async function syncCompletionStatusFromServer() {
      try {
        const stu = getCurrentStudent();
        if (!stu) return;

        const stuKey = buildStudentKey(stu);
        const keyPrefix = `dan-progress:${stuKey}:`;

        // ✅ BRAINUP과 BRAINFIT 시리즈 모두 가져오기
        const urlBrainUp = `/api/completion-status?grade=${encodeURIComponent(stu.grade || '')}&name=${encodeURIComponent(stu.name || '')}&series=BRAIN업`;
        const urlBrainFit = `/api/completion-status?grade=${encodeURIComponent(stu.grade || '')}&name=${encodeURIComponent(stu.name || '')}&series=BRAIN핏`;

        const [dataBrainUp, dataBrainFit] = await Promise.all([
          ApiCache.fetch(urlBrainUp),
          ApiCache.fetch(urlBrainFit)
        ]);

        console.log('[syncCompletionStatus] BRAINUP 응답:', dataBrainUp);
        console.log('[syncCompletionStatus] BRAINFIT 응답:', dataBrainFit);

        // 두 시리즈의 completedUnits 합치기
        let allCompletedUnits = [];
        if (dataBrainUp && dataBrainUp.ok && Array.isArray(dataBrainUp.completedUnits)) {
          allCompletedUnits = allCompletedUnits.concat(dataBrainUp.completedUnits);
        }
        if (dataBrainFit && dataBrainFit.ok && Array.isArray(dataBrainFit.completedUnits)) {
          // ✅ BRAINFIT 단원은 fit_ 접두어 추가 (DB에 bio_01로 저장되어 있음 → fit_bio_01로 변환)
          const fitUnits = dataBrainFit.completedUnits.map(unit => {
            // 이미 fit_ 접두어가 있으면 그대로, 없으면 추가
            return unit.startsWith('fit_') ? unit : `fit_${unit}`;
          });
          allCompletedUnits = allCompletedUnits.concat(fitUnits);
        }

        if (allCompletedUnits.length === 0) {
          console.warn('[syncCompletionStatus] 완료된 단원 없음');
          return;
        }

        console.log('[syncCompletionStatus] 총 완료 단원:', allCompletedUnits.length);

        // 기존 로직 유지 (data.completedUnits → allCompletedUnits로 변경)
        if (allCompletedUnits.length > 0) {
          allCompletedUnits.forEach(unit => {
            const key = keyPrefix + unit;
            // 배열 형식으로 저장 (학습 페이지와 동일한 방식)
            let saved = [];
            try {
              const existing = localStorage.getItem(key);
              if (existing) {
                saved = JSON.parse(existing);
                if (!Array.isArray(saved)) saved = [];
              }
            } catch(e) {
              saved = [];
            }

            // 기본 페이지 ID 추가 (비어있으면)
            // ✅ 단원 코드에 따라 올바른 폴더 설정 (FIT/DEEP 시리즈 포함)
            if (saved.length === 0) {
              let folder = 'social';  // 기본값
              // FIT 시리즈: fit_bio_01, fit_earth_02 등
              if (unit.startsWith('fit_bio_') || unit.startsWith('fit_chem_') ||
                  unit.startsWith('fit_physics_') || unit.startsWith('fit_earth_')) {
                folder = 'science';
              } else if (unit.startsWith('fit_modern_') || unit.startsWith('fit_classic_')) {
                folder = 'korlit';
              } else if (unit.startsWith('fit_world_') || unit.startsWith('fit_world1_') || unit.startsWith('fit_world2_')) {
                folder = 'worldlit';
              } else if (unit.startsWith('fit_people_') || unit.startsWith('fit_people1_') || unit.startsWith('fit_people2_')) {
                folder = 'person';
              }
              // DEEP 시리즈: deep_bio_01, deep_earth_02 등
              else if (unit.startsWith('deep_bio_') || unit.startsWith('deep_chem_') ||
                  unit.startsWith('deep_physics_') || unit.startsWith('deep_earth_')) {
                folder = 'science';
              } else if (unit.startsWith('deep_modern_') || unit.startsWith('deep_classic_')) {
                folder = 'korlit';
              } else if (unit.startsWith('deep_world_') || unit.startsWith('deep_world1_') || unit.startsWith('deep_world2_')) {
                folder = 'worldlit';
              } else if (unit.startsWith('deep_people_') || unit.startsWith('deep_people1_') || unit.startsWith('deep_people2_')) {
                folder = 'person';
              }
              // BRAINUP 시리즈
              else if (unit.startsWith('bio_') || unit.startsWith('chem_') ||
                  unit.startsWith('physics_') || unit.startsWith('earth_')) {
                folder = 'science';
              } else if (unit.startsWith('classic_') || unit.startsWith('modern_')) {
                folder = 'korlit';
              } else if (unit.startsWith('world1_') || unit.startsWith('world2_') || unit.startsWith('world_')) {
                folder = 'worldlit';
              } else if (unit.startsWith('people1_') || unit.startsWith('people2_') || unit.startsWith('people_')) {
                folder = 'person';
              }
              saved.push(`BRAINUP_${folder}_${unit}`);
            }

            localStorage.setItem(key, JSON.stringify(saved));
            console.log('[syncCompletionStatus] 저장:', key);
          });

          console.log('[syncCompletionStatus] 완료 상태 동기화 완료:', allCompletedUnits.length, '개');
        }
      } catch (e) {
        console.warn('[syncCompletionStatus] 오류', e);
      }
    }

    // ✅ localStorage에 저장해둔 완료된 단원들을 메뉴에 반영 (학생별)
    function restoreProgressOnRenderedList() {
      const stu = getCurrentStudent();
      if (!stu) return;

      // 1️⃣ 기존 방식: 배열로 저장된 완료 목록 (하위 호환)
      const saved = getStudentProgressList(); // ["./BRAINUP/social/geo_01.html", ...]
      saved.forEach(pageKey => {
        updateLessonStatus(pageKey, 'done');
      });

      // 2️⃣ 새 방식: 개별 키로 저장된 완료 상태 (학습 페이지와 동일한 방식)
      const stuKey = buildStudentKey(stu);
      const keyPrefix = `dan-progress:${stuKey}:`;

      // 현재 화면에 표시된 모든 단원 li 순회
      document.querySelectorAll('.unit-item').forEach(li => {
        const pageKey = li.dataset.page; // "./BRAINUP/social/geo_01.html"
        if (!pageKey) return;

        // 경로에서 단원 코드 추출 (geo_01, geo_02 등)
        const match = pageKey.match(/\/([^\/]+)\.html$/);
        if (!match) return;
        const unitCode = match[1]; // "geo_01"

        // localStorage에서 완료 상태 확인 (배열 방식 + 레거시 '1' 형식)
        const storageKey = keyPrefix + unitCode;
        let isCompleted = false;
        try {
          const data = localStorage.getItem(storageKey);
          if (data) {
            // '1' 형식(레거시)과 배열 형식 모두 지원
            if (data === '1' || data === '"1"') {
              isCompleted = true;
            } else {
              const saved = JSON.parse(data);
              if (Array.isArray(saved) && saved.length > 0) {
                isCompleted = true;
              }
            }
          }
        } catch(e) {
          // ignore
        }

        // 완료 상태면 표시
        if (isCompleted) {
          updateLessonStatus(pageKey, 'done');
        }
      });
    }

    // ✅ 세부과목 리스트의 완료 개수(X/20개) 업데이트 (sync 완료 후 호출)
    function updateSubjectCompletionCounts() {
      // 현재 선택된 시리즈 확인
      const seriesKey = currentSelectedSeries || 'BRAINUP';

      // 현재 화면에 표시된 모든 세부과목 li 순회
      document.querySelectorAll('.subject-item').forEach(li => {
        const subId = li.dataset.sub;
        const offset = li.dataset.offset ? parseInt(li.dataset.offset) : 0;
        if (!subId) return;

        // 현재 도메인에서 해당 과목 정보 찾기
        const domainData = domainsBySeries[seriesKey] || domainsBySeries["BRAINON"];
        let subInfo = null;
        for (const dom of domainData) {
          const found = dom.subs.find(s => s.id === subId && (s.offset || 0) === offset);
          if (found) {
            subInfo = found;
            break;
          }
        }
        if (!subInfo) return;

        // 완료 개수 다시 계산
        let completedCount = 0;
        if (seriesKey === 'BRAINUP') {
          completedCount = getCompletedCountForSubject(subInfo.id, subInfo.count, subInfo.offset || 0);
        } else if (seriesKey === 'BRAINFIT') {
          completedCount = getCompletedCountForFitSubject(subInfo.id, subInfo.count);
        } else if (seriesKey === 'BRAINDEEP') {
          completedCount = getCompletedCountForDeepSubject(subInfo.id, subInfo.count);
        }

        // .meta 부분만 업데이트
        const metaSpan = li.querySelector('.meta');
        if (metaSpan) {
          metaSpan.textContent = `${completedCount}/${subInfo.count}개`;
        }
      });

      console.log('[updateSubjectCompletionCounts] 세부과목 완료 개수 업데이트 완료');
    }

    /* 🔋 로딩 오버레이 제어 (단원 이동용) */
    function hideLoadingScreen() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.remove('show');
    }

    function showLoadingScreen(targetUrl) {
      const overlay = document.getElementById('loadingOverlay');
      const bar = document.getElementById('loadingBar');
      const percent = document.getElementById('loadingPercent');
      const emoji = document.querySelector('.loading-emoji');
      const title = document.querySelector('.loading-title');
      const msg = document.querySelector('.loading-msg');

      if (!overlay || !bar || !percent) {
        window.location.href = targetUrl;
        return;
      }

      overlay.classList.add('show');
      // 기본 모드는 학습 로딩 스타일 유지
      if (emoji) emoji.textContent = '🐋';
      if (title) title.textContent = '로딩 중...';
      if (msg) msg.textContent = '학습 자료를 준비하고 있어요.';

      bar.style.width = '0%';
      percent.textContent = '0%';

      let p = 0;
      const timer = setInterval(() => {
        p += 5;
        if (p > 100) p = 100;
        bar.style.width = p + '%';
        percent.textContent = p + '%';

        if (p === 100) {
          clearInterval(timer);
          setTimeout(() => {
            window.location.href = targetUrl;
          }, 500);
        }
      }, 80);
    }

    window.onbeforeunload = () => {
      hideLoadingScreen();
    };

    // 🐋 로그인 시 챗봇 뱃지 초기화 (매일 자정 10개 리셋)
    function initChatbotBadgeOnLogin() {
      const userStr = sessionStorage.getItem('user');
      if (!userStr) return;

      try {
        const user = JSON.parse(userStr);
        const chatbotBadgeKey = `chatbotBadge_${user.grade}_${user.name}`;
        const chatbotBadgeDateKey = `chatbotBadgeDate_${user.grade}_${user.name}`;

        const today = new Date().toISOString().split('T')[0];
        const savedDate = localStorage.getItem(chatbotBadgeDateKey);

        // 날짜가 다르면 10개로 리셋
        if (savedDate !== today) {
          localStorage.setItem(chatbotBadgeKey, '10');
          localStorage.setItem(chatbotBadgeDateKey, today);
          console.log('🐋 [로그인] 챗봇 뱃지 10개로 초기화');
        } else {
          console.log('🐋 [로그인] 오늘 이미 초기화됨, 기존 뱃지 유지');
        }
      } catch(e) {
        console.error('챗봇 뱃지 초기화 오류:', e);
      }
    }

    // 🔻 상단 사용자 표시: localStorage가 우선, 없으면 URL 파라미터
    function showUserInfo() {
      const infoTarget = document.getElementById("user-info");
      if (!infoTarget) return;

      const stu = getCurrentStudent();
      if (stu) {
        infoTarget.textContent = `${stu.grade || ''} ${stu.name || ''}님 환영합니다!`.trim();
      } else {
        infoTarget.textContent = "로그인이 필요합니다.";
      }
    }

        // 실제로 로그아웃 실행하는 함수 (버튼/뒤로가기에서 공용으로 사용)
    async function performLogout() {
      const btn = document.getElementById('logoutBtn');
      const overlay = document.getElementById('loadingOverlay');
      const bar = document.getElementById('loadingBar');
      const percent = document.getElementById('loadingPercent');
      const emoji = document.querySelector('.loading-emoji');
      const title = document.querySelector('.loading-title');
      const msg = document.querySelector('.loading-msg');

      // 🔄 로딩 오버레이를 "로그아웃 모드"로 사용
      if (overlay && bar && percent) {
        overlay.classList.add('show');
        if (emoji) emoji.textContent = '🚪';
        if (title) title.textContent = '로그아웃 중...';
        if (msg) msg.textContent = '잠시 후 로그인 화면으로 이동합니다.';

        bar.style.width = '0%';
        percent.textContent = '0%';
      }

      if (btn) btn.disabled = true;

      let progressTimer = null;
      if (bar && percent) {
        progressTimer = setInterval(() => {
          let current = parseInt(percent.textContent) || 0;
          if (current < 95) {
            current += 5;
            bar.style.width = current + '%';
            percent.textContent = current + '%';
          }
        }, 80);
      }

      try {
        // 현재 학생 정보 제거
        localStorage.removeItem('currentStudent');

        await fetch("/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
      } catch (e) {
        console.error("logout error", e);
      } finally {
        if (bar && percent) {
          bar.style.width = '100%';
          percent.textContent = '100%';
        }
        if (progressTimer) clearInterval(progressTimer);

        setTimeout(() => {
          window.location.href = "/";
        }, 400);
      }
    }


    // ✅ 잘못된 localStorage 키 자동 정리 (더 이상 사용하지 않음)
    // NOTE: world1_, world2_, people1_, people2_ 형식이 이제 정상 단원 코드이므로 삭제하지 않음
    function cleanupWrongUnitKeys() {
      // 정리할 패턴 없음 (모든 패턴이 정상 코드로 사용됨)
      const wrongPatterns = [];
      const keysToRemove = [];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('dan-progress:')) {
          for (const pattern of wrongPatterns) {
            if (key.includes(pattern)) {
              keysToRemove.push(key);
              break;
            }
          }
        }
      }

      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        console.log('[cleanupWrongUnitKeys] 삭제:', key);
      });

      if (keysToRemove.length > 0) {
        console.log('[cleanupWrongUnitKeys] 총', keysToRemove.length, '개의 잘못된 키 삭제 완료');
      }
    }

    // ✅ 페이지 로드 시: 유저정보 반영 + 뒤로가기용 히스토리 1단계 쌓기
    document.addEventListener('DOMContentLoaded', () => {
      // 🧹 잘못된 localStorage 키 정리 (world2_XX, people2_XX 등)
      cleanupWrongUnitKeys();

      // 🤖 로그인 직후 AI 학습 인식 화면 표시 + 새로고침
      const justLoggedIn = sessionStorage.getItem('justLoggedIn');
      const aiRecognitionDone = sessionStorage.getItem('aiRecognitionDone');

      if (justLoggedIn === 'true' && aiRecognitionDone !== 'true') {
        // 플래그 제거 (무한 루프 방지)
        sessionStorage.removeItem('justLoggedIn');
        sessionStorage.setItem('aiRecognitionDone', 'true');

        // 🐋 로그인 시 챗봇 뱃지 10개 초기화 (매일 자정 리셋)
        initChatbotBadgeOnLogin();

        // 1.5초 후 새로고침
        setTimeout(() => {
          location.reload();
        }, 1500);
        return; // 나머지 초기화 코드 실행 중단
      }

      // AI 인식 완료 후에는 플래그 정리
      if (aiRecognitionDone === 'true') {
        sessionStorage.removeItem('aiRecognitionDone');
      }

      // ✅ URL 파라미터에서 grade와 name을 읽어서 localStorage에 저장 (관리자 페이지에서 이동 시)
      const urlParams = new URLSearchParams(window.location.search);
      const gradeFromUrl = urlParams.get('grade');
      const nameFromUrl = urlParams.get('name');

      if (gradeFromUrl && nameFromUrl) {
        console.log('📥 URL에서 학생 정보 감지:', gradeFromUrl, nameFromUrl);
        const studentData = {
          grade: gradeFromUrl,
          name: nameFromUrl
        };
        localStorage.setItem('currentStudent', JSON.stringify(studentData));
        console.log('✅ currentStudent 저장 완료');
      } else {
        console.log('ℹ️ URL 파라미터 없음 - 기존 localStorage 사용');
      }

      showUserInfo();

      // 현재 메뉴 페이지를 한 번 더 push해서,
      // 첫 번째 뒤로가기는 popstate만 발생하고 화면은 그대로 있게 만들기
      if (window.history && window.history.pushState) {
        history.pushState({ page: 'menu' }, '', location.href);
      }

      // ✅ AI 과제 알림 체크 (당일 첫 로그인만)
      checkAITaskNotification();

      // ✅ 관리자 부여 과제 확인 팝업
      checkAssignedTasks();

      // 🎉 배경 빈 공간 클릭 시 폭죽 효과 + 학습 진도 갱신
      // Debounce timer to prevent duplicate sync calls
      let syncDebounceTimer = null;

      document.body.addEventListener('click', function(e) {
        // 클릭한 요소가 버튼, 링크, 입력 필드 등이 아닌 경우에만 폭죽 실행
        const clickedElement = e.target;
        const isInteractiveElement = clickedElement.closest('button, a, input, select, textarea, .series-item, .domain-item, .subject-item, .unit-item');

        if (!isInteractiveElement) {
          // 클릭 위치를 기준으로 폭죽 터뜨리기
          const x = e.clientX / window.innerWidth;
          const y = e.clientY / window.innerHeight;

          confetti({
            particleCount: 150,
            spread: 80,
            origin: { x: x, y: y },
            colors: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#ffd700', '#ff6b6b']
          });

          // Clear existing sync timer
          if (syncDebounceTimer) {
            clearTimeout(syncDebounceTimer);
          }

          // 🔄 폭죽 효과 후 학습 완료 상태 갱신 (페이지 새로고침 없이)
          syncDebounceTimer = setTimeout(async () => {
            console.log('🔄 서버에서 최신 데이터 가져오는 중...');
            await syncCompletionStatusFromServer(); // 서버에서 최신 완료 상태 가져오기
            console.log('🔄 UI 업데이트 중...');
            restoreProgressOnRenderedList(); // UI에 반영
            updateSubjectCompletionCounts(); // ✅ 세부과목 완료 개수 업데이트
            console.log('✅ 학습 진도 갱신 완료!');
            syncDebounceTimer = null;
          }, 800); // 폭죽 효과 감상 후 업데이트
        }
      });
    });

    // === AI 과제 알림 체크 (당일 첫 로그인만) ===
    async function checkAITaskNotification() {
      try {
        const user = JSON.parse(localStorage.getItem('currentStudent') || '{}');
        if (!user.grade || !user.name) return;

        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        const lastNotificationDate = localStorage.getItem('lastAINotificationDate');

        // 오늘 이미 알림을 받았으면 표시 안 함
        if (lastNotificationDate === today) {
          console.log('🔔 AI 과제 알림: 이미 오늘 확인함');
          return;
        }

        // 마지막 AI 부여 시간 조회 (캐시 사용)
        const data = await ApiCache.fetch(`/api/ai-task/last-assigned?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`);

        if (data.ok && data.lastAIAssignedAt) {
          const lastAssigned = new Date(data.lastAIAssignedAt).toISOString().split('T')[0];

          // 오늘 AI가 과제를 부여했으면 알림 표시
          if (lastAssigned === today) {
            showMessage(
              '🤖',
              'AI고래쌤이 새 과제를 추천했어요!',
              '학습실을 확인해보세요. 맞춤형 복습 과제가 준비되어 있습니다.'
            );

            // 오늘 알림 표시했음을 기록
            localStorage.setItem('lastAINotificationDate', today);
            console.log('🔔 AI 과제 알림: 새 과제 알림 표시');
          }
        }
      } catch (error) {
        console.error('❌ AI 과제 알림 체크 오류:', error);
      }
    }

    // === 관리자 부여 과제 확인 팝업 ===
    async function checkAssignedTasks() {
      try {
        const user = JSON.parse(localStorage.getItem('currentStudent') || '{}');
        if (!user.grade || !user.name) return;

        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        const taskPopupHideDate = localStorage.getItem('taskPopupHideDate');

        // "오늘 하루 보지 않기"를 선택했으면 표시 안 함
        if (taskPopupHideDate === today) {
          console.log('📋 과제 팝업: 오늘 하루 보지 않기 설정됨');
          return;
        }

        // 과제 목록 조회 (캐시 사용)
        const data = await ApiCache.fetch(`/api/user-progress/study-room?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`);

        if (data.ok && data.assignedTasks && data.assignedTasks.length > 0) {
          const pendingTasks = data.assignedTasks.filter(t => t.status === 'pending');

          if (pendingTasks.length > 0) {
            showAssignedTasksPopup(pendingTasks);
          }
        }
      } catch (error) {
        console.error('❌ 과제 확인 오류:', error);
      }
    }

    // 과제 팝업 표시 함수
    function showAssignedTasksPopup(tasks) {
      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      overlay.id = 'assignedTasksOverlay';
      overlay.style.display = 'flex';
      overlay.style.zIndex = '10000';

      const taskList = tasks.slice(0, 5).map(task =>
        `<li>📚 ${task.field} > ${task.subject} > ${task.title || task.unitId}</li>`
      ).join('');

      const moreText = tasks.length > 5 ? `<p style="color: #6b7280; font-size: 14px; margin-top: 8px;">외 ${tasks.length - 5}개 더 있습니다</p>` : '';

      overlay.innerHTML = `
        <div class="assign-modal">
          <div class="assign-modal-header">
            <h3>📚 새로운 과제가 있습니다!</h3>
          </div>
          <div class="assign-modal-body">
            <p style="margin-bottom: 12px;">총 <strong>${tasks.length}개</strong>의 과제가 부여되었습니다.</p>
            <ul style="text-align: left; padding-left: 20px; margin: 12px 0;">
              ${taskList}
            </ul>
            ${moreText}
            <p style="margin-top: 16px;">좌측 상단의 <strong>학습실</strong>에서 확인하세요!</p>
          </div>
          <div class="assign-modal-footer">
            <button class="btn-cancel" id="hideTodayBtn">오늘 하루 보지 않기</button>
            <button class="btn-confirm" id="confirmTaskBtn">확인</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      // 확인 버튼
      document.getElementById('confirmTaskBtn').addEventListener('click', () => {
        document.body.removeChild(overlay);
      });

      // 오늘 하루 보지 않기 버튼
      document.getElementById('hideTodayBtn').addEventListener('click', () => {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem('taskPopupHideDate', today);
        document.body.removeChild(overlay);
        console.log('📋 과제 팝업: 오늘 하루 보지 않기 설정');
      });

      // 오버레이 클릭 시 닫기
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      });
    }

    // ✅ 실제 로그아웃 처리 공용 함수 (헤더 버튼/뒤로가기 공용 사용)
    async function doLogoutWithAnimation() {
      const overlay = document.getElementById('loadingOverlay');
      const bar = document.getElementById('loadingBar');
      const percent = document.getElementById('loadingPercent');
      const emoji = document.querySelector('.loading-emoji');
      const title = document.querySelector('.loading-title');
      const msg = document.querySelector('.loading-msg');

      // 🔄 로딩 오버레이를 "로그아웃 모드"로 사용
      if (overlay && bar && percent) {
        overlay.classList.add('show');
        if (emoji) emoji.textContent = '🚪';
        if (title) title.textContent = '로그아웃 중...';
        if (msg) msg.textContent = '잠시 후 로그인 화면으로 이동합니다.';

        bar.style.width = '0%';
        percent.textContent = '0%';
      }

      let progressTimer = null;
      if (bar && percent) {
        progressTimer = setInterval(() => {
          let current = parseInt(percent.textContent) || 0;
          if (current < 95) {
            current += 5;
            bar.style.width = current + '%';
            percent.textContent = current + '%';
          }
        }, 80);
      }

      try {
        // 현재 학생 정보 제거
        localStorage.removeItem('currentStudent');

        await fetch("/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
      } catch (e) {
        console.error("logout error", e);
      } finally {
        if (bar && percent) {
          bar.style.width = '100%';
          percent.textContent = '100%';
        }
        if (progressTimer) clearInterval(progressTimer);

        setTimeout(() => {
          window.location.href = "/";
        }, 400);
      }
    }

async function performLogout() {
  const btn = document.getElementById('logoutBtn');
  const overlay = document.getElementById('loadingOverlay');
  const bar = document.getElementById('loadingBar');
  const percent = document.getElementById('loadingPercent');
  const emoji = document.querySelector('.loading-emoji');
  const title = document.querySelector('.loading-title');
  const msg = document.querySelector('.loading-msg');

  if (overlay && bar && percent) {
    overlay.classList.add('show');
    if (emoji) emoji.textContent = '🚪';
    if (title) title.textContent = '로그아웃 중...';
    if (msg) msg.textContent = '잠시 후 로그인 화면으로 이동합니다.';

    bar.style.width = '0%';
    percent.textContent = '0%';
  }

  if (btn) btn.disabled = true;

  let progressTimer = null;
  if (bar && percent) {
    progressTimer = setInterval(() => {
      let current = parseInt(percent.textContent) || 0;
      if (current < 95) {
        current += 5;
        bar.style.width = current + '%';
        percent.textContent = current + '%';
      }
    }, 80);
  }

  try {
    localStorage.removeItem('currentStudent');

    await fetch("/logout", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
  } catch (e) {
    console.error("logout error", e);
  } finally {
    if (bar && percent) {
      bar.style.width = '100%';
      percent.textContent = '100%';
    }
    if (progressTimer) clearInterval(progressTimer);

    setTimeout(() => {
      window.location.href = "/";
    }, 400);
  }
}


    // ✅ 로그아웃 버튼 동작 (커스텀 모달 사용)
    (function setupLogout() {
      const btn = document.getElementById('logoutBtn');
      const modal = document.getElementById('logoutConfirm');
      const cancelBtn = document.getElementById('logoutCancelBtn');
      const okBtn = document.getElementById('logoutOkBtn');

      if (!btn || !modal || !cancelBtn || !okBtn) return;

      // 1) 메뉴 상단 로그아웃 버튼 클릭 → 모달 열기
      btn.addEventListener('click', () => {
        modal.classList.add('show');
      });

      // 2) 취소 버튼 → 모달 닫기
      cancelBtn.addEventListener('click', () => {
        modal.classList.remove('show');
      });

      // 3) 바깥 검은 영역 클릭 → 모달 닫기
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });

      // 4) 확인(로그아웃) 버튼 → 실제 로그아웃 실행
      okBtn.addEventListener('click', async () => {
        modal.classList.remove('show');
        btn.disabled = true;     // 중복 클릭 방지
        await doLogoutWithAnimation();
      });
    })();

    // 🔙 브라우저 뒤로가기 인터셉트
    window.addEventListener('popstate', (event) => {
      // menu.html 에서만 동작 (혹시 다른 페이지에서 섞이지 않게)
      if (!location.pathname.includes('menu')) return;

      const ok = confirm('로그아웃하시겠습니까?');

      if (ok) {
        // 뒤로가기에서 확인 누르면 바로 로그아웃 실행
        doLogoutWithAnimation();
      } else {
        // 취소하면 다시 히스토리 쌓아서 화면 유지
        if (window.history && window.history.pushState) {
          history.pushState({ page: 'menu' }, '', location.href);
        }
      }
    });

    // ✅ 저장된 메뉴 상태 복원 또는 기본값으로 시작
    restoreMenuState();

    // ✅ 페이지 로딩 시 서버에서 완료 상태 가져와서 세부과목 완료 개수 업데이트
    (async function() {
      await syncCompletionStatusFromServer();
      updateSubjectCompletionCounts();
      restoreProgressOnRenderedList();
      console.log('✅ 초기 완료 상태 동기화 및 UI 업데이트 완료');
    })();

    // === 헤더 클릭 시 폭죽 효과 ===
    let jsConfetti = null;

    // JS Confetti 인스턴스 초기화
    if (typeof JSConfetti !== 'undefined') {
      jsConfetti = new JSConfetti();
    }

    // 헤더 영역에만 이벤트 추가
    const menuHeader = document.getElementById('menuHeader');
    if (menuHeader) {
      menuHeader.addEventListener('click', function(e) {
        // 버튼, 링크 등 상호작용 요소를 클릭한 경우는 제외
        const clickedElement = e.target;
        const isInteractiveElement =
          clickedElement.tagName === 'BUTTON' ||
          clickedElement.tagName === 'A' ||
          clickedElement.tagName === 'INPUT' ||
          clickedElement.closest('button') ||
          clickedElement.closest('a');

        if (!isInteractiveElement) {
          console.log('🎉 헤더 클릭 - 폭죽 효과!');

          if (jsConfetti) {
            jsConfetti.addConfetti({
              emojis: ['📚', '🐋', '✨', '🎉', '🎊', '⭐'],
              emojiSize: 50,
              confettiNumber: 30,
            });
          }
        }
      });
    }

    // === 고래 Coin 시스템 ===
    // 단원 완료 메시지를 받아서 코인 증가 처리 + 완료 상태 저장
    window.addEventListener('message', function(event) {
      // 보안: 같은 origin에서 온 메시지만 처리
      if (event.origin !== window.location.origin) return;

      // 🔥 캐시 무효화 메시지 처리 (학습 로그 전송 완료 후)
      if (event.data && event.data.type === 'INVALIDATE_CACHE') {
        console.log('🗑️ [INVALIDATE_CACHE] 캐시 무효화 메시지 수신');
        if (window.ApiCache) {
          ApiCache.invalidate('unit-grades');
          ApiCache.invalidate('completion-status');
          ApiCache.invalidate('learning-logs');
        }
        return;
      }

      // 어휘퀴즈 완료 메시지 처리
      if (event.data && event.data.type === 'vocabularyQuizCompleted') {
        console.log('✅ 어휘퀴즈 완료 메시지 수신');

        // 어휘퀴즈 팝업 닫기
        closeVocabularyQuiz();

        // 페이지 새로고침 (메인 배경 복원)
        setTimeout(() => {
          location.reload();
        }, 300);

        return;
      }

      if (event.data && event.data.type === 'UNIT_COMPLETED') {
        // 현재 열려있는 단원 경로 가져오기
        const currentUnitPath = sessionStorage.getItem('currentOpenUnit');
        if (!currentUnitPath) {
          console.log('⚠️ currentOpenUnit not found in sessionStorage');
          return;
        }

        // 경로에서 단원 코드 추출 (geo_01, geo_02 등)
        const match = currentUnitPath.match(/\/([^\/]+)\.html$/);
        if (!match) {
          console.log('⚠️ Cannot extract unit code from path:', currentUnitPath);
          return;
        }
        const unitCode = match[1];

        // 학생 정보 가져오기
        const stu = getCurrentStudent();
        if (!stu) {
          console.log('⚠️ No student info found');
          return;
        }
        const stuKey = buildStudentKey(stu);

        // 완료 여부 확인 - 학습 페이지와 동일한 방식 사용
        const storageKey = `dan-progress:${stuKey}:${unitCode}`;
        let saved = [];
        try {
          const data = localStorage.getItem(storageKey);
          if (data) {
            saved = JSON.parse(data);
            if (!Array.isArray(saved)) saved = [];
          }
        } catch(e) {
          saved = [];
        }

        // 이미 완료되었는지 체크 (배열에 데이터가 있으면 완료)
        const alreadyCompleted = saved.length > 0;

        if (!alreadyCompleted) {
          console.log(`✅ 새로운 단원 완료: ${unitCode}`);
        } else {
          console.log(`ℹ️ 이미 완료된 단원: ${unitCode}`);
        }

        // UI 업데이트 (학습완료 배지 표시)
        updateLessonStatus(currentUnitPath, 'done');

        // 🔥 API 캐시 무효화 (별표/학습완료 즉시 반영)
        if (window.ApiCache) {
          ApiCache.invalidate('unit-grades');
          ApiCache.invalidate('completion-status');
          ApiCache.invalidate('learning-logs');
          console.log('🗑️ [UNIT_COMPLETED] API 캐시 무효화 완료');
        }

        // 🔥 별표 데이터 다시 로드 및 단원 목록 업데이트
        setTimeout(async () => {
          try {
            // 현재 표시된 단원 목록 다시 렌더링 (최신 별표 데이터 반영)
            if (typeof currentUnits !== 'undefined' && currentUnits && currentUnits.length > 0) {
              await renderUnitList(currentUnits);
              console.log('⭐ [UNIT_COMPLETED] 단원 목록 다시 렌더링 (별표 반영)');
            }
          } catch (e) {
            console.warn('[UNIT_COMPLETED] 단원 목록 업데이트 오류:', e);
          }
        }, 800);

        // 학습실 모달이 열려있다면 리스트 다시 렌더링
        const studyRoomModal = document.getElementById('studyRoomModal');
        if (studyRoomModal && studyRoomModal.classList.contains('show')) {
          renderStudyRoomList();
          console.log('🔄 학습실 리스트 업데이트');
        }
      }
    });

    // ===== 시리즈 활성화/비활성화 처리 =====
    function applySeriesRestrictions() {
      try {
        const user = JSON.parse(sessionStorage.getItem('user') || '{}');
        const assignedSeries = user.assignedSeries || [];

        console.log('🔒 Applying series restrictions:', assignedSeries);

        // 시리즈 이름 매핑 (모달에서 사용하는 이름 -> HTML data-series 값)
        const seriesMapping = {
          'BRAIN은': 'BRAINON',
          'BRAIN암': 'BRAINUP',
          'BRAIN빛': 'BRAINFIT',
          'BRAIN답': 'BRAINDEEP',
          'BRAIN중등': 'BRAINM',
          'BRAIN고등': 'BRAINH',
          // 역방향 매핑도 추가 (이미 영문 ID인 경우 대응)
          'BRAINON': 'BRAINON',
          'BRAINUP': 'BRAINUP',
          'BRAINFIT': 'BRAINFIT',
          'BRAINDEEP': 'BRAINDEEP',
          'BRAINM': 'BRAINM',
          'BRAINH': 'BRAINH'
        };

        // assignedSeries를 data-series 형식으로 변환
        const allowedSeriesIds = assignedSeries.map(name => seriesMapping[name]).filter(Boolean);

        console.log('✅ Allowed series IDs:', allowedSeriesIds);

        // 모든 시리즈 아이템 확인
        document.querySelectorAll("#seriesList .series-item").forEach(li => {
          const seriesId = li.dataset.series;

          if (allowedSeriesIds.includes(seriesId)) {
            // 활성화
            li.classList.remove("disabled");
          } else {
            // 비활성화
            li.classList.add("disabled");
          }
        });
      } catch (err) {
        console.error('❌ Error applying series restrictions:', err);
      }
    }

    // 시리즈 제한 적용
    applySeriesRestrictions();

    // 페이지 처음 열릴 때도 이미 저장돼 있던 완료 내역 있으면 반영
    restoreProgressOnRenderedList();

    window.addEventListener("pageshow", async function (event) {
      // 뒤로가기 캐시에서 돌아올 때 로딩 가리기
      document.getElementById("loadingOverlay")?.classList.remove("show");

      const stu = getCurrentStudent();

      // 🔐 로그아웃 후 뒤로가기 하면 무조건 로그인 페이지로 돌려보내기
      if (!stu) {
        window.location.href = "/";
        return;
      }

      // 🔄 서버에서 최신 사용자 정보 가져오기 (시리즈 부여 업데이트 반영)
      if (stu && stu.grade && stu.name) {
        try {
          const res = await fetch(`/api/user-info?grade=${encodeURIComponent(stu.grade)}&name=${encodeURIComponent(stu.name)}`);
          if (res.ok) {
            const userData = await res.json();
            if (userData) {
              // sessionStorage 업데이트
              sessionStorage.setItem('user', JSON.stringify(userData));
              console.log('✅ User info updated from server:', userData);

              // 시리즈 제한 다시 적용
              applySeriesRestrictions();
            }
          }
        } catch (err) {
          console.error('Failed to fetch updated user info:', err);
        }
      }

      // 학생 정보가 있으면 헤더 문구 다시 갱신
      showUserInfo();

      // ✅ 완료 상태는 이미 6099번 줄에서 로드되었으므로 중복 호출 제거
      // UI만 업데이트
      restoreProgressOnRenderedList();
      updateSubjectCompletionCounts(); // ✅ 세부과목 완료 개수 업데이트
    });

    // === 준비된 단원 목록 (파일 존재 여부 확인용) ===
    const availableUnits = {
      './BRAINUP/korlit/classic_01.html': true,
      './BRAINUP/korlit/classic_02.html': true,
      './BRAINUP/korlit/classic_03.html': true,
      './BRAINUP/korlit/classic_04.html': true,
      './BRAINUP/korlit/classic_05.html': true,
      './BRAINUP/korlit/classic_06.html': true,
      './BRAINUP/korlit/classic_07.html': true,
      './BRAINUP/korlit/classic_08.html': true,
      './BRAINUP/korlit/classic_09.html': true,
      './BRAINUP/korlit/classic_10.html': true,
      './BRAINUP/korlit/classic_11.html': true,
      './BRAINUP/korlit/classic_12.html': true,
      './BRAINUP/korlit/classic_13.html': true,
      './BRAINUP/korlit/classic_14.html': true,
      './BRAINUP/korlit/classic_15.html': true,
      './BRAINUP/korlit/classic_16.html': true,
      './BRAINUP/korlit/classic_17.html': true,
      './BRAINUP/korlit/classic_18.html': true,
      './BRAINUP/korlit/classic_19.html': true,
      './BRAINUP/korlit/classic_20.html': true,
      './BRAINUP/korlit/classic_21.html': true,
      './BRAINUP/korlit/classic_22.html': true,
      './BRAINUP/korlit/classic_23.html': true,
      './BRAINUP/korlit/classic_24.html': true,
      './BRAINUP/korlit/classic_25.html': true,
      './BRAINUP/korlit/classic_26.html': true,
      './BRAINUP/korlit/classic_27.html': true,
      './BRAINUP/korlit/classic_28.html': true,
      './BRAINUP/korlit/classic_29.html': true,
      './BRAINUP/korlit/classic_30.html': true,
      './BRAINUP/korlit/classic_31.html': true,
      './BRAINUP/korlit/classic_32.html': true,
      './BRAINUP/korlit/classic_33.html': true,
      './BRAINUP/korlit/classic_34.html': true,
      './BRAINUP/korlit/classic_35.html': true,
      './BRAINUP/korlit/classic_36.html': true,
      './BRAINUP/korlit/classic_37.html': true,
      './BRAINUP/korlit/classic_38.html': true,
      './BRAINUP/korlit/classic_39.html': true,
      './BRAINUP/korlit/classic_40.html': true,
      './BRAINUP/korlit/modern_01.html': true,
      './BRAINUP/korlit/modern_02.html': true,
      './BRAINUP/korlit/modern_03.html': true,
      './BRAINUP/korlit/modern_04.html': true,
      './BRAINUP/korlit/modern_05.html': true,
      './BRAINUP/korlit/modern_06.html': true,
      './BRAINUP/korlit/modern_07.html': true,
      './BRAINUP/korlit/modern_08.html': true,
      './BRAINUP/korlit/modern_09.html': true,
      './BRAINUP/korlit/modern_10.html': true,
      './BRAINUP/korlit/modern_11.html': true,
      './BRAINUP/korlit/modern_12.html': true,
      './BRAINUP/korlit/modern_13.html': true,
      './BRAINUP/korlit/modern_14.html': true,
      './BRAINUP/korlit/modern_15.html': true,
      './BRAINUP/korlit/modern_16.html': true,
      './BRAINUP/korlit/modern_17.html': true,
      './BRAINUP/korlit/modern_18.html': true,
      './BRAINUP/korlit/modern_19.html': true,
      './BRAINUP/korlit/modern_20.html': true,
      './BRAINUP/korlit/modern_21.html': true,
      './BRAINUP/korlit/modern_22.html': true,
      './BRAINUP/korlit/modern_23.html': true,
      './BRAINUP/korlit/modern_24.html': true,
      './BRAINUP/korlit/modern_25.html': true,
      './BRAINUP/korlit/modern_26.html': true,
      './BRAINUP/korlit/modern_27.html': true,
      './BRAINUP/korlit/modern_28.html': true,
      './BRAINUP/korlit/modern_29.html': true,
      './BRAINUP/korlit/modern_30.html': true,
      './BRAINUP/korlit/modern_31.html': true,
      './BRAINUP/korlit/modern_32.html': true,
      './BRAINUP/korlit/modern_33.html': true,
      './BRAINUP/korlit/modern_34.html': true,
      './BRAINUP/korlit/modern_35.html': true,
      './BRAINUP/korlit/modern_36.html': true,
      './BRAINUP/korlit/modern_37.html': true,
      './BRAINUP/korlit/modern_38.html': true,
      './BRAINUP/korlit/modern_39.html': true,
      './BRAINUP/korlit/modern_40.html': true,
      // 한국인물 (people1_01 ~ people1_40)
      './BRAINUP/person/people1_01.html': true,
      './BRAINUP/person/people1_02.html': true,
      './BRAINUP/person/people1_03.html': true,
      './BRAINUP/person/people1_04.html': true,
      './BRAINUP/person/people1_05.html': true,
      './BRAINUP/person/people1_06.html': true,
      './BRAINUP/person/people1_07.html': true,
      './BRAINUP/person/people1_08.html': true,
      './BRAINUP/person/people1_09.html': true,
      './BRAINUP/person/people1_10.html': true,
      './BRAINUP/person/people1_11.html': true,
      './BRAINUP/person/people1_12.html': true,
      './BRAINUP/person/people1_13.html': true,
      './BRAINUP/person/people1_14.html': true,
      './BRAINUP/person/people1_15.html': true,
      './BRAINUP/person/people1_16.html': true,
      './BRAINUP/person/people1_17.html': true,
      './BRAINUP/person/people1_18.html': true,
      './BRAINUP/person/people1_19.html': true,
      './BRAINUP/person/people1_20.html': true,
      './BRAINUP/person/people1_21.html': true,
      './BRAINUP/person/people1_22.html': true,
      './BRAINUP/person/people1_23.html': true,
      './BRAINUP/person/people1_24.html': true,
      './BRAINUP/person/people1_25.html': true,
      './BRAINUP/person/people1_26.html': true,
      './BRAINUP/person/people1_27.html': true,
      './BRAINUP/person/people1_28.html': true,
      './BRAINUP/person/people1_29.html': true,
      './BRAINUP/person/people1_30.html': true,
      './BRAINUP/person/people1_31.html': true,
      './BRAINUP/person/people1_32.html': true,
      './BRAINUP/person/people1_33.html': true,
      './BRAINUP/person/people1_34.html': true,
      './BRAINUP/person/people1_35.html': true,
      './BRAINUP/person/people1_36.html': true,
      './BRAINUP/person/people1_37.html': true,
      './BRAINUP/person/people1_38.html': true,
      './BRAINUP/person/people1_39.html': true,
      './BRAINUP/person/people1_40.html': true,
      // 세계인물 (people2_01 ~ people2_40)
      './BRAINUP/person/people2_01.html': true,
      './BRAINUP/person/people2_02.html': true,
      './BRAINUP/person/people2_03.html': true,
      './BRAINUP/person/people2_04.html': true,
      './BRAINUP/person/people2_05.html': true,
      './BRAINUP/person/people2_06.html': true,
      './BRAINUP/person/people2_07.html': true,
      './BRAINUP/person/people2_08.html': true,
      './BRAINUP/person/people2_09.html': true,
      './BRAINUP/person/people2_10.html': true,
      './BRAINUP/person/people2_11.html': true,
      './BRAINUP/person/people2_12.html': true,
      './BRAINUP/person/people2_13.html': true,
      './BRAINUP/person/people2_14.html': true,
      './BRAINUP/person/people2_15.html': true,
      './BRAINUP/person/people2_16.html': true,
      './BRAINUP/person/people2_17.html': true,
      './BRAINUP/person/people2_18.html': true,
      './BRAINUP/person/people2_19.html': true,
      './BRAINUP/person/people2_20.html': true,
      './BRAINUP/person/people2_21.html': true,
      './BRAINUP/person/people2_22.html': true,
      './BRAINUP/person/people2_23.html': true,
      './BRAINUP/person/people2_24.html': true,
      './BRAINUP/person/people2_25.html': true,
      './BRAINUP/person/people2_26.html': true,
      './BRAINUP/person/people2_27.html': true,
      './BRAINUP/person/people2_28.html': true,
      './BRAINUP/person/people2_29.html': true,
      './BRAINUP/person/people2_30.html': true,
      './BRAINUP/person/people2_31.html': true,
      './BRAINUP/person/people2_32.html': true,
      './BRAINUP/person/people2_33.html': true,
      './BRAINUP/person/people2_34.html': true,
      './BRAINUP/person/people2_35.html': true,
      './BRAINUP/person/people2_36.html': true,
      './BRAINUP/person/people2_37.html': true,
      './BRAINUP/person/people2_38.html': true,
      './BRAINUP/person/people2_39.html': true,
      './BRAINUP/person/people2_40.html': true,
      './BRAINUP/science/bio_01.html': true,
      './BRAINUP/science/bio_02.html': true,
      './BRAINUP/science/bio_03.html': true,
      './BRAINUP/science/bio_04.html': true,
      './BRAINUP/science/bio_05.html': true,
      './BRAINUP/science/bio_06.html': true,
      './BRAINUP/science/bio_07.html': true,
      './BRAINUP/science/bio_08.html': true,
      './BRAINUP/science/bio_09.html': true,
      './BRAINUP/science/bio_10.html': true,
      './BRAINUP/science/bio_11.html': true,
      './BRAINUP/science/bio_12.html': true,
      './BRAINUP/science/bio_13.html': true,
      './BRAINUP/science/bio_14.html': true,
      './BRAINUP/science/bio_15.html': true,
      './BRAINUP/science/bio_16.html': true,
      './BRAINUP/science/bio_17.html': true,
      './BRAINUP/science/bio_18.html': true,
      './BRAINUP/science/bio_19.html': true,
      './BRAINUP/science/bio_20.html': true,
      './BRAINUP/science/chem_01.html': true,
      './BRAINUP/science/chem_02.html': true,
      './BRAINUP/science/chem_03.html': true,
      './BRAINUP/science/chem_04.html': true,
      './BRAINUP/science/chem_05.html': true,
      './BRAINUP/science/chem_06.html': true,
      './BRAINUP/science/chem_07.html': true,
      './BRAINUP/science/chem_08.html': true,
      './BRAINUP/science/chem_09.html': true,
      './BRAINUP/science/chem_10.html': true,
      './BRAINUP/science/chem_11.html': true,
      './BRAINUP/science/chem_12.html': true,
      './BRAINUP/science/chem_13.html': true,
      './BRAINUP/science/chem_14.html': true,
      './BRAINUP/science/chem_15.html': true,
      './BRAINUP/science/chem_16.html': true,
      './BRAINUP/science/chem_17.html': true,
      './BRAINUP/science/chem_18.html': true,
      './BRAINUP/science/chem_19.html': true,
      './BRAINUP/science/chem_20.html': true,
      './BRAINUP/science/earth_01.html': true,
      './BRAINUP/science/earth_02.html': true,
      './BRAINUP/science/earth_03.html': true,
      './BRAINUP/science/earth_04.html': true,
      './BRAINUP/science/earth_05.html': true,
      './BRAINUP/science/earth_06.html': true,
      './BRAINUP/science/earth_07.html': true,
      './BRAINUP/science/earth_08.html': true,
      './BRAINUP/science/earth_09.html': true,
      './BRAINUP/science/earth_10.html': true,
      './BRAINUP/science/earth_11.html': true,
      './BRAINUP/science/earth_12.html': true,
      './BRAINUP/science/earth_13.html': true,
      './BRAINUP/science/earth_14.html': true,
      './BRAINUP/science/earth_15.html': true,
      './BRAINUP/science/earth_16.html': true,
      './BRAINUP/science/earth_17.html': true,
      './BRAINUP/science/earth_18.html': true,
      './BRAINUP/science/earth_19.html': true,
      './BRAINUP/science/earth_20.html': true,
      './BRAINUP/science/physics_01.html': true,
      './BRAINUP/science/physics_02.html': true,
      './BRAINUP/science/physics_03.html': true,
      './BRAINUP/science/physics_04.html': true,
      './BRAINUP/science/physics_05.html': true,
      './BRAINUP/science/physics_06.html': true,
      './BRAINUP/science/physics_07.html': true,
      './BRAINUP/science/physics_08.html': true,
      './BRAINUP/science/physics_09.html': true,
      './BRAINUP/science/physics_10.html': true,
      './BRAINUP/science/physics_11.html': true,
      './BRAINUP/science/physics_12.html': true,
      './BRAINUP/science/physics_13.html': true,
      './BRAINUP/science/physics_14.html': true,
      './BRAINUP/science/physics_15.html': true,
      './BRAINUP/science/physics_16.html': true,
      './BRAINUP/science/physics_17.html': true,
      './BRAINUP/science/physics_18.html': true,
      './BRAINUP/science/physics_19.html': true,
      './BRAINUP/science/physics_20.html': true,
      './BRAINUP/social/geo_01.html': true,
      './BRAINUP/social/geo_02.html': true,
      './BRAINUP/social/geo_03.html': true,
      './BRAINUP/social/geo_04.html': true,
      './BRAINUP/social/geo_05.html': true,
      './BRAINUP/social/geo_06.html': true,
      './BRAINUP/social/geo_07.html': true,
      './BRAINUP/social/geo_08.html': true,
      './BRAINUP/social/geo_09.html': true,
      './BRAINUP/social/geo_10.html': true,
      './BRAINUP/social/geo_11.html': true,
      './BRAINUP/social/geo_12.html': true,
      './BRAINUP/social/geo_13.html': true,
      './BRAINUP/social/geo_14.html': true,
      './BRAINUP/social/geo_15.html': true,
      './BRAINUP/social/geo_16.html': true,
      './BRAINUP/social/geo_17.html': true,
      './BRAINUP/social/geo_18.html': true,
      './BRAINUP/social/geo_19.html': true,
      './BRAINUP/social/geo_20.html': true,
      './BRAINUP/social/law_01.html': true,
      './BRAINUP/social/law_02.html': true,
      './BRAINUP/social/law_03.html': true,
      './BRAINUP/social/law_04.html': true,
      './BRAINUP/social/law_05.html': true,
      './BRAINUP/social/law_06.html': true,
      './BRAINUP/social/law_07.html': true,
      './BRAINUP/social/law_08.html': true,
      './BRAINUP/social/law_09.html': true,
      './BRAINUP/social/law_10.html': true,
      './BRAINUP/social/law_11.html': true,
      './BRAINUP/social/law_12.html': true,
      './BRAINUP/social/law_13.html': true,
      './BRAINUP/social/law_14.html': true,
      './BRAINUP/social/law_15.html': true,
      './BRAINUP/social/law_16.html': true,
      './BRAINUP/social/law_17.html': true,
      './BRAINUP/social/law_18.html': true,
      './BRAINUP/social/law_19.html': true,
      './BRAINUP/social/law_20.html': true,
      './BRAINUP/social/pol_01.html': true,
      './BRAINUP/social/pol_02.html': true,
      './BRAINUP/social/pol_03.html': true,
      './BRAINUP/social/pol_04.html': true,
      './BRAINUP/social/pol_05.html': true,
      './BRAINUP/social/pol_06.html': true,
      './BRAINUP/social/pol_07.html': true,
      './BRAINUP/social/pol_08.html': true,
      './BRAINUP/social/pol_09.html': true,
      './BRAINUP/social/pol_10.html': true,
      './BRAINUP/social/pol_11.html': true,
      './BRAINUP/social/pol_12.html': true,
      './BRAINUP/social/pol_13.html': true,
      './BRAINUP/social/pol_14.html': true,
      './BRAINUP/social/pol_15.html': true,
      './BRAINUP/social/pol_16.html': true,
      './BRAINUP/social/pol_17.html': true,
      './BRAINUP/social/pol_18.html': true,
      './BRAINUP/social/pol_19.html': true,
      './BRAINUP/social/pol_20.html': true,
      './BRAINUP/social/soc_01.html': true,
      './BRAINUP/social/soc_02.html': true,
      './BRAINUP/social/soc_03.html': true,
      './BRAINUP/social/soc_04.html': true,
      './BRAINUP/social/soc_05.html': true,
      './BRAINUP/social/soc_06.html': true,
      './BRAINUP/social/soc_07.html': true,
      './BRAINUP/social/soc_08.html': true,
      './BRAINUP/social/soc_09.html': true,
      './BRAINUP/social/soc_10.html': true,
      './BRAINUP/social/soc_11.html': true,
      './BRAINUP/social/soc_12.html': true,
      './BRAINUP/social/soc_13.html': true,
      './BRAINUP/social/soc_14.html': true,
      './BRAINUP/social/soc_15.html': true,
      './BRAINUP/social/soc_16.html': true,
      './BRAINUP/social/soc_17.html': true,
      './BRAINUP/social/soc_18.html': true,
      './BRAINUP/social/soc_19.html': true,
      './BRAINUP/social/soc_20.html': true,
      './BRAINUP/worldlit/world1_01.html': true,
      './BRAINUP/worldlit/world1_02.html': true,
      './BRAINUP/worldlit/world1_03.html': true,
      './BRAINUP/worldlit/world1_04.html': true,
      './BRAINUP/worldlit/world1_05.html': true,
      './BRAINUP/worldlit/world1_06.html': true,
      './BRAINUP/worldlit/world1_07.html': true,
      './BRAINUP/worldlit/world1_08.html': true,
      './BRAINUP/worldlit/world1_09.html': true,
      './BRAINUP/worldlit/world1_10.html': true,
      './BRAINUP/worldlit/world1_11.html': true,
      './BRAINUP/worldlit/world1_12.html': true,
      './BRAINUP/worldlit/world1_13.html': true,
      './BRAINUP/worldlit/world1_14.html': true,
      './BRAINUP/worldlit/world1_15.html': true,
      './BRAINUP/worldlit/world1_16.html': true,
      './BRAINUP/worldlit/world1_17.html': true,
      './BRAINUP/worldlit/world1_18.html': true,
      './BRAINUP/worldlit/world1_19.html': true,
      './BRAINUP/worldlit/world1_20.html': true,
      './BRAINUP/worldlit/world1_21.html': true,
      './BRAINUP/worldlit/world1_22.html': true,
      './BRAINUP/worldlit/world1_23.html': true,
      './BRAINUP/worldlit/world1_24.html': true,
      './BRAINUP/worldlit/world1_25.html': true,
      './BRAINUP/worldlit/world1_26.html': true,
      './BRAINUP/worldlit/world1_27.html': true,
      './BRAINUP/worldlit/world1_28.html': true,
      './BRAINUP/worldlit/world1_29.html': true,
      './BRAINUP/worldlit/world1_30.html': true,
      './BRAINUP/worldlit/world1_31.html': true,
      './BRAINUP/worldlit/world1_32.html': true,
      './BRAINUP/worldlit/world1_33.html': true,
      './BRAINUP/worldlit/world1_34.html': true,
      './BRAINUP/worldlit/world1_35.html': true,
      './BRAINUP/worldlit/world1_36.html': true,
      './BRAINUP/worldlit/world1_37.html': true,
      './BRAINUP/worldlit/world1_38.html': true,
      './BRAINUP/worldlit/world1_39.html': true,
      './BRAINUP/worldlit/world1_40.html': true,
      './BRAINUP/worldlit/world2_01.html': true,
      './BRAINUP/worldlit/world2_02.html': true,
      './BRAINUP/worldlit/world2_03.html': true,
      './BRAINUP/worldlit/world2_04.html': true,
      './BRAINUP/worldlit/world2_05.html': true,
      './BRAINUP/worldlit/world2_06.html': true,
      './BRAINUP/worldlit/world2_07.html': true,
      './BRAINUP/worldlit/world2_08.html': true,
      './BRAINUP/worldlit/world2_09.html': true,
      './BRAINUP/worldlit/world2_10.html': true,
      './BRAINUP/worldlit/world2_11.html': true,
      './BRAINUP/worldlit/world2_12.html': true,
      './BRAINUP/worldlit/world2_13.html': true,
      './BRAINUP/worldlit/world2_14.html': true,
      './BRAINUP/worldlit/world2_15.html': true,
      './BRAINUP/worldlit/world2_16.html': true,
      './BRAINUP/worldlit/world2_17.html': true,
      './BRAINUP/worldlit/world2_18.html': true,
      './BRAINUP/worldlit/world2_19.html': true,
      './BRAINUP/worldlit/world2_20.html': true,
      './BRAINUP/worldlit/world2_21.html': true,
      './BRAINUP/worldlit/world2_22.html': true,
      './BRAINUP/worldlit/world2_23.html': true,
      './BRAINUP/worldlit/world2_24.html': true,
      './BRAINUP/worldlit/world2_25.html': true,
      './BRAINUP/worldlit/world2_26.html': true,
      './BRAINUP/worldlit/world2_27.html': true,
      './BRAINUP/worldlit/world2_28.html': true,
      './BRAINUP/worldlit/world2_29.html': true,
      './BRAINUP/worldlit/world2_30.html': true,
      './BRAINUP/worldlit/world2_31.html': true,
      './BRAINUP/worldlit/world2_32.html': true,
      './BRAINUP/worldlit/world2_33.html': true,
      './BRAINUP/worldlit/world2_34.html': true,
      './BRAINUP/worldlit/world2_35.html': true,
      './BRAINUP/worldlit/world2_36.html': true,
      './BRAINUP/worldlit/world2_37.html': true,
      './BRAINUP/worldlit/world2_38.html': true,
      './BRAINUP/worldlit/world2_39.html': true,
      './BRAINUP/worldlit/world2_40.html': true,
      './BRAINUP/korlit/classic_01.html': true,
      './BRAINUP/korlit/classic_02.html': true,
      './BRAINUP/korlit/classic_03.html': true,
      './BRAINUP/korlit/classic_04.html': true,
      './BRAINUP/korlit/classic_05.html': true,
      './BRAINUP/korlit/classic_06.html': true,
      './BRAINUP/korlit/classic_07.html': true,
      './BRAINUP/korlit/classic_08.html': true,
      './BRAINUP/korlit/classic_09.html': true,
      './BRAINUP/korlit/classic_10.html': true,
      './BRAINUP/korlit/classic_11.html': true,
      './BRAINUP/korlit/classic_12.html': true,
      './BRAINUP/korlit/classic_13.html': true,
      './BRAINUP/korlit/classic_14.html': true,
      './BRAINUP/korlit/classic_15.html': true,
      './BRAINUP/korlit/classic_16.html': true,
      './BRAINUP/korlit/classic_17.html': true,
      './BRAINUP/korlit/classic_18.html': true,
      './BRAINUP/korlit/classic_19.html': true,
      './BRAINUP/korlit/classic_20.html': true,
      './BRAINUP/korlit/classic_21.html': true,
      './BRAINUP/korlit/classic_22.html': true,
      './BRAINUP/korlit/classic_23.html': true,
      './BRAINUP/korlit/classic_24.html': true,
      './BRAINUP/korlit/classic_25.html': true,
      './BRAINUP/korlit/classic_26.html': true,
      './BRAINUP/korlit/classic_27.html': true,
      './BRAINUP/korlit/classic_28.html': true,
      './BRAINUP/korlit/classic_29.html': true,
      './BRAINUP/korlit/classic_30.html': true,
      './BRAINUP/korlit/classic_31.html': true,
      './BRAINUP/korlit/classic_32.html': true,
      './BRAINUP/korlit/classic_33.html': true,
      './BRAINUP/korlit/classic_34.html': true,
      './BRAINUP/korlit/classic_35.html': true,
      './BRAINUP/korlit/classic_36.html': true,
      './BRAINUP/korlit/classic_37.html': true,
      './BRAINUP/korlit/classic_38.html': true,
      './BRAINUP/korlit/classic_39.html': true,
      './BRAINUP/korlit/classic_40.html': true,
      './BRAINUP/korlit/modern_01.html': true,
      './BRAINUP/korlit/modern_02.html': true,
      './BRAINUP/korlit/modern_03.html': true,
      './BRAINUP/korlit/modern_04.html': true,
      './BRAINUP/korlit/modern_05.html': true,
      './BRAINUP/korlit/modern_06.html': true,
      './BRAINUP/korlit/modern_07.html': true,
      './BRAINUP/korlit/modern_08.html': true,
      './BRAINUP/korlit/modern_09.html': true,
      './BRAINUP/korlit/modern_10.html': true,
      './BRAINUP/korlit/modern_11.html': true,
      './BRAINUP/korlit/modern_12.html': true,
      './BRAINUP/korlit/modern_13.html': true,
      './BRAINUP/korlit/modern_14.html': true,
      './BRAINUP/korlit/modern_15.html': true,
      './BRAINUP/korlit/modern_16.html': true,
      './BRAINUP/korlit/modern_17.html': true,
      './BRAINUP/korlit/modern_18.html': true,
      './BRAINUP/korlit/modern_19.html': true,
      './BRAINUP/korlit/modern_20.html': true,
      './BRAINUP/korlit/modern_21.html': true,
      './BRAINUP/korlit/modern_22.html': true,
      './BRAINUP/korlit/modern_23.html': true,
      './BRAINUP/korlit/modern_24.html': true,
      './BRAINUP/korlit/modern_25.html': true,
      './BRAINUP/korlit/modern_26.html': true,
      './BRAINUP/korlit/modern_27.html': true,
      './BRAINUP/korlit/modern_28.html': true,
      './BRAINUP/korlit/modern_29.html': true,
      './BRAINUP/korlit/modern_30.html': true,
      './BRAINUP/korlit/modern_31.html': true,
      './BRAINUP/korlit/modern_32.html': true,
      './BRAINUP/korlit/modern_33.html': true,
      './BRAINUP/korlit/modern_34.html': true,
      './BRAINUP/korlit/modern_35.html': true,
      './BRAINUP/korlit/modern_36.html': true,
      './BRAINUP/korlit/modern_37.html': true,
      './BRAINUP/korlit/modern_38.html': true,
      './BRAINUP/korlit/modern_39.html': true,
      './BRAINUP/korlit/modern_40.html': true,
      // 한국인물 (people1_01 ~ people1_40)
      './BRAINUP/person/people1_01.html': true,
      './BRAINUP/person/people1_02.html': true,
      './BRAINUP/person/people1_03.html': true,
      './BRAINUP/person/people1_04.html': true,
      './BRAINUP/person/people1_05.html': true,
      './BRAINUP/person/people1_06.html': true,
      './BRAINUP/person/people1_07.html': true,
      './BRAINUP/person/people1_08.html': true,
      './BRAINUP/person/people1_09.html': true,
      './BRAINUP/person/people1_10.html': true,
      './BRAINUP/person/people1_11.html': true,
      './BRAINUP/person/people1_12.html': true,
      './BRAINUP/person/people1_13.html': true,
      './BRAINUP/person/people1_14.html': true,
      './BRAINUP/person/people1_15.html': true,
      './BRAINUP/person/people1_16.html': true,
      './BRAINUP/person/people1_17.html': true,
      './BRAINUP/person/people1_18.html': true,
      './BRAINUP/person/people1_19.html': true,
      './BRAINUP/person/people1_20.html': true,
      './BRAINUP/person/people1_21.html': true,
      './BRAINUP/person/people1_22.html': true,
      './BRAINUP/person/people1_23.html': true,
      './BRAINUP/person/people1_24.html': true,
      './BRAINUP/person/people1_25.html': true,
      './BRAINUP/person/people1_26.html': true,
      './BRAINUP/person/people1_27.html': true,
      './BRAINUP/person/people1_28.html': true,
      './BRAINUP/person/people1_29.html': true,
      './BRAINUP/person/people1_30.html': true,
      './BRAINUP/person/people1_31.html': true,
      './BRAINUP/person/people1_32.html': true,
      './BRAINUP/person/people1_33.html': true,
      './BRAINUP/person/people1_34.html': true,
      './BRAINUP/person/people1_35.html': true,
      './BRAINUP/person/people1_36.html': true,
      './BRAINUP/person/people1_37.html': true,
      './BRAINUP/person/people1_38.html': true,
      './BRAINUP/person/people1_39.html': true,
      './BRAINUP/person/people1_40.html': true,
      // 세계인물 (people2_01 ~ people2_40)
      './BRAINUP/person/people2_01.html': true,
      './BRAINUP/person/people2_02.html': true,
      './BRAINUP/person/people2_03.html': true,
      './BRAINUP/person/people2_04.html': true,
      './BRAINUP/person/people2_05.html': true,
      './BRAINUP/person/people2_06.html': true,
      './BRAINUP/person/people2_07.html': true,
      './BRAINUP/person/people2_08.html': true,
      './BRAINUP/person/people2_09.html': true,
      './BRAINUP/person/people2_10.html': true,
      './BRAINUP/person/people2_11.html': true,
      './BRAINUP/person/people2_12.html': true,
      './BRAINUP/person/people2_13.html': true,
      './BRAINUP/person/people2_14.html': true,
      './BRAINUP/person/people2_15.html': true,
      './BRAINUP/person/people2_16.html': true,
      './BRAINUP/person/people2_17.html': true,
      './BRAINUP/person/people2_18.html': true,
      './BRAINUP/person/people2_19.html': true,
      './BRAINUP/person/people2_20.html': true,
      './BRAINUP/person/people2_21.html': true,
      './BRAINUP/person/people2_22.html': true,
      './BRAINUP/person/people2_23.html': true,
      './BRAINUP/person/people2_24.html': true,
      './BRAINUP/person/people2_25.html': true,
      './BRAINUP/person/people2_26.html': true,
      './BRAINUP/person/people2_27.html': true,
      './BRAINUP/person/people2_28.html': true,
      './BRAINUP/person/people2_29.html': true,
      './BRAINUP/person/people2_30.html': true,
      './BRAINUP/person/people2_31.html': true,
      './BRAINUP/person/people2_32.html': true,
      './BRAINUP/person/people2_33.html': true,
      './BRAINUP/person/people2_34.html': true,
      './BRAINUP/person/people2_35.html': true,
      './BRAINUP/person/people2_36.html': true,
      './BRAINUP/person/people2_37.html': true,
      './BRAINUP/person/people2_38.html': true,
      './BRAINUP/person/people2_39.html': true,
      './BRAINUP/person/people2_40.html': true,
      './BRAINUP/science/bio_01.html': true,
      './BRAINUP/science/bio_02.html': true,
      './BRAINUP/science/bio_03.html': true,
      './BRAINUP/science/bio_04.html': true,
      './BRAINUP/science/bio_05.html': true,
      './BRAINUP/science/bio_06.html': true,
      './BRAINUP/science/bio_07.html': true,
      './BRAINUP/science/bio_08.html': true,
      './BRAINUP/science/bio_09.html': true,
      './BRAINUP/science/bio_10.html': true,
      './BRAINUP/science/bio_11.html': true,
      './BRAINUP/science/bio_12.html': true,
      './BRAINUP/science/bio_13.html': true,
      './BRAINUP/science/bio_14.html': true,
      './BRAINUP/science/bio_15.html': true,
      './BRAINUP/science/bio_16.html': true,
      './BRAINUP/science/bio_17.html': true,
      './BRAINUP/science/bio_18.html': true,
      './BRAINUP/science/bio_19.html': true,
      './BRAINUP/science/bio_20.html': true,
      './BRAINUP/science/chem_01.html': true,
      './BRAINUP/science/chem_02.html': true,
      './BRAINUP/science/chem_03.html': true,
      './BRAINUP/science/chem_04.html': true,
      './BRAINUP/science/chem_05.html': true,
      './BRAINUP/science/chem_06.html': true,
      './BRAINUP/science/chem_07.html': true,
      './BRAINUP/science/chem_08.html': true,
      './BRAINUP/science/chem_09.html': true,
      './BRAINUP/science/chem_10.html': true,
      './BRAINUP/science/chem_11.html': true,
      './BRAINUP/science/chem_12.html': true,
      './BRAINUP/science/chem_13.html': true,
      './BRAINUP/science/chem_14.html': true,
      './BRAINUP/science/chem_15.html': true,
      './BRAINUP/science/chem_16.html': true,
      './BRAINUP/science/chem_17.html': true,
      './BRAINUP/science/chem_18.html': true,
      './BRAINUP/science/chem_19.html': true,
      './BRAINUP/science/chem_20.html': true,
      './BRAINUP/science/earth_01.html': true,
      './BRAINUP/science/earth_02.html': true,
      './BRAINUP/science/earth_03.html': true,
      './BRAINUP/science/earth_04.html': true,
      './BRAINUP/science/earth_05.html': true,
      './BRAINUP/science/earth_06.html': true,
      './BRAINUP/science/earth_07.html': true,
      './BRAINUP/science/earth_08.html': true,
      './BRAINUP/science/earth_09.html': true,
      './BRAINUP/science/earth_10.html': true,
      './BRAINUP/science/earth_11.html': true,
      './BRAINUP/science/earth_12.html': true,
      './BRAINUP/science/earth_13.html': true,
      './BRAINUP/science/earth_14.html': true,
      './BRAINUP/science/earth_15.html': true,
      './BRAINUP/science/earth_16.html': true,
      './BRAINUP/science/earth_17.html': true,
      './BRAINUP/science/earth_18.html': true,
      './BRAINUP/science/earth_19.html': true,
      './BRAINUP/science/earth_20.html': true,
      './BRAINUP/science/physics_01.html': true,
      './BRAINUP/science/physics_02.html': true,
      './BRAINUP/science/physics_03.html': true,
      './BRAINUP/science/physics_04.html': true,
      './BRAINUP/science/physics_05.html': true,
      './BRAINUP/science/physics_06.html': true,
      './BRAINUP/science/physics_07.html': true,
      './BRAINUP/science/physics_08.html': true,
      './BRAINUP/science/physics_09.html': true,
      './BRAINUP/science/physics_10.html': true,
      './BRAINUP/science/physics_11.html': true,
      './BRAINUP/science/physics_12.html': true,
      './BRAINUP/science/physics_13.html': true,
      './BRAINUP/science/physics_14.html': true,
      './BRAINUP/science/physics_15.html': true,
      './BRAINUP/science/physics_16.html': true,
      './BRAINUP/science/physics_17.html': true,
      './BRAINUP/science/physics_18.html': true,
      './BRAINUP/science/physics_19.html': true,
      './BRAINUP/science/physics_20.html': true,
      './BRAINUP/social/geo_01.html': true,
      './BRAINUP/social/geo_02.html': true,
      './BRAINUP/social/geo_03.html': true,
      './BRAINUP/social/geo_04.html': true,
      './BRAINUP/social/geo_05.html': true,
      './BRAINUP/social/geo_06.html': true,
      './BRAINUP/social/geo_07.html': true,
      './BRAINUP/social/geo_08.html': true,
      './BRAINUP/social/geo_09.html': true,
      './BRAINUP/social/geo_10.html': true,
      './BRAINUP/social/geo_11.html': true,
      './BRAINUP/social/geo_12.html': true,
      './BRAINUP/social/geo_13.html': true,
      './BRAINUP/social/geo_14.html': true,
      './BRAINUP/social/geo_15.html': true,
      './BRAINUP/social/geo_16.html': true,
      './BRAINUP/social/geo_17.html': true,
      './BRAINUP/social/geo_18.html': true,
      './BRAINUP/social/geo_19.html': true,
      './BRAINUP/social/geo_20.html': true,
      './BRAINUP/social/law_01.html': true,
      './BRAINUP/social/law_02.html': true,
      './BRAINUP/social/law_03.html': true,
      './BRAINUP/social/law_04.html': true,
      './BRAINUP/social/law_05.html': true,
      './BRAINUP/social/law_06.html': true,
      './BRAINUP/social/law_07.html': true,
      './BRAINUP/social/law_08.html': true,
      './BRAINUP/social/law_09.html': true,
      './BRAINUP/social/law_10.html': true,
      './BRAINUP/social/law_11.html': true,
      './BRAINUP/social/law_12.html': true,
      './BRAINUP/social/law_13.html': true,
      './BRAINUP/social/law_14.html': true,
      './BRAINUP/social/law_15.html': true,
      './BRAINUP/social/law_16.html': true,
      './BRAINUP/social/law_17.html': true,
      './BRAINUP/social/law_18.html': true,
      './BRAINUP/social/law_19.html': true,
      './BRAINUP/social/law_20.html': true,
      './BRAINUP/social/pol_01.html': true,
      './BRAINUP/social/pol_02.html': true,
      './BRAINUP/social/pol_03.html': true,
      './BRAINUP/social/pol_04.html': true,
      './BRAINUP/social/pol_05.html': true,
      './BRAINUP/social/pol_06.html': true,
      './BRAINUP/social/pol_07.html': true,
      './BRAINUP/social/pol_08.html': true,
      './BRAINUP/social/pol_09.html': true,
      './BRAINUP/social/pol_10.html': true,
      './BRAINUP/social/pol_11.html': true,
      './BRAINUP/social/pol_12.html': true,
      './BRAINUP/social/pol_13.html': true,
      './BRAINUP/social/pol_14.html': true,
      './BRAINUP/social/pol_15.html': true,
      './BRAINUP/social/pol_16.html': true,
      './BRAINUP/social/pol_17.html': true,
      './BRAINUP/social/pol_18.html': true,
      './BRAINUP/social/pol_19.html': true,
      './BRAINUP/social/pol_20.html': true,
      './BRAINUP/social/soc_01.html': true,
      './BRAINUP/social/soc_02.html': true,
      './BRAINUP/social/soc_03.html': true,
      './BRAINUP/social/soc_04.html': true,
      './BRAINUP/social/soc_05.html': true,
      './BRAINUP/social/soc_06.html': true,
      './BRAINUP/social/soc_07.html': true,
      './BRAINUP/social/soc_08.html': true,
      './BRAINUP/social/soc_09.html': true,
      './BRAINUP/social/soc_10.html': true,
      './BRAINUP/social/soc_11.html': true,
      './BRAINUP/social/soc_12.html': true,
      './BRAINUP/social/soc_13.html': true,
      './BRAINUP/social/soc_14.html': true,
      './BRAINUP/social/soc_15.html': true,
      './BRAINUP/social/soc_16.html': true,
      './BRAINUP/social/soc_17.html': true,
      './BRAINUP/social/soc_18.html': true,
      './BRAINUP/social/soc_19.html': true,
      './BRAINUP/social/soc_20.html': true,
      './BRAINUP/worldlit/world1_01.html': true,
      './BRAINUP/worldlit/world1_02.html': true,
      './BRAINUP/worldlit/world1_03.html': true,
      './BRAINUP/worldlit/world1_04.html': true,
      './BRAINUP/worldlit/world1_05.html': true,
      './BRAINUP/worldlit/world1_06.html': true,
      './BRAINUP/worldlit/world1_07.html': true,
      './BRAINUP/worldlit/world1_08.html': true,
      './BRAINUP/worldlit/world1_09.html': true,
      './BRAINUP/worldlit/world1_10.html': true,
      './BRAINUP/worldlit/world1_11.html': true,
      './BRAINUP/worldlit/world1_12.html': true,
      './BRAINUP/worldlit/world1_13.html': true,
      './BRAINUP/worldlit/world1_14.html': true,
      './BRAINUP/worldlit/world1_15.html': true,
      './BRAINUP/worldlit/world1_16.html': true,
      './BRAINUP/worldlit/world1_17.html': true,
      './BRAINUP/worldlit/world1_18.html': true,
      './BRAINUP/worldlit/world1_19.html': true,
      './BRAINUP/worldlit/world1_20.html': true,
      './BRAINUP/worldlit/world1_21.html': true,
      './BRAINUP/worldlit/world1_22.html': true,
      './BRAINUP/worldlit/world1_23.html': true,
      './BRAINUP/worldlit/world1_24.html': true,
      './BRAINUP/worldlit/world1_25.html': true,
      './BRAINUP/worldlit/world1_26.html': true,
      './BRAINUP/worldlit/world1_27.html': true,
      './BRAINUP/worldlit/world1_28.html': true,
      './BRAINUP/worldlit/world1_29.html': true,
      './BRAINUP/worldlit/world1_30.html': true,
      './BRAINUP/worldlit/world1_31.html': true,
      './BRAINUP/worldlit/world1_32.html': true,
      './BRAINUP/worldlit/world1_33.html': true,
      './BRAINUP/worldlit/world1_34.html': true,
      './BRAINUP/worldlit/world1_35.html': true,
      './BRAINUP/worldlit/world1_36.html': true,
      './BRAINUP/worldlit/world1_37.html': true,
      './BRAINUP/worldlit/world1_38.html': true,
      './BRAINUP/worldlit/world1_39.html': true,
      './BRAINUP/worldlit/world1_40.html': true,
      './BRAINUP/worldlit/world2_01.html': true,
      './BRAINUP/worldlit/world2_02.html': true,
      './BRAINUP/worldlit/world2_03.html': true,
      './BRAINUP/worldlit/world2_04.html': true,
      './BRAINUP/worldlit/world2_05.html': true,
      './BRAINUP/worldlit/world2_06.html': true,
      './BRAINUP/worldlit/world2_07.html': true,
      './BRAINUP/worldlit/world2_08.html': true,
      './BRAINUP/worldlit/world2_09.html': true,
      './BRAINUP/worldlit/world2_10.html': true,
      './BRAINUP/worldlit/world2_11.html': true,
      './BRAINUP/worldlit/world2_12.html': true,
      './BRAINUP/worldlit/world2_13.html': true,
      './BRAINUP/worldlit/world2_14.html': true,
      './BRAINUP/worldlit/world2_15.html': true,
      './BRAINUP/worldlit/world2_16.html': true,
      './BRAINUP/worldlit/world2_17.html': true,
      './BRAINUP/worldlit/world2_18.html': true,
      './BRAINUP/worldlit/world2_19.html': true,
      './BRAINUP/worldlit/world2_20.html': true,
      './BRAINUP/worldlit/world2_21.html': true,
      './BRAINUP/worldlit/world2_22.html': true,
      './BRAINUP/worldlit/world2_23.html': true,
      './BRAINUP/worldlit/world2_24.html': true,
      './BRAINUP/worldlit/world2_25.html': true,
      './BRAINUP/worldlit/world2_26.html': true,
      './BRAINUP/worldlit/world2_27.html': true,
      './BRAINUP/worldlit/world2_28.html': true,
      './BRAINUP/worldlit/world2_29.html': true,
      './BRAINUP/worldlit/world2_30.html': true,
      './BRAINUP/worldlit/world2_31.html': true,
      './BRAINUP/worldlit/world2_32.html': true,
      './BRAINUP/worldlit/world2_33.html': true,
      './BRAINUP/worldlit/world2_34.html': true,
      './BRAINUP/worldlit/world2_35.html': true,
      './BRAINUP/worldlit/world2_36.html': true,
      './BRAINUP/worldlit/world2_37.html': true,
      './BRAINUP/worldlit/world2_38.html': true,
      './BRAINUP/worldlit/world2_39.html': true,
      './BRAINUP/worldlit/world2_40.html': true,
      './BRAINUP/korlit/fit_classic_01.html': true,
      './BRAINUP/korlit/fit_classic_02.html': true,
      './BRAINUP/korlit/fit_classic_03.html': true,
      './BRAINUP/korlit/fit_classic_04.html': true,
      './BRAINUP/korlit/fit_classic_05.html': true,
      './BRAINUP/korlit/fit_classic_06.html': true,
      './BRAINUP/korlit/fit_classic_07.html': true,
      './BRAINUP/korlit/fit_classic_08.html': true,
      './BRAINUP/korlit/fit_classic_09.html': true,
      './BRAINUP/korlit/fit_classic_10.html': true,
      './BRAINUP/korlit/fit_classic_11.html': true,
      './BRAINUP/korlit/fit_classic_12.html': true,
      './BRAINUP/korlit/fit_classic_13.html': true,
      './BRAINUP/korlit/fit_classic_14.html': true,
      './BRAINUP/korlit/fit_classic_15.html': true,
      './BRAINUP/korlit/fit_classic_16.html': true,
      './BRAINUP/korlit/fit_classic_17.html': true,
      './BRAINUP/korlit/fit_classic_18.html': true,
      './BRAINUP/korlit/fit_classic_19.html': true,
      './BRAINUP/korlit/fit_classic_20.html': true,
      './BRAINUP/korlit/fit_classic_21.html': true,
      './BRAINUP/korlit/fit_classic_22.html': true,
      './BRAINUP/korlit/fit_classic_23.html': true,
      './BRAINUP/korlit/fit_classic_24.html': true,
      './BRAINUP/korlit/fit_classic_25.html': true,
      './BRAINUP/korlit/fit_classic_26.html': true,
      './BRAINUP/korlit/fit_classic_27.html': true,
      './BRAINUP/korlit/fit_classic_28.html': true,
      './BRAINUP/korlit/fit_classic_29.html': true,
      './BRAINUP/korlit/fit_classic_30.html': true,
      './BRAINUP/korlit/fit_classic_31.html': true,
      './BRAINUP/korlit/fit_classic_32.html': true,
      './BRAINUP/korlit/fit_classic_33.html': true,
      './BRAINUP/korlit/fit_classic_34.html': true,
      './BRAINUP/korlit/fit_classic_35.html': true,
      './BRAINUP/korlit/fit_classic_36.html': true,
      './BRAINUP/korlit/fit_classic_37.html': true,
      './BRAINUP/korlit/fit_classic_38.html': true,
      './BRAINUP/korlit/fit_classic_39.html': true,
      './BRAINUP/korlit/fit_classic_40.html': true,
      './BRAINUP/korlit/fit_modern_01.html': true,
      './BRAINUP/korlit/fit_modern_02.html': true,
      './BRAINUP/korlit/fit_modern_03.html': true,
      './BRAINUP/korlit/fit_modern_04.html': true,
      './BRAINUP/korlit/fit_modern_05.html': true,
      './BRAINUP/korlit/fit_modern_06.html': true,
      './BRAINUP/korlit/fit_modern_07.html': true,
      './BRAINUP/korlit/fit_modern_08.html': true,
      './BRAINUP/korlit/fit_modern_09.html': true,
      './BRAINUP/korlit/fit_modern_10.html': true,
      './BRAINUP/korlit/fit_modern_11.html': true,
      './BRAINUP/korlit/fit_modern_12.html': true,
      './BRAINUP/korlit/fit_modern_13.html': true,
      './BRAINUP/korlit/fit_modern_14.html': true,
      './BRAINUP/korlit/fit_modern_15.html': true,
      './BRAINUP/korlit/fit_modern_16.html': true,
      './BRAINUP/korlit/fit_modern_17.html': true,
      './BRAINUP/korlit/fit_modern_18.html': true,
      './BRAINUP/korlit/fit_modern_19.html': true,
      './BRAINUP/korlit/fit_modern_20.html': true,
      './BRAINUP/korlit/fit_modern_21.html': true,
      './BRAINUP/korlit/fit_modern_22.html': true,
      './BRAINUP/korlit/fit_modern_23.html': true,
      './BRAINUP/korlit/fit_modern_24.html': true,
      './BRAINUP/korlit/fit_modern_25.html': true,
      './BRAINUP/korlit/fit_modern_26.html': true,
      './BRAINUP/korlit/fit_modern_27.html': true,
      './BRAINUP/korlit/fit_modern_28.html': true,
      './BRAINUP/korlit/fit_modern_29.html': true,
      './BRAINUP/korlit/fit_modern_30.html': true,
      './BRAINUP/korlit/fit_modern_31.html': true,
      './BRAINUP/korlit/fit_modern_32.html': true,
      './BRAINUP/korlit/fit_modern_33.html': true,
      './BRAINUP/korlit/fit_modern_34.html': true,
      './BRAINUP/korlit/fit_modern_35.html': true,
      './BRAINUP/korlit/fit_modern_36.html': true,
      './BRAINUP/korlit/fit_modern_37.html': true,
      './BRAINUP/korlit/fit_modern_38.html': true,
      './BRAINUP/korlit/fit_modern_39.html': true,
      './BRAINUP/korlit/fit_modern_40.html': true,
      './BRAINUP/person/fit_people1_01.html': true,
      './BRAINUP/person/fit_people1_02.html': true,
      './BRAINUP/person/fit_people1_03.html': true,
      './BRAINUP/person/fit_people1_04.html': true,
      './BRAINUP/person/fit_people1_05.html': true,
      './BRAINUP/person/fit_people1_06.html': true,
      './BRAINUP/person/fit_people1_07.html': true,
      './BRAINUP/person/fit_people1_08.html': true,
      './BRAINUP/person/fit_people1_09.html': true,
      './BRAINUP/person/fit_people1_10.html': true,
      './BRAINUP/person/fit_people1_11.html': true,
      './BRAINUP/person/fit_people1_12.html': true,
      './BRAINUP/person/fit_people1_13.html': true,
      './BRAINUP/person/fit_people1_14.html': true,
      './BRAINUP/person/fit_people1_15.html': true,
      './BRAINUP/person/fit_people1_16.html': true,
      './BRAINUP/person/fit_people1_17.html': true,
      './BRAINUP/person/fit_people1_18.html': true,
      './BRAINUP/person/fit_people1_19.html': true,
      './BRAINUP/person/fit_people1_20.html': true,
      './BRAINUP/person/fit_people1_21.html': true,
      './BRAINUP/person/fit_people1_22.html': true,
      './BRAINUP/person/fit_people1_23.html': true,
      './BRAINUP/person/fit_people1_24.html': true,
      './BRAINUP/person/fit_people1_25.html': true,
      './BRAINUP/person/fit_people1_26.html': true,
      './BRAINUP/person/fit_people1_27.html': true,
      './BRAINUP/person/fit_people1_28.html': true,
      './BRAINUP/person/fit_people1_29.html': true,
      './BRAINUP/person/fit_people1_30.html': true,
      './BRAINUP/person/fit_people1_31.html': true,
      './BRAINUP/person/fit_people1_32.html': true,
      './BRAINUP/person/fit_people1_33.html': true,
      './BRAINUP/person/fit_people1_34.html': true,
      './BRAINUP/person/fit_people1_35.html': true,
      './BRAINUP/person/fit_people1_36.html': true,
      './BRAINUP/person/fit_people1_37.html': true,
      './BRAINUP/person/fit_people1_38.html': true,
      './BRAINUP/person/fit_people1_39.html': true,
      './BRAINUP/person/fit_people1_40.html': true,
      './BRAINUP/person/fit_people2_01.html': true,
      './BRAINUP/person/fit_people2_02.html': true,
      './BRAINUP/person/fit_people2_03.html': true,
      './BRAINUP/person/fit_people2_04.html': true,
      './BRAINUP/person/fit_people2_05.html': true,
      './BRAINUP/person/fit_people2_06.html': true,
      './BRAINUP/person/fit_people2_07.html': true,
      './BRAINUP/person/fit_people2_08.html': true,
      './BRAINUP/person/fit_people2_09.html': true,
      './BRAINUP/person/fit_people2_10.html': true,
      './BRAINUP/person/fit_people2_11.html': true,
      './BRAINUP/person/fit_people2_12.html': true,
      './BRAINUP/person/fit_people2_13.html': true,
      './BRAINUP/person/fit_people2_14.html': true,
      './BRAINUP/person/fit_people2_15.html': true,
      './BRAINUP/person/fit_people2_16.html': true,
      './BRAINUP/person/fit_people2_17.html': true,
      './BRAINUP/person/fit_people2_18.html': true,
      './BRAINUP/person/fit_people2_19.html': true,
      './BRAINUP/person/fit_people2_20.html': true,
      './BRAINUP/person/fit_people2_21.html': true,
      './BRAINUP/person/fit_people2_22.html': true,
      './BRAINUP/person/fit_people2_23.html': true,
      './BRAINUP/person/fit_people2_24.html': true,
      './BRAINUP/person/fit_people2_25.html': true,
      './BRAINUP/person/fit_people2_26.html': true,
      './BRAINUP/person/fit_people2_27.html': true,
      './BRAINUP/person/fit_people2_28.html': true,
      './BRAINUP/person/fit_people2_29.html': true,
      './BRAINUP/person/fit_people2_30.html': true,
      './BRAINUP/person/fit_people2_31.html': true,
      './BRAINUP/person/fit_people2_32.html': true,
      './BRAINUP/person/fit_people2_33.html': true,
      './BRAINUP/person/fit_people2_34.html': true,
      './BRAINUP/person/fit_people2_35.html': true,
      './BRAINUP/person/fit_people2_36.html': true,
      './BRAINUP/person/fit_people2_37.html': true,
      './BRAINUP/person/fit_people2_38.html': true,
      './BRAINUP/person/fit_people2_39.html': true,
      './BRAINUP/person/fit_people2_40.html': true,
      './BRAINUP/science/fit_bio_01.html': true,
      './BRAINUP/science/fit_bio_02.html': true,
      './BRAINUP/science/fit_bio_03.html': true,
      './BRAINUP/science/fit_bio_04.html': true,
      './BRAINUP/science/fit_bio_05.html': true,
      './BRAINUP/science/fit_bio_06.html': true,
      './BRAINUP/science/fit_bio_07.html': true,
      './BRAINUP/science/fit_bio_08.html': true,
      './BRAINUP/science/fit_bio_09.html': true,
      './BRAINUP/science/fit_bio_10.html': true,
      './BRAINUP/science/fit_bio_11.html': true,
      './BRAINUP/science/fit_bio_12.html': true,
      './BRAINUP/science/fit_bio_13.html': true,
      './BRAINUP/science/fit_bio_14.html': true,
      './BRAINUP/science/fit_bio_15.html': true,
      './BRAINUP/science/fit_bio_16.html': true,
      './BRAINUP/science/fit_bio_17.html': true,
      './BRAINUP/science/fit_bio_18.html': true,
      './BRAINUP/science/fit_bio_19.html': true,
      './BRAINUP/science/fit_bio_20.html': true,
      './BRAINUP/science/fit_chem_01.html': true,
      './BRAINUP/science/fit_chem_02.html': true,
      './BRAINUP/science/fit_chem_03.html': true,
      './BRAINUP/science/fit_chem_04.html': true,
      './BRAINUP/science/fit_chem_05.html': true,
      './BRAINUP/science/fit_chem_06.html': true,
      './BRAINUP/science/fit_chem_07.html': true,
      './BRAINUP/science/fit_chem_08.html': true,
      './BRAINUP/science/fit_chem_09.html': true,
      './BRAINUP/science/fit_chem_10.html': true,
      './BRAINUP/science/fit_chem_11.html': true,
      './BRAINUP/science/fit_chem_12.html': true,
      './BRAINUP/science/fit_chem_13.html': true,
      './BRAINUP/science/fit_chem_14.html': true,
      './BRAINUP/science/fit_chem_15.html': true,
      './BRAINUP/science/fit_chem_16.html': true,
      './BRAINUP/science/fit_chem_17.html': true,
      './BRAINUP/science/fit_chem_18.html': true,
      './BRAINUP/science/fit_chem_19.html': true,
      './BRAINUP/science/fit_chem_20.html': true,
      './BRAINUP/science/fit_earth_01.html': true,
      './BRAINUP/science/fit_earth_02.html': true,
      './BRAINUP/science/fit_earth_03.html': true,
      './BRAINUP/science/fit_earth_04.html': true,
      './BRAINUP/science/fit_earth_05.html': true,
      './BRAINUP/science/fit_earth_06.html': true,
      './BRAINUP/science/fit_earth_07.html': true,
      './BRAINUP/science/fit_earth_08.html': true,
      './BRAINUP/science/fit_earth_09.html': true,
      './BRAINUP/science/fit_earth_10.html': true,
      './BRAINUP/science/fit_earth_11.html': true,
      './BRAINUP/science/fit_earth_12.html': true,
      './BRAINUP/science/fit_earth_13.html': true,
      './BRAINUP/science/fit_earth_14.html': true,
      './BRAINUP/science/fit_earth_15.html': true,
      './BRAINUP/science/fit_earth_16.html': true,
      './BRAINUP/science/fit_earth_17.html': true,
      './BRAINUP/science/fit_earth_18.html': true,
      './BRAINUP/science/fit_earth_19.html': true,
      './BRAINUP/science/fit_earth_20.html': true,
      './BRAINUP/science/fit_physics_01.html': true,
      './BRAINUP/science/fit_physics_02.html': true,
      './BRAINUP/science/fit_physics_03.html': true,
      './BRAINUP/science/fit_physics_04.html': true,
      './BRAINUP/science/fit_physics_05.html': true,
      './BRAINUP/science/fit_physics_06.html': true,
      './BRAINUP/science/fit_physics_07.html': true,
      './BRAINUP/science/fit_physics_08.html': true,
      './BRAINUP/science/fit_physics_09.html': true,
      './BRAINUP/science/fit_physics_10.html': true,
      './BRAINUP/science/fit_physics_11.html': true,
      './BRAINUP/science/fit_physics_12.html': true,
      './BRAINUP/science/fit_physics_13.html': true,
      './BRAINUP/science/fit_physics_14.html': true,
      './BRAINUP/science/fit_physics_15.html': true,
      './BRAINUP/science/fit_physics_16.html': true,
      './BRAINUP/science/fit_physics_17.html': true,
      './BRAINUP/science/fit_physics_18.html': true,
      './BRAINUP/science/fit_physics_19.html': true,
      './BRAINUP/science/fit_physics_20.html': true,
      './BRAINUP/social/fit_geo_01.html': true,
      './BRAINUP/social/fit_geo_02.html': true,
      './BRAINUP/social/fit_geo_03.html': true,
      './BRAINUP/social/fit_geo_04.html': true,
      './BRAINUP/social/fit_geo_05.html': true,
      './BRAINUP/social/fit_geo_06.html': true,
      './BRAINUP/social/fit_geo_07.html': true,
      './BRAINUP/social/fit_geo_08.html': true,
      './BRAINUP/social/fit_geo_09.html': true,
      './BRAINUP/social/fit_geo_10.html': true,
      './BRAINUP/social/fit_geo_11.html': true,
      './BRAINUP/social/fit_geo_12.html': true,
      './BRAINUP/social/fit_geo_13.html': true,
      './BRAINUP/social/fit_geo_14.html': true,
      './BRAINUP/social/fit_geo_15.html': true,
      './BRAINUP/social/fit_geo_16.html': true,
      './BRAINUP/social/fit_geo_17.html': true,
      './BRAINUP/social/fit_geo_18.html': true,
      './BRAINUP/social/fit_geo_19.html': true,
      './BRAINUP/social/fit_geo_20.html': true,
      './BRAINUP/social/fit_law_01.html': true,
      './BRAINUP/social/fit_law_02.html': true,
      './BRAINUP/social/fit_law_03.html': true,
      './BRAINUP/social/fit_law_04.html': true,
      './BRAINUP/social/fit_law_05.html': true,
      './BRAINUP/social/fit_law_06.html': true,
      './BRAINUP/social/fit_law_07.html': true,
      './BRAINUP/social/fit_law_08.html': true,
      './BRAINUP/social/fit_law_09.html': true,
      './BRAINUP/social/fit_law_10.html': true,
      './BRAINUP/social/fit_law_11.html': true,
      './BRAINUP/social/fit_law_12.html': true,
      './BRAINUP/social/fit_law_13.html': true,
      './BRAINUP/social/fit_law_14.html': true,
      './BRAINUP/social/fit_law_15.html': true,
      './BRAINUP/social/fit_law_16.html': true,
      './BRAINUP/social/fit_law_17.html': true,
      './BRAINUP/social/fit_law_18.html': true,
      './BRAINUP/social/fit_law_19.html': true,
      './BRAINUP/social/fit_law_20.html': true,
      './BRAINUP/social/fit_pol_01.html': true,
      './BRAINUP/social/fit_pol_02.html': true,
      './BRAINUP/social/fit_pol_03.html': true,
      './BRAINUP/social/fit_pol_04.html': true,
      './BRAINUP/social/fit_pol_05.html': true,
      './BRAINUP/social/fit_pol_06.html': true,
      './BRAINUP/social/fit_pol_07.html': true,
      './BRAINUP/social/fit_pol_08.html': true,
      './BRAINUP/social/fit_pol_09.html': true,
      './BRAINUP/social/fit_pol_10.html': true,
      './BRAINUP/social/fit_pol_11.html': true,
      './BRAINUP/social/fit_pol_12.html': true,
      './BRAINUP/social/fit_pol_13.html': true,
      './BRAINUP/social/fit_pol_14.html': true,
      './BRAINUP/social/fit_pol_15.html': true,
      './BRAINUP/social/fit_pol_16.html': true,
      './BRAINUP/social/fit_pol_17.html': true,
      './BRAINUP/social/fit_pol_18.html': true,
      './BRAINUP/social/fit_pol_19.html': true,
      './BRAINUP/social/fit_pol_20.html': true,
      './BRAINUP/social/fit_soc_01.html': true,
      './BRAINUP/social/fit_soc_02.html': true,
      './BRAINUP/social/fit_soc_03.html': true,
      './BRAINUP/social/fit_soc_04.html': true,
      './BRAINUP/social/fit_soc_05.html': true,
      './BRAINUP/social/fit_soc_06.html': true,
      './BRAINUP/social/fit_soc_07.html': true,
      './BRAINUP/social/fit_soc_08.html': true,
      './BRAINUP/social/fit_soc_09.html': true,
      './BRAINUP/social/fit_soc_10.html': true,
      './BRAINUP/social/fit_soc_11.html': true,
      './BRAINUP/social/fit_soc_12.html': true,
      './BRAINUP/social/fit_soc_13.html': true,
      './BRAINUP/social/fit_soc_14.html': true,
      './BRAINUP/social/fit_soc_15.html': true,
      './BRAINUP/social/fit_soc_16.html': true,
      './BRAINUP/social/fit_soc_17.html': true,
      './BRAINUP/social/fit_soc_18.html': true,
      './BRAINUP/social/fit_soc_19.html': true,
      './BRAINUP/social/fit_soc_20.html': true,
      './BRAINUP/worldlit/fit_world1_01.html': true,
      './BRAINUP/worldlit/fit_world1_02.html': true,
      './BRAINUP/worldlit/fit_world1_03.html': true,
      './BRAINUP/worldlit/fit_world1_04.html': true,
      './BRAINUP/worldlit/fit_world1_05.html': true,
      './BRAINUP/worldlit/fit_world1_06.html': true,
      './BRAINUP/worldlit/fit_world1_07.html': true,
      './BRAINUP/worldlit/fit_world1_08.html': true,
      './BRAINUP/worldlit/fit_world1_09.html': true,
      './BRAINUP/worldlit/fit_world1_10.html': true,
      './BRAINUP/worldlit/fit_world1_11.html': true,
      './BRAINUP/worldlit/fit_world1_12.html': true,
      './BRAINUP/worldlit/fit_world1_13.html': true,
      './BRAINUP/worldlit/fit_world1_14.html': true,
      './BRAINUP/worldlit/fit_world1_15.html': true,
      './BRAINUP/worldlit/fit_world1_16.html': true,
      './BRAINUP/worldlit/fit_world1_17.html': true,
      './BRAINUP/worldlit/fit_world1_18.html': true,
      './BRAINUP/worldlit/fit_world1_19.html': true,
      './BRAINUP/worldlit/fit_world1_20.html': true,
      './BRAINUP/worldlit/fit_world1_21.html': true,
      './BRAINUP/worldlit/fit_world1_22.html': true,
      './BRAINUP/worldlit/fit_world1_23.html': true,
      './BRAINUP/worldlit/fit_world1_24.html': true,
      './BRAINUP/worldlit/fit_world1_25.html': true,
      './BRAINUP/worldlit/fit_world1_26.html': true,
      './BRAINUP/worldlit/fit_world1_27.html': true,
      './BRAINUP/worldlit/fit_world1_28.html': true,
      './BRAINUP/worldlit/fit_world1_29.html': true,
      './BRAINUP/worldlit/fit_world1_30.html': true,
      './BRAINUP/worldlit/fit_world1_31.html': true,
      './BRAINUP/worldlit/fit_world1_32.html': true,
      './BRAINUP/worldlit/fit_world1_33.html': true,
      './BRAINUP/worldlit/fit_world1_34.html': true,
      './BRAINUP/worldlit/fit_world1_35.html': true,
      './BRAINUP/worldlit/fit_world1_36.html': true,
      './BRAINUP/worldlit/fit_world1_37.html': true,
      './BRAINUP/worldlit/fit_world1_38.html': true,
      './BRAINUP/worldlit/fit_world1_39.html': true,
      './BRAINUP/worldlit/fit_world1_40.html': true,
      './BRAINUP/worldlit/fit_world2_01.html': true,
      './BRAINUP/worldlit/fit_world2_02.html': true,
      './BRAINUP/worldlit/fit_world2_03.html': true,
      './BRAINUP/worldlit/fit_world2_04.html': true,
      './BRAINUP/worldlit/fit_world2_05.html': true,
      './BRAINUP/worldlit/fit_world2_06.html': true,
      './BRAINUP/worldlit/fit_world2_07.html': true,
      './BRAINUP/worldlit/fit_world2_08.html': true,
      './BRAINUP/worldlit/fit_world2_09.html': true,
      './BRAINUP/worldlit/fit_world2_10.html': true,
      './BRAINUP/worldlit/fit_world2_11.html': true,
      './BRAINUP/worldlit/fit_world2_12.html': true,
      './BRAINUP/worldlit/fit_world2_13.html': true,
      './BRAINUP/worldlit/fit_world2_14.html': true,
      './BRAINUP/worldlit/fit_world2_15.html': true,
      './BRAINUP/worldlit/fit_world2_16.html': true,
      './BRAINUP/worldlit/fit_world2_17.html': true,
      './BRAINUP/worldlit/fit_world2_18.html': true,
      './BRAINUP/worldlit/fit_world2_19.html': true,
      './BRAINUP/worldlit/fit_world2_20.html': true,
      './BRAINUP/worldlit/fit_world2_21.html': true,
      './BRAINUP/worldlit/fit_world2_22.html': true,
      './BRAINUP/worldlit/fit_world2_23.html': true,
      './BRAINUP/worldlit/fit_world2_24.html': true,
      './BRAINUP/worldlit/fit_world2_25.html': true,
      './BRAINUP/worldlit/fit_world2_26.html': true,
      './BRAINUP/worldlit/fit_world2_27.html': true,
      './BRAINUP/worldlit/fit_world2_28.html': true,
      './BRAINUP/worldlit/fit_world2_29.html': true,
      './BRAINUP/worldlit/fit_world2_30.html': true,
      './BRAINUP/worldlit/fit_world2_31.html': true,
      './BRAINUP/worldlit/fit_world2_32.html': true,
      './BRAINUP/worldlit/fit_world2_33.html': true,
      './BRAINUP/worldlit/fit_world2_34.html': true,
      './BRAINUP/worldlit/fit_world2_35.html': true,
      './BRAINUP/worldlit/fit_world2_36.html': true,
      './BRAINUP/worldlit/fit_world2_37.html': true,
      './BRAINUP/worldlit/fit_world2_38.html': true,
      './BRAINUP/worldlit/fit_world2_39.html': true,
      './BRAINUP/worldlit/fit_world2_40.html': true,
      './BRAINUP/korlit/deep_classic_01.html': true,
      './BRAINUP/korlit/deep_classic_02.html': true,
      './BRAINUP/korlit/deep_classic_03.html': true,
      './BRAINUP/korlit/deep_classic_04.html': true,
      './BRAINUP/korlit/deep_classic_05.html': true,
      './BRAINUP/korlit/deep_classic_06.html': true,
      './BRAINUP/korlit/deep_classic_07.html': true,
      './BRAINUP/korlit/deep_classic_08.html': true,
      './BRAINUP/korlit/deep_classic_09.html': true,
      './BRAINUP/korlit/deep_classic_10.html': true,
      './BRAINUP/korlit/deep_classic_11.html': true,
      './BRAINUP/korlit/deep_classic_12.html': true,
      './BRAINUP/korlit/deep_classic_13.html': true,
      './BRAINUP/korlit/deep_classic_14.html': true,
      './BRAINUP/korlit/deep_classic_15.html': true,
      './BRAINUP/korlit/deep_classic_16.html': true,
      './BRAINUP/korlit/deep_classic_17.html': true,
      './BRAINUP/korlit/deep_classic_18.html': true,
      './BRAINUP/korlit/deep_classic_19.html': true,
      './BRAINUP/korlit/deep_classic_20.html': true,
      './BRAINUP/korlit/deep_classic_21.html': true,
      './BRAINUP/korlit/deep_classic_22.html': true,
      './BRAINUP/korlit/deep_classic_23.html': true,
      './BRAINUP/korlit/deep_classic_24.html': true,
      './BRAINUP/korlit/deep_classic_25.html': true,
      './BRAINUP/korlit/deep_classic_26.html': true,
      './BRAINUP/korlit/deep_classic_27.html': true,
      './BRAINUP/korlit/deep_classic_28.html': true,
      './BRAINUP/korlit/deep_classic_29.html': true,
      './BRAINUP/korlit/deep_classic_30.html': true,
      './BRAINUP/korlit/deep_classic_31.html': true,
      './BRAINUP/korlit/deep_classic_32.html': true,
      './BRAINUP/korlit/deep_classic_33.html': true,
      './BRAINUP/korlit/deep_classic_34.html': true,
      './BRAINUP/korlit/deep_classic_35.html': true,
      './BRAINUP/korlit/deep_classic_36.html': true,
      './BRAINUP/korlit/deep_classic_37.html': true,
      './BRAINUP/korlit/deep_classic_38.html': true,
      './BRAINUP/korlit/deep_classic_39.html': true,
      './BRAINUP/korlit/deep_classic_40.html': true,
      './BRAINUP/korlit/deep_modern_01.html': true,
      './BRAINUP/korlit/deep_modern_02.html': true,
      './BRAINUP/korlit/deep_modern_03.html': true,
      './BRAINUP/korlit/deep_modern_04.html': true,
      './BRAINUP/korlit/deep_modern_05.html': true,
      './BRAINUP/korlit/deep_modern_06.html': true,
      './BRAINUP/korlit/deep_modern_07.html': true,
      './BRAINUP/korlit/deep_modern_08.html': true,
      './BRAINUP/korlit/deep_modern_09.html': true,
      './BRAINUP/korlit/deep_modern_10.html': true,
      './BRAINUP/korlit/deep_modern_11.html': true,
      './BRAINUP/korlit/deep_modern_12.html': true,
      './BRAINUP/korlit/deep_modern_13.html': true,
      './BRAINUP/korlit/deep_modern_14.html': true,
      './BRAINUP/korlit/deep_modern_15.html': true,
      './BRAINUP/korlit/deep_modern_16.html': true,
      './BRAINUP/korlit/deep_modern_17.html': true,
      './BRAINUP/korlit/deep_modern_18.html': true,
      './BRAINUP/korlit/deep_modern_19.html': true,
      './BRAINUP/korlit/deep_modern_20.html': true,
      './BRAINUP/korlit/deep_modern_21.html': true,
      './BRAINUP/korlit/deep_modern_22.html': true,
      './BRAINUP/korlit/deep_modern_23.html': true,
      './BRAINUP/korlit/deep_modern_24.html': true,
      './BRAINUP/korlit/deep_modern_25.html': true,
      './BRAINUP/korlit/deep_modern_26.html': true,
      './BRAINUP/korlit/deep_modern_27.html': true,
      './BRAINUP/korlit/deep_modern_28.html': true,
      './BRAINUP/korlit/deep_modern_29.html': true,
      './BRAINUP/korlit/deep_modern_30.html': true,
      './BRAINUP/korlit/deep_modern_31.html': true,
      './BRAINUP/korlit/deep_modern_32.html': true,
      './BRAINUP/korlit/deep_modern_33.html': true,
      './BRAINUP/korlit/deep_modern_34.html': true,
      './BRAINUP/korlit/deep_modern_35.html': true,
      './BRAINUP/korlit/deep_modern_36.html': true,
      './BRAINUP/korlit/deep_modern_37.html': true,
      './BRAINUP/korlit/deep_modern_38.html': true,
      './BRAINUP/korlit/deep_modern_39.html': true,
      './BRAINUP/korlit/deep_modern_40.html': true,
      './BRAINUP/person/deep_people1_01.html': true,
      './BRAINUP/person/deep_people1_02.html': true,
      './BRAINUP/person/deep_people1_03.html': true,
      './BRAINUP/person/deep_people1_04.html': true,
      './BRAINUP/person/deep_people1_05.html': true,
      './BRAINUP/person/deep_people1_06.html': true,
      './BRAINUP/person/deep_people1_07.html': true,
      './BRAINUP/person/deep_people1_08.html': true,
      './BRAINUP/person/deep_people1_09.html': true,
      './BRAINUP/person/deep_people1_10.html': true,
      './BRAINUP/person/deep_people1_11.html': true,
      './BRAINUP/person/deep_people1_12.html': true,
      './BRAINUP/person/deep_people1_13.html': true,
      './BRAINUP/person/deep_people1_14.html': true,
      './BRAINUP/person/deep_people1_15.html': true,
      './BRAINUP/person/deep_people1_16.html': true,
      './BRAINUP/person/deep_people1_17.html': true,
      './BRAINUP/person/deep_people1_18.html': true,
      './BRAINUP/person/deep_people1_19.html': true,
      './BRAINUP/person/deep_people1_20.html': true,
      './BRAINUP/person/deep_people1_21.html': true,
      './BRAINUP/person/deep_people1_22.html': true,
      './BRAINUP/person/deep_people1_23.html': true,
      './BRAINUP/person/deep_people1_24.html': true,
      './BRAINUP/person/deep_people1_25.html': true,
      './BRAINUP/person/deep_people1_26.html': true,
      './BRAINUP/person/deep_people1_27.html': true,
      './BRAINUP/person/deep_people1_28.html': true,
      './BRAINUP/person/deep_people1_29.html': true,
      './BRAINUP/person/deep_people1_30.html': true,
      './BRAINUP/person/deep_people1_31.html': true,
      './BRAINUP/person/deep_people1_32.html': true,
      './BRAINUP/person/deep_people1_33.html': true,
      './BRAINUP/person/deep_people1_34.html': true,
      './BRAINUP/person/deep_people1_35.html': true,
      './BRAINUP/person/deep_people1_36.html': true,
      './BRAINUP/person/deep_people1_37.html': true,
      './BRAINUP/person/deep_people1_38.html': true,
      './BRAINUP/person/deep_people1_39.html': true,
      './BRAINUP/person/deep_people1_40.html': true,
      './BRAINUP/person/deep_people2_01.html': true,
      './BRAINUP/person/deep_people2_02.html': true,
      './BRAINUP/person/deep_people2_03.html': true,
      './BRAINUP/person/deep_people2_04.html': true,
      './BRAINUP/person/deep_people2_05.html': true,
      './BRAINUP/person/deep_people2_06.html': true,
      './BRAINUP/person/deep_people2_07.html': true,
      './BRAINUP/person/deep_people2_08.html': true,
      './BRAINUP/person/deep_people2_09.html': true,
      './BRAINUP/person/deep_people2_10.html': true,
      './BRAINUP/person/deep_people2_11.html': true,
      './BRAINUP/person/deep_people2_12.html': true,
      './BRAINUP/person/deep_people2_13.html': true,
      './BRAINUP/person/deep_people2_14.html': true,
      './BRAINUP/person/deep_people2_15.html': true,
      './BRAINUP/person/deep_people2_16.html': true,
      './BRAINUP/person/deep_people2_17.html': true,
      './BRAINUP/person/deep_people2_18.html': true,
      './BRAINUP/person/deep_people2_19.html': true,
      './BRAINUP/person/deep_people2_20.html': true,
      './BRAINUP/person/deep_people2_21.html': true,
      './BRAINUP/person/deep_people2_22.html': true,
      './BRAINUP/person/deep_people2_23.html': true,
      './BRAINUP/person/deep_people2_24.html': true,
      './BRAINUP/person/deep_people2_25.html': true,
      './BRAINUP/person/deep_people2_26.html': true,
      './BRAINUP/person/deep_people2_27.html': true,
      './BRAINUP/person/deep_people2_28.html': true,
      './BRAINUP/person/deep_people2_29.html': true,
      './BRAINUP/person/deep_people2_30.html': true,
      './BRAINUP/person/deep_people2_31.html': true,
      './BRAINUP/person/deep_people2_32.html': true,
      './BRAINUP/person/deep_people2_33.html': true,
      './BRAINUP/person/deep_people2_34.html': true,
      './BRAINUP/person/deep_people2_35.html': true,
      './BRAINUP/person/deep_people2_36.html': true,
      './BRAINUP/person/deep_people2_37.html': true,
      './BRAINUP/person/deep_people2_38.html': true,
      './BRAINUP/person/deep_people2_39.html': true,
      './BRAINUP/person/deep_people2_40.html': true,
      './BRAINUP/science/deep_bio_01.html': true,
      './BRAINUP/science/deep_bio_02.html': true,
      './BRAINUP/science/deep_bio_03.html': true,
      './BRAINUP/science/deep_bio_04.html': true,
      './BRAINUP/science/deep_bio_05.html': true,
      './BRAINUP/science/deep_bio_06.html': true,
      './BRAINUP/science/deep_bio_07.html': true,
      './BRAINUP/science/deep_bio_08.html': true,
      './BRAINUP/science/deep_bio_09.html': true,
      './BRAINUP/science/deep_bio_10.html': true,
      './BRAINUP/science/deep_bio_11.html': true,
      './BRAINUP/science/deep_bio_12.html': true,
      './BRAINUP/science/deep_bio_13.html': true,
      './BRAINUP/science/deep_bio_14.html': true,
      './BRAINUP/science/deep_bio_15.html': true,
      './BRAINUP/science/deep_bio_16.html': true,
      './BRAINUP/science/deep_bio_17.html': true,
      './BRAINUP/science/deep_bio_18.html': true,
      './BRAINUP/science/deep_bio_19.html': true,
      './BRAINUP/science/deep_bio_20.html': true,
      './BRAINUP/science/deep_chem_01.html': true,
      './BRAINUP/science/deep_chem_02.html': true,
      './BRAINUP/science/deep_chem_03.html': true,
      './BRAINUP/science/deep_chem_04.html': true,
      './BRAINUP/science/deep_chem_05.html': true,
      './BRAINUP/science/deep_chem_06.html': true,
      './BRAINUP/science/deep_chem_07.html': true,
      './BRAINUP/science/deep_chem_08.html': true,
      './BRAINUP/science/deep_chem_09.html': true,
      './BRAINUP/science/deep_chem_10.html': true,
      './BRAINUP/science/deep_chem_11.html': true,
      './BRAINUP/science/deep_chem_12.html': true,
      './BRAINUP/science/deep_chem_13.html': true,
      './BRAINUP/science/deep_chem_14.html': true,
      './BRAINUP/science/deep_chem_15.html': true,
      './BRAINUP/science/deep_chem_16.html': true,
      './BRAINUP/science/deep_chem_17.html': true,
      './BRAINUP/science/deep_chem_18.html': true,
      './BRAINUP/science/deep_chem_19.html': true,
      './BRAINUP/science/deep_chem_20.html': true,
      './BRAINUP/science/deep_earth_01.html': true,
      './BRAINUP/science/deep_earth_02.html': true,
      './BRAINUP/science/deep_earth_03.html': true,
      './BRAINUP/science/deep_earth_04.html': true,
      './BRAINUP/science/deep_earth_05.html': true,
      './BRAINUP/science/deep_earth_06.html': true,
      './BRAINUP/science/deep_earth_07.html': true,
      './BRAINUP/science/deep_earth_08.html': true,
      './BRAINUP/science/deep_earth_09.html': true,
      './BRAINUP/science/deep_earth_10.html': true,
      './BRAINUP/science/deep_earth_11.html': true,
      './BRAINUP/science/deep_earth_12.html': true,
      './BRAINUP/science/deep_earth_13.html': true,
      './BRAINUP/science/deep_earth_14.html': true,
      './BRAINUP/science/deep_earth_15.html': true,
      './BRAINUP/science/deep_earth_16.html': true,
      './BRAINUP/science/deep_earth_17.html': true,
      './BRAINUP/science/deep_earth_18.html': true,
      './BRAINUP/science/deep_earth_19.html': true,
      './BRAINUP/science/deep_earth_20.html': true,
      './BRAINUP/science/deep_physics_01.html': true,
      './BRAINUP/science/deep_physics_02.html': true,
      './BRAINUP/science/deep_physics_03.html': true,
      './BRAINUP/science/deep_physics_04.html': true,
      './BRAINUP/science/deep_physics_05.html': true,
      './BRAINUP/science/deep_physics_06.html': true,
      './BRAINUP/science/deep_physics_07.html': true,
      './BRAINUP/science/deep_physics_08.html': true,
      './BRAINUP/science/deep_physics_09.html': true,
      './BRAINUP/science/deep_physics_10.html': true,
      './BRAINUP/science/deep_physics_11.html': true,
      './BRAINUP/science/deep_physics_12.html': true,
      './BRAINUP/science/deep_physics_13.html': true,
      './BRAINUP/science/deep_physics_14.html': true,
      './BRAINUP/science/deep_physics_15.html': true,
      './BRAINUP/science/deep_physics_16.html': true,
      './BRAINUP/science/deep_physics_17.html': true,
      './BRAINUP/science/deep_physics_18.html': true,
      './BRAINUP/science/deep_physics_19.html': true,
      './BRAINUP/science/deep_physics_20.html': true,
      './BRAINUP/social/deep_geo_01.html': true,
      './BRAINUP/social/deep_geo_02.html': true,
      './BRAINUP/social/deep_geo_03.html': true,
      './BRAINUP/social/deep_geo_04.html': true,
      './BRAINUP/social/deep_geo_05.html': true,
      './BRAINUP/social/deep_geo_06.html': true,
      './BRAINUP/social/deep_geo_07.html': true,
      './BRAINUP/social/deep_geo_08.html': true,
      './BRAINUP/social/deep_geo_09.html': true,
      './BRAINUP/social/deep_geo_10.html': true,
      './BRAINUP/social/deep_geo_11.html': true,
      './BRAINUP/social/deep_geo_12.html': true,
      './BRAINUP/social/deep_geo_13.html': true,
      './BRAINUP/social/deep_geo_14.html': true,
      './BRAINUP/social/deep_geo_15.html': true,
      './BRAINUP/social/deep_geo_16.html': true,
      './BRAINUP/social/deep_geo_17.html': true,
      './BRAINUP/social/deep_geo_18.html': true,
      './BRAINUP/social/deep_geo_19.html': true,
      './BRAINUP/social/deep_geo_20.html': true,
      './BRAINUP/social/deep_law_01.html': true,
      './BRAINUP/social/deep_law_02.html': true,
      './BRAINUP/social/deep_law_03.html': true,
      './BRAINUP/social/deep_law_04.html': true,
      './BRAINUP/social/deep_law_05.html': true,
      './BRAINUP/social/deep_law_06.html': true,
      './BRAINUP/social/deep_law_07.html': true,
      './BRAINUP/social/deep_law_08.html': true,
      './BRAINUP/social/deep_law_09.html': true,
      './BRAINUP/social/deep_law_10.html': true,
      './BRAINUP/social/deep_law_11.html': true,
      './BRAINUP/social/deep_law_12.html': true,
      './BRAINUP/social/deep_law_13.html': true,
      './BRAINUP/social/deep_law_14.html': true,
      './BRAINUP/social/deep_law_15.html': true,
      './BRAINUP/social/deep_law_16.html': true,
      './BRAINUP/social/deep_law_17.html': true,
      './BRAINUP/social/deep_law_18.html': true,
      './BRAINUP/social/deep_law_19.html': true,
      './BRAINUP/social/deep_law_20.html': true,
      './BRAINUP/social/deep_pol_01.html': true,
      './BRAINUP/social/deep_pol_02.html': true,
      './BRAINUP/social/deep_pol_03.html': true,
      './BRAINUP/social/deep_pol_04.html': true,
      './BRAINUP/social/deep_pol_05.html': true,
      './BRAINUP/social/deep_pol_06.html': true,
      './BRAINUP/social/deep_pol_07.html': true,
      './BRAINUP/social/deep_pol_08.html': true,
      './BRAINUP/social/deep_pol_09.html': true,
      './BRAINUP/social/deep_pol_10.html': true,
      './BRAINUP/social/deep_pol_11.html': true,
      './BRAINUP/social/deep_pol_12.html': true,
      './BRAINUP/social/deep_pol_13.html': true,
      './BRAINUP/social/deep_pol_14.html': true,
      './BRAINUP/social/deep_pol_15.html': true,
      './BRAINUP/social/deep_pol_16.html': true,
      './BRAINUP/social/deep_pol_17.html': true,
      './BRAINUP/social/deep_pol_18.html': true,
      './BRAINUP/social/deep_pol_19.html': true,
      './BRAINUP/social/deep_pol_20.html': true,
      './BRAINUP/social/deep_soc_01.html': true,
      './BRAINUP/social/deep_soc_02.html': true,
      './BRAINUP/social/deep_soc_03.html': true,
      './BRAINUP/social/deep_soc_04.html': true,
      './BRAINUP/social/deep_soc_05.html': true,
      './BRAINUP/social/deep_soc_06.html': true,
      './BRAINUP/social/deep_soc_07.html': true,
      './BRAINUP/social/deep_soc_08.html': true,
      './BRAINUP/social/deep_soc_09.html': true,
      './BRAINUP/social/deep_soc_10.html': true,
      './BRAINUP/social/deep_soc_11.html': true,
      './BRAINUP/social/deep_soc_12.html': true,
      './BRAINUP/social/deep_soc_13.html': true,
      './BRAINUP/social/deep_soc_14.html': true,
      './BRAINUP/social/deep_soc_15.html': true,
      './BRAINUP/social/deep_soc_16.html': true,
      './BRAINUP/social/deep_soc_17.html': true,
      './BRAINUP/social/deep_soc_18.html': true,
      './BRAINUP/social/deep_soc_19.html': true,
      './BRAINUP/social/deep_soc_20.html': true,
      './BRAINUP/worldlit/deep_world1_01.html': true,
      './BRAINUP/worldlit/deep_world1_02.html': true,
      './BRAINUP/worldlit/deep_world1_03.html': true,
      './BRAINUP/worldlit/deep_world1_04.html': true,
      './BRAINUP/worldlit/deep_world1_05.html': true,
      './BRAINUP/worldlit/deep_world1_06.html': true,
      './BRAINUP/worldlit/deep_world1_07.html': true,
      './BRAINUP/worldlit/deep_world1_08.html': true,
      './BRAINUP/worldlit/deep_world1_09.html': true,
      './BRAINUP/worldlit/deep_world1_10.html': true,
      './BRAINUP/worldlit/deep_world1_11.html': true,
      './BRAINUP/worldlit/deep_world1_12.html': true,
      './BRAINUP/worldlit/deep_world1_13.html': true,
      './BRAINUP/worldlit/deep_world1_14.html': true,
      './BRAINUP/worldlit/deep_world1_15.html': true,
      './BRAINUP/worldlit/deep_world1_16.html': true,
      './BRAINUP/worldlit/deep_world1_17.html': true,
      './BRAINUP/worldlit/deep_world1_18.html': true,
      './BRAINUP/worldlit/deep_world1_19.html': true,
      './BRAINUP/worldlit/deep_world1_20.html': true,
      './BRAINUP/worldlit/deep_world1_21.html': true,
      './BRAINUP/worldlit/deep_world1_22.html': true,
      './BRAINUP/worldlit/deep_world1_23.html': true,
      './BRAINUP/worldlit/deep_world1_24.html': true,
      './BRAINUP/worldlit/deep_world1_25.html': true,
      './BRAINUP/worldlit/deep_world1_26.html': true,
      './BRAINUP/worldlit/deep_world1_27.html': true,
      './BRAINUP/worldlit/deep_world1_28.html': true,
      './BRAINUP/worldlit/deep_world1_29.html': true,
      './BRAINUP/worldlit/deep_world1_30.html': true,
      './BRAINUP/worldlit/deep_world1_31.html': true,
      './BRAINUP/worldlit/deep_world1_32.html': true,
      './BRAINUP/worldlit/deep_world1_33.html': true,
      './BRAINUP/worldlit/deep_world1_34.html': true,
      './BRAINUP/worldlit/deep_world1_35.html': true,
      './BRAINUP/worldlit/deep_world1_36.html': true,
      './BRAINUP/worldlit/deep_world1_37.html': true,
      './BRAINUP/worldlit/deep_world1_38.html': true,
      './BRAINUP/worldlit/deep_world1_39.html': true,
      './BRAINUP/worldlit/deep_world1_40.html': true,
      './BRAINUP/worldlit/deep_world2_01.html': true,
      './BRAINUP/worldlit/deep_world2_02.html': true,
      './BRAINUP/worldlit/deep_world2_03.html': true,
      './BRAINUP/worldlit/deep_world2_04.html': true,
      './BRAINUP/worldlit/deep_world2_05.html': true,
      './BRAINUP/worldlit/deep_world2_06.html': true,
      './BRAINUP/worldlit/deep_world2_07.html': true,
      './BRAINUP/worldlit/deep_world2_08.html': true,
      './BRAINUP/worldlit/deep_world2_09.html': true,
      './BRAINUP/worldlit/deep_world2_10.html': true,
      './BRAINUP/worldlit/deep_world2_11.html': true,
      './BRAINUP/worldlit/deep_world2_12.html': true,
      './BRAINUP/worldlit/deep_world2_13.html': true,
      './BRAINUP/worldlit/deep_world2_14.html': true,
      './BRAINUP/worldlit/deep_world2_15.html': true,
      './BRAINUP/worldlit/deep_world2_16.html': true,
      './BRAINUP/worldlit/deep_world2_17.html': true,
      './BRAINUP/worldlit/deep_world2_18.html': true,
      './BRAINUP/worldlit/deep_world2_19.html': true,
      './BRAINUP/worldlit/deep_world2_20.html': true,
      './BRAINUP/worldlit/deep_world2_21.html': true,
      './BRAINUP/worldlit/deep_world2_22.html': true,
      './BRAINUP/worldlit/deep_world2_23.html': true,
      './BRAINUP/worldlit/deep_world2_24.html': true,
      './BRAINUP/worldlit/deep_world2_25.html': true,
      './BRAINUP/worldlit/deep_world2_26.html': true,
      './BRAINUP/worldlit/deep_world2_27.html': true,
      './BRAINUP/worldlit/deep_world2_28.html': true,
      './BRAINUP/worldlit/deep_world2_29.html': true,
      './BRAINUP/worldlit/deep_world2_30.html': true,
      './BRAINUP/worldlit/deep_world2_31.html': true,
      './BRAINUP/worldlit/deep_world2_32.html': true,
      './BRAINUP/worldlit/deep_world2_33.html': true,
      './BRAINUP/worldlit/deep_world2_34.html': true,
      './BRAINUP/worldlit/deep_world2_35.html': true,
      './BRAINUP/worldlit/deep_world2_36.html': true,
      './BRAINUP/worldlit/deep_world2_37.html': true,
      './BRAINUP/worldlit/deep_world2_38.html': true,
      './BRAINUP/worldlit/deep_world2_39.html': true,
      './BRAINUP/worldlit/deep_world2_40.html': true
};

    // === 준비 중 팝업 열기/닫기 ===
    function showComingSoonPopup() {
      const overlay = document.getElementById('comingSoonOverlay');
      if (overlay) {
        overlay.classList.add('show');
      }
    }

    function closeComingSoonPopup() {
      const overlay = document.getElementById('comingSoonOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    // === 단원 ID를 파일 경로로 변환 ===
    function getUnitPath(unitId) {
      console.log('🔍 getUnitPath called with:', unitId);

      // unitId가 이미 경로인 경우 그대로 반환
      if (unitId && unitId.startsWith('./')) {
        console.log('✅ unitId is already a path, returning:', unitId);
        return unitId;
      }

      // 구 형식 ID를 새 형식으로 변환 (기존 데이터 호환성)
      // world_XX -> world1_XX 또는 world2_XX (41~80은 world2_01~40)
      // people_XX -> people1_XX 또는 people2_XX (41~80은 people2_01~40)
      if (unitId) {
        const legacyMatch = unitId.match(/^(world|people)_(\d+)$/i);
        if (legacyMatch) {
          const oldPrefix = legacyMatch[1].toLowerCase();
          const num = parseInt(legacyMatch[2], 10);

          // 41~80은 세계문학2/세계인물의 1~40
          if (num >= 41 && num <= 80) {
            const newNum = (num - 40).toString().padStart(2, '0');
            unitId = `${oldPrefix}2_${newNum}`;
          } else {
            const paddedNum = num.toString().padStart(2, '0');
            unitId = `${oldPrefix}1_${paddedNum}`;
          }
          console.log(`🔄 Converting legacy unitId: ${legacyMatch[0]} -> ${unitId}`);
        }
      }

      // fit_ 접두어 처리 (예: fit_bio_01 -> bio_01 과목코드 추출, fit_bio_01.html 경로 생성)
      if (unitId && unitId.match(/^fit_[a-z]+\d?_\d+$/i)) {
        // fit_과목코드_번호 형식 (예: fit_bio_01, fit_people2_03)
        const fitMatch = unitId.match(/^fit_([a-z]+\d?)_(\d+)$/i);
        if (fitMatch) {
          const subjectCode = fitMatch[1].toLowerCase();

          // 과목 코드 -> 폴더 매핑
          const subjectToFolder = {
            // 과학 분야
            'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
            // 사회 분야
            'soc': 'social', 'geo': 'social', 'law': 'social', 'pol': 'social',
            // 국어 분야
            'classic': 'korlit', 'modern': 'korlit',
            // 세계문학 분야
            'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
            // 인물 분야
            'people': 'person', 'people1': 'person', 'people2': 'person'
          };

          const folder = subjectToFolder[subjectCode] || 'social';
          const path = `./BRAINUP/${folder}/${unitId}.html`;
          console.log(`✅ Converting fit_ unitId to BRAINUP/${folder} path:`, path);
          return path;
        }
      }

      // unitId를 파일 경로로 변환 (예: "geo_01" -> "./BRAINUP/social/geo_01.html")
      if (unitId && unitId.match(/^[a-z]+\d?_\d+$/i)) {
        // 과목 코드 추출 (예: chem_01 -> chem, physics_01 -> physics)
        const subjectMatch = unitId.match(/^([a-z]+\d?)_\d+$/i);
        if (subjectMatch) {
          const subjectCode = subjectMatch[1].toLowerCase();

          // 과목 코드 -> 폴더 매핑
          const subjectToFolder = {
            // 과학 분야
            'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
            // 사회 분야
            'soc': 'social', 'geo': 'social', 'law': 'social', 'pol': 'social',
            // 국어 분야
            'classic': 'korlit', 'modern': 'korlit',
            // 세계문학 분야
            'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
            // 인물 분야
            'people': 'person', 'people1': 'person', 'people2': 'person'
          };

          const folder = subjectToFolder[subjectCode] || 'social';
          const path = `./BRAINUP/${folder}/${unitId}.html`;
          console.log(`✅ Converting unitId to BRAINUP/${folder} path:`, path);
          return path;
        }
      }

      console.log('❌ Could not convert unitId to path, returning null');
      return null;
    }

    // === 단원 학습 모달 관련 ===
    function openUnitModal(unitIdOrPath) {
      // 메뉴 클릭 효과음 재생
      playMenuClickSound();

      // 단원 ID를 파일 경로로 변환
      const unitPath = getUnitPath(unitIdOrPath);

      if (!unitPath) {
        console.log('⚠️ 잘못된 단원 ID:', unitIdOrPath);
        showComingSoonPopup();
        return;
      }

      // 파일 존재 여부 확인
      if (!availableUnits[unitPath]) {
        console.log('⚠️ 준비되지 않은 단원:', unitPath);
        showComingSoonPopup();
        return;
      }

      const unitModal = document.getElementById('unitModal');
      const unitIframe = document.getElementById('unitIframe');
      const loadingOverlay = document.getElementById('loading-overlay');

      if (unitModal && unitIframe) {
        // 🎬 뒷배경 비디오 일시정지 (성능 최적화)
        const bgVideo = document.querySelector('#tablet-fixed-bg video, .background-video video');
        if (bgVideo) {
          bgVideo.pause();
        }

        // 모달을 먼저 표시 (깜박임 방지)
        unitModal.classList.add('show');

        // iframe 배경을 불투명하게 설정
        unitIframe.style.backgroundColor = '#f5f5f5';
        unitIframe.style.opacity = '0';

        // 로딩 오버레이 표시
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
          loadingOverlay.classList.remove('fade-out');
        }

        // iframe 로드 완료 시 처리
        unitIframe.onload = function() {
          // iframe을 부드럽게 표시
          unitIframe.style.transition = 'opacity 0.3s ease';
          unitIframe.style.opacity = '1';

          if (loadingOverlay) {
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
            }, 500);
          }
        };

        // 캐시버스터 추가 (iframe 캐시 방지)
        const cacheBuster = unitPath.includes('?') ? `&_t=${Date.now()}` : `?_t=${Date.now()}`;

        // iframe src 설정 전에 약간의 딜레이 (모달 렌더링 완료 대기)
        requestAnimationFrame(() => {
          unitIframe.src = unitPath + cacheBuster;
        });
        // sessionStorage에 현재 열린 단원 경로 저장
        sessionStorage.setItem('currentOpenUnit', unitPath);

        // ✅ 현재 메뉴 상태 저장 (새로고침 후 복원용)
        const menuState = {
          series: currentSelectedSeries,
          domainId: currentSelectedDomain ? currentSelectedDomain.id : null,
          subjectId: currentSelectedSubject ? currentSelectedSubject.id : null,
          subjectOffset: currentSelectedSubject ? currentSelectedSubject.offset : null
        };
        sessionStorage.setItem('menuState', JSON.stringify(menuState));
        console.log('💾 메뉴 상태 저장:', menuState);
      }
    }

    // ===== 🎵 테스트용 효과음 모음 (콘솔에서 testSound1() ~ testSound5() 호출) =====

    // 1. 뽀로록~ (귀여운 물방울)
    window.testSound1 = function() {
      const ctx = new AudioContext();
      const notes = [800, 1000, 1200, 1400, 1600];
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.08);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.08 + 0.15);
        osc.start(ctx.currentTime + i * 0.08);
        osc.stop(ctx.currentTime + i * 0.08 + 0.15);
      });
      console.log('🫧 1번: 뽀로록~ (물방울)');
    };

    // 2. 띠링♪ (레벨업 같은 느낌)
    window.testSound2 = function() {
      const ctx = new AudioContext();
      const notes = [523, 659, 784, 1047];
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.25, ctx.currentTime + i * 0.1);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.25);
        osc.start(ctx.currentTime + i * 0.1);
        osc.stop(ctx.currentTime + i * 0.1 + 0.25);
      });
      console.log('✨ 2번: 띠링♪ (레벨업)');
    };

    // 3. 삐삐빠빠~ (게임 클리어)
    window.testSound3 = function() {
      const ctx = new AudioContext();
      const melody = [
        { freq: 784, time: 0, dur: 0.1 },
        { freq: 988, time: 0.1, dur: 0.1 },
        { freq: 1175, time: 0.2, dur: 0.1 },
        { freq: 1568, time: 0.3, dur: 0.3 }
      ];
      melody.forEach(n => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.value = n.freq;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.15, ctx.currentTime + n.time);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + n.time + n.dur);
        osc.start(ctx.currentTime + n.time);
        osc.stop(ctx.currentTime + n.time + n.dur);
      });
      console.log('🎮 3번: 삐삐빠빠~ (게임 클리어)');
    };

    // 4. 팡! 퐁! (짧고 통통한) - 메뉴 클릭 효과음 (비활성화)
    function playMenuClickSound() {
      // 효과음 비활성화
    }
    window.testSound4 = playMenuClickSound;

    // 5. 쨘~♬ (짧은 축하 멜로디)
    window.testSound5 = function() {
      const ctx = new AudioContext();
      const melody = [
        { freq: 659, time: 0, dur: 0.08 },
        { freq: 784, time: 0.08, dur: 0.08 },
        { freq: 988, time: 0.16, dur: 0.08 },
        { freq: 1319, time: 0.24, dur: 0.25 }
      ];
      melody.forEach(n => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = n.freq;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.25, ctx.currentTime + n.time);
        gain.gain.setValueAtTime(0.25, ctx.currentTime + n.time + n.dur * 0.7);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + n.time + n.dur);
        osc.start(ctx.currentTime + n.time);
        osc.stop(ctx.currentTime + n.time + n.dur);
      });
      console.log('🎉 5번: 쨘~♬ (축하 멜로디)');
    };

    // 6. 띠리리링~ (종소리)
    window.testSound6 = function() {
      const ctx = new AudioContext();
      [0, 0.12, 0.24].forEach((t, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 1200 + i * 200;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.3, ctx.currentTime + t);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + t + 0.2);
        osc.start(ctx.currentTime + t);
        osc.stop(ctx.currentTime + t + 0.2);
      });
      console.log('🔔 6번: 띠리리링~ (종소리)');
    };

    console.log('🎵 효과음 테스트: testSound1() ~ testSound6() 중 선택해서 호출하세요!');

    // ===== 학습 완료 축하 효과 (폭죽만) =====
    function playLearningCelebration() {
      // 폭죽 효과
      if (typeof confetti === 'function') {
        confetti({ particleCount: 100, spread: 70, origin: { x: 0.5, y: 0.6 }, colors: ['#ff0000', '#ff7700', '#ffff00', '#00ff00', '#0099ff', '#6633ff'], zIndex: 999999 });
        setTimeout(() => { confetti({ particleCount: 50, angle: 60, spread: 55, origin: { x: 0, y: 0.6 }, colors: ['#ff69b4', '#ffd700', '#00ffff'], zIndex: 999999 }); }, 200);
        setTimeout(() => { confetti({ particleCount: 50, angle: 120, spread: 55, origin: { x: 1, y: 0.6 }, colors: ['#ff69b4', '#ffd700', '#00ffff'], zIndex: 999999 }); }, 200);
        setTimeout(() => { confetti({ particleCount: 80, spread: 100, origin: { x: 0.5, y: 0.5 }, shapes: ['star'], colors: ['#ffd700', '#ffec8b', '#fff8dc'], zIndex: 999999 }); }, 500);
      }
    }

    // iframe 내부에서 호출할 수 있도록 window 객체에 노출
    window.closeUnitModal = function() {
      const unitModal = document.getElementById('unitModal');
      const unitIframe = document.getElementById('unitIframe');

      if (unitModal) {
        // 축하 효과 먼저 실행!
        playLearningCelebration();

        unitModal.classList.remove('show');
        if (unitIframe) {
          unitIframe.src = ''; // iframe 초기화
        }
        // sessionStorage에서 현재 열린 단원 경로 제거
        sessionStorage.removeItem('currentOpenUnit');

        // 🎬 뒷배경 비디오 다시 재생
        const bgVideo = document.querySelector('#tablet-fixed-bg video, .background-video video');
        if (bgVideo) {
          bgVideo.play().catch(e => console.log('비디오 재생 실패:', e));
        }

        // 메뉴 페이지 새로고침 (학습 완료 상태 반영) - 축하 효과 보이도록 딜레이 증가
        setTimeout(() => {
          location.reload();
        }, 1500);
      }
    };

    // 페이지 로드 시 이전에 열려있던 모달 복원
    function restoreUnitModal() {
      const savedUnitPath = sessionStorage.getItem('currentOpenUnit');
      if (savedUnitPath) {
        openUnitModal(savedUnitPath);
      }
    }

    // 단원 모달 닫기 버튼 이벤트
    window.addEventListener('DOMContentLoaded', function() {
      const closeUnitBtn = document.getElementById('closeUnitModal');
      const unitModal = document.getElementById('unitModal');

      if (closeUnitBtn) {
        closeUnitBtn.addEventListener('click', window.closeUnitModal);
      }

      // 배경 클릭 시 모달 닫기
      if (unitModal) {
        unitModal.addEventListener('click', function(e) {
          if (e.target === unitModal) {
            window.closeUnitModal();
          }
        });
      }

      // 페이지 로드 시 이전에 열려있던 모달 복원
      restoreUnitModal();
    });

    // === AI 챗봇 플로팅 버튼 ===
    window.addEventListener('DOMContentLoaded', function() {
      const aiChatbotBtn = document.getElementById('aiChatbotBtn');
      const aiChatbotModal = document.getElementById('aiChatbotModal');
      const aiChatbotIframe = document.getElementById('aiChatbotIframe');
      const closeAiChatbotBtn = document.getElementById('closeAiChatbotModal');

      if (aiChatbotBtn && aiChatbotModal && aiChatbotIframe) {
        // 플로팅 버튼 클릭 시 모달 열기/닫기 토글
        aiChatbotBtn.addEventListener('click', function() {
          if (aiChatbotModal.classList.contains('show')) {
            aiChatbotModal.classList.remove('show');
            aiChatbotIframe.src = ''; // iframe 초기화
          } else {
            aiChatbotIframe.src = '/demo-ai-korean-chatbot.html';
            aiChatbotModal.classList.add('show');
          }
        });

        // 닫기 버튼 클릭 시 모달 닫기
        if (closeAiChatbotBtn) {
          closeAiChatbotBtn.addEventListener('click', function() {
            aiChatbotModal.classList.remove('show');
            aiChatbotIframe.src = ''; // iframe 초기화
          });
        }

        // 드래그 기능 구현
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;

        aiChatbotModal.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        // 터치 이벤트도 지원
        aiChatbotModal.addEventListener('touchstart', dragStart);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', dragEnd);

        function dragStart(e) {
          // 닫기 버튼 클릭 시 드래그 방지
          if (e.target.closest('.ai-chatbot-modal-close')) {
            return;
          }

          // iframe 영역 클릭 시 드래그 방지
          if (e.target.closest('.ai-chatbot-modal-iframe')) {
            return;
          }

          if (e.type === 'touchstart') {
            initialX = e.touches[0].clientX - (aiChatbotModal.offsetLeft || 0);
            initialY = e.touches[0].clientY - (aiChatbotModal.offsetTop || 0);
          } else {
            initialX = e.clientX - (aiChatbotModal.offsetLeft || 0);
            initialY = e.clientY - (aiChatbotModal.offsetTop || 0);
          }

          isDragging = true;
        }

        function drag(e) {
          if (isDragging) {
            e.preventDefault();

            if (e.type === 'touchmove') {
              currentX = e.touches[0].clientX - initialX;
              currentY = e.touches[0].clientY - initialY;
            } else {
              currentX = e.clientX - initialX;
              currentY = e.clientY - initialY;
            }

            // 화면 경계 체크
            const maxX = window.innerWidth - aiChatbotModal.offsetWidth;
            const maxY = window.innerHeight - aiChatbotModal.offsetHeight;

            currentX = Math.max(0, Math.min(currentX, maxX));
            currentY = Math.max(0, Math.min(currentY, maxY));

            setPosition(currentX, currentY);
          }
        }

        function dragEnd(e) {
          isDragging = false;
        }

        function setPosition(xPos, yPos) {
          aiChatbotModal.style.left = xPos + 'px';
          aiChatbotModal.style.top = yPos + 'px';
          aiChatbotModal.style.right = 'auto';
          aiChatbotModal.style.bottom = 'auto';
        }
      }
    });

    // === 시리즈별 레이더 등급 뱃지 업데이트 ===
    async function updateRadarGradeBadgeForSeries(seriesKey) {
      // ✅ localStorage의 currentStudent를 우선 사용
      let user = JSON.parse(localStorage.getItem('currentStudent') || '{}');
      if (!user.grade || !user.name) {
        user = JSON.parse(sessionStorage.getItem('user') || '{}');
      }

      const grade = user.grade || '';
      const name = user.name || '';

      if (!grade || !name) {
        console.log('⚠️ 사용자 정보 없음');
        return;
      }

      try {
        const url = `/api/learning-logs?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}`;
        const response = await fetch(url);
        const logs = await response.json();

        if (!logs || logs.length === 0) {
          document.getElementById('radarGradeBadge').textContent = '-';
          // localStorage에도 저장
          localStorage.setItem('selectedSeriesBadge', JSON.stringify({
            series: seriesKey,
            avgScore: 0,
            progressPercent: 0
          }));
          return;
        }

        // 시리즈별 단원 필터링
        const seriesPrefix = seriesKey === 'BRAINFIT' ? 'fit_' : (seriesKey === 'BRAINDEEP' ? 'deep_' : '');
        const filteredLogs = logs.filter(log => {
          if (!log.unit) return false;
          if (seriesKey === 'BRAINFIT') {
            return log.unit.includes('fit_');
          } else if (seriesKey === 'BRAINDEEP') {
            return log.unit.includes('deep_');
          } else if (seriesKey === 'BRAINUP') {
            return !log.unit.includes('fit_') && !log.unit.includes('deep_');
          }
          return true;
        });

        // 진도율 계산 (시리즈별 200개 단원 기준)
        const completedUnits = new Set();
        filteredLogs.forEach(log => {
          if (log.unit) completedUnits.add(log.unit);
        });
        const totalUnits = 400; // 각 시리즈 400개 단원
        const progressPercent = Math.round((completedUnits.size / totalUnits) * 100);

        // radar 데이터가 있는 로그만 필터링
        const validLogs = filteredLogs.filter(log => log.radar);

        let avgScore = 0;
        let gradeClass = 'encourage';

        if (validLogs.length > 0) {
          let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
          let totalInferential = 0, totalCritical = 0;
          let count = 0;

          validLogs.forEach(log => {
            totalLiteral += log.radar.literal || 0;
            totalStructural += log.radar.structural || 0;
            totalLexical += log.radar.lexical || 0;
            totalInferential += log.radar.inferential || 0;
            totalCritical += log.radar.critical || 0;
            count++;
          });

          const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
          const avgStructural = Math.round((totalStructural / count) * 10) / 10;
          const avgLexical = Math.round((totalLexical / count) * 10) / 10;
          const avgInferential = Math.round((totalInferential / count) * 10) / 10;
          const avgCritical = Math.round((totalCritical / count) * 10) / 10;

          const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
          avgScore = parseFloat((scores.reduce((a, b) => a + b, 0) / 5).toFixed(1));

          if (avgScore >= 9) gradeClass = 'excellent';
          else if (avgScore >= 8) gradeClass = 'good';
          else if (avgScore >= 7) gradeClass = 'average';
        }

        // 뱃지 업데이트
        const badge = document.getElementById('radarGradeBadge');
        if (validLogs.length > 0) {
          badge.textContent = avgScore + ' / ' + progressPercent;
        } else {
          badge.textContent = '- / ' + progressPercent;
        }
        badge.className = 'radar-grade-badge ' + gradeClass;

        // localStorage에 저장 (새로고침 후 복원용)
        localStorage.setItem('selectedSeriesBadge', JSON.stringify({
          series: seriesKey,
          avgScore: avgScore,
          progressPercent: progressPercent
        }));

        console.log('✅ 시리즈별 뱃지 업데이트:', seriesKey, avgScore || '-', '점 / 진도율:', progressPercent, '%');
      } catch (error) {
        console.error('❌ 시리즈별 뱃지 업데이트 실패:', error);
      }
    }

    // === 레이더 등급 뱃지 업데이트 (실시간 계산) ===
    async function updateRadarGradeBadge() {
      // ✅ localStorage의 currentStudent를 우선 사용 (가장 최신 로그인 정보)
      let user = JSON.parse(localStorage.getItem('currentStudent') || '{}');

      // localStorage에 없으면 sessionStorage 사용
      if (!user.grade || !user.name) {
        user = JSON.parse(sessionStorage.getItem('user') || '{}');
      }

      const grade = user.grade || '';
      const name = user.name || '';
      const phone = user.phone || '';

      console.log('🔍 뱃지 업데이트 - 사용자 정보:', { grade, name, phone });

      if (!grade || !name) {
        console.log('⚠️ 사용자 정보 없음');
        document.getElementById('radarGradeBadge').textContent = '-';
        return;
      }

      try {
        // ✅ 학습 기록 조회 (phone 제외 - 기존 저장 데이터 호환)
        const url = `/api/learning-logs?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}`;

        console.log('📡 학습 기록 API 호출:', url);
        const response = await fetch(url);
        const logs = await response.json();

        if (!logs || logs.length === 0) {
          console.log('⚠️ 학습 기록 없음');
          document.getElementById('radarGradeBadge').textContent = '-';
          return;
        }

        console.log('📚 총 학습 기록:', logs.length, '개');

        // 진도율 계산 (전체 시리즈 기준 400개 단원)
        const completedUnits = new Set();
        logs.forEach(log => {
          if (log.unit) {
            completedUnits.add(log.unit);
          }
        });
        const progressPercent = Math.round((completedUnits.size / 400) * 100);

        // radar 데이터가 있는 로그만 필터링
        const validLogs = logs.filter(log => log.radar);
        console.log('📊 radar 데이터가 있는 기록:', validLogs.length, '개');

        let avgScore = 0;
        let gradeClass = 'encourage';

        if (validLogs.length > 0) {
          // 시리즈 종합 레이더와 동일한 평균 계산 (5개 영역 평균)
          let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
          let totalInferential = 0, totalCritical = 0;
          let count = 0;

          validLogs.forEach(log => {
            totalLiteral += log.radar.literal || 0;
            totalStructural += log.radar.structural || 0;
            totalLexical += log.radar.lexical || 0;
            totalInferential += log.radar.inferential || 0;
            totalCritical += log.radar.critical || 0;
            count++;
          });

          const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
          const avgStructural = Math.round((totalStructural / count) * 10) / 10;
          const avgLexical = Math.round((totalLexical / count) * 10) / 10;
          const avgInferential = Math.round((totalInferential / count) * 10) / 10;
          const avgCritical = Math.round((totalCritical / count) * 10) / 10;

          const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
          avgScore = parseFloat((scores.reduce((a, b) => a + b, 0) / 5).toFixed(1));

          // 등급 계산 (색상 결정용)
          if (avgScore >= 9) {
            gradeClass = 'excellent';
          } else if (avgScore >= 8) {
            gradeClass = 'good';
          } else if (avgScore >= 7) {
            gradeClass = 'average';
          } else {
            gradeClass = 'encourage';
          }

          // ✅ AI 자동 과제 스케줄 생성은 이제 서버의 assignAITasksDaily()에서 LearningLog 기반으로 처리됨
          // (기존 AITaskSchedule 기반 로직 제거됨)
        }

        // 뱃지 업데이트 (평점 / 진도율 표시)
        const badge = document.getElementById('radarGradeBadge');
        if (validLogs.length > 0) {
          // radar 데이터가 있으면: 평점 / 진도율
          badge.textContent = avgScore + ' / ' + progressPercent;
        } else {
          // radar 데이터가 없으면: 진도율만 표시
          badge.textContent = '- / ' + progressPercent;
        }
        badge.className = 'radar-grade-badge ' + gradeClass;

        console.log('✅ 레이더 뱃지 업데이트:', avgScore || '-', '점 / 진도율:', progressPercent, '%');
      } catch (error) {
        console.error('❌ 레이더 등급 조회 실패:', error);
      }
    }

    // === 레이더 차트 아이콘 클릭 이벤트 (모달로 표시) ===
    window.addEventListener('DOMContentLoaded', function() {
      const radarIcon = document.getElementById('radarChartIcon');
      const learningModal = document.getElementById('learningModal');
      const learningIframe = document.getElementById('learningIframe');
      const closeModalBtn = document.getElementById('closeLearningModal');

      // 레이더 등급 뱃지 업데이트 (초기 로드) - 저장된 시리즈가 있으면 해당 시리즈로 새로 계산
      const savedMenuSeries = localStorage.getItem('selectedMenuSeries');
      if (savedMenuSeries && (savedMenuSeries === 'BRAINUP' || savedMenuSeries === 'BRAINFIT' || savedMenuSeries === 'BRAINDEEP')) {
        // 저장된 시리즈로 새로 계산 (항상 최신 데이터 사용)
        updateRadarGradeBadgeForSeries(savedMenuSeries);
        console.log('✅ 페이지 로드 시 시리즈별 뱃지 새로 계산:', savedMenuSeries);
      } else {
        // 저장된 시리즈가 없으면 기본 업데이트
        updateRadarGradeBadge();
      }

      // 페이지가 보일 때마다 뱃지 업데이트 (학습 완료 후 돌아왔을 때)
      // Debounce timer to prevent duplicate calls
      let visibilityDebounceTimer = null;

      document.addEventListener('visibilitychange', async function() {
        if (!document.hidden) {
          // Clear existing timer
          if (visibilityDebounceTimer) {
            clearTimeout(visibilityDebounceTimer);
          }

          // Set new timer - only execute after 500ms of no new events
          visibilityDebounceTimer = setTimeout(async () => {
            console.log('🔄 페이지 활성화 - 뱃지 및 학습 완료 상태 업데이트');

            // 🔥 unit-grades 캐시 무효화 (학습 페이지에서 돌아올 때 최신 별표 데이터 가져오기)
            if (window.ApiCache && typeof window.ApiCache.invalidate === 'function') {
              ApiCache.invalidate('unit-grades');
              console.log('🗑️ [Menu] unit-grades 캐시 무효화 완료');
            }

            // 현재 활성화된 시리즈로 뱃지 새로 계산
            const activeSeriesItem = document.querySelector('#seriesList .series-item.active');
            if (activeSeriesItem) {
              const activeSeries = activeSeriesItem.dataset.series;
              if (activeSeries === 'BRAINUP' || activeSeries === 'BRAINFIT' || activeSeries === 'BRAINDEEP') {
                updateRadarGradeBadgeForSeries(activeSeries);
              } else {
                updateRadarGradeBadge();
              }
            } else {
              updateRadarGradeBadge();
            }

            // 메인 메뉴의 학습 완료 상태 및 별점 업데이트
            await updateAllLessonStatus();

            visibilityDebounceTimer = null;
          }, 500);
        }
      });

      // 종합리포트(iframe)에서 시리즈 변경 시 뱃지 업데이트
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'seriesChanged') {
          const { series, avgScore, progressPercent, completedCount, totalUnits } = event.data;
          console.log('📥 시리즈 변경 메시지 수신:', series, avgScore, progressPercent + '%');

          // ✅ 시리즈 선택을 localStorage에 저장 (새로고침 후 복원용)
          localStorage.setItem('selectedMenuSeries', series);
          console.log('✅ 시리즈 선택 저장 (종합리포트에서):', series);

          const badge = document.getElementById('radarGradeBadge');
          if (badge) {
            // 등급 클래스 결정
            let gradeClass = 'encourage';
            if (avgScore >= 9) {
              gradeClass = 'excellent';
            } else if (avgScore >= 8) {
              gradeClass = 'good';
            } else if (avgScore >= 7) {
              gradeClass = 'average';
            }

            // 뱃지 텍스트 업데이트
            if (avgScore > 0) {
              badge.textContent = avgScore + ' / ' + progressPercent;
            } else {
              badge.textContent = '- / ' + progressPercent;
            }
            badge.className = 'radar-grade-badge ' + gradeClass;
            console.log('✅ 뱃지 업데이트 완료:', badge.textContent, gradeClass);
          }
        }
      });

      // 모달 닫을 때 뱃지 업데이트 (선택된 시리즈 데이터 우선 사용)
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          console.log('🔄 모달 닫기 - 뱃지 업데이트');

          // localStorage에 저장된 선택 시리즈 데이터가 있으면 그것을 사용
          const savedBadge = localStorage.getItem('selectedSeriesBadge');
          if (savedBadge) {
            try {
              const data = JSON.parse(savedBadge);
              const badge = document.getElementById('radarGradeBadge');
              if (badge && data.series !== 'all') {
                // 등급 클래스 결정
                let gradeClass = 'encourage';
                if (data.avgScore >= 9) gradeClass = 'excellent';
                else if (data.avgScore >= 8) gradeClass = 'good';
                else if (data.avgScore >= 7) gradeClass = 'average';

                // 뱃지 업데이트
                if (data.avgScore > 0) {
                  badge.textContent = data.avgScore + ' / ' + data.progressPercent;
                } else {
                  badge.textContent = '- / ' + data.progressPercent;
                }
                badge.className = 'radar-grade-badge ' + gradeClass;
                console.log('✅ 저장된 시리즈 뱃지 복원:', data.series, badge.textContent);
                return; // 저장된 데이터로 업데이트했으므로 종료
              }
            } catch (e) {
              console.log('저장된 뱃지 데이터 파싱 오류:', e);
            }
          }

          // 저장된 데이터가 없거나 전체 시리즈인 경우 기본 업데이트
          updateRadarGradeBadge();
        });
      }

      if (radarIcon && learningModal && learningIframe) {
        // ✅ 학습 분석 모달 열기 함수
        function openLearningModal() {
          const user = JSON.parse(sessionStorage.getItem('user') || '{}');
          console.log('🔍 sessionStorage user:', user);
          const grade = user.grade || '학년미지정';
          const name = user.name || '이름미지정';
          console.log('📊 Opening learning page:', { grade, name });

          // ✅ 현재 선택된 시리즈 가져오기 (실시간으로 활성화된 시리즈 확인)
          let selectedSeries = 'BRAINUP';
          const activeSeriesItem = document.querySelector('#seriesList .series-item.active');
          if (activeSeriesItem) {
            selectedSeries = activeSeriesItem.dataset.series || 'BRAINUP';
          }
          // 시리즈별 파라미터 설정 (up, fit, deep)
          let seriesParam = 'up';
          if (selectedSeries === 'BRAINFIT') {
            seriesParam = 'fit';
          } else if (selectedSeries === 'BRAINDEEP') {
            seriesParam = 'deep';
          }

          const url = `/my-learning?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}&series=${seriesParam}`;
          console.log('🔗 URL:', url, '(시리즈:', selectedSeries, ')');

          // iframe에 URL 설정하고 모달 열기
          learningIframe.src = url;
          learningModal.classList.add('show');

          // ✅ 배경 비디오 일시정지 (깜박임 방지)
          const bgVideo = document.querySelector('#tablet-fixed-bg video, .background-video video, .menu-bg-video');
          if (bgVideo) {
            bgVideo.pause();
            console.log('🎬 배경 비디오 일시정지');
          }

          // ✅ 모달 열림 상태 저장 (새로고침 후 복원용)
          sessionStorage.setItem('learningModalOpen', 'true');
        }

        // ✅ 학습 분석 모달 닫기 함수
        function closeLearningModal() {
          learningModal.classList.remove('show');
          learningIframe.src = ''; // iframe 초기화

          // ✅ 배경 비디오 재생
          const bgVideo = document.querySelector('#tablet-fixed-bg video, .background-video video, .menu-bg-video');
          if (bgVideo) {
            bgVideo.play().catch(e => console.log('비디오 재생 실패:', e));
            console.log('▶️ 배경 비디오 재생');
          }

          // ✅ 모달 열림 상태 제거
          sessionStorage.removeItem('learningModalOpen');
        }

        // 아이콘 클릭 시 모달 열기
        radarIcon.addEventListener('click', openLearningModal);

        // 닫기 버튼 클릭 시 모달 닫기
        if (closeModalBtn) {
          closeModalBtn.addEventListener('click', closeLearningModal);
        }

        // 배경 클릭 시 모달 닫기
        learningModal.addEventListener('click', function(e) {
          if (e.target === learningModal) {
            closeLearningModal();
          }
        });

        // ✅ 페이지 로드 시 모달 상태 복원
        if (sessionStorage.getItem('learningModalOpen') === 'true') {
          console.log('🔄 학습 분석 모달 상태 복원');
          openLearningModal();
        }

        // 전송하기 버튼 클릭 시 이메일 열기
        const sendBtn = document.getElementById('sendLearningBtn');
        if (sendBtn) {
          console.log('✅ 전송하기 버튼 찾음:', sendBtn);
          sendBtn.addEventListener('click', function() {
            console.log('📧 전송하기 버튼 클릭됨');

            // iframe에서 학생 정보 가져오기
            const iframeSrc = learningIframe.src;
            const urlParams = new URLSearchParams(iframeSrc.split('?')[1]);
            const grade = urlParams.get('grade') || '';
            const name = urlParams.get('name') || '';

            // 이메일 제목과 본문 설정
            const subject = `[단단국어] ${grade} ${name} 학생 학습 분석 리포트`;
            const body = `안녕하세요,

${grade} ${name} 학생의 학습 분석 리포트를 전송합니다.

📊 학습 분석 내용:
- 학습 기록 및 점수
- 단원별 문해력 레이더 차트
- 종합 분석 결과

자세한 내용은 첨부된 PDF 파일을 확인해주세요.

※ PDF 파일은 '다운로드' 버튼을 클릭하여 먼저 저장한 후 이메일에 첨부해주세요.

감사합니다.`;

            // mailto 링크 생성
            const mailtoLink = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);

            console.log('📧 이메일 앱 열기:', mailtoLink);
            window.location.href = mailtoLink;
          });
        } else {
          console.error('❌ 전송하기 버튼을 찾을 수 없습니다');
        }

        // 카카오톡 공유 버튼 클릭 시
        const kakaoShareBtn = document.getElementById('kakaoShareBtn');
        if (kakaoShareBtn) {
          console.log('✅ 카카오톡 전송 버튼 찾음:', kakaoShareBtn);
          kakaoShareBtn.addEventListener('click', function() {
            console.log('💬 카카오톡 전송 버튼 클릭됨');

            // iframe에서 학생 정보 가져오기
            const iframeSrc = learningIframe.src;
            const urlParams = new URLSearchParams(iframeSrc.split('?')[1]);
            const grade = urlParams.get('grade') || '';
            const name = urlParams.get('name') || '';

            // 카카오톡 공유하기
            if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
              try {
                // 배포 환경에서는 Render 서버 URL 사용 (서버 라우트 /my-learning 접근 필요)
                const baseUrl = window.location.hostname === 'localhost'
                  ? window.location.origin
                  : 'https://dan-dan-app.onrender.com';

                const reportPath = iframeSrc.replace(window.location.origin, '');
                const fullUrl = baseUrl + reportPath;

                Kakao.Share.sendDefault({
                  objectType: 'feed',
                  content: {
                    title: `📊 ${grade} ${name} 학생 학습 분석 리포트`,
                    description: '단단국어 학습 분석 결과를 확인하세요!\n\n📈 학습 기록 및 점수\n📊 단원별 문해력 레이더 차트\n✨ 종합 분석 결과',
                    imageUrl: 'https://project-2516060862411225169.web.app/images/report-share-thumbnail.png',
                    link: {
                      mobileWebUrl: fullUrl,
                      webUrl: fullUrl
                    }
                  },
                  buttons: [
                    {
                      title: '리포트 보기',
                      link: {
                        mobileWebUrl: fullUrl,
                        webUrl: fullUrl
                      }
                    }
                  ]
                });
                console.log('✅ 카카오톡 공유하기 실행됨:', fullUrl);
              } catch (error) {
                console.error('❌ 카카오톡 공유 오류:', error);
                alert('카카오톡 공유 중 오류가 발생했습니다.\n카카오톡이 설치되어 있는지 확인해주세요.');
              }
            } else {
              console.error('❌ Kakao SDK가 초기화되지 않았습니다');
              alert('카카오톡 공유 기능을 사용할 수 없습니다.\n페이지를 새로고침 후 다시 시도해주세요.');
            }
          });
        } else {
          console.error('❌ 카카오톡 전송 버튼을 찾을 수 없습니다');
        }

        // 다운로드 버튼 클릭 시 PDF 생성
        const downloadBtn = document.getElementById('downloadLearningBtn');
        if (downloadBtn) {
          console.log('✅ 다운로드 버튼 찾음:', downloadBtn);
          downloadBtn.addEventListener('click', function() {
            console.log('📥 다운로드 버튼 클릭됨');
            console.log('iframe:', learningIframe);
            console.log('iframe.contentWindow:', learningIframe.contentWindow);
            if (learningIframe && learningIframe.contentWindow) {
              console.log('💬 iframe에 메시지 전송 중...');
              learningIframe.contentWindow.postMessage({ action: 'downloadPDF' }, '*');
            } else {
              console.error('❌ iframe.contentWindow를 찾을 수 없습니다');
              alert('페이지를 먼저 로드해주세요.');
            }
          });
        } else {
          console.error('❌ 다운로드 버튼을 찾을 수 없습니다');
        }
      }
    });

    // 노트 아이콘 클릭 기능 - 어휘력 퀴즈쇼 모달
    document.addEventListener('DOMContentLoaded', () => {
      const noteIcon = document.getElementById('noteIcon');
      const vocabModal = document.getElementById('vocabQuizModal');
      const vocabIframe = document.getElementById('vocabQuizIframe');
      const closeVocabModal = document.getElementById('closeVocabModal');

      if (noteIcon) {
        noteIcon.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          // 모달 열기
          vocabIframe.src = '/demo-vocabulary-quiz.html';
          vocabModal.classList.add('show');
        });
      }

      // 닫기 버튼
      if (closeVocabModal) {
        closeVocabModal.addEventListener('click', () => {
          vocabModal.classList.remove('show');
          vocabIframe.src = '';
        });
      }

      // 배경 클릭으로 닫기
      if (vocabModal) {
        vocabModal.addEventListener('click', (e) => {
          if (e.target === vocabModal) {
            vocabModal.classList.remove('show');
            vocabIframe.src = '';
          }
        });
      }

      // iframe에서 학습완료 메시지를 받으면 모달 닫기 및 학습실 새로고침
      window.addEventListener('message', async (event) => {
        if (event.data && event.data.type === 'vocabularyQuizCompleted') {
          console.log('✅ 어휘 퀴즈 완료 - 모달 닫기 및 학습실 새로고침');
          vocabModal.classList.remove('show');
          vocabIframe.src = '';

          // 나의 학습실이 열려있으면 목록 새로고침
          const studyRoomPopup = document.getElementById('studyRoomPopup');
          if (studyRoomPopup && studyRoomPopup.classList.contains('show')) {
            await renderStudyRoomList();
            console.log('✅ 나의 학습실 목록 새로고침 완료');
          }
        }
      });
    });

    // ========================================
    // 학습실 (Study Room) 기능
    // ========================================

    // 관리자 비밀번호 (통합 비밀번호)
    const ADMIN_PASSWORD = '1234';

    // 현재 로그인한 학생 정보 가져오기
    function getCurrentStudentKey() {
      return localStorage.getItem('currentStudentKey') || 'guest';
    }

    // 학습실 데이터 키 생성
    function getStudyRoomKey() {
      return `studyRoom_${getCurrentStudentKey()}`;
    }

    // 학습실 과제 목록 불러오기 (서버 DB에서)
    async function getStudyRoomTasks() {
      try {
        const user = JSON.parse(localStorage.getItem('currentStudent') || '{}');
        if (!user.grade || !user.name) {
          console.log('⚠️ 사용자 정보 없음 - localStorage 사용');
          const key = getStudyRoomKey();
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        }

        // 서버에서 학습실 데이터 조회 (캐시 사용)
        const result = await ApiCache.fetch(`/api/user-progress/study-room?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`);

        if (result.ok && result.data?.studyRoom?.assignedTasks) {
          console.log('✅ 서버에서 학습실 데이터 로드:', result.data.studyRoom.assignedTasks.length, '개');
          return result.data.studyRoom.assignedTasks;
        }

        // 서버에 데이터 없으면 localStorage fallback
        console.log('⚠️ 서버 데이터 없음 - localStorage 사용');
        const key = getStudyRoomKey();
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (error) {
        console.error('❌ 학습실 데이터 로드 오류:', error);
        // 오류 시 localStorage fallback
        const key = getStudyRoomKey();
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      }
    }

    // 학습실 과제 목록 저장하기 (서버 DB에)
    async function saveStudyRoomTasks(tasks) {
      try {
        const user = JSON.parse(localStorage.getItem('currentStudent') || '{}');
        if (!user.grade || !user.name) {
          console.log('⚠️ 사용자 정보 없음 - localStorage에만 저장');
          const key = getStudyRoomKey();
          localStorage.setItem(key, JSON.stringify(tasks));
          updateStudyRoomBadge();
          return;
        }

        // 서버에 저장
        const response = await fetch('/api/user-progress/study-room', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            grade: user.grade,
            name: user.name,
            assignedTasks: tasks
          })
        });

        const result = await response.json();
        if (result.ok) {
          console.log('✅ 학습실 데이터 서버 저장 완료');
        } else {
          console.error('❌ 서버 저장 실패:', result.message);
          // fallback to localStorage
          const key = getStudyRoomKey();
          localStorage.setItem(key, JSON.stringify(tasks));
        }
      } catch (error) {
        console.error('❌ 학습실 데이터 저장 오류:', error);
        // fallback to localStorage
        const key = getStudyRoomKey();
        localStorage.setItem(key, JSON.stringify(tasks));
      }

      updateStudyRoomBadge();
    }

    // 뱃지 업데이트
    async function updateStudyRoomBadge() {
      const badge = document.getElementById('studyRoomBadge');
      if (badge) {
        const tasks = await getStudyRoomTasks();

        // 완료된 과제 개수 계산 (학습완료 + 복습완료)
        // - AI 과제: task.status === 'completed' (복습완료)
        // - 일반 과제: isUnitCompleted()로 학습 완료 확인 (학습완료)
        const completedCount = tasks.filter(task => {
          if (task.isAI) {
            // AI 과제는 status가 'completed'인 경우 (복습완료)
            return task.status === 'completed';
          } else {
            // 일반 과제는 LearningLog에 기록된 경우 (학습완료)
            const unitId = task.id || task.unitId;
            return isUnitCompleted(unitId);
          }
        }).length;

        // 어휘퀴즈 완료 여부 확인
        const vocabCompleted = await checkVocabularyCompletedToday();

        // 전체 과제 개수 = 기존 과제 + 어휘퀴즈(1개)
        const totalCount = tasks.length + 1;

        // 완료 개수 = 기존 완료 + 어휘퀴즈 완료 여부
        const totalCompletedCount = completedCount + (vocabCompleted ? 1 : 0);

        badge.textContent = `${totalCompletedCount}/${totalCount}`;
      }
    }

    // 어휘퀴즈 어휘력 지수 뱃지 업데이트
    function updateVocabAvgBadge() {
      const badge = document.getElementById('vocabAvgBadge');
      console.log('🎯 updateVocabAvgBadge 실행, badge 요소:', badge);

      if (badge) {
        const userStr = sessionStorage.getItem('user');
        let storageKey = 'vocabRatingScore'; // 어휘력 지수
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            // 어휘퀴즈와 동일한 형식: baseKey_grade_name
            storageKey = `vocabRatingScore_${user.grade}_${user.name}`;
            console.log('👤 사용자 정보:', user, '키:', storageKey);
          } catch(e) {
            console.error('❌ User parse error:', e);
          }
        }

        const ratingScore = localStorage.getItem(storageKey);
        console.log('📊 localStorage 키:', storageKey, '값:', ratingScore);

        badge.textContent = ratingScore ? ratingScore : '0';
        console.log('✅ 뱃지 업데이트 완료:', badge.textContent);
      } else {
        console.error('❌ vocabAvgBadge 요소를 찾을 수 없습니다');
      }
    }

    // ========== 자동과제부여 관련 함수 ==========
    // 자동과제부여 상태 관리
    let autoTaskSettings = {
      series: [],          // 선택된 시리즈 ('up', 'fit')
      days: [],            // 선택된 요일 (0=일, 1=월, ..., 6=토, 'everyday')
      taskCount: 1,        // 과제 개수
      status: 'stopped'    // 'running', 'paused', 'stopped'
    };

    // 과목 우선순위 순서
    const SUBJECT_PRIORITY = ['bio', 'chem', 'physics', 'earth', 'geo', 'soc', 'law', 'pol', 'econ', 'classic', 'modern', 'world1', 'world2', 'people1', 'people2'];

    // 드롭다운 토글
    function toggleAutoTaskDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('autoTaskDropdown');
      const btn = document.getElementById('autoTaskBtn');
      if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
        btn.classList.remove('active');
      } else {
        // 버튼 위치 기준으로 드롭다운 위치 설정
        const rect = btn.getBoundingClientRect();
        dropdown.style.top = (rect.bottom + 8) + 'px';
        dropdown.style.left = rect.left + 'px';

        dropdown.classList.add('show');
        btn.classList.add('active');
        // 설정 불러오기
        loadAutoTaskSettings();
      }
    }

    // 드롭다운 외부 클릭 시 닫기
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('autoTaskDropdown');
      const btn = document.getElementById('autoTaskBtn');
      if (dropdown && !dropdown.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
        dropdown.classList.remove('show');
        btn.classList.remove('active');
      }
    });

    // 시리즈 버튼 클릭 핸들러
    function initSeriesButtons() {
      const seriesBtns = document.querySelectorAll('#seriesBtnGroup .series-btn:not([disabled])');
      seriesBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('selected');
          updateAutoTaskSettings();
        });
      });
    }

    // 요일 버튼 클릭 핸들러
    function initDayButtons() {
      const dayBtns = document.querySelectorAll('#dayBtnGroup .day-btn');
      dayBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const day = this.dataset.day;

          if (day === 'everyday') {
            // 매일 선택 시: 다른 요일 모두 해제, 매일만 선택
            if (!this.classList.contains('selected')) {
              dayBtns.forEach(b => b.classList.remove('selected'));
              this.classList.add('selected');
            } else {
              this.classList.remove('selected');
            }
          } else {
            // 개별 요일 선택 시: 매일 해제
            const everydayBtn = document.querySelector('#dayBtnGroup .day-btn[data-day="everyday"]');
            if (everydayBtn) everydayBtn.classList.remove('selected');
            this.classList.toggle('selected');
          }
          updateAutoTaskSettings();
        });
      });
    }

    // 과제 개수 입력 핸들러
    function initTaskCountInput() {
      const input = document.getElementById('autoTaskCount');
      if (input) {
        input.addEventListener('change', function() {
          let val = parseInt(this.value) || 3;
          if (val < 1) val = 1;
          if (val > 15) val = 15;
          this.value = val;
          updateAutoTaskSettings();
        });
      }
    }

    // 설정 업데이트 (UI에서 값 수집)
    function updateAutoTaskSettings() {
      // 시리즈
      const selectedSeries = [];
      document.querySelectorAll('#seriesBtnGroup .series-btn.selected').forEach(btn => {
        selectedSeries.push(btn.dataset.series);
      });
      autoTaskSettings.series = selectedSeries;

      // 요일
      const selectedDays = [];
      document.querySelectorAll('#dayBtnGroup .day-btn.selected').forEach(btn => {
        selectedDays.push(btn.dataset.day);
      });
      autoTaskSettings.days = selectedDays;

      // 과제 개수
      const countInput = document.getElementById('autoTaskCount');
      autoTaskSettings.taskCount = parseInt(countInput?.value) || 1;
    }

    // 서버에서 설정 불러오기
    async function loadAutoTaskSettings() {
      try {
        const userStr = sessionStorage.getItem('user');
        if (!userStr) return;
        const user = JSON.parse(userStr);

        const response = await fetch(`/api/auto-task-settings?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`);
        const result = await response.json();

        if (result.ok && result.settings) {
          autoTaskSettings = { ...autoTaskSettings, ...result.settings };
          applySettingsToUI();
        }
      } catch (error) {
        console.error('자동과제부여 설정 불러오기 실패:', error);
      }
    }

    // 설정을 UI에 적용
    function applySettingsToUI() {
      // 시리즈 버튼
      document.querySelectorAll('#seriesBtnGroup .series-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (autoTaskSettings.series.includes(btn.dataset.series)) {
          btn.classList.add('selected');
        }
      });

      // 요일 버튼
      document.querySelectorAll('#dayBtnGroup .day-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (autoTaskSettings.days.includes(btn.dataset.day)) {
          btn.classList.add('selected');
        }
      });

      // 과제 개수
      const countInput = document.getElementById('autoTaskCount');
      if (countInput) {
        countInput.value = autoTaskSettings.taskCount || 1;
      }

      // 버튼 상태
      updateActionButtons();

      // 상태 표시
      updateStatusDisplay();
    }

    // 액션 버튼 상태 업데이트
    function updateActionButtons() {
      const startBtn = document.getElementById('autoTaskStartBtn');
      const pauseBtn = document.getElementById('autoTaskPauseBtn');
      const stopBtn = document.getElementById('autoTaskStopBtn');

      switch (autoTaskSettings.status) {
        case 'running':
          startBtn.disabled = true;
          pauseBtn.disabled = false;
          stopBtn.disabled = false;
          break;
        case 'paused':
          startBtn.disabled = false;
          pauseBtn.disabled = true;
          stopBtn.disabled = false;
          break;
        case 'stopped':
        default:
          startBtn.disabled = false;
          pauseBtn.disabled = true;
          stopBtn.disabled = true;
          break;
      }
    }

    // 상태 표시 업데이트
    function updateStatusDisplay() {
      const statusEl = document.getElementById('autoTaskStatus');
      if (!statusEl) return;

      statusEl.classList.remove('running', 'paused', 'stopped');

      switch (autoTaskSettings.status) {
        case 'running':
          statusEl.classList.add('running');
          const seriesText = autoTaskSettings.series.map(s => {
            if (s === 'up') return 'BRIAN업';
            if (s === 'fit') return 'BRIAN핏';
            return s;
          }).join(', ') || '미선택';
          const daysText = autoTaskSettings.days.includes('everyday') ? '매일' :
            autoTaskSettings.days.map(d => ['일','월','화','수','목','금','토'][d] || d).join(', ') || '미선택';
          statusEl.innerHTML = `▶️ 자동과제부여 실행 중<br><small style="opacity: 0.8;">${seriesText} / ${daysText} / ${autoTaskSettings.taskCount}개</small>`;
          break;
        case 'paused':
          statusEl.classList.add('paused');
          statusEl.innerHTML = `⏸️ 자동과제부여 일시정지 상태`;
          break;
        case 'stopped':
        default:
          statusEl.classList.add('stopped');
          statusEl.innerHTML = `⏹️ 자동과제부여가 비활성화 상태입니다`;
          break;
      }
    }

    // 서버에 설정 저장
    async function saveAutoTaskSettings() {
      try {
        const userStr = sessionStorage.getItem('user');
        if (!userStr) {
          showErrorMessage('로그인이 필요합니다', '⚠️', '알림');
          return false;
        }
        const user = JSON.parse(userStr);

        const response = await fetch('/api/auto-task-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            grade: user.grade,
            name: user.name,
            settings: autoTaskSettings
          })
        });

        const result = await response.json();
        return result.ok;
      } catch (error) {
        console.error('자동과제부여 설정 저장 실패:', error);
        return false;
      }
    }

    // 시작 버튼
    async function startAutoTask() {
      // 유효성 검사
      updateAutoTaskSettings();

      if (autoTaskSettings.series.length === 0) {
        showErrorMessage('시리즈를 1개 이상 선택해주세요', '⚠️', '알림');
        return;
      }
      if (autoTaskSettings.days.length === 0) {
        showErrorMessage('요일을 1개 이상 선택해주세요', '⚠️', '알림');
        return;
      }

      autoTaskSettings.status = 'running';
      const saved = await saveAutoTaskSettings();

      if (saved) {
        updateActionButtons();
        updateStatusDisplay();
        showErrorMessage('자동과제부여가 시작되었습니다!<br>매일 00:00에 과제가 자동 부여됩니다.', '✅', '성공');
      } else {
        autoTaskSettings.status = 'stopped';
        showErrorMessage('설정 저장에 실패했습니다', '❌', '오류');
      }
    }

    // 일시정지 버튼
    async function pauseAutoTask() {
      autoTaskSettings.status = 'paused';
      const saved = await saveAutoTaskSettings();

      if (saved) {
        updateActionButtons();
        updateStatusDisplay();
        showErrorMessage('자동과제부여가 일시정지되었습니다', '⏸️', '알림');
      }
    }

    // 중단 버튼
    async function stopAutoTask() {
      // 설정 초기화
      autoTaskSettings.series = [];
      autoTaskSettings.days = [];
      autoTaskSettings.taskCount = 1;
      autoTaskSettings.status = 'stopped';

      const saved = await saveAutoTaskSettings();

      if (saved) {
        applySettingsToUI();
        showErrorMessage('자동과제부여가 중단되고 설정이 초기화되었습니다', '⏹️', '알림');
      }
    }

    // 자동과제부여 버튼 초기화
    document.addEventListener('DOMContentLoaded', function() {
      initSeriesButtons();
      initDayButtons();
      initTaskCountInput();
    });

    // 학습실 모달 열기
    async function openStudyRoomModal() {
      const modal = document.getElementById('studyRoomModal');
      if (modal) {
        // 🎬 뒷배경 비디오 일시정지 (성능 최적화)
        const bgVideo = document.querySelector('#tablet-fixed-bg video, .background-video video');
        if (bgVideo) {
          bgVideo.pause();
        }

        modal.classList.add('show');
        // 과제 목록 렌더링
        await renderStudyRoomList();
        // ✅ 모달 열림 상태 저장 (새로고침 후 복원용)
        sessionStorage.setItem('studyRoomModalOpen', 'true');
      }
    }

    // 학습실 모달 닫기
    async function closeStudyRoomModal() {
      console.log('🚪 학습실 모달 닫기 시작');
      const modal = document.getElementById('studyRoomModal');
      if (modal) {
        modal.classList.remove('show');
        // ✅ 모달 열림 상태 제거
        sessionStorage.removeItem('studyRoomModalOpen');
        console.log('✅ 모달 숨김 완료, 학습 완료 상태 업데이트 시작');

        // 🎬 뒷배경 비디오 다시 재생
        const bgVideo = document.querySelector('#tablet-fixed-bg video, .background-video video');
        if (bgVideo) {
          bgVideo.play().catch(e => console.log('비디오 재생 실패:', e));
        }

        // 메인 메뉴의 학습 완료 상태 업데이트
        await updateAllLessonStatus();
        console.log('✅ 학습실 모달 닫기 완료');
      } else {
        console.error('❌ studyRoomModal 요소를 찾을 수 없습니다');
      }
    }

    // ✅ 페이지 로드 시 학습실 모달 상태 복원
    function restoreStudyRoomModal() {
      if (sessionStorage.getItem('studyRoomModalOpen') === 'true') {
        console.log('🔄 학습실 모달 상태 복원');
        openStudyRoomModal();
      }
    }

    // 메인 메뉴의 모든 단원 학습 완료 상태 및 별점 업데이트
    async function updateAllLessonStatus() {
      console.log('🔄 학습 완료 상태 및 별점 업데이트 시작');

      // 현재 렌더링된 단원 목록이 있으면 다시 렌더링 (등급 데이터 포함)
      if (currentUnits && currentUnits.length > 0) {
        console.log('📚 현재 단원 목록 다시 렌더링:', currentUnits.length, '개');
        await renderUnitList(currentUnits);
        console.log('✅ 메인 메뉴 학습 완료 상태 및 별점 업데이트 완료');
        return; // 재렌더링 완료, 함수 종료
      }

      console.log('⚠️ currentUnits가 비어있음, DOM 요소 직접 업데이트');

      // 최신 등급 데이터 로드
      unitGradesData = await fetchUnitGrades();
      console.log('⭐ fetchUnitGrades 완료, unitGradesData:', Object.keys(unitGradesData).length, '개');

      // DOM에서 현재 보이는 단원들을 찾아서 업데이트
      const allUnits = document.querySelectorAll('.unit-item[data-page]');
      console.log('📋 DOM에서 찾은 단원 수:', allUnits.length);

      allUnits.forEach(unit => {
        const pageKey = unit.dataset.page;
        if (!pageKey) return;

        // pageKey에서 단원 코드 추출
        let unitCode = pageKey;
        const match = pageKey.match(/\/([^\/]+)\.html$/);
        if (match) {
          unitCode = match[1];
        }

        // ✅ world2_XX, people2_XX 형식 그대로 사용 (서버 API와 동일하게)
        // 서버에서 world2_XX 형식 그대로 저장하므로 변환하지 않음

        // 완료 여부 확인
        const completed = isUnitCompleted(pageKey);

        // 배지 업데이트
        const badge = unit.querySelector('.status-badge');
        if (badge) {
          badge.classList.remove('status-default', 'status-done');
          if (completed) {
            badge.classList.add('status-done');
            badge.textContent = '🏆 학습완료';
          } else {
            badge.classList.add('status-default');
            badge.textContent = '✏️ 미완료';
          }
        }

        // 별점 업데이트
        const unitRight = unit.querySelector('.unit-right');
        if (unitRight) {
          // 기존 별점 제거
          const existingStars = unitRight.querySelector('.unit-stars');
          if (existingStars) {
            existingStars.remove();
          }

          // 새로운 별점 추가 (완료된 경우만)
          if (completed) {
            const gradeInfo = unitGradesData[unitCode];
            const stars = gradeInfo ? getStarsForGrade(gradeInfo.grade) : '';

            console.log(`⭐ [${unitCode}] completed=${completed}, gradeInfo=`, gradeInfo, 'stars=', stars);

            if (stars) {
              const starsSpan = document.createElement('span');
              starsSpan.className = 'unit-stars';
              starsSpan.textContent = stars;
              // 배지 앞에 별점 삽입
              if (badge) {
                unitRight.insertBefore(starsSpan, badge);
              } else {
                unitRight.appendChild(starsSpan);
              }
            }
          }
        }
      });
      console.log('✅ 메인 메뉴 학습 완료 상태 및 별점 업데이트 완료');
    }

    // 오늘 어휘퀴즈 완료 여부 확인
    async function checkVocabularyCompletedToday() {
      try {
        const userStr = sessionStorage.getItem('user');
        if (!userStr) {
          console.error('사용자 정보가 없습니다');
          return false;
        }

        const user = JSON.parse(userStr);

        const response = await fetch(
          `/api/user-progress/vocabulary-history/today?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`
        );

        const result = await response.json();
        if (result.ok) {
          return result.completedToday;
        }
        return false;
      } catch (error) {
        console.error('어휘퀴즈 완료 여부 확인 오류:', error);
        return false;
      }
    }

    // 어휘퀴즈 팝업 열기
    function openVocabularyQuiz() {
      const existingOverlay = document.getElementById('vocabularyQuizOverlay');
      if (existingOverlay) {
        existingOverlay.remove();
      }

      const overlay = document.createElement('div');
      overlay.id = 'vocabularyQuizOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10003;
      `;

      // 컨테이너 (iframe + X 버튼을 포함)
      const container = document.createElement('div');
      container.style.cssText = `
        position: relative;
        width: 1000px;
        height: 700px;
        max-width: 90%;
        max-height: 90%;
      `;

      // X 버튼
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.cssText = `
        position: absolute;
        top: -15px;
        right: -15px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ff4444;
        color: white;
        border: 3px solid white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10004;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.2s ease;
      `;
      closeBtn.onmouseover = () => {
        closeBtn.style.background = '#cc0000';
        closeBtn.style.transform = 'scale(1.1)';
      };
      closeBtn.onmouseout = () => {
        closeBtn.style.background = '#ff4444';
        closeBtn.style.transform = 'scale(1)';
      };
      closeBtn.onclick = closeVocabularyQuiz;

      // iframe
      const iframe = document.createElement('iframe');
      iframe.id = 'vocabularyQuizIframe';
      iframe.src = '/demo-vocabulary-quiz.html';
      iframe.style.cssText = `
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 12px;
        background: white;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      `;

      container.appendChild(closeBtn);
      container.appendChild(iframe);
      overlay.appendChild(container);
      document.body.appendChild(overlay);

      // 오버레이 클릭 시 닫기 (iframe 외부 클릭)
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeVocabularyQuiz();
        }
      });
    }

    // 어휘퀴즈 팝업 닫기
    function closeVocabularyQuiz() {
      const overlay = document.getElementById('vocabularyQuizOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    // 구 형식 unitId를 새 형식으로 정규화 (world_02 -> world1_02, people_02 -> people1_02)
    function normalizeUnitId(unitId) {
      if (!unitId) return unitId;
      const legacyMatch = unitId.match(/^(world|people)_(\d+)$/i);
      if (legacyMatch) {
        const oldPrefix = legacyMatch[1].toLowerCase();
        const num = parseInt(legacyMatch[2], 10);
        // 41~80은 world2/people2의 01~40으로 변환
        if (num >= 41 && num <= 80) {
          const newNum = (num - 40).toString().padStart(2, '0');
          return `${oldPrefix}2_${newNum}`;
        }
        // 1~40은 world1/people1의 01~40으로 변환
        const paddedNum = num.toString().padStart(2, '0');
        return `${oldPrefix}1_${paddedNum}`;
      }
      return unitId;
    }

    // 부여 시간 포맷 함수 (11월 25일 14:30 형태)
    function formatAssignedTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${month}월 ${day}일 ${hours}:${minutes}`;
    }

    // unitId에서 한글 과목/분야/제목 정보 추출 (AI 추천 과제용)
    function getUnitInfoFromId(unitId) {
      // 과목 코드 -> 한글 매핑
      const subjectMap = {
        'bio': '생물', 'earth': '지구과학', 'physics': '물리', 'chem': '화학',
        'soc': '사회문화', 'geo': '지리', 'law': '법', 'pol': '정치경제',
        'classic': '고전문학', 'modern': '현대문학',
        'world': '세계문학', 'world1': '세계문학1', 'world2': '세계문학2',
        'people': '인물', 'people1': '한국인물', 'people2': '세계인물'
      };

      // 분야 코드 -> 한글 매핑
      const fieldMap = {
        'science': '과학분야', 'social': '사회분야', 'korlit': '국어분야',
        'worldlit': '세계문학분야', 'person': '인물분야'
      };

      // 과목 코드에서 분야 유추
      const subjectToField = {
        'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
        'soc': 'social', 'geo': 'social', 'law': 'social', 'pol': 'social',
        'classic': 'korlit', 'modern': 'korlit',
        'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
        'people': 'person', 'people1': 'person', 'people2': 'person'
      };

      // unitId에서 과목코드와 번호 추출 (예: "chem_01", "physics_12", "./BRAINUP/science/chem_01.html", "fit_bio_01", "deep_bio_01")
      let subjectCode = '';
      let unitNo = '';
      let isDeep = false;

      // deep_ 접두어 경로 형식인 경우 (./BRAINUP/science/deep_bio_01.html)
      const deepPathMatch = unitId.match(/\/deep_([a-z]+\d?)_(\d+)\.html$/i);
      if (deepPathMatch) {
        subjectCode = deepPathMatch[1].toLowerCase();
        unitNo = deepPathMatch[2];
        isDeep = true;
      } else {
        // deep_ 접두어 단순 코드 형식인 경우 (deep_bio_01)
        const deepCodeMatch = unitId.match(/^deep_([a-z]+\d?)_(\d+)$/i);
        if (deepCodeMatch) {
          subjectCode = deepCodeMatch[1].toLowerCase();
          unitNo = deepCodeMatch[2];
          isDeep = true;
        } else {
          // fit_ 접두어 경로 형식인 경우 (./BRAINUP/science/fit_chem_01.html)
          const fitPathMatch = unitId.match(/\/fit_([a-z]+\d?)_(\d+)\.html$/i);
          if (fitPathMatch) {
            subjectCode = fitPathMatch[1].toLowerCase();
            unitNo = fitPathMatch[2];
          } else {
            // fit_ 접두어 단순 코드 형식인 경우 (fit_chem_01, fit_people2_03)
            const fitCodeMatch = unitId.match(/^fit_([a-z]+\d?)_(\d+)$/i);
            if (fitCodeMatch) {
              subjectCode = fitCodeMatch[1].toLowerCase();
              unitNo = fitCodeMatch[2];
            } else {
              // 파일 경로 형식인 경우 (./BRAINUP/science/chem_01.html)
              const pathMatch = unitId.match(/\/([a-z]+\d?)_(\d+)\.html$/i);
              if (pathMatch) {
                subjectCode = pathMatch[1].toLowerCase();
                unitNo = pathMatch[2];
              } else {
                // 단순 코드 형식인 경우 (chem_01)
                const codeMatch = unitId.match(/^([a-z]+\d?)_(\d+)$/i);
                if (codeMatch) {
                  subjectCode = codeMatch[1].toLowerCase();
                  unitNo = codeMatch[2];
                }
              }
            }
          }
        }
      }

      const subjectLabel = subjectMap[subjectCode] || subjectCode;
      const fieldCode = subjectToField[subjectCode] || 'social';
      const fieldLabel = fieldMap[fieldCode] || '분야';

      // unitNo에서 앞의 0 제거 (01 -> 1)
      const displayNo = unitNo ? parseInt(unitNo, 10).toString() : '';

      // ✅ BRAINDEEP (deep_bio 등)인 경우 CONTENTS에서 실제 제목 가져오기
      let displayTitle = displayNo ? `${subjectLabel} ${displayNo}` : subjectLabel;

      if (isDeep && window.CONTENTS) {
        const contentKey = `deep_${subjectCode}_${unitNo}`;
        if (window.CONTENTS[contentKey] && window.CONTENTS[contentKey].title) {
          displayTitle = window.CONTENTS[contentKey].title;
        }
      }

      return {
        subjectCode: subjectCode,
        subjectLabel: subjectLabel,
        fieldCode: fieldCode,
        fieldLabel: fieldLabel,
        unitNo: unitNo,
        displayTitle: displayTitle
      };
    }

    // 학습실 목록 렌더링
    async function renderStudyRoomList() {
      const list = document.getElementById('studyRoomList');
      if (!list) return;

      // 단원별 등급 데이터 로드
      unitGradesData = await fetchUnitGrades();

      const allTasks = await getStudyRoomTasks();

      // AI 과제와 일반 과제 분리 후 각각 시간순 정렬
      const aiTasks = allTasks.filter(t => t.isAI).sort((a, b) => {
        const dateA = new Date(a.assignedAt || 0);
        const dateB = new Date(b.assignedAt || 0);
        return dateB - dateA; // 내림차순 (최신 순)
      });

      const normalTasks = allTasks.filter(t => !t.isAI).sort((a, b) => {
        const dateA = new Date(a.assignedAt || 0);
        const dateB = new Date(b.assignedAt || 0);
        return dateB - dateA; // 내림차순 (최신 순)
      });

      // AI 과제를 먼저, 일반 과제를 나중에
      const tasks = [...aiTasks, ...normalTasks];

      list.innerHTML = '';

      // ========== 어휘력 데일리 과제 섹션 (최상단 고정) ==========
      const vocabDailyHeader = document.createElement('li');
      vocabDailyHeader.className = 'study-room-divider';
      vocabDailyHeader.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0;">
          <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #10b981, transparent);"></div>
          <span style="color: #10b981; font-size: 13px; font-weight: 600; white-space: nowrap;">📖 어휘력 데일리 과제</span>
          <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #10b981, transparent);"></div>
        </div>
      `;
      list.appendChild(vocabDailyHeader);

      // 오늘 어휘퀴즈 완료 여부 체크
      const vocabCompletedToday = await checkVocabularyCompletedToday();

      // 어휘력 향상 퀴즈 항목
      const vocabItem = document.createElement('li');
      vocabItem.className = 'study-room-item';
      vocabItem.style.cursor = 'pointer';
      vocabItem.dataset.isVocabQuiz = 'true';

      const vocabBadgeClass = vocabCompletedToday ? 'status-done' : 'status-default';
      const vocabBadgeText = vocabCompletedToday ? '🏆 학습완료' : '✏️ 미완료';

      vocabItem.innerHTML = `
        <div class="task-info">
          <div class="task-title" style="font-weight: 600;">어휘력 향상 퀴즈</div>
          <div class="task-meta" style="font-size: 12px; color: #6b7280; margin-top: 4px;">
            매일 학습으로 어휘력을 키워보세요!
          </div>
        </div>
        <div class="task-status">
          <span class="status-badge ${vocabBadgeClass}">${vocabBadgeText}</span>
        </div>
      `;

      // 클릭 시 어휘퀴즈 팝업 열기
      vocabItem.addEventListener('click', openVocabularyQuiz);

      list.appendChild(vocabItem);

      // ========== 독서 감상문 월간 과제 섹션 ==========
      const readingReportHeader = document.createElement('li');
      readingReportHeader.className = 'study-room-divider';
      readingReportHeader.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0;">
          <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #f59e0b, transparent);"></div>
          <span style="color: #f59e0b; font-size: 13px; font-weight: 600; white-space: nowrap;">📝 독서 감상문 월간 과제</span>
          <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #f59e0b, transparent);"></div>
        </div>
      `;
      list.appendChild(readingReportHeader);

      // 이번 달 제출 개수 확인
      const monthlyReportCount = await getMonthlyReportCount();

      // 독서 감상문 항목
      const reportItem = document.createElement('li');
      reportItem.className = 'study-room-item';
      reportItem.style.cursor = 'pointer';
      reportItem.dataset.isReadingReport = 'true';

      const reportBadgeClass = monthlyReportCount > 0 ? 'status-done' : 'status-default';
      const reportBadgeText = monthlyReportCount > 0 ? `🏆 이번 달 ${monthlyReportCount}개 제출완료` : '✏️ 미제출';

      reportItem.innerHTML = `
        <div class="task-info">
          <div class="task-title" style="font-weight: 600;">고래 도서관 독서 감상문</div>
          <div class="task-meta" style="font-size: 12px; color: #6b7280; margin-top: 4px;">
            신나는 고래도서관 이야기를 읽고 감상문을 제출해보세요!
          </div>
        </div>
        <div class="task-status">
          <span class="status-badge ${reportBadgeClass}">${reportBadgeText}</span>
        </div>
      `;

      // 클릭 시 학습실 모달 닫고 고래 도서관 팝업 열기
      reportItem.addEventListener('click', () => {
        // 학습실 모달 닫기
        const studyRoomModal = document.getElementById('studyRoomModal');
        if (studyRoomModal) {
          studyRoomModal.classList.remove('show');
        }
        // 고래 도서관 팝업 열기
        goToWhaleStory();
      });

      list.appendChild(reportItem);

      // AI 추천 과제 헤더 추가 (AI 과제가 있을 때만)
      if (aiTasks.length > 0) {
        const aiHeader = document.createElement('li');
        aiHeader.className = 'study-room-divider';
        aiHeader.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0;">
            <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #a855f7, transparent);"></div>
            <span style="color: #a855f7; font-size: 13px; font-weight: 600; white-space: nowrap;">🤖 AI 추천 과제</span>
            <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #a855f7, transparent);"></div>
          </div>
        `;
        list.appendChild(aiHeader);
      }

      // 일반 과제 헤더 추가 (AI 과제가 없고 일반 과제만 있을 때)
      if (aiTasks.length === 0 && normalTasks.length > 0) {
        const normalHeader = document.createElement('li');
        normalHeader.className = 'study-room-divider';
        normalHeader.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0;">
            <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #e5e7eb, transparent);"></div>
            <span style="color: #9ca3af; font-size: 13px; font-weight: 500; white-space: nowrap;">📚 일반 과제</span>
            <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #e5e7eb, transparent);"></div>
          </div>
        `;
        list.appendChild(normalHeader);
      }

      // 모든 과제를 순회하며 렌더링 (제한 없음)
      tasks.forEach((task, i) => {
        // AI 과제와 일반 과제 사이에 구분선 추가 (둘 다 있을 때만)
        if (i === aiTasks.length && aiTasks.length > 0 && normalTasks.length > 0) {
          const divider = document.createElement('li');
          divider.className = 'study-room-divider';
          divider.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0;">
              <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #e5e7eb, transparent);"></div>
              <span style="color: #9ca3af; font-size: 13px; font-weight: 500; white-space: nowrap;">📚 일반 과제</span>
              <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #e5e7eb, transparent);"></div>
            </div>
          `;
          list.appendChild(divider);
        }
        const li = document.createElement('li');
        li.className = 'study-room-item';

        // AI 과제는 id, 관리자 과제는 unitId 사용
        const rawUnitId = task.id || task.unitId;
        // 구 형식 ID를 새 형식으로 정규화 (world_02 -> world1_02)
        const unitId = normalizeUnitId(rawUnitId);
        const isCompleted = isUnitCompleted(unitId);

        li.dataset.unitId = unitId;  // 정규화된 ID 저장
        li.dataset.taskIndex = i; // 과제 인덱스 저장 (복습 완료 처리용)
        li.style.cursor = 'pointer';

        // unitId에서 단원 코드 추출 (./BRAINUP/social/geo_03.html -> geo_03)
        let unitCode = unitId;
        const match = unitId.match(/\/([^\/]+)\.html$/);
        if (match) {
          unitCode = match[1];
        }
        // unitCode도 정규화 (world_02 -> world1_02)
        unitCode = normalizeUnitId(unitCode);

        // AI 과제와 일반 과제의 배지 구분
        let badgeClass = '';
        let badgeText = '';

        if (task.isAI) {
          // AI 추천 과제 - task.status로 복습 완료 여부 확인
          if (task.status === 'completed') {
            badgeClass = 'status-ai-done';
            badgeText = '✅ 복습완료';
          } else {
            badgeClass = 'status-ai-pending';
            badgeText = '🔄 복습필요';
          }
        } else {
          // 일반 과제 - LearningLog로 학습 완료 여부 확인
          if (isCompleted) {
            badgeClass = 'status-done';
            badgeText = '🏆 학습완료';
          } else {
            badgeClass = 'status-default';
            badgeText = '✏️ 미완료';
          }
        }

        // 학습이 완료된 과제는 별점 추가 (unitCode 사용)
        // AI 추천 과제: task.status === 'completed' (복습완료)일 때만 별점 표시
        // 일반 과제: isCompleted (학습완료)일 때 별점 표시
        const gradeInfo = unitGradesData[unitCode];
        const showStars = task.isAI ? (task.status === 'completed') : isCompleted;
        const stars = showStars && gradeInfo
          ? getStarsForGrade(gradeInfo.grade)
          : '';

        // 디버깅: 별이 안 나오는 이유 확인
        if ((task.status === 'completed' || isCompleted) && !stars) {
          console.log(`⭐ [디버깅] 별이 없는 완료 과제:`, {
            title: task.title,
            unitId: unitId,
            unitCode: unitCode,
            isCompleted: isCompleted,
            taskStatus: task.status,
            hasGradeInfo: !!gradeInfo,
            gradeInfo: gradeInfo
          });
        }

        const assignedTimeText = formatAssignedTime(task.assignedAt);

        // AI 과제인 경우 unitId에서 한글 정보 추출
        let displayTitle = task.title;
        let displayMeta = `${task.series} > ${task.field || task.domain} > ${task.subject}`;

        if (task.isAI) {
          const unitInfo = getUnitInfoFromId(unitId);
          if (unitInfo.subjectLabel && unitInfo.unitNo) {
            // unitInfo에서 직접 제목 생성 (fit NaN 문제 해결)
            displayTitle = unitInfo.displayTitle;
            displayMeta = `${task.series || 'BRAIN핏'} > ${unitInfo.fieldLabel} > ${unitInfo.subjectLabel}`;
          } else if (task.title && !task.title.includes('NaN')) {
            // DB에 저장된 task.title 변환 (people1 1 -> 한국인물 1, people2 1 -> 세계인물 1)
            let convertedTitle = task.title;
            // people1 X -> 한국인물 X
            const people1Match = convertedTitle.match(/^people1\s+(\d+)$/);
            if (people1Match) {
              convertedTitle = `한국인물 ${people1Match[1]}`;
            }
            // people2 X -> 세계인물 X
            const people2Match = convertedTitle.match(/^people2\s+(\d+)$/);
            if (people2Match) {
              convertedTitle = `세계인물 ${people2Match[1]}`;
            }
            displayTitle = convertedTitle;
          }
        }

        li.innerHTML = `
          <div class="study-room-item-left">
            <div class="study-room-item-title">
              ${task.isAI ? '🤖 ' : ''}${displayTitle}${task.isAI ? ' <span style="color: #667eea; font-size: 12px;">(AI 추천)</span>' : ''}
            </div>
            <div class="study-room-item-meta">${displayMeta}</div>
            ${assignedTimeText ? `<div class="study-room-item-assigned-time" style="font-size: 11px; color: #9ca3af; margin-top: 4px;">📅 부여시간: ${assignedTimeText}</div>` : ''}
          </div>
          <div class="study-room-item-right">
            ${stars ? `<span class="unit-stars">${stars}</span>` : ''}
            <span class="status-badge ${badgeClass}">${badgeText}</span>
            <button class="trash-btn" data-task-id="${task.id || task.unitId || task.taskId}" title="삭제">🗑️</button>
          </div>
        `;

        // 과제 클릭 시 학습 페이지 열기
        li.addEventListener('click', (e) => {
          // 휴지통 버튼 클릭 시에는 열리지 않도록
          if (e.target.classList.contains('trash-btn') || e.target.closest('.trash-btn')) {
            return;
          }
          // 학습실 모달 먼저 닫기
          closeStudyRoomModal();
          // 약간의 딜레이 후 학습 페이지 열기
          setTimeout(() => {
            openUnitModal(unitId);
          }, 200);
        });

        list.appendChild(li);
      });

      // 휴지통 버튼 이벤트 리스너 추가
      list.querySelectorAll('.trash-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskId = btn.getAttribute('data-task-id');
          showAdminPasswordModal(taskId);
        });
      });
    }

    // 과제 추가
    async function addTaskToStudyRoom(taskData) {
      const tasks = await getStudyRoomTasks();

      // 중복 체크 (AI 과제는 id, 관리자 과제는 unitId 사용)
      const isDuplicate = tasks.some(t =>
        (t.id && t.id === taskData.unitId) ||
        (t.unitId && t.unitId === taskData.unitId)
      );
      if (isDuplicate) {
        showMessage('⚠️', '중복된 과제입니다', '이미 학습실에 추가된 과제입니다.');
        return false;
      }

      // 과제 추가
      tasks.push(taskData);
      await saveStudyRoomTasks(tasks);

      // 학습실 모달이 열려있으면 목록 갱신
      const modal = document.getElementById('studyRoomModal');
      if (modal && modal.classList.contains('show')) {
        renderStudyRoomList();
      }

      showMessage('✅', '과제가 추가되었습니다', `"${taskData.title}"이(가) 학습실에 추가되었습니다.`);
      return true;
    }

    // 과제 삭제
    async function removeTaskFromStudyRoom(taskId) {
      const tasks = await getStudyRoomTasks();
      const taskIndex = tasks.findIndex(t =>
        (t.id && t.id === taskId) ||
        (t.unitId && t.unitId === taskId) ||
        (t.taskId && t.taskId === taskId)
      );

      if (taskIndex >= 0) {
        const removedTask = tasks.splice(taskIndex, 1)[0];
        await saveStudyRoomTasks(tasks);
        renderStudyRoomList();
        // 한글 제목으로 변환 (physics_01 -> 물리 01)
        const taskIdForDisplay = removedTask.id || removedTask.unitId || removedTask.taskId || removedTask.title;
        const unitInfo = getUnitInfoFromId(taskIdForDisplay);
        const displayName = unitInfo.displayTitle || removedTask.title;
        showMessage('✅', '과제가 삭제되었습니다', `"${displayName}"이(가) 학습실에서 삭제되었습니다.`);
      }
    }

    // 관리자 비밀번호 모달 표시
    let pendingDeleteTaskId = null;
    function showAdminPasswordModal(taskId) {
      pendingDeleteTaskId = taskId;
      const overlay = document.getElementById('adminPasswordOverlay');
      const input = document.getElementById('adminPasswordInput');
      if (overlay && input) {
        input.value = '';
        overlay.classList.add('show');
        setTimeout(() => input.focus(), 100);
      }
    }

    // 관리자 비밀번호 확인
    function verifyAdminPassword() {
      const input = document.getElementById('adminPasswordInput');
      const overlay = document.getElementById('adminPasswordOverlay');

      if (input && overlay) {
        const password = input.value.trim();
        if (password === ADMIN_PASSWORD) {
          overlay.classList.remove('show');
          input.value = '';
          // 비밀번호 인증 성공 후 최종 확인 팝업
          showDeleteConfirmModal();
        } else {
          showMessage('🚫', '비밀번호 오류', '관리자 비밀번호가 올바르지 않습니다.');
          input.value = '';
          input.focus();
        }
      }
    }

    // 삭제 최종 확인 모달
    function showDeleteConfirmModal() {
      const overlay = document.getElementById('deleteConfirmOverlay');
      if (overlay) {
        overlay.classList.add('show');
      }
    }

    function confirmDeleteTask() {
      const overlay = document.getElementById('deleteConfirmOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
      if (pendingDeleteTaskId !== null) {
        removeTaskFromStudyRoom(pendingDeleteTaskId);
        pendingDeleteTaskId = null;
      }
    }

    function cancelDeleteTask() {
      const overlay = document.getElementById('deleteConfirmOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
      pendingDeleteTaskId = null;
    }

    // 메시지 표시 (오류 알림 팝업)
    function showMessage(emoji, title, msg) {
      const overlay = document.getElementById('errorMessageOverlay');
      const emojiEl = document.getElementById('errorEmoji');
      const titleEl = document.getElementById('errorTitle');
      const msgEl = document.getElementById('errorMsg');

      if (overlay && emojiEl && titleEl && msgEl) {
        emojiEl.textContent = emoji;
        titleEl.textContent = title;
        msgEl.textContent = msg;
        overlay.classList.add('show');
      }
    }

    function closeErrorMessage() {
      const overlay = document.getElementById('errorMessageOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    // 단원 완료 상태 확인
    function isUnitCompleted(unitId) {
      // unitId가 없으면 false 반환
      if (!unitId) return false;

      // 학생 정보 가져오기 (sessionStorage 우선, localStorage fallback)
      let stu = JSON.parse(sessionStorage.getItem('user') || '{}');
      if (!stu.grade || !stu.name) {
        stu = getCurrentStudent();
      }
      if (!stu || !stu.grade || !stu.name) return false;

      // unitId에서 단원 코드 추출 (./BRAINUP/social/geo_02.html -> geo_02)
      let unitCode = unitId;
      const match = unitId.match(/\/([^\/]+)\.html$/);
      if (match) {
        unitCode = match[1];
      }

      // ✅ world2_XX, people2_XX 형식 그대로 사용 (서버 API와 동일하게)
      // 서버에서 world2_XX 형식 그대로 저장하므로 변환하지 않음

      // ✅ 두 가지 키 형식 모두 확인 (하위 호환)
      // 1. buildStudentKey 형식 (전화번호 포함): 1학년_홍길동_11
      // 2. 기존 형식 (전화번호 없음): 1학년_홍길동
      const stuKeyWithPhone = buildStudentKey(stu);
      const gradeNum = String(stu.grade).replace('학년', '');
      const stuKeyWithoutPhone = `${gradeNum}학년_${stu.name}`;

      // 두 키 모두 확인
      for (const stuKey of [stuKeyWithPhone, stuKeyWithoutPhone]) {
        const storageKey = `dan-progress:${stuKey}:${unitCode}`;
        try {
          const data = localStorage.getItem(storageKey);
          if (data) {
            // ✅ 여러 형식 지원: 배열, 문자열 '1', 기타 truthy 값
            let saved;
            try {
              saved = JSON.parse(data);
            } catch(parseErr) {
              // JSON 파싱 실패 → 단순 문자열로 처리
              saved = data;
            }

            // 배열인 경우
            if (Array.isArray(saved) && saved.length > 0) {
              console.log(`[isUnitCompleted] ✅ 완료(배열)! unitCode=${unitCode}, stuKey=${stuKey}`);
              return true;
            }
            // 문자열 '1' 또는 다른 truthy 값인 경우 (과학 분야 등)
            if (saved && saved !== 'false' && saved !== '0') {
              console.log(`[isUnitCompleted] ✅ 완료(단순값)! unitCode=${unitCode}, stuKey=${stuKey}, value=${data}`);
              return true;
            }
          }
        } catch(e) {}
      }

      // ✅ Fallback: localStorage에서 학생 이름과 unitCode가 모두 포함된 키 검색
      // (키 형식이 다른 경우에도 완료 상태를 찾을 수 있도록)
      const studentName = stu.name;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('dan-progress:') && key.includes(studentName) && key.endsWith(`:${unitCode}`)) {
          try {
            const data = localStorage.getItem(key);
            if (data) {
              // ✅ 여러 형식 지원
              let saved;
              try {
                saved = JSON.parse(data);
              } catch(parseErr) {
                saved = data;
              }

              // 배열인 경우
              if (Array.isArray(saved) && saved.length > 0) {
                console.log(`[isUnitCompleted] ✅ Fallback 완료(배열)! unitCode=${unitCode}, key=${key}`);
                return true;
              }
              // 단순값인 경우
              if (saved && saved !== 'false' && saved !== '0') {
                console.log(`[isUnitCompleted] ✅ Fallback 완료(단순값)! unitCode=${unitCode}, key=${key}, value=${data}`);
                return true;
              }
            }
          } catch(e) {}
        }
      }

      console.log(`[isUnitCompleted] ❌ 미완료 unitCode=${unitCode}`);
      return false;
    }

    // 과제부여 모달 표시 (모바일용)
    let pendingTaskData = null;
    function showAssignTaskModal(taskDataStr) {
      try {
        pendingTaskData = JSON.parse(taskDataStr);
        const overlay = document.getElementById('assignTaskOverlay');
        const msgEl = document.getElementById('assignTaskMsg');

        if (overlay && msgEl) {
          msgEl.textContent = `"${pendingTaskData.title}"을(를) 학습실에 추가하시겠습니까?`;
          overlay.classList.add('show');
        }
      } catch (err) {
        console.error('과제 데이터 파싱 오류:', err);
      }
    }

    // 과제부여 확인
    function confirmAssignTask() {
      if (pendingTaskData) {
        addTaskToStudyRoom(pendingTaskData);
        pendingTaskData = null;
      }
      const overlay = document.getElementById('assignTaskOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    // 학습실 모달 이벤트 리스너
    document.addEventListener('DOMContentLoaded', () => {
      // ✅ 페이지 로드 시 학습실 모달 상태 복원
      restoreStudyRoomModal();

      // 학습실 아이콘 클릭
      const studyRoomIcon = document.getElementById('studyRoomIcon');
      if (studyRoomIcon) {
        studyRoomIcon.addEventListener('click', openStudyRoomModal);

        // 학습실 아이콘에 드래그 앤 드롭 기능 추가
        studyRoomIcon.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          studyRoomIcon.style.transform = 'scale(1.15)';
          studyRoomIcon.style.filter = 'drop-shadow(0 8px 24px rgba(255, 107, 107, 0.6))';
        });

        studyRoomIcon.addEventListener('dragleave', (e) => {
          studyRoomIcon.style.transform = '';
          studyRoomIcon.style.filter = '';
        });

        studyRoomIcon.addEventListener('drop', (e) => {
          e.preventDefault();
          studyRoomIcon.style.transform = '';
          studyRoomIcon.style.filter = '';

          const taskDataStr = e.dataTransfer.getData('text/plain');
          if (taskDataStr) {
            try {
              const taskData = JSON.parse(taskDataStr);
              addTaskToStudyRoom(taskData);
            } catch (err) {
              console.error('과제 데이터 파싱 오류:', err);
            }
          }
        });
      }

      // 학습실 모달 닫기 버튼
      const closeBtn = document.getElementById('closeStudyRoomModal');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeStudyRoomModal);
      }

      // 모달 배경 클릭 시 닫기 - 비활성화 (배경 클릭 시 닫히지 않도록)
      // const modal = document.getElementById('studyRoomModal');
      // if (modal) {
      //   modal.addEventListener('click', (e) => {
      //     if (e.target === modal) {
      //       closeStudyRoomModal();
      //     }
      //   });
      // }

      // 관리자 비밀번호 모달 버튼
      const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
      const confirmPasswordBtn = document.getElementById('confirmPasswordBtn');

      if (cancelPasswordBtn) {
        cancelPasswordBtn.addEventListener('click', () => {
          document.getElementById('adminPasswordOverlay').classList.remove('show');
          pendingDeleteIndex = null;
        });
      }

      if (confirmPasswordBtn) {
        confirmPasswordBtn.addEventListener('click', verifyAdminPassword);
      }

      // Enter 키로 비밀번호 확인
      const passwordInput = document.getElementById('adminPasswordInput');
      if (passwordInput) {
        passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            verifyAdminPassword();
          }
        });
      }

      // 과제부여 모달 버튼
      const cancelAssignBtn = document.getElementById('cancelAssignBtn');
      const confirmAssignBtn = document.getElementById('confirmAssignBtn');

      if (cancelAssignBtn) {
        cancelAssignBtn.addEventListener('click', () => {
          document.getElementById('assignTaskOverlay').classList.remove('show');
          pendingTaskData = null;
        });
      }

      if (confirmAssignBtn) {
        confirmAssignBtn.addEventListener('click', confirmAssignTask);
      }

      // 삭제 최종 확인 모달 버튼
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', cancelDeleteTask);
      }

      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', confirmDeleteTask);
      }

      // 준비 중 팝업 닫기 버튼
      const closeComingSoonBtn = document.getElementById('closeComingSoonBtn');
      if (closeComingSoonBtn) {
        closeComingSoonBtn.addEventListener('click', closeComingSoonPopup);
      }

      // 준비 중 팝업 배경 클릭으로 닫기 - 비활성화 (배경 클릭 시 닫히지 않도록)
      // const comingSoonOverlay = document.getElementById('comingSoonOverlay');
      // if (comingSoonOverlay) {
      //   comingSoonOverlay.addEventListener('click', (e) => {
      //     if (e.target === comingSoonOverlay) {
      //       closeComingSoonPopup();
      //     }
      //   });
      // }

      // 오류 메시지 모달 닫기 버튼
      const closeErrorBtn = document.getElementById('closeErrorBtn');
      if (closeErrorBtn) {
        closeErrorBtn.addEventListener('click', closeErrorMessage);
      }

      // 오류 메시지 배경 클릭으로 닫기 - 비활성화 (배경 클릭 시 닫히지 않도록)
      // const errorOverlay = document.getElementById('errorMessageOverlay');
      // if (errorOverlay) {
      //   errorOverlay.addEventListener('click', (e) => {
      //     if (e.target === errorOverlay) {
      //       closeErrorMessage();
      //     }
      //   });
      // }

      // 초기 뱃지 업데이트
      updateStudyRoomBadge();

      // ✅ 세션이 이미 준비됐으면 바로 업데이트, 아니면 이벤트 대기
      if (window.sessionReady) {
        console.log('🔄 세션 이미 준비됨 - 어휘지수 뱃지 업데이트');
        updateVocabAvgBadge();
      } else {
        updateVocabAvgBadge(); // 일단 시도
        window.addEventListener('sessionReady', () => {
          console.log('🔄 세션 준비 완료 - 어휘지수 뱃지 재업데이트');
          updateVocabAvgBadge();
        });
      }

      // storage 이벤트로 실시간 동기화
      window.addEventListener('storage', (e) => {
        if (e.key && e.key.startsWith('studyRoom_')) {
          updateStudyRoomBadge();
          const modal = document.getElementById('studyRoomModal');
          if (modal && modal.classList.contains('show')) {
            renderStudyRoomList();
          }
        }
        // 학습 완료 상태 변경 시에도 학습실 목록 업데이트
        if (e.key && (e.key.startsWith('completed_') || e.key.startsWith('dan-progress:'))) {
          const modal = document.getElementById('studyRoomModal');
          if (modal && modal.classList.contains('show')) {
            renderStudyRoomList();
          }
        }
      });
    });

    // 푸른 고래섬 이야기 팝업 열기
    function goToWhaleStory() {
      const modal = document.getElementById('whaleStoryModal');
      modal.classList.add('show');
      // Reset carousel to first slide
      currentSlide = 0;
      updateCarousel();
    }

    // 시즌 선택 팝업 닫기 함수
    function closeWhaleStoryModal() {
      const modal = document.getElementById('whaleStoryModal');
      console.log('시즌 선택 팝업 닫기');
      modal.classList.remove('show');
    }

    // 시즌 선택 - 팝업으로 열기
    // Carousel state
    let currentSlide = 0;
    const totalSlides = 11;

    function updateCarousel() {
      const carousel = document.getElementById('storyCarousel');
      const prevBtn = document.getElementById('carouselPrev');
      const nextBtn = document.getElementById('carouselNext');

      carousel.style.transform = `translateX(-${currentSlide * 100}%)`;

      // Update button states
      prevBtn.disabled = currentSlide === 0;
      nextBtn.disabled = currentSlide === totalSlides - 1;
    }

    function moveCarousel(direction) {
      currentSlide += direction;
      if (currentSlide < 0) currentSlide = 0;
      if (currentSlide >= totalSlides) currentSlide = totalSlides - 1;
      updateCarousel();
    }

    function goToSeason(storyType, season) {
      const urls = {
        whale: {
          1: '/whale_island_journey.html',
          2: '/whale_island_season2_quiz.html',
          3: '/whale_island_season3_quiz.html'
        },
        jungle: {
          1: '/jungle_journey_season1.html',
          2: '/jungle_season2_quiz.html',
          3: '/jungle_season3_quiz.html'
        },
        library: {
          1: '/library/library_season1.html',
          2: '/library_season2_quiz.html',
          3: '/library_season3_quiz.html'
        },
        timeLibrary: {
          1: '/time-library/time_library_season1.html',
          2: '/time_library_season2_quiz.html',
          3: '/time_library_season3_quiz.html'
        },
        catIsland: {
          1: '/cat-island/cat_island_season1.html',
          2: '/cat-island/cat_island_season2.html',
          3: '/cat-island/cat_island_season3.html'
        },
        catTransform: {
          1: '/cat-transform/cat_transform_season1.html',
          2: '/cat-transform/cat_transform_season2_quiz.html',
          3: '/cat-transform/cat_transform_season3_quiz.html'
        },
        sonagi: {
          1: '/rain/sonagi_season1.html'
        },
        goodday: {
          1: '/good/goodday_season1.html'
        },
        dongbaek: {
          1: '/flower/dongbaek_season1.html'
        },
        samdae: {
          1: '/three/samdae_season1.html'
        },
        chunhyang: {
          1: '/girl/chunhyang_season1.html'
        }
      };

      if (urls[storyType] && urls[storyType][season]) {
        // 시즌 선택 모달 닫기
        document.getElementById('whaleStoryModal').classList.remove('show');

        // 스토리 콘텐츠 모달 열기
        const storyModal = document.getElementById('storyContentModal');
        const storyIframe = document.getElementById('storyContentIframe');

        storyIframe.src = urls[storyType][season];
        storyModal.classList.add('show');
      }
    }

    // 스토리 콘텐츠 모달 닫기 함수
    function closeStoryModal() {
      const storyModal = document.getElementById('storyContentModal');
      const storyIframe = document.getElementById('storyContentIframe');

      console.log('닫기 버튼 클릭됨');
      storyModal.classList.remove('show');

      // iframe 정리
      setTimeout(() => {
        storyIframe.src = '';
      }, 300);

      // 고래 이야기 슬라이드(시즌 선택 화면)로 돌아가기
      const whaleStoryModal = document.getElementById('whaleStoryModal');
      if (whaleStoryModal) {
        whaleStoryModal.classList.add('show');
      }
    }

    // DOMContentLoaded 후 이벤트 등록
    document.addEventListener('DOMContentLoaded', function() {
      // 시즌 선택 팝업 닫기 버튼
      const closeWhaleBtn = document.getElementById('closeWhaleStoryModal');
      if (closeWhaleBtn) {
        closeWhaleBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('시즌 선택 X 버튼 클릭');
          closeWhaleStoryModal();
        });
      }

      // 시즌 선택 팝업 배경 클릭 시 닫기
      const whaleModal = document.getElementById('whaleStoryModal');
      if (whaleModal) {
        whaleModal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeWhaleStoryModal();
          }
        });
      }

      // 스토리 콘텐츠 모달 닫기 버튼
      const closeBtn = document.getElementById('closeStoryContentModal');
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('스토리 X 버튼 클릭');
          closeStoryModal();
        });
      }

      // 스토리 모달 배경 클릭 시 닫기
      const storyModal = document.getElementById('storyContentModal');
      if (storyModal) {
        storyModal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeStoryModal();
          }
        });
      }

      // ESC 키로 모달 닫기
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const storyModal = document.getElementById('storyContentModal');
          const whaleModal = document.getElementById('whaleStoryModal');
          const readingModal = document.getElementById('readingReportModal');

          if (storyModal && storyModal.classList.contains('show')) {
            closeStoryModal();
          } else if (whaleModal && whaleModal.classList.contains('show')) {
            closeWhaleStoryModal();
          } else if (readingModal && readingModal.classList.contains('show')) {
            closeReadingReportModal();
          }
        }
      });
    });

    // ========== 독서 감상문 기능 ==========
    let currentEditingReport = null; // 현재 편집 중인 리포트 ID
    let autoSaveTimer = null;
    let historyDisplayLimit = 5; // 초기 표시 개수

    // 스토리 데이터 정의 (중앙 관리)
    const STORY_DATA = {
      whale: {
        title: '🐋 푸른 고래섬의 비밀 모험단',
        seasons: [
          { id: 'whale_island', season: 1, subtitle: '푸른 고래섬 탐험' },
          { id: 'whale_island_season2', season: 2, subtitle: '파도 골짜기의 비밀' },
          { id: 'whale_island_season3', season: 3, subtitle: '빛의 기억' }
        ]
      },
      jungle: {
        title: '🌿 깊은 정글의 잊힌 도시',
        seasons: [
          { id: 'jungle_journey', season: 1, subtitle: '잊힌 도시 발견' },
          { id: 'jungle_journey_season2', season: 2, subtitle: '도시의 균형 회복' },
          { id: 'jungle_journey_season3', season: 3, subtitle: '암녹림의 수호자' }
        ]
      },
      library: {
        title: '📚 살아 있는 신비의 도서관',
        seasons: [
          { id: 'library_season1', season: 1, subtitle: '지혜와 용기로 가득한 도서관 여정의 시작' },
          { id: 'library_season2', season: 2, subtitle: '빛과 어둠의 균형을 찾는 모험' },
          { id: 'library_season3', season: 3, subtitle: '파괴와 마법을 넘나드는 대 모험' }
        ]
      },
      timeLibrary: {
        title: '⏰ 시간도서관',
        seasons: [
          { id: 'time_library_season1', season: 1, subtitle: '과거의 문을 열다 - 잊힌 시대의 수호자들' },
          { id: 'time_library_season2', season: 2, subtitle: '현재의 균열 - 시간이 뒤틀린 도서관' },
          { id: 'time_library_season3', season: 3, subtitle: '미래의 심장 - 시간을 지키는 마지막 아이들' }
        ]
      },
      catIsland: {
        title: '🐱 미지의 고양이 섬 표류기',
        seasons: [
          { id: 'cat_island_season1', season: 1, subtitle: '바람이 데려온 섬' },
          { id: 'cat_island_season2', season: 2, subtitle: '바람고양이들의 숨겨진 날개' },
          { id: 'cat_island_season3', season: 3, subtitle: '마음의 왕국과 감정의 불꽃' }
        ]
      },
      catTransform: {
        title: '🐈 고양이가 되어버린 날',
        seasons: [
          { id: 'cat_transform_season1', season: 1, subtitle: '고양이의 눈으로 본 첫 세계' },
          { id: 'cat_transform_season2', season: 2, subtitle: '목걸이의 비밀과 그림자 왕국' },
          { id: 'cat_transform_season3', season: 3, subtitle: '그림자왕국의 심장' }
        ]
      },
      sonagi: {
        title: '🌧️ 소나기',
        seasons: [
          { id: 'sonagi_season1', season: 1, subtitle: '황순원 원작 - 소년과 소녀의 짧은 만남' }
        ]
      },
      goodday: {
        title: '☔ 운수 좋은 날',
        seasons: [
          { id: 'goodday_season1', season: 1, subtitle: '현진건 원작 - 비극적 아이러니' }
        ]
      },
      dongbaek: {
        title: '🌸 동백꽃',
        seasons: [
          { id: 'dongbaek_season1', season: 1, subtitle: '김유정 원작 - 순수한 시골 첫사랑' }
        ]
      },
      samdae: {
        title: '🏛️ 삼대',
        seasons: [
          { id: 'samdae_season1', season: 1, subtitle: '염상섭 원작 - 세 세대의 갈등' }
        ]
      },
      chunhyang: {
        title: '🌸 춘향전',
        seasons: [
          { id: 'chunhyang_season1', season: 1, subtitle: '신분을 초월한 사랑 이야기' }
        ]
      }
    };

    // 스토리 드롭다운 초기화
    function initStoryDropdown() {
      const storySelect = document.getElementById('reportStory');
      if (!storySelect) return;

      // 기존 옵션 제거 (첫 번째 placeholder 제외)
      while (storySelect.options.length > 1) {
        storySelect.remove(1);
      }

      // 스토리 데이터로부터 옵션 생성
      Object.values(STORY_DATA).forEach(story => {
        story.seasons.forEach(season => {
          const option = document.createElement('option');
          option.value = season.id;
          option.textContent = `${story.title} 시즌 ${season.season}: ${season.subtitle}`;
          option.setAttribute('data-title', `${story.title} 시즌 ${season.season}: ${season.subtitle}`);
          storySelect.appendChild(option);
        });
      });
    }

    // 독서 감상문 모달 열기
    async function openReadingReportModal() {
      const modal = document.getElementById('readingReportModal');
      modal.classList.add('show');

      // 스토리 드롭다운 초기화
      initStoryDropdown();

      // 사용자 정보로 학년/이름 자동 입력
      const userStr = sessionStorage.getItem('user');
      if (userStr) {
        const user = JSON.parse(userStr);
        document.getElementById('reportGrade').value = user.grade || '';
        document.getElementById('reportName').value = user.name || '';
      }

      // localStorage에서 임시 저장된 내용 불러오기
      loadDraft();

      // 히스토리 로드
      await loadReadingHistory();

      // 자동 저장 시작
      startAutoSave();
    }

    // 독서 감상문 모달 닫기
    function closeReadingReportModal() {
      const modal = document.getElementById('readingReportModal');
      modal.classList.remove('show');

      // 자동 저장 중지
      stopAutoSave();
    }

    // 독서 감상문 모달 열기 (이야기별 바로가기 버튼용)
    async function openBookReportModal(storyType) {
      // 기존 openReadingReportModal 호출
      await openReadingReportModal();

      // 스토리 드롭다운에서 해당 이야기 선택
      const storyDropdown = document.getElementById('reportStory');
      if (storyDropdown && storyType) {
        // 스토리 타입에 따른 value 매칭
        const storyMap = {
          'whale': 'whale_season1',
          'jungle': 'jungle_season1',
          'library': 'library_season1',
          'timeLibrary': 'time_library_season1',
          'catIsland': 'cat_island_season1',
          'catTransform': 'cat_transform_season1'
        };

        const selectedValue = storyMap[storyType];
        if (selectedValue) {
          // 약간의 딜레이 후 선택 (드롭다운 초기화 완료 대기)
          setTimeout(() => {
            storyDropdown.value = selectedValue;
          }, 100);
        }
      }
    }

    // 이번 달 제출 개수 확인
    async function getMonthlyReportCount() {
      try {
        const userStr = sessionStorage.getItem('user');
        if (!userStr) return 0;

        const user = JSON.parse(userStr);
        const response = await fetch(
          `/api/user-progress/reading-reports/monthly-count?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`
        );

        const result = await response.json();
        return result.ok ? result.count : 0;
      } catch (error) {
        console.error('월간 제출 개수 확인 오류:', error);
        return 0;
      }
    }

    // 히스토리 로드
    async function loadReadingHistory(showAll = false) {
      try {
        const userStr = sessionStorage.getItem('user');
        if (!userStr) return;

        const user = JSON.parse(userStr);
        const response = await fetch(
          `/api/user-progress/reading-reports/history?grade=${encodeURIComponent(user.grade)}&name=${encodeURIComponent(user.name)}`
        );

        const result = await response.json();
        if (!result.ok) return;

        const historyList = document.getElementById('readingHistoryList');
        historyList.innerHTML = '';

        const reports = result.reports || [];
        const limit = showAll ? reports.length : historyDisplayLimit;
        const displayReports = reports.slice(0, limit);

        // 리포트 항목 렌더링
        displayReports.forEach(report => {
          const item = document.createElement('div');
          item.className = 'history-item';

          const date = new Date(report.submittedAt);
          const dateStr = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
          const monthStr = `${date.getFullYear()}년 ${date.getMonth() + 1}월`;

          // 스토리 정보 가져오기 (기본값: 시즌1)
          const storyId = report.storyId || 'whale_island';
          const storyInfo = report.storyTitle || '푸른 고래섬의 비밀 모험단 시즌 1: 푸른 고래섬 탐험';

          console.log('📚 Report:', report.title, '| storyId:', storyId, '| storyTitle:', storyInfo);

          item.innerHTML = `
            <div class="history-item-title">${report.title}</div>
            <div class="history-item-date">${dateStr}</div>
            <div class="history-item-month">${monthStr}</div>
            <div class="history-item-story">${storyInfo}</div>
          `;

          // 클릭 시 해당 리포트 로드
          item.addEventListener('click', () => loadReport(report));

          historyList.appendChild(item);
        });

        // "더보기" 버튼 추가
        if (!showAll && reports.length > historyDisplayLimit) {
          const loadMoreBtn = document.createElement('button');
          loadMoreBtn.className = 'history-load-more';
          loadMoreBtn.textContent = `더보기 (${reports.length - historyDisplayLimit}개 더)`;
          loadMoreBtn.onclick = () => loadReadingHistory(true);
          historyList.appendChild(loadMoreBtn);
        }
      } catch (error) {
        console.error('히스토리 로드 오류:', error);
      }
    }

    // 리포트 로드 (편집/재공유용)
    function loadReport(report) {
      document.getElementById('reportStory').value = report.storyId || 'whale_island';
      document.getElementById('reportTitle').value = report.title;
      document.getElementById('reportContent').value = report.content;
      currentEditingReport = report._id;
    }

    // localStorage 임시 저장
    function saveDraft() {
      const userStr = sessionStorage.getItem('user');
      if (!userStr) return;

      const user = JSON.parse(userStr);
      const draft = {
        title: document.getElementById('reportTitle').value,
        content: document.getElementById('reportContent').value,
        timestamp: new Date().toISOString()
      };

      const key = `readingReportDraft_${user.grade}_${user.name}`;
      localStorage.setItem(key, JSON.stringify(draft));

      // 자동 저장 표시
      const indicator = document.getElementById('autoSaveIndicator');
      indicator.textContent = '✓ 자동 저장됨';
      setTimeout(() => {
        indicator.textContent = '';
      }, 2000);
    }

    // localStorage에서 임시 저장 불러오기
    function loadDraft() {
      const userStr = sessionStorage.getItem('user');
      if (!userStr) return;

      const user = JSON.parse(userStr);
      const key = `readingReportDraft_${user.grade}_${user.name}`;
      const draftStr = localStorage.getItem(key);

      if (draftStr) {
        const draft = JSON.parse(draftStr);
        document.getElementById('reportTitle').value = draft.title || '';
        document.getElementById('reportContent').value = draft.content || '';
      }
    }

    // 자동 저장 시작
    function startAutoSave() {
      const titleInput = document.getElementById('reportTitle');
      const contentInput = document.getElementById('reportContent');

      titleInput.addEventListener('input', saveDraft);
      contentInput.addEventListener('input', saveDraft);
    }

    // 자동 저장 중지
    function stopAutoSave() {
      const titleInput = document.getElementById('reportTitle');
      const contentInput = document.getElementById('reportContent');

      titleInput.removeEventListener('input', saveDraft);
      contentInput.removeEventListener('input', saveDraft);
    }

    // 폼 초기화
    function clearForm() {
      if (!confirm('작성 중인 내용을 지우고 새로 작성하시겠습니까?')) {
        return;
      }

      document.getElementById('reportStory').value = '';
      document.getElementById('reportTitle').value = '';
      document.getElementById('reportContent').value = '';
      currentEditingReport = null;

      // localStorage 임시 저장도 삭제
      const userStr = sessionStorage.getItem('user');
      if (userStr) {
        const user = JSON.parse(userStr);
        const key = `readingReportDraft_${user.grade}_${user.name}`;
        localStorage.removeItem(key);
      }
    }

    // PDF 다운로드 (html2canvas 사용하여 한글 지원)
    async function downloadPDF() {
      const storySelect = document.getElementById('reportStory');
      const title = document.getElementById('reportTitle').value.trim();
      const content = document.getElementById('reportContent').value.trim();

      if (!storySelect.value) {
        alert('이야기를 선택해주세요.');
        return;
      }

      if (!title || !content) {
        alert('제목과 내용을 모두 입력해주세요.');
        return;
      }

      // 맞춤법 검사 먼저 수행
      await checkSpelling(content);
      return; // 맞춤법 검사 모달에서 "제출하기" 버튼을 누르면 submitFinal()이 호출됩니다
    }

    // 맞춤법 검사 후 실제 제출 함수
    async function submitFinal() {
      const storySelect = document.getElementById('reportStory');
      const title = document.getElementById('reportTitle').value.trim();
      const content = document.getElementById('reportContent').value.trim();

      // 유효성 검사
      if (!storySelect.value) {
        alert('이야기를 선택해주세요.');
        return;
      }

      if (!title || !content) {
        alert('제목과 내용을 모두 입력해주세요.');
        return;
      }

      const selectedOption = storySelect.options[storySelect.selectedIndex];
      const storyId = storySelect.value;
      const storyTitle = selectedOption.getAttribute('data-title');

      const userStr = sessionStorage.getItem('user');
      if (!userStr) {
        alert('로그인 정보를 확인할 수 없습니다.');
        return;
      }

      const user = JSON.parse(userStr);
      const today = new Date();
      const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      // 맞춤법 검사 인라인 닫기
      closeSpellCheckInline();

      // 임시 PDF 템플릿 생성
      const pdfTemplate = document.createElement('div');
      pdfTemplate.style.cssText = `
        width: 794px;
        min-height: 1123px;
        background: #fcfaf5;
        padding: 60px;
        font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
        position: absolute;
        left: -9999px;
        top: 0;
      `;

      pdfTemplate.innerHTML = `
        <div style="text-align: center; margin-bottom: 40px;">
          <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/rudolph.png" style="width: 80px; height: 80px; margin-bottom: 20px;" crossorigin="anonymous">
          <h1 style="font-size: 32px; color: #2c3e50; margin: 0 0 10px 0;">고래 도서관 독서 감상문</h1>
          <p style="font-size: 18px; color: #6b7280; margin: 0;">${user.grade} ${user.name}</p>
          <p style="font-size: 14px; color: #9ca3af; margin: 5px 0 0 0;">${dateStr}</p>
        </div>

        <div style="margin-bottom: 30px;">
          <h2 style="font-size: 24px; color: #2c3e50; text-align: center; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">${title}</h2>
        </div>

        <div style="background: white; padding: 30px; border-radius: 10px; position: relative; min-height: 600px;">
          <!-- 원고지 선 -->
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;">
            ${Array.from({length: 40}, (_, i) => `<div style="position: absolute; left: 30px; right: 30px; top: ${30 + i * 20}px; height: 1px; background: #e9ecef;"></div>`).join('')}
          </div>

          <!-- 내용 -->
          <div style="position: relative; z-index: 1; line-height: 2; font-size: 16px; color: #2c3e50; white-space: pre-wrap; word-wrap: break-word;">
${content}
          </div>

          <!-- 워터마크 -->
          <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/rudolph.png" style="position: absolute; bottom: 50px; right: 50px; width: 200px; height: 200px; opacity: 0.05; z-index: 0;" crossorigin="anonymous">
        </div>
      `;

      document.body.appendChild(pdfTemplate);

      try {
        // html2canvas로 이미지 생성
        const canvas = await html2canvas(pdfTemplate, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#fcfaf5'
        });

        // PDF 생성
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = 210;
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

        // 파일명 생성 및 저장
        const filename = `고래도서관_감상문_${user.name}_${dateStr}.pdf`;
        pdf.save(filename);

        // 서버에 제출 기록 저장
        console.log('📝 감상문 제출 시작...');
        console.log('🔍 storyId:', storyId, '| storyTitle:', storyTitle);
        const saved = await saveReportToServer({
          grade: user.grade,
          name: user.name,
          title: title,
          content: content,
          type: 'pdf',
          storyId: storyId,
          storyTitle: storyTitle
        });

        console.log('📝 제출 결과:', saved);

        if (saved) {
          alert('감상문이 제출되었습니다!\nPDF가 다운로드되었습니다.');

          // 히스토리 새로고침
          console.log('📝 히스토리 새로고침 시작...');
          await loadReadingHistory();
          console.log('📝 히스토리 새로고침 완료');

          // 학습실 새로고침
          console.log('📝 학습실 새로고침 시작...');
          await renderStudyRoomList();
          console.log('📝 학습실 새로고침 완료');
        } else {
          alert('제출에 실패했습니다. 다시 시도해주세요.');
        }
      } catch (error) {
        console.error('PDF 생성 오류:', error);
        alert('PDF 생성 중 오류가 발생했습니다.');
      } finally {
        // 임시 요소 제거
        document.body.removeChild(pdfTemplate);
      }
    }

    // 카카오톡 공유 (이미지로 공유)
    async function shareKakao() {
      const storySelect = document.getElementById('reportStory');
      const title = document.getElementById('reportTitle').value.trim();
      const content = document.getElementById('reportContent').value.trim();

      if (!storySelect.value) {
        alert('이야기를 선택해주세요.');
        return;
      }

      if (!title || !content) {
        alert('제목과 내용을 모두 입력해주세요.');
        return;
      }

      const selectedOption = storySelect.options[storySelect.selectedIndex];
      const storyId = storySelect.value;
      const storyTitle = selectedOption.getAttribute('data-title');

      const userStr = sessionStorage.getItem('user');
      if (!userStr) {
        alert('로그인 정보를 확인할 수 없습니다.');
        return;
      }

      const user = JSON.parse(userStr);
      const today = new Date();
      const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      // 임시 이미지 템플릿 생성 (PDF와 동일)
      const imageTemplate = document.createElement('div');
      imageTemplate.style.cssText = `
        width: 794px;
        min-height: 1123px;
        background: #fcfaf5;
        padding: 60px;
        font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
        position: absolute;
        left: -9999px;
        top: 0;
      `;

      imageTemplate.innerHTML = `
        <div style="text-align: center; margin-bottom: 40px;">
          <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/rudolph.png" style="width: 80px; height: 80px; margin-bottom: 20px;" crossorigin="anonymous">
          <h1 style="font-size: 32px; color: #2c3e50; margin: 0 0 10px 0;">고래 도서관 독서 감상문</h1>
          <p style="font-size: 18px; color: #6b7280; margin: 0;">${user.grade} ${user.name}</p>
          <p style="font-size: 14px; color: #9ca3af; margin: 5px 0 0 0;">${dateStr}</p>
        </div>

        <div style="margin-bottom: 30px;">
          <h2 style="font-size: 24px; color: #2c3e50; text-align: center; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">${title}</h2>
        </div>

        <div style="background: white; padding: 30px; border-radius: 10px; position: relative; min-height: 600px;">
          <!-- 원고지 선 -->
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;">
            ${Array.from({length: 40}, (_, i) => `<div style="position: absolute; left: 30px; right: 30px; top: ${30 + i * 20}px; height: 1px; background: #e9ecef;"></div>`).join('')}
          </div>

          <!-- 내용 -->
          <div style="position: relative; z-index: 1; line-height: 2; font-size: 16px; color: #2c3e50; white-space: pre-wrap; word-wrap: break-word;">
${content}
          </div>

          <!-- 워터마크 -->
          <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/rudolph.png" style="position: absolute; bottom: 50px; right: 50px; width: 200px; height: 200px; opacity: 0.05; z-index: 0;" crossorigin="anonymous">
        </div>
      `;

      document.body.appendChild(imageTemplate);

      try {
        // html2canvas로 이미지 생성
        const canvas = await html2canvas(imageTemplate, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#fcfaf5'
        });

        // 이미지를 Blob으로 변환
        canvas.toBlob(async (blob) => {
          // 임시 요소 제거
          document.body.removeChild(imageTemplate);

          if (!blob) {
            alert('이미지 생성에 실패했습니다.');
            return;
          }

          // 이미지를 서버에 업로드 (임시 저장소)
          const formData = new FormData();
          formData.append('image', blob, `reading-report-${user.name}-${Date.now()}.png`);

          try {
            const uploadResponse = await fetch('/api/upload-temp-image', {
              method: 'POST',
              body: formData
            });

            if (!uploadResponse.ok) {
              throw new Error('이미지 업로드 실패');
            }

            const { imageUrl } = await uploadResponse.json();

            // 카카오톡으로 이미지 공유 (이미지만 공유, 링크 없음)
            if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
              Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                  title: `📖 ${title}`,
                  description: `${user.name}님의 독서 감상문`,
                  imageUrl: imageUrl,
                  link: {
                    mobileWebUrl: imageUrl,
                    webUrl: imageUrl
                  }
                }
              });
              console.log('✅ 카카오톡 이미지 공유 성공');

              // 서버에 제출 기록 저장
              console.log('📝 감상문 제출 시작...');
              const saved = await saveReportToServer({
                grade: user.grade,
                name: user.name,
                title: title,
                content: content,
                type: 'kakao',
                storyId: storyId,
                storyTitle: storyTitle
              });

              console.log('📝 제출 결과:', saved);

              if (saved) {
                alert('카카오톡으로 감상문 이미지가 공유되었습니다!');

                // 히스토리 새로고침
                console.log('📝 히스토리 새로고침 시작...');
                await loadReadingHistory();
                console.log('📝 히스토리 새로고침 완료');

                // 학습실 새로고침
                console.log('📝 학습실 새로고침 시작...');
                await renderStudyRoomList();
                console.log('📝 학습실 새로고침 완료');
              } else {
                alert('카카오톡 공유는 성공했으나 제출 기록 저장에 실패했습니다.');
              }
            } else {
              // Fallback: 이미지 다운로드
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = `고래도서관_감상문_${user.name}_${dateStr}.png`;
              link.click();
              alert('카카오톡 SDK를 찾을 수 없어 이미지를 다운로드했습니다.');
            }
          } catch (uploadError) {
            console.error('이미지 업로드 오류:', uploadError);
            // Fallback: 이미지 다운로드
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `고래도서관_감상문_${user.name}_${dateStr}.png`;
            link.click();
            alert('서버 업로드에 실패하여 이미지를 다운로드했습니다.');
          }
        }, 'image/png');

      } catch (error) {
        console.error('이미지 생성 오류:', error);
        document.body.removeChild(imageTemplate);
        alert('이미지 생성 중 오류가 발생했습니다.');
      }
    }

    // 서버에 리포트 저장
    async function saveReportToServer(data) {
      try {
        console.log('📤 서버에 리포트 전송 중...', data);

        const response = await fetch('/api/user-progress/reading-reports/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        console.log('📥 서버 응답 상태:', response.status);

        const result = await response.json();
        console.log('📥 서버 응답 결과:', result);

        if (result.ok) {
          console.log('✅ 독서 감상문 제출 완료');

          // localStorage 임시 저장 삭제
          const key = `readingReportDraft_${data.grade}_${data.name}`;
          localStorage.removeItem(key);
          console.log('🗑️ localStorage 임시 저장 삭제:', key);

          return true;
        } else {
          console.error('❌ 서버 제출 실패:', result.message);
          return false;
        }
      } catch (error) {
        console.error('❌ 리포트 저장 오류:', error);
        return false;
      }
    }

    // 맞춤법 검사 버튼용 함수 (자동 제출 없이 결과만 표시)
    async function checkSpellingOnly() {
      const content = document.getElementById('reportContent').value.trim();

      if (!content) {
        alert('내용을 입력해주세요.');
        return;
      }

      const loadingDiv = document.getElementById('spellCheckLoading');
      const inlineContainer = document.getElementById('spellCheckInline');

      try {
        console.log('🔍 맞춤법 검사 시작...');

        // 기존 결과 숨기기
        inlineContainer.style.display = 'none';

        // 로딩 표시
        loadingDiv.style.display = 'block';

        const response = await fetch('/api/spell-check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: content })
        });

        const result = await response.json();
        console.log('✅ 맞춤법 검사 완료:', result);

        // 로딩 숨기기
        loadingDiv.style.display = 'none';

        // 결과 인라인 표시 (자동 제출 없이)
        showSpellCheckResultOnly(result);
      } catch (error) {
        console.error('❌ 맞춤법 검사 오류:', error);

        // 로딩 숨기기
        loadingDiv.style.display = 'none';

        alert('맞춤법 검사 중 오류가 발생했습니다.');
      }
    }

    // 맞춤법 검사 결과 표시 (자동 제출 없음)
    function showSpellCheckResultOnly(result) {
      const inlineContainer = document.getElementById('spellCheckInline');

      inlineContainer.innerHTML = '';

      if (result.errata_count === 0) {
        // 오류 없음
        inlineContainer.innerHTML = `
          <div class="no-error-message">
            ✅ 맞춤법 및 띄어쓰기 오류가 발견되지 않았습니다!
          </div>
        `;
      } else {
        // 오류 발견
        let errorsHTML = `
          <div class="error-section">
            <h4>맞춤법/띄어쓰기 오류 ${result.errata_count}개 발견</h4>
        `;

        if (result.errors && result.errors.length > 0) {
          result.errors.forEach((error, index) => {
            errorsHTML += `
              <div class="error-item">
                예시 ${index + 1}) <span class="wrong-text">${error.wrong}</span> → <strong>${error.correct}</strong>
              </div>
            `;
          });
        }

        errorsHTML += `</div>`;

        let correctHTML = `
          <div class="correct-section">
            <h4>✓ 올바른 맞춤법</h4>
            <div class="correct-text">${result.corrected_html || result.notag_html}</div>
          </div>
        `;

        inlineContainer.innerHTML = errorsHTML + correctHTML;
      }

      // 인라인 컨테이너 표시
      inlineContainer.style.display = 'block';

      // 스크롤하여 결과 보여주기
      setTimeout(() => {
        inlineContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }

    // 맞춤법 검사 인라인 닫기
    function closeSpellCheckInline() {
      const inlineContainer = document.getElementById('spellCheckInline');
      inlineContainer.style.display = 'none';
    }
  </script>

  <!-- 레이더 차트 아이콘 -->
  <div class="radar-chart-icon" id="radarChartIcon" title="나의 학습 분석 보기">
    <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/total-radar-chart-v2.png" alt="학습 분석 레이더 차트">
    <div class="radar-grade-badge" id="radarGradeBadge">-</div>
  </div>

  <!-- 노트 아이콘 -->
  <div class="note-icon" id="noteIcon" title="학습 노트">
    <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/note-icon-v2.png" alt="학습 노트">
    <div class="vocab-avg-badge" id="vocabAvgBadge">0</div>
  </div>

  <!-- 학습 분석 모달 -->
  <div class="learning-modal" id="learningModal">
    <div class="learning-modal-content">
      <div class="learning-modal-header">
        <div class="learning-modal-title">나의 학습 분석</div>
        <button class="learning-modal-close" id="closeLearningModal">&times;</button>
      </div>
      <iframe class="learning-modal-iframe" id="learningIframe"></iframe>
      <div class="learning-modal-footer">
        <button class="learning-action-btn send-btn" id="sendLearningBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
          </svg>
          이메일 전송
        </button>
        <button class="learning-action-btn kakao-btn" id="kakaoShareBtn" style="background: linear-gradient(135deg, #FEE500 0%, #FFCD00 100%); color: #3C1E1E;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3C6.5 3 2 6.6 2 11c0 2.8 1.9 5.3 4.7 6.7-.2.8-.7 2.8-.8 3.2-.1.5.2.5.4.4.3-.1 3.5-2.3 4-2.7.5.1 1 .1 1.7.1 5.5 0 10-3.6 10-8S17.5 3 12 3z"/>
          </svg>
          카카오톡 전송
        </button>
        <button class="learning-action-btn download-btn" id="downloadLearningBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
          </svg>
          다운로드
        </button>
      </div>
    </div>
  </div>

  <!-- 단원 학습 모달 -->
  <div class="unit-modal" id="unitModal">
    <div class="unit-modal-content">
      <div class="unit-modal-header">
        <button class="unit-modal-close" id="closeUnitModal">&times;</button>
      </div>
      <iframe class="unit-modal-iframe" id="unitIframe"></iframe>
    </div>
  </div>

  <!-- AI 챗봇 플로팅 버튼 -->
  <div class="ai-chatbot-floating-btn" id="aiChatbotBtn">
    <div class="ai-chatbot-speech-bubble">...</div>
    <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/whale-ai-teacher-v2.png" alt="AI 국어 챗봇">
  </div>

  <!-- AI 챗봇 모달 -->
  <div class="ai-chatbot-modal" id="aiChatbotModal">
    <div class="ai-chatbot-modal-content">
      <div class="ai-chatbot-modal-header">
        <button class="ai-chatbot-modal-close" id="closeAiChatbotModal">&times;</button>
      </div>
      <iframe class="ai-chatbot-modal-iframe" id="aiChatbotIframe"></iframe>
    </div>
  </div>

  <!-- 어휘력 퀴즈쇼 모달 -->
  <div class="vocab-quiz-modal" id="vocabQuizModal">
    <div class="vocab-quiz-modal-content">
      <div class="vocab-quiz-modal-header">
        <button class="vocab-quiz-modal-close" id="closeVocabModal">&times;</button>
      </div>
      <iframe class="vocab-quiz-modal-iframe" id="vocabQuizIframe"></iframe>
    </div>
  </div>

  <!-- 학습실 아이콘 (좌측 하단) -->
  <div class="study-room-icon" id="studyRoomIcon">
    <img src="https://cdn.jsdelivr.net/gh/kukicoollevitt-hash/dan-dan-app@main/public/images/student-study-room.png" alt="학습실">
    <div class="study-room-badge" id="studyRoomBadge">0/1</div>
  </div>

  <!-- 학습실 모달 -->
  <div class="study-room-modal" id="studyRoomModal">
    <div class="study-room-modal-content">
      <div class="study-room-modal-header">
        <div style="display: flex; align-items: center;">
          <h2>📚 나의 학습실</h2>
          <div class="auto-task-dropdown-wrapper">
            <button class="auto-task-btn" id="autoTaskBtn" onclick="toggleAutoTaskDropdown(event)">
              ⚙️ 자동과제부여 <span class="arrow">▼</span>
            </button>
            <div class="auto-task-dropdown" id="autoTaskDropdown">
              <div class="auto-task-dropdown-header">🤖 자동과제부여 설정</div>
              <div class="auto-task-dropdown-body">
                <!-- 시리즈 선택 -->
                <div class="auto-task-section">
                  <div class="auto-task-section-title">📚 시리즈 선택</div>
                  <div class="auto-task-btn-group" id="seriesBtnGroup">
                    <button class="series-btn" data-series="on" disabled>BRIAN온</button>
                    <button class="series-btn" data-series="up">BRIAN업</button>
                    <button class="series-btn" data-series="fit">BRIAN핏</button>
                    <button class="series-btn" data-series="deep" disabled>BRIAN딥</button>
                  </div>
                </div>

                <!-- 요일 선택 -->
                <div class="auto-task-section">
                  <div class="auto-task-section-title">📅 요일 선택</div>
                  <div class="auto-task-btn-group" id="dayBtnGroup">
                    <button class="day-btn" data-day="everyday">매일</button>
                    <button class="day-btn" data-day="1">월</button>
                    <button class="day-btn" data-day="2">화</button>
                    <button class="day-btn" data-day="3">수</button>
                    <button class="day-btn" data-day="4">목</button>
                    <button class="day-btn" data-day="5">금</button>
                    <button class="day-btn" data-day="6">토</button>
                    <button class="day-btn" data-day="0">일</button>
                  </div>
                </div>

                <!-- 과제 개수 -->
                <div class="auto-task-section">
                  <div class="auto-task-section-title">🎯 랜덤과제개수</div>
                  <div class="task-count-input">
                    <input type="number" id="autoTaskCount" min="1" max="15" value="1">
                    <span>개 (최소 1개 ~ 최대 15개)</span>
                  </div>
                </div>

                <!-- 액션 버튼 -->
                <div class="auto-task-actions">
                  <button class="auto-task-action-btn start" id="autoTaskStartBtn" onclick="startAutoTask()">
                    시작
                  </button>
                  <button class="auto-task-action-btn pause" id="autoTaskPauseBtn" onclick="pauseAutoTask()" disabled>
                    일시정지
                  </button>
                  <button class="auto-task-action-btn stop" id="autoTaskStopBtn" onclick="stopAutoTask()" disabled>
                    중단
                  </button>
                </div>

                <!-- 상태 표시 -->
                <div class="auto-task-status stopped" id="autoTaskStatus">
                  ⏹️ 자동과제부여가 비활성화 상태입니다
                </div>
              </div>
            </div>
          </div>
        </div>
        <button class="study-room-modal-close" id="closeStudyRoomModal" onclick="closeStudyRoomModal()">&times;</button>
      </div>
      <div class="study-room-modal-body">
        <ul class="study-room-list" id="studyRoomList">
          <!-- 과제 목록이 여기에 렌더링됩니다 -->
        </ul>
      </div>
    </div>
  </div>

  <!-- 관리자 비밀번호 입력 모달 -->
  <div class="overlay" id="adminPasswordOverlay">
    <div class="password-modal">
      <div class="password-modal-header">
        <h3>🔒 관리자 인증</h3>
      </div>
      <div class="password-modal-body">
        <p>과제를 삭제하려면 관리자 비밀번호를 입력하세요</p>
        <input type="password" id="adminPasswordInput" placeholder="비밀번호 입력" maxlength="4">
      </div>
      <div class="password-modal-footer">
        <button class="btn-cancel" id="cancelPasswordBtn">취소</button>
        <button class="btn-confirm" id="confirmPasswordBtn">확인</button>
      </div>
    </div>
  </div>

  <!-- 과제 추가 확인 팝업 -->
  <div class="overlay" id="assignTaskOverlay">
    <div class="assign-modal">
      <div class="assign-modal-header">
        <h3>📝 과제 추가</h3>
      </div>
      <div class="assign-modal-body">
        <p id="assignTaskMessage">이 과제를 학습실에 추가하시겠습니까?</p>
      </div>
      <div class="assign-modal-footer">
        <button class="btn-cancel" id="cancelAssignBtn">취소</button>
        <button class="btn-confirm" id="confirmAssignBtn">추가하기</button>
      </div>
    </div>
  </div>

  <!-- 삭제 최종 확인 팝업 -->
  <div class="overlay" id="deleteConfirmOverlay">
    <div class="assign-modal">
      <div class="assign-modal-header">
        <h3>⚠️ 삭제 확인</h3>
      </div>
      <div class="assign-modal-body">
        <p>삭제 후 복구가 안됩니다.<br>정말 삭제하시겠습니까?</p>
      </div>
      <div class="assign-modal-footer">
        <button class="btn-cancel" id="cancelDeleteBtn">취소</button>
        <button class="btn-confirm" id="confirmDeleteBtn">삭제하기</button>
      </div>
    </div>
  </div>

  <!-- 준비 중 팝업 -->
  <div class="overlay" id="comingSoonOverlay">
    <div class="assign-modal">
      <div class="assign-modal-header">
        <h3>📚✨ 아직 준비 중입니다</h3>
      </div>
      <div class="assign-modal-body">
        <p>곧 지문이 오픈됩니다. 기대해주세요!</p>
      </div>
      <div class="assign-modal-footer">
        <button class="btn-confirm" id="closeComingSoonBtn">확인</button>
      </div>
    </div>
  </div>

  <!-- 오류 메시지 팝업 -->
  <div class="overlay" id="errorMessageOverlay">
    <div class="assign-modal">
      <div class="assign-modal-header">
        <h3><span id="errorEmoji">🚫</span> <span id="errorTitle">오류</span></h3>
      </div>
      <div class="assign-modal-body">
        <p id="errorMsg">오류가 발생했습니다.</p>
      </div>
      <div class="assign-modal-footer">
        <button class="btn-confirm" id="closeErrorBtn">확인</button>
      </div>
    </div>
  </div>

  <!-- 고래섬 이야기 팝업 모달 -->
  <div class="whale-story-modal" id="whaleStoryModal">
    <div class="whale-story-modal-content">
      <button class="whale-story-modal-close" id="closeWhaleStoryModal" onclick="closeWhaleStoryModal()" type="button">&times;</button>

      <!-- Carousel Navigation Arrows -->
      <button class="carousel-nav prev" id="carouselPrev" onclick="moveCarousel(-1)" type="button">‹</button>
      <button class="carousel-nav next" id="carouselNext" onclick="moveCarousel(1)" type="button">›</button>

      <!-- Carousel Wrapper -->
      <div class="story-carousel-wrapper">
        <div class="story-carousel-container" id="storyCarousel">

          <!-- Slide 1: Whale Island Story -->
          <div class="story-slide whale-story">
            <div class="whale-story-header">
              <h2>🐋 푸른 고래섬의 비밀 모험단</h2>
              <p>어떤 시즌으로 모험을 떠나시겠습니까?</p>
            </div>

            <div class="whale-story-seasons">
              <!-- 시즌 1 -->
              <div class="season-card" onclick="goToSeason('whale', 1)">
                <div class="season-number">🏝️</div>
                <div class="season-title">시즌 1</div>
                <div class="season-subtitle">푸른 고래섬 탐험</div>
                <div class="season-desc">신비로운 섬에서 시작되는 첫 번째 모험</div>
              </div>

              <!-- 시즌 2 -->
              <div class="season-card" onclick="goToSeason('whale', 2)">
                <div class="season-number">🌊</div>
                <div class="season-title">시즌 2</div>
                <div class="season-subtitle">파도 골짜기의 비밀</div>
                <div class="season-desc">고래 왕국의 기억을 되찾는 여정</div>
              </div>

              <!-- 시즌 3 -->
              <div class="season-card" onclick="goToSeason('whale', 3)">
                <div class="season-number">✨</div>
                <div class="season-title">시즌 3</div>
                <div class="season-subtitle">빛의 기억</div>
                <div class="season-desc">기억의 수호자가 되는 마지막 모험</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('whale')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 2: Jungle Story -->
          <div class="story-slide jungle-story">
            <div class="whale-story-header">
              <h2>🌿 깊은 정글의 잊힌 도시</h2>
              <p>어떤 시즌으로 모험을 떠나시겠습니까?</p>
            </div>

            <div class="whale-story-seasons">
              <!-- 시즌 1 -->
              <div class="season-card" onclick="goToSeason('jungle', 1)">
                <div class="season-number">🏝️</div>
                <div class="season-title">시즌 1</div>
                <div class="season-subtitle">잊힌 도시 발견</div>
                <div class="season-desc">신비로운 정글에서 시작되는 첫 번째 모험</div>
              </div>

              <!-- 시즌 2 -->
              <div class="season-card" onclick="goToSeason('jungle', 2)">
                <div class="season-number">🌿</div>
                <div class="season-title">시즌 2</div>
                <div class="season-subtitle">도시의 균형 회복</div>
                <div class="season-desc">고대 장치의 비밀을 푸는 여정</div>
              </div>

              <!-- 시즌 3 -->
              <div class="season-card" onclick="goToSeason('jungle', 3)">
                <div class="season-number">🐉</div>
                <div class="season-title">시즌 3</div>
                <div class="season-subtitle">암녹림의 수호자</div>
                <div class="season-desc">정글의 진정한 균형을 지키는 마지막 모험</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('jungle')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 3: Library Story -->
          <div class="story-slide library-story">
            <div class="whale-story-header">
              <h2>📚 살아 있는 신비의 도서관</h2>
              <p>어떤 시즌으로 모험을 떠나시겠습니까?</p>
            </div>

            <div class="whale-story-seasons">
              <!-- 시즌 1 -->
              <div class="season-card" onclick="goToSeason('library', 1)">
                <div class="season-number">🏛️</div>
                <div class="season-title">시즌 1</div>
                <div class="season-subtitle">신비한 도서관의 발견</div>
                <div class="season-desc">지혜와 용기로 가득한 도서관 여정의 시작</div>
              </div>

              <!-- 시즌 2 -->
              <div class="season-card" onclick="goToSeason('library', 2)">
                <div class="season-number">🔐</div>
                <div class="season-title">시즌 2</div>
                <div class="season-subtitle">금지된 서고의 비밀</div>
                <div class="season-desc">빛과 어둠의 균형을 찾는 모험</div>
              </div>

              <!-- 시즌 3 -->
              <div class="season-card" onclick="goToSeason('library', 3)">
                <div class="season-number">⏳</div>
                <div class="season-title">시즌 3</div>
                <div class="season-subtitle">시간 여행자의 도서관</div>
                <div class="season-desc">파괴와 마법을 넘나드는 대 모험</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('library')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 4: Time Library Story -->
          <div class="story-slide time-library-story">
            <div class="whale-story-header">
              <h2>⏰ 시간도서관</h2>
              <p>어떤 시즌으로 모험을 떠나시겠습니까?</p>
            </div>

            <div class="whale-story-seasons">
              <!-- 시즌 1 -->
              <div class="season-card" onclick="goToSeason('timeLibrary', 1)">
                <div class="season-number">🕰️</div>
                <div class="season-title">시즌 1</div>
                <div class="season-subtitle">과거의 문을 열다</div>
                <div class="season-desc">잊힌 시대의 수호자들</div>
              </div>

              <!-- 시즌 2 -->
              <div class="season-card" onclick="goToSeason('timeLibrary', 2)">
                <div class="season-number">⚡</div>
                <div class="season-title">시즌 2</div>
                <div class="season-subtitle">현재의 균열</div>
                <div class="season-desc">시간이 뒤틀린 도서관</div>
              </div>

              <!-- 시즌 3 -->
              <div class="season-card" onclick="goToSeason('timeLibrary', 3)">
                <div class="season-number">💫</div>
                <div class="season-title">시즌 3</div>
                <div class="season-subtitle">미래의 심장</div>
                <div class="season-desc">시간을 지키는 마지막 아이들</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('timeLibrary')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 5: Cat Island Story -->
          <div class="story-slide cat-island-story">
            <div class="whale-story-header">
              <h2>🐱 미지의 고양이 섬 표류기</h2>
              <p>어떤 시즌으로 모험을 떠나시겠습니까?</p>
            </div>

            <div class="whale-story-seasons">
              <!-- 시즌 1 -->
              <div class="season-card" onclick="goToSeason('catIsland', 1)">
                <div class="season-number">🌊</div>
                <div class="season-title">시즌 1</div>
                <div class="season-subtitle">바람이 데려온 섬</div>
                <div class="season-desc">말하는 고양이들의 신비한 섬</div>
              </div>

              <!-- 시즌 2 -->
              <div class="season-card" onclick="goToSeason('catIsland', 2)">
                <div class="season-number">🌪️</div>
                <div class="season-title">시즌 2</div>
                <div class="season-subtitle">바람고양이들의 숨겨진 날개</div>
                <div class="season-desc">잃어버린 고양이들을 찾아서</div>
              </div>

              <!-- 시즌 3 -->
              <div class="season-card" onclick="goToSeason('catIsland', 3)">
                <div class="season-number">💖</div>
                <div class="season-title">시즌 3</div>
                <div class="season-subtitle">마음의 왕국과 감정의 불꽃</div>
                <div class="season-desc">잠든 왕국을 깨우는 마지막 모험</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('catIsland')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 6: Cat Transform Story -->
          <div class="story-slide cat-transform-story">
            <div class="whale-story-header">
              <h2>🐈 고양이가 되어버린 날</h2>
              <p>어떤 시즌으로 모험을 떠나시겠습니까?</p>
            </div>

            <div class="whale-story-seasons">
              <!-- 시즌 1 -->
              <div class="season-card" onclick="goToSeason('catTransform', 1)">
                <div class="season-number">💫</div>
                <div class="season-title">시즌 1</div>
                <div class="season-subtitle">고양이의 눈으로 본 첫 세계</div>
                <div class="season-desc">낯설지만 아름다운 새로운 삶</div>
              </div>

              <!-- 시즌 2 -->
              <div class="season-card" onclick="goToSeason('catTransform', 2)">
                <div class="season-number">🏛️</div>
                <div class="season-title">시즌 2</div>
                <div class="season-subtitle">목걸이의 비밀과 그림자 왕국</div>
                <div class="season-desc">잃어버린 왕국의 비밀이 드러난다</div>
              </div>

              <!-- 시즌 3 -->
              <div class="season-card" onclick="goToSeason('catTransform', 3)">
                <div class="season-number">⚖️</div>
                <div class="season-title">시즌 3</div>
                <div class="season-subtitle">그림자왕국의 심장</div>
                <div class="season-desc">빛과 그림자의 마지막 균형을 찾아서</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('catTransform')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 7: Sonagi Story (단독 시즌) -->
          <div class="story-slide sonagi-story">
            <div class="whale-story-header">
              <h2>🌧️ 소나기</h2>
              <p>황순원 원작 - 순수한 첫사랑 이야기</p>
            </div>

            <div class="whale-story-seasons single-season-container">
              <!-- 단독 시즌 -->
              <div class="season-card single-season" onclick="goToSeason('sonagi', 1)">
                <div class="season-number">🌾</div>
                <div class="season-title">단독 시즌</div>
                <div class="season-subtitle">10파트 구성</div>
                <div class="season-desc">소년과 소녀의 아름답고 슬픈 여름 이야기</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('sonagi')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 8: Good Day Story (운수 좋은 날 - 단독 시즌) -->
          <div class="story-slide goodday-story">
            <div class="whale-story-header">
              <h2>🌧️ 운수 좋은 날</h2>
              <p>현진건 원작 - 비극적 아이러니의 걸작</p>
            </div>

            <div class="whale-story-seasons single-season-container">
              <!-- 단독 시즌 -->
              <div class="season-card single-season" onclick="goToSeason('goodday', 1)">
                <div class="season-number">🚗</div>
                <div class="season-title">단독 시즌</div>
                <div class="season-subtitle">10파트 구성</div>
                <div class="season-desc">김첨지의 운수 좋은 날, 그러나...</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('goodday')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 9: Dongbaek Story (동백꽃 - 단독 시즌) -->
          <div class="story-slide dongbaek-story">
            <div class="whale-story-header">
              <h2>🌸 동백꽃</h2>
              <p>김유정 원작 - 순수한 시골 첫사랑 이야기</p>
            </div>

            <div class="whale-story-seasons single-season-container">
              <!-- 단독 시즌 -->
              <div class="season-card single-season" onclick="goToSeason('dongbaek', 1)">
                <div class="season-number">🐓</div>
                <div class="season-title">단독 시즌</div>
                <div class="season-subtitle">10파트 구성</div>
                <div class="season-desc">'나'와 점순이의 티격태격 첫사랑</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('dongbaek')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 10: Samdae Story (삼대 - 단독 시즌) -->
          <div class="story-slide samdae-story">
            <div class="whale-story-header">
              <h2>🏛️ 삼대</h2>
              <p>염상섭 원작 - 세 세대의 갈등과 근대화의 물결</p>
            </div>

            <div class="whale-story-seasons single-season-container">
              <!-- 단독 시즌 -->
              <div class="season-card single-season" onclick="goToSeason('samdae', 1)">
                <div class="season-number">👴</div>
                <div class="season-title">단독 시즌</div>
                <div class="season-subtitle">10파트 구성</div>
                <div class="season-desc">조의관 집안 삼대의 몰락과 희망</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('samdae')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

          <!-- Slide 11: Chunhyang Story (춘향전 - 단독 시즌) -->
          <div class="story-slide chunhyang-story">
            <div class="whale-story-header">
              <h2>🌸 춘향전</h2>
              <p>조선시대 판소리계 소설 - 신분을 초월한 사랑 이야기</p>
            </div>

            <div class="whale-story-seasons single-season-container">
              <!-- 단독 시즌 -->
              <div class="season-card single-season" onclick="goToSeason('chunhyang', 1)">
                <div class="season-number">💕</div>
                <div class="season-title">단독 시즌</div>
                <div class="season-subtitle">10파트 구성</div>
                <div class="season-desc">이몽룡과 성춘향의 사랑과 절개</div>
              </div>
            </div>

            <div class="book-report-btn-container">
              <button class="book-report-btn" onclick="openBookReportModal('chunhyang')">
                <span>독서 감상문 제출</span>
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 스토리 콘텐츠 팝업 모달 -->
  <div class="story-content-modal" id="storyContentModal">
    <div class="story-content-modal-inner">
      <button class="story-content-close" id="closeStoryContentModal" onclick="closeStoryModal()" type="button">&times;</button>
      <iframe class="story-content-iframe" id="storyContentIframe"></iframe>
    </div>
  </div>

  <!-- 독서 감상문 팝업 모달 -->
  <div class="reading-report-modal" id="readingReportModal">
    <div class="reading-report-container">
      <button class="reading-report-close" onclick="closeReadingReportModal()" type="button">&times;</button>

      <!-- 왼쪽 히스토리 사이드바 -->
      <div class="reading-history-sidebar">
        <div class="history-header">
          📚 제출 이력
        </div>
        <div class="history-list" id="readingHistoryList">
          <!-- 히스토리 항목들이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>

      <!-- 오른쪽 메인 작성 영역 -->
      <div class="reading-report-main">
        <div class="report-form-header">
          <h2>🐋 고래 도서관 독서 감상문</h2>
          <p>신나는 고래도서관 이야기를 읽고 감상문을 작성해보세요!</p>
        </div>

        <form class="report-form" id="reportForm">
          <div class="form-row">
            <div class="form-group">
              <label for="reportGrade">학년</label>
              <input type="text" id="reportGrade" disabled>
            </div>
            <div class="form-group">
              <label for="reportName">이름</label>
              <input type="text" id="reportName" disabled>
            </div>
          </div>

          <div class="form-group">
            <label for="reportStory">📚 이야기 선택</label>
            <select id="reportStory" required>
              <option value="">읽은 이야기를 선택하세요</option>
            </select>
          </div>

          <div class="form-group">
            <label for="reportTitle">제목</label>
            <input type="text" id="reportTitle" placeholder="감상문 제목을 입력하세요" required>
          </div>

          <div class="form-group" style="position: relative;">
            <label for="reportContent">내용</label>
            <textarea id="reportContent" placeholder="고래도서관 이야기를 읽고 느낀 점을 자유롭게 작성해보세요..." required></textarea>
            <button type="button" onclick="checkSpellingOnly()" style="position: absolute; right: 8px; bottom: 8px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer; opacity: 0.9;">🔍 맞춤법 검사</button>
          </div>

          <!-- 맞춤법 검사 로딩 -->
          <div class="spell-check-loading" id="spellCheckLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>맞춤법 검사 중...</p>
          </div>

          <!-- 맞춤법 검사 결과 인라인 표시 (박스 없이) -->
          <div class="spell-check-inline" id="spellCheckInline" style="display: none;">
            <!-- 맞춤법 검사 결과가 여기에 표시됩니다 -->
          </div>

          <div class="auto-save-indicator" id="autoSaveIndicator"></div>

          <div class="form-actions">
            <button type="button" class="btn-submit" onclick="submitFinal()">📄 제출하기</button>
            <button type="button" class="btn-kakao" onclick="shareKakao()">💬 카카오톡 공유</button>
            <button type="button" class="btn-new" onclick="clearForm()">🔄 새로 작성</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 맞춤법 검사 결과 모달 -->
  <div class="spell-check-modal" id="spellCheckModal">
    <div class="spell-check-modal-content">
      <div class="spell-check-header">
        <h3>맞춤법 검사 결과</h3>
        <button class="spell-check-close" onclick="closeSpellCheckModal()">&times;</button>
      </div>

      <div class="spell-check-body" id="spellCheckBody">
        <!-- 결과가 여기에 동적으로 추가됩니다 -->
      </div>

      <div class="spell-check-footer">
        <button class="btn-recheck" onclick="closeSpellCheckModal()">재점하기</button>
        <button class="btn-submit-final" onclick="submitFinal()">제출하기</button>
      </div>
    </div>
  </div>

  <!-- 🔔 공지사항 팝업 스타일 -->
  <style>
    /* 공지사항 팝업 오버레이 */
    .notice-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      animation: fadeIn 0.3s ease;
    }
    .notice-popup-overlay.active {
      display: flex;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* 공지사항 팝업 카드 */
    .notice-popup-card {
      width: min(500px, 92vw);
      max-height: 85vh;
      background: linear-gradient(145deg, #fff9f0 0%, #fff3e0 50%, #ffe8cc 100%);
      border-radius: 24px;
      box-shadow:
        0 25px 60px rgba(0, 0, 0, 0.35),
        0 0 0 1px rgba(255, 180, 100, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      overflow: hidden;
      animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* 공지사항 헤더 */
    .notice-popup-header {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .notice-popup-header .whale-icon {
      font-size: 36px;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    .notice-popup-header h2 {
      margin: 0;
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .notice-popup-header .bell-icon {
      margin-left: auto;
      font-size: 24px;
      animation: ring 1.5s ease-in-out infinite;
    }
    @keyframes ring {
      0%, 100% { transform: rotate(0); }
      10%, 30% { transform: rotate(15deg); }
      20%, 40% { transform: rotate(-15deg); }
      50% { transform: rotate(0); }
    }

    /* 공지사항 본문 */
    .notice-popup-body {
      padding: 24px;
      max-height: 50vh;
      overflow-y: auto;
    }
    .notice-item {
      display: flex;
      gap: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 14px;
      border-left: 4px solid #ff9800;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.2s ease;
    }
    .notice-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
    }
    .notice-item:last-child {
      margin-bottom: 0;
    }
    .notice-num {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(255, 152, 0, 0.4);
    }
    .notice-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.6;
      color: #4a3728;
    }
    .notice-text .highlight {
      color: #e65100;
      font-weight: 600;
    }
    .notice-text .sub-note {
      display: block;
      font-size: 12px;
      color: #8d6e5a;
      margin-top: 4px;
    }

    /* 공지사항 푸터 */
    .notice-popup-footer {
      padding: 16px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: rgba(255, 248, 240, 0.5);
      border-top: 1px solid rgba(255, 180, 100, 0.3);
    }
    .notice-checkbox-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .notice-checkbox-wrap input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #ff9800;
      cursor: pointer;
    }
    .notice-checkbox-wrap label {
      font-size: 14px;
      color: #6d5a4a;
      cursor: pointer;
      user-select: none;
    }
    .notice-confirm-btn {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
      transition: all 0.2s ease;
    }
    .notice-confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
    }
    .notice-confirm-btn:active {
      transform: translateY(0);
    }
  </style>

  <!-- 🔔 공지사항 팝업 HTML -->
  <div class="notice-popup-overlay" id="noticePopup">
    <div class="notice-popup-card">
      <div class="notice-popup-header">
        <span class="whale-icon">🐳</span>
        <h2>공지사항</h2>
        <span class="bell-icon">🔔</span>
      </div>
      <div class="notice-popup-body">
        <div class="notice-item">
          <span class="notice-num">1</span>
          <p class="notice-text">
            <span class="highlight">어휘학습</span>은 최초 1회 완료 후에 어휘력 지수가 반영됩니다!
          </p>
        </div>
        <div class="notice-item">
          <span class="notice-num">2</span>
          <p class="notice-text">
            <span class="highlight">AI고래쌤</span> 하루 고래뱃지는 매일 <span class="highlight">10뱃지</span>가 지급됩니다!
            <span class="sub-note">*추가 고래뱃지 획득은 어휘학습을 통해 가능</span>
          </p>
        </div>
        <div class="notice-item">
          <span class="notice-num">3</span>
          <p class="notice-text">
            학습실의 <span class="highlight">AI추천과제</span>는 미흡한 단원을 AI고래쌤이 확인하여 부여되는 과제입니다!
          </p>
        </div>
        <div class="notice-item">
          <span class="notice-num">4</span>
          <p class="notice-text">
            <span class="highlight">고래 독서 감상문</span>은 최소 월 1회 제출이지만 얼마든지 추가로 제출이 가능합니다!
          </p>
        </div>
        <div class="notice-item">
          <span class="notice-num">5</span>
          <p class="notice-text">
            학습실의 <span class="highlight">완료된 학습과제</span>는 선생님 확인 후 삭제가 가능합니다!
          </p>
        </div>
        <div class="notice-item">
          <span class="notice-num">6</span>
          <p class="notice-text">
            <span class="highlight">종합리포트</span>는 최신 완료된 과제 순으로 기록됩니다!
          </p>
        </div>
      </div>
      <div class="notice-popup-footer">
        <div class="notice-checkbox-wrap">
          <input type="checkbox" id="noShowToday">
          <label for="noShowToday">오늘 하루 더 이상 보지 않기</label>
        </div>
        <button class="notice-confirm-btn" onclick="closeNoticePopup()">확인</button>
      </div>
    </div>
  </div>

  <!-- 🔔 공지사항 팝업 스크립트 -->
  <script>
    // 공지사항 팝업 닫기
    function closeNoticePopup() {
      const popup = document.getElementById('noticePopup');
      const checkbox = document.getElementById('noShowToday');

      // "오늘 하루 보지 않기" 체크 시 localStorage에 저장
      if (checkbox && checkbox.checked) {
        const today = new Date().toDateString();
        localStorage.setItem('noticePopup_noShowDate', today);
      }

      // 팝업 닫기 애니메이션
      popup.style.animation = 'fadeOut 0.3s ease forwards';
      setTimeout(() => {
        popup.classList.remove('active');
        popup.style.animation = '';
      }, 300);
    }

    // 공지사항 팝업 표시 여부 확인
    function shouldShowNoticePopup() {
      const noShowDate = localStorage.getItem('noticePopup_noShowDate');
      const today = new Date().toDateString();

      // 오늘 날짜와 저장된 날짜가 같으면 표시 안함
      if (noShowDate === today) {
        return false;
      }
      return true;
    }

    // 페이지 로드 시 공지사항 팝업 표시
    document.addEventListener('DOMContentLoaded', function() {
      if (shouldShowNoticePopup()) {
        // 약간의 딜레이 후 표시 (로딩 완료 후)
        setTimeout(() => {
          const popup = document.getElementById('noticePopup');
          if (popup) {
            popup.classList.add('active');
          }
        }, 1000);
      }
    });

    // fadeOut 애니메이션 추가
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
    `;
    document.head.appendChild(styleSheet);
  </script>

  <!-- 📝 형성평가 관문 시스템 스타일 -->
  <style>
    /* 관문 팝업 오버레이 */
    .gate-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .gate-popup-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* 관문 팝업 카드 */
    .gate-popup-card {
      background: linear-gradient(135deg, #fff 0%, #faf8f6 100%);
      border-radius: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      animation: gatePopIn 0.4s ease-out;
      text-align: center;
    }
    @keyframes gatePopIn {
      from {
        opacity: 0;
        transform: scale(0.85) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* 관문 팝업 헤더 */
    .gate-popup-header {
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      padding: 24px;
      color: #fff;
    }
    .gate-popup-header .trophy-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 12px;
      animation: bounce 1s ease infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .gate-popup-header h2 {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }
    .gate-popup-header p {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }

    /* 관문 팝업 바디 */
    .gate-popup-body {
      padding: 24px;
    }
    .gate-popup-body .gate-message {
      font-size: 16px;
      color: #4a3728;
      line-height: 1.7;
      margin-bottom: 20px;
    }
    .gate-popup-body .gate-message strong {
      color: #8b2f2f;
    }
    .gate-completed-count {
      background: #fef5f5;
      border: 2px solid #8b2f2f;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .gate-completed-count .count-num {
      font-size: 36px;
      font-weight: 700;
      color: #8b2f2f;
    }
    .gate-completed-count .count-label {
      font-size: 14px;
      color: #666;
      display: block;
      margin-top: 4px;
    }

    /* 관문 팝업 버튼 */
    .gate-popup-footer {
      padding: 0 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .gate-start-btn {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(139, 47, 47, 0.4);
      transition: all 0.2s ease;
    }
    .gate-start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 47, 47, 0.5);
    }
    .gate-skip-btn {
      background: transparent;
      border: 2px solid #ddd;
      color: #888;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .gate-skip-btn:hover {
      border-color: #aaa;
      color: #666;
    }
  </style>

  <!-- 📝 형성평가 관문 팝업 HTML -->
  <div class="gate-popup-overlay" id="gatePopup">
    <div class="gate-popup-card">
      <div class="gate-popup-header">
        <span class="trophy-icon">🏆</span>
        <h2>형성평가 관문 <span id="gateLevel">1</span></h2>
        <p>10개 단원 학습 완료!</p>
      </div>
      <div class="gate-popup-body">
        <div class="gate-completed-count">
          <span class="count-num" id="gateCompletedCount">10</span>
          <span class="count-label">완료 단원</span>
        </div>
        <p class="gate-message">
          축하합니다! <strong id="gateRequiredCount">10</strong>개 단원을 모두 완료했습니다.<br><br>
          다음 단원을 학습하려면<br>
          <strong>형성평가 관문 시험</strong>을 통과해야 합니다.
        </p>
      </div>
      <div class="gate-popup-footer">
        <button class="gate-start-btn" onclick="startGateQuiz()">
          📝 형성평가 시작하기
        </button>
        <button class="gate-skip-btn" onclick="closeGatePopup()">
          나중에 하기
        </button>
      </div>
    </div>
  </div>

  <!-- 🔒 학습 잠금 모달 -->
  <style>
    .lock-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 100001;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .lock-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .lock-modal-card {
      background: linear-gradient(135deg, #fff 0%, #faf8f6 100%);
      border-radius: 24px;
      width: 90%;
      max-width: 380px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      animation: lockPopIn 0.4s ease-out;
      text-align: center;
    }
    @keyframes lockPopIn {
      from { opacity: 0; transform: scale(0.85) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .lock-modal-header {
      background: linear-gradient(135deg, #5a5a5a 0%, #3d3d3d 100%);
      padding: 24px;
      color: #fff;
    }
    .lock-modal-header .lock-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 12px;
    }
    .lock-modal-header h2 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    .lock-modal-body {
      padding: 24px;
    }
    .lock-modal-body p {
      font-size: 15px;
      color: #4a3728;
      line-height: 1.7;
      margin: 0 0 20px 0;
    }
    .lock-modal-body .gate-link {
      color: #8b2f2f;
      font-weight: 700;
      text-decoration: underline;
      cursor: pointer;
    }
    .lock-modal-footer {
      padding: 0 24px 24px;
    }
    .lock-modal-footer button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .lock-go-gate-btn {
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      color: #fff;
      margin-bottom: 10px;
    }
    .lock-go-gate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 47, 47, 0.3);
    }
    .lock-close-btn {
      background: #f0ebe5;
      color: #4a3728;
    }
    .lock-close-btn:hover {
      background: #e5ded6;
    }

    /* ===== 형성평가 관문 모달 ===== */
    .gate-quiz-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100001;
      padding: 20px;
    }
    .gate-quiz-modal.active {
      display: flex;
    }
    .gate-quiz-container {
      background: linear-gradient(145deg, #fffaf5, #fff5eb);
      border-radius: 24px;
      padding: 30px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
      animation: gateSlideIn 0.4s ease-out;
      position: relative;
    }
    @keyframes gateSlideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .gate-quiz-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 36px;
      height: 36px;
      border: none;
      background: #f5f0eb;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #8b2f2f;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .gate-quiz-close-btn:hover {
      background: #8b2f2f;
      color: #fff;
      transform: scale(1.1);
    }
    .gate-quiz-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .gate-quiz-header h1 {
      font-size: 24px;
      color: #8b2f2f;
      margin: 0 0 8px 0;
    }
    .gate-quiz-header .gate-number {
      font-size: 16px;
      color: #666;
    }
    .gate-quiz-header .gate-info {
      font-size: 13px;
      color: #999;
      margin-top: 5px;
    }
    .gate-progress-bar {
      height: 8px;
      background: #e8e0d8;
      border-radius: 4px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .gate-progress-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, #8b2f2f, #c0392b);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .gate-unit-btn {
      background: #fff8f0;
      border: 2px solid #e8d4c4;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }
    .gate-unit-btn:hover {
      background: #fff0e0;
      border-color: #d4b8a0;
    }
    .gate-unit-btn .title-text {
      font-size: 14px;
      color: #8b2f2f;
      font-weight: 600;
    }
    .gate-unit-btn .title-hint {
      font-size: 11px;
      color: #999;
      margin-left: 6px;
    }
    .gate-unit-btn .arrow {
      font-size: 12px;
      color: #8b2f2f;
      transition: transform 0.3s ease;
    }
    .gate-unit-btn.open .arrow {
      transform: rotate(180deg);
    }
    .gate-passage {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.3s ease;
      background: #fffaf5;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .gate-passage.open {
      max-height: 300px;
      padding: 16px;
      border: 1px solid #f0e0d0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .gate-passage p {
      font-size: 13px;
      color: #4a3728;
      line-height: 1.7;
      margin-bottom: 10px;
      text-align: justify;
    }
    .gate-passage p:last-child { margin-bottom: 0; }
    .gate-passage b { color: #8b2f2f; font-weight: 600; }
    .gate-question-box {
      background: #faf8f6;
      padding: 20px;
      border-radius: 14px;
      margin-bottom: 20px;
      border-left: 4px solid #8b2f2f;
    }
    .gate-question-box .question-text {
      font-size: 15px;
      color: #3b2a1a;
      font-weight: 600;
      line-height: 1.6;
    }
    .gate-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .gate-option-btn {
      background: #fff;
      border: 2px solid #e8d4c4;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 14px;
      color: #3b2a1a;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .gate-option-btn:hover {
      border-color: #d4b8a0;
      background: #fffaf5;
    }
    .gate-option-btn.selected {
      border-color: #8b2f2f;
      background: linear-gradient(135deg, #fff5f0, #fff0e8);
      color: #8b2f2f;
      font-weight: 600;
    }
    .gate-option-btn.correct {
      border-color: #27ae60;
      background: linear-gradient(135deg, #e8f8f0, #d5f5e3);
      color: #27ae60;
    }
    .gate-option-btn.wrong {
      border-color: #e74c3c;
      background: linear-gradient(135deg, #fdf2f2, #fdeaea);
      color: #e74c3c;
    }
    .gate-submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .gate-submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 47, 47, 0.3);
    }
    .gate-submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .gate-loading {
      text-align: center;
      padding: 60px 20px;
    }
    .gate-loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e8d4c4;
      border-top: 4px solid #8b2f2f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    .gate-loading-text {
      color: #8b2f2f;
      font-size: 16px;
      font-weight: 600;
    }
    .gate-result {
      text-align: center;
      padding: 40px 20px;
    }
    .gate-result-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .gate-result-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .gate-result-title.success { color: #27ae60; }
    .gate-result-title.fail { color: #e74c3c; }
    .gate-result-msg {
      font-size: 15px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .gate-result-btn {
      padding: 14px 40px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .gate-result-btn.primary {
      background: linear-gradient(135deg, #8b2f2f 0%, #c0392b 100%);
      color: #fff;
    }
    .gate-result-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(139, 47, 47, 0.3);
    }
    .gate-result-btn.secondary {
      background: #f0ebe5;
      color: #4a3728;
      margin-left: 10px;
    }
    .gate-result-btn.secondary:hover {
      background: #e5ded6;
    }
    @media (max-width: 600px) {
      .gate-quiz-container {
        padding: 20px;
        border-radius: 18px;
      }
      .gate-quiz-header h1 { font-size: 20px; }
      .gate-option-btn { padding: 12px 14px; font-size: 13px; }
    }
  </style>

  <!-- 📝 형성평가 관문 모달 -->
  <div id="gateQuizModal" class="gate-quiz-modal">
    <div class="gate-quiz-container" id="gateQuizContainer">
      <button class="gate-quiz-close-btn" onclick="closeGateQuizModal()" title="닫기">✕</button>
      <div class="gate-loading">
        <div class="gate-loading-spinner"></div>
        <p class="gate-loading-text">형성평가 문제를 불러오는 중...</p>
      </div>
    </div>
  </div>

  <div id="lockModal" class="lock-modal-overlay">
    <div class="lock-modal-card">
      <div class="lock-modal-header">
        <span class="lock-icon">🔒</span>
        <h2>학습 잠금</h2>
      </div>
      <div class="lock-modal-body">
        <p>
          이 단원은 <strong>형성평가 관문 <span id="lockGateLevel">1</span></strong>을<br>
          통과해야 학습할 수 있습니다.<br><br>
          관문 시험에 도전해보세요!
        </p>
      </div>
      <div class="lock-modal-footer">
        <button class="lock-go-gate-btn" onclick="goToGateFromLock()">
          📝 형성평가 시험 보러 가기
        </button>
        <button class="lock-close-btn" onclick="closeLockModal()">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- 📝 형성평가 관문 시스템 스크립트 -->
  <script>
    // ===== 형성평가 모달 전역 변수 =====
    let gateQuizData = [];
    let gateCurrentIndex = 0;
    let gateSelectedAnswer = null;
    let gateCurrentLevel = 1;

    // ===== 보기 섞기 함수 (Fisher-Yates 알고리즘) =====
    function shuffleQuizOptions(quizzes) {
      return quizzes.map(quiz => {
        // 원본 정답 인덱스 (1-based → 0-based)
        const correctIdx = (quiz.correct || quiz.answer) - 1;
        const correctOption = quiz.options[correctIdx];

        // 보기 배열 복사 후 섞기
        const shuffledOptions = [...quiz.options];
        for (let i = shuffledOptions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
        }

        // 섞인 배열에서 정답의 새로운 위치 찾기 (1-based로 저장)
        const newCorrectIdx = shuffledOptions.indexOf(correctOption) + 1;

        return {
          ...quiz,
          options: shuffledOptions,
          correct: newCorrectIdx,
          answer: newCorrectIdx
        };
      });
    }

    // ===== 관문 통과 축하 효과 (폭죽만) =====
    function playGatePassCelebration() {
      // 화려한 폭죽 효과 (여러 번 연속 발사) - z-index를 모달보다 높게 설정
      const confettiZIndex = 999999;
      if (typeof confetti === 'function') {
        // 첫 번째 폭죽 - 중앙에서 위로
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { x: 0.5, y: 0.6 },
          colors: ['#ff0000', '#ff7700', '#ffff00', '#00ff00', '#0099ff', '#6633ff'],
          zIndex: confettiZIndex
        });

        // 두 번째 폭죽 - 왼쪽에서
        setTimeout(() => {
          confetti({
            particleCount: 50,
            angle: 60,
            spread: 55,
            origin: { x: 0, y: 0.6 },
            colors: ['#ff69b4', '#ffd700', '#00ffff'],
            zIndex: confettiZIndex
          });
        }, 200);

        // 세 번째 폭죽 - 오른쪽에서
        setTimeout(() => {
          confetti({
            particleCount: 50,
            angle: 120,
            spread: 55,
            origin: { x: 1, y: 0.6 },
            colors: ['#ff69b4', '#ffd700', '#00ffff'],
            zIndex: confettiZIndex
          });
        }, 200);

        // 네 번째 폭죽 - 별 모양
        setTimeout(() => {
          confetti({
            particleCount: 80,
            spread: 100,
            origin: { x: 0.5, y: 0.5 },
            shapes: ['star'],
            colors: ['#ffd700', '#ffec8b', '#fff8dc'],
            zIndex: confettiZIndex
          });
        }, 500);

        // 추가 화려한 효과 (일반: 2초, 40관문: 5초)
        setTimeout(() => {
          const duration = gateCurrentLevel === 40 ? 5000 : 2000;
          const end = Date.now() + duration;
          const colors = gateCurrentLevel === 40
            ? ['#bb0000', '#ffffff', '#ffd700', '#ff69b4']
            : ['#667eea', '#764ba2', '#f093fb', '#ffd700'];

          const frame = () => {
            confetti({
              particleCount: gateCurrentLevel === 40 ? 7 : 4,
              angle: 60,
              spread: 55,
              origin: { x: 0 },
              colors: colors,
              zIndex: confettiZIndex
            });
            confetti({
              particleCount: gateCurrentLevel === 40 ? 7 : 4,
              angle: 120,
              spread: 55,
              origin: { x: 1 },
              colors: colors,
              zIndex: confettiZIndex
            });

            if (Date.now() < end) {
              requestAnimationFrame(frame);
            }
          };
          frame();
        }, 800);
      }
    }

    // 관문 시험 시작 (모달 열기)
    function startGateQuiz() {
      const gateLevel = document.getElementById('gateLevel').textContent;
      // 관문 안내 팝업 닫기
      closeGatePopup();
      // 형성평가 모달 열기
      openGateQuizModal(parseInt(gateLevel));
    }

    // 형성평가 모달 열기
    async function openGateQuizModal(level) {
      gateCurrentLevel = level;
      gateQuizData = [];
      gateCurrentIndex = 0;
      gateSelectedAnswer = null;

      const modal = document.getElementById('gateQuizModal');
      const container = document.getElementById('gateQuizContainer');

      // 모달 표시 (로딩 상태)
      container.innerHTML = `
        <button class="gate-quiz-close-btn" onclick="closeGateQuizModal()" title="닫기">✕</button>
        <div class="gate-loading">
          <div class="gate-loading-spinner"></div>
          <p class="gate-loading-text">형성평가 문제를 불러오는 중...</p>
        </div>
      `;
      modal.classList.add('active');

      // API 호출하여 문제 가져오기
      try {
        const saved = localStorage.getItem('currentStudent');
        if (!saved) {
          alert('로그인이 필요합니다.');
          closeGateQuizModal();
          return;
        }
        const student = JSON.parse(saved);
        const res = await fetch(`/api/gate-quiz/generate?grade=${encodeURIComponent(student.grade)}&name=${encodeURIComponent(student.name)}&gate=${level}`);
        const data = await res.json();

        if (!data.ok) {
          container.innerHTML = `
            <button class="gate-quiz-close-btn" onclick="closeGateQuizModal()" title="닫기">✕</button>
            <div class="gate-result">
              <div class="gate-result-icon">❌</div>
              <h2 class="gate-result-title fail">문제 생성 실패</h2>
              <p class="gate-result-msg">${data.error || '문제를 불러올 수 없습니다.'}</p>
              <button class="gate-result-btn secondary" onclick="closeGateQuizModal()">닫기</button>
            </div>
          `;
          return;
        }

        gateQuizData = data.quizzes || data.questions;
        // 각 문제의 보기를 랜덤으로 섞기
        gateQuizData = shuffleQuizOptions(gateQuizData);
        renderGateQuiz();
      } catch (err) {
        console.error('[Gate Quiz Error]', err);
        container.innerHTML = `
          <button class="gate-quiz-close-btn" onclick="closeGateQuizModal()" title="닫기">✕</button>
          <div class="gate-result">
            <div class="gate-result-icon">❌</div>
            <h2 class="gate-result-title fail">오류 발생</h2>
            <p class="gate-result-msg">서버 연결에 실패했습니다.</p>
            <button class="gate-result-btn secondary" onclick="closeGateQuizModal()">닫기</button>
          </div>
        `;
      }
    }

    // 형성평가 모달 닫기
    function closeGateQuizModal() {
      if (gateQuizData.length > 0 && gateCurrentIndex < gateQuizData.length) {
        if (!confirm('형성평가를 종료하시겠습니까?\n통과하지 못하면 다음 단원 학습이 제한됩니다.')) {
          return;
        }
      }
      document.getElementById('gateQuizModal').classList.remove('active');
      gateQuizData = [];
      gateCurrentIndex = 0;
    }

    // 형성평가 문제 렌더링
    function renderGateQuiz() {
      const container = document.getElementById('gateQuizContainer');
      const quiz = gateQuizData[gateCurrentIndex];
      const qNum = gateCurrentIndex + 1;

      const passageHTML = quiz.passage && quiz.passage.length > 0
        ? quiz.passage.map(p => `<p>${p}</p>`).join('')
        : '<p>본문을 불러올 수 없습니다.</p>';

      container.innerHTML = `
        <button class="gate-quiz-close-btn" onclick="closeGateQuizModal()" title="닫기">✕</button>
        <div class="gate-quiz-header">
          <h1>📝 형성평가 관문 ${gateCurrentLevel}</h1>
          <p class="gate-number">10개 문제 중 ${qNum}번째</p>
          <p class="gate-info">모든 문제를 연속으로 맞춰야 통과합니다</p>
        </div>

        <div class="gate-progress-bar">
          <div class="fill" style="width: ${(qNum / 10) * 100}%"></div>
        </div>

        <div class="gate-unit-btn" onclick="toggleGatePassage()">
          <div>
            <span class="title-text">📖 ${quiz.unitTitle}</span>
            <span class="title-hint">에서 출제 (클릭하여 본문 보기)</span>
          </div>
          <span class="arrow">▼</span>
        </div>

        <div class="gate-passage" id="gatePassageContent">
          ${passageHTML}
        </div>

        <div class="gate-question-box">
          <p class="question-text">${quiz.question}</p>
        </div>

        <div class="gate-options">
          ${quiz.options.map((opt, idx) => `
            <button class="gate-option-btn" onclick="selectGateAnswer(${idx})">
              ${['①', '②', '③', '④'][idx]} ${opt}
            </button>
          `).join('')}
        </div>

        <button class="gate-submit-btn" onclick="submitGateAnswer()" disabled>
          답안 제출
        </button>
      `;
      gateSelectedAnswer = null;
    }

    // 본문 토글
    function toggleGatePassage() {
      const btn = document.querySelector('.gate-unit-btn');
      const content = document.getElementById('gatePassageContent');
      btn.classList.toggle('open');
      content.classList.toggle('open');
    }

    // 답안 선택
    function selectGateAnswer(index) {
      gateSelectedAnswer = index;
      const buttons = document.querySelectorAll('.gate-option-btn');
      buttons.forEach(btn => btn.classList.remove('selected'));
      buttons[index].classList.add('selected');
      document.querySelector('.gate-submit-btn').disabled = false;
    }

    // 답안 제출
    async function submitGateAnswer() {
      if (gateSelectedAnswer === null) return;

      const quiz = gateQuizData[gateCurrentIndex];
      // API에서 correct는 1-4 기반, 화면에서는 0-3 기반 인덱스 사용
      const correctIndex = (quiz.correct || quiz.answer) - 1;
      const isCorrect = gateSelectedAnswer === correctIndex;

      const buttons = document.querySelectorAll('.gate-option-btn');
      buttons.forEach((btn, idx) => {
        btn.onclick = null;
        if (idx === correctIndex) btn.classList.add('correct');
        if (idx === gateSelectedAnswer && !isCorrect) btn.classList.add('wrong');
      });
      document.querySelector('.gate-submit-btn').disabled = true;

      if (isCorrect) {
        // 정답
        if (gateCurrentIndex < gateQuizData.length - 1) {
          // 다음 문제로
          setTimeout(() => {
            gateCurrentIndex++;
            gateSelectedAnswer = null;
            renderGateQuiz();
          }, 1000);
        } else {
          // 모두 통과!
          setTimeout(() => saveGatePass(), 1000);
        }
      } else {
        // 오답 - 실패
        setTimeout(() => showGateFail(), 1500);
      }
    }

    // 관문 통과 저장
    async function saveGatePass() {
      const container = document.getElementById('gateQuizContainer');
      try {
        const saved = localStorage.getItem('currentStudent');
        const student = JSON.parse(saved);

        console.log('[Gate Pass] 저장 요청:', { grade: student.grade, name: student.name, gateLevel: gateCurrentLevel });

        const res = await fetch('/api/gate-quiz/pass', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            grade: student.grade,
            name: student.name,
            gate: gateCurrentLevel  // 서버에서 'gate'를 기대함
          })
        });
        const data = await res.json();
        console.log('[Gate Pass] 응답:', data);

        if (!data.ok) {
          throw new Error(data.error || '저장 실패');
        }

        // 전역 변수 업데이트
        passedGates = gateCurrentLevel;

        // 통과한 관문은 dismissed에서 제거 (다음 관문 팝업이 뜨도록)
        sessionStorage.removeItem('gatePopupDismissed');

        // 화려한 폭죽 효과 + 빵빠레 효과음
        playGatePassCelebration();

        // 마지막 관문(40) 통과 시 특별 메시지
        const isFinalGate = gateCurrentLevel === 40;
        const resultMsg = isFinalGate
          ? `🎊 축하합니다! 모든 400개 단원을 완료하셨습니다!<br>대단한 성취입니다!`
          : `축하합니다! 10문제를 모두 맞추셨습니다.<br>새로운 단원의 학습이 해금되었습니다.`;
        const resultIcon = isFinalGate ? '🏆' : '🎉';
        const buttonText = isFinalGate ? '완료' : '학습 계속하기';

        container.innerHTML = `
          <button class="gate-quiz-close-btn" onclick="closeGateQuizModalForce()" title="닫기">✕</button>
          <div class="gate-result">
            <div class="gate-result-icon">${resultIcon}</div>
            <h2 class="gate-result-title success">관문 ${gateCurrentLevel} 통과!</h2>
            <p class="gate-result-msg">${resultMsg}</p>
            <button class="gate-result-btn primary" onclick="closeGateQuizModalForce()">${buttonText}</button>
          </div>
        `;
      } catch (err) {
        console.error('[Gate Pass Error]', err);
        container.innerHTML = `
          <button class="gate-quiz-close-btn" onclick="closeGateQuizModalForce()" title="닫기">✕</button>
          <div class="gate-result">
            <div class="gate-result-icon">⚠️</div>
            <h2 class="gate-result-title">저장 오류</h2>
            <p class="gate-result-msg">관문 통과 기록 저장에 실패했습니다.</p>
            <button class="gate-result-btn secondary" onclick="closeGateQuizModalForce()">닫기</button>
          </div>
        `;
      }
    }

    // 실패 화면
    function showGateFail() {
      const container = document.getElementById('gateQuizContainer');
      container.innerHTML = `
        <button class="gate-quiz-close-btn" onclick="closeGateQuizModalForce()" title="닫기">✕</button>
        <div class="gate-result">
          <div class="gate-result-icon">😢</div>
          <h2 class="gate-result-title fail">아쉽게도 통과하지 못했습니다</h2>
          <p class="gate-result-msg">
            ${gateCurrentIndex + 1}번째 문제에서 오답이 발생했습니다.<br>
            복습 후 다시 도전해주세요!
          </p>
          <div>
            <button class="gate-result-btn primary" onclick="openGateQuizModal(${gateCurrentLevel})">다시 도전하기</button>
            <button class="gate-result-btn secondary" onclick="closeGateQuizModalForce()">나중에 하기</button>
          </div>
        </div>
      `;
    }

    // 강제 닫기 (확인 없이)
    function closeGateQuizModalForce() {
      document.getElementById('gateQuizModal').classList.remove('active');
      gateQuizData = [];
      gateCurrentIndex = 0;
      // 관문 상태 새로고침
      checkGateStatus();
    }

    // 관문 팝업 닫기 (나중에 하기)
    function closeGatePopup() {
      const popup = document.getElementById('gatePopup');
      if (popup) popup.classList.remove('active');
      // 세션 동안 해당 관문 팝업 안 뜨게
      const gateLevel = document.getElementById('gateLevel').textContent;
      sessionStorage.setItem('gatePopupDismissed', gateLevel);
    }

    // 관문 상태 확인 및 팝업 표시 (캐시 사용)
    async function checkGateStatus() {
      const saved = localStorage.getItem('currentStudent');
      if (!saved) return;

      try {
        const student = JSON.parse(saved);
        const data = await ApiCache.fetch(`/api/gate-quiz/status?grade=${encodeURIComponent(student.grade)}&name=${encodeURIComponent(student.name)}`);

        if (!data || !data.ok) return;

        console.log('[Gate Status]', data);

        // 🔒 전역 변수 설정 (잠금 체크용)
        passedGates = data.highestPassedGate || 0;
        completedUnitsCount = data.completedUnits || 0;
        completedUnitIds = data.completedUnitIds || [];

        // 관문 시험을 볼 수 있는 상태인지 확인
        if (data.canTakeGate) {
          // "나중에 하기"를 눌렀던 관문인지 확인
          const dismissedGate = sessionStorage.getItem('gatePopupDismissed');
          if (dismissedGate === String(data.nextGate)) {
            console.log('[Gate] 팝업 dismissed:', data.nextGate);
            return; // 이미 "나중에 하기"를 누른 관문이면 팝업 안 띄움
          }

          // 팝업 표시
          document.getElementById('gateLevel').textContent = data.nextGate;
          document.getElementById('gateCompletedCount').textContent = data.completedUnits;
          document.getElementById('gateRequiredCount').textContent = data.requiredUnits;

          // 공지사항 팝업 후에 표시 (2초 딜레이)
          setTimeout(() => {
            const gatePopup = document.getElementById('gatePopup');
            const noticePopup = document.getElementById('noticePopup');

            // 공지사항 팝업이 활성화되어 있지 않으면 관문 팝업 표시
            if (!noticePopup || !noticePopup.classList.contains('active')) {
              gatePopup.classList.add('active');
            } else {
              // 공지사항 팝업이 닫힐 때까지 기다림
              const observer = new MutationObserver((mutations) => {
                if (!noticePopup.classList.contains('active')) {
                  setTimeout(() => gatePopup.classList.add('active'), 500);
                  observer.disconnect();
                }
              });
              observer.observe(noticePopup, { attributes: true });
            }
          }, 1500);
        }
      } catch (err) {
        console.error('[Gate Status Error]', err);
      }
    }

    // 페이지 로드 시 관문 상태 확인
    document.addEventListener('DOMContentLoaded', function() {
      // 즉시 관문 상태 확인 (잠금 상태 설정)
      checkGateStatus();
      // 3초 후에 다시 확인 (팝업 표시용)
      setTimeout(checkGateStatus, 3000);
    });
  </script>

  <!-- 🔄 로딩 스피너 제어 스크립트 -->
  <script>
    // 페이지 로드 완료 시 스피너 숨김 (1.5초 후)
    window.addEventListener('load', function() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        setTimeout(() => {
          loadingOverlay.classList.add('fade-out');
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500);
        }, 1500);
      }

      // 🔥 iPad/iOS 비디오 자동재생 강제 실행
      const bgVideo = document.querySelector('.menu-bg-video');
      if (bgVideo) {
        // iOS Safari에서는 autoplay 속성만으로 부족할 수 있어 명시적으로 play() 호출
        bgVideo.play().catch(err => {
          console.log('비디오 자동재생 실패 (사용자 인터랙션 필요):', err);
          // 사용자가 화면을 터치하면 재생되도록 이벤트 리스너 추가
          document.body.addEventListener('click', function playOnce() {
            bgVideo.play();
            document.body.removeEventListener('click', playOnce);
          }, { once: true });
        });
      }
    });
  </script>

</body>
</html>
