<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í–‰ë™ì˜ˆì¸¡ AI ë°ì´í„° ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      --panel: #ffffff;
      --accent: #495057;
      --accent-hover: #212529;
      --text: #212529;
      --text-light: #495057;
      --line: #dee2e6;
      --danger: #dc3545;
      --danger-hover: #c82333;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      padding: 40px 20px;
      background: var(--bg);
      font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
      color: var(--text);
    }
    .wrap {
      max-width: 1400px;
      margin: 0 auto;
    }
    header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 20px;
    }
    .title-main {
      font-size: 32px;
      font-weight: 700;
      color: #212529;
      margin: 0 0 8px;
    }
    .title-sub {
      font-size: 14px;
      color: #495057;
      line-height: 1.6;
      margin: 0;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      padding: 10px 20px;
      background: linear-gradient(135deg, #495057 0%, #212529 100%);
      color: #fff;
      text-decoration: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
      flex-wrap: wrap;
    }
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .search-box {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .search-box input {
      padding: 10px 16px;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      font-size: 14px;
      width: 250px;
      transition: border-color 0.3s;
    }
    .search-box input:focus {
      outline: none;
      border-color: #495057;
    }
    .select-all-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #495057;
    }
    .select-all-wrap input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .delete-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-hover) 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .delete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }
    .delete-btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .count-info {
      font-size: 14px;
      color: #495057;
      background: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    .count-info strong {
      color: #212529;
    }
    .table-container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: linear-gradient(135deg, #495057 0%, #343a40 100%);
      color: #fff;
    }
    th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
    }
    th:first-child {
      width: 50px;
      text-align: center;
    }
    tbody tr {
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s;
    }
    tbody tr:hover {
      background: #f8f9fa;
    }
    tbody tr.selected {
      background: #e3f2fd;
    }
    td {
      padding: 14px 12px;
      font-size: 14px;
      color: #495057;
    }
    td:first-child {
      text-align: center;
    }
    td input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #868e96;
      font-size: 16px;
    }
    .gate-badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #495057 0%, #343a40 100%);
      color: #fff;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .gate-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: #fff;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal-content {
      transform: translateY(0);
    }
    .modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #212529;
      margin: 0;
    }
    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: #f1f3f5;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #dee2e6;
    }
    .modal-body {
      padding: 28px;
    }
    .detail-section {
      margin-bottom: 24px;
    }
    .detail-section:last-child {
      margin-bottom: 0;
    }
    .detail-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e9ecef;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .detail-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
    }
    .detail-label {
      font-size: 12px;
      color: #868e96;
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 18px;
      font-weight: 700;
      color: #212529;
    }
    .detail-value.highlight {
      color: #495057;
    }
    .question-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .question-table th,
    .question-table td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 13px;
    }
    .question-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }
    .question-table td {
      color: #212529;
    }
    .no-attempt-data {
      text-align: center;
      padding: 40px 20px;
      color: #868e96;
      font-size: 14px;
    }
    .loading-modal {
      text-align: center;
      padding: 40px;
      color: #495057;
    }
    .date-cell {
      white-space: nowrap;
    }
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #495057;
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #dee2e6;
      border-top-color: #495057;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #212529;
      color: #fff;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    @media (max-width: 768px) {
      .title-main { font-size: 24px; }
      header { flex-direction: column; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left { flex-direction: column; }
      .search-box input { width: 100%; }
      th, td { padding: 10px 8px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title-main">í˜•ì„±í‰ê°€ ê´€ë¬¸ AI ë°ì´í„° ê´€ë¦¬</div>
        <div class="title-sub">
          í•™ìƒë“¤ì˜ í˜•ì„±í‰ê°€ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.
        </div>
      </div>
      <a href="/super/dashboard" class="back-btn">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    </header>

    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ì´ë¦„ ë˜ëŠ” í•™êµëª…ìœ¼ë¡œ ê²€ìƒ‰..." />
        </div>
        <div class="select-all-wrap">
          <input type="checkbox" id="selectAll" />
          <label for="selectAll">ì „ì²´ ì„ íƒ</label>
        </div>
        <div class="count-info">
          ì„ íƒ: <strong id="selectedCount">0</strong>ê°œ / ì „ì²´: <strong id="totalCount">0</strong>ê°œ
        </div>
      </div>
      <button class="delete-btn" id="deleteBtn" disabled>
        ğŸ—‘ï¸ ì„ íƒ í•­ëª© ì¼ê´„ ì‚­ì œ
      </button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>ë²ˆí˜¸</th>
            <th>í•™ë…„</th>
            <th>ì´ë¦„</th>
            <th>í•™êµëª…</th>
            <th>ê´€ë¬¸</th>
            <th>ê´€ë¬¸ í†µê³¼ ë‚ ì§œ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="7" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ========== í•™ìŠµ í–‰ë™ ë°ì´í„° ì„¹ì…˜ ========== -->
    <div style="margin-top: 60px; padding-top: 40px; border-top: 3px solid #dee2e6;">
      <header style="margin-bottom: 30px;">
        <div>
          <div class="title-main" style="font-size: 28px;">ë³¸ë¬¸í•™ìŠµ í–‰ë™ ë°ì´í„°</div>
          <div class="title-sub">
            í•™ìƒë“¤ì˜ ë³¸ë¬¸í•™ìŠµ ì˜¤ë‹µ ê¸°ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤. (ë…í•´ì‹œê°„, ì¤‘ì‹¬ë¬¸ë‹¨ í€´ì¦ˆ ì˜¤ë‹µ, ë¬¸ì œ ì˜¤ë‹µ)
          </div>
        </div>
      </header>

      <div class="toolbar">
        <div class="toolbar-left">
          <div class="search-box">
            <input type="text" id="behaviorSearchInput" placeholder="ì´ë¦„ ë˜ëŠ” ë‹¨ì›ëª…ìœ¼ë¡œ ê²€ìƒ‰..." />
          </div>
          <div class="select-all-wrap">
            <input type="checkbox" id="behaviorSelectAll" />
            <label for="behaviorSelectAll">ì „ì²´ ì„ íƒ</label>
          </div>
          <div class="count-info">
            ì„ íƒ: <strong id="behaviorSelectedCount">0</strong>ê°œ / ì „ì²´: <strong id="behaviorTotalCount">0</strong>ê°œ
          </div>
        </div>
        <button class="delete-btn" id="behaviorDeleteBtn" disabled>
          ğŸ—‘ï¸ ì„ íƒ í•­ëª© ì¼ê´„ ì‚­ì œ
        </button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>ë²ˆí˜¸</th>
              <th>í•™êµëª…</th>
              <th>í•™ë…„</th>
              <th>ì´ë¦„</th>
              <th>ë‹¨ì›ëª…</th>
              <th>ê³¼ëª©í‰ê· ì†Œìš”ì‹œê°„</th>
              <th>ë…í•´ ì´ì†Œìš”ì‹œê°„</th>
              <th>ì¤‘ì‹¬ë¬¸ë‹¨ ì´ì˜¤ë‹µ</th>
              <th>ë¬¸ì œ ì´ì˜¤ë‹µ</th>
              <th>í•™ìŠµì¼ì‹œ</th>
            </tr>
          </thead>
          <tbody id="behaviorTableBody">
            <tr>
              <td colspan="11" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ê´€ë¬¸ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">ê´€ë¬¸ ìƒì„¸ ì •ë³´</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="loading-modal">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- í•™ìŠµ í–‰ë™ ìƒì„¸ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="behaviorDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="behaviorModalTitle">ì˜¤ë‹µ ìƒì„¸ ì •ë³´</h3>
        <button class="modal-close" onclick="closeBehaviorModal()">&times;</button>
      </div>
      <div class="modal-body" id="behaviorModalBody">
        <div class="loading-modal">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let selectedIds = new Set();
    let gateShowAll = false;  // ë”ë³´ê¸° ìƒíƒœ
    const GATE_INITIAL_COUNT = 10;  // ì´ˆê¸° í‘œì‹œ ê°œìˆ˜

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
      try {
        const res = await fetch('/api/super/gate-passes');
        const result = await res.json();

        if (result.ok) {
          allData = result.data;
          filteredData = [...allData];
          renderTable();
          updateCounts();
        } else {
          showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">ê´€ë¬¸ í†µê³¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      // ë”ë³´ê¸° ìƒíƒœì— ë”°ë¼ í‘œì‹œí•  ë°ì´í„° ê²°ì •
      const displayData = gateShowAll ? filteredData : filteredData.slice(0, GATE_INITIAL_COUNT);
      const hasMore = filteredData.length > GATE_INITIAL_COUNT && !gateShowAll;

      let html = displayData.map((item, index) => {
        const isSelected = selectedIds.has(item._id);
        const passedDate = item.passedAt ? new Date(item.passedAt).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';

        return `
          <tr class="${isSelected ? 'selected' : ''}" data-id="${item._id}">
            <td>
              <input type="checkbox" class="row-checkbox" data-id="${item._id}" ${isSelected ? 'checked' : ''} />
            </td>
            <td>${index + 1}</td>
            <td>${item.grade || '-'}</td>
            <td>${item.name || '-'}</td>
            <td>${item.school || '-'}</td>
            <td><span class="gate-badge" onclick="openGateDetail('${item.grade}', '${item.name}', ${item.gate})">ê´€ë¬¸ ${item.gate}</span></td>
            <td class="date-cell">${passedDate}</td>
          </tr>
        `;
      }).join('');

      // ë”ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
      if (hasMore) {
        html += `
          <tr>
            <td colspan="7" style="text-align:center; padding:20px;">
              <button onclick="toggleGateShowAll()" style="
                background: linear-gradient(135deg, #495057 0%, #212529 100%);
                color: #fff;
                border: none;
                padding: 12px 32px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
              " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                ë”ë³´ê¸° (${filteredData.length - GATE_INITIAL_COUNT}ê°œ ë”)
              </button>
            </td>
          </tr>
        `;
      } else if (gateShowAll && filteredData.length > GATE_INITIAL_COUNT) {
        html += `
          <tr>
            <td colspan="7" style="text-align:center; padding:20px;">
              <button onclick="toggleGateShowAll()" style="
                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                color: #fff;
                border: none;
                padding: 12px 32px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
              " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                ì ‘ê¸°
              </button>
            </td>
          </tr>
        `;
      }

      tbody.innerHTML = html;

      // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          if (e.target.checked) {
            selectedIds.add(id);
          } else {
            selectedIds.delete(id);
          }
          updateSelection();
        });
      });
    }

    function toggleGateShowAll() {
      gateShowAll = !gateShowAll;
      renderTable();
    }

    function updateSelection() {
      // í–‰ ì„ íƒ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      document.querySelectorAll('#tableBody tr[data-id]').forEach(row => {
        const id = row.dataset.id;
        if (selectedIds.has(id)) {
          row.classList.add('selected');
        } else {
          row.classList.remove('selected');
        }
      });

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
      const selectAllCb = document.getElementById('selectAll');
      if (filteredData.length > 0 && selectedIds.size === filteredData.length) {
        selectAllCb.checked = true;
        selectAllCb.indeterminate = false;
      } else if (selectedIds.size > 0) {
        selectAllCb.checked = false;
        selectAllCb.indeterminate = true;
      } else {
        selectAllCb.checked = false;
        selectAllCb.indeterminate = false;
      }

      updateCounts();
    }

    function updateCounts() {
      document.getElementById('selectedCount').textContent = selectedIds.size;
      document.getElementById('totalCount').textContent = filteredData.length;
      document.getElementById('deleteBtn').disabled = selectedIds.size === 0;
    }

    // ì „ì²´ ì„ íƒ
    document.getElementById('selectAll').addEventListener('change', (e) => {
      if (e.target.checked) {
        filteredData.forEach(item => selectedIds.add(item._id));
      } else {
        selectedIds.clear();
      }
      renderTable();
      updateCounts();
    });

    // ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      if (!query) {
        filteredData = [...allData];
      } else {
        filteredData = allData.filter(item =>
          (item.name && item.name.toLowerCase().includes(query)) ||
          (item.school && item.school.toLowerCase().includes(query)) ||
          (item.grade && item.grade.toLowerCase().includes(query))
        );
      }
      // ê²€ìƒ‰ ì‹œ ì„ íƒ ì´ˆê¸°í™”
      selectedIds.clear();
      renderTable();
      updateCounts();
    });

    // ì¼ê´„ ì‚­ì œ
    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (selectedIds.size === 0) return;

      const confirmMsg = `ì„ íƒí•œ ${selectedIds.size}ê°œì˜ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
      if (!confirm(confirmMsg)) return;

      try {
        const res = await fetch('/api/super/gate-passes/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(selectedIds) })
        });

        const result = await res.json();

        if (result.ok) {
          showToast(`${result.deletedCount}ê°œ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          selectedIds.clear();
          await loadData();
        } else {
          showToast(result.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ê´€ë¬¸ ìƒì„¸ ì •ë³´ ëª¨ë‹¬
    async function openGateDetail(grade, name, gate) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = `${name} - ê´€ë¬¸ ${gate} ìƒì„¸ ì •ë³´`;
      modalBody.innerHTML = '<div class="loading-modal">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      modal.classList.add('show');

      try {
        const res = await fetch(`/api/super/gate-pass-details?grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}&gate=${gate}`);
        const result = await res.json();

        if (result.ok) {
          renderDetailModal(result.data);
        } else {
          modalBody.innerHTML = '<div class="no-attempt-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
      } catch (err) {
        console.error(err);
        modalBody.innerHTML = '<div class="no-attempt-data">ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    function renderDetailModal(data) {
      const modalBody = document.getElementById('modalBody');

      // ì‹œë„ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš°
      if (data.totalAttempts === 0) {
        modalBody.innerHTML = `
          <div class="no-attempt-data">
            <p>ì•„ì§ ìƒì„¸ ì‹œë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p style="font-size:12px; color:#adb5bd; margin-top:8px;">
              (ìƒˆë¡œìš´ í˜•ì„±í‰ê°€ í’€ì´ë¶€í„° ê¸°ë¡ë©ë‹ˆë‹¤)
            </p>
          </div>
        `;
        return;
      }

      const formatTime = (seconds) => {
        if (!seconds) return '0ì´ˆ';
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (mins > 0) {
          return `${mins}ë¶„ ${secs}ì´ˆ`;
        }
        return `${secs}ì´ˆ`;
      };

      const passedDate = data.passedAt ? new Date(data.passedAt).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }) : '-';

      // ì§€ìˆ˜ ìœ í˜• ë§¤í•‘ í•¨ìˆ˜
      const getIndexName = (qType) => {
        return qType === 'q2' ? 'êµ¬ì¡°íŒŒì•…ë ¥' : 'í•µì‹¬ì´í•´ë ¥';
      };

      let questionDetailsHtml = '';
      let weakestQuestionsHtml = '';

      if (data.questionDetails && data.questionDetails.length > 0) {
        const validQuestions = data.questionDetails
          .filter(q => q.questionNo != null && !isNaN(q.questionNo));

        // ê°€ì¥ ë¯¸í¡í•œ ë¬¸í•­ 2ê°œ ì„ ì •
        // ì¡°ê±´: 1) ëˆ„ì  ì˜¤ë‹µ í´ë¦­ ë§ì€ ìˆœ, 2) ëˆ„ì  ì‹œê°„ ë†’ì€ ìˆœ, 3) êµ¬ì¡°íŒŒì•…ë ¥ ìš°ì„ 
        const sortedByWeakness = [...validQuestions].sort((a, b) => {
          // 1. ëˆ„ì  ì˜¤ë‹µ í´ë¦­ì´ ë§ì€ ìˆœ
          if (b.cumulativeWrongClicks !== a.cumulativeWrongClicks) {
            return b.cumulativeWrongClicks - a.cumulativeWrongClicks;
          }
          // 2. ëˆ„ì  ì‹œê°„ì´ ë†’ì€ ìˆœ
          if (b.cumulativeTime !== a.cumulativeTime) {
            return b.cumulativeTime - a.cumulativeTime;
          }
          // 3. êµ¬ì¡°íŒŒì•…ë ¥(q2) ìš°ì„ 
          if (a.qType !== b.qType) {
            return a.qType === 'q2' ? -1 : 1;
          }
          return 0;
        });

        const weakestTwo = sortedByWeakness.slice(0, 2);
        const weakestQuestionNos = new Set(weakestTwo.map(q => q.questionNo));

        if (weakestTwo.length > 0) {
          weakestQuestionsHtml = `
            <div class="detail-section">
              <div class="detail-section-title" style="color:#dc3545;">âš ï¸ ê°€ì¥ ë¯¸í¡í•œ ë¬¸í•­ (ìƒìœ„ ${weakestTwo.length}ê°œ)</div>
              <table class="question-table" style="border:2px solid #ffcdd2; border-radius:8px;">
                <thead style="background:#ffebee;">
                  <tr>
                    <th style="color:#c62828;">ë¬¸í•­</th>
                    <th style="color:#c62828;">ë‹¨ì›ëª…</th>
                    <th style="color:#c62828;">ì§€ìˆ˜</th>
                    <th style="color:#c62828;">ëˆ„ì  ì‹œê°„</th>
                    <th style="color:#c62828;">ëˆ„ì  ì˜¤ë‹µ í´ë¦­</th>
                  </tr>
                </thead>
                <tbody>
                  ${weakestTwo.map(q => `
                    <tr style="background:#fff8f8;">
                      <td style="font-weight:600; color:#c62828;">ë¬¸í•­ ${q.questionNo}</td>
                      <td style="font-size:11px; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${q.unitTitle || q.unitCode || '-'}">${q.unitTitle || q.unitCode || '-'}</td>
                      <td><span style="display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; background:${q.qType === 'q2' ? '#e3f2fd' : '#fff3e0'}; color:${q.qType === 'q2' ? '#1565c0' : '#e65100'};">${getIndexName(q.qType)}</span></td>
                      <td style="font-weight:600;">${formatTime(q.cumulativeTime)}</td>
                      <td style="font-weight:600; color:#c62828;">${q.cumulativeWrongClicks}íšŒ</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

        questionDetailsHtml = `
          <div class="detail-section">
            <div class="detail-section-title">ê° ë¬¸í•­ë³„ ëˆ„ì  ê¸°ë¡</div>
            <table class="question-table">
              <thead>
                <tr>
                  <th>ë¬¸í•­</th>
                  <th>ë‹¨ì›ëª…</th>
                  <th>ì§€ìˆ˜</th>
                  <th>ëˆ„ì  ì‹œê°„</th>
                  <th>ëˆ„ì  ì˜¤ë‹µ í´ë¦­</th>
                </tr>
              </thead>
              <tbody>
                ${validQuestions
                  .sort((a, b) => a.questionNo - b.questionNo)
                  .map(q => `
                  <tr style="${weakestQuestionNos.has(q.questionNo) ? 'background:#fff8f8;' : ''}">
                    <td style="${weakestQuestionNos.has(q.questionNo) ? 'color:#c62828; font-weight:600;' : ''}">ë¬¸í•­ ${q.questionNo}</td>
                    <td style="font-size:11px; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${q.unitTitle || q.unitCode || '-'}">${q.unitTitle || q.unitCode || '-'}</td>
                    <td><span style="display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; background:${q.qType === 'q2' ? '#e3f2fd' : '#fff3e0'}; color:${q.qType === 'q2' ? '#1565c0' : '#e65100'};">${getIndexName(q.qType)}</span></td>
                    <td>${formatTime(q.cumulativeTime)}</td>
                    <td style="${weakestQuestionNos.has(q.questionNo) ? 'color:#c62828; font-weight:600;' : ''}">${q.cumulativeWrongClicks}íšŒ</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      modalBody.innerHTML = `
        <div class="detail-section">
          <div class="detail-section-title">ìš”ì•½ ì •ë³´</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">ì¬ë„ì „ íšŸìˆ˜</div>
              <div class="detail-value highlight">${data.retryCount}íšŒ</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ì´ ì‹œë„ íšŸìˆ˜</div>
              <div class="detail-value">${data.totalAttempts}íšŒ</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ëˆ„ì  ì „ì²´ í’€ì´ ì‹œê°„</div>
              <div class="detail-value">${formatTime(data.cumulativeTime)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ëˆ„ì  ì „ì²´ ì˜¤ë‹µ í´ë¦­</div>
              <div class="detail-value">${data.cumulativeWrongClicks}íšŒ</div>
            </div>
          </div>
        </div>

        ${data.finalAttempt ? `
        <div class="detail-section">
          <div class="detail-section-title">ìµœì¢… ì‹œë„ (${data.finalAttempt.passed ? 'í†µê³¼' : 'ë¯¸í†µê³¼'})</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">ìµœì¢… í’€ì´ ì‹œê°„</div>
              <div class="detail-value">${formatTime(data.finalAttempt.totalTime)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ìµœì¢… ì˜¤ë‹µ í´ë¦­</div>
              <div class="detail-value">${data.finalAttempt.totalWrongClicks}íšŒ</div>
            </div>
          </div>
        </div>
        ` : ''}

        ${weakestQuestionsHtml}

        ${questionDetailsHtml}

        <div class="detail-section">
          <div class="detail-section-title">í†µê³¼ ë‚ ì§œ</div>
          <div class="detail-item" style="text-align: center;">
            <div class="detail-value">${passedDate}</div>
          </div>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal();
      }
    });

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
        closeBehaviorModal();
      }
    });

    // ========== í•™ìŠµ í–‰ë™ ë°ì´í„° ì„¹ì…˜ ==========
    let behaviorAllData = [];
    let behaviorFilteredData = [];
    let behaviorSelectedIds = new Set();
    let subjectAverages = {}; // ê³¼ëª©ë³„ í‰ê·  ì†Œìš”ì‹œê°„

    // ë‹¨ì›ëª…ì—ì„œ ê³¼ëª©ì½”ë“œ ì¶”ì¶œ (on_chem_04 â†’ chem)
    function getSubjectCode(unitName) {
      if (!unitName) return null;
      // on_, fit_, deep_ ì ‘ë‘ì–´ ì œê±° í›„ ë§ˆì§€ë§‰ _ìˆ«ì ì œê±°
      let code = unitName.replace(/^(on_|fit_|deep_)/, '');
      code = code.replace(/_\d+$/, '');
      return code || null;
    }

    // ê³¼ëª©ë³„ í‰ê·  ì†Œìš”ì‹œê°„ ê³„ì‚° (30ë¶„ ì´ˆê³¼ ë°ì´í„° ì œì™¸)
    function calculateSubjectAverages(data) {
      const subjectTimes = {};

      data.forEach(item => {
        const unitName = item.unit || item.unitTitle;
        const subjectCode = getSubjectCode(unitName);
        const readingTime = item.readingTime || 0;

        // 30ë¶„(1800ì´ˆ) ì´ˆê³¼ ë°ì´í„° ì œì™¸
        if (!subjectCode || readingTime > 1800) return;

        if (!subjectTimes[subjectCode]) {
          subjectTimes[subjectCode] = { total: 0, count: 0 };
        }
        subjectTimes[subjectCode].total += readingTime;
        subjectTimes[subjectCode].count += 1;
      });

      // í‰ê·  ê³„ì‚°
      const averages = {};
      for (const code in subjectTimes) {
        if (subjectTimes[code].count > 0) {
          averages[code] = Math.round(subjectTimes[code].total / subjectTimes[code].count);
        }
      }
      return averages;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•™ìŠµ í–‰ë™ ë°ì´í„°ë„ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', loadBehaviorData);

    async function loadBehaviorData() {
      try {
        const res = await fetch('/api/super/learning-behaviors');
        const result = await res.json();

        if (result.ok) {
          behaviorAllData = result.data;
          behaviorFilteredData = [...behaviorAllData];
          subjectAverages = calculateSubjectAverages(behaviorAllData);
          renderBehaviorTable();
          updateBehaviorCounts();
        } else {
          showToast('í•™ìŠµ í–‰ë™ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function formatTime(seconds) {
      if (!seconds) return '0ì´ˆ';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      if (mins > 0) {
        return `${mins}ë¶„ ${secs}ì´ˆ`;
      }
      return `${secs}ì´ˆ`;
    }

    function renderBehaviorTable() {
      const tbody = document.getElementById('behaviorTableBody');

      if (behaviorFilteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="no-data">í•™ìŠµ í–‰ë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      tbody.innerHTML = behaviorFilteredData.map((item, index) => {
        const isSelected = behaviorSelectedIds.has(item._id);
        const createdDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';

        const paragraphTotal = item.paragraphQuizErrors?.total || 0;
        const problemTotal = item.problemErrors?.total || 0;

        // ê³¼ëª©í‰ê· ì†Œìš”ì‹œê°„ ê³„ì‚°
        const unitName = item.unit || item.unitTitle;
        const subjectCode = getSubjectCode(unitName);
        const subjectAvg = subjectCode ? subjectAverages[subjectCode] : null;

        return `
          <tr class="${isSelected ? 'selected' : ''}" data-id="${item._id}">
            <td>
              <input type="checkbox" class="behavior-row-checkbox" data-id="${item._id}" ${isSelected ? 'checked' : ''} />
            </td>
            <td>${index + 1}</td>
            <td>${item.school || '-'}</td>
            <td>${item.grade || '-'}</td>
            <td>${item.name || '-'}</td>
            <td>${item.unitTitle || item.unit || '-'}</td>
            <td>${subjectAvg ? formatTime(subjectAvg) : '-'}</td>
            <td>${formatTime(item.readingTime)}</td>
            <td>
              ${paragraphTotal > 0
                ? `<span class="gate-badge" style="background: linear-gradient(135deg, #e57373 0%, #c62828 100%);" onclick="openParagraphDetail('${item._id}')">${paragraphTotal}íšŒ</span>`
                : '<span style="color:#868e96;">0íšŒ</span>'}
            </td>
            <td>
              ${problemTotal > 0
                ? `<span class="gate-badge" style="background: linear-gradient(135deg, #ff8a65 0%, #d84315 100%);" onclick="openProblemDetail('${item._id}')">${problemTotal}íšŒ</span>`
                : '<span style="color:#868e96;">0íšŒ</span>'}
            </td>
            <td class="date-cell">${createdDate}</td>
          </tr>
        `;
      }).join('');

      // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      document.querySelectorAll('.behavior-row-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          if (e.target.checked) {
            behaviorSelectedIds.add(id);
          } else {
            behaviorSelectedIds.delete(id);
          }
          updateBehaviorSelection();
        });
      });
    }

    function updateBehaviorSelection() {
      document.querySelectorAll('#behaviorTableBody tr[data-id]').forEach(row => {
        const id = row.dataset.id;
        if (behaviorSelectedIds.has(id)) {
          row.classList.add('selected');
        } else {
          row.classList.remove('selected');
        }
      });

      const selectAllCb = document.getElementById('behaviorSelectAll');
      if (behaviorFilteredData.length > 0 && behaviorSelectedIds.size === behaviorFilteredData.length) {
        selectAllCb.checked = true;
        selectAllCb.indeterminate = false;
      } else if (behaviorSelectedIds.size > 0) {
        selectAllCb.checked = false;
        selectAllCb.indeterminate = true;
      } else {
        selectAllCb.checked = false;
        selectAllCb.indeterminate = false;
      }

      updateBehaviorCounts();
    }

    function updateBehaviorCounts() {
      document.getElementById('behaviorSelectedCount').textContent = behaviorSelectedIds.size;
      document.getElementById('behaviorTotalCount').textContent = behaviorFilteredData.length;
      document.getElementById('behaviorDeleteBtn').disabled = behaviorSelectedIds.size === 0;
    }

    // ì „ì²´ ì„ íƒ
    document.getElementById('behaviorSelectAll').addEventListener('change', (e) => {
      if (e.target.checked) {
        behaviorFilteredData.forEach(item => behaviorSelectedIds.add(item._id));
      } else {
        behaviorSelectedIds.clear();
      }
      renderBehaviorTable();
      updateBehaviorCounts();
    });

    // ê²€ìƒ‰
    document.getElementById('behaviorSearchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      if (!query) {
        behaviorFilteredData = [...behaviorAllData];
      } else {
        behaviorFilteredData = behaviorAllData.filter(item =>
          (item.name && item.name.toLowerCase().includes(query)) ||
          (item.unitTitle && item.unitTitle.toLowerCase().includes(query)) ||
          (item.unit && item.unit.toLowerCase().includes(query)) ||
          (item.school && item.school.toLowerCase().includes(query))
        );
      }
      behaviorSelectedIds.clear();
      renderBehaviorTable();
      updateBehaviorCounts();
    });

    // ì¼ê´„ ì‚­ì œ
    document.getElementById('behaviorDeleteBtn').addEventListener('click', async () => {
      if (behaviorSelectedIds.size === 0) return;

      const confirmMsg = `ì„ íƒí•œ ${behaviorSelectedIds.size}ê°œì˜ í•™ìŠµ í–‰ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
      if (!confirm(confirmMsg)) return;

      try {
        const res = await fetch('/api/super/learning-behaviors/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(behaviorSelectedIds) })
        });

        const result = await res.json();

        if (result.ok) {
          showToast(`${result.deletedCount}ê°œ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          behaviorSelectedIds.clear();
          await loadBehaviorData();
        } else {
          showToast(result.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì¤‘ì‹¬ë¬¸ë‹¨ ì˜¤ë‹µ ìƒì„¸ ëª¨ë‹¬
    function openParagraphDetail(id) {
      const item = behaviorAllData.find(d => d._id === id);
      if (!item) return;

      const modal = document.getElementById('behaviorDetailModal');
      const modalTitle = document.getElementById('behaviorModalTitle');
      const modalBody = document.getElementById('behaviorModalBody');

      modalTitle.textContent = `${item.name} - ì¤‘ì‹¬ë¬¸ë‹¨ í€´ì¦ˆ ì˜¤ë‹µ ìƒì„¸`;

      const details = item.paragraphQuizErrors?.details || [];
      if (details.length === 0) {
        modalBody.innerHTML = '<div class="no-attempt-data">ìƒì„¸ ì˜¤ë‹µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        modalBody.innerHTML = `
          <div class="detail-section">
            <div class="detail-section-title">ë¬¸ë‹¨ë³„ ì˜¤ë‹µ íšŸìˆ˜</div>
            <table class="question-table">
              <thead>
                <tr>
                  <th>ë¬¸ë‹¨ ë²ˆí˜¸</th>
                  <th>ì˜¤ë‹µ íšŸìˆ˜</th>
                </tr>
              </thead>
              <tbody>
                ${details.map(d => `
                  <tr>
                    <td>ë¬¸ë‹¨ ${d.paragraphNo}</td>
                    <td style="color:#c62828; font-weight:600;">${d.errorCount}íšŒ</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="detail-section">
            <div class="detail-item" style="text-align:center;">
              <div class="detail-label">ì´ ì˜¤ë‹µ íšŸìˆ˜</div>
              <div class="detail-value" style="color:#c62828;">${item.paragraphQuizErrors?.total || 0}íšŒ</div>
            </div>
          </div>
        `;
      }

      modal.classList.add('show');
    }

    // ë¬¸ì œ ì˜¤ë‹µ ìƒì„¸ ëª¨ë‹¬
    const problemIndexNames = {
      1: 'í•µì‹¬ ì´í•´ë ¥',
      2: 'êµ¬ì¡° íŒŒì•…ë ¥',
      3: 'ì–´íœ˜ ë§¥ë½ë ¥',
      4: 'ì¶”ë¡  í†µí•©ë ¥',
      5: 'ë¹„íŒ ì ìš©ë ¥'
    };

    function openProblemDetail(id) {
      const item = behaviorAllData.find(d => d._id === id);
      if (!item) return;

      const modal = document.getElementById('behaviorDetailModal');
      const modalTitle = document.getElementById('behaviorModalTitle');
      const modalBody = document.getElementById('behaviorModalBody');

      modalTitle.textContent = `${item.name} - ë¬¸ì œ ì˜¤ë‹µ ìƒì„¸`;

      const details = item.problemErrors?.details || [];
      if (details.length === 0) {
        modalBody.innerHTML = '<div class="no-attempt-data">ìƒì„¸ ì˜¤ë‹µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        modalBody.innerHTML = `
          <div class="detail-section">
            <div class="detail-section-title">ë¬¸í•­ë³„ ì˜¤ë‹µ íšŸìˆ˜ (ë‹¤ì‹œí’€ê¸° í¬í•¨ ëˆ„ì )</div>
            <table class="question-table">
              <thead>
                <tr>
                  <th>ë¬¸í•­ ë²ˆí˜¸</th>
                  <th>ì§€ìˆ˜ ëª…ì¹­</th>
                  <th>ì˜¤ë‹µ íšŸìˆ˜</th>
                </tr>
              </thead>
              <tbody>
                ${details.map(d => `
                  <tr>
                    <td>ë¬¸í•­ ${d.problemNo}</td>
                    <td style="color:#495057;">${problemIndexNames[d.problemNo] || '-'}</td>
                    <td style="color:#d84315; font-weight:600;">${d.errorCount}íšŒ</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="detail-section">
            <div class="detail-item" style="text-align:center;">
              <div class="detail-label">ì´ ì˜¤ë‹µ íšŸìˆ˜</div>
              <div class="detail-value" style="color:#d84315;">${item.problemErrors?.total || 0}íšŒ</div>
            </div>
          </div>
        `;
      }

      modal.classList.add('show');
    }

    function closeBehaviorModal() {
      document.getElementById('behaviorDetailModal').classList.remove('show');
    }

    // í•™ìŠµ í–‰ë™ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('behaviorDetailModal').addEventListener('click', (e) => {
      if (e.target.id === 'behaviorDetailModal') {
        closeBehaviorModal();
      }
    });
  </script>
</body>
</html>
