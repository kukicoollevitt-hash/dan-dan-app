<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³ ë˜ë±ƒì§€ í™•ì„±ê¸° ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Noto Sans KR", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }

    .header h1 {
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 16px;
    }

    .back-btn {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 30px;
    }

    .back-btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .section {
      margin-bottom: 50px;
    }

    .section-title {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .count-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .filter-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-section input, .filter-section select {
      padding: 10px 16px;
      font-size: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      outline: none;
    }

    .filter-section input:focus, .filter-section select:focus {
      border-color: #667eea;
    }

    .search-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      transform: translateY(-2px);
    }

    .add-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(17, 153, 142, 0.4);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid #ecf0f1;
      color: #2c3e50;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .empty-message {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #667eea;
    }

    .edit-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .edit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
    }

    .delete-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 8px;
    }

    .delete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
    }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .user-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #667eea;
    }

    /* ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì˜ì—­ */
    .bulk-actions {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .bulk-actions.active {
      display: flex;
    }

    .bulk-actions .selected-count {
      font-weight: 600;
      color: #667eea;
    }

    .bulk-delete-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bulk-delete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    .bulk-cancel-btn {
      padding: 10px 16px;
      background: #f1f1f1;
      color: #666;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .bulk-cancel-btn:hover {
      background: #e0e0e0;
    }

    /* ë©”ì‹œì§€ íƒ€ì… ë°°ì§€ */
    .type-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .type-megaphone {
      background: #FFD700;
      color: #333;
    }

    .type-notice {
      background: #3498db;
      color: white;
    }

    /* ë©”ì‹œì§€ ë‚´ìš© ìŠ¤íƒ€ì¼ */
    .message-content {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background: #fff;
      border-radius: 20px;
      padding: 35px 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    .modal-overlay.active .modal-box {
      transform: scale(1);
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-form .input-group {
      margin-bottom: 16px;
    }

    .modal-form label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .modal-form input, .modal-form select, .modal-form textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      outline: none;
      transition: all 0.3s ease;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 100px;
    }

    .modal-form input:focus, .modal-form select:focus, .modal-form textarea:focus {
      border-color: #667eea;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 25px;
    }

    .modal-btn {
      padding: 12px 30px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .modal-btn-cancel {
      background: #f1f1f1;
      color: #666;
    }

    .modal-btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
    }

    .char-counter {
      text-align: right;
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .char-counter.over {
      color: #e74c3c;
    }

    /* ë”ë³´ê¸° ë²„íŠ¼ */
    .show-more-btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .show-more-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .filter-section {
        flex-direction: column;
      }

      .filter-section input, .filter-section select, .filter-section button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/super/dashboard" class="back-btn">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="header">
      <h1>ğŸ“¢ ê³ ë˜ë±ƒì§€ í™•ì„±ê¸° ê´€ë¦¬</h1>
      <p>Live í”¼ë“œì— í‘œì‹œë˜ëŠ” í•™ìƒ ì‘ì› ë©”ì‹œì§€ì™€ ê³µì§€ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>

    <!-- ê³ ì • ê³µì§€ì‚¬í•­ ê´€ë¦¬ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ“Œ Live í”¼ë“œ ê³ ì • ê³µì§€ ê´€ë¦¬</span>
        <span class="count-badge" id="noticeCount">ì´ 0ê±´</span>
      </div>
      <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">ë©”ì¸ ë©”ë‰´ Live í”¼ë“œì— í‘œì‹œë˜ëŠ” ê³ ì • ê³µì§€ì‚¬í•­ (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)</p>

      <div class="filter-section" style="margin-bottom: 15px;">
        <button class="add-btn" onclick="openNoticeAddModal()">+ ê³µì§€ ì¶”ê°€</button>
      </div>

      <div class="table-container" style="max-height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px;">
        <table>
          <thead style="position: sticky; top: 0; z-index: 10;">
            <tr>
              <th style="width: 60px; text-align: center;">ë²ˆí˜¸</th>
              <th style="width: 70px; text-align: center;">ì•„ì´ì½˜</th>
              <th style="text-align: left;">ê³µì§€ ë‚´ìš©</th>
              <th style="width: 140px; text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="noticeTableBody">
            <tr>
              <td colspan="4" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- í˜•ì„±í‰ê°€ í†µê³¼ í•™ìƒ ëª©ë¡ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ‰ í˜•ì„±í‰ê°€ í†µê³¼ í•™ìƒ ëª©ë¡ (Live í”¼ë“œ)</span>
        <span class="count-badge" id="learningCount">ì´ 0ê±´</span>
      </div>
      <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">ìµœê·¼ 32ê±´ì˜ í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)</p>

      <!-- ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
      <div class="bulk-actions" id="learningBulkActions">
        <span class="selected-count"><span id="learningSelectedCount">0</span>ê°œ ì„ íƒë¨</span>
        <button class="bulk-delete-btn" onclick="bulkDeleteLearningLogs()">ğŸ—‘ï¸ ì¼ê´„ ì‚­ì œ</button>
        <button class="bulk-cancel-btn" onclick="clearLearningSelection()">ì„ íƒ ì·¨ì†Œ</button>
      </div>

      <div class="learning-feed-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px;">
        <table>
          <thead style="position: sticky; top: 0; z-index: 10;">
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="learningSelectAll" class="user-checkbox" onchange="toggleLearningSelectAll()"></th>
              <th style="width: 50px;">ë²ˆí˜¸</th>
              <th>í•™ë…„</th>
              <th>ì´ë¦„</th>
              <th>í†µê³¼ ë‹¨ì›</th>
              <th>ì‹œë¦¬ì¦ˆ</th>
              <th>ì™„ë£Œ ì¼ì‹œ</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="learningTableBody">
            <tr>
              <td colspan="8" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- í™•ì„±ê¸° ë©”ì‹œì§€ ê´€ë¦¬ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ“£ í™•ì„±ê¸° ë©”ì‹œì§€ ëª©ë¡</span>
        <span class="count-badge" id="messageCount">ì´ 0ê°œ</span>
      </div>

      <div class="filter-section">
        <select id="searchType">
          <option value="">ì „ì²´ íƒ€ì…</option>
          <option value="megaphone">í•™ìƒ í™•ì„±ê¸°</option>
          <option value="notice">ê´€ë¦¬ì ê³µì§€</option>
        </select>
        <select id="searchGrade">
          <option value="">ì „ì²´ í•™ë…„</option>
          <option value="ì´ˆ4">ì´ˆ4</option>
          <option value="ì´ˆ5">ì´ˆ5</option>
          <option value="ì´ˆ6">ì´ˆ6</option>
          <option value="4í•™ë…„">4í•™ë…„</option>
          <option value="5í•™ë…„">5í•™ë…„</option>
          <option value="6í•™ë…„">6í•™ë…„</option>
          <option value="ì¤‘1">ì¤‘1</option>
          <option value="ì¤‘2">ì¤‘2</option>
          <option value="ì¤‘3">ì¤‘3</option>
          <option value="ê³ 1">ê³ 1</option>
          <option value="ê³ 2">ê³ 2</option>
          <option value="ê³ 3">ê³ 3</option>
        </select>
        <input type="text" id="searchName" placeholder="ì´ë¦„ ê²€ìƒ‰">
        <input type="text" id="searchMessage" placeholder="ë©”ì‹œì§€ ë‚´ìš© ê²€ìƒ‰">
        <button class="search-btn" onclick="loadMessages()">ê²€ìƒ‰</button>
        <button class="add-btn" onclick="openAddModal()">+ ê³µì§€ ì¶”ê°€</button>
      </div>

      <!-- ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
      <div class="bulk-actions" id="bulkActions">
        <span class="selected-count"><span id="selectedCount">0</span>ê°œ ì„ íƒë¨</span>
        <button class="bulk-delete-btn" onclick="bulkDeleteMessages()">ğŸ—‘ï¸ ì¼ê´„ ì‚­ì œ</button>
        <button class="bulk-cancel-btn" onclick="clearSelection()">ì„ íƒ ì·¨ì†Œ</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="selectAll" class="user-checkbox" onchange="toggleSelectAll()"></th>
              <th>ë²ˆí˜¸</th>
              <th>íƒ€ì…</th>
              <th>í•™ë…„</th>
              <th>ì´ë¦„</th>
              <th>í™•ì„±ê¸° ë‚´ìš©</th>
              <th>ì‚¬ìš© ì½”ì¸</th>
              <th>ë“±ë¡ì¼ì‹œ</th>
              <th>ë§Œë£Œì¼ì‹œ</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="messageTableBody">
            <tr>
              <td colspan="10" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="show-more-btn" id="showMoreBtn" style="display: none;" onclick="showMoreMessages()">ë”ë³´ê¸° (<span id="remainingCount">0</span>ê°œ ë”)</button>
    </div>
  </div>

  <!-- ë©”ì‹œì§€ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="messageModal">
    <div class="modal-box">
      <div class="modal-title" id="modalTitle">ê³µì§€ ì¶”ê°€</div>
      <form class="modal-form" id="messageForm">
        <input type="hidden" id="messageId">
        <div class="input-group">
          <label>íƒ€ì…</label>
          <select id="messageType" required>
            <option value="notice">ê´€ë¦¬ì ê³µì§€</option>
            <option value="megaphone">í•™ìƒ í™•ì„±ê¸°</option>
          </select>
        </div>
        <div class="input-group" id="gradeGroup">
          <label>í•™ë…„</label>
          <select id="messageGrade">
            <option value="">ì„ íƒ</option>
            <option value="ì´ˆ4">ì´ˆ4</option>
            <option value="ì´ˆ5">ì´ˆ5</option>
            <option value="ì´ˆ6">ì´ˆ6</option>
            <option value="4í•™ë…„">4í•™ë…„</option>
            <option value="5í•™ë…„">5í•™ë…„</option>
            <option value="6í•™ë…„">6í•™ë…„</option>
            <option value="ì¤‘1">ì¤‘1</option>
            <option value="ì¤‘2">ì¤‘2</option>
            <option value="ì¤‘3">ì¤‘3</option>
            <option value="ê³ 1">ê³ 1</option>
            <option value="ê³ 2">ê³ 2</option>
            <option value="ê³ 3">ê³ 3</option>
          </select>
        </div>
        <div class="input-group" id="nameGroup">
          <label>ì´ë¦„</label>
          <input type="text" id="messageName" placeholder="ì´ë¦„ ì…ë ¥">
        </div>
        <div class="input-group">
          <label>ë©”ì‹œì§€ ë‚´ìš© (ìµœëŒ€ 50ì)</label>
          <textarea id="messageContent" maxlength="50" required placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <div class="char-counter" id="charCounter">0 / 50</div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="modal-btn modal-btn-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ê³ ì • ê³µì§€ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="noticeModal">
    <div class="modal-box">
      <div class="modal-title" id="noticeModalTitle">ê³µì§€ ì¶”ê°€</div>
      <form class="modal-form" id="noticeForm" onsubmit="submitNotice(event)">
        <input type="hidden" id="noticeEditIndex" value="-1">
        <div class="input-group">
          <label>ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
          <input type="text" id="noticeIcon" required placeholder="ì˜ˆ: ğŸ“š, ğŸ³, ğŸ¤–" maxlength="4" style="font-size: 20px; text-align: center;">
        </div>
        <div class="input-group">
          <label>ê³µì§€ ë‚´ìš©</label>
          <textarea id="noticeMessage" required placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" rows="3"></textarea>
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-cancel" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="modal-btn modal-btn-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- í˜•ì„±í‰ê°€ ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="learningModal">
    <div class="modal-box">
      <div class="modal-title">í˜•ì„±í‰ê°€ ê¸°ë¡ ìˆ˜ì •</div>
      <form class="modal-form" id="learningForm" onsubmit="submitLearningEdit(event)">
        <input type="hidden" id="learningEditId">
        <div class="input-group">
          <label>í•™ë…„</label>
          <select id="learningEditGrade" required>
            <option value="">ì„ íƒ</option>
            <option value="ì´ˆ4">ì´ˆ4</option>
            <option value="ì´ˆ5">ì´ˆ5</option>
            <option value="ì´ˆ6">ì´ˆ6</option>
            <option value="4í•™ë…„">4í•™ë…„</option>
            <option value="5í•™ë…„">5í•™ë…„</option>
            <option value="6í•™ë…„">6í•™ë…„</option>
            <option value="ì¤‘1">ì¤‘1</option>
            <option value="ì¤‘2">ì¤‘2</option>
            <option value="ì¤‘3">ì¤‘3</option>
            <option value="ê³ 1">ê³ 1</option>
            <option value="ê³ 2">ê³ 2</option>
            <option value="ê³ 3">ê³ 3</option>
          </select>
        </div>
        <div class="input-group">
          <label>ì´ë¦„</label>
          <input type="text" id="learningEditName" required placeholder="ì´ë¦„ ì…ë ¥">
        </div>
        <div class="input-group">
          <label>í†µê³¼ ë‹¨ì›</label>
          <input type="text" id="learningEditUnit" required placeholder="ë‹¨ì› ì…ë ¥ (ì˜ˆ: 08ê´€ë¬¸)">
        </div>
        <div class="input-group">
          <label>ì‹œë¦¬ì¦ˆ</label>
          <input type="text" id="learningEditSeries" placeholder="ì‹œë¦¬ì¦ˆ ì…ë ¥ (ì˜ˆ: BRAINì—…)">
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-cancel" onclick="closeLearningModal()">ì·¨ì†Œ</button>
          <button type="submit" class="modal-btn modal-btn-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allMessages = [];

    // ê³ ì • ê³µì§€ ë°ì´í„° (localStorage ì‚¬ìš©)
    const NOTICE_STORAGE_KEY = 'live_feed_notices';
    let fixedNotices = [];

    // ê¸°ë³¸ ê³µì§€ ëª©ë¡
    const defaultNotices = [
      { icon: 'ğŸ“š', message: '[ê³µì§€] ì–´íœ˜í•™ìŠµì€ ìµœì´ˆ 1íšŒ ì™„ë£Œ í›„ì— ì–´íœ˜ë ¥ ì§€ìˆ˜ê°€ ë°˜ì˜ë©ë‹ˆë‹¤!' },
      { icon: 'ğŸ³', message: '[ê³µì§€] AIê³ ë˜ìŒ¤ í•˜ë£¨ ê³ ë˜ë±ƒì§€ëŠ” ë§¤ì¼ 10ë±ƒì§€ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤!' },
      { icon: 'ğŸ¤–', message: '[ê³µì§€] í•™ìŠµì‹¤ì˜ AIì¶”ì²œê³¼ì œëŠ” ë¯¸í¡í•œ ë‹¨ì›ì„ AIê³ ë˜ìŒ¤ì´ í™•ì¸í•˜ì—¬ ë¶€ì—¬ë©ë‹ˆë‹¤!' },
      { icon: 'ğŸ“–', message: '[ê³µì§€] ê³ ë˜ ë…ì„œ ê°ìƒë¬¸ì€ ìµœì†Œ ì›” 1íšŒ ì œì¶œì´ì§€ë§Œ ì¶”ê°€ ì œì¶œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤!' },
      { icon: 'âœ…', message: '[ê³µì§€] ì™„ë£Œëœ í•™ìŠµê³¼ì œëŠ” ì„ ìƒë‹˜ í™•ì¸ í›„ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤!' },
      { icon: 'ğŸ“Š', message: '[ê³µì§€] ì¢…í•©ë¦¬í¬íŠ¸ëŠ” ìµœì‹  ì™„ë£Œëœ ê³¼ì œ ìˆœìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤!' }
    ];

    // ê³µì§€ ë¡œë“œ (ì„œë²„ APIì—ì„œ)
    async function loadNotices() {
      try {
        const res = await fetch('/api/notices/admin');
        const data = await res.json();
        if (data.success) {
          fixedNotices = data.notices;
        } else {
          console.error('ê³µì§€ ë¡œë“œ ì‹¤íŒ¨:', data.error);
          fixedNotices = [];
        }
      } catch (err) {
        console.error('ê³µì§€ ë¡œë“œ ì˜¤ë¥˜:', err);
        fixedNotices = [];
      }
      renderNotices();
    }

    // ê³µì§€ ë Œë”ë§
    function renderNotices() {
      const tbody = document.getElementById('noticeTableBody');
      document.getElementById('noticeCount').textContent = `ì´ ${fixedNotices.length}ê±´`;

      if (fixedNotices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-message">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      tbody.innerHTML = fixedNotices.map((notice, idx) => `
        <tr>
          <td style="text-align: center; vertical-align: middle;">${idx + 1}</td>
          <td style="text-align: center; vertical-align: middle; font-size: 24px;">${notice.icon}</td>
          <td style="vertical-align: middle; padding: 12px 16px;">${notice.message}</td>
          <td style="text-align: center; vertical-align: middle; white-space: nowrap;">
            <button class="edit-btn" onclick="openNoticeEditModal('${notice._id}')">ìˆ˜ì •</button>
            <button class="delete-btn" onclick="deleteNotice('${notice._id}')">ì‚­ì œ</button>
          </td>
        </tr>
      `).join('');
    }

    // ê³µì§€ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function openNoticeAddModal() {
      document.getElementById('noticeModalTitle').textContent = 'ê³µì§€ ì¶”ê°€';
      document.getElementById('noticeEditIndex').value = '-1';
      document.getElementById('noticeIcon').value = '';
      document.getElementById('noticeMessage').value = '';
      document.getElementById('noticeModal').classList.add('active');
    }

    // ê³µì§€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (ID ê¸°ë°˜)
    function openNoticeEditModal(noticeId) {
      const notice = fixedNotices.find(n => n._id === noticeId);
      if (!notice) {
        console.error('Notice not found with id:', noticeId);
        return;
      }
      document.getElementById('noticeModalTitle').textContent = 'ê³µì§€ ìˆ˜ì •';
      document.getElementById('noticeEditIndex').value = noticeId;
      document.getElementById('noticeIcon').value = notice.icon;
      document.getElementById('noticeMessage').value = notice.message;
      document.getElementById('noticeModal').classList.add('active');
    }

    // ê³µì§€ ëª¨ë‹¬ ë‹«ê¸°
    function closeNoticeModal() {
      document.getElementById('noticeModal').classList.remove('active');
    }

    // ê³µì§€ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •) - ì„œë²„ API ì‚¬ìš©
    async function submitNotice(e) {
      e.preventDefault();
      const editId = document.getElementById('noticeEditIndex').value;
      const icon = document.getElementById('noticeIcon').value.trim();
      const message = document.getElementById('noticeMessage').value.trim();

      if (!icon || !message) {
        alert('ì•„ì´ì½˜ê³¼ ê³µì§€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        let res;
        if (editId === '-1' || editId === '') {
          // ì¶”ê°€
          res = await fetch('/api/notices/admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ icon, message })
          });
        } else {
          // ìˆ˜ì •
          res = await fetch(`/api/notices/admin/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ icon, message })
          });
        }

        const data = await res.json();
        if (data.success) {
          await loadNotices();
          closeNoticeModal();
          alert(editId === '-1' || editId === '' ? 'ê³µì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê³µì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('ì˜¤ë¥˜: ' + (data.error || 'ê³µì§€ ì €ì¥ ì‹¤íŒ¨'));
        }
      } catch (err) {
        console.error('ê³µì§€ ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ê³µì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ê³µì§€ ì‚­ì œ - ì„œë²„ API ì‚¬ìš©
    async function deleteNotice(noticeId) {
      if (!confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch(`/api/notices/admin/${noticeId}`, {
          method: 'DELETE'
        });
        const data = await res.json();

        if (data.success) {
          await loadNotices();
          alert('ê³µì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('ì˜¤ë¥˜: ' + (data.error || 'ê³µì§€ ì‚­ì œ ì‹¤íŒ¨'));
        }
      } catch (err) {
        console.error('ê³µì§€ ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ê³µì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    const noticeModalEl = document.getElementById('noticeModal');
    if (noticeModalEl) {
      noticeModalEl.addEventListener('click', function(e) {
        if (e.target === this) closeNoticeModal();
      });
    }

    let filteredMessages = [];
    let selectedIds = [];

    // í˜•ì„±í‰ê°€ ê´€ë ¨ ë³€ìˆ˜
    let allLearningLogs = [];
    let learningSelectedIds = [];

    // í˜ì´ì§€ë‹¹ í‘œì‹œ ê°œìˆ˜
    const ITEMS_PER_PAGE = 20;
    let displayCount = ITEMS_PER_PAGE;

    // í˜•ì„±í‰ê°€ í†µê³¼ í•™ìƒ ëª©ë¡ ë¡œë“œ (ê´€ë¦¬ììš© API ì‚¬ìš©)
    async function loadLearningFeed() {
      const tbody = document.getElementById('learningTableBody');
      learningSelectedIds = [];

      // ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      const bulkActions = document.getElementById('learningBulkActions');
      if (bulkActions) bulkActions.classList.remove('active');

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
      const selectAllCheckbox = document.getElementById('learningSelectAll');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }

      try {
        const response = await fetch('/api/learning-log/admin/list');
        const data = await response.json();

        if (data.success) {
          allLearningLogs = data.logs || [];

          document.getElementById('learningCount').textContent = `ì´ ${allLearningLogs.length}ê±´`;

          if (allLearningLogs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-message">í˜•ì„±í‰ê°€ë¥¼ í†µê³¼í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
          }

          tbody.innerHTML = allLearningLogs.map((log, idx) => {
            // ë‹¨ì› IDì—ì„œ ê´€ë¬¸ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: on_world2_08 â†’ 08ê´€ë¬¸, bio_02 â†’ 02ê´€ë¬¸)
            const unitId = log.unit || '';
            const gateMatch = unitId.match(/(\d+)$/);
            const gateName = gateMatch ? gateMatch[1].padStart(2, '0') + 'ê´€ë¬¸' : unitId;

            // ì‹œë¦¬ì¦ˆ ì •ë³´
            const series = log.series || '-';

            // ì™„ë£Œ ì¼ì‹œ í¬ë§·
            const completedAt = log.timestamp ? formatDate(log.timestamp) : '-';

            return `
              <tr>
                <td class="checkbox-cell"><input type="checkbox" class="user-checkbox learning-row-checkbox" data-id="${log._id}" onchange="updateLearningSelection()"></td>
                <td style="text-align: center;">${idx + 1}</td>
                <td>${log.grade || '-'}</td>
                <td>${log.name || '-'}</td>
                <td>${gateName}</td>
                <td>${series}</td>
                <td>${completedAt}</td>
                <td>
                  <button class="edit-btn" onclick="openLearningEditModal('${log._id}')">ìˆ˜ì •</button>
                  <button class="delete-btn" onclick="deleteLearningLog('${log._id}')">ì‚­ì œ</button>
                </td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="8" class="empty-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="8" class="empty-message">ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    // ì´ë¦„ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
    function maskName(name) {
      if (!name || name.length < 2) return name;
      if (name.length === 2) return name[0] + 'â—‹';
      return name[0] + 'â—‹'.repeat(name.length - 2) + name[name.length - 1];
    }

    // í˜•ì„±í‰ê°€ ì²´í¬ë°•ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function toggleLearningSelectAll() {
      const selectAllCheckbox = document.getElementById('learningSelectAll');
      const rowCheckboxes = document.querySelectorAll('.learning-row-checkbox');

      rowCheckboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
      });

      updateLearningSelection();
    }

    function updateLearningSelection() {
      const rowCheckboxes = document.querySelectorAll('.learning-row-checkbox');
      learningSelectedIds = [];

      rowCheckboxes.forEach(cb => {
        if (cb.checked) {
          learningSelectedIds.push(cb.getAttribute('data-id'));
        }
      });

      document.getElementById('learningSelectedCount').textContent = learningSelectedIds.length;

      const bulkActions = document.getElementById('learningBulkActions');
      if (learningSelectedIds.length > 0) {
        bulkActions.classList.add('active');
      } else {
        bulkActions.classList.remove('active');
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
      const selectAllCheckbox = document.getElementById('learningSelectAll');
      if (learningSelectedIds.length === rowCheckboxes.length && rowCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (learningSelectedIds.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function clearLearningSelection() {
      const rowCheckboxes = document.querySelectorAll('.learning-row-checkbox');
      rowCheckboxes.forEach(cb => cb.checked = false);

      learningSelectedIds = [];
      document.getElementById('learningSelectedCount').textContent = 0;
      document.getElementById('learningBulkActions').classList.remove('active');
      const selectAllCheckbox = document.getElementById('learningSelectAll');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    // í˜•ì„±í‰ê°€ ê°œë³„ ì‚­ì œ
    async function deleteLearningLog(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await fetch(`/api/learning-log/admin/delete/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadLearningFeed();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í˜•ì„±í‰ê°€ ì¼ê´„ ì‚­ì œ
    async function bulkDeleteLearningLogs() {
      if (learningSelectedIds.length === 0) {
        alert('ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(`ì„ íƒí•œ ${learningSelectedIds.length}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const response = await fetch('/api/learning-log/admin/bulk-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: learningSelectedIds })
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message);
          learningSelectedIds = [];
          loadLearningFeed();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í˜•ì„±í‰ê°€ ìˆ˜ì • ëª¨ë‹¬
    function openLearningEditModal(id) {
      const log = allLearningLogs.find(l => l._id === id);
      if (!log) return;

      document.getElementById('learningEditId').value = id;
      document.getElementById('learningEditGrade').value = log.grade || '';
      document.getElementById('learningEditName').value = log.name || '';
      document.getElementById('learningEditUnit').value = log.unit || '';
      document.getElementById('learningEditSeries').value = log.series || '';

      document.getElementById('learningModal').classList.add('active');
    }

    function closeLearningModal() {
      document.getElementById('learningModal').classList.remove('active');
    }

    async function submitLearningEdit(event) {
      event.preventDefault();

      const id = document.getElementById('learningEditId').value;
      const updateData = {
        grade: document.getElementById('learningEditGrade').value,
        name: document.getElementById('learningEditName').value.trim(),
        unit: document.getElementById('learningEditUnit').value.trim(),
        series: document.getElementById('learningEditSeries').value.trim()
      };

      if (!updateData.name || !updateData.unit) {
        alert('ì´ë¦„ê³¼ í†µê³¼ ë‹¨ì›ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const response = await fetch(`/api/learning-log/admin/update/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });

        const data = await response.json();
        if (data.success) {
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeLearningModal();
          loadLearningFeed();
        } else {
          alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í˜•ì„±í‰ê°€ ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('learningModal').addEventListener('click', function(e) {
      if (e.target === this) closeLearningModal();
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
      loadNotices();
      loadLearningFeed();
      loadMessages();

      // ë©”ì‹œì§€ íƒ€ì… ë³€ê²½ ì‹œ í•™ë…„/ì´ë¦„ í•„ë“œ í‘œì‹œ ì œì–´
      document.getElementById('messageType').addEventListener('change', function() {
        const isNotice = this.value === 'notice';
        document.getElementById('gradeGroup').style.display = isNotice ? 'none' : 'block';
        document.getElementById('nameGroup').style.display = isNotice ? 'none' : 'block';

        if (isNotice) {
          document.getElementById('messageGrade').value = '';
          document.getElementById('messageName').value = '';
        }
      });

      // ê¸€ì ìˆ˜ ì¹´ìš´í„°
      document.getElementById('messageContent').addEventListener('input', updateCharCounter);
    });

    function updateCharCounter() {
      const content = document.getElementById('messageContent').value;
      const counter = document.getElementById('charCounter');
      counter.textContent = `${content.length} / 50`;
      counter.classList.toggle('over', content.length >= 50);
    }

    async function loadMessages() {
      const searchType = document.getElementById('searchType').value;
      const searchGrade = document.getElementById('searchGrade').value;
      const searchName = document.getElementById('searchName').value.trim();
      const searchMessage = document.getElementById('searchMessage').value.trim();

      // ê²€ìƒ‰ ì‹œ í‘œì‹œ ê°œìˆ˜ ì´ˆê¸°í™”
      displayCount = ITEMS_PER_PAGE;
      selectedIds = [];
      clearSelection();

      try {
        const response = await fetch('/api/megaphone/admin/list');
        const data = await response.json();

        if (data.ok) {
          allMessages = data.messages || [];

          // í•„í„°ë§
          filteredMessages = allMessages;
          if (searchType) {
            filteredMessages = filteredMessages.filter(m => m.type === searchType);
          }
          if (searchGrade) {
            filteredMessages = filteredMessages.filter(m => m.grade === searchGrade);
          }
          if (searchName) {
            filteredMessages = filteredMessages.filter(m => m.name?.includes(searchName));
          }
          if (searchMessage) {
            filteredMessages = filteredMessages.filter(m => m.message?.includes(searchMessage));
          }

          renderTable(filteredMessages);
          document.getElementById('messageCount').textContent = `ì´ ${filteredMessages.length}ê°œ`;
        } else {
          showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function renderTable(messages) {
      const tbody = document.getElementById('messageTableBody');
      const showMoreBtn = document.getElementById('showMoreBtn');

      if (messages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-message">ë“±ë¡ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        showMoreBtn.style.display = 'none';
        return;
      }

      // í‘œì‹œí•  ë°ì´í„°ë§Œ ì¶”ì¶œ
      const displayData = messages.slice(0, displayCount);
      const remaining = messages.length - displayCount;

      tbody.innerHTML = displayData.map((m, idx) => {
        const typeClass = m.type === 'notice' ? 'type-notice' : 'type-megaphone';
        const typeText = m.type === 'notice' ? 'ê³µì§€' : 'í™•ì„±ê¸°';
        const isChecked = selectedIds.includes(m._id) ? 'checked' : '';

        return `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" class="user-checkbox row-checkbox" data-id="${m._id}" ${isChecked} onchange="updateSelection()"></td>
          <td>${idx + 1}</td>
          <td><span class="type-badge ${typeClass}">${typeText}</span></td>
          <td>${m.grade || '-'}</td>
          <td>${m.name || '-'}</td>
          <td class="message-content" title="${escapeHtml(m.message)}">${escapeHtml(m.message)}</td>
          <td>${m.coinsUsed || 0}</td>
          <td>${formatDate(m.createdAt)}</td>
          <td>${formatDate(m.expiresAt)}</td>
          <td>
            <button class="edit-btn" onclick="openEditModal('${m._id}')">ìˆ˜ì •</button>
            <button class="delete-btn" onclick="deleteMessage('${m._id}')">ì‚­ì œ</button>
          </td>
        </tr>
      `}).join('');

      // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (remaining > 0) {
        document.getElementById('remainingCount').textContent = remaining;
        showMoreBtn.style.display = 'block';
      } else {
        showMoreBtn.style.display = 'none';
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
      document.getElementById('selectAll').checked = false;
    }

    function showMoreMessages() {
      displayCount += ITEMS_PER_PAGE;
      renderTable(filteredMessages);
    }

    function showError(msg) {
      document.getElementById('messageTableBody').innerHTML = `<tr><td colspan="10" class="empty-message">${msg}</td></tr>`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // ì²´í¬ë°•ìŠ¤ ê´€ë ¨
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');

      rowCheckboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
      });

      updateSelection();
    }

    function updateSelection() {
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      selectedIds = [];

      rowCheckboxes.forEach(cb => {
        if (cb.checked) {
          selectedIds.push(cb.getAttribute('data-id'));
        }
      });

      document.getElementById('selectedCount').textContent = selectedIds.length;

      const bulkActions = document.getElementById('bulkActions');
      if (selectedIds.length > 0) {
        bulkActions.classList.add('active');
      } else {
        bulkActions.classList.remove('active');
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
      const selectAllCheckbox = document.getElementById('selectAll');
      if (selectedIds.length === rowCheckboxes.length && rowCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedIds.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function clearSelection() {
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      rowCheckboxes.forEach(cb => cb.checked = false);

      selectedIds = [];
      document.getElementById('selectedCount').textContent = 0;
      document.getElementById('bulkActions').classList.remove('active');
      document.getElementById('selectAll').checked = false;
      document.getElementById('selectAll').indeterminate = false;
    }

    async function bulkDeleteMessages() {
      if (selectedIds.length === 0) {
        alert('ì‚­ì œí•  ë©”ì‹œì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(`ì„ íƒí•œ ${selectedIds.length}ê°œì˜ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const response = await fetch('/api/megaphone/admin/bulk-delete', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: selectedIds })
        });

        const data = await response.json();
        if (data.ok) {
          alert(`${data.deletedCount}ê°œì˜ ë©”ì‹œì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          selectedIds = [];
          loadMessages();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ê´€ë ¨
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'ê³µì§€ ì¶”ê°€';
      document.getElementById('messageId').value = '';
      document.getElementById('messageType').value = 'notice';
      document.getElementById('messageGrade').value = '';
      document.getElementById('messageName').value = '';
      document.getElementById('messageContent').value = '';
      document.getElementById('gradeGroup').style.display = 'none';
      document.getElementById('nameGroup').style.display = 'none';
      updateCharCounter();
      document.getElementById('messageModal').classList.add('active');
    }

    function openEditModal(id) {
      const message = allMessages.find(m => m._id === id);
      if (!message) return;

      document.getElementById('modalTitle').textContent = 'ë©”ì‹œì§€ ìˆ˜ì •';
      document.getElementById('messageId').value = id;
      document.getElementById('messageType').value = message.type || 'megaphone';
      document.getElementById('messageGrade').value = message.grade || '';
      document.getElementById('messageName').value = message.name || '';
      document.getElementById('messageContent').value = message.message || '';

      const isNotice = message.type === 'notice';
      document.getElementById('gradeGroup').style.display = isNotice ? 'none' : 'block';
      document.getElementById('nameGroup').style.display = isNotice ? 'none' : 'block';

      updateCharCounter();
      document.getElementById('messageModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('messageModal').classList.remove('active');
    }

    document.getElementById('messageForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const id = document.getElementById('messageId').value;
      const type = document.getElementById('messageType').value;
      const messageData = {
        type: type,
        grade: type === 'notice' ? '' : document.getElementById('messageGrade').value,
        name: type === 'notice' ? 'ê´€ë¦¬ì' : document.getElementById('messageName').value.trim(),
        message: document.getElementById('messageContent').value.trim(),
        coinsUsed: type === 'notice' ? 0 : 40
      };

      if (!messageData.message) {
        alert('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        let response;
        if (id) {
          // ìˆ˜ì •
          response = await fetch(`/api/megaphone/admin/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(messageData)
          });
        } else {
          // ì¶”ê°€
          response = await fetch('/api/megaphone/admin/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(messageData)
          });
        }

        const data = await response.json();
        if (data.ok) {
          alert(id ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeModal();
          loadMessages();
        } else {
          alert((id ? 'ìˆ˜ì •' : 'ì¶”ê°€') + 'ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    async function deleteMessage(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await fetch(`/api/megaphone/admin/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadMessages();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('messageModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  </script>
</body>
</html>
