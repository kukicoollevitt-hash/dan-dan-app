<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬</title>
  <!-- ì¹´ì¹´ì˜¤ SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Noto Sans KR", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }

    .header h1 {
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 16px;
    }

    .back-btn {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 30px;
    }

    .back-btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .section {
      margin-bottom: 50px;
    }

    .section-title {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .count-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid #ecf0f1;
      color: #2c3e50;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .empty-message {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #667eea;
    }

    .view-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .view-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
    }

    .edit-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .edit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
    }

    .delete-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 8px;
    }

    .delete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
    }

    .grade-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: white;
    }

    /* 1ë“±ê¸‰ - í•˜ëŠ˜ìƒ‰ ê³„ì—´ */
    .grade-1 {
      background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 30%, #0284c7 70%, #0369a1 100%);
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
    }
    /* 2ë“±ê¸‰ - ë…¸ë€ìƒ‰/ê¸ˆìƒ‰ ê³„ì—´ */
    .grade-2 {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 30%, #b45309 70%, #92400e 100%);
      box-shadow: 0 2px 8px rgba(217, 119, 6, 0.4);
    }
    /* 3ë“±ê¸‰ - ì—°ë‘ìƒ‰ ê³„ì—´ */
    .grade-3 {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 30%, #15803d 70%, #166534 100%);
      box-shadow: 0 2px 8px rgba(22, 163, 74, 0.4);
    }
    /* 4ë“±ê¸‰ - ì£¼í™©ìƒ‰ ê³„ì—´ */
    .grade-4 {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 30%, #c2410c 70%, #9a3412 100%);
      box-shadow: 0 2px 8px rgba(234, 88, 12, 0.4);
    }
    /* 5ë“±ê¸‰ - í•‘í¬ìƒ‰ ê³„ì—´ */
    .grade-5 {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 30%, #be185d 70%, #9d174d 100%);
      box-shadow: 0 2px 8px rgba(219, 39, 119, 0.4);
    }

    .score-text {
      font-weight: 700;
      color: #667eea;
    }

    /* ì •ë ¬ ê°€ëŠ¥í•œ í—¤ë” */
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .sortable:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .sortable::after {
      content: 'â‡…';
      margin-left: 6px;
      opacity: 0.6;
      font-size: 12px;
    }

    .sortable.asc::after {
      content: 'â–²';
      opacity: 1;
    }

    .sortable.desc::after {
      content: 'â–¼';
      opacity: 1;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background: #fff;
      border-radius: 20px;
      padding: 35px 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    .modal-overlay.active .modal-box {
      transform: scale(1);
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-form .input-group {
      margin-bottom: 16px;
    }

    .modal-form label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .modal-form input, .modal-form select {
      width: 100%;
      padding: 12px 16px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      outline: none;
      transition: all 0.3s ease;
    }

    .modal-form input:focus, .modal-form select:focus {
      border-color: #667eea;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 25px;
    }

    .modal-btn {
      padding: 12px 30px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .modal-btn-cancel {
      background: #f1f1f1;
      color: #666;
    }

    .modal-btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
    }

    .filter-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-section input, .filter-section select {
      padding: 10px 16px;
      font-size: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      outline: none;
    }

    .filter-section input:focus, .filter-section select:focus {
      border-color: #667eea;
    }

    .search-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      transform: translateY(-2px);
    }

    .add-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(17, 153, 142, 0.4);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #fff3cd;
      color: #856404;
    }

    .status-suspended {
      background: #f8d7da;
      color: #721c24;
    }

    /* AIê³¼ì œ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .ai-task-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    .ai-task-none {
      background: #f1f3f4;
      color: #9aa0a6;
    }

    .ai-task-pending {
      background: #fff3cd;
      color: #856404;
    }

    .ai-task-progress {
      background: #cce5ff;
      color: #004085;
    }

    .ai-task-complete {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .status-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 4px;
    }

    .status-btn-activate {
      background: #28a745;
      color: white;
    }

    .status-btn-suspend {
      background: #ffc107;
      color: #333;
    }

    /* ì´ìš©ê¶Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .ticket-btn {
      display: inline-block;
      padding: 4px 10px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ticket-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }

    .user-name-link {
      color: #6366f1;
      cursor: pointer;
      text-decoration: underline;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .user-name-link:hover {
      color: #8b5cf6;
    }

    /* ì´ìš©ê¶Œ ëª¨ë‹¬ */
    .ticket-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .ticket-modal-overlay.active {
      display: flex;
    }

    .ticket-modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .ticket-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .ticket-modal-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    .ticket-input-group {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .ticket-input-group label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .ticket-input-group input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
    }

    .ticket-input-group input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .ticket-modal-buttons {
      display: flex;
      gap: 10px;
    }

    .ticket-modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ticket-modal-btn.cancel {
      background: #f3f4f6;
      color: #666;
    }

    .ticket-modal-btn.cancel:hover {
      background: #e5e7eb;
    }

    .ticket-modal-btn.save {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }

    .ticket-modal-btn.save:hover {
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .user-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #667eea;
    }

    /* ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì˜ì—­ */
    .bulk-actions {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .bulk-actions.active {
      display: flex;
    }

    .bulk-actions .selected-count {
      font-weight: 600;
      color: #667eea;
    }

    .bulk-ticket-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bulk-ticket-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .bulk-cancel-btn {
      padding: 10px 16px;
      background: #f1f1f1;
      color: #666;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .bulk-cancel-btn:hover {
      background: #e0e0e0;
    }

    /* ìƒë‹´ ìƒíƒœ ë°°ì§€ */
    .consult-status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .consult-status-contacted {
      background: #d1ecf1;
      color: #0c5460;
    }

    .consult-status-completed {
      background: #d4edda;
      color: #155724;
    }

    .consult-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 4px;
    }

    .consult-btn-contact {
      background: #17a2b8;
      color: white;
    }

    .consult-btn-complete {
      background: #28a745;
      color: white;
    }

    .consult-btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    /* ì¼ê´„ ì‚­ì œ ë²„íŠ¼ */
    .bulk-delete-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bulk-delete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    /* ë”ë³´ê¸° ë²„íŠ¼ */
    .show-more-btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .show-more-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/super/dashboard" class="back-btn">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="header">
      <h1>ğŸ“ ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬</h1>
      <p>ëª¨ì˜ê³ ì‚¬ íšŒì› ê´€ë¦¬ì™€ ì‘ì‹œì ëª©ë¡, ì±„ì  ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>

    <!-- ì¤Œ ìˆ˜ì—… ë§í¬ ê´€ë¦¬ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ“º ì¤Œ ìˆ˜ì—… ë§í¬ ê´€ë¦¬</span>
      </div>
      <div class="zoom-link-section" style="padding: 20px; background: #f8fafc; border-radius: 12px; margin-top: 15px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <input type="text" id="zoomLinkInput" placeholder="ì¤Œ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://zoom.us/j/...)"
            style="flex: 1; min-width: 300px; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
          <button onclick="saveZoomLink()"
            style="padding: 12px 24px; background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
            ë§í¬ ì €ì¥
          </button>
        </div>
        <div id="currentZoomLink" style="margin-top: 12px; font-size: 13px; color: #64748b;">
          í˜„ì¬ ì„¤ì •ëœ ë§í¬: <span id="savedZoomLinkDisplay">ì—†ìŒ</span>
        </div>
      </div>
    </div>

    <!-- ìƒë‹´ ì‹ ì²­ ê´€ë¦¬ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ“ ìƒë‹´ ì‹ ì²­ ëª©ë¡</span>
        <span class="count-badge" id="consultCount">ì´ 0ëª…</span>
      </div>

      <div class="filter-section">
        <select id="consultSearchGrade" onchange="filterConsultations()">
          <option value="">ì „ì²´ í•™ë…„</option>
          <option value="ì´ˆ4">ì´ˆ4</option>
          <option value="ì´ˆ5">ì´ˆ5</option>
          <option value="ì´ˆ6">ì´ˆ6</option>
          <option value="ì¤‘1">ì¤‘1</option>
          <option value="ì¤‘2">ì¤‘2</option>
          <option value="ì¤‘3">ì¤‘3</option>
          <option value="ê³ 1">ê³ 1</option>
          <option value="ê³ 2">ê³ 2</option>
          <option value="ê³ 3">ê³ 3</option>
        </select>
        <input type="text" id="consultSearchName" placeholder="ì´ë¦„ ê²€ìƒ‰" oninput="filterConsultations()">
        <select id="consultSearchStatus" onchange="filterConsultations()">
          <option value="">ì „ì²´ ìƒíƒœ</option>
          <option value="pending">ëŒ€ê¸°</option>
          <option value="contacted">ì—°ë½ì™„ë£Œ</option>
          <option value="completed">ìƒë‹´ì™„ë£Œ</option>
        </select>
      </div>

      <!-- ìƒë‹´ ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ -->
      <div class="bulk-actions" id="consultBulkActions">
        <span class="selected-count"><span id="consultSelectedCount">0</span>ëª… ì„ íƒë¨</span>
        <button class="bulk-delete-btn" onclick="bulkDeleteConsultations()">ğŸ—‘ï¸ ì¼ê´„ ì‚­ì œ</button>
        <button class="bulk-cancel-btn" onclick="clearConsultSelection()">ì„ íƒ ì·¨ì†Œ</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="consultSelectAll" class="user-checkbox" onchange="toggleConsultSelectAll()"></th>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th>í•™êµ</th>
              <th>í•™ë…„</th>
              <th>ì—°ë½ì²˜</th>
              <th>ìƒíƒœ</th>
              <th>ì‹ ì²­ì¼</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="consultTableBody">
            <tr>
              <td colspan="9" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="show-more-btn" id="consultShowMoreBtn" style="display: none;" onclick="showMoreConsultations()">ë”ë³´ê¸° (<span id="consultRemainingCount">0</span>ëª… ë”)</button>
    </div>

    <!-- ëª¨ì˜ê³ ì‚¬ íšŒì› ê´€ë¦¬ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ‘¤ ëª¨ì˜ê³ ì‚¬ íšŒì› ê´€ë¦¬</span>
        <span class="count-badge" id="userCount">ì´ 0ëª…</span>
      </div>

      <div class="filter-section">
        <select id="userSearchGrade" onchange="filterUsers()">
          <option value="">ì „ì²´ í•™ë…„</option>
          <option value="ì¤‘1">ì¤‘1</option>
          <option value="ì¤‘2">ì¤‘2</option>
          <option value="ì¤‘3">ì¤‘3</option>
          <option value="ê³ 1">ê³ 1</option>
          <option value="ê³ 2">ê³ 2</option>
          <option value="ê³ 3">ê³ 3</option>
          <option value="Nìˆ˜">Nìˆ˜</option>
        </select>
        <input type="text" id="userSearchSchool" placeholder="í•™êµëª… ê²€ìƒ‰" oninput="filterUsers()">
        <input type="text" id="userSearchName" placeholder="ì´ë¦„ ê²€ìƒ‰" oninput="filterUsers()">
        <button class="add-btn" onclick="openAddUserModal()">+ íšŒì› ì¶”ê°€</button>
      </div>

      <!-- ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
      <div class="bulk-actions" id="bulkActions">
        <span class="selected-count"><span id="selectedCount">0</span>ëª… ì„ íƒë¨</span>
        <button class="bulk-ticket-btn" onclick="openBulkTicketModal()">ğŸ« ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬</button>
        <button class="bulk-delete-btn" onclick="bulkDeleteUsers()">ğŸ—‘ï¸ ì¼ê´„ ì‚­ì œ</button>
        <button class="bulk-cancel-btn" onclick="clearSelection()">ì„ íƒ ì·¨ì†Œ</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="selectAll" class="user-checkbox" onchange="toggleSelectAll()"></th>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th>í•™êµ</th>
              <th>í•™ë…„</th>
              <th>ì „í™”ë²ˆí˜¸</th>
              <th>ì´ìš©ê¶Œ</th>
              <th>ìƒíƒœ</th>
              <th class="sortable" id="sortAiTask" onclick="toggleAiTaskSort()">AIê³¼ì œ</th>
              <th>ê°€ì…ì¼</th>
              <th>ìµœê·¼ ë¡œê·¸ì¸</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <tr>
              <td colspan="12" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="show-more-btn" id="userShowMoreBtn" style="display: none;" onclick="showMoreUsers()">ë”ë³´ê¸° (<span id="userRemainingCount">0</span>ëª… ë”)</button>
    </div>

    <!-- ëª¨ì˜ê³ ì‚¬ ì‘ì‹œ ê²°ê³¼ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ“Š ëª¨ì˜ê³ ì‚¬ ì‘ì‹œ ëª©ë¡</span>
        <span class="count-badge" id="totalCount">ì´ 0ëª…</span>
      </div>

      <div class="filter-section">
        <select id="searchRound" onchange="filterResults()">
          <option value="">ì „ì²´ íšŒì°¨</option>
          <option value="korean_mock_1">1íšŒ</option>
          <option value="korean_mock_2">2íšŒ</option>
          <option value="korean_mock_3">3íšŒ</option>
          <option value="korean_mock_4">4íšŒ</option>
        </select>
        <input type="text" id="searchSchool" placeholder="í•™êµëª… ê²€ìƒ‰" oninput="filterResults()">
        <select id="searchGrade" onchange="filterResults()">
          <option value="">ì „ì²´ í•™ë…„</option>
          <option value="ì´ˆ4">ì´ˆ4</option>
          <option value="ì´ˆ5">ì´ˆ5</option>
          <option value="ì´ˆ6">ì´ˆ6</option>
          <option value="ì¤‘1">ì¤‘1</option>
          <option value="ì¤‘2">ì¤‘2</option>
          <option value="ì¤‘3">ì¤‘3</option>
          <option value="ê³ 1">ê³ 1</option>
          <option value="ê³ 2">ê³ 2</option>
          <option value="ê³ 3">ê³ 3</option>
        </select>
        <input type="text" id="searchName" placeholder="ì´ë¦„ ê²€ìƒ‰" oninput="filterResults()">
      </div>

      <!-- ì‘ì‹œê²°ê³¼ ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ -->
      <div class="bulk-actions" id="resultBulkActions">
        <span class="selected-count"><span id="resultSelectedCount">0</span>ëª… ì„ íƒë¨</span>
        <button class="bulk-delete-btn" onclick="bulkDeleteResults()">ğŸ—‘ï¸ ì¼ê´„ ì‚­ì œ</button>
        <button class="bulk-cancel-btn" onclick="clearResultSelection()">ì„ íƒ ì·¨ì†Œ</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="resultSelectAll" class="user-checkbox" onchange="toggleResultSelectAll()"></th>
              <th>ë²ˆí˜¸</th>
              <th>íšŒì°¨</th>
              <th>í•™êµëª…</th>
              <th>í•™ë…„</th>
              <th>ì´ë¦„</th>
              <th>ì „í™”ë²ˆí˜¸</th>
              <th>ì ìˆ˜</th>
              <th>ë“±ê¸‰</th>
              <th class="sortable" id="sortRank" onclick="toggleRankSort()">ìˆœìœ„</th>
              <th>ì‘ì‹œì¼</th>
              <th>ì‹œí—˜ì§€ ë³´ê¸°</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="resultTableBody">
            <tr>
              <td colspan="13" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="show-more-btn" id="resultShowMoreBtn" style="display: none;" onclick="showMoreResults()">ë”ë³´ê¸° (<span id="resultRemainingCount">0</span>ëª… ë”)</button>
    </div>
  </div>

  <!-- íšŒì› ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="userModal">
    <div class="modal-box">
      <div class="modal-title" id="userModalTitle">íšŒì› ì¶”ê°€</div>
      <form class="modal-form" id="userForm">
        <input type="hidden" id="userId">
        <div class="input-group">
          <label>ì´ë¦„</label>
          <input type="text" id="userName" required placeholder="ì´ë¦„ ì…ë ¥">
        </div>
        <div class="input-group">
          <label>í•™êµ</label>
          <input type="text" id="userSchool" required placeholder="ì˜ˆ: â—‹â—‹ê³ ë“±í•™êµ">
        </div>
        <div class="input-group">
          <label>í•™ë…„</label>
          <select id="userGrade" required>
            <option value="">í•™ë…„ ì„ íƒ</option>
            <option value="ì¤‘1">ì¤‘1</option>
            <option value="ì¤‘2">ì¤‘2</option>
            <option value="ì¤‘3">ì¤‘3</option>
            <option value="ê³ 1">ê³ 1</option>
            <option value="ê³ 2">ê³ 2</option>
            <option value="ê³ 3">ê³ 3</option>
            <option value="Nìˆ˜">Nìˆ˜</option>
          </select>
        </div>
        <div class="input-group">
          <label>ì „í™”ë²ˆí˜¸ <span style="font-weight: 400; color: #888;">(ë¹„ë°€ë²ˆí˜¸ë¡œ ì‚¬ìš©)</span></label>
          <input type="tel" id="userPhone" required placeholder="010-0000-0000">
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-cancel" onclick="closeUserModal()">ì·¨ì†Œ</button>
          <button type="submit" class="modal-btn modal-btn-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì‘ì‹œê²°ê³¼ ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-box">
      <div class="modal-title">í•™ìƒ ì •ë³´ ìˆ˜ì •</div>
      <form class="modal-form" id="editForm">
        <input type="hidden" id="editId">
        <div class="input-group">
          <label>í•™êµëª…</label>
          <input type="text" id="editSchool" required>
        </div>
        <div class="input-group">
          <label>í•™ë…„</label>
          <select id="editGradeLevel" required>
            <option value="ì´ˆ4">ì´ˆ4</option>
            <option value="ì´ˆ5">ì´ˆ5</option>
            <option value="ì´ˆ6">ì´ˆ6</option>
            <option value="ì¤‘1">ì¤‘1</option>
            <option value="ì¤‘2">ì¤‘2</option>
            <option value="ì¤‘3">ì¤‘3</option>
            <option value="ê³ 1">ê³ 1</option>
            <option value="ê³ 2">ê³ 2</option>
            <option value="ê³ 3">ê³ 3</option>
          </select>
        </div>
        <div class="input-group">
          <label>ì´ë¦„</label>
          <input type="text" id="editName" required>
        </div>
        <div class="input-group">
          <label>ì „í™”ë²ˆí˜¸</label>
          <input type="tel" id="editPhone" required>
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
          <button type="submit" class="modal-btn modal-btn-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allResults = [];
    let allUsers = [];
    let allConsultations = [];
    let rankSortOrder = null; // null, 'asc', 'desc'
    let aiTaskSortOrder = null; // null, 'asc', 'desc' (asc: ë¯¸ì™„ë£Œ ìˆœ)

    // í˜ì´ì§€ë‹¹ í‘œì‹œ ê°œìˆ˜
    const ITEMS_PER_PAGE = 10;

    // í˜„ì¬ í‘œì‹œ ê°œìˆ˜
    let consultDisplayCount = ITEMS_PER_PAGE;
    let userDisplayCount = ITEMS_PER_PAGE;
    let resultDisplayCount = ITEMS_PER_PAGE;

    // ì„ íƒëœ IDë“¤
    let selectedConsultIds = [];
    let selectedResultIds = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
      loadConsultations();
      loadUsers();
      loadResults();
      loadZoomLink();
    });

    // ===== ì¤Œ ë§í¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
    async function loadZoomLink() {
      try {
        const response = await fetch('/api/zoom-link');
        const data = await response.json();
        if (data.success && data.zoomLink) {
          document.getElementById('zoomLinkInput').value = data.zoomLink;
          document.getElementById('savedZoomLinkDisplay').innerHTML =
            `<a href="${data.zoomLink}" target="_blank" style="color: #2563eb;">${data.zoomLink}</a>`;
        }
      } catch (error) {
        console.error('ì¤Œ ë§í¬ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    async function saveZoomLink() {
      const zoomLink = document.getElementById('zoomLinkInput').value.trim();
      if (!zoomLink) {
        alert('ì¤Œ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch('/api/zoom-link', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ zoomLink })
        });
        const data = await response.json();
        if (data.success) {
          alert('ì¤Œ ë§í¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          document.getElementById('savedZoomLinkDisplay').innerHTML =
            `<a href="${zoomLink}" target="_blank" style="color: #2563eb;">${zoomLink}</a>`;
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + data.message);
        }
      } catch (error) {
        console.error('ì¤Œ ë§í¬ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== ìƒë‹´ ì‹ ì²­ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
    let filteredConsultations = [];

    async function loadConsultations() {
      const searchGrade = document.getElementById('consultSearchGrade').value;
      const searchName = document.getElementById('consultSearchName').value.trim();
      const searchStatus = document.getElementById('consultSearchStatus').value;

      // ê²€ìƒ‰ ì‹œ í‘œì‹œ ê°œìˆ˜ ì´ˆê¸°í™”
      consultDisplayCount = ITEMS_PER_PAGE;
      selectedConsultIds = [];
      clearConsultSelection();

      try {
        const response = await fetch('/api/mock-exam/admin/consultations');
        const data = await response.json();

        if (data.ok) {
          allConsultations = data.consultations || [];

          // í•„í„°ë§
          filteredConsultations = allConsultations;
          if (searchGrade) {
            filteredConsultations = filteredConsultations.filter(c => c.grade === searchGrade);
          }
          if (searchName) {
            filteredConsultations = filteredConsultations.filter(c => c.name?.includes(searchName));
          }
          if (searchStatus) {
            filteredConsultations = filteredConsultations.filter(c => c.status === searchStatus);
          }

          renderConsultTable(filteredConsultations);
          document.getElementById('consultCount').textContent = `ì´ ${filteredConsultations.length}ëª…`;
        } else {
          showConsultError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showConsultError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìƒë‹´ ì‹¤ì‹œê°„ í•„í„°ë§ í•¨ìˆ˜
    function filterConsultations() {
      const searchGrade = document.getElementById('consultSearchGrade').value;
      const searchName = document.getElementById('consultSearchName').value.trim().toLowerCase();
      const searchStatus = document.getElementById('consultSearchStatus').value;

      filteredConsultations = allConsultations.filter(c => {
        const gradeMatch = !searchGrade || c.grade === searchGrade;
        const nameMatch = !searchName || (c.name && c.name.toLowerCase().includes(searchName));
        const statusMatch = !searchStatus || c.status === searchStatus;
        return gradeMatch && nameMatch && statusMatch;
      });

      consultDisplayCount = ITEMS_PER_PAGE;
      renderConsultTable(filteredConsultations);
      document.getElementById('consultCount').textContent = `ì´ ${filteredConsultations.length}ëª…`;
    }

    function renderConsultTable(consultations) {
      const tbody = document.getElementById('consultTableBody');
      const showMoreBtn = document.getElementById('consultShowMoreBtn');

      if (consultations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-message">ìƒë‹´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        showMoreBtn.style.display = 'none';
        return;
      }

      // í‘œì‹œí•  ë°ì´í„°ë§Œ ì¶”ì¶œ
      const displayData = consultations.slice(0, consultDisplayCount);
      const remaining = consultations.length - consultDisplayCount;

      tbody.innerHTML = displayData.map((c, idx) => {
        const statusClass = c.status === 'pending' ? 'consult-status-pending' :
                           c.status === 'contacted' ? 'consult-status-contacted' : 'consult-status-completed';
        const statusText = c.status === 'pending' ? 'ëŒ€ê¸°' :
                          c.status === 'contacted' ? 'ì—°ë½ì™„ë£Œ' : 'ìƒë‹´ì™„ë£Œ';
        const isChecked = selectedConsultIds.includes(c._id) ? 'checked' : '';

        return `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" class="user-checkbox consult-row-checkbox" data-consult-id="${c._id}" ${isChecked} onchange="updateConsultSelection()"></td>
          <td>${idx + 1}</td>
          <td>${c.name || '-'}</td>
          <td>${c.school || '-'}</td>
          <td>${c.grade || '-'}</td>
          <td>${c.phone || '-'}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${formatDate(c.createdAt)}</td>
          <td>
            ${c.status === 'pending' ?
              `<button class="consult-btn consult-btn-contact" onclick="updateConsultStatus('${c._id}', 'contacted')">ì—°ë½ì™„ë£Œ</button>` : ''}
            ${c.status !== 'completed' ?
              `<button class="consult-btn consult-btn-complete" onclick="updateConsultStatus('${c._id}', 'completed')">ìƒë‹´ì™„ë£Œ</button>` : ''}
            <button class="delete-btn" onclick="deleteConsultation('${c._id}')">ì‚­ì œ</button>
          </td>
        </tr>
      `}).join('');

      // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (remaining > 0) {
        document.getElementById('consultRemainingCount').textContent = remaining;
        showMoreBtn.style.display = 'block';
      } else {
        showMoreBtn.style.display = 'none';
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
      document.getElementById('consultSelectAll').checked = false;
    }

    function showMoreConsultations() {
      consultDisplayCount += ITEMS_PER_PAGE;
      renderConsultTable(filteredConsultations);
    }

    function showConsultError(msg) {
      document.getElementById('consultTableBody').innerHTML = `<tr><td colspan="9" class="empty-message">${msg}</td></tr>`;
    }

    // ìƒë‹´ ì²´í¬ë°•ìŠ¤ ê´€ë ¨
    function toggleConsultSelectAll() {
      const selectAllCheckbox = document.getElementById('consultSelectAll');
      const rowCheckboxes = document.querySelectorAll('.consult-row-checkbox');

      rowCheckboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
      });

      updateConsultSelection();
    }

    function updateConsultSelection() {
      const rowCheckboxes = document.querySelectorAll('.consult-row-checkbox');
      selectedConsultIds = [];

      rowCheckboxes.forEach(cb => {
        if (cb.checked) {
          selectedConsultIds.push(cb.getAttribute('data-consult-id'));
        }
      });

      document.getElementById('consultSelectedCount').textContent = selectedConsultIds.length;

      const bulkActions = document.getElementById('consultBulkActions');
      if (selectedConsultIds.length > 0) {
        bulkActions.classList.add('active');
      } else {
        bulkActions.classList.remove('active');
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
      const selectAllCheckbox = document.getElementById('consultSelectAll');
      if (selectedConsultIds.length === rowCheckboxes.length && rowCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedConsultIds.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function clearConsultSelection() {
      const rowCheckboxes = document.querySelectorAll('.consult-row-checkbox');
      rowCheckboxes.forEach(cb => cb.checked = false);

      selectedConsultIds = [];
      document.getElementById('consultSelectedCount').textContent = 0;
      document.getElementById('consultBulkActions').classList.remove('active');
      document.getElementById('consultSelectAll').checked = false;
      document.getElementById('consultSelectAll').indeterminate = false;
    }

    async function bulkDeleteConsultations() {
      if (selectedConsultIds.length === 0) {
        alert('ì‚­ì œí•  ìƒë‹´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(`ì„ íƒí•œ ${selectedConsultIds.length}ê°œì˜ ìƒë‹´ ì‹ ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        let successCount = 0;
        for (const id of selectedConsultIds) {
          const response = await fetch(`/api/mock-exam/admin/consultations/${id}`, { method: 'DELETE' });
          const data = await response.json();
          if (data.ok) successCount++;
        }

        alert(`${successCount}ê°œì˜ ìƒë‹´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        selectedConsultIds = [];
        loadConsultations();
      } catch (err) {
        console.error(err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function updateConsultStatus(id, status) {
      const statusText = status === 'contacted' ? 'ì—°ë½ì™„ë£Œ' : 'ìƒë‹´ì™„ë£Œ';
      if (!confirm(`${statusText} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const response = await fetch(`/api/mock-exam/admin/consultations/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        const data = await response.json();
        if (data.ok) {
          alert(`${statusText} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          loadConsultations();
        } else {
          alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteConsultation(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await fetch(`/api/mock-exam/admin/consultations/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadConsultations();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== íšŒì› ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
    let filteredUsers = [];

    async function loadUsers() {
      const searchGrade = document.getElementById('userSearchGrade').value;
      const searchSchool = document.getElementById('userSearchSchool').value.trim();
      const searchName = document.getElementById('userSearchName').value.trim();

      // ê²€ìƒ‰ ì‹œ í‘œì‹œ ê°œìˆ˜ ì´ˆê¸°í™”
      userDisplayCount = ITEMS_PER_PAGE;
      selectedUserIds = [];
      clearSelection();

      try {
        const response = await fetch('/api/mock-exam/admin/users');
        const data = await response.json();

        if (data.ok) {
          allUsers = data.users;

          // í•„í„°ë§
          filteredUsers = allUsers;
          if (searchGrade) {
            filteredUsers = filteredUsers.filter(u => u.grade === searchGrade);
          }
          if (searchSchool) {
            filteredUsers = filteredUsers.filter(u => u.school?.includes(searchSchool));
          }
          if (searchName) {
            filteredUsers = filteredUsers.filter(u => u.name?.includes(searchName));
          }

          renderUserTable(filteredUsers);
          document.getElementById('userCount').textContent = `ì´ ${filteredUsers.length}ëª…`;
        } else {
          showUserError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showUserError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // íšŒì› ì‹¤ì‹œê°„ í•„í„°ë§ í•¨ìˆ˜
    function filterUsers() {
      const searchGrade = document.getElementById('userSearchGrade').value;
      const searchSchool = document.getElementById('userSearchSchool').value.trim().toLowerCase();
      const searchName = document.getElementById('userSearchName').value.trim().toLowerCase();

      filteredUsers = allUsers.filter(u => {
        const gradeMatch = !searchGrade || u.grade === searchGrade;
        const schoolMatch = !searchSchool || (u.school && u.school.toLowerCase().includes(searchSchool));
        const nameMatch = !searchName || (u.name && u.name.toLowerCase().includes(searchName));
        return gradeMatch && schoolMatch && nameMatch;
      });

      userDisplayCount = ITEMS_PER_PAGE;
      renderUserTable(filteredUsers);
      document.getElementById('userCount').textContent = `ì´ ${filteredUsers.length}ëª…`;
    }

    function renderUserTable(users) {
      const tbody = document.getElementById('userTableBody');
      const showMoreBtn = document.getElementById('userShowMoreBtn');

      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="empty-message">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        showMoreBtn.style.display = 'none';
        return;
      }

      // í‘œì‹œí•  ë°ì´í„°ë§Œ ì¶”ì¶œ
      const displayData = users.slice(0, userDisplayCount);
      const remaining = users.length - userDisplayCount;

      tbody.innerHTML = displayData.map((u, idx) => {
        const statusClass = u.status === 'active' ? 'status-active' :
                           u.status === 'suspended' ? 'status-suspended' : 'status-inactive';
        const statusText = u.status === 'active' ? 'í™œì„±' :
                          u.status === 'suspended' ? 'ì •ì§€' : 'ë¹„í™œì„±';
        const isChecked = selectedUserIds.includes(u._id) ? 'checked' : '';

        // AIê³¼ì œ ë°°ì§€ ìƒ‰ìƒ ê²°ì •
        const aiCompleted = u.aiTaskCompleted || 0;
        const aiTotal = u.aiTaskTotal || 0;
        let aiTaskBadgeClass = 'ai-task-none';
        if (aiTotal > 0) {
          if (aiCompleted === aiTotal) {
            aiTaskBadgeClass = 'ai-task-complete';
          } else if (aiCompleted > 0) {
            aiTaskBadgeClass = 'ai-task-progress';
          } else {
            aiTaskBadgeClass = 'ai-task-pending';
          }
        }

        return `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" class="user-checkbox user-row-checkbox" data-user-id="${u._id}" ${isChecked} onchange="updateSelection()"></td>
          <td>${idx + 1}</td>
          <td><span class="user-name-link" onclick="goToStudentDashboard('${u._id}', '${u.name}')">${u.name || '-'}</span></td>
          <td>${u.school || '-'}</td>
          <td>${u.grade || '-'}</td>
          <td>${u.phone || '-'}</td>
          <td><span class="ticket-btn" onclick="openTicketModal('${u._id}', '${u.name}', ${u.tickets || 0})">${u.tickets || 0}íšŒ</span></td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td><span class="ai-task-badge ${aiTaskBadgeClass}" onclick="shareAiTaskKakao('${u._id}', '${u.name}', ${aiCompleted}, ${aiTotal})" style="cursor: pointer;" title="í´ë¦­í•˜ì—¬ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ ">${aiTotal > 0 ? `${aiCompleted}/${aiTotal}` : '-'}</span></td>
          <td>${formatDate(u.createdAt)}</td>
          <td>${u.lastLogin ? formatDate(u.lastLogin) : '-'}</td>
          <td>
            <button class="edit-btn" onclick="openEditUserModal('${u._id}')">ìˆ˜ì •</button>
            ${u.status === 'active' ?
              `<button class="status-btn status-btn-suspend" onclick="changeUserStatus('${u._id}', 'suspended')">ì •ì§€</button>` :
              `<button class="status-btn status-btn-activate" onclick="changeUserStatus('${u._id}', 'active')">í™œì„±í™”</button>`
            }
            <button class="delete-btn" onclick="deleteUser('${u._id}')">ì‚­ì œ</button>
          </td>
        </tr>
      `}).join('');

      // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (remaining > 0) {
        document.getElementById('userRemainingCount').textContent = remaining;
        showMoreBtn.style.display = 'block';
      } else {
        showMoreBtn.style.display = 'none';
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
      document.getElementById('selectAll').checked = false;
    }

    function showMoreUsers() {
      userDisplayCount += ITEMS_PER_PAGE;
      renderUserTable(filteredUsers);
    }

    // AIê³¼ì œ ì •ë ¬ í† ê¸€
    function toggleAiTaskSort() {
      const sortBtn = document.getElementById('sortAiTask');

      if (aiTaskSortOrder === null || aiTaskSortOrder === 'desc') {
        aiTaskSortOrder = 'asc';
        sortBtn.className = 'sortable asc';
      } else {
        aiTaskSortOrder = 'desc';
        sortBtn.className = 'sortable desc';
      }

      // ë¯¸ì™„ë£Œ ê³¼ì œê°€ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬ (asc: ë¯¸ì™„ë£Œ ìˆœ)
      if (aiTaskSortOrder === 'asc') {
        // ë¯¸ì™„ë£Œ ìˆœ: ê³¼ì œê°€ ìˆê³  ì™„ë£Œìœ¨ì´ ë‚®ì€ ìˆœ
        filteredUsers = [...filteredUsers].sort((a, b) => {
          const aTotal = a.aiTaskTotal || 0;
          const bTotal = b.aiTaskTotal || 0;
          const aCompleted = a.aiTaskCompleted || 0;
          const bCompleted = b.aiTaskCompleted || 0;
          const aRemaining = aTotal - aCompleted;
          const bRemaining = bTotal - bCompleted;

          // ê³¼ì œê°€ ìˆëŠ” ì‚¬ëŒ ìš°ì„ 
          if (aTotal > 0 && bTotal === 0) return -1;
          if (aTotal === 0 && bTotal > 0) return 1;
          if (aTotal === 0 && bTotal === 0) return 0;

          // ë¯¸ì™„ë£Œ ê°œìˆ˜ê°€ ë§ì€ ìˆœ
          return bRemaining - aRemaining;
        });
      } else {
        // ì™„ë£Œ ìˆœ: ì™„ë£Œìœ¨ì´ ë†’ì€ ìˆœ
        filteredUsers = [...filteredUsers].sort((a, b) => {
          const aTotal = a.aiTaskTotal || 0;
          const bTotal = b.aiTaskTotal || 0;
          const aCompleted = a.aiTaskCompleted || 0;
          const bCompleted = b.aiTaskCompleted || 0;

          // ê³¼ì œê°€ ìˆëŠ” ì‚¬ëŒ ìš°ì„ 
          if (aTotal > 0 && bTotal === 0) return -1;
          if (aTotal === 0 && bTotal > 0) return 1;
          if (aTotal === 0 && bTotal === 0) return 0;

          // ì™„ë£Œ ê°œìˆ˜ê°€ ë§ì€ ìˆœ
          return bCompleted - aCompleted;
        });
      }

      userDisplayCount = ITEMS_PER_PAGE;
      renderUserTable(filteredUsers);
    }

    function showUserError(msg) {
      document.getElementById('userTableBody').innerHTML = `<tr><td colspan="12" class="empty-message">${msg}</td></tr>`;
    }

    // íšŒì› ì¼ê´„ ì‚­ì œ
    async function bulkDeleteUsers() {
      if (selectedUserIds.length === 0) {
        alert('ì‚­ì œí•  íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(`ì„ íƒí•œ ${selectedUserIds.length}ëª…ì˜ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ íšŒì›ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

      try {
        let successCount = 0;
        for (const id of selectedUserIds) {
          const response = await fetch(`/api/mock-exam/admin/users/${id}`, { method: 'DELETE' });
          const data = await response.json();
          if (data.ok) successCount++;
        }

        alert(`${successCount}ëª…ì˜ íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        selectedUserIds = [];
        loadUsers();
      } catch (err) {
        console.error(err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function openAddUserModal() {
      document.getElementById('userModalTitle').textContent = 'íšŒì› ì¶”ê°€';
      document.getElementById('userId').value = '';
      document.getElementById('userName').value = '';
      document.getElementById('userSchool').value = '';
      document.getElementById('userGrade').value = '';
      document.getElementById('userPhone').value = '';
      document.getElementById('userModal').classList.add('active');
    }

    function openEditUserModal(id) {
      const user = allUsers.find(u => u._id === id);
      if (!user) return;

      document.getElementById('userModalTitle').textContent = 'íšŒì› ì •ë³´ ìˆ˜ì •';
      document.getElementById('userId').value = id;
      document.getElementById('userName').value = user.name || '';
      document.getElementById('userSchool').value = user.school || '';
      document.getElementById('userGrade').value = user.grade || '';
      document.getElementById('userPhone').value = user.phone || '';
      document.getElementById('userModal').classList.add('active');
    }

    function closeUserModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
    function formatPhoneInput(input) {
      let value = input.value.replace(/[^0-9]/g, '');
      if (value.length > 3 && value.length <= 7) {
        value = value.slice(0, 3) + '-' + value.slice(3);
      } else if (value.length > 7) {
        value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
      }
      input.value = value;
    }

    document.getElementById('userPhone').addEventListener('input', function() { formatPhoneInput(this); });

    document.getElementById('userForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const id = document.getElementById('userId').value;
      const userData = {
        name: document.getElementById('userName').value.trim(),
        school: document.getElementById('userSchool').value.trim(),
        grade: document.getElementById('userGrade').value,
        phone: document.getElementById('userPhone').value.trim()
      };

      try {
        let response;
        if (id) {
          // ìˆ˜ì •
          response = await fetch(`/api/mock-exam/admin/users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
          });
        } else {
          // ì¶”ê°€ (íšŒì›ê°€ì… API ì‚¬ìš©)
          response = await fetch('/api/mock-exam/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
          });
        }

        const data = await response.json();
        if (data.ok) {
          alert(id ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'íšŒì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeUserModal();
          loadUsers();
        } else {
          alert((id ? 'ìˆ˜ì •' : 'ì¶”ê°€') + 'ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    async function changeUserStatus(id, status) {
      const statusText = status === 'active' ? 'í™œì„±í™”' : 'ì •ì§€';
      if (!confirm(`ì •ë§ ${statusText} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const response = await fetch(`/api/mock-exam/admin/users/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        const data = await response.json();
        if (data.ok) {
          alert(`${statusText} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          loadUsers();
        } else {
          alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteUser(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ íšŒì›ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

      try {
        const response = await fetch(`/api/mock-exam/admin/users/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadUsers();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message));
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('userModal').addEventListener('click', function(e) {
      if (e.target === this) closeUserModal();
    });

    // ===== ì‘ì‹œ ê²°ê³¼ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
    let filteredResults = [];

    // ìˆœìœ„ ì •ë ¬ í† ê¸€
    function toggleRankSort() {
      const sortBtn = document.getElementById('sortRank');

      if (rankSortOrder === null || rankSortOrder === 'desc') {
        rankSortOrder = 'asc';
        sortBtn.className = 'sortable asc';
      } else {
        rankSortOrder = 'desc';
        sortBtn.className = 'sortable desc';
      }

      // ì ìˆ˜ ê¸°ì¤€ ì •ë ¬ (ìˆœìœ„ = ì ìˆ˜ ì—­ìˆœ)
      if (rankSortOrder === 'asc') {
        filteredResults = [...filteredResults].sort((a, b) => (b.score || 0) - (a.score || 0));
      } else {
        filteredResults = [...filteredResults].sort((a, b) => (a.score || 0) - (b.score || 0));
      }

      renderTable(filteredResults);
    }

    async function loadResults() {
      const searchRound = document.getElementById('searchRound').value;
      const searchSchool = document.getElementById('searchSchool').value.trim();
      const searchGrade = document.getElementById('searchGrade').value;
      const searchName = document.getElementById('searchName').value.trim();

      // ê²€ìƒ‰ ì‹œ í‘œì‹œ ê°œìˆ˜ ì´ˆê¸°í™”
      resultDisplayCount = ITEMS_PER_PAGE;
      selectedResultIds = [];
      clearResultSelection();

      try {
        const response = await fetch('/api/mock-exam/admin/results');
        const data = await response.json();

        if (data.ok) {
          allResults = data.results;

          // í•„í„°ë§
          filteredResults = allResults;
          if (searchRound) {
            filteredResults = filteredResults.filter(r => r.examId === searchRound);
          }
          if (searchSchool) {
            filteredResults = filteredResults.filter(r => r.studentInfo?.schoolName?.includes(searchSchool));
          }
          if (searchGrade) {
            filteredResults = filteredResults.filter(r => r.studentInfo?.grade === searchGrade);
          }
          if (searchName) {
            filteredResults = filteredResults.filter(r => r.studentInfo?.studentName?.includes(searchName));
          }

          renderTable(filteredResults);
          document.getElementById('totalCount').textContent = `ì´ ${filteredResults.length}ëª…`;
        } else {
          showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì‘ì‹œ ê²°ê³¼ ì‹¤ì‹œê°„ í•„í„°ë§ í•¨ìˆ˜
    function filterResults() {
      const searchRound = document.getElementById('searchRound').value;
      const searchSchool = document.getElementById('searchSchool').value.trim().toLowerCase();
      const searchGrade = document.getElementById('searchGrade').value;
      const searchName = document.getElementById('searchName').value.trim().toLowerCase();

      filteredResults = allResults.filter(r => {
        const roundMatch = !searchRound || r.examId === searchRound;
        const schoolMatch = !searchSchool || (r.studentInfo?.schoolName && r.studentInfo.schoolName.toLowerCase().includes(searchSchool));
        const gradeMatch = !searchGrade || r.studentInfo?.grade === searchGrade;
        const nameMatch = !searchName || (r.studentInfo?.studentName && r.studentInfo.studentName.toLowerCase().includes(searchName));
        return roundMatch && schoolMatch && gradeMatch && nameMatch;
      });

      resultDisplayCount = ITEMS_PER_PAGE;
      renderTable(filteredResults);
      document.getElementById('totalCount').textContent = `ì´ ${filteredResults.length}ëª…`;
    }

    // ì ìˆ˜ ê¸°ì¤€ ë“±ê¸‰ ê³„ì‚° í•¨ìˆ˜ - 1íšŒì°¨ ê¸°ì¤€: ì „ì²´ 4ì  í•˜í–¥
    function calculateGradeRound1(score) {
      if (score >= 93) return { grade: 1, text: '1ë“±ê¸‰ ìƒ' };
      if (score >= 90) return { grade: 1, text: '1ë“±ê¸‰ ì¤‘' };
      if (score >= 87) return { grade: 1, text: '1ë“±ê¸‰ í•˜' };
      if (score >= 84) return { grade: 2, text: '2ë“±ê¸‰ ìƒ' };
      if (score >= 81) return { grade: 2, text: '2ë“±ê¸‰ ì¤‘' };
      if (score >= 78) return { grade: 2, text: '2ë“±ê¸‰ í•˜' };
      if (score >= 74) return { grade: 3, text: '3ë“±ê¸‰ ìƒ' };
      if (score >= 70) return { grade: 3, text: '3ë“±ê¸‰ ì¤‘' };
      if (score >= 66) return { grade: 3, text: '3ë“±ê¸‰ í•˜' };
      if (score >= 63) return { grade: 4, text: '4ë“±ê¸‰ ìƒ' };
      if (score >= 59) return { grade: 4, text: '4ë“±ê¸‰ ì¤‘' };
      if (score >= 55) return { grade: 4, text: '4ë“±ê¸‰ í•˜' };
      return { grade: 5, text: '5ë“±ê¸‰' };
    }

    // 2íšŒì°¨, 3íšŒì°¨ ë“±ê¸‰ ê³„ì‚° í•¨ìˆ˜ - 1íšŒì°¨ ëŒ€ë¹„ 6ì ì”© í•˜í–¥ (ë‚œì´ë„ ìƒí–¥ìœ¼ë¡œ ì¸í•œ ì¡°ì •)
    function calculateGradeRound2(score) {
      if (score >= 91) return { grade: 1, text: '1ë“±ê¸‰ ìƒ' };
      if (score >= 88) return { grade: 1, text: '1ë“±ê¸‰ ì¤‘' };
      if (score >= 85) return { grade: 1, text: '1ë“±ê¸‰ í•˜' };
      if (score >= 82) return { grade: 2, text: '2ë“±ê¸‰ ìƒ' };
      if (score >= 79) return { grade: 2, text: '2ë“±ê¸‰ ì¤‘' };
      if (score >= 76) return { grade: 2, text: '2ë“±ê¸‰ í•˜' };
      if (score >= 72) return { grade: 3, text: '3ë“±ê¸‰ ìƒ' };
      if (score >= 68) return { grade: 3, text: '3ë“±ê¸‰ ì¤‘' };
      if (score >= 64) return { grade: 3, text: '3ë“±ê¸‰ í•˜' };
      if (score >= 61) return { grade: 4, text: '4ë“±ê¸‰ ìƒ' };
      if (score >= 57) return { grade: 4, text: '4ë“±ê¸‰ ì¤‘' };
      if (score >= 53) return { grade: 4, text: '4ë“±ê¸‰ í•˜' };
      return { grade: 5, text: '5ë“±ê¸‰' };
    }

    // íšŒì°¨ë³„ ë“±ê¸‰ ê³„ì‚° ë¶„ê¸°
    function calculateGrade(score, examId) {
      if (examId === 'korean_mock_2' || examId === 'korean_mock_3' || examId === 'korean_mock_4') {
        return calculateGradeRound2(score);
      }
      return calculateGradeRound1(score);
    }

    // íšŒì°¨ë³„ ì‹œí—˜ì§€ URL ë°˜í™˜
    function getExamUrl(examId) {
      const examUrls = {
        'korean_mock_1': '/mock_exam_korean.html',
        'korean_mock_2': '/mock_exam_korean2.html',
        'korean_mock_3': '/mock_exam_korean3.html',
        'korean_mock_4': '/mock_exam_korean4.html'
      };
      return examUrls[examId] || '/mock_exam_korean.html';
    }

    function renderTable(results) {
      const tbody = document.getElementById('resultTableBody');
      const showMoreBtn = document.getElementById('resultShowMoreBtn');

      if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="empty-message">ë“±ë¡ëœ ì‘ì‹œìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        showMoreBtn.style.display = 'none';
        return;
      }

      // íšŒì°¨ë³„ ìˆœìœ„ ê³„ì‚°
      const rankByExam = {};

      // íšŒì°¨ë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìˆœìœ„ ë¶€ì—¬
      results.forEach(r => {
        const examId = r.examId || 'korean_mock_1';
        if (!rankByExam[examId]) {
          rankByExam[examId] = [];
        }
        rankByExam[examId].push({ id: r._id, score: r.score || 0 });
      });

      // ê° íšŒì°¨ë³„ë¡œ ì ìˆ˜ ìˆœ ì •ë ¬ í›„ ìˆœìœ„ ë¶€ì—¬
      const rankMap = {};
      Object.keys(rankByExam).forEach(examId => {
        const sorted = rankByExam[examId].sort((a, b) => b.score - a.score);
        sorted.forEach((item, idx) => {
          // ë™ì ì ì²˜ë¦¬: ê°™ì€ ì ìˆ˜ë©´ ê°™ì€ ìˆœìœ„
          if (idx > 0 && sorted[idx - 1].score === item.score) {
            rankMap[item.id] = rankMap[sorted[idx - 1].id];
          } else {
            rankMap[item.id] = idx + 1;
          }
        });
      });

      // íšŒì°¨ë³„ ì´ ì¸ì›ìˆ˜
      const totalByExam = {};
      Object.keys(rankByExam).forEach(examId => {
        totalByExam[examId] = rankByExam[examId].length;
      });

      // í‘œì‹œí•  ë°ì´í„°ë§Œ ì¶”ì¶œ
      const displayData = results.slice(0, resultDisplayCount);
      const remaining = results.length - resultDisplayCount;

      tbody.innerHTML = displayData.map((r, idx) => {
        // examIdì—ì„œ íšŒì°¨ ì¶”ì¶œ (korean_mock_1 -> 1íšŒ)
        const examId = r.examId || 'korean_mock_1';
        const gradeInfo = calculateGrade(r.score || 0, examId);
        const examRound = examId.replace(/[^0-9]/g, '') + 'íšŒ';
        const rank = rankMap[r._id] || '-';
        const total = totalByExam[examId] || 0;
        const isChecked = selectedResultIds.includes(r._id) ? 'checked' : '';
        return `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" class="user-checkbox result-row-checkbox" data-result-id="${r._id}" ${isChecked} onchange="updateResultSelection()"></td>
          <td>${idx + 1}</td>
          <td>${examRound}</td>
          <td>${r.studentInfo?.schoolName || '-'}</td>
          <td>${r.studentInfo?.grade || '-'}</td>
          <td><span class="user-name-link" onclick="goToStudentDashboardByPhone('${r.studentInfo?.phoneNumber || ''}', '${r.studentInfo?.studentName || ''}')">${r.studentInfo?.studentName || '-'}</span></td>
          <td>${r.studentInfo?.phoneNumber || '-'}</td>
          <td class="score-text">${r.score || 0}ì  (${r.correctCount || 0}/45)</td>
          <td><span class="grade-badge grade-${gradeInfo.grade}">${gradeInfo.text}</span></td>
          <td><strong>${rank}</strong> / ${total}</td>
          <td>${formatDate(r.completedAt)}</td>
          <td><a href="${getExamUrl(examId)}?view=${r._id}" target="_blank" class="view-btn">ì‹œí—˜ì§€ ë³´ê¸°</a></td>
          <td>
            <button class="edit-btn" onclick="openEditModal('${r._id}')">ìˆ˜ì •</button>
            <button class="delete-btn" onclick="deleteResult('${r._id}')">ì‚­ì œ</button>
          </td>
        </tr>
      `}).join('');

      // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (remaining > 0) {
        document.getElementById('resultRemainingCount').textContent = remaining;
        showMoreBtn.style.display = 'block';
      } else {
        showMoreBtn.style.display = 'none';
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
      document.getElementById('resultSelectAll').checked = false;
    }

    function showMoreResults() {
      resultDisplayCount += ITEMS_PER_PAGE;
      renderTable(filteredResults);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function showError(msg) {
      document.getElementById('resultTableBody').innerHTML = `<tr><td colspan="13" class="empty-message">${msg}</td></tr>`;
    }

    // ì‘ì‹œ ê²°ê³¼ ì²´í¬ë°•ìŠ¤ ê´€ë ¨
    function toggleResultSelectAll() {
      const selectAllCheckbox = document.getElementById('resultSelectAll');
      const rowCheckboxes = document.querySelectorAll('.result-row-checkbox');

      rowCheckboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
      });

      updateResultSelection();
    }

    function updateResultSelection() {
      const rowCheckboxes = document.querySelectorAll('.result-row-checkbox');
      selectedResultIds = [];

      rowCheckboxes.forEach(cb => {
        if (cb.checked) {
          selectedResultIds.push(cb.getAttribute('data-result-id'));
        }
      });

      document.getElementById('resultSelectedCount').textContent = selectedResultIds.length;

      const bulkActions = document.getElementById('resultBulkActions');
      if (selectedResultIds.length > 0) {
        bulkActions.classList.add('active');
      } else {
        bulkActions.classList.remove('active');
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
      const selectAllCheckbox = document.getElementById('resultSelectAll');
      if (selectedResultIds.length === rowCheckboxes.length && rowCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedResultIds.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function clearResultSelection() {
      const rowCheckboxes = document.querySelectorAll('.result-row-checkbox');
      rowCheckboxes.forEach(cb => cb.checked = false);

      selectedResultIds = [];
      document.getElementById('resultSelectedCount').textContent = 0;
      document.getElementById('resultBulkActions').classList.remove('active');
      document.getElementById('resultSelectAll').checked = false;
      document.getElementById('resultSelectAll').indeterminate = false;
    }

    async function bulkDeleteResults() {
      if (selectedResultIds.length === 0) {
        alert('ì‚­ì œí•  ì‘ì‹œ ê²°ê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(`ì„ íƒí•œ ${selectedResultIds.length}ê°œì˜ ì‘ì‹œ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        let successCount = 0;
        for (const id of selectedResultIds) {
          const response = await fetch(`/api/mock-exam/admin/delete/${id}`, { method: 'DELETE' });
          const data = await response.json();
          if (data.ok) successCount++;
        }

        alert(`${successCount}ê°œì˜ ì‘ì‹œ ê²°ê³¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        selectedResultIds = [];
        loadResults();
      } catch (err) {
        console.error(err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function openEditModal(id) {
      const result = allResults.find(r => r._id === id);
      if (!result) return;

      document.getElementById('editId').value = id;
      document.getElementById('editSchool').value = result.studentInfo?.schoolName || '';
      document.getElementById('editGradeLevel').value = result.studentInfo?.grade || '1';
      document.getElementById('editName').value = result.studentInfo?.studentName || '';
      document.getElementById('editPhone').value = result.studentInfo?.phoneNumber || '';

      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const id = document.getElementById('editId').value;
      const studentInfo = {
        schoolName: document.getElementById('editSchool').value,
        grade: document.getElementById('editGradeLevel').value,
        studentName: document.getElementById('editName').value,
        phoneNumber: document.getElementById('editPhone').value
      };

      try {
        const response = await fetch(`/api/mock-exam/admin/update/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentInfo })
        });

        const data = await response.json();
        if (data.ok) {
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeEditModal();
          loadResults();
        } else {
          alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    async function deleteResult(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await fetch(`/api/mock-exam/admin/delete/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadResults();
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
      } catch (err) {
        console.error(err);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) closeEditModal();
    });

    // ========== ì²´í¬ë°•ìŠ¤ ì„ íƒ ê´€ë ¨ ==========
    let selectedUserIds = [];

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const rowCheckboxes = document.querySelectorAll('.user-row-checkbox');

      rowCheckboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
      });

      updateSelection();
    }

    function updateSelection() {
      const rowCheckboxes = document.querySelectorAll('.user-row-checkbox');
      selectedUserIds = [];

      rowCheckboxes.forEach(cb => {
        if (cb.checked) {
          selectedUserIds.push(cb.getAttribute('data-user-id'));
        }
      });

      // ì„ íƒëœ ìˆ˜ ì—…ë°ì´íŠ¸
      document.getElementById('selectedCount').textContent = selectedUserIds.length;

      // ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
      const bulkActions = document.getElementById('bulkActions');
      if (selectedUserIds.length > 0) {
        bulkActions.classList.add('active');
      } else {
        bulkActions.classList.remove('active');
      }

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      const selectAllCheckbox = document.getElementById('selectAll');
      if (selectedUserIds.length === rowCheckboxes.length && rowCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedUserIds.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function clearSelection() {
      const rowCheckboxes = document.querySelectorAll('.user-row-checkbox');
      rowCheckboxes.forEach(cb => {
        cb.checked = false;
      });

      selectedUserIds = [];
      document.getElementById('selectedCount').textContent = 0;
      document.getElementById('bulkActions').classList.remove('active');
      document.getElementById('selectAll').checked = false;
      document.getElementById('selectAll').indeterminate = false;
    }

    // ========== ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬ ==========
    function openBulkTicketModal() {
      if (selectedUserIds.length === 0) {
        alert('ì´ìš©ê¶Œì„ ë¶€ì—¬í•  íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      document.getElementById('bulkTicketCount').textContent = selectedUserIds.length;
      document.getElementById('bulkTicketInput').value = 1;
      document.getElementById('bulkTicketModal').classList.add('active');
      document.getElementById('bulkTicketInput').focus();
    }

    function closeBulkTicketModal() {
      document.getElementById('bulkTicketModal').classList.remove('active');
    }

    async function saveBulkTickets() {
      const addTickets = parseInt(document.getElementById('bulkTicketInput').value) || 0;

      if (addTickets <= 0) {
        alert('ë¶€ì—¬í•  ì´ìš©ê¶Œ ìˆ˜ë¥¼ 1 ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (selectedUserIds.length === 0) {
        alert('ì„ íƒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!confirm(`${selectedUserIds.length}ëª…ì—ê²Œ ì´ìš©ê¶Œ ${addTickets}íšŒë¥¼ ì¶”ê°€ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      try {
        const response = await fetch('/api/mock-exam/admin/users/bulk-tickets', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userIds: selectedUserIds,
            addTickets: addTickets
          })
        });

        const data = await response.json();

        if (data.ok) {
          alert(`${data.updatedCount}ëª…ì—ê²Œ ì´ìš©ê¶Œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          closeBulkTicketModal();
          clearSelection();
          loadUsers();
        } else {
          alert(data.error || 'ì´ìš©ê¶Œ ë¶€ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬ ì˜¤ë¥˜:', error);
        alert('ì´ìš©ê¶Œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ========== ì´ìš©ê¶Œ ë¶€ì—¬ ê¸°ëŠ¥ (ê°œë³„) ==========
    let ticketUserId = null;

    function openTicketModal(userId, userName, currentTickets) {
      ticketUserId = userId;
      document.getElementById('ticketUserName').textContent = userName;
      document.getElementById('ticketInput').value = currentTickets;
      document.getElementById('ticketModal').classList.add('active');
      document.getElementById('ticketInput').focus();
    }

    function closeTicketModal() {
      document.getElementById('ticketModal').classList.remove('active');
      ticketUserId = null;
    }

    async function saveTickets() {
      if (!ticketUserId) return;

      const tickets = parseInt(document.getElementById('ticketInput').value) || 0;

      if (tickets < 0) {
        alert('ì´ìš©ê¶Œì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        const response = await fetch(`/api/mock-exam/admin/users/${ticketUserId}/tickets`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tickets })
        });

        const data = await response.json();

        if (data.ok) {
          alert('ì´ìš©ê¶Œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeTicketModal();
          loadUsers();
        } else {
          alert(data.error || 'ì´ìš©ê¶Œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ì´ìš©ê¶Œ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì´ìš©ê¶Œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì´ìš©ê¶Œ ëª¨ë‹¬ ì´ë²¤íŠ¸ëŠ” DOMContentLoadedì—ì„œ ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {
      // ì´ìš©ê¶Œ ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
      const ticketModalEl = document.getElementById('ticketModal');
      if (ticketModalEl) {
        ticketModalEl.addEventListener('click', function(e) {
          if (e.target === this) closeTicketModal();
        });
      }

      // Enter í‚¤ë¡œ ì €ì¥
      const ticketInputEl = document.getElementById('ticketInput');
      if (ticketInputEl) {
        ticketInputEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') saveTickets();
        });
      }
    });

    // í•™ìƒ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ (ë¡œê·¸ì¸ ì—†ì´)
    function goToStudentDashboard(userId, userName) {
      const dashboardUrl = `/mock_exam_dashboard.html?userId=${encodeURIComponent(userId)}&name=${encodeURIComponent(userName)}`;
      window.open(dashboardUrl, '_blank');
    }

    // ì „í™”ë²ˆí˜¸ë¡œ MockExamUserë¥¼ ì°¾ì•„ì„œ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ (ì‘ì‹œ ëª©ë¡ìš©)
    async function goToStudentDashboardByPhone(phone, userName) {
      if (!phone) {
        alert('ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // allUsersì—ì„œ ì „í™”ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì°¾ê¸°
      const user = allUsers.find(u => u.phone === phone);
      if (user) {
        // MockExamUserê°€ ìˆìœ¼ë©´ ê·¸ _id ì‚¬ìš©
        goToStudentDashboard(user._id, user.name);
      } else {
        // MockExamUserê°€ ì—†ìœ¼ë©´ ì „í™”ë²ˆí˜¸ë¥¼ userIdë¡œ ì‚¬ìš©
        const dashboardUrl = `/mock_exam_dashboard.html?phone=${encodeURIComponent(phone)}&name=${encodeURIComponent(userName)}`;
        window.open(dashboardUrl, '_blank');
      }
    }

    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    if (window.Kakao && !Kakao.isInitialized()) {
      Kakao.init('6ad10cc6680c7a5829a4fd7a3cbb4a7e');
    }

    // AIê³¼ì œ ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
    function shareAiTaskKakao(userId, userName, completed, total) {
      const remaining = total - completed;
      const baseUrl = 'https://dan-dan-app.onrender.com/mock_exam_dashboard.html';
      const shareUrl = `${baseUrl}?userId=${encodeURIComponent(userId)}&name=${encodeURIComponent(userName)}`;

      // ì´ë¦„ì—ì„œ ì„± ì œì™¸ (ê¹€ë¯¸ì†Œ -> ë¯¸ì†Œ í•™ìƒ)
      const displayName = userName && userName.length >= 2 ? userName.slice(1) + ' í•™ìƒ' : userName + ' í•™ìƒ';

      if (window.Kakao && Kakao.isInitialized()) {
        Kakao.Share.sendDefault({
          objectType: 'feed',
          content: {
            title: `${displayName}, AI ì¶”ì²œ ê³¼ì œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!`,
            description: `ğŸ“š ë¯¸ì™„ë£Œ ê³¼ì œ: ${remaining}ê°œ (${completed}/${total} ì™„ë£Œ)\n\nì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³¼ì œë¥¼ í™•ì¸í•˜ì„¸ìš”.`,
            imageUrl: 'https://dan-dan-app.onrender.com/images/ai-task-reminder.png',
            link: {
              mobileWebUrl: shareUrl,
              webUrl: shareUrl
            }
          },
          buttons: [
            {
              title: 'AI ê³¼ì œ í™•ì¸í•˜ê¸°',
              link: {
                mobileWebUrl: shareUrl,
                webUrl: shareUrl
              }
            }
          ]
        });
      } else {
        alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }
  </script>

  <!-- ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬ ëª¨ë‹¬ -->
  <div class="ticket-modal-overlay" id="bulkTicketModal">
    <div class="ticket-modal">
      <h3 class="ticket-modal-title">ğŸ« ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬</h3>
      <p class="ticket-modal-subtitle"><strong id="bulkTicketCount">0</strong>ëª…ì—ê²Œ ì´ìš©ê¶Œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</p>
      <div class="ticket-input-group">
        <label>ì¶”ê°€í•  ì´ìš©ê¶Œ</label>
        <input type="number" id="bulkTicketInput" min="1" value="1">
        <span>íšŒ</span>
      </div>
      <p style="font-size: 13px; color: #888; margin-bottom: 15px; text-align: center;">â€» ê¸°ì¡´ ì´ìš©ê¶Œì— ì¶”ê°€ë©ë‹ˆë‹¤</p>
      <div class="ticket-modal-buttons">
        <button class="ticket-modal-btn cancel" onclick="closeBulkTicketModal()">ì·¨ì†Œ</button>
        <button class="ticket-modal-btn save" onclick="saveBulkTickets()">ë¶€ì—¬í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì´ìš©ê¶Œ ë¶€ì—¬ ëª¨ë‹¬ (ê°œë³„) -->
  <div class="ticket-modal-overlay" id="ticketModal">
    <div class="ticket-modal">
      <h3 class="ticket-modal-title">ì´ìš©ê¶Œ ë¶€ì—¬</h3>
      <p class="ticket-modal-subtitle"><strong id="ticketUserName">-</strong>ë‹˜ì˜ ì´ìš©ê¶Œì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
      <div class="ticket-input-group">
        <label>ì´ìš©ê¶Œ ê°œìˆ˜</label>
        <input type="number" id="ticketInput" min="0" value="0">
        <span>íšŒ</span>
      </div>
      <div class="ticket-modal-buttons">
        <button class="ticket-modal-btn cancel" onclick="closeTicketModal()">ì·¨ì†Œ</button>
        <button class="ticket-modal-btn save" onclick="saveTickets()">ì €ì¥</button>
      </div>
    </div>
  </div>
</body>
</html>
