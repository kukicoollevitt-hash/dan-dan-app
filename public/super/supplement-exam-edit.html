<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>보완 학습 시험지 수정</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Noto Sans KR", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }

    .header h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .back-btn {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .back-btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }

    .exam-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .exam-info-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .exam-info-row:last-child {
      margin-bottom: 0;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group input[readonly] {
      background: #e9ecef;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #28a745;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .questions-section {
      margin-top: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
    }

    .add-question-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #28a745 0%, #218838 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-question-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }

    .question-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .question-number {
      font-size: 16px;
      font-weight: 700;
      color: #667eea;
    }

    .delete-question-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .delete-question-btn:hover {
      transform: translateY(-2px);
    }

    .question-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .option-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-number {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #667eea;
      color: white;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 600;
    }

    .option-input {
      flex: 1;
    }

    .correct-radio {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      color: #495057;
      cursor: pointer;
    }

    .correct-radio input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .save-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e9ecef;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    .save-btn {
      padding: 14px 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .cancel-btn {
      padding: 14px 40px;
      background: #e9ecef;
      color: #495057;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .cancel-btn:hover {
      background: #dee2e6;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 18px;
      color: #667eea;
    }

    .empty-questions {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px dashed #dee2e6;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/super/supplement-exam-management.html" class="back-btn">← 목록으로 돌아가기</a>

    <div class="header">
      <h1 id="pageTitle">시험지 수정</h1>
      <p id="pageDesc">시험지 정보와 문항을 수정합니다</p>
    </div>

    <div id="content">
      <div class="loading">데이터를 불러오는 중...</div>
    </div>
  </div>

  <script>
    let examData = null;
    let questions = [];
    const examId = new URLSearchParams(window.location.search).get('examId');

    if (!examId) {
      alert('시험지 ID가 없습니다.');
      window.location.href = '/super/supplement-exam-management.html';
    }

    // 데이터 로드
    async function loadData() {
      try {
        const response = await fetch(`/api/supplement-exams/${examId}`);
        const result = await response.json();

        if (result.ok) {
          examData = result.exam;
          questions = examData.questions || [];
          renderContent();
        } else {
          alert('시험지를 찾을 수 없습니다.');
          window.location.href = '/super/supplement-exam-management.html';
        }
      } catch (err) {
        console.error('데이터 로드 실패:', err);
        alert('서버 오류가 발생했습니다.');
      }
    }

    // 콘텐츠 렌더링
    function renderContent() {
      document.getElementById('pageTitle').textContent = examData.title;
      document.getElementById('pageDesc').textContent = `${examData.areaName} 영역 - 문항 ${questions.length}개`;

      let html = `
        <div class="exam-info">
          <div class="exam-info-row">
            <div class="form-group">
              <label>시험지 ID</label>
              <input type="text" value="${examData.examId}" readonly>
            </div>
            <div class="form-group">
              <label>영역</label>
              <input type="text" value="${examData.areaName}" readonly>
            </div>
          </div>
          <div class="exam-info-row">
            <div class="form-group">
              <label>시험지 제목</label>
              <input type="text" id="examTitle" value="${examData.title}">
            </div>
            <div class="form-group">
              <label>활성화 상태</label>
              <div class="toggle-group" style="margin-top: 8px;">
                <label class="toggle-switch">
                  <input type="checkbox" id="isActive" ${examData.isActive ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
                <span id="statusText">${examData.isActive ? '활성' : '비활성'}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="questions-section">
          <div class="section-header">
            <div class="section-title">문항 목록</div>
            <button class="add-question-btn" onclick="addQuestion()">+ 문항 추가</button>
          </div>
          <div id="questionsList">
            ${renderQuestions()}
          </div>
        </div>

        <div class="save-section">
          <button class="cancel-btn" onclick="cancelEdit()">취소</button>
          <button class="save-btn" onclick="saveExam()">저장</button>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // 활성화 토글 이벤트
      document.getElementById('isActive').addEventListener('change', function() {
        document.getElementById('statusText').textContent = this.checked ? '활성' : '비활성';
      });
    }

    // 문항 렌더링
    function renderQuestions() {
      if (questions.length === 0) {
        return '<div class="empty-questions">등록된 문항이 없습니다.<br>문항 추가 버튼을 클릭하여 문항을 추가하세요.</div>';
      }

      return questions.map((q, idx) => `
        <div class="question-card" data-index="${idx}">
          <div class="question-header">
            <span class="question-number">${idx + 1}번 문항</span>
            <button class="delete-question-btn" onclick="deleteQuestion(${idx})">삭제</button>
          </div>
          <div class="question-content">
            <div class="form-group">
              <label>지문 (선택)</label>
              <textarea rows="4" placeholder="지문이 있는 경우 입력하세요" onchange="updateQuestion(${idx}, 'passage', this.value)">${q.passage || ''}</textarea>
            </div>
            <div class="form-group">
              <label>문제</label>
              <textarea rows="2" placeholder="문제를 입력하세요" onchange="updateQuestion(${idx}, 'questionText', this.value)">${q.questionText || ''}</textarea>
            </div>
            <div class="form-group">
              <label>선택지</label>
              <div class="options-container">
                ${[1, 2, 3, 4, 5].map(num => `
                  <div class="option-row">
                    <div class="option-number">${num}</div>
                    <input type="text" class="option-input" placeholder="${num}번 선택지"
                      value="${q.options && q.options[num - 1] ? q.options[num - 1] : ''}"
                      onchange="updateOption(${idx}, ${num - 1}, this.value)">
                    <label class="correct-radio">
                      <input type="radio" name="correct_${idx}" value="${num}"
                        ${q.correctAnswer === num ? 'checked' : ''}
                        onchange="updateQuestion(${idx}, 'correctAnswer', ${num})">
                      정답
                    </label>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="form-group">
              <label>해설 (선택)</label>
              <textarea rows="2" placeholder="해설을 입력하세요" onchange="updateQuestion(${idx}, 'explanation', this.value)">${q.explanation || ''}</textarea>
            </div>
          </div>
        </div>
      `).join('');
    }

    // 문항 추가
    function addQuestion() {
      questions.push({
        questionNumber: questions.length + 1,
        questionText: '',
        passage: '',
        options: ['', '', '', '', ''],
        correctAnswer: 1,
        explanation: ''
      });
      document.getElementById('questionsList').innerHTML = renderQuestions();
    }

    // 문항 삭제
    function deleteQuestion(idx) {
      if (confirm(`${idx + 1}번 문항을 삭제하시겠습니까?`)) {
        questions.splice(idx, 1);
        // 문항 번호 재정렬
        questions.forEach((q, i) => q.questionNumber = i + 1);
        document.getElementById('questionsList').innerHTML = renderQuestions();
      }
    }

    // 문항 업데이트
    function updateQuestion(idx, field, value) {
      questions[idx][field] = value;
    }

    // 선택지 업데이트
    function updateOption(idx, optionIdx, value) {
      if (!questions[idx].options) {
        questions[idx].options = ['', '', '', '', ''];
      }
      questions[idx].options[optionIdx] = value;
    }

    // 저장
    async function saveExam() {
      const title = document.getElementById('examTitle').value;
      const isActive = document.getElementById('isActive').checked;

      // 문항 번호 재정렬
      questions.forEach((q, i) => q.questionNumber = i + 1);

      try {
        const response = await fetch(`/api/supplement-exams/${examId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, questions, isActive })
        });

        const result = await response.json();

        if (result.ok) {
          alert('저장되었습니다.');
          window.location.href = '/super/supplement-exam-management.html';
        } else {
          alert('저장 실패: ' + result.message);
        }
      } catch (err) {
        console.error('저장 실패:', err);
        alert('서버 오류가 발생했습니다.');
      }
    }

    // 취소
    function cancelEdit() {
      if (confirm('변경사항이 저장되지 않습니다. 취소하시겠습니까?')) {
        window.location.href = '/super/supplement-exam-management.html';
      }
    }

    // 초기 로드
    loadData();
  </script>
</body>
</html>
