require("dotenv").config();

const express = require("express");
const bodyParser = require("body-parser");
const fs = require("fs");
const path = require("path");
const mongoose = require("mongoose");
const session = require("express-session");
const MongoStore = require("connect-mongo").default || require("connect-mongo");
const OpenAI = require("openai");
const nodemailer = require("nodemailer");
const cron = require("node-cron");
const multer = require("multer");
const compression = require("compression");

// ===== ë‹¨ì› ì œëª© ë§¤í•‘ ë¡œë“œ =====
let UNIT_TITLES = {};
try {
  const unitTitlesPath = path.join(__dirname, 'unit_titles.json');
  if (fs.existsSync(unitTitlesPath)) {
    UNIT_TITLES = JSON.parse(fs.readFileSync(unitTitlesPath, 'utf8'));
    console.log(`âœ… ë‹¨ì› ì œëª© ë§¤í•‘ ë¡œë“œ ì™„ë£Œ: ${Object.keys(UNIT_TITLES).length}ê°œ`);
  }
} catch (err) {
  console.error('âŒ unit_titles.json ë¡œë“œ ì‹¤íŒ¨:', err.message);
}

// ===== Nodemailer ì„¤ì • =====
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASSWORD
  }
});

// ===== MongoDB ëª¨ë¸ =====
const LearningLog = require("./models/LearningLog");
const UserProgress = require("./models/UserProgress");
const DiagnosticTest = require("./models/DiagnosticTest");
const CourseApplication = require("./models/CourseApplication");
const MockExamResult = require("./models/MockExamResult");
const MockExamUser = require("./models/MockExamUser");
const MockExamConsultation = require("./models/MockExamConsultation");
const MegaphoneMessage = require("./models/MegaphoneMessage");
const Notice = require("./models/Notice");
const SnackOrder = require("./models/SnackOrder");

// ===== ì½˜í…ì¸  íŒŒì¼ì—ì„œ ë‹¨ì› ì œëª© ê°€ì ¸ì˜¤ê¸° =====
const contentTitleCache = new Map(); // ì½˜í…ì¸  ì œëª© ìºì‹œ

function getContentTitle(unitKey, unitPath) {
  // ìºì‹œ í™•ì¸
  if (contentTitleCache.has(unitKey)) {
    return contentTitleCache.get(unitKey);
  }

  try {
    // unitPathì—ì„œ content íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
    // ./BRAINUP/science/deep_bio_01.html -> ./public/BRAINUP/science/deep_bio_content.js
    const match = unitPath.match(/\.\/BRAINUP\/([^\/]+)\/([^_]+(?:_[^_]+)?)_(\d+)\.html/);
    if (!match) return null;

    const [, folder, prefix, unitNo] = match;
    // prefix: bio, fit_bio, deep_bio ë“±
    const contentFile = path.join(__dirname, 'public', 'BRAINUP', folder, `${prefix}_content.js`);

    if (!fs.existsSync(contentFile)) return null;

    const content = fs.readFileSync(contentFile, 'utf8');

    // unitKeyì˜ title ì°¾ê¸° (ì˜ˆ: deep_bio_01: { ... title: '...' })
    const titleRegex = new RegExp(`${unitKey}:\\s*\\{[^}]*title:\\s*['"]([^'"]+)['"]`, 's');
    const titleMatch = content.match(titleRegex);

    if (titleMatch && titleMatch[1]) {
      contentTitleCache.set(unitKey, titleMatch[1]);
      return titleMatch[1];
    }

    return null;
  } catch (error) {
    console.error(`ì½˜í…ì¸  ì œëª© ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜ (${unitKey}):`, error.message);
    return null;
  }
}

// ===== ê°„ë‹¨í•œ ë©”ëª¨ë¦¬ ìºì‹œ =====
const cache = new Map();
const CACHE_TTL = 30000; // 30ì´ˆ

function getCacheKey(prefix, params) {
  return `${prefix}:${JSON.stringify(params)}`;
}

function getCache(key) {
  const cached = cache.get(key);
  if (!cached) return null;

  const now = Date.now();
  if (now > cached.expiry) {
    cache.delete(key);
    return null;
  }

  return cached.data;
}

function setCache(key, data, ttl = CACHE_TTL) {
  cache.set(key, {
    data,
    expiry: Date.now() + ttl
  });
}

function clearCacheByPrefix(prefix) {
  for (const key of cache.keys()) {
    if (key.startsWith(prefix)) {
      cache.delete(key);
    }
  }
}

const app = express();
app.use(compression());
const ADMIN_KEY = process.env.ADMIN_KEY ? process.env.ADMIN_KEY.trim() : "";

const PORT = process.env.PORT || 3000;
const USERS_FILE = "users.json";
const MONGO_URI = process.env.MONGODB_URI;

// OpenAI ì„¤ì •
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ===== ë¯¸ë“¤ì›¨ì–´ =====
app.use(bodyParser.urlencoded({ extended: true, limit: '50mb' }));
app.use(express.json({ limit: '50mb' }));

// âœ… ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ (MongoDB ì €ì¥ì†Œ ì‚¬ìš©)
app.use(
  session({
    secret: process.env.SESSION_SECRET || "dandan-secret",
    resave: false,
    saveUninitialized: false,
    store: MongoStore.create({
      mongoUrl: MONGO_URI,
      ttl: 60 * 60 * 2, // 2ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
      autoRemove: 'native'
    }),
    cookie: {
      httpOnly: true,
      maxAge: 1000 * 60 * 60 * 2, // 2ì‹œê°„
    },
  })
);

// í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€
app.get("/student-login", (req, res) => {
  res.sendFile(path.join(__dirname, "public/student-login.html"));
});


// âœ… 1) ë©”ì¸(/) = ëœë”© í˜ì´ì§€
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "brain_landing.html"));
});

// âœ… 1-2) /login = ë¡œê·¸ì¸ í˜ì´ì§€ (ì¿¼ë¦¬ ìœ ì§€)
app.get("/login", (req, res) => {
  console.log("âœ… [GET] /login  -> login.html ë³´ë‚´ê¸° (ì¿¼ë¦¬ ìœ ì§€)");
  res.sendFile(path.join(__dirname, "login.html"));
});

app.get("/signup", (req, res) => {
  console.log("âœ… [GET] /signup -> ë©”ì¸ìœ¼ë¡œ ì´ë™");
  return res.redirect("/");   // â— ì¿¼ë¦¬ ì—†ì´ ë£¨íŠ¸ë¡œë§Œ ë³´ë‚´ê¸°
});

// âœ… í•™ìƒ ë©”ë‰´ í˜ì´ì§€ (ê´€ë¦¬ìì—ì„œ í•™ìƒ ì´ë¦„ í´ë¦­ ì‹œ ì´ë™)
app.get("/menu", (req, res) => {
  console.log("âœ… [GET] /menu -> menu.html ì œê³µ (grade:", req.query.grade, ", name:", req.query.name, ")");
  res.sendFile(path.join(__dirname, "public", "menu.html"));
});

// âœ… ë“±ë¡ëœ í•™êµ ëª©ë¡ ì¡°íšŒ API (ë¡œê·¸ì¸/íšŒì›ê°€ì…ìš©)
app.get("/api/schools", async (req, res) => {
  try {
    // Admin í…Œì´ë¸”ì—ì„œ academyName ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const adminSchools = await Admin.find({ deleted: { $ne: true } }).distinct("academyName");

    // User í…Œì´ë¸”ì—ì„œ school ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const userSchools = await User.find({ deleted: { $ne: true } }).distinct("school");

    // ë‘ ëª©ë¡ í•©ì¹˜ê¸° (ì¤‘ë³µ ì œê±°)
    const allSchools = [...new Set([...adminSchools, ...userSchools])];

    // ë¹ˆ ê°’ ì œê±° ë° ì •ë ¬
    const schools = allSchools
      .filter(name => name && name.trim() && name !== "ì–´ë“œë¯¼")
      .sort((a, b) => a.localeCompare(b, "ko"));

    res.json({ ok: true, schools });
  } catch (err) {
    console.error("âŒ /api/schools ì—ëŸ¬:", err);
    res.json({ ok: false, schools: [] });
  }
});

// âœ… í•™ìƒ íšŒì›ê°€ì… ì²˜ë¦¬
// âœ… í•™ìƒ íšŒì›ê°€ì… ì²˜ë¦¬
app.post("/register", async (req, res) => {
  try {
    const { grade, classNum, studentNum, name, phone, academyName } = req.body;

    console.log("ğŸ“© [POST] /register ìš”ì²­:", grade, classNum, studentNum, name, phone, academyName);

    // 1) í•„ìˆ˜ê°’ ì²´í¬
    if (!grade || !name || !phone || !academyName) {
      return res.status(400).send("í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }

    const cleanPhone = String(phone).trim();

    // 2) ì´ë¯¸ ê°™ì€ í•™ìƒì´ ìˆëŠ”ì§€(íœ´ì§€ ì•„ë‹˜) í™•ì¸
    const existing = await User.findOne({
      grade,
      name,
      pw: cleanPhone,        // ğŸ”¸ pw ê¸°ì¤€ìœ¼ë¡œ ë™ì¼í•™ìƒ ì²´í¬
      deleted: { $ne: true }
    });

    if (existing) {
      console.log("âš  ì´ë¯¸ ê°€ì…ëœ í•™ìƒì…ë‹ˆë‹¤:", existing.name);
      // ì´ë¯¸ ìˆëŠ” ê³„ì •ì´ë©´ ê·¸ëƒ¥ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
return res.redirect("/?loginError=pending");
    }

    // 3) ìƒˆ í•™ìƒ ìƒì„±
    const created = await User.create({
      grade,
      classNum: classNum || "",      // ğŸ”¹ ë°˜ ì €ì¥
      studentNum: studentNum || "",  // ğŸ”¹ ë²ˆí˜¸ ì €ì¥
      name,
      phone: cleanPhone,
      pw: cleanPhone,        // ğŸ”¥ ë¡œê·¸ì¸ì—ì„œ ì“°ëŠ” ë¹„ë°€ë²ˆí˜¸ í•„ë“œ
      school: academyName,   // ğŸ”¹ academyNameì„ school í•„ë“œì— ì €ì¥
      approved: false,       // ê¸°ë³¸ê°’: ìŠ¹ì¸ ì „
      deleted: false,
      createdAt: new Date(),
    });

    console.log("âœ… [POST] íšŒì›ê°€ì… DB ì €ì¥ ì™„ë£Œ:", created.name);

    // 4) íšŒì›ê°€ì… í›„ ì´ë™
    //  - ì§€ê¸ˆ êµ¬ì¡°ì—ì„œëŠ” 'ìŠ¹ì¸ ëŒ€ê¸°' ì•ˆë‚´ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²Œ ìì—°ìŠ¤ëŸ¬ìš°ë‹ˆê¹Œ
    //    /login ìœ¼ë¡œ ë³´ë‚´ë©´ì„œ pending íŒì—… ë„ìš°ë„ë¡ í•¨
return res.redirect("/brain_landing.html?signup=pending");
    // ë˜ëŠ” ë©”ì¸ì—ì„œë§Œ ì“°ê³  ì‹¶ìœ¼ë©´:
    // return res.redirect("/?mode=login");
  } catch (err) {
    console.error("âŒ /register ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
    return res.status(500).send("íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});



// âœ… ìŠˆí¼ê´€ë¦¬ì HTML íŒŒì¼ ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨ (ì •ì  íŒŒì¼ ì„œë¹™ ì „ì— ì²´í¬)
app.use((req, res, next) => {
  // super_admin_dashboard.html ë˜ëŠ” /super/ í´ë” ë‚´ HTML ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨
  if (req.path === '/super_admin_dashboard.html' ||
      (req.path.startsWith('/super/') && req.path.endsWith('.html'))) {
    console.log("â›” ìŠˆí¼ê´€ë¦¬ì íŒŒì¼ ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨:", req.path);
    return res.redirect("/admin-login");
  }
  next();
});

// âœ… 2) ì •ì  íŒŒì¼ ì œê³µ (CSS, JS, menu.html, admin_*.html ë“±)
app.use(express.static(path.join(__dirname, "public"), {
  etag: true,
  setHeaders: (res, filePath) => {
    // HTML íŒŒì¼ì€ ìºì‹œ ë°©ì§€
    if (filePath.endsWith('.html')) {
      res.set('Cache-Control', 'no-store, no-cache, must-revalidate, private');
      res.set('Pragma', 'no-cache');
      res.set('Expires', '0');
    }
    // ë¹„ë””ì˜¤/ì´ë¯¸ì§€ íŒŒì¼ì€ 1ì¼ ìºì‹œ
    else if (filePath.match(/\.(mp4|webm|jpg|jpeg|png|gif|svg|webp)$/i)) {
      res.set('Cache-Control', 'public, max-age=86400'); // 24ì‹œê°„
    }
    // JS/CSS íŒŒì¼ì€ 1ì‹œê°„ ìºì‹œ
    else if (filePath.match(/\.(js|css)$/i)) {
      res.set('Cache-Control', 'public, max-age=3600'); // 1ì‹œê°„
    }
  }
}));

// users.json ì—†ìœ¼ë©´ ë§Œë“¤ê¸°
if (!fs.existsSync(USERS_FILE)) {
  fs.writeFileSync(USERS_FILE, "[]");
}

/* ============================
 *  MongoDB ìŠ¤í‚¤ë§ˆ ì •ì˜
 * ============================ */

// ===== í•™ìƒ/ì¼ë°˜ User ìŠ¤í‚¤ë§ˆ =====
const userSchema = new mongoose.Schema({
  grade: String,
  classNum: String,      // ğŸ”¹ ë°˜ (ì˜ˆ: "1ë°˜", "2ë°˜")
  studentNum: String,    // ğŸ”¹ ë²ˆí˜¸ (ì˜ˆ: "15", "03")
  name: String,
  phone: String,
  id: String,
  pw: String,
  lastLogin: Date,
  school: String,
  status: {
    type: String,
    enum: ["pending", "approved"],
    default: "pending", // ê¸°ë³¸ì€ 'ëŒ€ê¸°'
  },
  deleted: { type: Boolean, default: false },
  deletedAt: Date,
  // ğŸ”¹ ì§€ì  ì‚­ì œ(ë¸Œëœì¹˜ íœ´ì§€)ë¡œ ì¸í•´ ê°™ì´ íœ´ì§€ë¡œ ê°„ ê³„ì •ì¸ì§€ í‘œì‹œ
  branchDeleted: { type: Boolean, default: false },
  // ğŸ”¹ í•™ìƒì—ê²Œ ë¶€ì—¬ëœ ì‹œë¦¬ì¦ˆ ëª©ë¡
  assignedSeries: {
    type: [String],
    default: []
  }
});
const User = mongoose.model("User", userSchema);

// âœ… ë¸Œëœì¹˜ ê´€ë¦¬ì(í•™ì›ì¥) / ìŠˆí¼ê´€ë¦¬ì ìŠ¤í‚¤ë§ˆ
const adminSchema = new mongoose.Schema({
  academyName: { type: String, required: true }, // í•™ì›ëª…/ì§€ì ëª…

  // í•™ë…„
  grade: {
    type: String,
    default: "",
  },
  // ë°˜
  classNum: {
    type: String,
    default: "",
  },

  name:  { type: String, required: true }, // ì„±í•¨
  birth: { type: String, required: true }, // ì˜ˆ) 900305
  phone: { type: String, required: true }, // ë¡œê·¸ì¸ ID + PW

  // ğŸ”¥ ìŠˆí¼ê´€ë¦¬ì ì—¬ë¶€ (ì–´ë“œë¯¼ ê³„ì •ë§Œ true)
  isSuper: {
    type: Boolean,
    default: false,
  },

  status: {
    type: String,
    enum: ["pending", "approved"],
    default: "pending", // ê¸°ë³¸ì€ ìŠ¹ì¸ ìƒíƒœ
  },

  // ğŸ”¹ ì‚­ì œ(íœ´ì§€) ì—¬ë¶€
  deleted: { type: Boolean, default: false },
  deletedAt: Date,

  lastLogin: Date,
  createdAt: { type: Date, default: Date.now },

  // ğŸ” ë¸Œëœì¹˜ ê´€ë¦¬ì PIN (6ìë¦¬)
  pin: { type: String, default: null },
});

const Admin = mongoose.model("Admin", adminSchema);

/* ====================================
 * âœ… ë¸Œëœì¹˜ ê´€ë¦¬ììš© ë¯¸ë“¤ì›¨ì–´
 * ==================================== */
function requireAdminLogin(req, res, next) {
  if (!req.session.admin) {
    console.log("â›” ê´€ë¦¬ì ì„¸ì…˜ ì—†ìŒ â†’ /admin-login ë¦¬ë‹¤ì´ë ‰íŠ¸");
    return res.redirect("/admin-login");
  }
  next();
}

/* ====================================
 * âœ… ìŠˆí¼ê´€ë¦¬ì ì „ìš© ë¯¸ë“¤ì›¨ì–´
 * ==================================== */
const SUPER_ADMIN_PIN = "284600"; // ìŠˆí¼ê´€ë¦¬ì PIN

function requireSuperAdmin(req, res, next) {
  if (!req.session.admin || !req.session.admin.isSuper) {
    console.log("â›” ìŠˆí¼ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ");
    // API ìš”ì²­ì¸ ê²½ìš° JSON ì‘ë‹µ
    if (req.path.startsWith('/api/')) {
      return res.status(401).json({ ok: false, message: 'ìŠˆí¼ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }
    return res.redirect("/admin-login");
  }

  // PIN ì¸ì¦ í™•ì¸
  if (!req.session.superPinVerified) {
    console.log("ğŸ” ìŠˆí¼ê´€ë¦¬ì PIN ì¸ì¦ í•„ìš”");
    // API ìš”ì²­ì¸ ê²½ìš° JSON ì‘ë‹µ
    if (req.path.startsWith('/api/')) {
      return res.status(401).json({ ok: false, message: 'PIN ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.', needPin: true });
    }
    // ì›ë˜ ê°€ë ¤ë˜ URL ì €ì¥
    req.session.superRedirectUrl = req.originalUrl;
    return res.redirect("/super/pin");
  }

  next();
}

/* ====================================
 * âœ… ë¸Œëœì¹˜/ê´€ë¦¬ì í˜ì´ì§€ ë¼ìš°íŠ¸
 *   (ëª¨ë‘ public í´ë”ì˜ HTMLê³¼ ì—°ê²°)
 * ==================================== */

// ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€ (GET)
app.get("/admin-login", (req, res) => {
  console.log("âœ… [GET] /admin-login -> public/admin_login.html");
  res.sendFile(path.join(__dirname, "public", "admin_login.html"));
});

// âœ… /admin/login ìœ¼ë¡œ ë“¤ì–´ì˜¤ë©´ ê¸°ì¡´ /admin-login ìœ¼ë¡œ ë³´ë‚´ê¸° (ë³„ì¹­)
app.get("/admin/login", (req, res) => {
  return res.redirect("/admin-login");
});

// âœ… ìŠˆí¼ê´€ë¦¬ì PIN ì…ë ¥ í˜ì´ì§€
app.get("/super/pin", (req, res) => {
  // ìŠˆí¼ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
  if (!req.session.admin || !req.session.admin.isSuper) {
    return res.redirect("/admin-login");
  }
  // ì´ë¯¸ PIN ì¸ì¦ ì™„ë£Œë©´ ëŒ€ì‹œë³´ë“œë¡œ
  if (req.session.superPinVerified) {
    return res.redirect("/super/dashboard");
  }

  const error = req.query.error;
  res.send(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ìŠˆí¼ê´€ë¦¬ì PIN ì¸ì¦</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .pin-container {
          background: white;
          padding: 40px;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          text-align: center;
          max-width: 400px;
          width: 90%;
        }
        .lock-icon {
          font-size: 60px;
          margin-bottom: 20px;
        }
        h1 {
          color: #1a1a2e;
          margin-bottom: 10px;
          font-size: 24px;
        }
        p {
          color: #666;
          margin-bottom: 30px;
          font-size: 14px;
        }
        .pin-input {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-bottom: 20px;
        }
        .pin-input input {
          width: 50px;
          height: 60px;
          text-align: center;
          font-size: 24px;
          font-weight: bold;
          border: 2px solid #ddd;
          border-radius: 10px;
          outline: none;
          transition: all 0.3s;
        }
        .pin-input input:focus {
          border-color: #4a90d9;
          box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }
        .error {
          color: #e74c3c;
          margin-bottom: 20px;
          font-size: 14px;
          display: ${error ? 'block' : 'none'};
        }
        button {
          background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%);
          color: white;
          border: none;
          padding: 15px 50px;
          font-size: 16px;
          font-weight: bold;
          border-radius: 10px;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(74, 144, 217, 0.4);
        }
        .back-link {
          display: block;
          margin-top: 20px;
          color: #999;
          text-decoration: none;
          font-size: 14px;
        }
        .back-link:hover {
          color: #666;
        }
      </style>
    </head>
    <body>
      <div class="pin-container">
        <div class="lock-icon">ğŸ”</div>
        <h1>ìŠˆí¼ê´€ë¦¬ì ì¸ì¦</h1>
        <p>ë³´ì•ˆì„ ìœ„í•´ 6ìë¦¬ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
        <div class="error">PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
        <form method="POST" action="/super/pin/verify">
          <div class="pin-input">
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required autofocus>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
          </div>
          <input type="hidden" name="pin" id="pinValue">
          <button type="submit">ì¸ì¦í•˜ê¸°</button>
        </form>
        <a href="/admin-login" class="back-link">â† ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
      <script>
        const inputs = document.querySelectorAll('.pin-input input');
        const pinValue = document.getElementById('pinValue');
        const form = document.querySelector('form');

        inputs.forEach((input, index) => {
          input.addEventListener('input', (e) => {
            if (e.target.value && index < inputs.length - 1) {
              inputs[index + 1].focus();
            }
            updatePinValue();
          });

          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
              inputs[index - 1].focus();
            }
          });

          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = e.clipboardData.getData('text').replace(/\\D/g, '').slice(0, 6);
            paste.split('').forEach((char, i) => {
              if (inputs[i]) inputs[i].value = char;
            });
            updatePinValue();
            if (paste.length === 6) inputs[5].focus();
          });
        });

        function updatePinValue() {
          pinValue.value = Array.from(inputs).map(i => i.value).join('');
        }

        form.addEventListener('submit', (e) => {
          updatePinValue();
          if (pinValue.value.length !== 6) {
            e.preventDefault();
            alert('6ìë¦¬ PINì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
          }
        });
      </script>
    </body>
    </html>
  `);
});

// âœ… ìŠˆí¼ê´€ë¦¬ì PIN ê²€ì¦
app.post("/super/pin/verify", (req, res) => {
  // ìŠˆí¼ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
  if (!req.session.admin || !req.session.admin.isSuper) {
    return res.redirect("/admin-login");
  }

  const { pin } = req.body;

  if (pin === SUPER_ADMIN_PIN) {
    console.log("âœ… ìŠˆí¼ê´€ë¦¬ì PIN ì¸ì¦ ì„±ê³µ:", req.session.admin.name);
    req.session.superPinVerified = true;

    // ì›ë˜ ê°€ë ¤ë˜ URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    const redirectUrl = req.session.superRedirectUrl || "/super/dashboard";
    delete req.session.superRedirectUrl;
    return res.redirect(redirectUrl);
  } else {
    console.log("âŒ ìŠˆí¼ê´€ë¦¬ì PIN ì¸ì¦ ì‹¤íŒ¨");
    return res.redirect("/super/pin?error=1");
  }
});

// âœ… ë¸Œëœì¹˜ ê´€ë¦¬ì PIN ì…ë ¥ í˜ì´ì§€
app.get("/admin/pin", (req, res) => {
  // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
  if (!req.session.admin) {
    return res.redirect("/admin-login");
  }
  // PIN í•„ìš” ì—†ìœ¼ë©´ ëŒ€ì‹œë³´ë“œë¡œ
  if (!req.session.adminPinRequired || req.session.adminPinVerified) {
    return res.redirect("/admin/dashboard");
  }

  const error = req.query.error;
  const adminName = req.session.admin.name || "";
  const academyName = req.session.admin.academyName || "";

  res.send(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ê´€ë¦¬ì PIN ì¸ì¦</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .pin-container {
          background: white;
          padding: 40px;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          text-align: center;
          max-width: 400px;
          width: 90%;
        }
        .lock-icon {
          font-size: 60px;
          margin-bottom: 20px;
        }
        h1 {
          color: #2d3436;
          margin-bottom: 10px;
          font-size: 24px;
        }
        .admin-info {
          color: #636e72;
          margin-bottom: 5px;
          font-size: 14px;
        }
        p {
          color: #666;
          margin-bottom: 30px;
          font-size: 14px;
        }
        .pin-input {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-bottom: 20px;
        }
        .pin-input input {
          width: 50px;
          height: 60px;
          text-align: center;
          font-size: 24px;
          font-weight: bold;
          border: 2px solid #ddd;
          border-radius: 10px;
          outline: none;
          transition: all 0.3s;
        }
        .pin-input input:focus {
          border-color: #74b9ff;
          box-shadow: 0 0 10px rgba(116, 185, 255, 0.3);
        }
        .error {
          color: #e74c3c;
          margin-bottom: 20px;
          font-size: 14px;
          display: ${error ? 'block' : 'none'};
        }
        button {
          background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
          color: white;
          border: none;
          padding: 15px 50px;
          font-size: 16px;
          font-weight: bold;
          border-radius: 10px;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(45, 52, 54, 0.4);
        }
        .back-link {
          display: block;
          margin-top: 20px;
          color: #999;
          text-decoration: none;
          font-size: 14px;
        }
        .back-link:hover {
          color: #666;
        }
      </style>
    </head>
    <body>
      <div class="pin-container">
        <div class="lock-icon">ğŸ”‘</div>
        <h1>ê´€ë¦¬ì PIN ì¸ì¦</h1>
        <div class="admin-info">${academyName} - ${adminName}</div>
        <p>ë³´ì•ˆì„ ìœ„í•´ 6ìë¦¬ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
        <div class="error">PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
        <form method="POST" action="/admin/pin/verify">
          <div class="pin-input">
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required autofocus>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            <input type="password" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
          </div>
          <input type="hidden" name="pin" id="pinValue">
          <button type="submit">ì¸ì¦í•˜ê¸°</button>
        </form>
        <a href="/admin/logout" class="back-link">â† ë¡œê·¸ì•„ì›ƒ</a>
      </div>
      <script>
        const inputs = document.querySelectorAll('.pin-input input');
        const pinValue = document.getElementById('pinValue');
        const form = document.querySelector('form');

        inputs.forEach((input, index) => {
          input.addEventListener('input', (e) => {
            if (e.target.value && index < inputs.length - 1) {
              inputs[index + 1].focus();
            }
            updatePinValue();
          });

          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
              inputs[index - 1].focus();
            }
          });

          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = e.clipboardData.getData('text').replace(/\\D/g, '').slice(0, 6);
            paste.split('').forEach((char, i) => {
              if (inputs[i]) inputs[i].value = char;
            });
            updatePinValue();
            if (paste.length === 6) inputs[5].focus();
          });
        });

        function updatePinValue() {
          pinValue.value = Array.from(inputs).map(i => i.value).join('');
        }

        form.addEventListener('submit', (e) => {
          updatePinValue();
          if (pinValue.value.length !== 6) {
            e.preventDefault();
            alert('6ìë¦¬ PINì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
          }
        });
      </script>
    </body>
    </html>
  `);
});

// âœ… ë¸Œëœì¹˜ ê´€ë¦¬ì PIN ê²€ì¦
app.post("/admin/pin/verify", async (req, res) => {
  // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
  if (!req.session.admin) {
    return res.redirect("/admin-login");
  }

  const { pin } = req.body;
  const adminId = req.session.admin.id;

  try {
    const admin = await Admin.findById(adminId);

    if (admin && admin.pin === pin) {
      console.log("âœ… ë¸Œëœì¹˜ ê´€ë¦¬ì PIN ì¸ì¦ ì„±ê³µ:", req.session.admin.name);
      req.session.adminPinVerified = true;
      req.session.adminPinRequired = false;
      return res.redirect("/admin/dashboard");
    } else {
      console.log("âŒ ë¸Œëœì¹˜ ê´€ë¦¬ì PIN ì¸ì¦ ì‹¤íŒ¨");
      return res.redirect("/admin/pin?error=1");
    }
  } catch (err) {
    console.error("âŒ PIN ê²€ì¦ ì˜¤ë¥˜:", err);
    return res.redirect("/admin/pin?error=1");
  }
});

// âœ… ìŠˆí¼ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (GET)
app.get("/super/dashboard", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/dashboard -> public/super_admin_dashboard.html",
    "admin:",
    req.session.admin && req.session.admin.name
  );
  res.sendFile(path.join(__dirname, "public", "super_admin_dashboard.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ì§„ë‹¨í…ŒìŠ¤íŠ¸ ë° ìˆ˜ê°•ì‹ ì²­ ê´€ë¦¬
app.get("/super/diagnostic-management", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/diagnostic-management -> public/super/diagnostic-management.html"
  );
  res.sendFile(path.join(__dirname, "public", "super", "diagnostic-management.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬
app.get("/super/mock-exam-management", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/mock-exam-management -> public/super/mock-exam-management.html"
  );
  res.sendFile(path.join(__dirname, "public", "super", "mock-exam-management.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ê´€ë¦¬
app.get("/super/supplement-exam-management", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/supplement-exam-management -> public/super/supplement-exam-management.html"
  );
  res.sendFile(path.join(__dirname, "public", "super", "supplement-exam-management.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ìˆ˜ì •
app.get("/super/supplement-exam-edit", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/supplement-exam-edit -> public/super/supplement-exam-edit.html"
  );
  res.sendFile(path.join(__dirname, "public", "super", "supplement-exam-edit.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ê³ ë˜ë±ƒì§€ í™•ì„±ê¸° ê´€ë¦¬
app.get("/super/megaphone-management", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/megaphone-management -> public/super/megaphone-management.html"
  );
  res.sendFile(path.join(__dirname, "public", "super", "megaphone-management.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: í˜•ì„±í‰ê°€ ê´€ë¬¸ AI ë°ì´í„° ê´€ë¦¬ í˜ì´ì§€
app.get("/super/gate-pass-management", requireSuperAdmin, (req, res) => {
  console.log("âœ… [GET] /super/gate-pass-management");
  res.sendFile(path.join(__dirname, "public", "super", "gate-pass-management.html"));
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: í˜•ì„±í‰ê°€ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ëª©ë¡ API
app.get("/api/super/gate-passes", requireSuperAdmin, async (req, res) => {
  try {
    // GatePass ëª¨ë¸ì€ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ (line 20073)
    const GatePassModel = mongoose.model("GatePass");

    // ëª¨ë“  ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì¡°íšŒ
    const gatePasses = await GatePassModel.find({}).sort({ passedAt: -1 }).lean();

    // í•™êµëª…ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ User ì •ë³´ì™€ ë§¤ì¹­
    const enrichedData = await Promise.all(gatePasses.map(async (gp, index) => {
      // User ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ í•™ìƒ ì°¾ê¸°
      const user = await User.findOne({ grade: gp.grade, name: gp.name }).lean();
      return {
        _id: gp._id,
        no: index + 1,
        grade: gp.grade,
        name: gp.name,
        school: user?.school || user?.academyName || '-',
        gate: gp.gate,
        passedAt: gp.passedAt,
        units: gp.units || []
      };
    }));

    res.json({ ok: true, data: enrichedData });
  } catch (err) {
    console.error("âŒ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: í˜•ì„±í‰ê°€ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì¼ê´„ ì‚­ì œ API
app.post("/api/super/gate-passes/delete", requireSuperAdmin, async (req, res) => {
  try {
    const { ids } = req.body;

    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.json({ ok: false, message: "ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”." });
    }

    const GatePassModel = mongoose.model("GatePass");
    const result = await GatePassModel.deleteMany({ _id: { $in: ids } });

    console.log(`âœ… ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ${result.deletedCount}ê°œ ì‚­ì œë¨`);
    res.json({ ok: true, deletedCount: result.deletedCount });
  } catch (err) {
    console.error("âŒ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ê³ ë˜ ë±ƒì§€ íšë“ í•™ìƒ ëª©ë¡ API
console.log("ğŸ³ ê³ ë˜ ë±ƒì§€ API ë¼ìš°íŠ¸ ë“±ë¡ë¨");
app.get("/api/super/whale-badges", requireSuperAdmin, async (req, res) => {
  console.log("ğŸ³ ê³ ë˜ ë±ƒì§€ API í˜¸ì¶œë¨");
  try {
    // UserProgressì—ì„œ ì½”ì¸ì„ íšë“í•œ í•™ìƒë“¤ ì¡°íšŒ
    const badgeUsers = await UserProgress.find({
      'vocabularyQuiz.totalCoins': { $gt: 0 },
      deleted: { $ne: true }
    })
    .sort({ 'vocabularyQuiz.totalCoins': -1 })
    .lean();

    // í•™êµëª…ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ User ì •ë³´ì™€ ë§¤ì¹­
    const badges = await Promise.all(badgeUsers.map(async (user) => {
      const userInfo = await User.findOne({ grade: user.grade, name: user.name }).lean();
      return {
        grade: user.grade,
        name: user.name,
        school: userInfo?.school || userInfo?.academyName || '-',
        totalCoins: user.vocabularyQuiz?.totalCoins || 0,
        usedCoins: user.vocabularyQuiz?.usedCoins || 0,
        lastUpdate: user.vocabularyQuiz?.lastRankUpdate || user.updatedAt
      };
    }));

    res.json({ ok: true, badges });
  } catch (err) {
    console.error("âŒ ê³ ë˜ ë±ƒì§€ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ê³ ë˜ ë±ƒì§€ ìˆ˜ì • API
app.post("/api/super/whale-badges/update", requireSuperAdmin, async (req, res) => {
  try {
    const { grade, name, totalCoins, usedCoins } = req.body;

    if (!grade || !name) {
      return res.json({ ok: false, message: 'í•™ë…„ê³¼ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const result = await UserProgress.updateOne(
      { grade, name },
      {
        $set: {
          'vocabularyQuiz.totalCoins': totalCoins || 0,
          'vocabularyQuiz.usedCoins': usedCoins || 0,
          'vocabularyQuiz.lastRankUpdate': new Date()
        }
      }
    );

    if (result.matchedCount === 0) {
      return res.json({ ok: false, message: 'í•´ë‹¹ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    console.log(`âœ… ê³ ë˜ ë±ƒì§€ ìˆ˜ì •: ${grade} ${name} - totalCoins: ${totalCoins}, usedCoins: ${usedCoins}`);
    res.json({ ok: true });
  } catch (err) {
    console.error("âŒ ê³ ë˜ ë±ƒì§€ ìˆ˜ì • ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ê³ ë˜ ë±ƒì§€ ì‚­ì œ API (ì½”ì¸ 0ìœ¼ë¡œ ì´ˆê¸°í™”)
app.post("/api/super/whale-badges/delete", requireSuperAdmin, async (req, res) => {
  try {
    const { grade, name } = req.body;

    if (!grade || !name) {
      return res.json({ ok: false, message: 'í•™ë…„ê³¼ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const result = await UserProgress.updateOne(
      { grade, name },
      {
        $set: {
          'vocabularyQuiz.totalCoins': 0,
          'vocabularyQuiz.usedCoins': 0,
          'vocabularyQuiz.lastRankUpdate': new Date()
        }
      }
    );

    if (result.matchedCount === 0) {
      return res.json({ ok: false, message: 'í•´ë‹¹ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    console.log(`âœ… ê³ ë˜ ë±ƒì§€ ì‚­ì œ (ì´ˆê¸°í™”): ${grade} ${name}`);
    res.json({ ok: true });
  } catch (err) {
    console.error("âŒ ê³ ë˜ ë±ƒì§€ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ===== CU í¸ì˜ì  ê°„ì‹ êµ¬ë§¤ API =====

// ê°„ì‹ êµ¬ë§¤ ì‹ ì²­ (í•™ìƒìš©)
app.post("/api/snack-order", async (req, res) => {
  try {
    const { grade, name, school, items, totalBadges } = req.body;

    if (!grade || !name || !items || items.length === 0 || !totalBadges) {
      return res.status(400).json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ ëˆ„ë½" });
    }

    // í•™ìƒì˜ í˜„ì¬ ë±ƒì§€ í™•ì¸
    const userProgress = await UserProgress.findOne({ grade, name });
    if (!userProgress || !userProgress.vocabularyQuiz) {
      return res.status(400).json({ ok: false, message: "ì–´íœ˜í€´ì¦ˆ ë°ì´í„° ì—†ìŒ" });
    }

    const currentCoins = userProgress.vocabularyQuiz.totalCoins || 0;
    const usedCoins = userProgress.vocabularyQuiz.usedCoins || 0;
    const remainingCoins = currentCoins - usedCoins;

    if (remainingCoins < totalBadges) {
      return res.status(400).json({ ok: false, message: "ë±ƒì§€ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤", remaining: remainingCoins });
    }

    // ì£¼ë¬¸ ìƒì„±
    const order = new SnackOrder({
      grade,
      name,
      school: school || '',
      items,
      totalBadges,
      status: 'pending'
    });
    await order.save();

    // ë±ƒì§€ ì°¨ê°
    await UserProgress.updateOne(
      { grade, name },
      { $inc: { 'vocabularyQuiz.usedCoins': totalBadges } }
    );

    console.log(`âœ… ê°„ì‹ ì£¼ë¬¸ ì™„ë£Œ: ${grade} ${name} - ${items.map(i => i.name).join(', ')} (${totalBadges}ë±ƒì§€)`);
    res.json({ ok: true, orderId: order._id, remaining: remainingCoins - totalBadges });
  } catch (err) {
    console.error("âŒ ê°„ì‹ ì£¼ë¬¸ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ê°„ì‹ ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ (ìŠˆí¼ê´€ë¦¬ììš©)
app.get("/api/super/snack-orders", requireSuperAdmin, async (req, res) => {
  try {
    const orders = await SnackOrder.find()
      .sort({ createdAt: -1 })
      .limit(100)
      .lean();

    // User ì •ë³´ì—ì„œ í•™êµëª… ê°€ì ¸ì˜¤ê¸° (ê³ ë˜ë±ƒì§€ ëª©ë¡ê³¼ ë™ì¼í•œ ë°©ì‹)
    const ordersWithSchool = await Promise.all(orders.map(async (order) => {
      const userInfo = await User.findOne({ grade: order.grade, name: order.name }).lean();
      return {
        ...order,
        school: userInfo?.school || userInfo?.academyName || order.school || '-'
      };
    }));

    res.json({ ok: true, orders: ordersWithSchool });
  } catch (err) {
    console.error("âŒ ê°„ì‹ ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ê°„ì‹ ì£¼ë¬¸ ì „ë‹¬ ì™„ë£Œ ì²´í¬ (ìŠˆí¼ê´€ë¦¬ììš©)
app.post("/api/super/snack-orders/deliver", requireSuperAdmin, async (req, res) => {
  try {
    const { orderId, delivered } = req.body;

    const update = delivered
      ? { status: 'delivered', deliveredAt: new Date() }
      : { status: 'pending', deliveredAt: null };

    await SnackOrder.updateOne({ _id: orderId }, update);

    console.log(`âœ… ê°„ì‹ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½: ${orderId} -> ${delivered ? 'delivered' : 'pending'}`);
    res.json({ ok: true });
  } catch (err) {
    console.error("âŒ ê°„ì‹ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ê°„ì‹ ì£¼ë¬¸ ì‚­ì œ (ìŠˆí¼ê´€ë¦¬ììš©)
app.delete("/api/super/snack-orders/:id", requireSuperAdmin, async (req, res) => {
  try {
    const { id } = req.params;
    await SnackOrder.deleteOne({ _id: id });

    console.log(`âœ… ê°„ì‹ ì£¼ë¬¸ ì‚­ì œ: ${id}`);
    res.json({ ok: true });
  } catch (err) {
    console.error("âŒ ê°„ì‹ ì£¼ë¬¸ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// âœ… ìŠˆí¼ê´€ë¦¬ì: ì „ì²´ í•™ì› í•™ìƒ ëª©ë¡ ë³´ê¸°
app.get("/super/users", requireSuperAdmin, (req, res) => {
  console.log(
    "âœ… [GET] /super/users -> /admin/users ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ìŠˆí¼ê´€ë¦¬ì ì „ìš©)"
  );

  // ğŸ” ADMIN_KEY ëŠ” ì„œë²„ì—ì„œë§Œ ì•Œê³  ìˆìœ¼ë‹ˆ,
  // ì—¬ê¸°ì„œ ì¿¼ë¦¬ì— ë¶™ì—¬ì„œ ê¸°ì¡´ /admin/users í™”ë©´ì„ ì¬ì‚¬ìš©í•œë‹¤.
  res.redirect(`/admin/users?key=${encodeURIComponent(ADMIN_KEY)}`);
});



// âœ… ë‚´ í•™ì› í•™ìƒ ëª©ë¡ ë°ì´í„° API (JSON)
app.get("/api/branch/users", requireAdminLogin, async (req, res) => {
  try {
    const admin = req.session.admin;
    if (!admin) {
      return res.status(401).json({ ok: false, message: "ê´€ë¦¬ì ì„¸ì…˜ ì—†ìŒ" });
    }

    const academyName = admin.academyName;
    const adminGrade = admin.grade;      // ì„ ìƒë‹˜ í•™ë…„
    const adminClassNum = admin.classNum; // ì„ ìƒë‹˜ ë°˜
    const { q, status, sort } = req.query; // ê²€ìƒ‰ì–´ + ìƒíƒœ í•„í„°(ì˜µì…˜) + ì •ë ¬

    console.log("ğŸ” [/api/branch/users] í•„í„° ì¡°ê±´:", {
      academyName,
      adminGrade,
      adminClassNum
    });

    // ê¸°ë³¸ í•„í„°: ë‚´ í•™ì› + íœ´ì§€ ì•„ë‹˜
    const filter = {
      school: academyName,
      deleted: { $ne: true },
    };

    // âœ… "ì „ì²´" í•™ë…„ ì„ íƒ ì‹œ í•™ë…„ í•„í„°ë§ ê±´ë„ˆë›°ê¸° (í•´ë‹¹ í•™êµ ì „ì²´ í•™ë…„ í‘œì‹œ)
    if (adminGrade && adminGrade !== "ì „ì²´") {
      filter.grade = adminGrade;
    }
    // âœ… "ì „ì²´" ë°˜ ì„ íƒ ì‹œ ë°˜ í•„í„°ë§ ê±´ë„ˆë›°ê¸° (í•´ë‹¹ í•™êµ ì „ì²´ í•™ìƒ í‘œì‹œ)
    if (adminClassNum && adminClassNum !== "ì „ì²´") {
      filter.classNum = adminClassNum;
    }

    // ğŸ‘‰ í•„ìš”í•˜ë©´ íŠ¹ì • ìƒíƒœë§Œ ë³´ê³  ì‹¶ì„ ë•Œ ì¿¼ë¦¬ë¡œ status=approved / pending ë„˜ê¸¸ ìˆ˜ ìˆìŒ
    if (status === "approved" || status === "pending") {
      filter.status = status;
    }
    // ì•„ë¬´ê²ƒë„ ì•ˆ ë„˜ê¸°ë©´ ìŠ¹ì¸/ëŒ€ê¸° ë‘˜ ë‹¤ ì¡°íšŒë¨

    // ğŸ‘‰ ì´ë¦„/í•™ë…„/ì „í™”ë²ˆí˜¸ ê²€ìƒ‰(í”„ë¡ íŠ¸ì—ì„œ q ì¨ì„œ ë³´ë‚´ë˜ ê±° ì‹¤ì œë¡œ ë°˜ì˜)
    if (q && q.trim() !== "") {
      const kw = q.trim();
      const regex = new RegExp(kw, "i");
      filter.$or = [
        { name: regex },
        { grade: regex },
        { phone: regex },
        { id: regex },
      ];
    }

    // ì •ë ¬ ì˜µì…˜
    let sortOption = { lastLogin: -1, name: 1 };
    switch (sort) {
      case "lastLoginAsc":
        sortOption = { lastLogin: 1, name: 1 };
        break;
      case "gradeAsc":
        sortOption = { grade: 1, name: 1 };
        break;
      case "gradeDesc":
        sortOption = { grade: -1, name: 1 };
        break;
      case "nameAsc":
        sortOption = { name: 1 };
        break;
      case "nameDesc":
        sortOption = { name: -1 };
        break;
      default:
        sortOption = { lastLogin: -1, name: 1 };
    }

    // ì„¸ ì¿¼ë¦¬ë¥¼ ë³‘ë ¬ë¡œ ì‹¤í–‰ (ìŠˆí¼ê´€ë¦¬ìì™€ ë™ì¼í•œ ë°©ì‹)
    const [usersResult, allProgress, allLearningLogs] = await Promise.all([
      User.find(filter).sort(sortOption).lean(),
      UserProgress.find({}, { grade: 1, name: 1, school: 1, 'studyRoom.autoTaskSchedules': 1, 'studyRoom.assignedTasks': 1 }).lean(),
      LearningLog.find({ completed: true, deleted: { $ne: true } }, { grade: 1, name: 1, unit: 1, school: 1 }).lean()
    ]);
    let users = usersResult;

    // UserProgressë¥¼ Mapìœ¼ë¡œ ë³€í™˜
    const progressMap = new Map();
    for (const p of allProgress) {
      progressMap.set(`${p.grade}|${p.name}`, p);
    }

    // LearningLogë¥¼ Map<í•™ìƒí‚¤, Set<ì™„ë£Œëœ ë‹¨ì›>>ìœ¼ë¡œ ë³€í™˜
    // í•™ë…„|ì´ë¦„ í‚¤ì™€ í•™êµ|ì´ë¦„ í‚¤ ë‘ ê°€ì§€ë¡œ ë§¤í•‘ (ë³µêµ¬ëœ í•™ìƒë„ ë§¤ì¹­ë˜ë„ë¡)
    const completedUnitsMap = new Map();
    const completedUnitsMapBySchoolName = new Map(); // í•™êµ|ì´ë¦„ ê¸°ì¤€ í´ë°±ìš©
    for (const log of allLearningLogs) {
      const key = `${log.grade}|${log.name}`;
      if (!completedUnitsMap.has(key)) {
        completedUnitsMap.set(key, new Set());
      }
      completedUnitsMap.get(key).add(log.unit);

      // í•™êµ|ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œë„ ë§¤í•‘ (í´ë°±ìš©)
      if (log.school) {
        const schoolKey = `${log.school}|${log.name}`;
        if (!completedUnitsMapBySchoolName.has(schoolKey)) {
          completedUnitsMapBySchoolName.set(schoolKey, new Set());
        }
        completedUnitsMapBySchoolName.get(schoolKey).add(log.unit);
      }
    }

    // ì´ë¦„ë§Œìœ¼ë¡œ ë§¤í•‘ (ìµœí›„ì˜ í´ë°±)
    const completedUnitsMapByName = new Map();
    for (const log of allLearningLogs) {
      if (!completedUnitsMapByName.has(log.name)) {
        completedUnitsMapByName.set(log.name, new Set());
      }
      completedUnitsMapByName.get(log.name).add(log.unit);
    }

    // ê° userì— ëŒ€í•´ UserProgress ë°ì´í„° ë³‘í•© (ë©”ëª¨ë¦¬ì—ì„œ ë§¤í•‘)
    for (let i = 0; i < users.length; i++) {
      const user = users[i];
      // UserProgress ë§¤ì¹­ (í•™ë…„|ì´ë¦„ ìš°ì„ , í•™êµ|ì´ë¦„ í´ë°±, ì´ë¦„ë§Œ ìµœí›„ í´ë°±)
      let progress = progressMap.get(`${user.grade}|${user.name}`);
      if (!progress && user.school) {
        // í•™êµ|ì´ë¦„ìœ¼ë¡œ ì‹œë„
        for (const [key, p] of progressMap) {
          if (key.endsWith(`|${user.name}`) && p.school === user.school) {
            progress = p;
            break;
          }
        }
      }
      if (progress && progress.studyRoom) {
        users[i].studyRoom = progress.studyRoom;
      }

      // ì™„ë£Œëœ ë‹¨ì› Setì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
      // 1. í•™ë…„|ì´ë¦„ìœ¼ë¡œ ë¨¼ì € ì‹œë„
      let completedUnitsSet = completedUnitsMap.get(`${user.grade}|${user.name}`);
      // 2. í•™êµ|ì´ë¦„ìœ¼ë¡œ í´ë°±
      if ((!completedUnitsSet || completedUnitsSet.size === 0) && user.school) {
        completedUnitsSet = completedUnitsMapBySchoolName.get(`${user.school}|${user.name}`);
      }
      // 3. ì´ë¦„ë§Œìœ¼ë¡œ ìµœí›„ í´ë°± (ê°™ì€ í•™êµ ë‚´ì—ì„œ ì´ë¦„ì´ ìœ ì¼í•  ë•Œë§Œ ì ìš©)
      if ((!completedUnitsSet || completedUnitsSet.size === 0)) {
        completedUnitsSet = completedUnitsMapByName.get(user.name);
      }
      users[i].completedUnits = Array.from(completedUnitsSet || new Set());
    }

    // ìŠ¹ì¸ëŒ€ê¸° í•™ìƒì„ í•­ìƒ ë§¨ ìœ„ë¡œ ì •ë ¬
    users = users.sort((a, b) => {
      const statusA = a.status || 'approved';
      const statusB = b.status || 'approved';
      if (statusA === 'pending' && statusB !== 'pending') return -1;
      if (statusA !== 'pending' && statusB === 'pending') return 1;
      return 0;
    });

    return res.json({
      ok: true,
      academyName,
      adminGrade: adminGrade || "",
      adminClassNum: adminClassNum || "",
      count: users.length,
      students: users,
      users,
    });
  } catch (err) {
    console.error("âŒ /api/branch/users ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜" });
  }
});

// ë¸Œëœì¹˜ ê´€ë¦¬ììš© í•™ìŠµ ì´ë ¥ ë°ì´í„° API
app.get("/api/branch/logs", requireAdminLogin, async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: "grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤."
      });
    }

    const logs = await LearningLog.find({ grade, name, deleted: { $ne: true } })
      .sort({ timestamp: -1 })
      .lean();

    return res.json({
      ok: true,
      count: logs.length,
      logs
    });
  } catch (err) {
    console.error("âŒ /api/branch/logs ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜" });
  }
});

// ë¸Œëœì¹˜ ê´€ë¦¬ììš© AI ì¶”ì²œê³¼ì œ ëª©ë¡ API (í•™ì›ë³„ í•„í„°ë§)
app.get('/api/branch/ai-tasks', requireAdminLogin, async (req, res) => {
  try {
    const admin = req.session.admin;
    if (!admin) {
      return res.status(401).json({ ok: false, message: "ê´€ë¦¬ì ì„¸ì…˜ ì—†ìŒ" });
    }

    const academyName = admin.academyName;

    // í•´ë‹¹ í•™ì› í•™ìƒë“¤ì˜ UserProgressë§Œ ì¡°íšŒ
    const allProgress = await UserProgress.find({ school: academyName });

    const aiTasksList = [];

    for (const progress of allProgress) {
      const aiTasks = progress.studyRoom?.assignedTasks?.filter(t => t.isAI) || [];

      aiTasks.forEach(task => {
        aiTasksList.push({
          grade: progress.grade,
          name: progress.name,
          school: progress.school || academyName,
          taskTitle: task.title,
          series: task.series,
          field: task.field || task.domain,
          subject: task.subject,
          assignedAt: task.assignedAt,
          status: task.status,
          unitId: task.id || task.unitId
        });
      });
    }

    // ë¶€ì—¬ì‹œê°„ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
    aiTasksList.sort((a, b) => {
      const dateA = new Date(a.assignedAt || 0);
      const dateB = new Date(b.assignedAt || 0);
      return dateB - dateA;
    });

    res.json({
      ok: true,
      tasks: aiTasksList,
      total: aiTasksList.length,
      academyName
    });

  } catch (error) {
    console.error('AI ì¶”ì²œê³¼ì œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜ (ë¸Œëœì¹˜):', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ê´€ë¦¬ì íšŒì›ê°€ì… í˜ì´ì§€ (GET)
app.get("/admin-signup", (req, res) => {
  console.log("âœ… [GET] /admin-signup -> public/admin_signup.html");
  res.sendFile(path.join(__dirname, "public", "admin_signup.html"));
});

/// ê´€ë¦¬ì íšŒì›ê°€ì… ì²˜ë¦¬ (POST)
app.post("/admin-signup", async (req, res) => {
  try {
    const { academyName, grade, classNum, name, birth, phone } = req.body;
    console.log("ğŸ“¥ [POST] /admin-signup:", req.body);

    // í•„ìˆ˜ê°’ ì²´í¬
    if (!academyName || !grade || !classNum || !name || !birth || !phone) {
      return res.status(400).send("í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }

    // ê°„ë‹¨ ì¤‘ë³µ ì²´í¬: ê°™ì€ í•™ì›ëª… + í•™ë…„ + ë°˜ + ì´ë¦„ + ì „í™”ë²ˆí˜¸
    const exists = await Admin.findOne({ academyName, grade, classNum, name, phone });
    if (exists) {
      console.log("â›” ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê´€ë¦¬ì:", academyName, grade, classNum, name, phone);
      return res.redirect("/admin-login");
    }

    // ğŸ”¥ ì–´ë“œë¯¼(ìŠˆí¼ê´€ë¦¬ì) ê³„ì •ì¸ì§€ í™•ì¸
    let isSuper = false;
    let status = "approved"; // ê¸°ë³¸ê°’: ê´€ë¦¬ì ê³„ì •ì€ ì¼ë‹¨ ìŠ¹ì¸

    if (
      academyName === "ì–´ë“œë¯¼" &&
      name === "ì–´ë“œë¯¼" &&
      birth === "830911" &&
      phone === "01012341234"
    ) {
      // ì´ ì¡°í•©ìœ¼ë¡œ ê°€ì…í•˜ë©´ 'ìŠˆí¼ê´€ë¦¬ì'
      isSuper = true;
      status = "approved"; // ìŠˆí¼ê´€ë¦¬ìëŠ” ë¬´ì¡°ê±´ ìŠ¹ì¸
    }

    // ê´€ë¦¬ì ê³„ì • ìƒì„±
    await Admin.create({
      academyName,
      grade,
      classNum,
      name,
      birth,
      phone,
      isSuper, // âœ… ì—¬ê¸°ì„œ true/false ì €ì¥
      status,
    });

    console.log(
      "âœ… ê´€ë¦¬ì íšŒì›ê°€ì… ì™„ë£Œ:",
      academyName,
      name,
      isSuper ? "(ìŠˆí¼ê´€ë¦¬ì)" : ""
    );
    return res.redirect("/admin-login");
  } catch (err) {
    console.error("âŒ /admin-signup ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ê´€ë¦¬ì ë¡œê·¸ì¸ ì²˜ë¦¬ (POST)
app.post("/admin-login", async (req, res) => {
  try {
    const { academyName, grade, classNum, name, birth, phone } = req.body;
    console.log("ğŸ“¥ [POST] /admin-login:", req.body);

    // ğŸ”¥ ìŠˆí¼ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œë„ ì—¬ë¶€ í™•ì¸ (grade/classNum ì—†ì´ë„ ë¡œê·¸ì¸ ê°€ëŠ¥)
    const isSuperLogin =
      academyName === "ì–´ë“œë¯¼" &&
      name === "ì–´ë“œë¯¼" &&
      birth === "830911" &&
      phone === "01012341234";

    // DBì—ì„œ ê´€ë¦¬ì ì°¾ê¸° (ìŠˆí¼ê´€ë¦¬ìëŠ” grade/classNum ì—†ì´ ê²€ìƒ‰)
    const query = isSuperLogin
      ? { academyName, name, birth, phone }
      : { academyName, grade, classNum, name, birth, phone };

    const admin = await Admin.findOne(query);

    if (!admin) {
      console.log("âŒ ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨: ì¼ì¹˜í•˜ëŠ” ê³„ì • ì—†ìŒ");
      return res.redirect("/admin-login?error=invalid");
    }

    // ğŸ”’ ìŠˆí¼ê´€ë¦¬ìê°€ ì•„ë‹Œë° ìŠ¹ì¸ ëŒ€ê¸°ë©´ ë¡œê·¸ì¸ ë§‰ê¸°
    if (!isSuperLogin && admin.status === "pending") {
      console.log("â›” ìŠ¹ì¸ ëŒ€ê¸° ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œë„:", admin.name);
      return res.redirect("/admin-login?error=pending");
    }

    // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
    admin.lastLogin = new Date();
    await admin.save();

    // ì„¸ì…˜ì— ê´€ë¦¬ì ì •ë³´ ì €ì¥ (isSuper ì—¬ë¶€ í¬í•¨)
    req.session.admin = {
      id: admin._id.toString(),
      academyName: admin.academyName,
      name: admin.name,
      role: admin.role,
      grade: admin.grade || "",       // âœ… ì„ ìƒë‹˜ í•™ë…„ ì¶”ê°€
      classNum: admin.classNum || "", // âœ… ì„ ìƒë‹˜ ë°˜ ì¶”ê°€
      isSuper: isSuperLogin,   // âœ… ì—¬ê¸°!
    };

    console.log(
      "âœ… ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ:",
      admin.academyName,
      admin.name,
      isSuperLogin ? "(ìŠˆí¼ê´€ë¦¬ì)" : ""
    );

    // ğŸ”€ ë¶„ê¸°: ìŠˆí¼ê´€ë¦¬ì / ì¼ë°˜ ë¸Œëœì¹˜ ê´€ë¦¬ì
    if (isSuperLogin) {
      return res.redirect("/super/dashboard");
    } else {
      // ğŸ” ë¸Œëœì¹˜ ê´€ë¦¬ì PINì´ ì—†ìœ¼ë©´ ìƒë…„ì›”ì¼ë¡œ ìë™ ì„¤ì •
      if (!admin.pin) {
        admin.pin = admin.birth; // ìƒë…„ì›”ì¼ 6ìë¦¬ë¥¼ ì´ˆê¸° PINìœ¼ë¡œ ì„¤ì •
        await admin.save();
        console.log("ğŸ” ë¸Œëœì¹˜ ê´€ë¦¬ì PIN ìë™ ì„¤ì • (ìƒë…„ì›”ì¼):", admin.name, admin.pin);
      }
      // í•­ìƒ PIN ì…ë ¥ í˜ì´ì§€ë¡œ
      req.session.adminPinRequired = true;
      return res.redirect("/admin/pin");
    }
  } catch (err) {
    console.error("âŒ /admin-login ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});




// ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (GET)
app.get("/admin/dashboard", requireAdminLogin, (req, res) => {
  console.log(
    "âœ… [GET] /admin/dashboard -> public/admin_dashboard.html",
    "admin:",
    req.session.admin && req.session.admin.academyName
  );
  res.sendFile(path.join(__dirname, "public", "admin_dashboard.html"));
});

/* ====================================
 * âœ… ìŠˆí¼ê´€ë¦¬ì: ê´€ë¦¬ì ê³„ì • ëª©ë¡ / ìƒíƒœ ë³€ê²½ / ì‚­ì œ
 * ==================================== */

// ğŸ”¹ ê´€ë¦¬ì ê³„ì • ëª©ë¡ í˜ì´ì§€
// ğŸ”¹ ê´€ë¦¬ì ê³„ì • ëª©ë¡ í˜ì´ì§€
app.get("/super/admins", requireSuperAdmin, async (req, res) => {
  try {
    // ì‚­ì œ ì•ˆ ëœ ê´€ë¦¬ìë§Œ
    const admins = await Admin.find({ deleted: { $ne: true } })
      .sort({ academyName: 1, name: 1 })
      .lean();

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>ê´€ë¦¬ì ê³„ì • ëª©ë¡</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        :root {
          --bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          --panel: #ffffff;
          --accent: #495057;
          --accent-hover: #212529;
          --text: #212529;
          --text-light: #495057;
          --line: #dee2e6;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          padding: 40px 20px;
          background: var(--bg);
          font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
          color: var(--text);
          min-height: 100vh;
        }
        .wrap {
          max-width: 1200px;
          margin: 0 auto;
        }
        h1 {
          margin: 0 0 12px;
          font-size: 32px;
          font-weight: 700;
          color: #212529;
          text-shadow: none;
        }
        .desc {
          margin: 0 0 24px;
          font-size: 15px;
          color: #495057;
          line-height: 1.6;
        }
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 16px;
          flex-wrap: wrap;
          margin-bottom: 30px;
        }
        .btn-back {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: 2px solid rgba(73, 80, 87, 0.2);
          background: rgba(255,255,255,0.9);
          backdrop-filter: blur(10px);
          color: #212529;
          text-decoration: none;
          transition: all 0.3s ease;
        }
        .btn-back:hover {
          background: rgba(255,255,255,1);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .info-line {
          background: rgba(255,255,255,0.95);
          padding: 12px 20px;
          border-radius: 12px;
          font-size: 14px;
          color: var(--text);
          margin: 0 0 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .table-wrap {
          background: var(--panel);
          border-radius: 20px;
          padding: 24px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.1);
          border: 2px solid rgba(102, 126, 234, 0.1);
          overflow-x: auto;
        }
        table {
          border-collapse: collapse;
          width: 100%;
          min-width: 1000px;
          font-size: 14px;
        }
        th, td {
          border-bottom: 1px solid var(--line);
          padding: 14px 12px;
          text-align: left;
          font-weight: 500;
          color: var(--text);
          font-size: 14px;
        }
        th {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          font-weight: 600;
          color: white;
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          position: sticky;
          top: 0;
          z-index: 10;
        }
        tbody tr {
          transition: all 0.2s ease;
        }
        tbody tr:hover {
          background: #f9fafb;
          transform: scale(1.001);
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
        }
        .badge-approved {
          background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
          color: #065f46;
        }
        .badge-pending {
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          color: #92400e;
        }
        .badge-super {
          background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
          color: #6b21a8;
        }

        a.link {
          font-size: 13px;
          color: var(--accent);
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
        }
        a.link:hover {
          color: var(--accent-hover);
          text-decoration: underline;
        }
        a.link-danger {
          font-size: 13px;
          color: #dc2626;
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
        }
        a.link-danger:hover {
          color: #991b1b;
          text-decoration: underline;
        }

        @media (max-width: 768px) {
          body {
            padding: 20px 12px;
          }
          h1 {
            font-size: 24px;
          }
          .top-bar {
            flex-direction: column;
            align-items: flex-start;
          }
          .table-wrap {
            padding: 16px;
          }
        }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="top-bar">
          <div>
            <h1>ê´€ë¦¬ì(ì„ ìƒë‹˜) ê³„ì • ëª©ë¡</h1>
            <p class="desc">
              ì„ ìƒë‹˜ ê´€ë¦¬ì ê³„ì •ì„ í•œëˆˆì— í™•ì¸í•˜ê³ ,<br/>
              ìŠ¹ì¸ ìƒíƒœ ë³€ê²½ ë° ì‚­ì œ(íœ´ì§€ ì²˜ë¦¬)ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          <a href="/super/dashboard" class="btn-back">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <p class="info-line">
          ì´ <strong>${admins.length}</strong>ê°œì˜ ê´€ë¦¬ì ê³„ì •ì´ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>í•™êµëª…</th>
                <th>ì´ë¦„</th>
                <th>í•™ë…„</th>
                <th>ë°˜</th>
                <th>ì „í™”ë²ˆí˜¸(ID)</th>
                <th>ìƒë…„ì›”ì¼</th>
                <th>ê¶Œí•œ</th>
                <th>ìƒíƒœ</th>
                <th>ê°€ì…ì¼</th>
                <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                <th>ìˆ˜ì •</th>
                <th>ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody>
    `;

    admins.forEach((a, idx) => {
      const status = a.status || "approved";
      const statusLabel = status === "approved" ? "ìŠ¹ì¸" : "ëŒ€ê¸°";
      const statusClass =
        status === "approved" ? "badge-approved" : "badge-pending";

      const createdAt = a.createdAt
        ? new Date(a.createdAt).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
        : "-";
      const lastLogin = a.lastLogin
        ? new Date(a.lastLogin).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
        : "-";

      // ìƒíƒœ ë²„íŠ¼ (ëŒ€ê¸° â†’ ìŠ¹ì¸ / ìŠ¹ì¸ â†’ ëŒ€ê¸°)
let statusToggleLink = "";

if (status === "pending") {
  // ëŒ€ê¸° ìƒíƒœ â†’ ìŠ¹ì¸ ë²„íŠ¼ë§Œ í‘œì‹œ
  statusToggleLink = `
    <a class="link"
       href="/super/admin-status?id=${a._id}&status=approved"
       onclick="return confirm('ì´ ê´€ë¦¬ìë¥¼ ìŠ¹ì¸ ìƒíƒœë¡œ ë³€ê²½í• ê¹Œìš”?');">
       ìŠ¹ì¸í•˜ê¸°
    </a>
  `;
} else {
  // ìŠ¹ì¸ ìƒíƒœ â†’ ëŒ€ê¸°ë¡œ ì „í™˜
  statusToggleLink = `
    <a class="link"
       href="/super/admin-status?id=${a._id}&status=pending"
       onclick="return confirm('ì´ ê´€ë¦¬ì ìƒíƒœë¥¼ ëŒ€ê¸°ë¡œ ë³€ê²½í• ê¹Œìš”?');">
       ëŒ€ê¸° ì „í™˜
    </a>
  `;
}

               // ğŸ”¹ ê´€ë¦¬ì ì •ë³´ ìˆ˜ì • í™”ë©´
app.get("/super/admin-edit", requireSuperAdmin, async (req, res) => {
  const { id } = req.query;
  if (!id) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  try {
    const admin = await Admin.findById(id);
    if (!admin) return res.status(404).send("ê´€ë¦¬ì ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    const isSuper = admin.isSuper;

    const html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>ê´€ë¦¬ì ì •ë³´ ìˆ˜ì •</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        body {
font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
          padding: 20px;
          background:#f2ede5;
        }
        .card {
          max-width: 520px;
          margin: 0 auto;
          background:#fffaf3;
          border-radius: 12px;
          padding: 20px 22px 24px;
          box-shadow:0 10px 24px rgba(0,0,0,0.08);
          border:1px solid rgba(0,0,0,0.04);
        }
        h1 {
          margin: 0 0 12px;
          font-size: 22px;
        }
        .small { font-size:12px; color:#7a6a5b; margin-bottom:16px; }
        label {
          display:block;
          margin:8px 0 4px;
          font-size:13px;
        }
        input[type="text"] {
          width:100%;
          padding:7px 10px;
          font-size:14px;
          border-radius:8px;
          border:1px solid #d3c2af;
        }
        select {
          width:100%;
          padding:7px 10px;
          font-size:14px;
          border-radius:8px;
          border:1px solid #d3c2af;
          background:#fff;
        }
        .row { margin-bottom:8px; }
        .actions {
          margin-top:16px;
          display:flex;
          gap:8px;
        }
        button {
          padding:8px 16px;
          font-size:14px;
          border-radius:999px;
          border:1px solid #8b2f2f;
          background:#8b2f2f;
          color:#fff;
          cursor:pointer;
        }
        button:hover { opacity:.93; }
        a.back {
          padding:8px 14px;
          font-size:13px;
          border-radius:999px;
          border:1px solid #c59f7b;
          background:#fdf7ef;
          color:#5a3b23;
          text-decoration:none;
          display:inline-flex;
          align-items:center;
        }
        .badge-super {
          display:inline-block;
          margin-left:6px;
          padding:2px 7px;
          border-radius:999px;
          font-size:11px;
          background:#ede7f6;
          color:#5e35b1;
        }
      </style>
    </head>
    <body>
      <div class="card">
        <h1>ê´€ë¦¬ì ì •ë³´ ìˆ˜ì • ${isSuper ? '<span class="badge-super">ìŠˆí¼ê´€ë¦¬ì</span>' : ''}</h1>
        <p class="small">
          ê´€ë¦¬ì ê¸°ë³¸ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.${isSuper ? "<br>â€» ìŠˆí¼ê´€ë¦¬ì ê³„ì •ì€ ì•ˆì „ì„ ìœ„í•´ ì„œë²„ ì½”ë“œì—ì„œë§Œ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤." : ""}
        </p>

        <form method="POST" action="/super/admin-edit">
          <input type="hidden" name="id" value="${admin._id.toString()}" />

          <div class="row">
            <label>í•™êµëª…</label>
            <input type="text" name="academyName" value="${admin.academyName || ""}" />
          </div>

          <div class="row">
            <label>ì§ì±…</label>
            <input type="text" name="role" value="${admin.role || ""}" />
          </div>

          <div class="row">
            <label>ì´ë¦„</label>
            <input type="text" name="name" value="${admin.name || ""}" />
          </div>

          <div class="row">
            <label>ìƒë…„ì›”ì¼ (ì˜ˆ: 900305)</label>
            <input type="text" name="birth" value="${admin.birth || ""}" />
          </div>

          <div class="row">
            <label>ì „í™”ë²ˆí˜¸ (ë¡œê·¸ì¸ ID / ë¹„ë°€ë²ˆí˜¸)</label>
            <input type="text" name="phone" value="${admin.phone || ""}" />
          </div>

          <div class="row">
            <label>ìƒíƒœ</label>
            <select name="status">
              <option value="approved" ${admin.status === "approved" ? "selected" : ""}>ìŠ¹ì¸</option>
              <option value="pending" ${admin.status === "pending" ? "selected" : ""}>ëŒ€ê¸°</option>
            </select>
          </div>

          <div class="row">
            <label>PIN ë²ˆí˜¸ (6ìë¦¬ ìˆ«ì, ë¹„ì›Œë‘ë©´ PIN ì¸ì¦ ì—†ìŒ)</label>
            <input type="text" name="pin" value="${admin.pin || ""}" maxlength="6" pattern="[0-9]*" placeholder="ì˜ˆ: 123456" style="letter-spacing: 8px; font-weight: bold;" />
            <small style="color:#888; font-size:11px;">â€» PINì„ ì„¤ì •í•˜ë©´ ë¡œê·¸ì¸ ì‹œ ì¶”ê°€ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‚­ì œí•˜ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”.</small>
          </div>

          <div class="actions">
            <button type="submit">ì €ì¥í•˜ê¸°</button>
            <a class="back" href="/super/admins">â† ëª©ë¡ìœ¼ë¡œ</a>
          </div>
        </form>
      </div>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /super/admin-edit(GET) ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì ìˆ˜ì • í™”ë©´ ìƒì„± ì¤‘ ì˜¤ë¥˜");
  }
});

// ğŸ”¹ ê´€ë¦¬ì ì •ë³´ ìˆ˜ì • ì²˜ë¦¬
app.post("/super/admin-edit", requireSuperAdmin, async (req, res) => {
  const { id, academyName, role, name, birth, phone, status, pin } = req.body;

  if (!id) return res.status(400).send("id ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");

  try {
    const admin = await Admin.findById(id);
    if (!admin) return res.status(404).send("ê´€ë¦¬ì ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    // ìŠˆí¼ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œ/ìˆ˜ì • ìµœì†Œí™” â€“ í•„ìš”í•˜ë©´ ì—¬ê¸° ì¡°ê±´ ë°”ê¿”ë„ ë¨
    if (admin.isSuper) {
      return res.status(400).send("ìŠˆí¼ê´€ë¦¬ì ê³„ì •ì€ ì—¬ê¸°ì„œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    admin.academyName = academyName || "";
    admin.role        = role || "";
    admin.name        = name || "";
    admin.birth       = birth || "";
    admin.phone       = phone || "";
    if (status === "approved" || status === "pending") {
      admin.status = status;
    }

    // ğŸ” PIN ì„¤ì • (ë¹ˆ ê°’ì´ë©´ nullë¡œ ì €ì¥í•˜ì—¬ PIN ì¸ì¦ í•´ì œ)
    if (pin && pin.length === 6 && /^\d{6}$/.test(pin)) {
      admin.pin = pin;
    } else {
      admin.pin = null; // PIN í•´ì œ
    }

    await admin.save();
    console.log("âœ… ê´€ë¦¬ì ì •ë³´ ìˆ˜ì • ì™„ë£Œ:", admin.academyName, admin.name, admin.pin ? "(PIN ì„¤ì •ë¨)" : "(PIN ì—†ìŒ)");

    res.redirect("/super/admins");
  } catch (err) {
    console.error("âŒ /super/admin-edit(POST) ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜");
  }
});


      // ìŠˆí¼ê´€ë¦¬ìëŠ” ì‚­ì œ ë§‰ê¸°
      const deleteCell = a.isSuper
        ? `<span style="font-size:12px; color:#999;">ì‚­ì œ ë¶ˆê°€</span>`
        : `<a class="link-danger"
               href="/super/admin-delete?id=${a._id}"
               onclick="return confirm('ì´ ê´€ë¦¬ì ê³„ì •ì„ ì‚­ì œ(íœ´ì§€)í• ê¹Œìš”?\\n[${a.academyName} / ${a.name}]');">
              ì‚­ì œ
           </a>`;

      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${a.academyName || ""}</td>
          <td>${a.name || ""}</td>
          <td>${a.grade || ""}</td>
          <td>${a.classNum || ""}</td>
          <td>${a.phone || ""}</td>
          <td>${a.birth || "-"}</td>
          <td>
            ${a.isSuper ? '<span class="badge badge-super">ìŠˆí¼ê´€ë¦¬ì</span>' : 'ë¸Œëœì¹˜ ê´€ë¦¬ì'}
          </td>
          <td>
            <span class="badge ${statusClass}">${statusLabel}</span>
            ${statusToggleLink}
          </td>
          <td>${createdAt}</td>
          <td>${lastLogin}</td>
          <td>
            <a class="link" href="/super/admin-edit?id=${a._id}">ìˆ˜ì •</a>
          </td>
          <td>${deleteCell}</td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /super/admins ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});


// ğŸ”¹ ê´€ë¦¬ì ìƒíƒœ ë³€ê²½ (ìŠ¹ì¸ / ëŒ€ê¸°)
app.get("/super/admin-status", requireSuperAdmin, async (req, res) => {
  const { id, status } = req.query;
  const allowed = ["approved", "pending"];

  if (!id) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  if (!allowed.includes(status)) {
    return res.status(400).send("ìœ íš¨í•˜ì§€ ì•Šì€ status ê°’ì…ë‹ˆë‹¤.");
  }

  try {
    const admin = await Admin.findById(id);
    if (!admin) return res.status(404).send("ê´€ë¦¬ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    admin.status = status;
    await admin.save();

    console.log("âœ… ê´€ë¦¬ì ìƒíƒœ ë³€ê²½:", admin.name, "=>", status);
    res.redirect("/super/admins");
  } catch (err) {
    console.error("âŒ /super/admin-status ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜");
  }
});

// ğŸ”¹ ê´€ë¦¬ì ì‚­ì œ(íœ´ì§€ ì²˜ë¦¬)
app.get("/super/admin-delete", requireSuperAdmin, async (req, res) => {
  const { id } = req.query;
  if (!id) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  try {
    const admin = await Admin.findById(id);
    if (!admin) return res.status(404).send("ê´€ë¦¬ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    if (admin.isSuper) {
      return res.status(400).send("ìŠˆí¼ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    admin.deleted = true;
    admin.deletedAt = new Date();
    await admin.save();

    console.log("ğŸ—‘ ê´€ë¦¬ì ì‚­ì œ(íœ´ì§€):", admin.academyName, admin.name);
    res.redirect("/super/admins");
  } catch (err) {
    console.error("âŒ /super/admin-delete ì—ëŸ¬:", err);
    res.status(500).send("ê´€ë¦¬ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜");
  }
});



/* ====================================
 * âœ… ìŠˆí¼ê´€ë¦¬ì: í•™ì›/ì§€ì  ëª©ë¡ / ì§€ì ë³„ í•™ìƒ
 * ==================================== */

// ğŸ”¹ í•™ì›/ì§€ì  ëª©ë¡ í˜ì´ì§€
app.get("/super/branches", requireSuperAdmin, async (req, res) => {
  try {
    // 1) ì „ì²´ í•™ìƒ / ê´€ë¦¬ì ë¶ˆëŸ¬ì˜¤ê¸°
    const users = await User.find({ deleted: { $ne: true } }).lean();
    const admins = await Admin.find({ deleted: { $ne: true } }).lean();

    // 2) í•™ì›/ì§€ì  + ë°˜ë³„ë¡œ ë¬¶ê¸°
    const branchMap = {};

    // ê´€ë¦¬ì ê¸°ì¤€(í•™ì›ëª…) - ê´€ë¦¬ìëŠ” ë°˜ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ í•™êµ ë‹¨ìœ„ë¡œë§Œ ì¹´ìš´íŠ¸
    const adminCountBySchool = {};
    admins.forEach((a) => {
      const name = a.academyName || "í•™ì›ëª… ë¯¸ì…ë ¥";
      adminCountBySchool[name] = (adminCountBySchool[name] || 0) + 1;
    });

    // í•™ìƒ ê¸°ì¤€(í•™êµëª… + í•™ë…„ + ë°˜)
    users.forEach((u) => {
      const school = u.school || "í•™ì›ëª… ë¯¸ì…ë ¥";
      const grade = u.grade || "í•™ë…„ ë¯¸ì…ë ¥";
      const classNum = u.classNum || "ë°˜ ë¯¸ì…ë ¥";
      const key = `${school}___${grade}___${classNum}`; // í•™êµ+í•™ë…„+ë°˜ì„ í‚¤ë¡œ ì‚¬ìš©

      if (!branchMap[key]) {
        branchMap[key] = {
          academyName: school,
          grade: grade,
          classNum: classNum,
          adminCount: 0, // ë‚˜ì¤‘ì— í•™êµë³„ë¡œ ë¶„ë°°
          studentCount: 0,
          approvedCount: 0,
          pendingCount: 0,
        };
      }
      branchMap[key].studentCount += 1;
      if (u.status === "approved") {
        branchMap[key].approvedCount += 1;
      } else {
        branchMap[key].pendingCount += 1;
      }
    });

    // ê´€ë¦¬ì ìˆ˜ë¥¼ ê° í•™êµì˜ ì²« ë²ˆì§¸ ë°˜ì—ë§Œ í‘œì‹œ (ë˜ëŠ” ëª¨ë“  ë°˜ì— ë™ì¼í•˜ê²Œ)
    const schoolFirstRow = {};
    Object.keys(branchMap).forEach(key => {
      const school = branchMap[key].academyName;
      if (!schoolFirstRow[school]) {
        schoolFirstRow[school] = key;
        branchMap[key].adminCount = adminCountBySchool[school] || 0;
      }
    });

    const branches = Object.values(branchMap).sort((a, b) => {
      // ë¨¼ì € í•™êµëª…ìœ¼ë¡œ ì •ë ¬
      const schoolCompare = a.academyName.localeCompare(b.academyName, "ko");
      if (schoolCompare !== 0) return schoolCompare;
      // ê°™ì€ í•™êµë©´ í•™ë…„ìœ¼ë¡œ ì •ë ¬ (ìˆ«ì ì¶”ì¶œí•´ì„œ ë¹„êµ)
      const aGradeNum = parseInt(a.grade) || 999;
      const bGradeNum = parseInt(b.grade) || 999;
      if (aGradeNum !== bGradeNum) return aGradeNum - bGradeNum;
      // ê°™ì€ í•™ë…„ì´ë©´ ë°˜ìœ¼ë¡œ ì •ë ¬ (ìˆ«ì ì¶”ì¶œí•´ì„œ ë¹„êµ)
      const aClassNum = parseInt(a.classNum) || 999;
      const bClassNum = parseInt(b.classNum) || 999;
      return aClassNum - bClassNum;
    });

    // ğŸ”‘ ìŠˆí¼ê´€ë¦¬ììš© ë§í¬ì— ì“¸ keyëŠ” ì„œë²„ì—ì„œ ì§ì ‘ ë„£ì–´ì¤Œ
    const key = ADMIN_KEY;

    // 3) í™”ë©´ ë Œë”
    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>í•™ì›/ì§€ì  ëª©ë¡</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        :root {
          --bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          --panel: #ffffff;
          --accent: #495057;
          --accent-hover: #212529;
          --text: #212529;
          --text-light: #495057;
          --line: #dee2e6;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          padding: 40px 20px;
          background: var(--bg);
          font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
          color: var(--text);
          min-height: 100vh;
        }
        .wrap { max-width: 1400px; margin: 0 auto; }
        h1 {
          margin: 0 0 8px;
          font-size: 32px;
          font-weight: 700;
          color: #212529;
          text-shadow: none;
        }
        .desc {
          margin: 0 0 30px;
          font-size: 15px;
          color: #495057;
          line-height: 1.6;
        }
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          flex-wrap: wrap;
          gap: 20px;
          margin-bottom: 30px;
        }
        .btn-back {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: 2px solid rgba(73, 80, 87, 0.2);
          background: rgba(255,255,255,0.9);
          backdrop-filter: blur(10px);
          color: #212529;
          text-decoration: none;
          transition: all 0.3s ease;
        }
        .btn-back:hover {
          background: rgba(255,255,255,1);
          border-color: rgba(73, 80, 87, 0.4);
          transform: translateY(-2px);
        }

        .info-line {
          background: white;
          padding: 16px 20px;
          border-radius: 12px;
          margin-bottom: 20px;
          font-size: 14px;
          color: var(--text);
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .info-line strong {
          color: var(--accent);
          font-weight: 700;
        }

        .table-wrap {
          background: white;
          border-radius: 16px;
          padding: 0;
          box-shadow: 0 4px 20px rgba(0,0,0,0.08);
          overflow: hidden;
        }
        table {
          border-collapse: collapse;
          width: 100%;
          min-width: 1000px;
          font-size: 14px;
        }
        th, td {
          padding: 16px 14px;
          text-align: left;
          border-bottom: 1px solid #f3f4f6;
        }
        th {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          font-weight: 600;
          color: white;
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          position: sticky;
          top: 0;
          z-index: 10;
        }
        tbody tr:hover {
          background: #f9fafb;
          transform: scale(1.001);
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .btn-primary {
          display: inline-flex;
          align-items: center;
          padding: 8px 16px;
          font-size: 13px;
          font-weight: 600;
          border-radius: 8px;
          border: none;
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: #fff;
          text-decoration: none;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-trash {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: 2px solid rgba(239, 68, 68, 0.3);
          background: rgba(255,255,255,0.15);
          backdrop-filter: blur(10px);
          color: white;
          text-decoration: none;
          transition: all 0.3s ease;
        }
        .btn-trash:hover {
          background: rgba(255,255,255,0.25);
          border-color: rgba(239, 68, 68, 0.5);
          transform: translateY(-2px);
        }

        .btn-branch-del {
          display: inline-flex;
          align-items: center;
          padding: 8px 16px;
          font-size: 13px;
          font-weight: 600;
          border-radius: 8px;
          border: none;
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: #fff;
          text-decoration: none;
          margin-left: 8px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .btn-branch-del:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        @media (max-width:1024px){
          .wrap { padding: 30px 16px; }
          h1 { font-size: 28px; }
          .table-wrap {
            overflow-x: scroll;
          }
        }
        @media (max-width:720px){
          h1 { font-size: 24px; }
          th, td {
            font-size: 12px;
            padding: 12px 10px;
          }
        }

        /* ê²€ìƒ‰ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .search-box {
          display: flex;
          gap: 12px;
          margin-bottom: 20px;
          align-items: center;
          flex-wrap: wrap;
        }
        .search-input {
          flex: 1;
          min-width: 200px;
          max-width: 400px;
          padding: 12px 16px;
          border: 2px solid #dee2e6;
          border-radius: 12px;
          font-size: 14px;
          outline: none;
          transition: all 0.3s ease;
        }
        .search-input:focus {
          border-color: #495057;
          box-shadow: 0 0 0 3px rgba(73, 80, 87, 0.1);
        }
        .search-input::placeholder {
          color: #adb5bd;
        }
        .search-result-info {
          font-size: 13px;
          color: #6c757d;
        }
        .search-result-info strong {
          color: #495057;
        }
        .btn-reset {
          padding: 10px 16px;
          border: 2px solid #dee2e6;
          border-radius: 12px;
          background: white;
          color: #495057;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        .btn-reset:hover {
          background: #f8f9fa;
          border-color: #adb5bd;
        }
        .highlight {
          background-color: #fff3cd;
          padding: 0 2px;
          border-radius: 2px;
        }
        tr.hidden-row {
          display: none;
        }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="top-bar">
          <div>
            <h1>í•™êµ/í•™ë…„/ë°˜ ëª©ë¡</h1>
            <p class="desc">
              ë“±ë¡ëœ í•™êµ/í•™ë…„/í•™ê¸‰ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ê³ , í•™êµ/í•™ë…„/í•™ê¸‰ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™êµ/í•™ë…„/í•™ê¸‰ í•™ìƒë“¤ë§Œ ë”°ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          <div>
            <a href="/super/branch-trash" class="btn-trash">ğŸ—‘ í•™êµ íœ´ì§€í†µ</a>
            <a href="/super/dashboard" class="btn-back">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <div class="search-box">
          <input type="text" class="search-input" id="schoolSearch" placeholder="ğŸ” í•™êµëª…ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off" />
          <button type="button" class="btn-reset" id="resetSearch">ì´ˆê¸°í™”</button>
          <span class="search-result-info" id="searchResultInfo">
            ì´ <strong>${branches.length}</strong>ê°œì˜ í•™êµ/í•™ë…„/í•™ê¸‰
          </span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>í•™êµëª…</th>
                <th>í•™ë…„</th>
                <th>ë°˜</th>
                <th>ì„ ìƒë‹˜ ìˆ˜</th>
                <th>í•™ìƒ ìˆ˜</th>
                <th>ìŠ¹ì¸ í•™ìƒ</th>
                <th>ëŒ€ê¸° í•™ìƒ</th>
                <th>í•™ìƒ ëª©ë¡</th>
              </tr>
            </thead>
            <tbody>
    `;

     // ğŸ”¹ ê° ì§€ì +í•™ë…„+ë°˜ í•œ ì¤„ì”© ì¶œë ¥
    branches.forEach((b, idx) => {
      html += `
        <tr data-school="${b.academyName}" data-grade="${b.grade}" data-class="${b.classNum}" data-idx="${idx + 1}">
          <td class="row-num">${idx + 1}</td>
          <td class="school-name">${b.academyName}</td>
          <td>${b.grade}</td>
          <td>${b.classNum}</td>
          <td>${b.adminCount || '-'}</td>
          <td>${b.studentCount}</td>
          <td>${b.approvedCount}</td>
          <td>${b.pendingCount}</td>
          <td>
            <a class="btn-primary"
               href="/super/branch-users?academyName=${encodeURIComponent(
                 b.academyName
               )}&grade=${encodeURIComponent(b.grade)}&classNum=${encodeURIComponent(b.classNum)}">
              í•™ìƒ ëª©ë¡ ë³´ê¸°
            </a>
            <a class="btn-branch-del"
               href="/super/branch-delete?academyName=${encodeURIComponent(
                 b.academyName
               )}"
               onclick="return confirm('ì´ ì§€ì ì˜ ê´€ë¦¬ìì™€ í•™ìƒì„ ëª¨ë‘ íœ´ì§€ ìƒíƒœë¡œ ë³´ë‚¼ê¹Œìš”?\\n[${b.academyName}]');">
              í•™ê¸‰ ì‚­ì œ
            </a>
          </td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>

      <script>
        // í•™êµ ê²€ìƒ‰ ê¸°ëŠ¥
        const searchInput = document.getElementById('schoolSearch');
        const resetBtn = document.getElementById('resetSearch');
        const resultInfo = document.getElementById('searchResultInfo');
        const tbody = document.querySelector('tbody');
        const allRows = tbody.querySelectorAll('tr');
        const totalCount = ${branches.length};

        // ì›ë³¸ í•™êµëª… ì €ì¥
        allRows.forEach(row => {
          const schoolCell = row.querySelector('.school-name');
          if (schoolCell) {
            row.dataset.originalSchool = schoolCell.textContent;
          }
        });

        function doSearch() {
          const keyword = searchInput.value.trim().toLowerCase();
          let visibleCount = 0;
          let num = 0;

          allRows.forEach(row => {
            const schoolName = row.dataset.school || '';
            const schoolCell = row.querySelector('.school-name');
            const numCell = row.querySelector('.row-num');

            // ì›ë³¸ ë³µì›
            if (row.dataset.originalSchool) {
              schoolCell.textContent = row.dataset.originalSchool;
            }

            if (!keyword || schoolName.toLowerCase().includes(keyword)) {
              row.classList.remove('hidden-row');
              visibleCount++;
              num++;
              // ë²ˆí˜¸ ì¬ì •ë ¬
              if (numCell) numCell.textContent = num;
              // í•˜ì´ë¼ì´íŠ¸
              if (keyword && schoolCell) {
                const original = row.dataset.originalSchool;
                const escaped = keyword.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, String.fromCharCode(92) + String.fromCharCode(36) + '&');
                const regex = new RegExp('(' + escaped + ')', 'gi');
                schoolCell.innerHTML = original.replace(regex, '<span class="highlight">' + String.fromCharCode(36) + '1</span>');
              }
            } else {
              row.classList.add('hidden-row');
            }
          });

          // ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ ì—…ë°ì´íŠ¸
          if (keyword) {
            resultInfo.innerHTML = 'ê²€ìƒ‰ ê²°ê³¼: <strong>' + visibleCount + '</strong>ê°œ (ì „ì²´ ' + totalCount + 'ê°œ)';
          } else {
            resultInfo.innerHTML = 'ì´ <strong>' + totalCount + '</strong>ê°œì˜ í•™êµ/í•™ë…„/í•™ê¸‰';
          }
        }

        // ê²€ìƒ‰ ì´ë²¤íŠ¸
        searchInput.addEventListener('input', doSearch);

        // ì´ˆê¸°í™” ë²„íŠ¼
        resetBtn.addEventListener('click', function() {
          searchInput.value = '';
          doSearch();
          searchInput.focus();
        });

        // Enter í‚¤ ë°©ì§€
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
          }
        });
      </script>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /super/branches ì—ëŸ¬:", err);
    res.status(500).send("ì§€ì  ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ğŸ”¹ ì§€ì  ì‚­ì œ (ë¸Œëœì¹˜ ì „ì²´ë¥¼ íœ´ì§€ ìƒíƒœë¡œ ë³´ë‚´ê¸°)
// ğŸ”¹ ì§€ì  ì‚­ì œ (ë¸Œëœì¹˜ ì „ì²´ë¥¼ íœ´ì§€ ìƒíƒœë¡œ ë³´ë‚´ê¸°)
app.get("/super/branch-delete", requireSuperAdmin, async (req, res) => {
  const { academyName } = req.query;
  if (!academyName) {
    return res.status(400).send("academyName íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  const name = String(academyName).trim();
  const now = new Date();

  try {
    // 1) í•´ë‹¹ ì§€ì  ê´€ë¦¬ì ëª¨ë‘ íœ´ì§€ ìƒíƒœë¡œ (ì§€ì ì‚­ì œ í”Œë˜ê·¸ê¹Œì§€)
    const adminResult = await Admin.updateMany(
      { academyName: name, deleted: { $ne: true } },
      {
        $set: {
          deleted: true,
          deletedAt: now,
          branchDeleted: true   // âœ… ì§€ì  ì‚­ì œë¡œ íœ´ì§€ ê°„ ê²ƒ í‘œì‹œ
        }
      }
    );

    // 2) í•´ë‹¹ ì§€ì  í•™ìƒ ëª¨ë‘ íœ´ì§€ ìƒíƒœë¡œ (ì§€ì ì‚­ì œ í”Œë˜ê·¸ê¹Œì§€)
    const userResult = await User.updateMany(
      { school: name, deleted: { $ne: true } },
      {
        $set: {
          deleted: true,
          deletedAt: now,
          branchDeleted: true   // âœ… ì§€ì  ì‚­ì œë¡œ íœ´ì§€ ê°„ ê²ƒ í‘œì‹œ
        }
      }
    );

    console.log(
      "ğŸ—‘ ì§€ì  ì‚­ì œ:",
      name,
      "ê´€ë¦¬ì", adminResult.modifiedCount,
      "ëª…, í•™ìƒ", userResult.modifiedCount, "ëª… íœ´ì§€ ìƒíƒœë¡œ ì´ë™"
    );

    res.redirect("/super/branches");
  } catch (err) {
    console.error("âŒ /super/branch-delete ì—ëŸ¬:", err);
    res.status(500).send("ì§€ì  ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});


// ğŸ”¹ ì§€ì  íœ´ì§€í†µ ëª©ë¡
app.get("/super/branch-trash", requireSuperAdmin, async (req, res) => {
  try {
    // ğŸ”¥ ì§€ì  ì‚­ì œë¡œ ì¸í•´ íœ´ì§€ ê°„ admin/userë§Œ ê°€ì ¸ì˜¤ê¸°
    const admins = await Admin.find({
      deleted: true,
      branchDeleted: true     // â† â˜… í•µì‹¬ í•„í„°!
    }).lean();

    const users = await User.find({
      deleted: true,
      branchDeleted: true     // â† â˜… í•µì‹¬ í•„í„°!
    }).lean();

    const branchMap = {};

    function ensureEntry(name) {
      if (!branchMap[name]) {
        branchMap[name] = {
          academyName: name,
          adminCount: 0,
          studentCount: 0,
          lastDeleted: null,
        };
      }
      return branchMap[name];
    }

    admins.forEach((a) => {
      const name = a.academyName || "í•™ì›ëª… ë¯¸ì…ë ¥";
      const entry = ensureEntry(name);
      entry.adminCount += 1;
      const d = a.deletedAt || a.createdAt;
      if (!entry.lastDeleted || (d && d > entry.lastDeleted)) {
        entry.lastDeleted = d;
      }
    });

    users.forEach((u) => {
      const name = u.school || "í•™ì›ëª… ë¯¸ì…ë ¥";
      const entry = ensureEntry(name);
      entry.studentCount += 1;
      const d = u.deletedAt;
      if (!entry.lastDeleted || (d && d > entry.lastDeleted)) {
        entry.lastDeleted = d;
      }
    });

    const branches = Object.values(branchMap).sort((a, b) =>
      a.academyName.localeCompare(b.academyName, "ko")
    );

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>ì§€ì  íœ´ì§€í†µ</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        :root {
          --bg: #f2ede5;
          --panel: #fffaf3;
          --accent: #8b2f2f;
          --line: #e5d4c1;
          --text: #3b2a1a;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          padding: 24px 16px 40px;
          background: var(--bg);
font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
          color: var(--text);
        }
        .wrap { max-width: 1120px; margin: 0 auto; }
        h1 { margin: 4px 0 6px; font-size: 26px; font-weight: 700; }
        .desc { margin: 0 0 18px; font-size: 14px; color: #7a6a5b; }
        .top-bar {
          display:flex; justify-content:space-between; align-items:center;
          flex-wrap:wrap; gap:8px;
        }
        .btn-back {
          display:inline-flex; align-items:center; gap:4px;
          padding:6px 12px; font-size:13px;
          border-radius:999px;
          border:1px solid #c59f7b;
          background:#fdf7ef; color:#5a3b23;
          text-decoration:none;
        }
        .btn-back:hover { background:#f9f0e3; }
        .table-wrap {
          margin-top:12px;
          background:var(--panel);
          border-radius:12px;
          padding:14px 14px 18px;
          box-shadow:0 6px 18px rgba(0,0,0,0.06);
          border:1px solid rgba(0,0,0,0.04);
          overflow-x:auto;
        }
        table {
          border-collapse:collapse;
          width:100%;
          min-width:720px;
          font-size:14px;
        }
        th, td {
          border-bottom:1px solid #e5d4c1;
          padding:8px 10px;
          text-align:left;
          white-space:nowrap;
        }
        th { background:#f7efe2; font-weight:600; }
        tr:nth-child(even) td { background:#fdf7ef; }
        tr:hover td { background:#f3ebde; }
        .small { font-size:12px; color:#8a7b6f; }
        .btn-restore, .btn-delete {
          display:inline-flex;
          padding:5px 9px;
          font-size:12px;
          border-radius:999px;
          border:1px solid;
          text-decoration:none;
          margin-right:4px;
        }
        .btn-restore {
          border-color:#1565c0;
          color:#1565c0;
          background:#e3f2fd;
        }
        .btn-restore:hover { background:#d0e7fb; }
        .btn-delete {
          border-color:#b00020;
          color:#b00020;
          background:#fff5f5;
        }
        .btn-delete:hover { background:#ffecec; }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="top-bar">
          <div>
            <h1>ì§€ì  íœ´ì§€í†µ</h1>
            <p class="desc">
              ì‚­ì œëœ í•™ì›/ì§€ì ì˜ ê´€ë¦¬ìì™€ í•™ìƒ ê³„ì •ì´ ë¬¶ì—¬ì„œ í‘œì‹œë©ë‹ˆë‹¤.<br/>
              í•„ìš”í•˜ë©´ ì „ì²´ ë³µêµ¬ ë˜ëŠ” ì™„ì „ ì‚­ì œë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          <a href="/super/branches" class="btn-back">â† ì§€ì  ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <p class="small">ì´ <strong>${branches.length}</strong>ê°œì˜ ì§€ì ì´ íœ´ì§€ ìƒíƒœì…ë‹ˆë‹¤.</p>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>í•™êµëª…</th>
                <th>íœ´ì§€ ì„ ìƒë‹˜ ìˆ˜</th>
                <th>íœ´ì§€ í•™ìƒ ìˆ˜</th>
                <th>ë§ˆì§€ë§‰ íœ´ì§€ ì‹œê°</th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
    `;

    branches.forEach((b, idx) => {
      const ts = b.lastDeleted
        ? new Date(b.lastDeleted).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
        : "-";

      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${b.academyName}</td>
          <td>${b.adminCount}</td>
          <td>${b.studentCount}</td>
          <td>${ts}</td>
          <td>
            <a class="btn-restore"
               href="/super/branch-trash-restore?academyName=${encodeURIComponent(
                 b.academyName
               )}"
               onclick="return confirm('ì´ ì§€ì ì„ ë³µêµ¬í• ê¹Œìš”?\\n[${b.academyName}]');">
              ë³µêµ¬
            </a>
            <a class="btn-delete"
               href="/super/branch-trash-delete?academyName=${encodeURIComponent(
                 b.academyName
               )}"
               onclick="return confirm('ì´ ì§€ì ì˜ íœ´ì§€ ë°ì´í„°ë¥¼ ì™„ì „ ì‚­ì œí• ê¹Œìš”?\\nê´€ë¦¬ì/í•™ìƒ ê³„ì •ì„ ëª¨ë‘ DBì—ì„œ ì œê±°í•©ë‹ˆë‹¤.\\n[${b.academyName}]');">
              ì™„ì „ ì‚­ì œ
            </a>
          </td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /super/branch-trash ì—ëŸ¬:", err);
    res.status(500).send("ì§€ì  íœ´ì§€í†µ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ğŸ”¹ ì§€ì  ë³µêµ¬ (ê´€ë¦¬ì + í•™ìƒ ëª¨ë‘ deleted=false)
app.get("/super/branch-trash-restore", requireSuperAdmin, async (req, res) => {
  const { academyName } = req.query;
  if (!academyName) {
    return res.status(400).send("academyName íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  const name = String(academyName).trim();

  try {
    const adminResult = await Admin.updateMany(
      { academyName: name, deleted: true },
      { $set: { deleted: false, deletedAt: null } }
    );

    const userResult = await User.updateMany(
      { school: name, deleted: true },
      { $set: { deleted: false, deletedAt: null } }
    );

    console.log(
      "âœ… ì§€ì  ë³µêµ¬:",
      name,
      "ê´€ë¦¬ì", adminResult.modifiedCount,
      "ëª…, í•™ìƒ", userResult.modifiedCount, "ëª… ë³µêµ¬"
    );

    res.redirect("/super/branch-trash");
  } catch (err) {
    console.error("âŒ /super/branch-trash-restore ì—ëŸ¬:", err);
    res.status(500).send("ì§€ì  ë³µêµ¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ğŸ”¹ ì§€ì  ì™„ì „ ì‚­ì œ (deleted=true ìƒíƒœì¸ ê´€ë¦¬ì/í•™ìƒì„ DBì—ì„œ ì œê±°)
app.get("/super/branch-trash-delete", requireSuperAdmin, async (req, res) => {
  const { academyName } = req.query;
  if (!academyName) {
    return res.status(400).send("academyName íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  const name = String(academyName).trim();

  try {
    const adminResult = await Admin.deleteMany({
      academyName: name,
      deleted: true,
    });

    const userResult = await User.deleteMany({
      school: name,
      deleted: true,
    });

    console.log(
      "ğŸ—‘ ì§€ì  ì™„ì „ ì‚­ì œ:",
      name,
      "ê´€ë¦¬ì", adminResult.deletedCount,
      "ëª…, í•™ìƒ", userResult.deletedCount, "ëª… ì‚­ì œ"
    );

    res.redirect("/super/branch-trash");
  } catch (err) {
    console.error("âŒ /super/branch-trash-delete ì—ëŸ¬:", err);
    res.status(500).send("ì§€ì  ì™„ì „ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});


// ğŸ”¹ íŠ¹ì • í•™ì›/ì§€ì  í•™ìƒ ëª©ë¡ (ìŠˆí¼ê´€ë¦¬ì ëª¨ë“œì—ì„œ ë³´ê¸°)
app.get("/super/branch-users", requireSuperAdmin, async (req, res) => {
  const { academyName, grade, classNum } = req.query;
  if (!academyName) {
    return res.status(400).send("academyName íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  try {
    // ì¿¼ë¦¬ ì¡°ê±´ ìƒì„± - grade, classNumì´ ìˆìœ¼ë©´ í•™ë…„/ë°˜ë³„ë¡œ í•„í„°ë§
    const query = {
      deleted: { $ne: true },
      school: academyName,
    };
    if (grade) {
      query.grade = grade;
    }
    if (classNum) {
      query.classNum = classNum;
    }

    const users = await User.find(query)
      .sort({ grade: 1, classNum: 1, studentNum: 1, name: 1 })
      .lean();

    const key = ADMIN_KEY; // ğŸ”‘ ì—¬ê¸°ì„œë„ ì„œë²„ê°€ ì§ì ‘ ë„£ì–´ì¤Œ

    // â†“â†“â†“ ë‚˜ë¨¸ì§€ HTML ìƒì„± ë¶€ë¶„ì€ ë„¤ê°€ ê°€ì§€ê³  ìˆëŠ” ì½”ë“œ ê·¸ëŒ€ë¡œ ë‘ê³ ,
    //     ìœ„ì—ì„œ keyë¥¼ req.queryê°€ ì•„ë‹ˆë¼ ADMIN_KEYë¡œë§Œ ì“°ë©´ ë¼.
    // (í•™ìŠµ ì´ë ¥ ë³´ê¸° / ìƒíƒœë³€ê²½ / íœ´ì§€í†µ ë§í¬ì— ì“°ëŠ” key ê°’ìš©)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì§€ê¸ˆ ë„ˆ ì½”ë“œì˜ <html> ~ res.send(html) ê¹Œì§€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    // ë‹¨, ë§¨ ìœ—ë¶€ë¶„ì—ì„œ const { key, academyName } ëŒ€ì‹ 
    //  - const { academyName }ë§Œ ë‚¨ê¸°ê³ 
    //  - const key = ADMIN_KEY; ì¶”ê°€í–ˆì§€.
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ê·¸ ë¶€ë¶„ë§Œ ë°˜ì˜í•´ì„œ ë¶™ì—¬ ë„£ìœ¼ë©´ ë¼.


    // í•™ë…„ê³¼ ë°˜ ì •ë³´ë¡œ ì œëª© ìƒì„±
    const gradeClassText = [grade, classNum].filter(Boolean).join(' ');
    const pageTitle = gradeClassText ? `${academyName} ${gradeClassText} í•™ìƒ ëª©ë¡` : `${academyName} í•™ìƒ ëª©ë¡`;

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>${pageTitle}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        :root {
          --bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          --panel: #ffffff;
          --accent: #495057;
          --accent-hover: #212529;
          --text: #212529;
          --text-light: #495057;
          --line: #dee2e6;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          padding: 40px 20px;
          background: var(--bg);
          font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
          color: var(--text);
          min-height: 100vh;
        }
        .wrap {
          max-width: 1200px;
          margin: 0 auto;
        }
        h1 {
          margin: 0 0 12px;
          font-size: 32px;
          font-weight: 700;
          color: #212529;
          text-shadow: none;
        }
        .desc {
          margin: 0 0 24px;
          font-size: 15px;
          color: #495057;
          line-height: 1.6;
        }
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 16px;
          margin-bottom: 30px;
        }
        .btn-back {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: 2px solid rgba(73, 80, 87, 0.2);
          background: rgba(255,255,255,0.9);
          backdrop-filter: blur(10px);
          color: #212529;
          text-decoration: none;
          transition: all 0.3s ease;
        }
        .btn-back:hover {
          background: rgba(255,255,255,1);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toolbar {
          margin: 0 0 20px;
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          justify-content: flex-end;
          align-items: center;
        }
        .search-input {
          padding: 10px 16px;
          font-size: 14px;
          border-radius: 12px;
          border: 2px solid rgba(102, 126, 234, 0.2);
          min-width: 240px;
          transition: all 0.3s ease;
        }
        .search-input:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: none;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        .btn-ghost {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-ghost:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: white;
          box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
        }
        .btn-danger:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(245, 87, 108, 0.4);
        }

        .info-line {
          background: rgba(255,255,255,0.95);
          padding: 12px 20px;
          border-radius: 12px;
          font-size: 14px;
          color: var(--text);
          margin: 0 0 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .table-wrap {
          background: var(--panel);
          border-radius: 20px;
          padding: 24px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.1);
          border: 2px solid rgba(102, 126, 234, 0.1);
          overflow-x: auto;
        }
        table {
          border-collapse: collapse;
          width: 100%;
          min-width: 900px;
          font-size: 14px;
        }
        th, td {
          border-bottom: 1px solid var(--line);
          padding: 14px 12px;
          text-align: left;
        }
        th {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          font-weight: 600;
          color: white;
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          position: sticky;
          top: 0;
          z-index: 10;
        }
        tbody tr {
          transition: all 0.2s ease;
        }
        tbody tr:hover {
          background: #f9fafb;
          transform: scale(1.001);
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
        }
        .badge-approved {
          background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
          color: #065f46;
        }
        .badge-pending {
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          color: #92400e;
        }

        a.link {
          font-size: 13px;
          color: var(--accent);
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
        }
        a.link:hover {
          color: var(--accent-hover);
          text-decoration: underline;
        }
        a.link-danger {
          font-size: 13px;
          color: #dc2626;
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
        }
        a.link-danger:hover {
          color: #991b1b;
          text-decoration: underline;
        }

        @media (max-width: 768px) {
          body {
            padding: 20px 12px;
          }
          h1 {
            font-size: 24px;
          }
          .top-bar {
            flex-direction: column;
            align-items: flex-start;
          }
          .table-wrap {
            padding: 16px;
          }
        }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="top-bar">
          <div>
            <h1>${pageTitle}</h1>
            <p class="desc">ì´ í™”ë©´ì—ëŠ” ${gradeClassText ? `${academyName} ${gradeClassText}` : academyName}ì— ì†Œì†ëœ í•™ìƒë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
          <a href="/super/branches?key=${encodeURIComponent(
            key
          )}" class="btn-back">â† í•™êµ/í•™ë…„/ë°˜ ëª©ë¡ìœ¼ë¡œ</a>
        </div>

        <div class="toolbar">
          <!-- ë‚˜ì¤‘ì— ê²€ìƒ‰/ì—‘ì…€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì¶”ê°€ -->
        </div>

        <p class="info-line">ì´ <strong>${users.length}</strong>ëª…ì˜ í•™ìƒì´ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>í•™ë…„</th>
                <th>ë°˜</th>
                <th>ë²ˆí˜¸</th>
                <th>ì´ë¦„</th>
                <th>í•™êµëª…</th>
                <th>í•™ë…„ë°˜ë²ˆí˜¸(ID)</th>
                <th>ìƒíƒœ</th>
                <th>ìˆ˜ì •</th>
                <th>íœ´ì§€í†µ</th>
              </tr>
            </thead>
            <tbody>
    `;

    users.forEach((u, idx) => {
      const last = u.lastLogin
        ? new Date(u.lastLogin).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          })
        : "-";
      const idOrPhone = u.id || u.phone || "";

      const status = u.status || "approved";
      const statusLabel = status === "approved" ? "ìŠ¹ì¸" : "ëŒ€ê¸°";
      const statusClass =
        status === "approved" ? "badge-approved" : "badge-pending";

      const approveLink =
        status === "approved"
          ? `<a class="link" href="/admin/status?id=${encodeURIComponent(
              idOrPhone
            )}&status=pending&key=${encodeURIComponent(
              key
            )}" onclick="return confirm('ì´ íšŒì›ì„ ë‹¤ì‹œ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜í• ê¹Œìš”?');">ëŒ€ê¸° ì „í™˜</a>`
          : `<a class="link" href="/admin/status?id=${encodeURIComponent(
              idOrPhone
            )}&status=approved&key=${encodeURIComponent(
              key
            )}" onclick="return confirm('ì´ íšŒì›ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ìŠ¹ì¸í•˜ê¸°</a>`;

      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${u.grade || ""}</td>
          <td>${u.classNum || ""}</td>
          <td>${u.studentNum || u.number || ""}</td>
          <td>${u.name || ""}</td>
          <td>${u.school || ""}</td>
          <td>${idOrPhone}</td>
          <td>
            <span class="badge ${statusClass}">${statusLabel}</span>
            ${approveLink}
          </td>
          <td>
            <a class="link"
               href="/admin/user-edit?id=${encodeURIComponent(
                 idOrPhone
               )}&key=${encodeURIComponent(key)}">
              ìˆ˜ì •
            </a>
          </td>
          <td>
            <a class="link-danger"
               href="/trash-user?id=${encodeURIComponent(
                 idOrPhone
               )}&key=${encodeURIComponent(
        key
      )}"
               onclick="return confirm('ì´ íšŒì›ì„ íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚¼ê¹Œìš”? [${u.name} / ${idOrPhone}]');">
              íœ´ì§€í†µ
            </a>
          </td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /super/branch-users ì—ëŸ¬:", err);
    res.status(500).send("ì§€ì  í•™ìƒ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});


// ë‚´ í•™ì› í•™ìƒ ëª©ë¡ (ë¸Œëœì¹˜ ê´€ë¦¬ì ì „ìš© í™”ë©´ í…œí”Œë¦¿)
app.get("/admin/branch/users", requireAdminLogin, (req, res) => {
  console.log(
    "âœ… [GET] /admin/branch/users -> public/branch_user_list.html",
    "academyName:",
    req.session.admin && req.session.admin.academyName
  );
  // ì§€ê¸ˆì€ í…œí”Œë¦¿ë§Œ ì—°ê²°í•´ë‘ê³ , ì‹¤ì œ ë°ì´í„° ë°”ì¸ë”©ì€ ë‚˜ì¤‘ì— API/SSRë¡œ í™•ì¥ ê°€ëŠ¥
  res.sendFile(path.join(__dirname, "public", "branch_user_list.html"));
});

// ë¸Œëœì¹˜ ê´€ë¦¬ì ì§„ë‹¨í…ŒìŠ¤íŠ¸ ê´€ë¦¬ í˜ì´ì§€
app.get("/admin/diagnostic-management", requireAdminLogin, (req, res) => {
  console.log(
    "âœ… [GET] /admin/diagnostic-management -> public/admin_diagnostic_management.html",
    "academyName:",
    req.session.admin && req.session.admin.academyName
  );
  res.sendFile(path.join(__dirname, "public", "admin_diagnostic_management.html"));
});

// í•™ìƒ í•œ ëª… í•™ìŠµ ì´ë ¥ ë³´ê¸° (ë¸Œëœì¹˜ ê´€ë¦¬ììš© í™”ë©´ í…œí”Œë¦¿)
app.get("/admin/branch/logs", requireAdminLogin, (req, res) => {
  console.log(
    "âœ… [GET] /admin/branch/logs -> public/branch_logs.html",
    "academyName:",
    req.session.admin && req.session.admin.academyName
  );
  // URL ì˜ˆì‹œ: /admin/branch/logs?grade=ì´ˆ6&name=í™ê¸¸ë™
  res.sendFile(path.join(__dirname, "public", "branch_logs.html"));
});



// ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ (ë¸Œëœì¹˜ ê´€ë¦¬ì ì„¸ì…˜ë§Œ ì¢…ë£Œ)
app.get("/admin/logout", (req, res) => {
  console.log("ğŸ“¤ [GET] /admin/logout í˜¸ì¶œ");
  if (!req.session) {
    return res.redirect("/admin-login");
  }
  req.session.admin = null;
  req.session.superPinVerified = false; // ìŠˆí¼ê´€ë¦¬ì PIN ì¸ì¦ ì´ˆê¸°í™”
  req.session.adminPinVerified = false; // ë¸Œëœì¹˜ ê´€ë¦¬ì PIN ì¸ì¦ ì´ˆê¸°í™”
  req.session.adminPinRequired = false;
  res.redirect("/admin-login");
});

/* ====================================
 * âœ… ê¸°ì¡´ í•™ìƒ/ìŠˆí¼ê´€ë¦¬ì ë¼ìš°íŠ¸ë“¤
 * ==================================== */

// âœ… ë¡œê·¸ì•„ì›ƒ (GET: ì• ë‹ˆë©”ì´ì…˜ í˜ì´ì§€ë¡œ)
app.get("/logout", (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      console.log("â— ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:", err);
    }

    res.clearCookie("connect.sid", {
      path: "/",
      httpOnly: true,
      secure: false,
    });

    res.redirect("/logout.html");
  });
});

// ping
app.get("/ping", (req, res) => {
  console.log("âœ… [GET] /ping");
  res.send("pong âœ…");
});

app.get("/signup", (req, res) => {
  console.log("â¡ï¸ /signup ìš”ì²­ â†’ student-main.htmlì˜ íšŒì›ê°€ì… íŒì—… ëª¨ë“œ");
  res.redirect("/?mode=register");
});

// âœ… í•™ìƒ íšŒì›ê°€ì… ì²˜ë¦¬
app.post("/signup", async (req, res) => {
  console.log("ğŸ“¥ [POST] /signup ì—ì„œ ë°›ì€ ê°’:", req.body);

  const grade = req.body.grade || "";
  const name = req.body.name || "";
  const phone = req.body.phone || "";
  const school = req.body.school || "";

  const id = phone;
  const pw = phone;

  try {
    // MongoDB ì €ì¥ (statusëŠ” ê¸°ë³¸ê°’ 'pending')
    const created = await User.create({
      grade,
      name,
      phone,
      id,
      pw,
      school,
    });

    // JSON ë°±ì—…
    const users = JSON.parse(fs.readFileSync(USERS_FILE, "utf8"));
    users.push({ grade, name, phone, id, pw, school });
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));

    console.log("âœ… [POST] íšŒì›ê°€ì… DB ì €ì¥ ì™„ë£Œ:", created.name);
    res.redirect("/student-main.html");
  } catch (err) {
    console.error("âŒ [POST] /signup ì—ëŸ¬:", err);
    res.status(500).send("íšŒì› ê°€ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
  }
});

// ===== íšŒì› ì •ë³´ ìˆ˜ì • í™”ë©´ (GET) =====
app.get("/admin/user-edit", async (req, res) => {
  const { id: rawId, key, view } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }
  if (!rawId) {
    return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  const id = String(rawId).trim();

  try {
    const user = await User.findOne({
      $or: [{ id }, { phone: id }],
      deleted: { $ne: true },
    });

    if (!user) {
      return res.status(404).send("ìˆ˜ì • ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ğŸ”™ ìˆ˜ì • í›„ ëŒì•„ê°ˆ ì£¼ì†Œ
    const returnUrl =
      view === "branch"
        ? "/admin/branch/users"
        : `/admin/users?key=${encodeURIComponent(key)}`;

    const html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>íšŒì› ì •ë³´ ìˆ˜ì •</title>
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; padding: 20px; }
        h1 { margin-bottom: 16px; }
        label { display:block; margin:8px 0 4px; font-size:14px; }
        input[type="text"] { width:260px; padding:6px 8px; font-size:14px; }
        .row { margin-bottom:8px; }
        button { margin-top:12px; padding:6px 14px; font-size:14px; }
        a { font-size:13px; margin-left:8px; }
      </style>
    </head>
    <body>
      <h1>íšŒì› ì •ë³´ ìˆ˜ì •</h1>
      <form method="POST" action="/admin/user-edit">
        <input type="hidden" name="key" value="${key}" />
        <input type="hidden" name="originalId" value="${id}" />
        <input type="hidden" name="return" value="${returnUrl}" />

        <div class="row">
          <label>í•™ë…„</label>
          <input type="text" name="grade" value="${user.grade || ""}" />
        </div>

        <div class="row">
          <label>ë°˜</label>
          <input type="text" name="classNum" value="${user.classNum || ""}" />
        </div>

        <div class="row">
          <label>ë²ˆí˜¸</label>
          <input type="text" name="studentNum" value="${user.studentNum || ""}" />
        </div>

        <div class="row">
          <label>í•™êµ</label>
          <input type="text" name="school" value="${user.school || ""}" />
        </div>

        <div class="row">
          <label>ì´ë¦„</label>
          <input type="text" name="name" value="${user.name || ""}" />
        </div>

        <div class="row">
          <label>í•™ë…„ë°˜ë²ˆí˜¸(ID)</label>
          <input type="text" name="phone" value="${user.phone || ""}" />
        </div>

        <button type="submit">ì €ì¥í•˜ê¸°</button>
        <a href="${returnUrl}">ëŒì•„ê°€ê¸°</a>
      </form>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /admin/user-edit(GET) ì—ëŸ¬:", err);
    res.status(500).send("íšŒì› ì •ë³´ ìˆ˜ì • í™”ë©´ ìƒì„± ì¤‘ ì˜¤ë¥˜");
  }
});


// ===== íšŒì› ì •ë³´ ìˆ˜ì • ì²˜ë¦¬ (POST) =====
app.post("/admin/user-edit", async (req, res) => {
  const {
    originalId,
    key,
    grade,
    classNum,
    studentNum,
    school,
    name,
    phone,
    return: returnUrl,   // ğŸ”¹ hidden input ìœ¼ë¡œ ë„˜ì–´ì˜¨ return ì£¼ì†Œ
  } = req.body;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  if (!originalId) {
    return res.status(400).send("originalId ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  try {
    const targetId = String(originalId).trim();

    const user = await User.findOne({
      $or: [{ id: targetId }, { phone: targetId }],
      deleted: { $ne: true },
    });

    if (!user) {
      return res.status(404).send("ìˆ˜ì • ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ğŸ”¹ ê¸°ì¡´ í•™ë…„/ì´ë¦„ ì €ì¥ (í•™ìŠµ ê¸°ë¡ ì—…ë°ì´íŠ¸ìš©)
    const oldGrade = user.grade || "";
    const oldName = user.name || "";
    const newGrade = grade || "";
    const newName = name || "";

    // í•„ë“œ ì—…ë°ì´íŠ¸
    user.grade = newGrade;
    user.classNum = classNum || "";
    user.studentNum = studentNum || "";
    user.school = school || "";
    user.name = newName;
    user.phone = phone || "";
    user.id = phone || "";
    user.pw = phone || "";

    await user.save();

    // ğŸ”¹ í•™ë…„ ë˜ëŠ” ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš°, ê¸°ì¡´ í•™ìŠµ ê¸°ë¡ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
    if (oldGrade !== newGrade || oldName !== newName) {
      const logUpdateResult = await LearningLog.updateMany(
        { grade: oldGrade, name: oldName },
        { $set: { grade: newGrade, name: newName } }
      );
      console.log(`ğŸ“ í•™ìŠµ ê¸°ë¡ ì—…ë°ì´íŠ¸: ${oldGrade}/${oldName} â†’ ${newGrade}/${newName} (${logUpdateResult.modifiedCount}ê±´)`);

      // UserProgressë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
      const progressUpdateResult = await UserProgress.updateMany(
        { grade: oldGrade, name: oldName },
        { $set: { grade: newGrade, name: newName } }
      );
      console.log(`ğŸ“Š ì§„í–‰ë„ ì—…ë°ì´íŠ¸: ${oldGrade}/${oldName} â†’ ${newGrade}/${newName} (${progressUpdateResult.modifiedCount}ê±´)`);
    }

    console.log("âœ… íšŒì› ì •ë³´ ìˆ˜ì • ì™„ë£Œ:", user.name, user.id);

    // ğŸ”™ return ê°’ì´ ìˆìœ¼ë©´ ê±°ê¸°ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ íšŒì› ëª©ë¡ìœ¼ë¡œ
    if (returnUrl && returnUrl.startsWith("/")) {
      return res.redirect(returnUrl);
    }
    res.redirect(`/admin/users?key=${encodeURIComponent(key)}`);
  } catch (err) {
    console.error("âŒ /admin/user-edit(POST) ì—ëŸ¬:", err);
    res.status(500).send("íšŒì› ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜");
  }
});

// ===== ì‹œë¦¬ì¦ˆ ë¶€ì—¬ API (POST) =====
app.post("/admin/assign-series", async (req, res) => {
  const { key, userId, series } = req.body;

  if (key !== ADMIN_KEY) {
    return res.status(403).json({ success: false, message: "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨" });
  }

  if (!userId) {
    return res.status(400).json({ success: false, message: "userIdê°€ í•„ìš”í•©ë‹ˆë‹¤" });
  }

  if (!Array.isArray(series)) {
    return res.status(400).json({ success: false, message: "seriesëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤" });
  }

  try {
    const user = await User.findById(userId);

    if (!user) {
      return res.status(404).json({ success: false, message: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
    }

    user.assignedSeries = series;
    await user.save();

    console.log(`âœ… ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì™„ë£Œ: ${user.name} (${user.id}) -> [${series.join(", ")}]`);

    return res.json({
      success: true,
      message: "ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì™„ë£Œ",
      assignedSeries: series
    });
  } catch (err) {
    console.error("âŒ /admin/assign-series ì—ëŸ¬:", err);
    return res.status(500).json({ success: false, message: "ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" });
  }
});


// ===== íšŒì› ì‚­ì œ (hard delete) =====
app.get("/delete-user", async (req, res) => {
  const { id, pw, key } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  if (!id) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  try {
    const user = await User.findOne({ id });
    if (!user) return res.status(404).send("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.");

    if (pw && user.pw !== pw) {
      return res.status(403).send("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    await User.deleteOne({ _id: user._id });

    res.send(`ì‚­ì œ ì™„ë£Œ: ${user.name} (${user.id})`);
  } catch (err) {
    console.error(err);
    res.status(500).send("ì„œë²„ ì˜¤ë¥˜");
  }
});

// ===== íšŒì› íœ´ì§€í†µ ë³´ë‚´ê¸° (soft delete) =====
// ===== íšŒì› íœ´ì§€í†µ ë³´ë‚´ê¸° (soft delete) =====
app.get("/trash-user", async (req, res) => {
  const { id: rawId, key } = req.query;
  const returnUrl = req.query.return;   // âœ… ì–´ë””ë¡œ ëŒì•„ê°ˆì§€
  const view = req.query.view;         // âœ… branch ì»¨í…ìŠ¤íŠ¸ìš©

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  if (!rawId) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  const id = String(rawId).trim();
  console.log("ğŸ—‘ /trash-user í˜¸ì¶œ, id =", id);

  try {
    const user = await User.findOne({
      $or: [{ id }, { phone: id }],
      deleted: { $ne: true }, // active íšŒì›ë§Œ
    });

    if (!user) {
      return res
        .status(404)
        .send("ì´ë¯¸ íœ´ì§€ ìƒíƒœì´ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    }

    user.deleted = true;
    user.deletedAt = new Date();
    await user.save();

    console.log("âœ… íœ´ì§€í†µìœ¼ë¡œ ì´ë™ ì™„ë£Œ:", user.name, user.id || user.phone);

    // âœ… 1ìˆœìœ„: return íŒŒë¼ë¯¸í„° ìˆìœ¼ë©´ ê·¸ìª½ìœ¼ë¡œ
    if (typeof returnUrl === "string" && returnUrl.startsWith("/")) {
      return res.redirect(returnUrl);
    }

    // âœ… 2ìˆœìœ„: view=branch ë©´ ë¸Œëœì¹˜ ëª©ë¡ìœ¼ë¡œ
    if (view === "branch") {
      return res.redirect("/admin/branch/users");
    }

    // âœ… ê¸°ë³¸: ì „ì²´ íšŒì› íœ´ì§€í†µ í˜ì´ì§€
    return res.redirect(`/admin/trash?key=${encodeURIComponent(key)}`);
  } catch (err) {
    console.error("âŒ /trash-user ì—ëŸ¬:", err);
    res.status(500).send("íœ´ì§€í†µ ì´ë™ ì¤‘ ì˜¤ë¥˜");
  }
});


// â­â­â­ íšŒì› ìƒíƒœ(ìŠ¹ì¸/ëŒ€ê¸°) ë³€ê²½ ë¼ìš°íŠ¸ â­â­â­
// â­â­â­ íšŒì› ìƒíƒœ(ìŠ¹ì¸/ëŒ€ê¸°) ë³€ê²½ ë¼ìš°íŠ¸ â­â­â­
app.get("/admin/status", async (req, res) => {
  const { key, id: rawId, status } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }
  if (!rawId) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  const id = String(rawId).trim();
  const allowed = ["pending", "approved"];

  if (!allowed.includes(status)) {
    return res.status(400).send("ìœ íš¨í•˜ì§€ ì•Šì€ status ê°’ì…ë‹ˆë‹¤.");
  }

  try {
    const user = await User.findOne({
      $or: [{ id }, { phone: id }],
      deleted: { $ne: true },
    });

    if (!user) {
      return res.status(404).send("ìƒíƒœë¥¼ ë³€ê²½í•  ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    user.status = status;
    await user.save();

    console.log("âœ… ìƒíƒœ ë³€ê²½:", user.name, "=>", status);

    // âœ… return íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ê·¸ìª½ìœ¼ë¡œ, ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ ì „ì²´ íšŒì› ëª©ë¡
    let returnUrl = req.query.return;
    if (typeof returnUrl === "string" && returnUrl.startsWith("/")) {
      return res.redirect(returnUrl);
    }

    res.redirect(`/admin/users?key=${encodeURIComponent(key)}`);
  } catch (err) {
    console.error("âŒ /admin/status ì—ëŸ¬:", err);
    res.status(500).send("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜");
  }
});


// â­â­â­ íšŒì› ì¡°íšŒ í˜ì´ì§€ (ìŠˆí¼ê´€ë¦¬ì ì „ìš©, ìƒˆ ë””ìì¸) â­â­â­
app.get("/admin/users", async (req, res) => {
  const { key, q, sort } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  try {
    const filter = { deleted: { $ne: true } };

    let keyword = "";
    if (q && q.trim() !== "") {
      keyword = q.trim();
      const regex = new RegExp(keyword, "i");

      filter.$or = [
        { name: regex },
        { phone: regex },
        { id: regex },
        { school: regex },
        { grade: regex },
      ];
    }

    // ì •ë ¬ ì˜µì…˜ (ê¸°ë³¸ê°’: ìš°ì„ ìˆœìœ„ ì •ë ¬)
    let sortOption = { lastLogin: -1, name: 1 };
    const isPrioritySort = !sort || sort === "priority"; // ìš°ì„ ìˆœìœ„ ì •ë ¬ í”Œë˜ê·¸ (ê¸°ë³¸ê°’)
    switch (sort) {
      case "lastLoginAsc":
        sortOption = { lastLogin: 1, name: 1 };
        break;
      case "gradeAsc":
        sortOption = { grade: 1, name: 1 };
        break;
      case "gradeDesc":
        sortOption = { grade: -1, name: 1 };
        break;
      case "nameAsc":
        sortOption = { name: 1 };
        break;
      case "nameDesc":
        sortOption = { name: -1 };
        break;
      case "priority":
        // ìš°ì„ ìˆœìœ„ ì •ë ¬: ë©”ëª¨ë¦¬ì—ì„œ ì²˜ë¦¬í•  ê²ƒì´ë¯€ë¡œ ê¸°ë³¸ ì •ë ¬ ì‚¬ìš©
        sortOption = { lastLogin: -1, name: 1 };
        break;
      default:
        sortOption = { lastLogin: -1, name: 1 };
    }

    // ì„¸ ì¿¼ë¦¬ë¥¼ ë³‘ë ¬ë¡œ ì‹¤í–‰ + í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
    const [usersResult, allProgress, allLearningLogs] = await Promise.all([
      User.find(filter).sort(sortOption).lean(),
      UserProgress.find({}, { grade: 1, name: 1, 'studyRoom.autoTaskSchedules': 1, 'studyRoom.assignedTasks': 1 }).lean(),
      LearningLog.find({ completed: true, deleted: { $ne: true } }, { grade: 1, name: 1, unit: 1 }).lean()
    ]);
    let users = usersResult;

    // UserProgressë¥¼ Mapìœ¼ë¡œ ë³€í™˜
    const progressMap = new Map();
    for (const p of allProgress) {
      progressMap.set(`${p.grade}|${p.name}`, p);
    }

    // LearningLogë¥¼ Map<í•™ìƒí‚¤, Set<ì™„ë£Œëœ ë‹¨ì›>>ìœ¼ë¡œ ë³€í™˜
    const completedUnitsMap = new Map();
    for (const log of allLearningLogs) {
      const key = `${log.grade}|${log.name}`;
      if (!completedUnitsMap.has(key)) {
        completedUnitsMap.set(key, new Set());
      }
      completedUnitsMap.get(key).add(log.unit);
    }

    // ê° userì— ëŒ€í•´ UserProgress ë°ì´í„° ë³‘í•© (ë©”ëª¨ë¦¬ì—ì„œ ë§¤í•‘)
    for (let i = 0; i < users.length; i++) {
      const user = users[i];
      const progress = progressMap.get(`${user.grade}|${user.name}`);
      if (progress && progress.studyRoom) {
        users[i].studyRoom = progress.studyRoom;
      }
      // ì™„ë£Œëœ ë‹¨ì› Set ì¶”ê°€
      users[i].completedUnits = completedUnitsMap.get(`${user.grade}|${user.name}`) || new Set();
    }

    // ìš°ì„ ìˆœìœ„ ì •ë ¬: ë¯¸ìŠ¹ì¸ â†’ ë¯¸ë¶€ì—¬ â†’ ìµœì‹  í•™ìŠµìˆœ
    if (isPrioritySort) {
      users = users.sort((a, b) => {
        const statusA = a.status || 'approved';
        const statusB = b.status || 'approved';

        // 1. ë¯¸ìŠ¹ì¸(pending) í•™ìƒì´ ê°€ì¥ ìœ„
        const isPendingA = statusA === 'pending';
        const isPendingB = statusB === 'pending';
        if (isPendingA && !isPendingB) return -1;
        if (!isPendingA && isPendingB) return 1;

        // 2. ì‹œë¦¬ì¦ˆ ë¯¸ë¶€ì—¬ í•™ìƒì´ ê·¸ ë‹¤ìŒ
        const hasSeriesA = a.studyRoom && a.studyRoom.assignedTasks && a.studyRoom.assignedTasks.length > 0;
        const hasSeriesB = b.studyRoom && b.studyRoom.assignedTasks && b.studyRoom.assignedTasks.length > 0;
        if (!hasSeriesA && hasSeriesB) return -1;
        if (hasSeriesA && !hasSeriesB) return 1;

        // 3. ìµœì‹  í•™ìŠµ(lastLogin)ìˆœ ì •ë ¬
        const lastLoginA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
        const lastLoginB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
        return lastLoginB - lastLoginA; // ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹ ì´ ìœ„)
      });
    } else {
      // ê¸°ì¡´ ë¡œì§: ìŠ¹ì¸ëŒ€ê¸° í•™ìƒì„ í•­ìƒ ë§¨ ìœ„ë¡œ ì •ë ¬
      users = users.sort((a, b) => {
        const statusA = a.status || 'approved';
        const statusB = b.status || 'approved';
        if (statusA === 'pending' && statusB !== 'pending') return -1;
        if (statusA !== 'pending' && statusB === 'pending') return 1;
        return 0;
      });
    }

    // ìŠ¤ì¼€ì¤„ ë Œë”ë§ í•¨ìˆ˜
    function renderSchedules(schedules, grade, name) {
      if (!schedules || schedules.length === 0) {
        return '';
      }

      const dayLabels = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

      // ê³¼ëª© ì½”ë“œ â†’ í•œê¸€ ëª…ì¹­ ë§¤í•‘
      const subjectNameMap = {
        'science/bio': 'ìƒë¬¼',
        'science/geo_earth': 'ì§€êµ¬ê³¼í•™',
        'science/physics': 'ë¬¼ë¦¬',
        'science/chemistry': 'í™”í•™',
        'social/culture': 'ì‚¬íšŒë¬¸í™”',
        'social/geo': 'ì§€ë¦¬',
        'social/law': 'ë²•',
        'social/history': 'ë²•',
        'social/politic': 'ì •ì¹˜ê²½ì œ',
        'korlit/classic': 'ê³ ì „ì†Œì„¤',
        'korlit/modern': 'í˜„ëŒ€ì†Œì„¤',
        'korlit/essay': 'ê³ ì „ì†Œì„¤',
        'korlit/nonfiction': 'í˜„ëŒ€ì†Œì„¤',
        'worldlit/classic': 'ì„¸ê³„ë¬¸í•™(1)',
        'worldlit/modern': 'ì„¸ê³„ë¬¸í•™(1)',
        'worldlit/essay': 'ì„¸ê³„ë¬¸í•™(2)',
        'worldlit/nonfiction': 'ì„¸ê³„ë¬¸í•™(2)',
        'person/korea': 'í•œêµ­ì¸ë¬¼',
        'person/world': 'ì„¸ê³„ì¸ë¬¼'
      };

      const html = schedules.map(schedule => {
        const subjectNames = schedule.subjects.map(s => {
          return subjectNameMap[s] || s;
        }).join(', ');

        const daysText = schedule.days.map(d => dayLabels[d]).join(', ');
        const statusClass = schedule.isActive ? 'active' : 'paused';
        const statusText = schedule.isActive ? 'í™œì„±' : 'ì¼ì‹œì •ì§€';
        const buttonIcon = schedule.isActive ? 'â¸' : 'â–¶';
        const buttonTitle = schedule.isActive ? 'ì¼ì‹œì •ì§€' : 'ì¬ê°œ';

        return '<div class="schedule-item ' + statusClass + '">' +
          '<div class="schedule-info">' +
            '<div class="schedule-subject">' + subjectNames + '</div>' +
            '<div class="schedule-details">' + daysText + ' Â· ' + schedule.taskCount + 'ê°œ/ì¼</div>' +
            '<span class="schedule-status">' + statusText + '</span>' +
          '</div>' +
          '<div class="schedule-actions">' +
            '<button class="btn-icon" onclick="toggleSchedule(\'' + schedule.scheduleId + '\', \'' + grade + '\', \'' + name + '\')" title="' + buttonTitle + '">' +
              buttonIcon +
            '</button>' +
            '<button class="btn-icon btn-delete" onclick="deleteSchedule(\'' + schedule.scheduleId + '\', \'' + grade + '\', \'' + name + '\')" title="ì‚­ì œ">' +
              'ğŸ—‘' +
            '</button>' +
          '</div>' +
        '</div>';
      }).join('');

      console.log(`   â†’ HTML ìƒì„±ë¨ (ê¸¸ì´: ${html.length}ì)`);
      console.log(`   â†’ HTML ë¯¸ë¦¬ë³´ê¸°:`, html.substring(0, 200));

      return html;
    }

    // ğŸ”½ ì—¬ê¸°ë¶€í„° í™”ë©´ í…œí”Œë¦¿ (ë¸Œëœì¹˜ìš© ë””ìì¸ê³¼ ë¹„ìŠ·í•˜ê²Œ)
    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>AI ë¸Œë ˆì¸ ë¬¸í•´ë ¥ ì „ì²´ í•™ìƒ ëª©ë¡</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        :root {
          --bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          --panel: #ffffff;
          --accent: #495057;
          --accent-hover: #212529;
          --line: #dee2e6;
          --text: #212529;
          --text-light: #495057;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          padding: 0;
          background: var(--bg);
          font-family: "Gmarket Sans", "Noto Sans KR", sans-serif;
          color: var(--text);
          min-height: 100vh;
        }
        .wrap {
          max-width: 1400px;
          margin: 0 auto;
          padding: 40px 20px;
        }
        h1 {
          margin: 0 0 8px;
          font-size: 32px;
          font-weight: 700;
          color: #212529;
          text-shadow: none;
        }
        .desc {
          margin: 0 0 30px;
          font-size: 15px;
          color: #495057;
          line-height: 1.6;
        }
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 30px;
          gap: 20px;
          flex-wrap: wrap;
        }
        .btn-back {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: 2px solid rgba(73, 80, 87, 0.2);
          background: rgba(255,255,255,0.9);
          backdrop-filter: blur(10px);
          color: #212529;
          text-decoration: none;
          transition: all 0.3s ease;
        }
        .btn-back:hover {
          background: rgba(255,255,255,1);
          border-color: rgba(73, 80, 87, 0.4);
          transform: translateY(-2px);
        }

        .toolbar {
          background: white;
          padding: 20px;
          border-radius: 16px;
          margin-bottom: 20px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.08);
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          align-items: center;
          justify-content: flex-end;
        }
        .toolbar form {
          display: inline-flex;
          gap: 8px;
          align-items: center;
        }
        .search-input {
          padding: 12px 18px;
          font-size: 14px;
          border-radius: 12px;
          border: 2px solid #e5e7eb;
          min-width: 280px;
          transition: all 0.3s ease;
          font-family: inherit;
        }
        .search-input:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        .search-select {
          padding: 12px 16px;
          font-size: 14px;
          border-radius: 12px;
          border: 2px solid #e5e7eb;
          background: white;
          font-family: inherit;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        .search-select:focus {
          outline: none;
          border-color: var(--accent);
        }
        .btn {
          padding: 12px 24px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          border: none;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: inherit;
        }
        .btn-main {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-main:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        .btn-ghost {
          background: white;
          color: #4b5563;
          border: 2px solid #e5e7eb;
        }
        .btn-ghost:hover {
          background: #f9fafb;
          border-color: #d1d5db;
        }
        .btn-danger {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: white;
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .info-line {
          background: white;
          padding: 16px 20px;
          border-radius: 12px;
          margin-bottom: 20px;
          font-size: 14px;
          color: var(--text);
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .info-line strong {
          color: var(--accent);
          font-weight: 700;
        }

        .table-wrap {
          background: white;
          border-radius: 16px;
          padding: 0;
          box-shadow: 0 4px 20px rgba(0,0,0,0.08);
          overflow: hidden;
        }
        table {
          border-collapse: collapse;
          width: 100%;
          min-width: 1200px;
          font-size: 14px;
        }
        th, td {
          padding: 16px 14px;
          text-align: left;
          border-bottom: 1px solid #f3f4f6;
        }
        th {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          font-weight: 600;
          color: white;
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          position: sticky;
          top: 0;
          z-index: 10;
        }
        td {
          font-size: 14px;
          color: var(--text);
          font-weight: 500;
        }
        tbody tr {
          transition: all 0.2s ease;
        }
        tbody tr:hover {
          background: #f9fafb;
          transform: scale(1.005);
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .small {
          font-size: 12px;
          color: var(--text-light);
        }

        .badge {
          display: inline-block;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          letter-spacing: 0.3px;
        }
        .badge-approved {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
        }
        .badge-pending {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
        }

        a.link {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          font-size: 13px;
          font-weight: 600;
          color: var(--accent);
          text-decoration: none;
          transition: all 0.2s ease;
          padding: 6px 10px;
          border-radius: 8px;
        }
        a.link:hover {
          background: rgba(102, 126, 234, 0.1);
          color: var(--accent-hover);
        }

        a.link-danger {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          font-size: 13px;
          font-weight: 600;
          color: #ef4444;
          text-decoration: none;
          transition: all 0.2s ease;
          padding: 6px 10px;
          border-radius: 8px;
        }
        a.link-danger:hover {
          background: rgba(239, 68, 68, 0.1);
          color: #dc2626;
        }

        /* í…Œì´ë¸” ì•¡ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-action {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 4px;
          padding: 8px 14px;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          text-decoration: none;
          border: none;
          cursor: pointer;
          transition: all 0.2s ease;
          white-space: nowrap;
        }

        /* í•™ìƒ ì´ë¦„ ë²„íŠ¼ (íŒŒë€ìƒ‰) */
        .btn-student {
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          color: white;
        }
        .btn-student:hover {
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ë²„íŠ¼ - ë¯¸ë¶€ì—¬ (íšŒìƒ‰) */
        .btn-series-none {
          background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
          color: white;
        }
        .btn-series-none:hover {
          background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        /* ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ë²„íŠ¼ - ë¶€ì—¬ì™„ë£Œ (ì´ˆë¡ìƒ‰) */
        .btn-series-done {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
        }
        .btn-series-done:hover {
          background: linear-gradient(135deg, #059669 0%, #047857 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* í•™ìŠµì‹¤ ìƒíƒœ ë±ƒì§€ */
        .study-room-badge {
          display: inline-block;
          padding: 6px 14px;
          border-radius: 14px;
          font-size: 14px;
          font-weight: 700;
          text-decoration: none;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        /* í•™ìŠµì‹¤ ìƒíƒœ ì…€ ê°€ìš´ë° ì •ë ¬ */
        td:has(.study-room-badge) {
          text-align: center;
        }
        .study-room-badge:hover {
          transform: scale(1.05);
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .study-room-empty {
          background: #f3f4f6;
          color: #6b7280;
        }
        .study-room-complete {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
        }
        .study-room-pending {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
        }

        /* ì¹´ì¹´ì˜¤í†¡ ê³¼ì œ ì•Œë¦¼ ë²„íŠ¼ (ë…¸ë€ìƒ‰) */
        .btn-kakao-alert {
          background: linear-gradient(135deg, #FEE500 0%, #FFCD00 100%);
          color: #3C1E1E;
          border: none;
          cursor: pointer;
        }
        .btn-kakao-alert:hover {
          background: linear-gradient(135deg, #FFCD00 0%, #F5C000 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(255, 205, 0, 0.4);
        }

        /* í•™ìŠµ ì´ë ¥ ë²„íŠ¼ (ì´ˆë¡ìƒ‰) */
        .btn-history {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
        }
        .btn-history:hover {
          background: linear-gradient(135deg, #059669 0%, #047857 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* ìˆ˜ì • ë²„íŠ¼ (ì£¼í™©ìƒ‰) */
        .btn-edit {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
        }
        .btn-edit:hover {
          background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* ìƒíƒœ ë²„íŠ¼ - ìŠ¹ì¸ (ì´ˆë¡ìƒ‰) */
        .btn-status-approved {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
        }
        .btn-status-approved:hover {
          background: linear-gradient(135deg, #059669 0%, #047857 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* ìƒíƒœ ë²„íŠ¼ - ë¯¸ìŠ¹ì¸ (ì£¼í™©ìƒ‰) */
        .btn-status-pending {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
        }
        .btn-status-pending:hover {
          background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        @media (max-width: 1024px) {
          .wrap { padding: 30px 16px; }
          h1 { font-size: 28px; }
          .toolbar {
            flex-direction: column;
            align-items: stretch;
          }
          .toolbar form {
            flex-direction: column;
          }
          .search-input, .search-select, .btn {
            width: 100%;
          }
        }

        @media (max-width: 720px) {
          h1 { font-size: 24px; }
          .table-wrap {
            border-radius: 12px;
            overflow-x: scroll;
          }
          th, td {
            font-size: 12px;
            padding: 12px 10px;
          }
        }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox-col {
          width: 50px;
          text-align: center;
        }
        input[type="checkbox"] {
          width: 18px;
          height: 18px;
          cursor: pointer;
          accent-color: var(--accent);
        }
        .bulk-actions {
          display: flex;
          gap: 10px;
          align-items: center;
        }
        .selected-count {
          font-weight: 600;
          color: var(--accent);
          padding: 8px 12px;
          background: rgba(102, 126, 234, 0.1);
          border-radius: 8px;
        }

        /* ìë™ê³¼ì œ ìŠ¤ì¼€ì¤„ ìŠ¤íƒ€ì¼ */
        .auto-schedule-cell {
          display: flex;
          flex-direction: row;
          flex-wrap: wrap;
          gap: 8px;
          max-width: 600px;
        }
        .no-schedule {
          color: #9ca3af;
          font-size: 14px;
        }
        .schedule-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 10px;
          background: #f3f4f6;
          border-radius: 8px;
          border-left: 4px solid #3b82f6;
          font-size: 12px;
          min-width: 200px;
          max-width: 280px;
          flex: 0 0 auto;
        }
        .schedule-item.paused {
          border-left-color: #9ca3af;
          background: #f9fafb;
        }
        .schedule-info {
          flex: 1;
        }
        .schedule-subject {
          font-weight: 600;
          color: #1f2937;
          margin-bottom: 4px;
        }
        .schedule-details {
          font-size: 12px;
          color: #6b7280;
        }
        .schedule-status {
          display: inline-block;
          margin-top: 4px;
          padding: 2px 8px;
          background: #dbeafe;
          color: #1e40af;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
        }
        .schedule-item.paused .schedule-status {
          background: #e5e7eb;
          color: #6b7280;
        }
        .schedule-actions {
          display: flex;
          gap: 4px;
          margin-left: 8px;
        }
        .btn-icon {
          width: 28px;
          height: 28px;
          border: none;
          background: white;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }
        .btn-icon:hover {
          background: #e5e7eb;
        }
        .btn-icon.btn-delete:hover {
          background: #fee2e2;
          color: #dc2626;
        }

        /* ìë™ê³¼ì œë¶€ì—¬ ë§í¬ ìŠ¤íƒ€ì¼ (ìŠˆí¼ê´€ë¦¬ììš©) */
        .admin-auto-task-link {
          display: inline-block;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 8px 14px;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          text-decoration: none;
          transition: all 0.2s ease;
          margin-bottom: 8px;
        }
        .admin-auto-task-link:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
          color: white;
        }

        /* ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          align-items: center;
          justify-content: center;
        }
        .modal-overlay.active {
          display: flex;
        }
        .modal-box {
          background: var(--panel);
          border-radius: 12px;
          padding: 24px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        .modal-title {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 16px;
          color: var(--accent);
        }
        .modal-body {
          margin-bottom: 20px;
        }
        .checkbox-group {
          display: flex;
          flex-direction: column;
          gap: 0;
        }
        .checkbox-item {
          display: flex;
          align-items: flex-start;
          gap: 10px;
          margin-bottom: 12px;
          padding: 10px;
          background: #f9f9f9;
          border-radius: 8px;
          border: 1px solid #e0e0e0;
          transition: all 0.2s ease;
        }
        .checkbox-item:hover {
          background: #f0f0f0;
          border-color: var(--accent);
        }

        /* ë”ë³´ê¸° ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        #loadMoreBtn:hover {
          background: #5568d3;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .checkbox-item input[type="checkbox"] {
          margin-top: 3px;
          flex-shrink: 0;
        }
        .checkbox-item label {
          flex: 1;
          margin: 0;
          cursor: pointer;
        }
        .series-name {
          font-weight: 600;
          color: var(--accent);
          display: block;
          margin-bottom: 2px;
        }
        .series-desc {
          font-size: 12px;
          color: #666;
          display: block;
        }
        .modal-footer {
          display: flex;
          gap: 8px;
          justify-content: flex-end;
        }
        .btn {
          padding: 8px 16px;
          font-size: 14px;
          border-radius: 6px;
          border: none;
          cursor: pointer;
          font-weight: 500;
        }
        .btn-ghost {
          background: #e0e0e0;
          color: #333;
        }
        .btn-ghost:hover {
          background: #d0d0d0;
        }
        .btn-main {
          background: var(--accent);
          color: #fff;
        }
        .btn-main:hover {
          opacity: 0.9;
        }
      </style>
      <!-- ì¹´ì¹´ì˜¤ SDK -->
      <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js"></script>
    </head>
    <body>
      <div class="wrap">
        <div class="top-bar">
          <div>
            <h1>AI ë¸Œë ˆì¸ ë¬¸í•´ë ¥ ì „ì²´ í•™ìƒ ëª©ë¡</h1>
            <p class="desc">
              AI ë¸Œë ˆì¸ ë¬¸í•´ë ¥ì— ê°€ì…ëœ ëª¨ë“  í•™ìƒ ê³„ì •ì„ í•œ ë²ˆì— í™•ì¸í•©ë‹ˆë‹¤.<br/>
              í•™ë…„, í•™êµëª…, ì´ë¦„, ë¡œê·¸ì¸ ìƒíƒœ ë“±ì„ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          <div>
            <a href="/super/dashboard" class="btn-back">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
          </div>
        </div>

        <div class="toolbar">
          <!-- AI ì¶”ì²œê³¼ì œ ëª©ë¡ ë²„íŠ¼ (ìˆ¨ê¹€) -->
          <button
            class="btn btn-main"
            onclick="openAITasksModal()"
            style="display: none; font-size: 16px; padding: 12px 24px; font-weight: 600; margin-right: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);"
          >
            ğŸ¤– AI ì¶”ì²œê³¼ì œ ëª©ë¡
          </button>

          <!-- ìë™ ê³¼ì œ ë¶€ì—¬ ë²„íŠ¼ (ìˆ¨ê¹€) -->
          <button
            class="btn btn-main"
            onclick="openAutoTaskModal()"
            style="display: none; font-size: 16px; padding: 12px 24px; font-weight: 600; margin-right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);"
          >
            ğŸ“š ìë™ ê³¼ì œ ë¶€ì—¬
          </button>

          <form method="GET" action="/admin/users">
            <input type="hidden" name="key" value="${key || ""}" />
            <input
              type="text"
              name="q"
              class="search-input"
              placeholder="ì´ë¦„, í•™êµ, í•™ë…„ ê²€ìƒ‰"
              value="${q ? q : ""}"
            />
            <select name="sort" class="search-select">
              <option value="priority" ${!sort || sort === "priority" ? "selected" : ""}>â­ ìš°ì„ ìˆœìœ„ (ë¯¸ìŠ¹ì¸â†’ë¯¸ë¶€ì—¬â†’ìµœì‹ )</option>
              <option value="lastLoginDesc" ${sort === "lastLoginDesc" ? "selected" : ""}>ìµœê·¼ ë¡œê·¸ì¸ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)</option>
              <option value="lastLoginAsc" ${sort === "lastLoginAsc" ? "selected" : ""}>ìµœê·¼ ë¡œê·¸ì¸ìˆœ(ì˜¤ë¦„ì°¨ìˆœ)</option>
              <option value="gradeAsc" ${sort === "gradeAsc" ? "selected" : ""}>í•™ë…„ ì˜¤ë¦„ì°¨ìˆœ</option>
              <option value="gradeDesc" ${sort === "gradeDesc" ? "selected" : ""}>í•™ë…„ ë‚´ë¦¼ì°¨ìˆœ</option>
              <option value="nameAsc" ${sort === "nameAsc" ? "selected" : ""}>ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ</option>
              <option value="nameDesc" ${sort === "nameDesc" ? "selected" : ""}>ì´ë¦„ ì—­ìˆœ</option>
            </select>
            <button type="submit" class="btn btn-main">ê²€ìƒ‰</button>
          </form>

          <div class="bulk-actions" id="bulkActions" style="display: none;">
            <span class="selected-count" id="selectedCount">0ëª… ì„ íƒë¨</span>
            <button class="btn btn-danger" onclick="bulkDeleteUsers()">ì„ íƒí•œ í•™ìƒ ì‚­ì œ</button>
          </div>

          <form method="GET" action="/admin/users-export">
            <input type="hidden" name="key" value="${key || ""}" />
            <input type="hidden" name="q" value="${q ? q : ""}" />
            <input type="hidden" name="sort" value="${sort || ""}" />
            <button type="submit" class="btn btn-ghost">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          </form>

          <button
            id="btn-delete-all"
            class="btn"
            style="background: #dc2626; color: #fff; border-color: #dc2626;"
            onclick="deleteAllData()"
          >
            ì „ì²´ ë°ì´í„° ì‚­ì œ
          </button>

          <a
            href="/admin/trash?key=${encodeURIComponent(key || "")}"
            class="btn btn-danger"
            style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;"
          >
            íœ´ì§€í†µ ë³´ê¸°
          </a>
        </div>

        <p class="info-line">
          ì´ <strong>${users.length}</strong>ëª…ì˜ í•™ìƒì´ ìˆìŠµë‹ˆë‹¤.
          ${q && q.trim() !== "" ? `<span class="small">(ê²€ìƒ‰ì–´: "${q.trim()}")</span>` : ""}
          <br/>
          <span class="small">â€» ë§í¬ í´ë¦­ ì‹œ íœ´ì§€í†µ ì´ë™, ìƒíƒœ ë³€ê²½, í•™ìŠµ ì´ë ¥ í™•ì¸ ë“±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
        </p>

        <!-- í•µì‹¬ ê¸°ëŠ¥ ì•ˆë‚´ -->
        <div style="
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          border-radius: 12px;
          padding: 20px 24px;
          margin-bottom: 20px;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        ">
          <div style="
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
          ">
            <span style="
              font-size: 24px;
              background: rgba(255, 255, 255, 0.2);
              width: 42px;
              height: 42px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            ">â­</span>
            <div>
              <div style="
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 8px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
              ">í•µì‹¬ ê¸°ëŠ¥ : ğŸ‘¤ í•™ìƒ ì´ë¦„ í´ë¦­</div>
              <div style="
                font-size: 14px;
                line-height: 1.6;
                opacity: 0.95;
              ">
                í•´ë‹¹ í•™ìƒ í™”ë©´ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•˜ì—¬ <strong>í•™ìƒ ì „ì²´ ìƒí™©ì„ í•œ ëˆˆì— íŒŒì•…</strong>í•˜ê³ ,
                <strong>ìˆ˜ë™ìœ¼ë¡œ ê³¼ì œë¥¼ ë¶€ì—¬</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="checkbox-col">
                  <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" />
                </th>
                <th>#</th>
                <th>í•™ë…„</th>
                <th>ë°˜</th>
                <th>ë²ˆí˜¸</th>
                <th>ì´ë¦„</th>
                <th>í•™êµëª…</th>
                <th>í•™ë…„ë°˜ë²ˆí˜¸(ID)</th>
                <th>ìƒíƒœ</th>
                <th>ì‹œë¦¬ì¦ˆ ë¶€ì—¬</th>
                <th style="cursor: pointer;" onclick="sortByPendingTasks()" title="í´ë¦­í•˜ë©´ ë¯¸ì™„ë£Œ ê³¼ì œìˆœìœ¼ë¡œ ì •ë ¬">
                  í•™ìŠµì‹¤ ìƒíƒœ<br><span style="font-size: 10px; color: #888; font-weight: normal;">(ì–´íœ˜í•™ìŠµ ì œì™¸)</span>
                  <span id="studyRoomSortIcon" style="margin-left: 4px;">â‡…</span>
                </th>
                <th>ê³¼ì œ ì•Œë¦¼<br><span style="font-size: 10px; color: #888; font-weight: normal;">(ê°œì¸ë³„ ë°œì†¡)</span></th>
                <th>ìë™ê³¼ì œ ìŠ¤ì¼€ì¤„</th>
                <th>ìˆ˜ì •</th>
              </tr>
            </thead>
            <tbody>
    `;

    users.forEach((u, idx) => {
      const last = u.lastLogin
        ? new Date(u.lastLogin).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          })
        : "-";
      const idOrPhone = u.id || u.phone || "";

      const status = u.status || "approved";

      // ìƒíƒœ ë²„íŠ¼ (ìŠ¹ì¸/ë¯¸ìŠ¹ì¸ í† ê¸€)
      const statusButtonText = status === "approved" ? "âœ“ ìŠ¹ì¸" : "â³ ë¯¸ìŠ¹ì¸";
      const statusButtonClass = status === "approved" ? "btn-action btn-status-approved" : "btn-action btn-status-pending";
      const nextStatus = status === "approved" ? "pending" : "approved";
      const confirmMessage = status === "approved"
        ? "ì´ íšŒì›ì„ ë¯¸ìŠ¹ì¸ ìƒíƒœë¡œ ì „í™˜í• ê¹Œìš”?"
        : "ì´ íšŒì›ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

      // ì•ˆì „í•˜ê²Œ JSON ë°ì´í„° ì „ë‹¬
      const escapedName = (u.name || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
      const assignedSeriesJson = JSON.stringify(u.assignedSeries || [])
        .replace(/'/g, "\\'")
        .replace(/"/g, "&quot;");

      // ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ìŠ¤íƒ€ì¼
      const hasAssignedSeries = u.assignedSeries && u.assignedSeries.length > 0;
      const seriesButtonText = hasAssignedSeries ? 'ğŸ“š ë¶€ì—¬ì™„ë£Œ' : 'ğŸ“š ë¯¸ë¶€ì—¬';
      const seriesButtonClass = hasAssignedSeries ? 'btn-action btn-series-done' : 'btn-action btn-series-none';

      // í•™ìŠµì‹¤ ê³¼ì œ ìƒíƒœ ê³„ì‚° (LearningLog ê¸°ë°˜)
      const assignedTasks = u.studyRoom?.assignedTasks || [];
      const totalTasks = assignedTasks.length;
      const completedUnits = u.completedUnits || new Set();

      // ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°: AI ê³¼ì œëŠ” status, ì¼ë°˜ ê³¼ì œëŠ” LearningLog í™•ì¸
      const completedTasks = assignedTasks.filter(t => {
        if (t.isAI) {
          // AI ê³¼ì œëŠ” statusê°€ 'completed'ì¸ ê²½ìš°
          return t.status === 'completed';
        } else {
          // ì¼ë°˜ ê³¼ì œëŠ” LearningLogì—ì„œ í™•ì¸
          // unitIdì—ì„œ ë‹¨ì› ì½”ë“œ ì¶”ì¶œ: ./BRAINUP/science/bio_01.html â†’ bio_01
          const unitId = t.unitId || t.id || '';
          const match = unitId.match(/([a-z_]+_\d+)\.html$/i) || unitId.match(/([a-z_]+_\d+)$/i);
          const unitCode = match ? match[1] : unitId;
          return completedUnits.has(unitCode);
        }
      }).length;

      const studyRoomStatusText = totalTasks > 0 ? `${completedTasks}/${totalTasks}` : '-';
      const studyRoomStatusClass = totalTasks === 0 ? 'study-room-empty' : (completedTasks === totalTasks ? 'study-room-complete' : 'study-room-pending');
      const pendingTasks = totalTasks - completedTasks;  // ë¯¸ì™„ë£Œ ê³¼ì œ ìˆ˜

      html += `
        <tr data-user-grade="${u.grade || ''}" data-user-name="${u.name || ''}" data-pending="${pendingTasks}">
          <td class="checkbox-col">
            <input type="checkbox" class="user-checkbox" value="${idOrPhone}" data-grade="${u.grade || ''}" data-name="${u.name || ''}" onchange="updateSelectedCount()" />
          </td>
          <td>${idx + 1}</td>
          <td>${u.grade || ""}</td>
          <td>${u.classNum || ""}</td>
          <td>${u.studentNum || u.number || ""}</td>
          <td>
            <a class="btn-action btn-student"
               href="/menu?grade=${encodeURIComponent(u.grade || '')}&name=${encodeURIComponent(u.name || '')}"
               target="_blank"
               title="í•™ìƒ í™”ë©´ìœ¼ë¡œ ì´ë™ (ìƒˆ íƒ­)">
              ğŸ‘¤ ${u.name || ""}
            </a>
          </td>
          <td>${u.school || ""}</td>
          <td>${idOrPhone}</td>
          <td>
            <a class="${statusButtonClass}"
               href="/admin/status?id=${encodeURIComponent(idOrPhone)}&status=${nextStatus}&key=${encodeURIComponent(key)}"
               onclick="return confirm('${confirmMessage}');">
              ${statusButtonText}
            </a>
          </td>
          <td>
            <a class="${seriesButtonClass}"
               href="#"
               onclick="openSeriesModal('${u._id}', '${escapedName}', '${assignedSeriesJson}'); return false;">
              ${seriesButtonText}
            </a>
          </td>
          <td>
            <a href="/menu?grade=${encodeURIComponent(u.grade || '')}&name=${encodeURIComponent(u.name || '')}&openStudyRoom=true"
               target="_blank"
               class="study-room-badge ${studyRoomStatusClass}"
               title="í•™ìŠµì‹¤ ì—´ê¸° (ìƒˆ íƒ­)">${studyRoomStatusText}</a>
          </td>
          <td>
            <button class="btn-action btn-kakao-alert"
               onclick="sendKakaoTaskAlert('${encodeURIComponent(u.grade || '')}', '${encodeURIComponent(u.name || '')}')">
              ğŸ’¬ ì•Œë¦¼
            </button>
          </td>
          <td>
            <a class="admin-auto-task-link"
               href="/menu?grade=${encodeURIComponent(u.grade || '')}&name=${encodeURIComponent(u.name || '')}&openStudyRoom=true&openAutoTask=true"
               target="_blank"
               title="í•™ìŠµì‹¤ì—ì„œ ìë™ê³¼ì œë¶€ì—¬ ì„¤ì •">
              âš™ï¸ ìë™ê³¼ì œë¶€ì—¬
            </a>
            <div id="schedule-${idOrPhone}" class="auto-schedule-cell">
              ${renderSchedules(u.studyRoom?.autoTaskSchedules || [], u.grade || '', u.name || '')}
            </div>
          </td>
          <td>
            <a class="btn-action btn-edit"
               href="/admin/user-edit?id=${encodeURIComponent(
                 idOrPhone
               )}&key=${encodeURIComponent(key)}">
              âœï¸ ìˆ˜ì •
            </a>
          </td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>

      <!-- ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ëª¨ë‹¬ -->
      <div id="seriesModal" class="modal-overlay">
        <div class="modal-box">
          <div class="modal-title">ì‹œë¦¬ì¦ˆ ë¶€ì—¬</div>
          <div class="modal-body">
            <p style="margin-bottom: 12px; font-size: 14px; color: #555;">
              <strong id="modalUserName"></strong> í•™ìƒì—ê²Œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”:
            </p>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="series-brainun" value="BRAINì€" />
                <label for="series-brainun">
                  <span class="series-name">BRAIN ON</span>
                  <span class="series-desc">ê°œë…ì´í•´</span>
                </label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="series-brainam" value="BRAINì•”" />
                <label for="series-brainam">
                  <span class="series-name">BRAIN UP</span>
                  <span class="series-desc">ì‘ìš©ì ìš©</span>
                </label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="series-brainbit" value="BRAINë¹›" />
                <label for="series-brainbit">
                  <span class="series-name">BRAIN FIT</span>
                  <span class="series-desc">ì‚¬ê³ ì—°ê²°</span>
                </label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="series-braindap" value="BRAINë‹µ" />
                <label for="series-braindap">
                  <span class="series-name">BRAIN DEEP</span>
                  <span class="series-desc">ì‹¬í™”ì¶”ë¡ </span>
                </label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="series-brainjung" value="BRAINì¤‘ë“±" />
                <label for="series-brainjung">
                  <span class="series-name">BRAIN ì‹¤ì „</span>
                  <span class="series-desc">ìˆ˜ëŠ¥ëª¨ê³ </span>
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeSeriesModal()">ì·¨ì†Œ</button>
            <button class="btn btn-main" onclick="submitSeries()">ì €ì¥</button>
          </div>
        </div>
      </div>

      <script>
        // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
        if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
          Kakao.init('6ad10cc6680c7a5829a4fd7a3cbb4a7e');
        }

        // ì¹´ì¹´ì˜¤í†¡ ê³¼ì œ ì•Œë¦¼ ì „ì†¡
        function sendKakaoTaskAlert(grade, name) {
          grade = decodeURIComponent(grade);
          name = decodeURIComponent(name);

          if (!grade || !name) {
            alert('í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
            alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
          }

          try {
            const baseUrl = 'https://dan-dan-app.onrender.com';
            const studyRoomUrl = baseUrl + '/menu.html?openStudyRoom=true&grade=' + encodeURIComponent(grade) + '&name=' + encodeURIComponent(name);

            Kakao.Share.sendDefault({
              objectType: 'feed',
              content: {
                title: 'ğŸ“š ' + name + ' í•™ìƒ ê³¼ì œ ì•Œë¦¼',
                description: grade + ' ' + name + ' í•™ìƒ, í•™ìŠµì‹¤ì˜ ê³¼ì œë¥¼ ê¼­ í™•ì¸í•´ ì£¼ì„¸ìš”!',
                imageUrl: 'https://dan-dan-app.onrender.com/images/dandan_logo.png',
                link: {
                  mobileWebUrl: studyRoomUrl,
                  webUrl: studyRoomUrl
                }
              },
              buttons: [
                {
                  title: 'ë‚˜ì˜ í•™ìŠµì‹¤ ì—´ê¸°',
                  link: {
                    mobileWebUrl: studyRoomUrl,
                    webUrl: studyRoomUrl
                  }
                }
              ]
            });
          } catch (error) {
            console.error('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì˜¤ë¥˜:', error);
            alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        let currentUserId = null;

        function openSeriesModal(userId, userName, assignedSeriesStr) {
          currentUserId = userId;
          document.getElementById('modalUserName').textContent = userName;

          // ë¬¸ìì—´ì„ ë°°ì—´ë¡œ íŒŒì‹±
          let assignedSeries = [];
          try {
            assignedSeries = JSON.parse(assignedSeriesStr);
          } catch (e) {
            console.error('Failed to parse assignedSeries:', e);
          }

          const checkboxes = document.querySelectorAll('#seriesModal input[type="checkbox"]');
          checkboxes.forEach(cb => {
            cb.checked = assignedSeries.includes(cb.value);
          });

          document.getElementById('seriesModal').classList.add('active');
        }

        function closeSeriesModal() {
          document.getElementById('seriesModal').classList.remove('active');
          currentUserId = null;
        }

        async function submitSeries() {
          if (!currentUserId) return;

          const checkboxes = document.querySelectorAll('#seriesModal input[type="checkbox"]');
          const selectedSeries = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

          try {
            const res = await fetch('/admin/assign-series', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                key: '${key}',
                userId: currentUserId,
                series: selectedSeries
              })
            });

            const data = await res.json();
            if (data.success) {
              alert('ì‹œë¦¬ì¦ˆë¶€ì—¬ ì™„ë£Œ');
              closeSeriesModal();
              // AI í•™ìŠµ ì¸ì‹ ì¤‘ ìŠ¤ì™€ì´í”„ í‘œì‹œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
              showLoadingSwipe();
            } else {
              alert('ì˜¤ë¥˜: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          } catch (err) {
            console.error(err);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // AI í•™ìŠµ ì¸ì‹ ì¤‘ ìŠ¤ì™€ì´í”„ ì• ë‹ˆë©”ì´ì…˜
        function showLoadingSwipe() {
          const overlay = document.createElement('div');
          overlay.id = 'aiLoadingOverlay';
          overlay.innerHTML = \`
            <div style="
              position: fixed;
              top: 0; left: 0; right: 0; bottom: 0;
              background: rgba(0,0,0,0.7);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 99999;
            ">
              <div style="
                background: white;
                padding: 40px 60px;
                border-radius: 16px;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
              ">
                <div style="
                  width: 50px;
                  height: 50px;
                  border: 4px solid #e5e7eb;
                  border-top-color: #3b82f6;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                  margin: 0 auto 20px;
                "></div>
                <div style="font-size: 18px; font-weight: 600; color: #333;">AI í•™ìŠµ ì¸ì‹ ì¤‘..</div>
              </div>
            </div>
            <style>
              @keyframes spin {
                to { transform: rotate(360deg); }
              }
            </style>
          \`;
          document.body.appendChild(overlay);

          setTimeout(() => {
            location.reload();
          }, 1500);
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('seriesModal').addEventListener('click', function(e) {
          if (e.target === this) {
            closeSeriesModal();
          }
        });

        // í•™ìŠµì‹¤ ìƒíƒœ ì •ë ¬ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜
        let pendingSortOrder = 'desc';  // ê¸°ë³¸: ë‚´ë¦¼ì°¨ìˆœ (ë¯¸ì™„ë£Œ ë§ì€ ìˆœ)

        function sortByPendingTasks() {
          const tbody = document.querySelector('table tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));

          // ì •ë ¬
          rows.sort((a, b) => {
            const pendingA = parseInt(a.dataset.pending) || 0;
            const pendingB = parseInt(b.dataset.pending) || 0;

            if (pendingSortOrder === 'desc') {
              return pendingB - pendingA;  // ë¯¸ì™„ë£Œ ë§ì€ ìˆœ
            } else {
              return pendingA - pendingB;  // ë¯¸ì™„ë£Œ ì ì€ ìˆœ
            }
          });

          // DOM ì¬ë°°ì¹˜
          rows.forEach(row => tbody.appendChild(row));

          // ë²ˆí˜¸ ì¬ì •ë ¬
          rows.forEach((row, idx) => {
            const numCell = row.querySelector('td:nth-child(2)');
            if (numCell) numCell.textContent = idx + 1;
          });

          // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
          const icon = document.getElementById('studyRoomSortIcon');
          if (icon) {
            icon.textContent = pendingSortOrder === 'desc' ? 'â†“' : 'â†‘';
          }

          // ë‹¤ìŒ í´ë¦­ì‹œ ë°˜ëŒ€ ì •ë ¬
          pendingSortOrder = pendingSortOrder === 'desc' ? 'asc' : 'desc';
        }

        // ì²´í¬ë°•ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.user-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
          });
          updateSelectedCount();
        }

        function updateSelectedCount() {
          const checkboxes = document.querySelectorAll('.user-checkbox:checked');
          const count = checkboxes.length;
          const bulkActions = document.getElementById('bulkActions');
          const selectedCount = document.getElementById('selectedCount');

          if (count > 0) {
            bulkActions.style.display = 'flex';
            selectedCount.textContent = count + 'ëª… ì„ íƒë¨';
          } else {
            bulkActions.style.display = 'none';
          }
        }

        async function bulkDeleteUsers() {
          const checkboxes = document.querySelectorAll('.user-checkbox:checked');
          if (checkboxes.length === 0) {
            alert('ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          const userList = Array.from(checkboxes).map(cb => cb.dataset.name).join(', ');
          const confirmMsg = \`ì„ íƒí•œ \${checkboxes.length}ëª…ì˜ í•™ìƒì„ íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\ní•™ìƒ ëª©ë¡: \${userList}\`;

          if (!confirm(confirmMsg)) {
            return;
          }

          const userIds = Array.from(checkboxes).map(cb => cb.value);

          try {
            const promises = userIds.map(userId =>
              fetch(\`/trash-user?id=\${encodeURIComponent(userId)}&key=\${encodeURIComponent('${key}')}\`)
            );

            await Promise.all(promises);
            alert('ì„ íƒí•œ í•™ìƒë“¤ì´ íœ´ì§€í†µìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.reload();
          } catch (error) {
            console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // ìŠ¤ì¼€ì¤„ ì¼ì‹œì •ì§€/ì¬ê°œ
        async function toggleSchedule(scheduleId, grade, name) {
          try {
            const res = await fetch(\`/api/auto-task-schedule/\${scheduleId}/toggle\`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ grade, name })
            });

            const data = await res.json();

            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert(\`âŒ ì˜¤ë¥˜: \${data.message}\`);
            }
          } catch (err) {
            console.error('ìŠ¤ì¼€ì¤„ í† ê¸€ ì˜¤ë¥˜:', err);
            alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // ìŠ¤ì¼€ì¤„ ì‚­ì œ
        async function deleteSchedule(scheduleId, grade, name) {
          if (!confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
          }

          try {
            const res = await fetch(\`/api/auto-task-schedule/\${scheduleId}?grade=\${encodeURIComponent(grade)}&name=\${encodeURIComponent(name)}\`, {
              method: 'DELETE'
            });

            const data = await res.json();

            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert(\`âŒ ì˜¤ë¥˜: \${data.message}\`);
            }
          } catch (err) {
            console.error('ìŠ¤ì¼€ì¤„ ì‚­ì œ ì˜¤ë¥˜:', err);
            alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // ì „ì²´ ë°ì´í„° ì‚­ì œ
        async function deleteAllData() {
          const confirmMsg = "âš ï¸ ê²½ê³ : ëª¨ë“  íšŒì› ì •ë³´ì™€ í•™ìŠµ ê¸°ë¡ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.\\n\\nì •ë§ë¡œ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!";

          if (!confirm(confirmMsg)) {
            return;
          }

          // 2ì°¨ í™•ì¸
          const doubleConfirm = prompt("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œë ¤ë©´ 'ì‚­ì œí•˜ê¸°'ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
          if (doubleConfirm !== "ì‚­ì œí•˜ê¸°") {
            alert("ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
          }

          try {
            const btn = document.getElementById("btn-delete-all");
            btn.disabled = true;
            btn.textContent = "ì‚­ì œ ì¤‘...";

            const res = await fetch("/api/delete-all-data", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ key: "${key}" })
            });

            const data = await res.json();

            if (data.success) {
              alert(\`âœ… ì „ì²´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ!\\n\\nì‚­ì œëœ íšŒì›: \${data.deletedUsers}ëª…\\nì‚­ì œëœ í•™ìŠµ ê¸°ë¡: \${data.deletedRecords}ê°œ\`);
              window.location.reload();
            } else {
              alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }
          } catch (err) {
            console.error("ì‚­ì œ ì—ëŸ¬:", err);
            alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          } finally {
            const btn = document.getElementById("btn-delete-all");
            btn.disabled = false;
            btn.textContent = "ì „ì²´ ë°ì´í„° ì‚­ì œ";
          }
        }
      </script>

      <!-- AI ì¶”ì²œê³¼ì œ ëª©ë¡ ëª¨ë‹¬ -->
      <div id="aiTasksModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 85vh; display: flex; flex-direction: column;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
            <h2 style="margin: 0; font-size: 24px; font-weight: 700;">ğŸ¤– AI ì¶”ì²œê³¼ì œ ëª©ë¡</h2>
            <button onclick="closeAITasksModal()" style="background: transparent; border: none; font-size: 28px; cursor: pointer; color: #666; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 16px; color: #666; font-size: 14px;">
            ì´ <span id="aiTasksCount">0</span>ê°œì˜ AI ì¶”ì²œê³¼ì œê°€ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.
          </div>
          <div style="overflow-x: auto; overflow-y: auto; flex: 1;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">#</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">í•™ë…„</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ì´ë¦„</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">í•™ì›ëª…</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 200px;">ê³¼ì œëª…</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ì‹œë¦¬ì¦ˆ</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ë¶„ì•¼</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ê³¼ëª©</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ë¶€ì—¬ì‹œê°„</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; white-space: nowrap;">ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="aiTasksTbody">
                <tr>
                  <td colspan="10" style="padding: 40px; text-align: center; color: #999;">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="loadMoreContainer" style="text-align: center; margin-top: 20px; padding: 16px 0; border-top: 1px solid #e5e7eb; display: none;">
            <button id="loadMoreBtn" onclick="loadMoreAITasks()" style="padding: 12px 32px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
              ë”ë³´ê¸° â–¼
            </button>
          </div>
        </div>
      </div>

      <!-- ìë™ ê³¼ì œ ë¶€ì—¬ ëª¨ë‹¬ -->
      <div id="autoTaskModal" class="auto-task-modal" style="display: none;">
        <div class="auto-task-modal-overlay" onclick="closeAutoTaskModal()"></div>
        <div class="auto-task-modal-content">
          <div class="auto-task-modal-header">
            <h2>ìë™ ê³¼ì œ ë¶€ì—¬ ì„¤ì •</h2>
            <button class="close-btn" onclick="closeAutoTaskModal()">&times;</button>
          </div>

          <div class="auto-task-modal-body">
            <!-- ì„ íƒëœ í•™ìƒ í‘œì‹œ -->
            <div class="selected-students-section">
              <h3>ì„ íƒëœ í•™ìƒ (<span id="selectedStudentCount">0</span>ëª…)</h3>
              <div id="selectedStudentsList" class="selected-students-list"></div>
            </div>

            <!-- â‘  ìš”ì¼ ì„ íƒ -->
            <div class="form-section">
              <h3>â‘  ìš”ì¼ ì„ íƒ</h3>
              <div class="day-selection">
                <label><input type="checkbox" id="day-all" value="all" onchange="handleDayAllChange(this)"> ë§¤ì¼</label>
                <label><input type="checkbox" class="day-checkbox" value="1" onchange="handleDayChange()"> ì›”</label>
                <label><input type="checkbox" class="day-checkbox" value="2" onchange="handleDayChange()"> í™”</label>
                <label><input type="checkbox" class="day-checkbox" value="3" onchange="handleDayChange()"> ìˆ˜</label>
                <label><input type="checkbox" class="day-checkbox" value="4" onchange="handleDayChange()"> ëª©</label>
                <label><input type="checkbox" class="day-checkbox" value="5" onchange="handleDayChange()"> ê¸ˆ</label>
                <label><input type="checkbox" class="day-checkbox" value="6" onchange="handleDayChange()"> í† </label>
                <label><input type="checkbox" class="day-checkbox" value="0" onchange="handleDayChange()"> ì¼</label>
              </div>
            </div>

            <!-- â‘¡ ê³¼ëª© ì„ íƒ -->
            <div class="form-section">
              <h3>â‘¡ ê³¼ëª© ì„ íƒ</h3>
              <div class="subject-tree">
                <!-- ì‹œë¦¬ì¦ˆ ì „ì²´ -->
                <div class="subject-item level-0">
                  <label>
                    <input type="checkbox" id="series-all" onchange="handleSeriesAllChange(this)">
                    <span>ì‹œë¦¬ì¦ˆ ì „ì²´</span>
                  </label>
                </div>

                <!-- ê³¼í•™ë¶„ì•¼ -->
                <div class="subject-item level-1">
                  <label>
                    <input type="checkbox" class="field-checkbox" data-field="science" onchange="handleFieldChange(this, 'science')">
                    <span>ê³¼í•™ë¶„ì•¼ ì „ì²´</span>
                  </label>
                </div>
                <div class="subject-group level-2">
                  <label><input type="checkbox" class="subject-checkbox" data-field="science" data-subject="bio" value="science/bio" onchange="handleSubjectChange()"> ìƒë¬¼</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="science" data-subject="geo" value="science/geo_earth" onchange="handleSubjectChange()"> ì§€êµ¬ê³¼í•™</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="science" data-subject="phy" value="science/physics" onchange="handleSubjectChange()"> ë¬¼ë¦¬</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="science" data-subject="chem" value="science/chemistry" onchange="handleSubjectChange()"> í™”í•™</label>
                </div>

                <!-- ì‚¬íšŒë¶„ì•¼ -->
                <div class="subject-item level-1">
                  <label>
                    <input type="checkbox" class="field-checkbox" data-field="social" onchange="handleFieldChange(this, 'social')">
                    <span>ì‚¬íšŒë¶„ì•¼ ì „ì²´</span>
                  </label>
                </div>
                <div class="subject-group level-2">
                  <label><input type="checkbox" class="subject-checkbox" data-field="social" data-subject="culture" value="social/culture" onchange="handleSubjectChange()"> ì‚¬íšŒë¬¸í™”</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="social" data-subject="geo" value="social/geo" onchange="handleSubjectChange()"> ì§€ë¦¬</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="social" data-subject="law" value="social/law" onchange="handleSubjectChange()"> ë²•</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="social" data-subject="politic" value="social/politic" onchange="handleSubjectChange()"> ì •ì¹˜ê²½ì œ</label>
                </div>

                <!-- í•œêµ­ë¬¸í•™ -->
                <div class="subject-item level-1">
                  <label>
                    <input type="checkbox" class="field-checkbox" data-field="korlit" onchange="handleFieldChange(this, 'korlit')">
                    <span>í•œêµ­ë¬¸í•™ ì „ì²´</span>
                  </label>
                </div>
                <div class="subject-group level-2">
                  <label><input type="checkbox" class="subject-checkbox" data-field="korlit" data-subject="classic" value="korlit/classic" onchange="handleSubjectChange()"> ê³ ì „ì†Œì„¤</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="korlit" data-subject="modern" value="korlit/modern" onchange="handleSubjectChange()"> í˜„ëŒ€ì†Œì„¤</label>
                </div>

                <!-- ì„¸ê³„ë¬¸í•™ -->
                <div class="subject-item level-1">
                  <label>
                    <input type="checkbox" class="field-checkbox" data-field="worldlit" onchange="handleFieldChange(this, 'worldlit')">
                    <span>ì„¸ê³„ë¬¸í•™ ì „ì²´</span>
                  </label>
                </div>
                <div class="subject-group level-2">
                  <label><input type="checkbox" class="subject-checkbox" data-field="worldlit" data-subject="1" value="worldlit/classic" onchange="handleSubjectChange()"> ì„¸ê³„ë¬¸í•™(1)</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="worldlit" data-subject="2" value="worldlit/modern" onchange="handleSubjectChange()"> ì„¸ê³„ë¬¸í•™(2)</label>
                </div>

                <!-- ì¸ë¬¼ -->
                <div class="subject-item level-1">
                  <label>
                    <input type="checkbox" class="field-checkbox" data-field="person" onchange="handleFieldChange(this, 'person')">
                    <span>ì¸ë¬¼ ì „ì²´</span>
                  </label>
                </div>
                <div class="subject-group level-2">
                  <label><input type="checkbox" class="subject-checkbox" data-field="person" data-subject="1" value="person/korea" onchange="handleSubjectChange()"> í•œêµ­ì¸ë¬¼</label>
                  <label><input type="checkbox" class="subject-checkbox" data-field="person" data-subject="2" value="person/world" onchange="handleSubjectChange()"> ì„¸ê³„ì¸ë¬¼</label>
                </div>
              </div>
            </div>

            <!-- â‘¢ ê³¼ì œ ê°œìˆ˜ -->
            <div class="form-section">
              <h3>â‘¢ 1ì¼ ê³¼ì œ ê°œìˆ˜</h3>
              <input type="number" id="taskCount" min="1" max="5" value="1" class="task-count-input">
              <span class="hint">í•˜ë£¨ì— ë¶€ì—¬í•  ë‹¨ì› ê°œìˆ˜ (1~5ê°œ)</span>
            </div>
          </div>

          <div class="auto-task-modal-footer">
            <button class="btn btn-cancel" onclick="closeAutoTaskModal()">ì·¨ì†Œ</button>
            <button class="btn btn-main" onclick="submitAutoTaskSchedule()">ìë™ ê³¼ì œ ì‹œì‘</button>
          </div>
        </div>
      </div>

      <style>
        /* ìë™ ê³¼ì œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .auto-task-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 10000;
        }

        .auto-task-modal-overlay {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
        }

        .auto-task-modal-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 700px;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .auto-task-modal-header {
          padding: 24px;
          border-bottom: 1px solid #e5e7eb;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .auto-task-modal-header h2 {
          margin: 0;
          font-size: 24px;
          font-weight: 700;
          color: #1e3a8a;
        }

        .auto-task-modal-header .close-btn {
          background: none;
          border: none;
          font-size: 32px;
          color: #6b7280;
          cursor: pointer;
          padding: 0;
          width: 32px;
          height: 32px;
          line-height: 1;
        }

        .auto-task-modal-header .close-btn:hover {
          color: #1f2937;
        }

        .auto-task-modal-body {
          padding: 24px;
          overflow-y: auto;
          flex: 1;
        }

        .auto-task-modal-footer {
          padding: 20px 24px;
          border-top: 1px solid #e5e7eb;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
        }

        /* ì„ íƒëœ í•™ìƒ ì„¹ì…˜ */
        .selected-students-section {
          margin-bottom: 24px;
          padding: 16px;
          background: linear-gradient(135deg, #1e3a8a, #3b82f6);
          border-radius: 8px;
          color: white;
        }

        .selected-students-section h3 {
          margin: 0 0 12px 0;
          font-size: 16px;
          font-weight: 600;
        }

        .selected-students-list {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
        }

        .student-badge {
          background: rgba(255, 255, 255, 0.2);
          padding: 4px 12px;
          border-radius: 16px;
          font-size: 14px;
          backdrop-filter: blur(10px);
        }

        /* í¼ ì„¹ì…˜ */
        .form-section {
          margin-bottom: 24px;
        }

        .form-section h3 {
          margin: 0 0 12px 0;
          font-size: 18px;
          font-weight: 600;
          color: #1f2937;
        }

        /* ê³¼ëª© íŠ¸ë¦¬ */
        .subject-tree {
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 16px;
          background: #f9fafb;
        }

        .subject-item {
          margin-bottom: 8px;
        }

        .subject-item.level-0 label {
          font-weight: 700;
          font-size: 16px;
          color: #1e3a8a;
        }

        .subject-item.level-1 {
          margin-left: 20px;
          margin-top: 12px;
        }

        .subject-item.level-1 label {
          font-weight: 600;
          font-size: 15px;
          color: #3b82f6;
        }

        .subject-group.level-2 {
          margin-left: 40px;
          margin-top: 8px;
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
        }

        .subject-group.level-2 label {
          font-size: 14px;
          color: #4b5563;
          cursor: pointer;
        }

        .subject-tree input[type="checkbox"] {
          margin-right: 8px;
          cursor: pointer;
        }

        /* ìš”ì¼ ì„ íƒ */
        .day-selection {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
        }

        .day-selection label {
          display: inline-flex;
          align-items: center;
          padding: 8px 16px;
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s;
          font-size: 14px;
        }

        .day-selection label:hover {
          border-color: #3b82f6;
          background: #eff6ff;
        }

        .day-selection input[type="checkbox"] {
          margin-right: 6px;
        }

        .day-selection input[type="checkbox"]:checked + * {
          font-weight: 600;
        }

        .day-selection label:has(input:checked) {
          border-color: #3b82f6;
          background: #dbeafe;
        }

        /* ê³¼ì œ ê°œìˆ˜ ì…ë ¥ */
        .task-count-input {
          width: 100px;
          padding: 8px 12px;
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          font-size: 16px;
          margin-right: 12px;
        }

        .task-count-input:focus {
          outline: none;
          border-color: #3b82f6;
        }

        .hint {
          color: #6b7280;
          font-size: 14px;
        }

        /* ë²„íŠ¼ */
        .btn-cancel {
          background: #e5e7eb;
          color: #1f2937;
        }

        .btn-cancel:hover {
          background: #d1d5db;
        }
      </style>

      <script>
        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openAutoTaskModal() {
          const checkedRows = document.querySelectorAll('tbody input[type="checkbox"]:checked');
          if (checkedRows.length === 0) {
            alert("í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          // ì„ íƒëœ í•™ìƒ ì •ë³´ ìˆ˜ì§‘
          const selectedStudents = [];
          checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const nameCell = row.cells[3]; // ì´ë¦„ ì»¬ëŸ¼
            const name = nameCell.textContent.trim();
            const idOrPhone = checkbox.value;
            selectedStudents.push({ idOrPhone, name });
          });

          // ì„ íƒëœ í•™ìƒ í‘œì‹œ
          document.getElementById('selectedStudentCount').textContent = selectedStudents.length;
          const studentsList = document.getElementById('selectedStudentsList');
          studentsList.innerHTML = selectedStudents.map(s =>
            \`<span class="student-badge">\${s.name}</span>\`
          ).join('');

          // ëª¨ë‹¬ í‘œì‹œ
          document.getElementById('autoTaskModal').style.display = 'block';
        }

        function closeAutoTaskModal() {
          document.getElementById('autoTaskModal').style.display = 'none';

          // í¼ ì´ˆê¸°í™”
          document.querySelectorAll('#autoTaskModal input[type="checkbox"]').forEach(cb => cb.checked = false);
          document.getElementById('taskCount').value = 1;
        }

        // ===== AI ì¶”ì²œê³¼ì œ ëª©ë¡ ëª¨ë‹¬ =====
        let allAITasks = [];
        let currentDisplayCount = 10;
        const PAGE_SIZE = 10;

        function openAITasksModal() {
          document.getElementById('aiTasksModal').style.display = 'flex';
          loadAITasks();
        }

        function closeAITasksModal() {
          document.getElementById('aiTasksModal').style.display = 'none';
        }

        async function loadAITasks() {
          const tbody = document.getElementById('aiTasksTbody');
          const countSpan = document.getElementById('aiTasksCount');
          const loadMoreContainer = document.getElementById('loadMoreContainer');

          try {
            const response = await fetch('/api/admin/ai-tasks?key=${key}');
            const result = await response.json();

            if (!result.ok) {
              tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center; color: #dc2626;">ì˜¤ë¥˜: ' + result.message + '</td></tr>';
              loadMoreContainer.style.display = 'none';
              return;
            }

            allAITasks = result.tasks || [];
            countSpan.textContent = result.total || 0;

            if (allAITasks.length === 0) {
              tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center; color: #999;">ì•„ì§ ë¶€ì—¬ëœ AI ì¶”ì²œê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
              loadMoreContainer.style.display = 'none';
              return;
            }

            // ì´ˆê¸° í‘œì‹œ ê°œìˆ˜ ë¦¬ì…‹
            currentDisplayCount = PAGE_SIZE;

            // í…Œì´ë¸” ë Œë”ë§
            renderAITasksTable();

            // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
            if (allAITasks.length > PAGE_SIZE) {
              loadMoreContainer.style.display = 'block';
            } else {
              loadMoreContainer.style.display = 'none';
            }

          } catch (error) {
            console.error('AI ì¶”ì²œê³¼ì œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center; color: #dc2626;">ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            loadMoreContainer.style.display = 'none';
          }
        }

        function renderAITasksTable() {
          const tbody = document.getElementById('aiTasksTbody');
          const loadMoreContainer = document.getElementById('loadMoreContainer');

          const tasksToShow = allAITasks.slice(0, currentDisplayCount);

          tbody.innerHTML = tasksToShow.map((task, index) => {
            const assignedTime = task.assignedAt ? formatAssignedTime(task.assignedAt) : '-';
            const statusText = getStatusText(task.status);
            const statusColor = getStatusColor(task.status);

            return \`
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px; color: #666;">\${index + 1}</td>
                <td style="padding: 12px;">\${task.grade}</td>
                <td style="padding: 12px; font-weight: 600;">\${task.name}</td>
                <td style="padding: 12px;">\${task.academyName || '-'}</td>
                <td style="padding: 12px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="\${task.taskTitle}">\${task.taskTitle}</td>
                <td style="padding: 12px;">\${task.series || '-'}</td>
                <td style="padding: 12px;">\${task.field || '-'}</td>
                <td style="padding: 12px;">\${task.subject || '-'}</td>
                <td style="padding: 12px; white-space: nowrap;">\${assignedTime}</td>
                <td style="padding: 12px;">
                  <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; background: \${statusColor}; color: #fff; white-space: nowrap;">
                    \${statusText}
                  </span>
                </td>
              </tr>
            \`;
          }).join('');

          // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
          if (currentDisplayCount >= allAITasks.length) {
            loadMoreContainer.style.display = 'none';
          } else {
            loadMoreContainer.style.display = 'block';
          }
        }

        function loadMoreAITasks() {
          currentDisplayCount += PAGE_SIZE;
          renderAITasksTable();
        }

        function formatAssignedTime(dateString) {
          if (!dateString) return '-';
          const date = new Date(dateString);
          const month = date.getMonth() + 1;
          const day = date.getDate();
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return \`\${month}ì›” \${day}ì¼ \${hours}:\${minutes}\`;
        }

        function getStatusText(status) {
          const statusMap = {
            'pending': 'ë¯¸ì™„ë£Œ',
            'in_progress': 'ì§„í–‰ì¤‘',
            'completed': 'ì™„ë£Œ'
          };
          return statusMap[status] || 'ë¯¸ì™„ë£Œ';
        }

        function getStatusColor(status) {
          const colorMap = {
            'pending': '#94a3b8',
            'in_progress': '#3b82f6',
            'completed': '#10b981'
          };
          return colorMap[status] || '#94a3b8';
        }

        // ì‹œë¦¬ì¦ˆ ì „ì²´ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        function handleSeriesAllChange(checkbox) {
          const allCheckboxes = document.querySelectorAll('.field-checkbox, .subject-checkbox');
          allCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            cb.disabled = checkbox.checked;
          });
        }

        // ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        function handleFieldChange(checkbox, field) {
          const subjectCheckboxes = document.querySelectorAll(\`.subject-checkbox[data-field="\${field}"]\`);
          subjectCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
          });
          updateSeriesAllCheckbox();
        }

        // ê°œë³„ ê³¼ëª© ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        function handleSubjectChange() {
          // ê° ë¶„ì•¼ë³„ë¡œ ì²´í¬ ìƒíƒœ í™•ì¸
          const fields = ['science', 'social', 'korlit', 'worldlit', 'person'];
          fields.forEach(field => {
            const fieldCheckbox = document.querySelector(\`.field-checkbox[data-field="\${field}"]\`);
            const subjectCheckboxes = document.querySelectorAll(\`.subject-checkbox[data-field="\${field}"]\`);
            const allChecked = Array.from(subjectCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(subjectCheckboxes).some(cb => cb.checked);

            if (allChecked) {
              fieldCheckbox.checked = true;
              fieldCheckbox.indeterminate = false;
            } else if (someChecked) {
              fieldCheckbox.checked = false;
              fieldCheckbox.indeterminate = true;
            } else {
              fieldCheckbox.checked = false;
              fieldCheckbox.indeterminate = false;
            }
          });

          updateSeriesAllCheckbox();
        }

        // ì‹œë¦¬ì¦ˆ ì „ì²´ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSeriesAllCheckbox() {
          const seriesAllCheckbox = document.getElementById('series-all');
          const allSubjectCheckboxes = document.querySelectorAll('.subject-checkbox');
          const allChecked = Array.from(allSubjectCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(allSubjectCheckboxes).some(cb => cb.checked);

          if (allChecked) {
            seriesAllCheckbox.checked = true;
            seriesAllCheckbox.indeterminate = false;
          } else if (someChecked) {
            seriesAllCheckbox.checked = false;
            seriesAllCheckbox.indeterminate = true;
          } else {
            seriesAllCheckbox.checked = false;
            seriesAllCheckbox.indeterminate = false;
          }
        }

        // ìš”ì¼ ì „ì²´ ì„ íƒ ì²˜ë¦¬
        function handleDayAllChange(checkbox) {
          const dayCheckboxes = document.querySelectorAll('.day-checkbox');
          if (checkbox.checked) {
            dayCheckboxes.forEach(cb => {
              cb.checked = false;
              cb.disabled = true;
            });
          } else {
            dayCheckboxes.forEach(cb => {
              cb.disabled = false;
            });
          }
        }

        // ê°œë³„ ìš”ì¼ ì„ íƒ ì²˜ë¦¬
        function handleDayChange() {
          const dayAllCheckbox = document.getElementById('day-all');
          const dayCheckboxes = document.querySelectorAll('.day-checkbox');
          const anyDayChecked = Array.from(dayCheckboxes).some(cb => cb.checked);

          if (anyDayChecked) {
            dayAllCheckbox.checked = false;
          }
        }

        // ìë™ ê³¼ì œ ìŠ¤ì¼€ì¤„ ì œì¶œ
        async function submitAutoTaskSchedule() {
          try {
            // ì„ íƒëœ í•™ìƒ ìˆ˜ì§‘ (grade + name)
            const checkedRows = document.querySelectorAll('tbody input[type="checkbox"]:checked');
            const studentIds = Array.from(checkedRows).map(cb => ({
              grade: cb.dataset.grade,
              name: cb.dataset.name
            }));

            // ì„ íƒëœ ê³¼ëª© ìˆ˜ì§‘
            const selectedSubjects = [];
            document.querySelectorAll('.subject-checkbox:checked').forEach(cb => {
              selectedSubjects.push(cb.value);
            });

            if (selectedSubjects.length === 0) {
              alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            // ì„ íƒëœ ìš”ì¼ ìˆ˜ì§‘
            const selectedDays = [];
            const dayAll = document.getElementById('day-all').checked;
            if (dayAll) {
              selectedDays.push(...['0', '1', '2', '3', '4', '5', '6']);
            } else {
              document.querySelectorAll('.day-checkbox:checked').forEach(cb => {
                selectedDays.push(cb.value);
              });
            }

            if (selectedDays.length === 0) {
              alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            // ê³¼ì œ ê°œìˆ˜
            const taskCount = parseInt(document.getElementById('taskCount').value);
            if (taskCount < 1 || taskCount > 5) {
              alert("ê³¼ì œ ê°œìˆ˜ëŠ” 1~5ê°œ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
              return;
            }

            // API í˜¸ì¶œ
            const response = await fetch('/api/auto-task-schedule', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                studentIds,
                subjects: selectedSubjects,
                days: selectedDays,
                taskCount
              })
            });

            const result = await response.json();

            if (result.success) {
              alert(\`âœ… ìë™ ê³¼ì œ ìŠ¤ì¼€ì¤„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\\nëŒ€ìƒ í•™ìƒ: \${studentIds.length}ëª…\`);
              closeAutoTaskModal();
              location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìŠ¤ì¼€ì¤„ ëª©ë¡ ì—…ë°ì´íŠ¸
            } else {
              alert(\`âŒ ìŠ¤ì¼€ì¤„ ë“±ë¡ ì‹¤íŒ¨: \${result.message}\`);
            }
          } catch (err) {
            console.error("ìŠ¤ì¼€ì¤„ ë“±ë¡ ì—ëŸ¬:", err);
            alert("âŒ ìŠ¤ì¼€ì¤„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        }
      </script>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /admin/users ì—ëŸ¬:", err);
    res.status(500).send("íšŒì› ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});


// ===== íšŒì› ëª©ë¡ ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ =====
app.get("/admin/users-export", async (req, res) => {
  const { key, q, sort } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  try {
    const filter = { deleted: { $ne: true } };

    if (q && q.trim() !== "") {
      const keyword = q.trim();
      const regex = new RegExp(keyword, "i");
      filter.$or = [
        { name: regex },
        { phone: regex },
        { id: regex },
        { school: regex },
        { grade: regex },
      ];
    }

    let sortOption = { lastLogin: -1, name: 1 };
    switch (sort) {
      case "lastLoginAsc":
        sortOption = { lastLogin: 1, name: 1 };
        break;
      case "gradeAsc":
        sortOption = { grade: 1, name: 1 };
        break;
      case "gradeDesc":
        sortOption = { grade: -1, name: 1 };
        break;
      case "nameAsc":
        sortOption = { name: 1 };
        break;
      case "nameDesc":
        sortOption = { name: -1 };
        break;
      default:
        sortOption = { lastLogin: -1, name: 1 };
    }

    const users = await User.find(filter).sort(sortOption).lean();

    const escape = (v = "") => `"${String(v).replace(/"/g, '""')}"`;

    const lines = [];
    // í—¤ë”
    lines.push(
      [
        "ë²ˆí˜¸",
        "í•™ë…„",
        "í•™êµ",
        "ì´ë¦„",
        "í•™ë…„ë°˜ë²ˆí˜¸(ID)",
        "ìƒíƒœ",
        "ë§ˆì§€ë§‰ ë¡œê·¸ì¸",
      ]
        .map(escape)
        .join(",")
    );

    users.forEach((u, idx) => {
      const last = u.lastLogin
        ? new Date(u.lastLogin).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          })
        : "";
      const idOrPhone = u.id || u.phone || "";
      const status = u.status || "approved";
      const statusLabel = status === "approved" ? "ìŠ¹ì¸" : "ëŒ€ê¸°";

      lines.push(
        [
          idx + 1,
          u.grade || "",
          u.school || "",
          u.name || "",
          idOrPhone,
          statusLabel,
          last,
        ]
          .map(escape)
          .join(",")
      );
    });

    const csvBody = lines.join("\r\n");
    const bom = "\uFEFF";

    res.setHeader("Content-Type", "text/csv; charset=utf-8");
    res.setHeader(
      "Content-Disposition",
      `attachment; filename="dandan_users_${new Date()
        .toISOString()
        .slice(0, 10)}.csv"`
    );

    res.send(bom + csvBody);
  } catch (err) {
    console.error("âŒ /admin/users-export ì—ëŸ¬:", err);
    res.status(500).send("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ===== world2_XX/people2_XX â†’ world_4X/people_4X ë§ˆì´ê·¸ë ˆì´ì…˜ API =====
// ê¸°ì¡´ world2_01~40, people2_01~40 ë ˆì½”ë“œë¥¼ world_41~80, people_41~80ìœ¼ë¡œ ë³€í™˜ (ì¤‘ë³µ ì œê±°)
app.post("/api/migrate-legacy-units", async (req, res) => {
  try {
    console.log("ğŸ”„ world2_XX/people2_XX ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...");

    let totalConverted = 0;
    let totalDeleted = 0;
    let totalSkipped = 0;
    const results = { world2: { found: 0, converted: 0, deleted: 0 }, people2: { found: 0, converted: 0, deleted: 0 } };

    // 1. world2_XX ì²˜ë¦¬
    const world2Logs = await LearningLog.find({ unit: /^world2_/ });
    results.world2.found = world2Logs.length;
    console.log(`ğŸ“‹ world2_XX ë ˆì½”ë“œ ${world2Logs.length}ê°œ ë°œê²¬`);

    for (const log of world2Logs) {
      const match = log.unit.match(/^world2_(\d+)$/);
      if (!match) continue;

      const num = parseInt(match[1], 10);
      const newUnit = `world_${num + 40}`;

      const existingLog = await LearningLog.findOne({
        grade: log.grade, name: log.name, unit: newUnit
      });

      if (existingLog) {
        await LearningLog.deleteOne({ _id: log._id });
        results.world2.deleted++;
        totalDeleted++;
      } else {
        log.unit = newUnit;
        await log.save();
        results.world2.converted++;
        totalConverted++;
      }
    }

    // 2. people2_XX ì²˜ë¦¬
    const people2Logs = await LearningLog.find({ unit: /^people2_/ });
    results.people2.found = people2Logs.length;
    console.log(`ğŸ“‹ people2_XX ë ˆì½”ë“œ ${people2Logs.length}ê°œ ë°œê²¬`);

    for (const log of people2Logs) {
      const match = log.unit.match(/^people2_(\d+)$/);
      if (!match) continue;

      const num = parseInt(match[1], 10);
      const newUnit = `people_${num + 40}`;

      const existingLog = await LearningLog.findOne({
        grade: log.grade, name: log.name, unit: newUnit
      });

      if (existingLog) {
        await LearningLog.deleteOne({ _id: log._id });
        results.people2.deleted++;
        totalDeleted++;
      } else {
        log.unit = newUnit;
        await log.save();
        results.people2.converted++;
        totalConverted++;
      }
    }

    console.log(`ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ë³€í™˜ ${totalConverted}ê°œ, ì‚­ì œ ${totalDeleted}ê°œ`);
    res.json({ ok: true, message: "ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ", results });
  } catch (err) {
    console.error("âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ===== world_41~80 ë° world1_41~80 â†’ world2_01~40 ë§ˆì´ê·¸ë ˆì´ì…˜ API =====
// ê¸°ì¡´ world_41~80 ë˜ëŠ” world1_41~80 ë ˆì½”ë“œë¥¼ world2_01~40ìœ¼ë¡œ ë³€í™˜ ë˜ëŠ” ì‚­ì œ
app.post("/api/migrate-world1-to-world2", async (req, res) => {
  try {
    console.log("ğŸ”„ world_41~80 / world1_41~80 â†’ world2_01~40 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...");

    let converted = 0;
    let deleted = 0;

    // world_41~80 ë˜ëŠ” world1_41~80 ì°¾ê¸° (world_XX ë˜ëŠ” world1_XX í˜•ì‹ ëª¨ë‘ ì²˜ë¦¬)
    const worldLogs = await LearningLog.find({
      unit: { $regex: /^world1?_(4[1-9]|[5-7][0-9]|80)$/ }
    });

    console.log(`ğŸ“‹ world_41~80 / world1_41~80 ë ˆì½”ë“œ ${worldLogs.length}ê°œ ë°œê²¬`);

    for (const log of worldLogs) {
      // world_41 ë˜ëŠ” world1_41 í˜•ì‹ ëª¨ë‘ ë§¤ì¹­
      const match = log.unit.match(/^world1?_(\d+)$/);
      if (!match) continue;

      const num = parseInt(match[1], 10);
      if (num < 41 || num > 80) continue;

      // world_41 â†’ world2_01, world1_42 â†’ world2_02, ...
      const newNum = num - 40;
      const newUnit = `world2_${String(newNum).padStart(2, '0')}`;

      // ì´ë¯¸ world2_XXë¡œ ê°™ì€ ì‚¬ìš©ì ë ˆì½”ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
      const existingLog = await LearningLog.findOne({
        grade: log.grade, name: log.name, unit: newUnit
      });

      if (existingLog) {
        // ì¤‘ë³µì´ë©´ ì‚­ì œ
        await LearningLog.deleteOne({ _id: log._id });
        deleted++;
        console.log(`  ğŸ—‘ï¸ ì‚­ì œ (ì¤‘ë³µ): ${log.unit} â†’ ${newUnit} (${log.name})`);
      } else {
        // ë³€í™˜
        log.unit = newUnit;
        await log.save();
        converted++;
        console.log(`  âœ… ë³€í™˜: ${log.unit} â†’ ${newUnit} (${log.name})`);
      }
    }

    console.log(`ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ë³€í™˜ ${converted}ê°œ, ì‚­ì œ ${deleted}ê°œ`);
    res.json({
      ok: true,
      message: `world_41~80 / world1_41~80 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ`,
      found: worldLogs.length,
      converted,
      deleted
    });
  } catch (err) {
    console.error("âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ===== world_41~80 / world1_41~80 ì™„ì „ ì‚­ì œ API =====
app.post("/api/delete-world-41-80", async (req, res) => {
  try {
    console.log("ğŸ—‘ï¸ world_41~80 / world1_41~80 ì‚­ì œ ì‹œì‘...");
    const result = await LearningLog.deleteMany({
      unit: { $regex: /^world1?_(4[1-9]|[5-7][0-9]|80)$/ }
    });
    console.log(`âœ… world_41~80 ë ˆì½”ë“œ ${result.deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ`);
    res.json({ ok: true, deletedCount: result.deletedCount });
  } catch (err) {
    console.error("âŒ ì‚­ì œ ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ===== people ê´€ë ¨ ë°ì´í„° ì „ì²´ ì‚­ì œ API =====
// people_XX, people2_XX, person_XX ë“± ì¸ë¬¼ ê´€ë ¨ ëª¨ë“  ë ˆì½”ë“œ ì‚­ì œ
app.post("/api/delete-all-people-data", async (req, res) => {
  try {
    console.log("ğŸ—‘ï¸ people ê´€ë ¨ ë°ì´í„° ì „ì²´ ì‚­ì œ ì‹œì‘...");

    // peopleë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  unit ì‚­ì œ (people_, people2_, person_, person2_ ë“±)
    const result = await LearningLog.deleteMany({
      unit: { $regex: /^(people|person)/ }
    });

    console.log(`âœ… people ê´€ë ¨ ë°ì´í„° ${result.deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ`);
    res.json({ ok: true, message: `${result.deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ`, deletedCount: result.deletedCount });
  } catch (err) {
    console.error("âŒ ì‚­ì œ ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ===== world2_XX â†’ world_4X ë§ˆì´ê·¸ë ˆì´ì…˜ API (ë ˆê±°ì‹œ) =====
// ê¸°ì¡´ world2_01~40 ë ˆì½”ë“œë¥¼ world_41~80ìœ¼ë¡œ ë³€í™˜ (ì¤‘ë³µ ì œê±°)
app.post("/api/migrate-world2", async (req, res) => {
  try {
    console.log("ğŸ”„ world2_XX â†’ world_4X ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...");

    // 1. world2_XX í˜•ì‹ì˜ ëª¨ë“  ë ˆì½”ë“œ ì°¾ê¸°
    const world2Logs = await LearningLog.find({ unit: /^world2_/ });
    console.log(`ğŸ“‹ world2_XX ë ˆì½”ë“œ ${world2Logs.length}ê°œ ë°œê²¬`);

    let converted = 0;
    let deleted = 0;
    let skipped = 0;

    for (const log of world2Logs) {
      const match = log.unit.match(/^world2_(\d+)$/);
      if (!match) {
        skipped++;
        continue;
      }

      const num = parseInt(match[1], 10);
      const newUnit = `world_${num + 40}`;  // world2_01 â†’ world_41

      // ê°™ì€ ì‚¬ìš©ì, ê°™ì€ ë‹¨ì›(ë³€í™˜ëœ)ì˜ ê¸°ì¡´ ë ˆì½”ë“œ í™•ì¸
      const existingLog = await LearningLog.findOne({
        grade: log.grade,
        name: log.name,
        unit: newUnit
      });

      if (existingLog) {
        // ì´ë¯¸ world_4X ë ˆì½”ë“œê°€ ìˆìœ¼ë©´ world2_XX ë ˆì½”ë“œ ì‚­ì œ
        await LearningLog.deleteOne({ _id: log._id });
        deleted++;
        console.log(`ğŸ—‘ï¸ ì‚­ì œ: ${log.name} - ${log.unit} (ì´ë¯¸ ${newUnit} ì¡´ì¬)`);
      } else {
        // world_4X ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ë³€í™˜
        log.unit = newUnit;
        await log.save();
        converted++;
        console.log(`âœ… ë³€í™˜: ${log.name} - world2_${String(num).padStart(2, '0')} â†’ ${newUnit}`);
      }
    }

    console.log(`ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ë³€í™˜ ${converted}ê°œ, ì‚­ì œ ${deleted}ê°œ, ìŠ¤í‚µ ${skipped}ê°œ`);

    res.json({
      ok: true,
      message: `ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ`,
      stats: { found: world2Logs.length, converted, deleted, skipped }
    });
  } catch (err) {
    console.error("âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì—ëŸ¬:", err);
    res.status(500).json({ ok: false, message: err.message });
  }
});

// ===== í•™ìŠµ ì´ë ¥ ë¡œê·¸ ì €ì¥ API =====
app.post("/api/log", async (req, res) => {
  try {
    const { grade, name, school, series, unit, radar, completed } = req.body;

    console.log("[/api/log] ë°›ì€ ë°ì´í„°:", { grade, name, school, series, unit, completed });

    if (!grade || !name || !unit) {
      return res.status(400).json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ ë¶€ì¡±" });
    }

    // ğŸ‹ ìµœì´ˆ í•™ìŠµ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ (ë°°ì§€ ì§€ê¸‰ìš©)
    const existingLog = await LearningLog.findOne({ grade, name, unit });
    const isFirstCompletion = !existingLog && completed === true;

    const logData = {
      grade,
      name,
      school: school || "",
      series: series || "",
      unit,
      radar: radar || undefined,
      completed: completed === true,  // ëª…ì‹œì ìœ¼ë¡œ trueì¸ì§€ í™•ì¸
      timestamp: new Date(),  // í•™ìŠµí•  ë•Œë§ˆë‹¤ ì‹œê°„ ê°±ì‹  (ìµœì¢… í•™ìŠµ ì‹œê°„)
    };

    console.log("[/api/log] ì €ì¥í•  ë°ì´í„°:", logData);

    // ì¤‘ë³µ ë°©ì§€: ê°™ì€ í•™ìƒ+ë‹¨ì›ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒì„±
    const savedLog = await LearningLog.findOneAndUpdate(
      { grade, name, unit },  // ê²€ìƒ‰ ì¡°ê±´
      logData,                // ì—…ë°ì´íŠ¸í•  ë°ì´í„°
      {
        new: true,            // ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ ë°˜í™˜
        upsert: true,         // ì—†ìœ¼ë©´ ìƒì„±
        setDefaultsOnInsert: true
      }
    );
    console.log("[/api/log] ì €ì¥ ì™„ë£Œ:", savedLog._id, "completed:", savedLog.completed);

    // ğŸ‹ ìµœì´ˆ í•™ìŠµ ì™„ë£Œ ì‹œ ê³ ë˜ ë°°ì§€ 10ê°œ ì§€ê¸‰
    let badgesAwarded = 0;
    if (isFirstCompletion) {
      try {
        const badgeResult = await UserProgress.findOneAndUpdate(
          { grade, name },
          {
            $inc: { 'vocabularyQuiz.totalCoins': 10 },
            $set: { 'vocabularyQuiz.lastRankUpdate': new Date() }
          },
          { upsert: true, new: true }
        );
        badgesAwarded = 10;
        console.log(`ğŸ‹ [/api/log] ìµœì´ˆ í•™ìŠµ ì™„ë£Œ! ê³ ë˜ ë°°ì§€ 10ê°œ ì§€ê¸‰: ${grade} ${name} (ë‹¨ì›: ${unit})`);
        console.log(`ğŸ‹ [/api/log] í˜„ì¬ ì´ ë°°ì§€: ${badgeResult.vocabularyQuiz?.totalCoins || 10}ê°œ`);
      } catch (badgeErr) {
        console.error("âš ï¸ [/api/log] ê³ ë˜ ë°°ì§€ ì§€ê¸‰ ì‹¤íŒ¨:", badgeErr.message);
      }
    }

    // ğŸ”¥ unit-grades ìºì‹œ ì‚­ì œ (í•™ìŠµ ì™„ë£Œ ì‹œ ë“±ê¸‰ ë°ì´í„° ê°±ì‹  í•„ìš”)
    const cacheKey = getCacheKey('unit-grades', { grade, name });
    cache.delete(cacheKey);
    console.log("ğŸ—‘ï¸ [/api/log] unit-grades ìºì‹œ ì‚­ì œ:", cacheKey);

    // ğŸ”¥ í•™ìŠµ ê¸°ë¡ ìºì‹œë„ ì‚­ì œ (í•™ìŠµ ì™„ë£Œ ì‹œ ê¸°ë¡ ê°±ì‹  í•„ìš”)
    // phone íŒŒë¼ë¯¸í„° ìœ ë¬´ì— ë”°ë¼ ìºì‹œ í‚¤ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  learning-logs ìºì‹œ ì‚­ì œ
    const logsCachePrefix = `learning-logs:{"grade":"${grade}","name":"${name}"`;
    for (const key of cache.keys()) {
      if (key.startsWith(logsCachePrefix)) {
        cache.delete(key);
        console.log("ğŸ—‘ï¸ [/api/log] learning-logs ìºì‹œ ì‚­ì œ:", key);
      }
    }

    // ğŸ”¥ completion-status ìºì‹œ ì‚­ì œ (í•™ìŠµ ì™„ë£Œ ì‹œ ì™„ë£Œ ìƒíƒœ ê°±ì‹  í•„ìš”)
    const completionCachePrefix = `completion-status:{"grade":"${grade}","name":"${name}"`;
    for (const key of cache.keys()) {
      if (key.startsWith(completionCachePrefix)) {
        cache.delete(key);
        console.log("ğŸ—‘ï¸ [/api/log] completion-status ìºì‹œ ì‚­ì œ:", key);
      }
    }

    // ğŸ”¥ AI ì¶”ì²œ ê³¼ì œì˜ statusë¥¼ 'completed'ë¡œ ì—…ë°ì´íŠ¸ (ë³µìŠµì™„ë£Œ ì²˜ë¦¬)
    if (completed === true && unit) {
      try {
        const userProgress = await UserProgress.findOne({ grade, name });
        if (userProgress && userProgress.studyRoom && userProgress.studyRoom.assignedTasks) {
          let taskUpdated = false;
          const aiReviewTime = new Date();

          // êµ¬ í˜•ì‹ IDë¥¼ ìƒˆ í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
          // world_41~80 â†’ world2_01~40, world_1~40 â†’ world1_01~40
          // people_41~80 â†’ people2_01~40, people_1~40 â†’ people1_01~40
          const normalizeUnitId = (id) => {
            if (!id) return id;
            const legacyMatch = id.match(/^(world|people)_(\d+)$/i);
            if (legacyMatch) {
              const oldPrefix = legacyMatch[1].toLowerCase();
              const num = parseInt(legacyMatch[2], 10);
              // 41~80ì€ world2/people2ì˜ 01~40ìœ¼ë¡œ ë³€í™˜
              if (num >= 41 && num <= 80) {
                const newNum = (num - 40).toString().padStart(2, '0');
                return `${oldPrefix}2_${newNum}`;
              }
              // 1~40ì€ world1/people1ì˜ 01~40ìœ¼ë¡œ ë³€í™˜
              const paddedNum = num.toString().padStart(2, '0');
              return `${oldPrefix}1_${paddedNum}`;
            }
            return id;
          };

          const normalizedUnit = normalizeUnitId(unit);

          userProgress.studyRoom.assignedTasks.forEach(task => {
            // AI ê³¼ì œì´ê³ , id ë˜ëŠ” unitIdê°€ ì¼ì¹˜í•˜ë©´ ì™„ë£Œ ì²˜ë¦¬ (ì •ê·œí™” í›„ ë¹„êµ)
            const normalizedTaskId = normalizeUnitId(task.id);
            const normalizedTaskUnitId = normalizeUnitId(task.unitId);
            if (task.isAI && (normalizedTaskId === normalizedUnit || normalizedTaskUnitId === normalizedUnit)) {
              task.status = 'completed';
              task.completedAt = aiReviewTime;
              taskUpdated = true;
              console.log(`âœ… [/api/log] AI ê³¼ì œ ì™„ë£Œ ì²˜ë¦¬: ${unit} (ì›ë³¸ task.id: ${task.id})`);
            }
          });
          if (taskUpdated) {
            await userProgress.save();
            console.log(`ğŸ’¾ [/api/log] UserProgress ì €ì¥ ì™„ë£Œ`);

            // ğŸ”¥ LearningLogì—ë„ aiReviewCompletedAt ì €ì¥ (ê³¼ì œ ì‚­ì œí•´ë„ ìœ ì§€ë¨)
            await LearningLog.updateOne(
              { grade, name, unit },
              { $set: { aiReviewCompletedAt: aiReviewTime } }
            );
            console.log(`ğŸ’¾ [/api/log] LearningLogì— aiReviewCompletedAt ì €ì¥: ${unit}`);
          }
        }
      } catch (aiTaskErr) {
        console.warn("âš ï¸ [/api/log] AI ê³¼ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", aiTaskErr.message);
        // AI ê³¼ì œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ í•™ìŠµ ë¡œê·¸ëŠ” ì •ìƒ ì €ì¥ë¨
      }
    }

    // ğŸ‹ ì‘ë‹µì— ìµœì´ˆ ì™„ë£Œ ì—¬ë¶€ì™€ ë°°ì§€ ì§€ê¸‰ ì •ë³´ í¬í•¨
    return res.json({
      ok: true,
      firstCompletion: isFirstCompletion,
      badgesAwarded: badgesAwarded
    });
  } catch (err) {
    console.error("[/api/log] error:", err);
    res.status(500).json({ ok: false });
  }
});

// ===== ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ API (ì‹œë¦¬ì¦ˆ ë¶€ì—¬ ì •ë³´ ì—…ë°ì´íŠ¸ìš©) =====
app.get("/api/user-info", async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({ error: "grade and name are required" });
    }

    const user = await User.findOne({ grade, name, deleted: { $ne: true } });

    if (!user) {
      return res.status(404).json({ error: "User not found" });
    }

    // í•„ìš”í•œ ì •ë³´ë§Œ ë°˜í™˜
    res.json({
      _id: user._id,
      grade: user.grade,
      name: user.name,
      school: user.school,
      assignedSeries: user.assignedSeries || []
    });
  } catch (err) {
    console.error("Error fetching user info:", err);
    res.status(500).json({ error: "Internal server error" });
  }
});

// ===== í•™ìŠµ ì™„ë£Œ ìƒíƒœ ì¡°íšŒ API (ë™ì‹œ ìš”ì²­ ë³‘í•©) =====
// ë™ì‹œì— ê°™ì€ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ í•˜ë‚˜ì˜ DB ì¿¼ë¦¬ë§Œ ì‹¤í–‰í•˜ê³  ê²°ê³¼ ê³µìœ 
const pendingCompletionRequests = new Map();

app.get("/api/completion-status", async (req, res) => {
  try {
    const { grade, name, series } = req.query;

    if (!grade || !name || !series) {
      return res.status(400).json({ ok: false, message: "í•„ìˆ˜ íŒŒë¼ë¯¸í„° ë¶€ì¡± (grade, name, series)" });
    }

    // ìºì‹œ í‚¤ ìƒì„± ë° í™•ì¸
    const cacheKey = getCacheKey('completion-status', { grade, name, series });
    const cached = getCache(cacheKey);
    if (cached) {
      return res.json(cached);
    }

    // âœ… ë™ì‹œ ìš”ì²­ ë³‘í•©: ì´ë¯¸ ê°™ì€ ìš”ì²­ì´ ì§„í–‰ ì¤‘ì´ë©´ ê·¸ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¼
    if (pendingCompletionRequests.has(cacheKey)) {
      console.log("â³ [/api/completion-status] ë™ì‹œ ìš”ì²­ ë³‘í•© - ê¸°ì¡´ ìš”ì²­ ëŒ€ê¸°:", cacheKey);
      const result = await pendingCompletionRequests.get(cacheKey);
      return res.json(result);
    }

    // ìƒˆë¡œìš´ ìš”ì²­ ì‹œì‘ - Promise ì €ì¥
    console.log("[/api/completion-status] ì¡°íšŒ ìš”ì²­:", { grade, name, series });
    const queryPromise = (async () => {
      // í•´ë‹¹ í•™ìƒì˜ ì™„ë£Œëœ ë‹¨ì› ëª©ë¡ ì¡°íšŒ
      const completedLogs = await LearningLog.find({
        grade,
        name,
        series,
        completed: true
      }).select('unit').lean();

      // ì™„ë£Œëœ ë‹¨ì› ì½”ë“œ ë°°ì—´
      const completedUnits = completedLogs.map(log => log.unit);
      const result = { ok: true, completedUnits };

      // ìºì‹œì— ì €ì¥
      setCache(cacheKey, result);

      return result;
    })();

    // ì§„í–‰ ì¤‘ì¸ ìš”ì²­ìœ¼ë¡œ ë“±ë¡
    pendingCompletionRequests.set(cacheKey, queryPromise);

    try {
      const result = await queryPromise;
      return res.json(result);
    } finally {
      // ìš”ì²­ ì™„ë£Œ í›„ ëª©ë¡ì—ì„œ ì œê±°
      pendingCompletionRequests.delete(cacheKey);
    }
  } catch (err) {
    console.error("[/api/completion-status] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜" });
  }
});

// ===== í•™ìŠµ ì´ë ¥ ë³´ê¸° (ìŠˆí¼ê´€ë¦¬ì ì „ìš©) - HTML íŒŒì¼ ì„œë¹™ =====
app.get("/admin/logs", (req, res) => {
  const { key } = req.query;

  console.log("âœ… [GET] /admin/logs -> public/admin_logs.html");

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  res.sendFile(path.join(__dirname, "public/admin_logs.html"));
});

// ===== í•™ìŠµ ì´ë ¥ API (ìŠˆí¼ê´€ë¦¬ì ì „ìš©) =====
app.get("/api/admin/logs", async (req, res) => {
  const { key, grade, name } = req.query;

  console.log("[/api/admin/logs] ìš”ì²­ íŒŒë¼ë¯¸í„°:", { grade, name });

  if (key !== ADMIN_KEY) {
    return res.status(403).json({ ok: false, message: "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)" });
  }

  if (!grade || !name) {
    return res.status(400).json({ ok: false, message: "grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
  }

  try {
    const logs = await LearningLog.find({ grade, name, deleted: { $ne: true } })
      .sort({ timestamp: -1 })
      .lean();

    console.log("[/api/admin/logs] ì¡°íšŒ ê²°ê³¼:", logs.length, "ê°œ ê¸°ë¡ ì°¾ìŒ");

    // UserProgressì—ì„œ AI ê³¼ì œ ë³µìŠµ ì™„ë£Œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const userProgress = await UserProgress.findOne({ grade, name });
    const aiTaskMap = new Map();

    if (userProgress && userProgress.studyRoom && userProgress.studyRoom.assignedTasks) {
      userProgress.studyRoom.assignedTasks.forEach(task => {
        if (task.isAI && task.completedAt) {
          aiTaskMap.set(task.id, task.completedAt);
        }
      });
    }

    // ê° í•™ìŠµ ê¸°ë¡ì— AI ë³µìŠµ ì™„ë£Œ ì‹œê°„ ì¶”ê°€
    logs.forEach(log => {
      log.aiReviewCompletedAt = aiTaskMap.get(log.unit) || null;
    });

    res.json({ ok: true, logs });
  } catch (err) {
    console.error("[/api/admin/logs] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "í•™ìŠµ ì´ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== ê¸°ì¡´ ì¸ë¼ì¸ HTML ë Œë”ë§ ì½”ë“œ (ì‚­ì œë¨, ìœ„ì˜ íŒŒì¼ ì„œë¹™ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´) =====
app.get("/admin/logs-old-inline", async (req, res) => {
  const { key, grade, name } = req.query;

  console.log("[/admin/logs-old-inline] ìš”ì²­ íŒŒë¼ë¯¸í„°:", { grade, name });

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  if (!grade || !name) {
    return res.status(400).send("grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  try {
    const logs = await LearningLog.find({ grade, name, deleted: { $ne: true } })
      .sort({ timestamp: -1 })
      .lean();

    console.log("[/admin/logs-old-inline] ì¡°íšŒ ê²°ê³¼:", logs.length, "ê°œ ê¸°ë¡ ì°¾ìŒ");

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>í•™ìŠµ ì´ë ¥ - ${grade} ${name}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif;
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          min-height: 100vh;
          padding: 40px 20px;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          background: #ffffff;
          border-radius: 24px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
          padding: 50px;
        }

        .header {
          text-align: center;
          margin-bottom: 50px;
          padding-bottom: 30px;
          border-bottom: 3px solid #e5d4c1;
        }

        h1 {
          font-size: 42px;
          font-weight: 800;
          color: #2c3e50;
          margin-bottom: 15px;
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .subtitle {
          font-size: 16px;
          color: #7f8c8d;
          font-weight: 500;
        }

        .nav-buttons {
          display: flex;
          gap: 15px;
          justify-content: center;
          margin-top: 20px;
        }

        .btn {
          display: inline-block;
          padding: 12px 28px;
          border-radius: 50px;
          font-size: 14px;
          font-weight: 600;
          text-decoration: none;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-back {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
        }

        .btn-back:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-download {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: white;
        }

        .btn-download:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-trash {
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
          color: white;
        }

        .btn-trash:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .stats-badge {
          display: inline-block;
          background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
          color: #2d3436;
          padding: 8px 20px;
          border-radius: 50px;
          font-size: 14px;
          font-weight: 700;
          margin-bottom: 30px;
          box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
        }

        .section-title {
          font-size: 28px;
          font-weight: 700;
          color: #2c3e50;
          margin: 50px 0 20px 0;
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .section-description {
          font-size: 14px;
          color: #7f8c8d;
          margin-bottom: 30px;
          line-height: 1.6;
        }

        .table-container {
          background: #ffffff;
          border-radius: 16px;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          margin-bottom: 50px;
        }

        table {
          border-collapse: collapse;
          width: 100%;
        }

        th, td {
          padding: 16px 20px;
          font-size: 15px;
          text-align: left;
        }

        th {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          font-size: 13px;
        }

        td {
          border-bottom: 1px solid #ecf0f1;
          color: #2c3e50;
        }

        tr:hover td {
          background: #f8f9fa;
        }

        tr:last-child td {
          border-bottom: none;
        }

        hr {
          margin: 60px 0;
          border: none;
          border-top: 2px solid #e5d4c1;
        }

        #summary-radar-wrap {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
          margin-top: 30px;
          justify-content: center;
        }

        #radar-wrap {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
          margin-top: 30px;
          justify-content: center;
        }

        .radar-card {
          flex: 0 0 320px;
          border: 2px solid #e5d4c1;
          border-radius: 20px;
          padding: 24px;
          background: linear-gradient(135deg, #ffffff 0%, #fffaf3 100%);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        /* ê³¼ëª©ë³„ ì¢…í•© ë ˆì´ë”: í•œ ì¤„ì— 4ê°œ */
        #summary-radar-wrap .radar-card {
          flex: 0 0 195px;
          padding: 10px;
        }

        #summary-radar-wrap .radar-card canvas {
          width: 140px !important;
          height: 140px !important;
        }

        #summary-radar-wrap .radar-card-title {
          font-size: 12px;
        }

        #summary-radar-wrap .radar-stats {
          font-size: 10px;
        }

        #summary-radar-wrap .radar-card-header {
          margin-bottom: 8px;
        }

        /* ë‹¨ì›ë³„ ë¬¸í•´ë ¥ ë ˆì´ë”: í•œ ì¤„ì— 5ê°œ */
        #radar-wrap .radar-card {
          flex: 0 0 155px;
          padding: 8px;
        }

        #radar-wrap .radar-card canvas {
          width: 110px !important;
          height: 110px !important;
        }

        #radar-wrap .radar-card-title {
          font-size: 11px;
        }

        #radar-wrap .radar-stats {
          font-size: 9px;
        }

        #radar-wrap .radar-card-header {
          margin-bottom: 6px;
        }

        .radar-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .radar-card:hover {
          transform: translateY(-8px);
          box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
          border-color: #d4b89c;
        }

        .radar-card-header {
          margin-bottom: 20px;
          text-align: center;
          position: relative;
        }

        .delete-btn {
          position: absolute;
          top: -10px;
          right: -10px;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
          color: white;
          border: 2px solid white;
          cursor: pointer;
          font-size: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 10px rgba(238, 90, 111, 0.4);
          transition: all 0.3s ease;
          z-index: 10;
        }

        .delete-btn:hover {
          transform: scale(1.1);
          background: linear-gradient(135deg, #ee5a6f 0%, #ff4757 100%);
          box-shadow: 0 6px 15px rgba(238, 90, 111, 0.6);
        }

        .table-delete-btn {
          padding: 6px 12px;
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
          font-weight: 600;
          transition: all 0.3s ease;
          box-shadow: 0 2px 6px rgba(238, 90, 111, 0.3);
        }

        .table-delete-btn:hover {
          background: linear-gradient(135deg, #ee5a6f 0%, #ff4757 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 10px rgba(238, 90, 111, 0.5);
        }

        .radar-card-title {
          display: block;
          font-size: 18px;
          font-weight: 700;
          color: #2c3e50;
          margin-bottom: 10px;
          line-height: 1.4;
        }

        .radar-card-time {
          color: #95a5a6;
          font-size: 12px;
          font-weight: 500;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
        }

        .radar-card-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 20px;
          padding-top: 20px;
          border-top: 2px solid #f0f0f0;
          gap: 10px;
        }

        .stat-item {
          text-align: center;
          flex: 1;
        }

        .stat-label {
          font-size: 11px;
          color: #95a5a6;
          font-weight: 600;
          margin-bottom: 6px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .stat-value {
          font-size: 20px;
          font-weight: 800;
          color: #495057;
        }

        .score-badge {
          display: inline-block;
          padding: 6px 16px;
          border-radius: 50px;
          font-size: 12px;
          font-weight: 700;
          margin-top: 10px;
        }

        .badge-excellent {
          background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
          color: #2d3436;
        }

        .badge-good {
          background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
          color: #2d3436;
        }

        .badge-normal {
          background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
          color: #2d3436;
        }

        /* ì¢…í•© ë ˆì´ë” ì¹´ë“œ - ë¶‰ì€ ê³„ì—´ */
        .radar-card.summary-card::before {
          background: linear-gradient(90deg, #f093fb 0%, #f5576c 50%, #e74c3c 100%) !important;
        }

        .radar-card.summary-card {
          border-color: #f5c6cb;
        }

        .radar-card.summary-card:hover {
          border-color: #f5576c;
        }

        .radar-card.summary-card .stat-value {
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
          -webkit-background-clip: text !important;
          -webkit-text-fill-color: transparent !important;
          background-clip: text !important;
        }

        /* ë”ë³´ê¸° ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
        .hidden-row {
          display: none;
        }

        .hidden-card {
          display: none !important;
        }

        .toggle-btn {
          display: block;
          margin: 20px auto;
          padding: 12px 32px;
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
          border: none;
          border-radius: 25px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .toggle-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .toggle-btn:active {
          transform: translateY(0);
        }

        /* ì¤‘ì•™ ì•¡ì…˜ ë²„íŠ¼ */
        .action-buttons {
          display: flex;
          gap: 15px;
          justify-content: center;
          margin: 40px 0 30px 0;
        }

        .btn-send {
          padding: 14px 32px;
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
          border: none;
          border-radius: 50px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          transition: all 0.3s ease;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }

        .btn-send:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-download-action {
          padding: 14px 32px;
          background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
          color: white;
          border: none;
          border-radius: 50px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
          transition: all 0.3s ease;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }

        .btn-download-action:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>í•™ìŠµ ì´ë ¥</h1>
          <p class="subtitle">${grade} ${name}</p>

          <div class="nav-buttons">
            <a class="btn btn-back" href="/admin/users?key=${encodeURIComponent(key)}">
              â† íšŒì› ëª©ë¡ìœ¼ë¡œ
            </a>
            <a class="btn btn-download" href="/admin/logs-export?key=${encodeURIComponent(
              key
            )}&grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}">
              ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
            </a>
            <a class="btn btn-trash" href="/admin/logs/trash?key=${encodeURIComponent(key)}&grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}">
              ğŸ—‘ï¸ íœ´ì§€í†µ
            </a>
          </div>
        </div>

        <div style="text-align: center;">
          <span class="stats-badge">ğŸ“š ì´ ${logs.length}ê±´ì˜ í•™ìŠµ ê¸°ë¡</span>
        </div>

        <div class="section-title">
          ğŸ“ í•™ìŠµ ê¸°ë¡ ëª©ë¡
        </div>
        <p class="section-description">
          ëª¨ë“  í•™ìŠµ í™œë™ì´ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>ë‚ ì§œ/ì‹œê°„</th>
                <th>ì‹œë¦¬ì¦ˆ</th>
                <th>ë‹¨ì› ì½”ë“œ</th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
    `;

    logs.forEach((log, idx) => {
      const ts = log.timestamp
        ? new Date(log.timestamp).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          })
        : "-";

      const hiddenClass = idx >= 6 ? ' class="hidden-row"' : '';
      html += `
        <tr${hiddenClass}>
          <td>${idx + 1}</td>
          <td>${ts}</td>
          <td>${log.series || ""}</td>
          <td>${log.unit || ""}</td>
          <td>
            <button class="table-delete-btn" onclick="deleteLog('${log._id}', '${encodeURIComponent(key)}', '${encodeURIComponent(grade)}', '${encodeURIComponent(name)}')">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>

        ${logs.length > 6 ? '<button class="toggle-btn" id="toggleBtn" onclick="toggleRows()">ë”ë³´ê¸° â–¼</button>' : ''}

        <hr>

        <div class="section-title">
          ğŸ“Š ê³¼ëª©ë³„ ì¢…í•© ë ˆì´ë”
        </div>
        <p class="section-description">
          ê³¼ëª©ë³„ë¡œ ëª¨ë“  í•™ìŠµ ë°ì´í„°ì˜ í‰ê· ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.<br/>
          (â€» radar ë°ì´í„°ê°€ ìˆëŠ” ê¸°ë¡ë“¤ë§Œ í‰ê· ì— í¬í•¨ë©ë‹ˆë‹¤.)
        </p>

        <div id="summary-radar-wrap"></div>
        <button class="toggle-btn" id="toggleSummaryBtn" onclick="toggleSummaryRadar()" style="display:none;">ë”ë³´ê¸° â–¼</button>

        <hr>

        <div class="section-title">
          ğŸ§  ë‹¨ì›ë³„ ë¬¸í•´ë ¥ ë ˆì´ë” ì°¨íŠ¸
        </div>
        <p class="section-description">
          ê°€ì¥ ìµœê·¼ ê¸°ë¡ì´ ìœ„ì— ì˜¤ë„ë¡ ì •ë ¬ë˜ì–´ ìˆì–´ìš”.<br/>
          (â€» ì•„ì§ radar ë°ì´í„°ê°€ ì—†ëŠ” ê¸°ë¡ì€ ê·¸ë˜í”„ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
        </p>

        <div id="radar-wrap"></div>
        <button class="toggle-btn" id="toggleRadarBtn" onclick="toggleRadar()" style="display:none;">ë”ë³´ê¸° â–¼</button>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
      <script>
        // datalabels í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
        Chart.register(ChartDataLabels);

        // ===== ì‚­ì œ ê¸°ëŠ¥ (ê´€ë¦¬ì ì „ìš©) =====
        function deleteLog(logId, key, grade, name) {
          if (!confirm('ì´ í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì‚­ì œëœ í•­ëª©ì€ íœ´ì§€í†µì—ì„œ ë³µêµ¬í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
            return;
          }

          fetch(\`/admin/log/delete/\${logId}?key=\${encodeURIComponent(key)}\`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
              window.location.reload();
            } else {
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
            }
          })
          .catch(err => {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
          });
        }

        // ===== ê²€ìƒ‰ ê¸°ëŠ¥ (ë‹¨ì›ëª… + ë“±ê¸‰ í†µí•© ê²€ìƒ‰) =====
        function searchLogs(query) {
          const rows = document.querySelectorAll('#logTableBody tr');
          const clearBtn = document.getElementById('logSearchClear');

          clearBtn.classList.toggle('show', query.length > 0);

          rows.forEach(row => {
            // í…Œì´ë¸” êµ¬ì¡°: ìˆœë²ˆ, ê³¼ëª©ëª…, AIê³¼ì œë¶€ì—¬, ìµœì¢…ì™„ë£Œ, ë“±ê¸‰(5ë²ˆì§¸), ì‹œë¦¬ì¦ˆ, ë‹¨ì›ëª…(ë§ˆì§€ë§‰)
            const gradeCell = row.querySelector('td:nth-child(5)');
            const unitCell = row.querySelector('td:last-child');

            if (unitCell && gradeCell) {
              const unitText = unitCell.textContent.toLowerCase();
              const rowGrade = gradeCell.textContent.trim();
              const queryLower = query.toLowerCase();

              // ë‹¨ì›ëª… ë˜ëŠ” ë“±ê¸‰ì— ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ë©´ í‘œì‹œ
              const unitMatch = unitText.includes(queryLower);
              const gradeMatch = rowGrade.includes(queryLower);

              row.style.display = (unitMatch || gradeMatch) ? 'table-row' : 'none';
            }
          });

          updateLogCount();
        }

        function clearLogSearch() {
          document.getElementById('logSearch').value = '';
          document.getElementById('logSearchClear').classList.remove('show');
          const rows = document.querySelectorAll('#logTableBody tr');
          rows.forEach(row => row.style.display = 'table-row');
          updateLogCount();
        }

        // í‘œì‹œëœ ë¡œê·¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateLogCount() {
          const visibleRows = document.querySelectorAll('#logTableBody tr:not([style*="display: none"])');
          const badge = document.getElementById('logCountBadge');
          if (badge) {
            badge.textContent = 'ğŸ“š ì´ ' + visibleRows.length + 'ê±´ì˜ í•™ìŠµ ê¸°ë¡';
          }
        }

        // ê³¼ëª©ë³„ ë ˆì´ë” ê²€ìƒ‰
        function searchSubjectRadar(query) {
          const cards = document.querySelectorAll('#summary-radar-wrap .radar-card');
          const clearBtn = document.getElementById('subjectSearchClear');
          const toggleBtn = document.getElementById('toggleSummaryBtn');
          const gradeFilterEl = document.getElementById('subjectGradeFilter');
          const gradeFilter = gradeFilterEl ? gradeFilterEl.value : 'all';

          clearBtn.classList.toggle('show', query.length > 0);

          cards.forEach((card, index) => {
            const title = card.querySelector('.radar-card-title');
            const gradeEl = card.querySelector('.stat-grade');
            const titleText = title ? title.textContent.toLowerCase() : '';
            const cardGrade = gradeEl ? gradeEl.textContent.trim() : '';

            const searchMatch = query === '' || titleText.includes(query.toLowerCase());
            const gradeMatch = gradeFilter === 'all' || cardGrade.includes(gradeFilter);

            if (searchMatch && gradeMatch) {
              card.style.display = 'block';
              if (query.length > 0 || gradeFilter !== 'all') {
                card.classList.remove('hidden-card');
              } else if (index >= 6) {
                card.classList.add('hidden-card');
              }
            } else {
              card.style.display = 'none';
            }
          });

          // ê²€ìƒ‰/í•„í„° ì¤‘ì´ë©´ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          if (query.length > 0 || gradeFilter !== 'all') {
            if (toggleBtn) toggleBtn.style.display = 'none';
          } else if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        function filterSubjectRadarByGrade(grade) {
          const searchInput = document.getElementById('subjectSearch');
          const query = searchInput ? searchInput.value : '';
          searchSubjectRadar(query);
        }

        function clearSubjectSearch() {
          document.getElementById('subjectSearch').value = '';
          document.getElementById('subjectSearchClear').classList.remove('show');
          document.getElementById('subjectGradeFilter').value = 'all';
          const cards = document.querySelectorAll('#summary-radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleSummaryBtn');

          cards.forEach((card, index) => {
            card.style.display = 'block';
            if (index >= 6) {
              card.classList.add('hidden-card');
            } else {
              card.classList.remove('hidden-card');
            }
          });

          if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        // ë‹¨ì›ë³„ ë ˆì´ë” ê²€ìƒ‰
        function searchUnitRadar(query) {
          const cards = document.querySelectorAll('#radar-wrap .radar-card');
          const clearBtn = document.getElementById('unitSearchClear');
          const toggleBtn = document.getElementById('toggleRadarBtn');
          const gradeFilterEl = document.getElementById('unitGradeFilter');
          const gradeFilter = gradeFilterEl ? gradeFilterEl.value : 'all';

          clearBtn.classList.toggle('show', query.length > 0);

          cards.forEach((card, index) => {
            const title = card.querySelector('.radar-card-title');
            const gradeEl = card.querySelector('.stat-grade');
            const titleText = title ? title.textContent.toLowerCase() : '';
            const cardGrade = gradeEl ? gradeEl.textContent.trim() : '';

            const searchMatch = query === '' || titleText.includes(query.toLowerCase());
            const gradeMatch = gradeFilter === 'all' || cardGrade.includes(gradeFilter);

            if (searchMatch && gradeMatch) {
              card.style.display = 'block';
              if (query.length > 0 || gradeFilter !== 'all') {
                card.classList.remove('hidden-card');
              } else if (index >= 6) {
                card.classList.add('hidden-card');
              }
            } else {
              card.style.display = 'none';
            }
          });

          // ê²€ìƒ‰/í•„í„° ì¤‘ì´ë©´ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          if (query.length > 0 || gradeFilter !== 'all') {
            if (toggleBtn) toggleBtn.style.display = 'none';
          } else if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        function filterUnitRadarByGrade(grade) {
          const searchInput = document.getElementById('unitSearch');
          const query = searchInput ? searchInput.value : '';
          searchUnitRadar(query);
        }

        function clearUnitSearch() {
          document.getElementById('unitSearch').value = '';
          document.getElementById('unitSearchClear').classList.remove('show');
          document.getElementById('unitGradeFilter').value = 'all';
          const cards = document.querySelectorAll('#radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleRadarBtn');

          cards.forEach((card, index) => {
            card.style.display = 'block';
            if (index >= 6) {
              card.classList.add('hidden-card');
            } else {
              card.classList.remove('hidden-card');
            }
          });

          if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        // ===== í•™ìŠµ ê¸°ë¡ ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
        function toggleRows() {
          const hiddenRows = document.querySelectorAll('.hidden-row');
          const toggleBtn = document.getElementById('toggleBtn');

          if (hiddenRows.length === 0) return;

          const isHidden = hiddenRows[0].style.display === 'none' || hiddenRows[0].style.display === '';

          hiddenRows.forEach(row => {
            row.style.display = isHidden ? 'table-row' : 'none';
          });

          toggleBtn.textContent = isHidden ? 'ì ‘ê¸° â–²' : 'ë”ë³´ê¸° â–¼';
        }

        // ===== ì¢…í•© ë ˆì´ë” ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
        function toggleSummaryRadar() {
          const allCards = document.querySelectorAll('#summary-radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleSummaryBtn');
          const isExpanded = toggleBtn.textContent.includes('ì ‘ê¸°');

          allCards.forEach((card, index) => {
            if (index >= 6) {
              if (isExpanded) {
                card.classList.add('hidden-card');
              } else {
                card.classList.remove('hidden-card');
              }
            }
          });

          toggleBtn.textContent = isExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
        }

        // ===== ë‹¨ì›ë³„ ë ˆì´ë” ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
        function toggleRadar() {
          const allCards = document.querySelectorAll('#radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleRadarBtn');
          const isExpanded = toggleBtn.textContent.includes('ì ‘ê¸°');

          allCards.forEach((card, index) => {
            if (index >= 6) {
              if (isExpanded) {
                card.classList.add('hidden-card');
              } else {
                card.classList.remove('hidden-card');
              }
            }
          });

          toggleBtn.textContent = isExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
        }

        const logsForChart = ${JSON.stringify(logs)};

        // ===== ì§„í–‰ë¥  í‘œì‹œë¥¼ ìœ„í•œ í—¬í¼ í•¨ìˆ˜ ë° ë°ì´í„° =====
        // ê³¼ëª© ì½”ë“œ â†’ ì´ ë‹¨ì› ìˆ˜ ë§¤í•‘
        const subjectUnitCounts = {
          'bio': 20, 'earth': 20, 'physics': 20, 'chem': 20,
          'geo': 20, 'soc': 20, 'law': 20, 'pol': 20,
          'modern': 40, 'classic': 40,
          'world': 40, 'world1': 40, 'world2': 40,
          'people': 40, 'people1': 40, 'people2': 40, 'person1': 40, 'person2': 40
        };

        // ë¶„ì•¼ë³„ ì´ ë‹¨ì› ìˆ˜
        const fieldUnitCounts = {
          'ê³¼í•™ë¶„ì•¼': 80,
          'ì‚¬íšŒë¶„ì•¼': 80,
          'í•œêµ­ë¬¸í•™': 80,
          'ì„¸ê³„ë¬¸í•™': 80,
          'ì¸ë¬¼ë¶„ì•¼': 80
        };

        // ì‹œë¦¬ì¦ˆ ì´ ë‹¨ì› ìˆ˜
        const seriesTotalUnits = 400;

        // ë‹¨ì› ì½”ë“œ ì •ê·œí™” í•¨ìˆ˜ (world1_XX, world2_XX, people1_XX, people2_XXê°€ í‘œì¤€ í˜•ì‹)
        function normalizeUnitCode(unit) {
          // fit_ ì ‘ë‘ì–´ ì œê±°: fit_bio_01 -> bio_01
          if (unit.startsWith('fit_')) {
            unit = unit.substring(4);
          }
          // deep_ ì ‘ë‘ì–´ ì œê±°: deep_bio_01 -> bio_01
          if (unit.startsWith('deep_')) {
            unit = unit.substring(5);
          }
          // on_ ì ‘ë‘ì–´ ì œê±°: on_bio_01 -> bio_01
          if (unit.startsWith('on_')) {
            unit = unit.substring(3);
          }
          // world1_XX, world2_XXëŠ” ì´ë¯¸ í‘œì¤€ í˜•ì‹
          if (unit.startsWith('world1_') || unit.startsWith('world2_')) {
            return unit;
          }
          // people1_XX, people2_XXëŠ” ì´ë¯¸ í‘œì¤€ í˜•ì‹
          if (unit.startsWith('people1_') || unit.startsWith('people2_')) {
            return unit;
          }
          // ë ˆê±°ì‹œ: world_01~40 -> world1_XX, world_41~80 -> world2_XX
          if (unit.startsWith('world_')) {
            const numMatch = unit.match(/world_([0-9]+)$/);
            if (numMatch) {
              const num = parseInt(numMatch[1]);
              if (num >= 1 && num <= 40) {
                return 'world1_' + String(num).padStart(2, '0');
              } else if (num >= 41 && num <= 80) {
                return 'world2_' + String(num - 40).padStart(2, '0');
              }
            }
          }
          // ë ˆê±°ì‹œ: people_01~40 -> people1_XX, people_41~80 -> people2_XX
          if (unit.startsWith('people_')) {
            const numMatch = unit.match(/people_([0-9]+)$/);
            if (numMatch) {
              const num = parseInt(numMatch[1]);
              if (num >= 1 && num <= 40) {
                return 'people1_' + String(num).padStart(2, '0');
              } else if (num >= 41 && num <= 80) {
                return 'people2_' + String(num - 40).padStart(2, '0');
              }
            }
          }
          return unit;
        }

        // logsForChartì—ì„œ ì™„ë£Œëœ ê³ ìœ  ë‹¨ì› ìˆ˜ì§‘ (ì •ê·œí™”ëœ ì½”ë“œ ì‚¬ìš©)
        const completedUnitsSet = new Set();
        logsForChart.forEach(log => {
          if (log.unit) {
            completedUnitsSet.add(normalizeUnitCode(log.unit));
          }
        });

        // ê³¼ëª©ë³„ ì™„ë£Œ ê°œìˆ˜ ê³„ì‚° (logsForChart ê¸°ë°˜)
        function getCompletedCount(subjectCode) {
          let count = 0;
          completedUnitsSet.forEach(unit => {
            // world1, world2, people1, people2ëŠ” ì´ì œ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­
            if (unit.startsWith(subjectCode + '_')) {
              count++;
            }
          });
          return count;
        }

        // ë¶„ì•¼ë³„ ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°
        function getFieldCompletedCount(fieldName) {
          const fieldSubjects = {
            'ê³¼í•™ë¶„ì•¼': ['bio', 'earth', 'physics', 'chem'],
            'ì‚¬íšŒë¶„ì•¼': ['geo', 'soc', 'law', 'pol'],
            'í•œêµ­ë¬¸í•™': ['modern', 'classic'],
            'ì„¸ê³„ë¬¸í•™': ['world1', 'world2'],
            'ì¸ë¬¼ë¶„ì•¼': ['people1', 'people2']
          };
          const subjects = fieldSubjects[fieldName] || [];
          let total = 0;
          subjects.forEach(subjectCode => {
            total += getCompletedCount(subjectCode);
          });
          return total;
        }

        // ì‹œë¦¬ì¦ˆ ì „ì²´ ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°
        function getSeriesCompletedCount() {
          return completedUnitsSet.size;
        }

        // ===== ì¢…í•© ë ˆì´ë” ì°¨íŠ¸ ìƒì„± =====
        const summaryWrap = document.getElementById('summary-radar-wrap');

        // ê³¼ëª© ì½”ë“œ â†’ ê³¼ëª©ëª… ë§¤í•‘
        const subjectNames = {
          'geo': 'ì§€ë¦¬',
          'bio': 'ìƒë¬¼',
          'earth': 'ì§€êµ¬ê³¼í•™',
          'physics': 'ë¬¼ë¦¬',
          'chem': 'í™”í•™',
          'soc': 'ì‚¬íšŒë¬¸í™”',
          'law': 'ë²•',
          'pol': 'ì •ì¹˜ê²½ì œ',
          'modern': 'í˜„ëŒ€ë¬¸í•™',
          'classic': 'ê³ ì „ë¬¸í•™',
          'world': 'ì„¸ê³„ë¬¸í•™1',
          'world1': 'ì„¸ê³„ë¬¸í•™1',
          'world2': 'ì„¸ê³„ë¬¸í•™2',
          'people': 'í•œêµ­ì¸ë¬¼',
          'people1': 'í•œêµ­ì¸ë¬¼',
          'people2': 'ì„¸ê³„ì¸ë¬¼',
          'person1': 'í•œêµ­ì¸ë¬¼',
          'person2': 'ì„¸ê³„ì¸ë¬¼'
        };

        // ê³¼ëª© ì½”ë“œ â†’ ë¶„ì•¼ í´ë˜ìŠ¤ ë§¤í•‘
        const subjectToFieldClass = {
          'bio': 'science',
          'earth': 'science',
          'physics': 'science',
          'chem': 'science',
          'geo': 'society',
          'soc': 'society',
          'law': 'society',
          'pol': 'society',
          'modern': 'korean-lit',
          'classic': 'korean-lit',
          'world': 'world-lit',
          'world1': 'world-lit',
          'world2': 'world-lit',
          'people': 'person',
          'people1': 'person',
          'people2': 'person',
          'person1': 'person',
          'person2': 'person'
        };

        // ===== ê³¼ëª©ë³„ ì¢…í•© ë ˆì´ë” í•¨ìˆ˜ =====
        function renderSubjectRadar(logs) {
          // ê¸°ì¡´ ì¹´ë“œ ì œê±°
          summaryWrap.innerHTML = '';

          // í•„í„°ë§ëœ ë¡œê·¸ì—ì„œ ì™„ë£Œëœ ê³¼ëª©ë³„ ë‹¨ì› ìˆ˜ ê³„ì‚°
          function getFilteredCompletedCount(subjectCode, filteredLogs) {
            const unitSet = new Set();
            filteredLogs.forEach(log => {
              if (log.unit) {
                let unitCode = log.unit;
                if (unitCode.startsWith('fit_')) unitCode = unitCode.substring(4);
                else if (unitCode.startsWith('deep_')) unitCode = unitCode.substring(5);
                else if (unitCode.startsWith('on_')) unitCode = unitCode.substring(3);
                if (unitCode.startsWith(subjectCode + '_')) {
                  unitSet.add(unitCode);
                }
              }
            });
            return unitSet.size;
          }

          // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™” (unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ: geo, history ë“±)
          const subjectGroups = {};
          logs.forEach(log => {
            if (!log.radar || !log.unit) return;

            // unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ (geo_01 -> geo, history_01 -> history)
            // fit_ / deep_ / on_ ì ‘ë‘ì–´ ì œê±°: fit_bio_01 -> bio_01, deep_bio_01 -> bio_01, on_bio_01 -> bio_01
            let unitForSubject = log.unit;
            if (unitForSubject.startsWith('fit_')) {
              unitForSubject = unitForSubject.substring(4);
            } else if (unitForSubject.startsWith('deep_')) {
              unitForSubject = unitForSubject.substring(5);
            } else if (unitForSubject.startsWith('on_')) {
              unitForSubject = unitForSubject.substring(3);
            }
            let subjectCode = unitForSubject.split('_')[0];

          // world_01~40 -> world1, world_41~80 -> world2 (peopleë„ ë™ì¼)
          // world2_XX, people2_XXëŠ” ì§ì ‘ world2, people2ë¡œ ë§¤í•‘
          if (subjectCode === 'world' || subjectCode === 'people') {
            const numMatch = unitForSubject.match(/_([0-9]+)$/);
            const num = numMatch ? parseInt(numMatch[1]) : 0;
            if (subjectCode === 'world') {
              subjectCode = num <= 40 ? 'world1' : 'world2';
            } else {
              subjectCode = num <= 40 ? 'people1' : 'people2';
            }
          } else if (subjectCode === 'world1' || subjectCode === 'world2' || subjectCode === 'people1' || subjectCode === 'people2' || subjectCode === 'person1' || subjectCode === 'person2') {
            // world1, world2, people1, people2, person1, person2ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
            // person1 -> people1, person2 -> people2ë¡œ í†µí•©
            if (subjectCode === 'person1') subjectCode = 'people1';
            if (subjectCode === 'person2') subjectCode = 'people2';
          }

          // unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆëª… ì¶”ì¶œ
          const seriesFromUnit = (function(unit) {
            if (!unit) return 'BRAINì—…';
            if (unit.includes('on_')) return 'BRAINì˜¨';
            if (unit.includes('fit_')) return 'BRAINí•';
            if (unit.includes('deep_')) return 'BRAINë”¥';
            return 'BRAINì—…';
          })(log.unit);
          const subjectKey = seriesFromUnit + '_' + subjectCode;

          if (!subjectGroups[subjectKey]) {
            subjectGroups[subjectKey] = {
              series: seriesFromUnit,
              subjectCode: subjectCode,
              logs: []
            };
          }
          subjectGroups[subjectKey].logs.push(log);
        });

        // ê° ê³¼ëª©ë³„ë¡œ í‰ê·  ê³„ì‚° ë° ì°¨íŠ¸ ìƒì„±
        let summaryIndex = 0;
        Object.keys(subjectGroups).forEach(key => {
          const group = subjectGroups[key];
          const seriesLogs = group.logs;
          const subjectName = subjectNames[group.subjectCode] || group.subjectCode;
          const subjectTotal = subjectUnitCounts[group.subjectCode] || 20;
          const subjectCompleted = getFilteredCompletedCount(group.subjectCode, logs);
          const displayTitle = group.series + ' ' + subjectName + ' (' + subjectCompleted + '/' + subjectTotal + ')';

          // í‰ê·  ê³„ì‚°
          let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
          let totalInferential = 0, totalCritical = 0;
          let count = 0;

          seriesLogs.forEach(log => {
            if (log.radar) {
              totalLiteral += log.radar.literal || 0;
              totalStructural += log.radar.structural || 0;
              totalLexical += log.radar.lexical || 0;
              totalInferential += log.radar.inferential || 0;
              totalCritical += log.radar.critical || 0;
              count++;
            }
          });

          if (count === 0) return;

          const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
          const avgStructural = Math.round((totalStructural / count) * 10) / 10;
          const avgLexical = Math.round((totalLexical / count) * 10) / 10;
          const avgInferential = Math.round((totalInferential / count) * 10) / 10;
          const avgCritical = Math.round((totalCritical / count) * 10) / 10;

          const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
          const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
          const maxScore = Math.max(...scores).toFixed(1);
          const minScore = Math.min(...scores).toFixed(1);

          // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
          let badgeClass = 'badge-normal';
          let badgeText = 'ë³´í†µ';
          if (avgScore >= 9) {
            badgeClass = 'badge-excellent';
            badgeText = 'ìš°ìˆ˜';
          } else if (avgScore >= 8) {
            badgeClass = 'badge-good';
            badgeText = 'ì–‘í˜¸';
          } else if (avgScore >= 7) {
            badgeClass = 'badge-normal';
            badgeText = 'ë³´í†µ';
          } else {
            badgeClass = 'badge-encourage';
            badgeText = 'ê²©ë ¤';
          }

          // ì°¨íŠ¸ ì¹´ë“œ ìƒì„±
          const fieldClass = subjectToFieldClass[group.subjectCode] || '';
          const card = document.createElement('div');
          card.className = 'radar-card summary-card subject-card ' + fieldClass + (summaryIndex >= 6 ? ' hidden-card' : '');
          summaryIndex++;

          const header = document.createElement('div');
          header.className = 'radar-card-header';

          const title = document.createElement('div');
          title.className = 'radar-card-title';
          title.textContent = displayTitle;

          const subtitle = document.createElement('div');
          subtitle.className = 'radar-card-time';
          subtitle.innerHTML = 'ğŸ“š ì´ ' + count + 'íšŒ í•™ìŠµ';

          const badge = document.createElement('div');
          badge.className = 'score-badge ' + badgeClass;
          badge.textContent = badgeText + ' ë“±ê¸‰';

          header.appendChild(title);
          header.appendChild(subtitle);
          header.appendChild(badge);
          card.appendChild(header);

          const canvas = document.createElement('canvas');
          canvas.width = 280;
          canvas.height = 280;
          card.appendChild(canvas);

          // í†µê³„ ì •ë³´
          const stats = document.createElement('div');
          stats.className = 'radar-card-stats';
          stats.innerHTML =
            '<div class="stat-item">' +
              '<div class="stat-label">í‰ê· </div>' +
              '<div class="stat-value">' + avgScore + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœê³ </div>' +
              '<div class="stat-value">' + maxScore + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœì €</div>' +
              '<div class="stat-value">' + minScore + '</div>' +
            '</div>';
          card.appendChild(stats);

          summaryWrap.appendChild(card);

          // ì°¨íŠ¸ ìƒì„±
          new Chart(canvas.getContext('2d'), {
            type: 'radar',
            data: {
              labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
              datasets: [{
                label: displayTitle,
                data: scores,
                backgroundColor: 'rgba(245, 87, 108, 0.2)',
                borderColor: '#f5576c',
                borderWidth: 3,
                pointBackgroundColor: '#f5576c',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                r: {
                  suggestedMin: 0,
                  suggestedMax: 10,
                  ticks: {
                    stepSize: 2,
                    backdropColor: 'transparent',
                    font: { size: 11 }
                  },
                  pointLabels: {
                    font: { size: 12, weight: 'bold' }
                  },
                  grid: { color: '#e5d4c1' },
                  angleLines: { color: '#e5d4c1' }
                }
              }
            }
          });
        });

        // ===== ê°œë³„ ë ˆì´ë” ì°¨íŠ¸ ìƒì„± =====
        const wrap = document.getElementById('radar-wrap');
        let radarIndex = 0;

        logsForChart.forEach(function(log, idx) {
          if (!log.radar) return;

          const r = log.radar || {};

          // í‰ê·  ì ìˆ˜ ê³„ì‚°
          const scores = [
            r.literal || 0,
            r.structural || 0,
            r.lexical || 0,
            r.inferential || 0,
            r.critical || 0
          ];
          const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
          const maxScore = Math.max(...scores).toFixed(1);
          const minScore = Math.min(...scores).toFixed(1);

          // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
          let badgeClass = 'badge-normal';
          let badgeText = 'ë³´í†µ';
          if (avgScore >= 9) {
            badgeClass = 'badge-excellent';
            badgeText = 'ìš°ìˆ˜';
          } else if (avgScore >= 8) {
            badgeClass = 'badge-good';
            badgeText = 'ì–‘í˜¸';
          } else if (avgScore >= 7) {
            badgeClass = 'badge-normal';
            badgeText = 'ë³´í†µ';
          } else {
            badgeClass = 'badge-encourage';
            badgeText = 'ê²©ë ¤';
          }

          const card = document.createElement('div');
          card.className = 'radar-card' + (radarIndex >= 6 ? ' hidden-card' : '');

          const header = document.createElement('div');
          header.className = 'radar-card-header';

          const title = document.createElement('div');
          title.className = 'radar-card-title';
          title.textContent = (log.unit || 'ë‹¨ì› ë¯¸ì§€ì •');

          const time = document.createElement('div');
          time.className = 'radar-card-time';
          time.innerHTML = 'ğŸ• ' + (log.timestamp ? new Date(log.timestamp).toLocaleString('ko-KR') : '-');

          const badge = document.createElement('div');
          badge.className = 'score-badge ' + badgeClass;
          badge.textContent = badgeText + ' ë“±ê¸‰';

          header.appendChild(title);
          header.appendChild(time);
          header.appendChild(badge);
          card.appendChild(header);

          const canvas = document.createElement('canvas');
          canvas.id = 'radar-' + idx;
          canvas.width = 280;
          canvas.height = 280;
          card.appendChild(canvas);

          // í†µê³„ ì •ë³´
          const stats = document.createElement('div');
          stats.className = 'radar-card-stats';
          stats.innerHTML =
            '<div class="stat-item">' +
              '<div class="stat-label">í‰ê· </div>' +
              '<div class="stat-value">' + avgScore + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœê³ </div>' +
              '<div class="stat-value">' + maxScore + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœì €</div>' +
              '<div class="stat-value">' + minScore + '</div>' +
            '</div>';
          card.appendChild(stats);

          wrap.appendChild(card);

          new Chart(canvas.getContext('2d'), {
            type: 'radar',
            data: {
              labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
              datasets: [{
                label: (log.unit || 'ë‹¨ì›') + ' ë¶„ì„ë¦¬í¬íŠ¸',
                data: scores,
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: '#667eea',
                borderWidth: 3,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                r: {
                  suggestedMin: 0,
                  suggestedMax: 10,
                  ticks: {
                    stepSize: 2,
                    backdropColor: 'transparent',
                    font: { size: 11 }
                  },
                  pointLabels: {
                    font: { size: 12, weight: 'bold' }
                  },
                  grid: { color: '#e5d4c1' },
                  angleLines: { color: '#e5d4c1' }
                }
              }
            }
          });

          radarIndex++;
        });

        // ê°œë³„ ë ˆì´ë” ì°¨íŠ¸ ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
        if (radarIndex > 6) {
          document.getElementById('toggleRadarBtn').style.display = 'block';
        }

        // ===== PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ =====
        async function downloadPDF() {
          const container = document.querySelector('.container');
          const { jsPDF } = window.jspdf;

          try {
            const canvas = await html2canvas(container, {
              scale: 2,
              useCORS: true,
              logging: false,
              backgroundColor: '#ffffff'
            });

            const imgData = canvas.toDataURL('image/jpeg', 0.5);
            const pdf = new jsPDF({
              orientation: 'portrait',
              unit: 'mm',
              format: 'a4'
            });

            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft > 0) {
              position = heightLeft - imgHeight;
              pdf.addPage();
              pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
              heightLeft -= pageHeight;
            }

            const fileName = \`í•™ìŠµì´ë ¥_${grade}_${name}_\${new Date().toISOString().slice(0, 10)}.pdf\`;
            pdf.save(fileName);
          } catch (error) {
            console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
            alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }
      </script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

      <script>
        // í•™ìŠµì´ë ¥ ì „ì†¡ (mailto ë°©ì‹)
        function openSendModal() {
          const subject = \`[ë‹¨ë‹¨êµì‹¤] ${grade} ${name} í•™ìƒ í•™ìŠµì´ë ¥\`;
          const body = \`ì•ˆë…•í•˜ì„¸ìš”,\\n\\n${grade} ${name} í•™ìƒì˜ í•™ìŠµì´ë ¥ ë¦¬í¬íŠ¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.\\n\\nğŸ“Š í•™ìŠµ ë¶„ì„ ë‚´ìš©:\\n- í•™ìŠµ ê¸°ë¡ ë° ì ìˆ˜\\n- ë‹¨ì›ë³„ ë¬¸ì œë³„ ë ˆì´ë” ì°¨íŠ¸\\n- ì¢…í•© ë¶„ì„ ê²°ê³¼\\n\\nìì„¸í•œ ë‚´ìš©ì€ ì²¨ë¶€ëœ PDF íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\\n\\nâ€» PDF íŒŒì¼ì€ 'ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¨¼ì € ì €ì¥í•œ í›„ ì´ë©”ì¼ì— ì²¨ë¶€í•´ì£¼ì„¸ìš”.\\n\\nê°ì‚¬í•©ë‹ˆë‹¤.\`;

          const mailtoLink = \`mailto:?subject=\${encodeURIComponent(subject)}&body=\${encodeURIComponent(body)}\`;

          console.log('ğŸ“§ ì´ë©”ì¼ ì•± ì—´ê¸°:', mailtoLink);
          window.location.href = mailtoLink;
        }
      </script>

      <div class="action-buttons">
        <button class="btn-send" onclick="openSendModal()">
          ğŸ“¤ ì „ì†¡í•˜ê¸°
        </button>
        <button class="btn-download-action" onclick="downloadPDF()">
          ğŸ“¥ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>

    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /admin/logs ì—ëŸ¬:", err);
    res.status(500).send("í•™ìŠµ ì´ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ===== í•™ìŠµ ì´ë ¥ CSV ë‹¤ìš´ë¡œë“œ =====
app.get("/admin/logs-export", async (req, res) => {
  const { key, grade, name } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }
  if (!grade || !name) {
    return res.status(400).send("grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  try {
    const logs = await LearningLog.find({ grade, name })
      .sort({ timestamp: -1 })
      .lean();

    const escape = (v = "") => `"${String(v).replace(/"/g, '""')}"`;

    const lines = [];
    lines.push(
      [
        "ë²ˆí˜¸",
        "ë‚ ì§œì‹œê°„",
        "ì‹œë¦¬ì¦ˆ",
        "ë‹¨ì›ì½”ë“œ",
        "í•µì‹¬ì´í•´ë ¥",
        "êµ¬ì¡°íŒŒì•…ë ¥",
        "ì–´íœ˜ë§¥ë½ë ¥",
        "ì¶”ë¡ Â·í†µí•©ë ¥",
        "ë¹„íŒÂ·ì ìš©ë ¥",
      ]
        .map(escape)
        .join(",")
    );

    logs.forEach((log, idx) => {
      const ts = log.timestamp
        ? new Date(log.timestamp).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          })
        : "";

      const r = log.radar || {};

      lines.push(
        [
          idx + 1,
          ts,
          log.series || "",
          log.unit || "",
          r.literal ?? "",
          r.structural ?? "",
          r.lexical ?? "",
          r.inferential ?? "",
          r.critical ?? "",
        ]
          .map(escape)
          .join(",")
      );
    });

    const csvBody = lines.join("\r\n");
    const bom = "\uFEFF";

    res.setHeader("Content-Type", "text/csv; charset=utf-8");
    res.setHeader(
      "Content-Disposition",
      `attachment; filename="dandan_logs_${encodeURIComponent(
        grade + "_" + name
      )}_${new Date().toISOString().slice(0, 10)}.csv"`
    );

    res.send(bom + csvBody);
  } catch (err) {
    console.error("âŒ /admin/logs-export ì—ëŸ¬:", err);
    res.status(500).send("í•™ìŠµ ì´ë ¥ CSV ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ===== í•™ìŠµ ê¸°ë¡ ì¡°íšŒ API (ë±ƒì§€ìš©) =====
app.get("/api/learning-logs", async (req, res) => {
  const { grade, name, phone } = req.query;

  console.log("ğŸ“Š [/api/learning-logs] ìš”ì²­:", { grade, name, phone });

  if (!grade || !name) {
    return res.status(400).json({ error: "grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
  }

  // ìºì‹œ í‚¤ ìƒì„±
  const cacheKey = getCacheKey('learning-logs', { grade, name, phone });
  const cached = getCache(cacheKey);
  if (cached) {
    console.log("ğŸ’¾ [/api/learning-logs] ìºì‹œ ì‚¬ìš©");
    return res.json(cached);
  }

  try {
    // phoneì´ ìˆìœ¼ë©´ phoneìœ¼ë¡œë„ í•„í„°ë§ (ìƒˆë¡œìš´ í•™ìŠµ ê¸°ë¡ìš©)
    // phoneì´ ì—†ìœ¼ë©´ grade, nameë§Œìœ¼ë¡œ í•„í„°ë§ (ê¸°ì¡´ í•™ìŠµ ê¸°ë¡ í˜¸í™˜)
    const query = phone
      ? { grade, name, phone }
      : { grade, name };

    const logs = await LearningLog.find(query)
      .sort({ timestamp: -1 })
      .lean();

    // UserProgressì—ì„œ AI ê³¼ì œ ë³µìŠµ ì™„ë£Œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const userProgress = await UserProgress.findOne({ grade, name });
    const aiTaskMap = new Map();

    if (userProgress && userProgress.studyRoom && userProgress.studyRoom.assignedTasks) {
      userProgress.studyRoom.assignedTasks.forEach(task => {
        if (task.isAI && task.completedAt) {
          aiTaskMap.set(task.id, task.completedAt);
        }
      });
    }

    // ê° í•™ìŠµ ê¸°ë¡ì— AI ë³µìŠµ ì™„ë£Œ ì‹œê°„ ì¶”ê°€
    const logsWithAIReview = logs.map(log => ({
      ...log,
      aiReviewCompletedAt: aiTaskMap.get(log.unit) || null
    }));

    // ìºì‹œì— ì €ì¥
    setCache(cacheKey, logsWithAIReview);

    res.json(logsWithAIReview);
  } catch (err) {
    console.error("âŒ /api/learning-logs ì—ëŸ¬:", err);
    res.status(500).json({ error: "í•™ìŠµ ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== ë‹¨ì›ë³„ ìµœì‹  ë“±ê¸‰ ì¡°íšŒ API =====
app.get("/api/unit-grades", async (req, res) => {
  const { grade, name } = req.query;

  console.log("â­ [/api/unit-grades] ìš”ì²­:", { grade, name });

  if (!grade || !name) {
    return res.status(400).json({ error: "grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
  }

  // ìºì‹œ í‚¤ ìƒì„±
  const cacheKey = getCacheKey('unit-grades', { grade, name });
  const cached = getCache(cacheKey);
  if (cached) {
    console.log("ğŸ’¾ [/api/unit-grades] ìºì‹œ ì‚¬ìš©");
    return res.json(cached);
  }

  try {
    // í•™ìƒì˜ ëª¨ë“  í•™ìŠµ ê¸°ë¡ ì¡°íšŒ
    const logs = await LearningLog.find({ grade, name, deleted: false })
      .sort({ timestamp: -1 })
      .lean();

    // ë‹¨ì›ë³„ë¡œ ê°€ì¥ ìµœì‹  í•™ìŠµ ê¸°ë¡ì˜ ë“±ê¸‰ ì¶”ì¶œ
    const unitGradesMap = {};

    logs.forEach(log => {
      let unitId = log.unit;

      // people2_XX, people1_XX, world2_XX í˜•ì‹ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë³€í™˜í•˜ì§€ ì•ŠìŒ)
      // í´ë¼ì´ì–¸íŠ¸ì—ì„œ normalizeUnitIdë¡œ ë™ì¼í•˜ê²Œ ë³€í™˜í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©

      // ì´ë¯¸ ë“±ë¡ëœ ë‹¨ì›ì´ ì•„ë‹ˆë©´ ì¶”ê°€ (ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì²« ë²ˆì§¸ê°€ ìµœì‹ )
      if (!unitGradesMap[unitId] && log.radar) {
        // ë ˆì´ë” í‰ê·  ê³„ì‚°
        const radarValues = Object.values(log.radar);
        const radarAvg = radarValues.reduce((sum, val) => sum + val, 0) / radarValues.length;

        // ë“±ê¸‰ ê²°ì • (ì¢…í•©ë¦¬í¬íŠ¸ì™€ ë™ì¼í•œ ê¸°ì¤€ ì ìš©)
        let grade = 'ê²©ë ¤';
        if (radarAvg >= 9) {
          grade = 'ìš°ìˆ˜';
        } else if (radarAvg >= 8) {
          grade = 'ì–‘í˜¸';
        } else if (radarAvg >= 7) {
          grade = 'ë³´í†µ';
        }

        unitGradesMap[unitId] = {
          grade: grade,
          radarAvg: radarAvg.toFixed(2),
          timestamp: log.timestamp,
          radar: log.radar  // âœ… ë ˆì´ë” ì ìˆ˜ ë°ì´í„° í¬í•¨
        };
      }
    });

    // ìºì‹œì— ì €ì¥
    setCache(cacheKey, unitGradesMap);

    res.json(unitGradesMap);
  } catch (err) {
    console.error("âŒ /api/unit-grades ì—ëŸ¬:", err);
    res.status(500).json({ error: "ë‹¨ì› ë“±ê¸‰ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== í•™ìƒìš© í•™ìŠµ ì´ë ¥ ë³´ê¸° (ì¸ì¦ ë¶ˆí•„ìš”) =====
app.get("/my-learning", async (req, res) => {
  // ìºì‹œ ë°©ì§€ í—¤ë” ì„¤ì •
  res.set('Cache-Control', 'no-store, no-cache, must-revalidate, private');
  res.set('Pragma', 'no-cache');
  res.set('Expires', '0');

  const { grade, name, series } = req.query;

  console.log("ğŸ“Š [/my-learning] ìš”ì²­:", { grade, name, series });

  if (!grade || !name) {
    console.log("âŒ [/my-learning] íŒŒë¼ë¯¸í„° ë¶€ì¡±");
    return res.status(400).send("grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  try {
    const logs = await LearningLog.find({ grade, name, deleted: { $ne: true } })
      .sort({ timestamp: -1 })
      .lean();

    console.log("âœ… [/my-learning] ì¡°íšŒ ê²°ê³¼:", logs.length, "ê°œ ê¸°ë¡");

    // ğŸ”¥ LearningLogì— ì €ì¥ëœ aiReviewCompletedAt ì§ì ‘ ì‚¬ìš© (ê³¼ì œ ì‚­ì œí•´ë„ ìœ ì§€ë¨)
    // logsì—ëŠ” ì´ë¯¸ aiReviewCompletedAt í•„ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŒ

    // âœ… UserProgressì—ì„œ ì–´íœ˜í•™ìŠµ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    const userProgress = await UserProgress.findOne({ grade, name }).lean();
    // Map íƒ€ì…ì€ lean()í•˜ë©´ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜ë¨
    let unitProgressMap = {};
    if (userProgress?.unitProgress) {
      // Mapì´ Objectë¡œ ë³€í™˜ëœ ê²½ìš° ë˜ëŠ” ì´ë¯¸ Objectì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
      if (userProgress.unitProgress instanceof Map) {
        unitProgressMap = Object.fromEntries(userProgress.unitProgress);
      } else {
        unitProgressMap = userProgress.unitProgress;
      }
    }
    console.log("âœ… [/my-learning] UserProgress unitProgress ì¡°íšŒ ì™„ë£Œ, í‚¤ ê°œìˆ˜:", Object.keys(unitProgressMap).length);

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>ë‚˜ì˜ AI í•™ìŠµ ë¶„ì„ - ${grade} ${name}</title>
      <!-- html2canvas & jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <style>
        /* ğŸ”„ ë¡œë”© ìŠ¤í”¼ë„ˆ - ì¸ë¼ì¸ í¬ë¦¬í‹°ì»¬ CSS */
        #loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(242, 237, 229, 0.95);
          backdrop-filter: blur(5px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 99999;
          transition: opacity 0.5s ease;
        }

        #loading-overlay.fade-out {
          opacity: 0;
          pointer-events: none;
        }

        .spinner-container {
          text-align: center;
        }

        .spinner {
          width: 50px;
          height: 50px;
          border: 4px solid rgba(139, 47, 47, 0.2);
          border-top: 4px solid #8b2f2f;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
        }

        .loading-text {
          color: #8b2f2f;
          font-size: 16px;
          font-weight: 600;
          font-family: "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif;
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          min-height: 100vh;
          padding: 40px 20px;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          background: #ffffff;
          border-radius: 24px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
          padding: 50px;
        }

        .header {
          text-align: center;
          margin-bottom: 50px;
          padding-bottom: 30px;
          border-bottom: 3px solid #e5d4c1;
        }

        h1 {
          font-size: 42px;
          font-weight: 800;
          color: #1e3a8a;
          margin-bottom: 15px;
        }

        .subtitle {
          font-size: 18px;
          color: #7f8c8d;
          font-weight: 500;
        }

        .stats-badge {
          display: inline-block;
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          color: white;
          padding: 12px 28px;
          border-radius: 30px;
          font-size: 16px;
          font-weight: 600;
          margin: 30px 0;
          box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .section-title {
          font-size: 28px;
          font-weight: 700;
          color: #2c3e50;
          margin: 40px 0 15px 0;
          padding-left: 15px;
          border-left: 5px solid #667eea;
        }

        .section-description {
          font-size: 15px;
          color: #7f8c8d;
          margin-bottom: 30px;
          line-height: 1.6;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 15px;
          margin-bottom: 15px;
        }

        .search-box {
          display: flex;
          align-items: center;
          background: white;
          border: 2px solid #e0e0e0;
          border-radius: 25px;
          padding: 8px 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
        }

        .search-box:focus-within {
          border-color: #667eea;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .search-box input {
          border: none;
          outline: none;
          font-size: 14px;
          width: 150px;
          background: transparent;
        }

        .search-box input::placeholder {
          color: #aaa;
        }

        .search-box .search-icon {
          color: #667eea;
          margin-right: 8px;
        }

        .search-box .clear-btn {
          background: none;
          border: none;
          color: #999;
          cursor: pointer;
          font-size: 16px;
          padding: 0 4px;
          display: none;
        }

        .search-box .clear-btn.show {
          display: inline;
        }

        .search-box .clear-btn:hover {
          color: #e74c3c;
        }

        .grade-filter {
          display: flex;
          align-items: center;
          background: white;
          border: 2px solid #e0e0e0;
          border-radius: 25px;
          padding: 8px 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
        }

        .grade-filter:focus-within {
          border-color: #667eea;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .grade-filter select {
          border: none;
          outline: none;
          font-size: 14px;
          background: transparent;
          cursor: pointer;
          color: #333;
          padding-right: 8px;
        }

        .grade-filter .filter-icon {
          color: #667eea;
          margin-right: 8px;
        }

        hr {
          border: none;
          border-top: 2px solid #e5d4c1;
          margin: 60px 0;
        }

        .table-container {
          overflow-x: auto;
          border-radius: 16px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          margin-bottom: 40px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          background: white;
        }

        thead {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        th {
          color: white;
          padding: 18px 16px;
          text-align: center;
          font-weight: 600;
          font-size: 15px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        th[onclick] {
          cursor: pointer;
          user-select: none;
          transition: background 0.2s ease;
        }

        th[onclick]:hover {
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        td {
          padding: 16px;
          text-align: center;
          border-bottom: 1px solid #ecf0f1;
          font-size: 14px;
          color: #2c3e50;
        }

        tbody tr {
          transition: all 0.2s ease;
          cursor: pointer;
        }

        tbody tr:hover {
          background: linear-gradient(135deg, #e8f4fd 0%, #d4edfc 100%);
          transform: scale(1.01);
        }

        tbody tr:active {
          background: linear-gradient(135deg, #cce5ff 0%, #b3d9ff 100%);
        }

        tbody tr:last-child td {
          border-bottom: none;
        }

        /* ë‹¨ì›ëª… í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        .unit-link {
          color: #1e3a8a;
          font-weight: 600;
        }

        .unit-link::after {
          content: ' ğŸ“–';
        }

        .hidden-row {
          display: none;
        }

        .hidden-card {
          display: none !important;
        }

        .toggle-btn {
          display: block;
          margin: 20px auto;
          padding: 12px 32px;
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          color: white;
          border: none;
          border-radius: 25px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .toggle-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        .toggle-btn:active {
          transform: translateY(0);
        }

        /* Progress Section Styles */
        .progress-section {
          margin: 40px 0;
        }

        .total-progress-card {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          border-radius: 24px;
          padding: 50px 40px;
          margin-bottom: 40px;
          box-shadow: 0 15px 40px rgba(30, 58, 138, 0.4);
          text-align: center;
          position: relative;
          overflow: hidden;
          border: 3px solid rgba(255, 255, 255, 0.3);
          animation: pulse-glow 3s ease-in-out infinite;
        }

        .total-progress-card::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: linear-gradient(
            45deg,
            transparent,
            rgba(255, 255, 255, 0.1),
            transparent
          );
          transform: rotate(45deg);
          animation: shimmer 3s infinite;
        }

        @keyframes pulse-glow {
          0%, 100% {
            box-shadow: 0 15px 40px rgba(30, 58, 138, 0.4);
          }
          50% {
            box-shadow: 0 15px 50px rgba(30, 58, 138, 0.6), 0 0 30px rgba(30, 58, 138, 0.3);
          }
        }

        @keyframes shimmer {
          0% {
            transform: translateX(-100%) translateY(-100%) rotate(45deg);
          }
          100% {
            transform: translateX(100%) translateY(100%) rotate(45deg);
          }
        }

        .total-progress-title {
          font-size: 40px;
          font-weight: 800;
          margin-bottom: 30px;
          color: white;
          text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
          letter-spacing: -0.5px;
          position: relative;
          z-index: 1;
        }

        .total-progress-bar-container {
          width: 100%;
          height: 60px;
          background: rgba(255, 255, 255, 0.2);
          border-radius: 30px;
          overflow: hidden;
          position: relative;
          margin-bottom: 25px;
          box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
          border: 2px solid rgba(255, 255, 255, 0.3);
          z-index: 1;
        }

        .total-progress-bar {
          height: 100%;
          background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
          transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          justify-content: center;
          color: #1e3a8a;
          font-weight: 900;
          font-size: 22px;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        }

        .total-progress-bar::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.6),
            transparent
          );
          animation: progress-shimmer 2s infinite;
        }

        @keyframes progress-shimmer {
          0% {
            left: -100%;
          }
          100% {
            left: 100%;
          }
        }

        .total-progress-text {
          font-size: 24px;
          color: white;
          font-weight: 700;
          position: relative;
          z-index: 1;
          text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .field-progress-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 20px;
        }

        .field-progress-card {
          background: white;
          border-radius: 16px;
          padding: 25px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .field-progress-card.science {
          border: 2px solid #4facfe;
        }

        .field-progress-card.society {
          border: 2px solid #43e97b;
        }

        .field-progress-card.korean-lit {
          border: 2px solid #fa709a;
        }

        .field-progress-card.world-lit {
          border: 2px solid #30cfd0;
        }

        .field-progress-card.person {
          border: 2px solid #a8edea;
        }

        .field-title {
          font-size: 16px;
          font-weight: 700;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }

        .field-title-text {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .field-percent {
          font-size: 24px;
          font-weight: 700;
        }

        .field-percent.science {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .field-percent.society {
          background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .field-percent.korean-lit {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .field-percent.world-lit {
          background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .field-percent.person {
          background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .field-progress-bar-container {
          width: 100%;
          height: 12px;
          background: #f0f0f0;
          border-radius: 6px;
          overflow: hidden;
          margin-bottom: 10px;
        }

        .field-progress-bar {
          height: 100%;
          transition: width 0.5s ease;
        }

        .field-progress-bar.science {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .field-progress-bar.society {
          background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .field-progress-bar.korean-lit {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .field-progress-bar.world-lit {
          background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }

        .field-progress-bar.person {
          background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .field-progress-text {
          font-size: 14px;
          color: #666;
          margin-bottom: 15px;
        }

        .subject-list {
          border-left: 2px solid #e0e0e0;
          padding-left: 15px;
          margin-left: 5px;
        }

        .subject-item {
          margin-bottom: 12px;
        }

        .subject-title {
          font-size: 13px;
          color: #555;
          margin-bottom: 5px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .subject-progress-bar-container {
          width: 100%;
          height: 6px;
          background: #f0f0f0;
          border-radius: 3px;
          overflow: hidden;
        }

        .subject-progress-bar {
          height: 100%;
          transition: width 0.5s ease;
          opacity: 0.7;
        }

        .subject-progress-bar.science {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .subject-progress-bar.society {
          background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .subject-progress-bar.korean-lit {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .subject-progress-bar.world-lit {
          background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }

        .subject-progress-bar.person {
          background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        #radar-wrap, #summary-radar-wrap, #series-radar-wrap, #field-radar-wrap {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
          justify-content: center;
          margin: 20px 0;
        }

        .radar-card {
          flex: 0 0 320px;
          border: 2px solid #e5d4c1;
          border-radius: 20px;
          padding: 16px;
          background: linear-gradient(135deg, #ffffff 0%, #fffaf3 100%);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        .radar-card:hover {
          transform: translateY(-8px);
          box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .radar-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .radar-card.summary-card::before {
          background: linear-gradient(90deg, #f093fb 0%, #f5576c 50%, #e74c3c 100%) !important;
        }

        .radar-card.summary-card {
          border-color: #f5c6cb;
        }

        .radar-card.summary-card .stat-value {
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
          -webkit-background-clip: text !important;
          -webkit-text-fill-color: transparent !important;
        }

        /* ì‹œë¦¬ì¦ˆ ì¹´ë“œ - íŒŒë€ìƒ‰ */
        .radar-card.series-card {
          border-color: rgba(54, 162, 235, 0.5);
        }

        .radar-card.series-card::before {
          background: linear-gradient(90deg, #36a2eb 0%, #1e88e5 50%, #1565c0 100%) !important;
        }

        .radar-card.series-card .radar-card-title {
          color: #1565c0;
        }

        .radar-card.series-card .stat-value {
          color: #36a2eb !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        /* ë¶„ì•¼ë³„ ì¹´ë“œ - ë³´ë¼ìƒ‰ */
        .radar-card.field-card {
          border-color: rgba(153, 102, 255, 0.5);
        }

        .radar-card.field-card::before {
          background: linear-gradient(90deg, #9966ff 0%, #7e57c2 50%, #5e35b1 100%) !important;
        }

        .radar-card.field-card .radar-card-title {
          color: #5e35b1;
        }

        .radar-card.field-card .stat-value {
          color: #9966ff !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        /* ë¶„ì•¼ë³„ ì¹´ë“œ - ê° ë¶„ì•¼ ìƒ‰ìƒ ì ìš© */
        .radar-card.field-card.science {
          border: 2px solid #4facfe;
        }
        .radar-card.field-card.science::before {
          background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%) !important;
        }
        .radar-card.field-card.science .radar-card-title {
          color: #4facfe;
        }
        .radar-card.field-card.science .stat-value {
          color: #4facfe !important;
        }

        .radar-card.field-card.society {
          border: 2px solid #43e97b;
        }
        .radar-card.field-card.society::before {
          background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%) !important;
        }
        .radar-card.field-card.society .radar-card-title {
          color: #38b060;
        }
        .radar-card.field-card.society .stat-value {
          color: #43e97b !important;
        }

        .radar-card.field-card.korean-lit {
          border: 2px solid #fa709a;
        }
        .radar-card.field-card.korean-lit::before {
          background: linear-gradient(90deg, #fa709a 0%, #fee140 100%) !important;
        }
        .radar-card.field-card.korean-lit .radar-card-title {
          color: #e05780;
        }
        .radar-card.field-card.korean-lit .stat-value {
          color: #fa709a !important;
        }

        .radar-card.field-card.world-lit {
          border: 2px solid #30cfd0;
        }
        .radar-card.field-card.world-lit::before {
          background: linear-gradient(90deg, #30cfd0 0%, #330867 100%) !important;
        }
        .radar-card.field-card.world-lit .radar-card-title {
          color: #2ab0b1;
        }
        .radar-card.field-card.world-lit .stat-value {
          color: #30cfd0 !important;
        }

        .radar-card.field-card.person {
          border: 2px solid #b388ff;
        }
        .radar-card.field-card.person::before {
          background: linear-gradient(90deg, #b388ff 0%, #7c4dff 100%) !important;
        }
        .radar-card.field-card.person .radar-card-title {
          color: #9575cd;
        }
        .radar-card.field-card.person .stat-value {
          color: #b388ff !important;
        }

        /* ê³¼ëª©ë³„ ì¹´ë“œ - ë¶„ì•¼ë³„ ìƒ‰ìƒ ì ìš© */
        .radar-card.subject-card.science {
          border: 2px solid #4facfe;
        }
        .radar-card.subject-card.science::before {
          background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%) !important;
        }
        .radar-card.subject-card.science .radar-card-title {
          color: #4facfe;
        }
        .radar-card.subject-card.science .stat-value {
          color: #4facfe !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        .radar-card.subject-card.society {
          border: 2px solid #43e97b;
        }
        .radar-card.subject-card.society::before {
          background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%) !important;
        }
        .radar-card.subject-card.society .radar-card-title {
          color: #38b060;
        }
        .radar-card.subject-card.society .stat-value {
          color: #43e97b !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        .radar-card.subject-card.korean-lit {
          border: 2px solid #fa709a;
        }
        .radar-card.subject-card.korean-lit::before {
          background: linear-gradient(90deg, #fa709a 0%, #fee140 100%) !important;
        }
        .radar-card.subject-card.korean-lit .radar-card-title {
          color: #e05780;
        }
        .radar-card.subject-card.korean-lit .stat-value {
          color: #fa709a !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        .radar-card.subject-card.world-lit {
          border: 2px solid #30cfd0;
        }
        .radar-card.subject-card.world-lit::before {
          background: linear-gradient(90deg, #30cfd0 0%, #330867 100%) !important;
        }
        .radar-card.subject-card.world-lit .radar-card-title {
          color: #2ab0b1;
        }
        .radar-card.subject-card.world-lit .stat-value {
          color: #30cfd0 !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        .radar-card.subject-card.person {
          border: 2px solid #b388ff;
        }
        .radar-card.subject-card.person::before {
          background: linear-gradient(90deg, #b388ff 0%, #7c4dff 100%) !important;
        }
        .radar-card.subject-card.person .radar-card-title {
          color: #9575cd;
        }
        .radar-card.subject-card.person .stat-value {
          color: #b388ff !important;
          background: none !important;
          -webkit-background-clip: unset !important;
          -webkit-text-fill-color: unset !important;
        }

        .radar-card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        }

        .radar-card-title {
          font-size: 16px;
          font-weight: 700;
          color: #2c3e50;
        }

        .badge {
          padding: 6px 14px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
        }

        .badge-excellent {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
          box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .badge-good {
          background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
          color: #333;
          box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .badge-normal {
          background: linear-gradient(135deg, #ff9a56 0%, #ff6a00 100%);
          color: white;
          box-shadow: 0 4px 15px rgba(255, 154, 86, 0.4);
        }

        .badge-encourage {
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
          color: white;
          box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .radar-card-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #e5d4c1;
        }

        .stat-item {
          text-align: center;
        }

        .stat-label {
          font-size: 11px;
          color: #95a5a6;
          margin-bottom: 4px;
          font-weight: 600;
        }

        .stat-value {
          font-size: 18px;
          font-weight: 700;
          color: #495057;
        }

        .stat-value.excellent {
          color: #4facfe;
        }

        .stat-value.good {
          color: #ffd700;
        }

        .stat-value.normal {
          color: #ff9a56;
        }

        .stat-value.encourage {
          color: #ff6b6b;
        }

        .stat-grade {
          font-size: 11px;
          font-weight: 600;
          margin-top: 4px;
        }

        .stat-item .stat-grade.excellent {
          color: #4facfe;
        }

        .stat-item .stat-grade.good {
          color: #ffd700;
        }

        .stat-item .stat-grade.normal {
          color: #ff9a56;
        }

        .stat-item .stat-grade.encourage {
          color: #ff6b6b;
        }

        canvas {
          max-width: 100%;
          height: auto;
        }

        /* ì‹œë¦¬ì¦ˆ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
        .series-selector {
          position: absolute;
          top: 30px;
          left: 30px;
          z-index: 100;
        }

        .series-dropdown {
          position: relative;
        }

        .series-button {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 12px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
          transition: all 0.3s ease;
        }

        .series-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        .series-button .arrow {
          transition: transform 0.3s ease;
        }

        .series-button.active .arrow {
          transform: rotate(180deg);
        }

        .series-menu {
          position: absolute;
          top: calc(100% + 8px);
          left: 0;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
          min-width: 200px;
          overflow: hidden;
          display: none;
        }

        .series-menu.show {
          display: block;
          animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
          from {
            opacity: 0;
            transform: translateY(-10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .series-item {
          padding: 14px 20px;
          cursor: pointer;
          transition: all 0.2s ease;
          border-bottom: 1px solid #f0f0f0;
          font-size: 14px;
          font-weight: 500;
          color: #2c3e50;
        }

        .series-item:last-child {
          border-bottom: none;
        }

        .series-item:hover {
          background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf3 100%);
        }

        .series-item.active {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          color: white;
          font-weight: 700;
        }

        /* ì‹œë¦¬ì¦ˆ ìš”ì•½ ë°•ìŠ¤ */
        .series-summary {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin: 30px 0 40px;
        }

        .summary-card {
          background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
          border: 2px solid transparent;
          transition: all 0.3s ease;
        }

        .summary-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .summary-card.average {
          border-color: #4facfe;
        }

        .summary-card.progress {
          border-color: #43e97b;
        }

        .summary-label {
          font-size: 14px;
          color: #7f8c8d;
          font-weight: 600;
          margin-bottom: 12px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .summary-value {
          font-size: 36px;
          font-weight: 800;
          margin-bottom: 8px;
        }

        .summary-card.average .summary-value {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }

        .summary-card.progress .summary-value {
          background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }

        .summary-subtext {
          font-size: 13px;
          color: #95a5a6;
        }

        .total-progress-title {
          font-size: 24px;
          font-weight: 700;
          margin-bottom: 20px;
          color: #2c3e50;
        }

        /* Today í•™ìŠµ ê¸°ë¡ ì„¹ì…˜ */
        .today-section {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 20px;
          padding: 20px 30px 30px 30px;
          margin: 30px 0;
          box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .today-section .section-title {
          color: white;
          font-size: 28px;
          font-weight: 700;
          text-align: center;
          margin-bottom: 8px;
        }

        .today-section .section-description {
          color: rgba(255,255,255,0.8);
          text-align: center;
          margin-bottom: 20px;
        }

        #todayTableContainer {
          background: rgba(255,255,255,0.95);
          border-radius: 16px;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .today-table {
          width: 100%;
          border-collapse: collapse;
        }

        .today-table th {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          color: white;
          padding: 14px 12px;
          font-size: 13px;
          font-weight: 600;
        }

        .today-table td {
          padding: 12px;
          text-align: center;
          border-bottom: 1px solid #e5e7eb;
          font-size: 13px;
        }

        .today-table td:nth-child(4) {
          text-align: left;
        }

        .today-table tbody tr:hover {
          background: #f0f9ff;
        }

        /* ì•„ì´íŒ¨ë“œ ì„¸ë¡œëª¨ë“œ: Today í•™ìŠµ ê¸°ë¡ í…Œì´ë¸” ìµœì í™” */
        @media (max-width: 850px) {
          /* ì‹œë¦¬ì¦ˆ ì»¬ëŸ¼ ìˆ¨ê¸°ê¸° (2ë²ˆì§¸ ì»¬ëŸ¼) */
          .today-table th:nth-child(2),
          .today-table td:nth-child(2) {
            display: none;
          }
          /* ë¶„ì•¼ ì»¬ëŸ¼ */
          .today-table th:nth-child(3),
          .today-table td:nth-child(3) {
            min-width: 65px;
            padding: 10px 8px;
          }
          /* ë“±ê¸‰ ì»¬ëŸ¼ - ì‘ì€ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
          .today-table th:nth-child(5),
          .today-table td:nth-child(5) {
            min-width: 45px;
            padding: 8px 4px;
          }
          .today-table td:nth-child(5) .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
          }
          /* ë‹¨ì›ëª… í°íŠ¸ ì‚´ì§ ì¤„ì´ê¸° */
          .today-table td:nth-child(4) {
            font-size: 12px;
          }
        }

        .today-no-data {
          text-align: center;
          padding: 40px;
          color: rgba(255,255,255,0.8);
          font-size: 16px;
        }

        /* AI í”¼ë“œë°± ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .ai-feedback-box {
          background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
          border-radius: 12px;
          padding: 15px;
          border: 1px solid rgba(255,255,255,0.2);
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .ai-feedback-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 10px;
          padding-bottom: 8px;
          border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .ai-feedback-icon {
          font-size: 20px;
        }
        .ai-feedback-title {
          color: #FFD54F;
          font-size: 14px;
          font-weight: 600;
        }
        .ai-feedback-content {
          color: white;
          font-size: 14px;
          line-height: 1.7;
          white-space: pre-wrap;
        }
        .ai-feedback-loading {
          color: rgba(255,255,255,0.7);
          font-style: italic;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .ai-feedback-loading::before {
          content: "";
          width: 16px;
          height: 16px;
          border: 2px solid rgba(255,255,255,0.3);
          border-top-color: #FFD54F;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .ai-feedback-error {
          color: #ff9999;
        }

        /* í†µí•© AI í”¼ë“œë°± ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .ai-feedback-section {
          background: linear-gradient(135deg, rgba(107, 79, 160, 0.95) 0%, rgba(139, 111, 192, 0.95) 100%);
          border-radius: 16px;
          padding: 20px;
          border: 1px solid rgba(255,255,255,0.2);
          box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .ai-feedback-section-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
          padding-bottom: 12px;
          border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        .ai-feedback-section-title {
          color: #FFD54F;
          font-size: 18px;
          font-weight: 700;
        }
        .ai-feedback-loading-box {
          text-align: center;
          padding: 20px;
        }
        .ai-feedback-all-content {
          display: flex;
          flex-direction: column;
          gap: 15px;
        }
        .ai-feedback-item {
          background: rgba(255,255,255,0.08);
          border-radius: 12px;
          padding: 15px;
          border-left: 3px solid #FFD54F;
        }
        .ai-feedback-item-title {
          color: #FFD54F;
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 10px;
        }
        .ai-feedback-item-content {
          color: white;
          font-size: 14px;
          line-height: 1.8;
        }
        .ai-feedback-item {
          position: relative;
        }
        .ai-feedback-edit-btn {
          position: absolute;
          bottom: 8px;
          right: 8px;
          background: rgba(255,255,255,0.15);
          border: 1px solid rgba(255,255,255,0.3);
          color: rgba(255,255,255,0.7);
          font-size: 11px;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s;
        }
        .ai-feedback-edit-btn:hover {
          background: rgba(255,255,255,0.25);
          color: white;
        }
        .ai-feedback-textarea {
          width: 100%;
          min-height: 80px;
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.3);
          border-radius: 8px;
          color: white;
          font-size: 14px;
          line-height: 1.8;
          padding: 10px;
          resize: vertical;
          font-family: inherit;
        }
        .ai-feedback-textarea:focus {
          outline: none;
          border-color: #FFD54F;
        }
        .ai-feedback-edit-actions {
          display: flex;
          justify-content: flex-end;
          gap: 8px;
          margin-top: 8px;
        }
        .ai-feedback-save-btn {
          background: #FFD54F;
          color: #333;
          border: none;
          padding: 5px 12px;
          border-radius: 4px;
          font-size: 12px;
          cursor: pointer;
          font-weight: 600;
        }
        .ai-feedback-cancel-btn {
          background: rgba(255,255,255,0.2);
          color: white;
          border: none;
          padding: 5px 12px;
          border-radius: 4px;
          font-size: 12px;
          cursor: pointer;
          white-space: pre-wrap;
        }
        .ai-feedback-bottom-actions {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          gap: 12px;
          margin-top: 20px;
          padding-top: 15px;
          border-top: 1px solid rgba(255,255,255,0.1);
        }
        .ai-feedback-edit-all-btn {
          background: rgba(255,255,255,0.15);
          border: 1px solid rgba(255,255,255,0.3);
          color: rgba(255,255,255,0.9);
          font-size: 13px;
          padding: 8px 20px;
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s;
          font-weight: 500;
        }
        .ai-feedback-edit-all-btn:hover {
          background: rgba(255,255,255,0.25);
          color: white;
        }
        .ai-feedback-save-actions {
          display: flex;
          gap: 10px;
        }
        .ai-feedback-cancel-all-btn {
          background: rgba(255,255,255,0.2);
          color: white;
          border: none;
          padding: 8px 20px;
          border-radius: 6px;
          font-size: 13px;
          cursor: pointer;
          font-weight: 500;
          transition: all 0.2s;
        }
        .ai-feedback-cancel-all-btn:hover {
          background: rgba(255,255,255,0.3);
        }
        .ai-feedback-save-all-btn {
          background: #FFD54F;
          color: #333;
          border: none;
          padding: 8px 20px;
          border-radius: 6px;
          font-size: 13px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.2s;
        }
        .ai-feedback-save-all-btn:hover {
          background: #FFCA28;
        }

        /* Today ë¯¸ë‹ˆ ë ˆì´ë” ì¹´ë“œ */
        .today-radar-section {
          margin-top: 25px;
        }

        .today-radar-title {
          color: white;
          font-size: 18px;
          font-weight: 700;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .today-radar-slider {
          display: flex;
          align-items: center;
          gap: 10px;
          position: relative;
        }

        .today-radar-viewport {
          flex: 1;
          overflow: hidden;
          position: relative;
        }

        #today-radar-wrap {
          display: flex;
          flex-wrap: nowrap;
          gap: 15px;
          justify-content: flex-start;
          transition: transform 0.3s ease;
        }

        .slider-arrow {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: none;
          background: rgba(255, 255, 255, 0.9);
          color: #667eea;
          font-size: 18px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          transition: all 0.3s ease;
          flex-shrink: 0;
        }

        .slider-arrow:hover {
          background: #667eea;
          color: white;
          transform: scale(1.1);
        }

        .slider-arrow:disabled {
          opacity: 0.3;
          cursor: not-allowed;
          transform: none;
        }

        .slider-arrow:disabled:hover {
          background: rgba(255, 255, 255, 0.9);
          color: #667eea;
        }

        #today-radar-wrap .radar-card {
          flex: 0 0 180px;
          min-width: 180px;
          padding: 12px;
          border-radius: 16px;
          background: linear-gradient(135deg, #ffffff 0%, #fffaf3 100%);
          border: 2px solid #e5d4c1;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          position: relative;
          overflow: hidden;
        }

        #today-radar-wrap .radar-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        #today-radar-wrap .radar-card canvas {
          width: 130px !important;
          height: 130px !important;
          display: block;
          margin: 0 auto;
        }

        #today-radar-wrap .radar-card-header {
          margin-bottom: 8px;
          text-align: center;
        }

        #today-radar-wrap .radar-card-title {
          font-size: 12px;
          font-weight: 700;
          color: #2c3e50;
          margin-bottom: 4px;
          line-height: 1.3;
        }

        #today-radar-wrap .radar-card-time {
          font-size: 10px;
          color: #95a5a6;
          margin-bottom: 4px;
        }

        #today-radar-wrap .score-badge,
        .today-radar-grid .score-badge {
          display: inline-block;
          padding: 3px 10px;
          border-radius: 10px;
          font-size: 9px;
          font-weight: 700;
          letter-spacing: 0.5px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        #today-radar-wrap .score-badge.badge-excellent,
        .today-radar-grid .score-badge.badge-excellent {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        #today-radar-wrap .score-badge.badge-good,
        .today-radar-grid .score-badge.badge-good {
          background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
          color: white;
        }

        #today-radar-wrap .score-badge.badge-normal,
        .today-radar-grid .score-badge.badge-normal {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
        }

        #today-radar-wrap .score-badge.badge-encourage,
        .today-radar-grid .score-badge.badge-encourage {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
          color: white;
        }

        #today-radar-wrap .radar-card-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid #f0f0f0;
          font-size: 10px;
        }

        #today-radar-wrap .stat-item {
          text-align: center;
        }

        #today-radar-wrap .stat-label {
          color: #95a5a6;
          font-size: 9px;
        }

        #today-radar-wrap .stat-value {
          font-weight: 700;
          font-size: 12px;
          color: #667eea;
        }

        .today-empty-cards {
          background: rgba(255,255,255,0.2);
          border-radius: 12px;
          padding: 30px;
          text-align: center;
          color: rgba(255,255,255,0.8);
          font-size: 14px;
        }

        /* ì „ì²´ ë³´ê¸° í† ê¸€ ë²„íŠ¼ */
        .today-radar-toggle-wrap {
          text-align: center;
          margin-top: 15px;
        }

        .today-radar-toggle-btn {
          background: rgba(255, 255, 255, 0.2);
          border: 2px solid rgba(255, 255, 255, 0.4);
          color: white;
          padding: 8px 24px;
          border-radius: 20px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .today-radar-toggle-btn:hover {
          background: rgba(255, 255, 255, 0.3);
          border-color: rgba(255, 255, 255, 0.6);
          transform: translateY(-2px);
        }

        #todayRadarToggleIcon {
          display: inline-block;
          transition: transform 0.3s ease;
        }

        .today-radar-toggle-btn.expanded #todayRadarToggleIcon {
          transform: rotate(180deg);
        }

        /* ì „ì²´ ë³´ê¸° ê·¸ë¦¬ë“œ */
        .today-radar-grid {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
          justify-content: center;
          margin-top: 20px;
          padding: 20px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 16px;
        }

        .today-radar-grid .radar-card {
          flex: 0 0 180px;
          min-width: 180px;
          padding: 12px;
          border-radius: 16px;
          background: linear-gradient(135deg, #ffffff 0%, #fffaf3 100%);
          border: 2px solid #e5d4c1;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          position: relative;
          overflow: hidden;
        }

        .today-radar-grid .radar-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .today-radar-grid .radar-card canvas {
          width: 130px !important;
          height: 130px !important;
          display: block;
          margin: 0 auto;
        }

        .today-radar-grid .radar-card-header {
          margin-bottom: 8px;
          text-align: center;
        }

        .today-radar-grid .radar-card-title {
          font-size: 12px;
          font-weight: 700;
          color: #2c3e50;
          margin-bottom: 4px;
          line-height: 1.3;
        }

        .today-radar-grid .radar-card-time {
          font-size: 10px;
          color: #95a5a6;
          margin-bottom: 4px;
        }

        .today-radar-grid .radar-card-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid #f0f0f0;
          font-size: 10px;
        }

        .today-radar-grid .stat-item {
          text-align: center;
        }

        .today-radar-grid .stat-label {
          color: #95a5a6;
          font-size: 9px;
        }

        .today-radar-grid .stat-value {
          font-weight: 700;
          font-size: 12px;
          color: #667eea;
        }

        /* ì§€ìˆ˜ë³„ ì¶”ì´ êº¾ì€ì„  ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ */
        .index-trend-chart-container {
          background: #fff;
          border-radius: 16px;
          padding: 20px;
          margin-top: 15px;
          border: none;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .index-trend-chart-container canvas {
          width: 100% !important;
          height: 300px !important;
        }

        .index-trend-legend {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 15px;
          margin-bottom: 15px;
          padding: 10px;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
        }

        .index-trend-legend-item {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 12px;
          color: #333;
          background: rgba(255,255,255,0.9);
          padding: 4px 10px;
          border-radius: 12px;
          transition: all 0.3s ease;
          cursor: pointer;
        }

        .index-trend-legend-item:hover {
          transform: scale(1.05);
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .index-trend-legend-item.active {
          transform: scale(1.1);
          box-shadow: 0 4px 12px rgba(0,0,0,0.25);
          font-weight: 700;
        }

        .index-trend-legend-item.dimmed {
          opacity: 0.4;
          transform: scale(0.95);
        }

        .index-trend-legend-color {
          width: 12px;
          height: 12px;
          border-radius: 3px;
        }

        .index-trend-legend-label {
          font-weight: 500;
        }

        .index-trend-no-data {
          text-align: center;
          color: rgba(255,255,255,0.7);
          padding: 40px 20px;
          font-size: 14px;
        }

        /* ê³¼ëª©ë³„ ë§‰ëŒ€ ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ */
        .subject-bar-legend {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 8px;
          margin-bottom: 10px;
          padding: 10px;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
        }

        .subject-bar-legend-item {
          display: flex;
          align-items: center;
          gap: 4px;
          font-size: 10px;
          color: #333;
          background: rgba(255,255,255,0.9);
          padding: 3px 8px;
          border-radius: 10px;
        }

        .subject-bar-legend-color {
          width: 10px;
          height: 10px;
          border-radius: 2px;
        }

        .subject-bar-chart-container {
          background: rgba(255,255,255,0.95);
          border-radius: 12px;
          padding: 15px;
        }

        .nav-arrow-btn:hover {
          background: rgba(255,255,255,0.25) !important;
          transform: scale(1.1);
        }

        .nav-arrow-btn:disabled {
          opacity: 0.3;
          cursor: not-allowed;
        }
      </style>
    </head>
    <body>
      <!-- ğŸ”„ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
      <div id="loading-overlay">
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="loading-text">AI ì¸ì‹ ì¤‘...</div>
        </div>
      </div>

      <div class="container">
        <!-- ì‹œë¦¬ì¦ˆ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <div class="series-selector">
          <div class="series-dropdown">
            <button class="series-button" id="seriesButton">
              <span id="currentSeries">ì „ì²´ ì‹œë¦¬ì¦ˆ</span>
              <span class="arrow">â–¼</span>
            </button>
            <div class="series-menu" id="seriesMenu">
              <div class="series-item active" data-series="all">ì „ì²´ ì‹œë¦¬ì¦ˆ</div>
              <div class="series-item" data-series="BRAINì˜¨">BRAINì˜¨</div>
              <div class="series-item" data-series="BRAINì—…">BRAINì—…</div>
              <div class="series-item" data-series="BRAINí•">BRAINí•</div>
              <div class="series-item" data-series="BRAINë”¥">BRAINë”¥</div>
              <div class="series-item" data-series="BRAINì¤‘ë“±">BRAINì‹¤ì „</div>
            </div>
          </div>
        </div>

        <div class="header">
          <h1>ë‚˜ì˜ AI í•™ìŠµ ë¶„ì„</h1>
          <div class="subtitle">${grade} ${name} í•™ìƒ</div>
        </div>

        <div style="text-align: center;">
          <span class="stats-badge" id="logCountBadge" style="font-size: 20px; padding: 16px 36px;">ğŸ“š ì´ ${logs.length}ê±´ì˜ í•™ìŠµ ê¸°ë¡</span>
          <div style="margin-top: 5px; display: flex; justify-content: center; gap: 20px;">
            <span class="stats-badge" style="background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); color: white;" id="normalLearningCount">ğŸ“– ì¼ë°˜í•™ìŠµ 0ê±´</span>
            <span class="stats-badge" style="background: linear-gradient(135deg, #a855f7 0%, #6b21a8 100%); color: white;" id="aiLearningCount">ğŸ¤– AIì¶”ì²œí•™ìŠµ 0ê±´</span>
          </div>
        </div>

        <!-- âœ¨ Today ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡ ì„¹ì…˜ -->
        <div class="today-section">
          <!-- ì£¼ê°„/ì¼ê°„ í† ê¸€ ë²„íŠ¼ -->
          <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button id="weeklyToggleBtn" onclick="toggleWeeklyMode()" style="
              background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
              border: 2px solid rgba(255,255,255,0.4);
              color: #fff;
              padding: 10px 20px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              gap: 8px;
              backdrop-filter: blur(10px);
            ">
              <span id="weeklyToggleIcon">ğŸ“…</span>
              <span id="weeklyToggleText">ì£¼ê°„ë¦¬í¬íŠ¸</span>
            </button>
          </div>
          <div class="section-title"><span id="calendarIcon" onclick="openCalendarPopup()" style="cursor:pointer;">ğŸ“…</span> <span id="sectionTitleText">Today ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡</span></div>
          <p class="section-description" id="todayDescription">ì˜¤ëŠ˜ ì™„ë£Œí•œ í•™ìŠµ ê¸°ë¡ì…ë‹ˆë‹¤.</p>

          <!-- ë‹¬ë ¥ íŒì—… -->
          <div id="calendarPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
            <div style="background:#fff; border-radius:16px; padding:24px; max-width:380px; width:90%; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <button onclick="changeCalendarMonth(-1)" style="background:#667eea; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:16px;">â®</button>
                <span id="calendarMonthDisplay" style="font-size:18px; font-weight:700; color:#333;"></span>
                <button onclick="changeCalendarMonth(1)" style="background:#667eea; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:16px;">â¯</button>
              </div>
              <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; text-align:center;"></div>
              <button onclick="closeCalendarPopup()" style="margin-top:16px; width:100%; background:#667eea; color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600;">ë‹«ê¸°</button>
            </div>
          </div>

          <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ (ì¼ê°„) -->
          <div id="dailyNavigator" class="date-navigator" style="display:flex; justify-content:center; align-items:center; gap:16px; margin-bottom:16px;">
            <button id="datePrevBtn" onclick="changeDate(-1)" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s;">â®</button>
            <span id="currentDateDisplay" style="color:#fff; font-size:18px; font-weight:600; min-width:140px; text-align:center;"></span>
            <button id="dateNextBtn" onclick="changeDate(1)" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s;">â¯</button>
          </div>
          <!-- ì£¼ê°„ ë„¤ë¹„ê²Œì´ì…˜ (ì£¼ê°„ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
          <div id="weeklyNavigator" class="date-navigator" style="display:none; justify-content:center; align-items:center; gap:16px; margin-bottom:16px;">
            <button id="weekPrevBtn" onclick="changeWeek(-1)" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s;">â®</button>
            <span id="currentWeekDisplay" style="color:#fff; font-size:18px; font-weight:600; min-width:280px; text-align:center;"></span>
            <button id="weekNextBtn" onclick="changeWeek(1)" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s;">â¯</button>
          </div>

          <div id="todayTableContainer">
            <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ -->
          </div>

          <!-- ì˜¤ëŠ˜ ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¯¸ë‹ˆ ë ˆì´ë” ì¹´ë“œ -->
          <div class="today-radar-section">
            <div class="today-radar-title" id="radarSectionTitle">ğŸ“Š ì˜¤ëŠ˜ ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”</div>
            <!-- ì£¼ê°„ ë ˆì´ë” ë„¤ë¹„ê²Œì´ì…˜ (ì£¼ê°„ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
            <div id="weeklyRadarNavigator" style="display:none; justify-content:center; align-items:center; gap:16px; margin-bottom:16px;">
              <button id="weekRadarPrevBtn" onclick="changeWeekRadar(-1)" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s;">â®</button>
              <span id="currentWeekRadarDisplay" style="color:#fff; font-size:16px; font-weight:600; min-width:280px; text-align:center;"></span>
              <button id="weekRadarNextBtn" onclick="changeWeekRadar(1)" style="background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:20px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s;">â¯</button>
            </div>
            <div class="today-radar-slider" id="todayRadarSlider">
              <button class="slider-arrow slider-prev" id="todayRadarPrev" onclick="slideTodayRadar(-1)">â®</button>
              <div class="today-radar-viewport">
                <div id="today-radar-wrap">
                  <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ -->
                </div>
              </div>
              <button class="slider-arrow slider-next" id="todayRadarNext" onclick="slideTodayRadar(1)">â¯</button>
            </div>
            <!-- ì „ì²´ ë³´ê¸° í† ê¸€ -->
            <div class="today-radar-toggle-wrap" id="todayRadarToggleWrap">
              <button class="today-radar-toggle-btn" id="todayRadarToggle" onclick="toggleTodayRadarView()">
                <span id="todayRadarToggleText">ì „ì²´ ë³´ê¸°</span> <span id="todayRadarToggleIcon">â–¼</span>
              </button>
            </div>
            <!-- ì „ì²´ ë³´ê¸° ê·¸ë¦¬ë“œ -->
            <div class="today-radar-grid" id="todayRadarGrid" style="display: none;">
              <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ -->
            </div>

          </div>

          <!-- ì§€ìˆ˜ë³„ ì¶”ì´ êº¾ì€ì„  ê·¸ë˜í”„ ì„¹ì…˜ (ë³´ë¼ìƒ‰ ë°°ê²½ ë‚´ë¶€) -->
          <div class="index-trend-section" id="indexTrendSection" style="margin-top: 20px; display: none;">
            <div class="today-radar-title">ğŸ“ˆ ë‚ ì§œë³„ ë¬¸í•´ë ¥ ì„±ì¥ ì§€ìˆ˜ ë³€í™”</div>
            <p class="section-description" style="color: rgba(255,255,255,0.8); margin-bottom: 10px; text-align: left;">
              ì¼ë³„ í•™ìŠµì—ì„œ ì¸¡ì •ëœ 5ê°€ì§€ ë¬¸í•´ë ¥ ì§€ìˆ˜ì˜ í‰ê·  ì¶”ì´ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </p>
            <div class="index-trend-legend" id="indexTrendLegend">
              <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ - ìƒë‹¨ ë²”ë¡€ -->
            </div>
            <div class="index-trend-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0;">
              <button id="indexTrendPrev" class="nav-arrow-btn" style="background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;">â—€</button>
              <span id="indexTrendDateRange" style="color: #fff; font-size: 14px; font-weight: 500;"></span>
              <button id="indexTrendNext" class="nav-arrow-btn" style="background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;">â–¶</button>
            </div>
            <div class="index-trend-chart-container">
              <canvas id="indexTrendChart"></canvas>
            </div>
          </div>

          <!-- ë‚ ì§œë³„ ê³¼ëª© í‰ê·  í‰ì  ë§‰ëŒ€ ê·¸ë˜í”„ ì„¹ì…˜ -->
          <div class="subject-bar-section" id="subjectBarSection" style="margin-top: 30px; display: none;">
            <div class="today-radar-title">ğŸ“Š ë‚ ì§œë³„ ê³¼ëª© í‰ê·  í‰ì </div>
            <p class="section-description" style="color: rgba(255,255,255,0.8); margin-bottom: 10px; text-align: left;">
              ë‚ ì§œë³„ë¡œ ì™„ë£Œí•œ ê° ê³¼ëª©ì˜ í‰ê·  í‰ì ì„ í™•ì¸í•˜ì„¸ìš”.
            </p>
            <div class="subject-bar-legend" id="subjectBarLegend">
              <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ - ê³¼ëª©ë³„ ìƒ‰ìƒ ë²”ë¡€ -->
            </div>
            <div class="subject-bar-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0;">
              <button id="subjectBarPrev" class="nav-arrow-btn" style="background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;">â—€</button>
              <span id="subjectBarDateRange" style="color: #fff; font-size: 14px; font-weight: 500;"></span>
              <button id="subjectBarNext" class="nav-arrow-btn" style="background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;">â–¶</button>
            </div>
            <div class="subject-bar-chart-container" style="height: 300px; position: relative;">
              <canvas id="subjectBarChart"></canvas>
            </div>
          </div>

          <!-- ë‚ ì§œë³„ ì–´íœ˜ ì ìˆ˜ ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ ì„¹ì…˜ -->
          <div class="vocab-score-section" id="vocabScoreSection" style="margin-top: 30px; display: none;">
            <div class="today-radar-title">ğŸ“ ë‚ ì§œë³„ ì–´íœ˜ ì ìˆ˜</div>
            <p class="section-description" style="color: rgba(255,255,255,0.8); margin-bottom: 10px; text-align: left;">
              ê° ë‹¨ì›ë³„ ì–´íœ˜ í€´ì¦ˆ ì ìˆ˜ë¥¼ í‰ê· ê³¼ ë¹„êµí•´ ë³´ì„¸ìš”.
            </p>
            <div class="vocab-score-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0;">
              <button id="vocabScorePrev" class="nav-arrow-btn" style="background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;">â—€</button>
              <span id="vocabScoreDate" style="color: #fff; font-size: 14px; font-weight: 500;"></span>
              <button id="vocabScoreNext" class="nav-arrow-btn" style="background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;">â–¶</button>
            </div>
            <div class="vocab-score-chart-container" id="vocabScoreChartContainer" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px;">
              <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ -->
            </div>
          </div>

          <!-- ì°½ì˜í™œë™ ë‚´ì—­ ì„¹ì…˜ -->
          <div class="record-section creative-section" style="margin-top: 25px;">
            <div class="record-section-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
              <span style="font-size: 20px; line-height: 1;">âœï¸</span>
              <span class="section-title" style="color: #fff; font-size: 16px; font-weight: 600; line-height: 1;">ì°½ì˜í™œë™ ë‚´ì—­</span>
            </div>
            <p class="section-desc" style="color: rgba(255,255,255,0.7); font-size: 13px; margin-bottom: 15px;">ì œì¶œëœ ì°½ì˜í™œë™ ê¸€ì“°ê¸° ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”.</p>

            <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="creative-nav" style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0;">
              <button id="creativePrev" class="creative-nav-btn">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M8 10L4 6L8 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <span id="creativeDate" class="creative-date-display"></span>
              <button id="creativeNext" class="creative-nav-btn">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M4 2L8 6L4 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>

            <!-- ì°½ì˜í™œë™ í…Œì´ë¸” -->
            <div id="creativeTableContainer" class="creative-table-container">
              <table class="creative-table">
                <thead>
                  <tr>
                    <th style="width: 50px;">ë²ˆí˜¸</th>
                    <th style="width: 85px;">ì‘ì„±ì¼</th>
                    <th style="width: 100px;">ë‹¨ì›ëª…</th>
                    <th>ì£¼ì œ</th>
                    <th style="width: 70px;">ê¸€ììˆ˜</th>
                  </tr>
                </thead>
                <tbody id="creativeTableBody">
                  <!-- JavaScriptì—ì„œ ë™ì  ë Œë”ë§ -->
                </tbody>
              </table>
            </div>
          </div>

          <style>
            /* ì°½ì˜í™œë™ í…Œì´ë¸” ì„¸ë ¨ëœ ë””ìì¸ */
            .creative-section .creative-nav-btn {
              background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
              border: 1px solid rgba(255,255,255,0.2);
              border-radius: 50%;
              width: 38px;
              height: 38px;
              color: #fff;
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              justify-content: center;
              backdrop-filter: blur(10px);
            }
            .creative-section .creative-nav-btn:hover {
              background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
              transform: scale(1.1);
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
            .creative-section .creative-date-display {
              color: #fff;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(135deg, rgba(102,126,234,0.3) 0%, rgba(118,75,162,0.3) 100%);
              padding: 10px 24px;
              border-radius: 25px;
              border: 1px solid rgba(255,255,255,0.15);
              backdrop-filter: blur(10px);
              letter-spacing: 0.5px;
            }
            .creative-table-container {
              background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
              border-radius: 16px;
              padding: 0;
              overflow: hidden;
              border: 1px solid rgba(0,0,0,0.08);
              box-shadow: 0 8px 32px rgba(0,0,0,0.1);
              margin: 0 20px;
            }
            .creative-table {
              width: 100%;
              border-collapse: collapse;
              color: #333;
              font-size: 14px;
              table-layout: fixed;
            }
            .creative-table thead tr {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .creative-table thead th {
              padding: 16px 12px;
              text-align: center;
              font-weight: 600;
              font-size: 13px;
              color: #fff;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              border-bottom: none;
            }
            .creative-table tbody tr.creative-row {
              transition: all 0.25s ease;
              cursor: pointer;
              border-bottom: 1px solid rgba(0,0,0,0.06);
            }
            .creative-table tbody tr.creative-row:hover {
              background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            }
            .creative-table tbody tr.creative-row:last-child {
              border-bottom: none;
            }
            .creative-table tbody td {
              padding: 14px 12px;
              color: #333;
            }
            .creative-table .creative-num {
              text-align: center;
              font-weight: 500;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            }
            .creative-table .creative-arrow {
              font-size: 10px;
              color: #667eea;
              transition: all 0.3s ease;
            }
            .creative-table .creative-date {
              text-align: center;
              font-weight: 500;
              color: #667eea;
              font-size: 13px;
            }
            .creative-table .creative-unit {
              text-align: center;
              font-weight: 500;
              color: #444;
            }
            .creative-table .creative-topic {
              text-align: left;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              padding-left: 16px;
            }
            .creative-table .creative-chars {
              text-align: center;
              font-weight: 600;
              background: linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%);
              border-radius: 20px;
              padding: 4px 0;
              margin: 0 8px;
              font-size: 13px;
            }
            /* ë“œë¡­ë‹¤ìš´ ë‚´ìš© í–‰ */
            .creative-table .creative-content-row {
              background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
            }
            .creative-table .creative-content-row td {
              padding: 0;
            }
            .creative-content-box {
              padding: 20px 24px;
              margin: 12px 16px;
              background: #fff;
              border-radius: 12px;
              border-left: 4px solid linear-gradient(180deg, #667eea 0%, #764ba2 100%);
              border-left: 4px solid #667eea;
              box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }
            .creative-content-label {
              font-size: 12px;
              color: #667eea;
              font-weight: 600;
              margin-bottom: 10px;
              display: flex;
              align-items: center;
              gap: 6px;
            }
            .creative-content-text {
              font-size: 14px;
              line-height: 1.9;
              color: #333;
              white-space: pre-wrap;
              word-break: break-word;
              text-align: left;
            }
            /* ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ */
            .creative-table .creative-empty {
              text-align: center;
              padding: 40px 20px;
              color: #888;
              font-size: 14px;
            }
          </style>

          <!-- í†µí•© AI í”¼ë“œë°± ì˜ì—­: í•˜ë‹¨ì— 4ê°œ ì„¹ì…˜ ëª¨ë‘ í‘œì‹œ -->
          <div id="aiFeedbackSection" class="ai-feedback-section" style="margin-top: 25px; display: none;">
            <div class="ai-feedback-section-header">
              <span class="ai-feedback-icon">ğŸŒŸ</span>
              <span id="aiFeedbackMainTitle" class="ai-feedback-section-title">ì˜¤ëŠ˜ì˜ í•™ìŠµ ë¶„ì„</span>
            </div>
            <div class="ai-feedback-loading-box" id="aiFeedbackLoading">
              <div class="ai-feedback-loading">AI ì„ ìƒë‹˜ì´ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>
            </div>
            <div id="aiFeedbackContent" class="ai-feedback-all-content" style="display: none;">
              <!-- ì„¹ì…˜ 1: ì˜¤ëŠ˜ í•™ìŠµ ìš”ì•½ -->
              <div class="ai-feedback-item">
                <div id="feedbackTitle1" class="ai-feedback-item-title">ğŸ“š ì˜¤ëŠ˜ì˜ í•™ìŠµ ê¸°ë¡</div>
                <div id="feedbackContent1" class="ai-feedback-item-content"></div>
              </div>
              <!-- ì„¹ì…˜ 2: ë ˆì´ë” ì°¨íŠ¸ (ìˆ¨ê¹€) -->
              <!--
              <div class="ai-feedback-item">
                <div class="ai-feedback-item-title">ğŸ“Š ë¬¸í•´ë ¥ AI ë ˆì´ë” ë¶„ì„</div>
                <div id="feedbackContent2" class="ai-feedback-item-content"></div>
              </div>
              -->
              <!-- ì„¹ì…˜ 3: ì„±ì¥ ì§€ìˆ˜ -->
              <div class="ai-feedback-item">
                <div class="ai-feedback-item-title">ğŸ“ˆ ì„±ì¥ ì§€ìˆ˜ ë³€í™”</div>
                <div id="feedbackContent3" class="ai-feedback-item-content"></div>
              </div>
              <!-- ì„¹ì…˜ 4: ê³¼ëª©ë³„ ì ìˆ˜ -->
              <div class="ai-feedback-item">
                <div class="ai-feedback-item-title">ğŸ¯ ê³¼ëª©ë³„ ì ìˆ˜ ë¶„ì„</div>
                <div id="feedbackContent4" class="ai-feedback-item-content"></div>
              </div>
              <!-- ì„¹ì…˜ 5: ì–´íœ˜ ì ìˆ˜ í”¼ë“œë°± -->
              <div class="ai-feedback-item">
                <div class="ai-feedback-item-title">ğŸ“ ì–´íœ˜ ì ìˆ˜ ë¶„ì„</div>
                <div id="feedbackContent5" class="ai-feedback-item-content"></div>
              </div>
              <!-- í•˜ë‹¨ í†µí•© ìˆ˜ì •/ì €ì¥ ë²„íŠ¼ -->
              <div class="ai-feedback-bottom-actions" id="feedbackBottomActions">
                <button class="ai-feedback-edit-all-btn" id="editAllBtn" onclick="editAllFeedback()">ìˆ˜ì •</button>
                <div class="ai-feedback-save-actions" id="saveActions" style="display: none;">
                  <button class="ai-feedback-cancel-all-btn" onclick="cancelAllFeedback()">ì·¨ì†Œ</button>
                  <button class="ai-feedback-save-all-btn" onclick="saveAllFeedback()">ì €ì¥</button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- ì„¸ë¶€ AI ìƒì„¸ í•™ìŠµ ë‚´ì—­ ë³´ê¸° ë²„íŠ¼ (ë³´ë¼ìƒ‰ ë°°ê²½ ë°–) -->
        <div style="text-align: center; margin-top: 30px; padding-bottom: 20px;">
          <button id="toggleDetailedLogBtn" onclick="toggleDetailedLog()" style="
            background: linear-gradient(135deg, #6B4FA0 0%, #8B6FC0 100%);
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(107,79,160,0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
          ">
            <span id="toggleDetailedLogIcon">â–¼</span>
            <span id="toggleDetailedLogText">ì„¸ë¶€ AI ìƒì„¸ í•™ìŠµ ë‚´ì—­ ë³´ê¸°</span>
          </button>
        </div>

        <!-- ì„¸ë¶€ í•™ìŠµ ë‚´ì—­ ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) -->
        <div id="detailedLogSection" style="display: none;">

        <div class="section-header">
          <div class="section-title" style="margin: 0;">
            ğŸ“ ì¢…í•© í•™ìŠµ ê¸°ë¡ ëª©ë¡
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div class="search-box">
              <span class="search-icon">ğŸ”</span>
              <input type="text" id="logSearch" placeholder="ë‹¨ì›ëª… ë˜ëŠ” ë“±ê¸‰ ê²€ìƒ‰..." oninput="searchLogs(this.value)">
              <button class="clear-btn" id="logSearchClear" onclick="clearLogSearch()">âœ•</button>
            </div>
          </div>
        </div>
        <p class="section-description">
          ëª¨ë“  í•™ìŠµ í™œë™ì´ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>ê³¼ëª©</th>
                <th style="cursor: pointer;" onclick="sortByAIAssignDate()" id="aiDateHeader">
                  ë‚ ì§œ/ì‹œê°„<br/><small style="font-weight: normal; color: rgba(255,255,255,0.8);">(AIê³¼ì œë¶€ì—¬)</small>
                  <span id="aiSortIcon" style="margin-left: 4px;">â‡…</span>
                </th>
                <th style="cursor: pointer;" onclick="sortByFinalDate()" id="finalDateHeader">
                  ë‚ ì§œ/ì‹œê°„<br/><small style="font-weight: normal; color: rgba(255,255,255,0.8);">(ìµœì¢…)</small>
                  <span id="finalSortIcon" style="margin-left: 4px;">â‡…</span>
                </th>
                <th style="cursor: pointer;" onclick="sortByGrade()" id="gradeHeader">
                  ë“±ê¸‰
                  <span id="gradeSortIcon" style="margin-left: 4px;">â‡…</span>
                </th>
                <th>ì‹œë¦¬ì¦ˆ</th>
                <th>ë‹¨ì›ëª…</th>
              </tr>
            </thead>
            <tbody id="logTableBody">
            </tbody>
          </table>
        </div>
        <button class="toggle-btn" id="toggleBtn" onclick="toggleRows()" style="display:none;">ë”ë³´ê¸° â–¼</button>

        <hr>

        <div class="section-title">
          ğŸ“Š ì§„ë„ìœ¨
        </div>
        <p class="section-description">
          ì‹œë¦¬ì¦ˆ ì „ì²´ ì§„ë„ìœ¨ê³¼ ë¶„ì•¼ë³„/ê³¼ëª©ë³„ ì§„ë„ìœ¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="progress-section">
          <!-- Total Series Progress -->
          <div class="total-progress-card">
            <div class="total-progress-title" style="color: white !important; font-size: 32px !important;">ğŸ¯ ì „ì²´ ì‹œë¦¬ì¦ˆ ì§„ë„ìœ¨</div>
            <div class="total-progress-bar-container">
              <div class="total-progress-bar" id="totalProgressBar" style="width: 0%;">
                <span id="totalProgressPercent">0%</span>
              </div>
            </div>
            <div class="total-progress-text" id="totalProgressText">
              <span id="totalProgressTextCount">0 / 400</span>
              <span style="margin-left: 12px; font-weight: 900;" id="totalProgressTextPercent">(0%)</span>
            </div>
          </div>

          <!-- Field Progress Grid -->
          <div class="field-progress-grid">
            <!-- Science Field -->
            <div class="field-progress-card science">
              <div class="field-title">
                <div class="field-title-text">ğŸ”¬ ê³¼í•™ë¶„ì•¼</div>
                <div class="field-percent science" id="scienceFieldPercent">0%</div>
              </div>
              <div class="field-progress-bar-container">
                <div class="field-progress-bar science" id="scienceFieldBar" style="width: 0%;"></div>
              </div>
              <div class="field-progress-text" id="scienceFieldText">0 / 80</div>
              <div class="subject-list">
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ìƒë¬¼</span>
                    <span id="bioPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar science" id="bioBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì§€êµ¬ê³¼í•™</span>
                    <span id="earthPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar science" id="earthBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ë¬¼ë¦¬</span>
                    <span id="physicsPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar science" id="physicsBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>í™”í•™</span>
                    <span id="chemPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar science" id="chemBar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Society Field -->
            <div class="field-progress-card society">
              <div class="field-title">
                <div class="field-title-text">ğŸŒ ì‚¬íšŒë¶„ì•¼</div>
                <div class="field-percent society" id="societyFieldPercent">0%</div>
              </div>
              <div class="field-progress-bar-container">
                <div class="field-progress-bar society" id="societyFieldBar" style="width: 0%;"></div>
              </div>
              <div class="field-progress-text" id="societyFieldText">0 / 80</div>
              <div class="subject-list">
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì‚¬íšŒë¬¸í™”</span>
                    <span id="socPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar society" id="socBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì§€ë¦¬</span>
                    <span id="geoPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar society" id="geoBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ë²•</span>
                    <span id="lawPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar society" id="lawBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì •ì¹˜ê²½ì œ</span>
                    <span id="polPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar society" id="polBar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Korean Literature Field -->
            <div class="field-progress-card korean-lit">
              <div class="field-title">
                <div class="field-title-text">ğŸ“š í•œêµ­ë¬¸í•™</div>
                <div class="field-percent korean-lit" id="koreanLitFieldPercent">0%</div>
              </div>
              <div class="field-progress-bar-container">
                <div class="field-progress-bar korean-lit" id="koreanLitFieldBar" style="width: 0%;"></div>
              </div>
              <div class="field-progress-text" id="koreanLitFieldText">0 / 80</div>
              <div class="subject-list">
                <div class="subject-item">
                  <div class="subject-title">
                    <span>í˜„ëŒ€ë¬¸í•™</span>
                    <span id="modernPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar korean-lit" id="modernBar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ê³ ì „ë¬¸í•™</span>
                    <span id="classicPercent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar korean-lit" id="classicBar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- World Literature Field -->
            <div class="field-progress-card world-lit">
              <div class="field-title">
                <div class="field-title-text">ğŸŒ ì„¸ê³„ë¬¸í•™</div>
                <div class="field-percent world-lit" id="worldLitFieldPercent">0%</div>
              </div>
              <div class="field-progress-bar-container">
                <div class="field-progress-bar world-lit" id="worldLitFieldBar" style="width: 0%;"></div>
              </div>
              <div class="field-progress-text" id="worldLitFieldText">0 / 80</div>
              <div class="subject-list">
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì„¸ê³„ë¬¸í•™(1)</span>
                    <span id="world1Percent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar world-lit" id="world1Bar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì„¸ê³„ë¬¸í•™(2)</span>
                    <span id="world2Percent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar world-lit" id="world2Bar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Person Field -->
            <div class="field-progress-card person">
              <div class="field-title">
                <div class="field-title-text">ğŸ‘¤ ì¸ë¬¼ë¶„ì•¼</div>
                <div class="field-percent person" id="personFieldPercent">0%</div>
              </div>
              <div class="field-progress-bar-container">
                <div class="field-progress-bar person" id="personFieldBar" style="width: 0%;"></div>
              </div>
              <div class="field-progress-text" id="personFieldText">0 / 80</div>
              <div class="subject-list">
                <div class="subject-item">
                  <div class="subject-title">
                    <span>í•œêµ­ì¸ë¬¼</span>
                    <span id="person1Percent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar person" id="person1Bar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="subject-item">
                  <div class="subject-title">
                    <span>ì„¸ê³„ì¸ë¬¼</span>
                    <span id="person2Percent">0%</span>
                  </div>
                  <div class="subject-progress-bar-container">
                    <div class="subject-progress-bar person" id="person2Bar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <div class="section-title">
          ğŸ† ì‹œë¦¬ì¦ˆ ì¢…í•© ë ˆì´ë”
        </div>
        <p class="section-description">
          ì „ì²´ ì‹œë¦¬ì¦ˆì˜ ëª¨ë“  í•™ìŠµ ë°ì´í„°ë¥¼ í†µí•©í•œ ìµœì¢… ë ˆì´ë”ì…ë‹ˆë‹¤.<br/>
          (â€» radar ë°ì´í„°ê°€ ìˆëŠ” ê¸°ë¡ë“¤ë§Œ í‰ê· ì— í¬í•¨ë©ë‹ˆë‹¤.)
        </p>

        <div id="series-radar-wrap"></div>

        <hr>

        <div class="section-title">
          ğŸ“š ë¶„ì•¼ë³„ ì¢…í•© ë ˆì´ë”
        </div>
        <p class="section-description">
          ë¶„ì•¼ë³„ë¡œ ëª¨ë“  í•™ìŠµ ë°ì´í„°ì˜ í‰ê· ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.<br/>
          (â€» radar ë°ì´í„°ê°€ ìˆëŠ” ê¸°ë¡ë“¤ë§Œ í‰ê· ì— í¬í•¨ë©ë‹ˆë‹¤.)
        </p>

        <div id="field-radar-wrap"></div>

        <hr>

        <div class="section-header">
          <div class="section-title" style="margin: 0;">
            ğŸ“Š ê³¼ëª©ë³„ ì¢…í•© ë ˆì´ë”
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div class="grade-filter">
              <span class="filter-icon">ğŸ·ï¸</span>
              <select id="subjectGradeFilter" onchange="filterSubjectRadarByGrade(this.value)">
                <option value="all">ì „ì²´ ë“±ê¸‰</option>
                <option value="ê²©ë ¤">ê²©ë ¤</option>
                <option value="ë³´í†µ">ë³´í†µ</option>
                <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                <option value="ìš°ìˆ˜">ìš°ìˆ˜</option>
              </select>
            </div>
            <div class="search-box">
              <span class="search-icon">ğŸ”</span>
              <input type="text" id="subjectSearch" placeholder="ê³¼ëª©ëª… ê²€ìƒ‰..." oninput="searchSubjectRadar(this.value)">
              <button class="clear-btn" id="subjectSearchClear" onclick="clearSubjectSearch()">âœ•</button>
            </div>
          </div>
        </div>
        <p class="section-description">
          ê³¼ëª©ë³„ë¡œ ëª¨ë“  í•™ìŠµ ë°ì´í„°ì˜ í‰ê· ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.<br/>
          (â€» radar ë°ì´í„°ê°€ ìˆëŠ” ê¸°ë¡ë“¤ë§Œ í‰ê· ì— í¬í•¨ë©ë‹ˆë‹¤.)
        </p>

        <div id="summary-radar-wrap"></div>
        <button class="toggle-btn" id="toggleSummaryBtn" onclick="toggleSummaryRadar()" style="display:none;">ë”ë³´ê¸° â–¼</button>

        <hr>

        <div class="section-header">
          <div class="section-title" style="margin: 0;">
            ğŸ§  ë‹¨ì›ë³„ ë¬¸í•´ë ¥ ë ˆì´ë” ì°¨íŠ¸
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div class="grade-filter">
              <span class="filter-icon">ğŸ·ï¸</span>
              <select id="unitGradeFilter" onchange="filterUnitRadarByGrade(this.value)">
                <option value="all">ì „ì²´ ë“±ê¸‰</option>
                <option value="ê²©ë ¤">ê²©ë ¤</option>
                <option value="ë³´í†µ">ë³´í†µ</option>
                <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                <option value="ìš°ìˆ˜">ìš°ìˆ˜</option>
              </select>
            </div>
            <div class="search-box">
              <span class="search-icon">ğŸ”</span>
              <input type="text" id="unitSearch" placeholder="ë‹¨ì›ëª… ê²€ìƒ‰..." oninput="searchUnitRadar(this.value)">
              <button class="clear-btn" id="unitSearchClear" onclick="clearUnitSearch()">âœ•</button>
            </div>
          </div>
        </div>
        <p class="section-description">
          ê°€ì¥ ìµœê·¼ ê¸°ë¡ì´ ìœ„ì— ì˜¤ë„ë¡ ì •ë ¬ë˜ì–´ ìˆì–´ìš”.<br/>
          (â€» ì•„ì§ radar ë°ì´í„°ê°€ ì—†ëŠ” ê¸°ë¡ì€ ê·¸ë˜í”„ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
        </p>

        <div id="radar-wrap"></div>
        <button class="toggle-btn" id="toggleRadarBtn" onclick="toggleRadar()" style="display:none;">ë”ë³´ê¸° â–¼</button>
      </div>
      </div><!-- detailedLogSection ë‹«ê¸° -->

      <!-- í˜•ì„±í‰ê°€ ê´€ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
      <div id="gateDetailModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#fff; border-radius:20px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
          <div style="padding:24px 28px; border-bottom:1px solid #e9ecef; display:flex; justify-content:space-between; align-items:center;">
            <h3 id="gateModalTitle" style="font-size:20px; font-weight:700; color:#212529; margin:0;">ê´€ë¬¸ ìƒì„¸ ì •ë³´</h3>
            <button onclick="closeGateDetailModal()" style="width:36px; height:36px; border:none; background:#f1f3f5; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
          </div>
          <div id="gateModalBody" style="padding:28px;">
            <div style="text-align:center; padding:40px; color:#495057;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
      <script>
        // datalabels í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
        Chart.register(ChartDataLabels);

        // ===== í˜•ì„±í‰ê°€ ê´€ë¬¸ ìƒì„¸ ëª¨ë‹¬ í•¨ìˆ˜ =====
        async function showGateDetailModal(gate) {
          const modal = document.getElementById('gateDetailModal');
          const modalTitle = document.getElementById('gateModalTitle');
          const modalBody = document.getElementById('gateModalBody');

          const grade = '${grade}';
          const name = '${name}';

          modalTitle.textContent = 'ê´€ë¬¸ ' + gate + ' ìƒì„¸ ì •ë³´';
          modalBody.innerHTML = '<div style="text-align:center; padding:40px; color:#495057;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
          modal.style.display = 'flex';

          try {
            const res = await fetch('/api/gate-quiz/details?grade=' + encodeURIComponent(grade) + '&name=' + encodeURIComponent(name) + '&gate=' + gate);
            const result = await res.json();

            if (result.ok) {
              renderGateDetailModal(result.data, gate);
            } else {
              modalBody.innerHTML = '<div style="text-align:center; padding:40px; color:#868e96;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
          } catch (err) {
            console.error('ê´€ë¬¸ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', err);
            modalBody.innerHTML = '<div style="text-align:center; padding:40px; color:#868e96;">ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
          }
        }

        function renderGateDetailModal(data, gate) {
          const modalBody = document.getElementById('gateModalBody');

          if (data.totalAttempts === 0) {
            modalBody.innerHTML = '<div style="text-align:center; padding:40px; color:#868e96;"><p>ì•„ì§ ìƒì„¸ ì‹œë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p><p style="font-size:12px; color:#adb5bd; margin-top:8px;">(ìƒˆë¡œìš´ í˜•ì„±í‰ê°€ í’€ì´ë¶€í„° ê¸°ë¡ë©ë‹ˆë‹¤)</p></div>';
            return;
          }

          const formatTime = (seconds) => {
            if (!seconds) return '0ì´ˆ';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) return mins + 'ë¶„ ' + secs + 'ì´ˆ';
            return secs + 'ì´ˆ';
          };

          const passedDate = data.passedAt ? new Date(data.passedAt).toLocaleDateString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
          }) : '-';

          const getIndexName = (qType) => qType === 'q2' ? 'êµ¬ì¡°íŒŒì•…ë ¥' : 'í•µì‹¬ì´í•´ë ¥';

          let weakestQuestionsHtml = '';
          let questionDetailsHtml = '';

          if (data.questionDetails && data.questionDetails.length > 0) {
            const validQuestions = data.questionDetails.filter(q => q.questionNo != null && !isNaN(q.questionNo));

            // ê°€ì¥ ë¯¸í¡í•œ ë¬¸í•­ 2ê°œ ì„ ì •
            const sortedByWeakness = [...validQuestions].sort((a, b) => {
              if (b.cumulativeWrongClicks !== a.cumulativeWrongClicks) return b.cumulativeWrongClicks - a.cumulativeWrongClicks;
              if (b.cumulativeTime !== a.cumulativeTime) return b.cumulativeTime - a.cumulativeTime;
              if (a.qType !== b.qType) return a.qType === 'q2' ? -1 : 1;
              return 0;
            });

            const weakestTwo = sortedByWeakness.slice(0, 2);
            const weakestQuestionNos = new Set(weakestTwo.map(q => q.questionNo));

            if (weakestTwo.length > 0) {
              weakestQuestionsHtml = '<div style="margin-bottom:24px;"><div style="font-size:14px; font-weight:600; color:#dc3545; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #ffcdd2;">âš ï¸ ê°€ì¥ ë¯¸í¡í•œ ë¬¸í•­ (ìƒìœ„ ' + weakestTwo.length + 'ê°œ)</div><div style="font-size:11px; color:#868e96; margin-bottom:8px;">í´ë¦­í•˜ë©´ ë¬¸ì œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div><table style="width:100%; border-collapse:collapse; border:2px solid #ffcdd2; border-radius:8px; overflow:hidden;"><thead style="background:#ffebee;"><tr><th style="padding:10px 12px; text-align:center; font-size:13px; color:#c62828;">ë¬¸í•­</th><th style="padding:10px 12px; text-align:center; font-size:13px; color:#c62828;">ë‹¨ì›ëª…</th><th style="padding:10px 12px; text-align:center; font-size:13px; color:#c62828;">ì§€ìˆ˜</th><th style="padding:10px 12px; text-align:center; font-size:13px; color:#c62828;">ëˆ„ì  ì‹œê°„</th><th style="padding:10px 12px; text-align:center; font-size:13px; color:#c62828;">ëˆ„ì  ì˜¤ë‹µ</th></tr></thead><tbody>';
              weakestTwo.forEach(q => {
                const indexBg = q.qType === 'q2' ? '#e3f2fd' : '#fff3e0';
                const indexColor = q.qType === 'q2' ? '#1565c0' : '#e65100';
                weakestQuestionsHtml += '<tr style="background:#fff8f8; cursor:pointer; transition:all 0.2s;" onclick="showQuestionDetail(\\'' + (q.unitCode || '') + '\\', \\'' + (q.qType || 'q1') + '\\', ' + q.questionNo + ')" onmouseover="this.style.background=\\'#ffe8e8\\'" onmouseout="this.style.background=\\'#fff8f8\\'"><td style="padding:10px 12px; text-align:center; font-weight:600; color:#c62828; border-bottom:1px solid #e9ecef;">ë¬¸í•­ ' + q.questionNo + '</td><td style="padding:10px 12px; text-align:center; font-size:11px; border-bottom:1px solid #e9ecef;">' + (q.unitTitle || q.unitCode || '-') + '</td><td style="padding:10px 12px; text-align:center; border-bottom:1px solid #e9ecef;"><span style="display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; background:' + indexBg + '; color:' + indexColor + ';">' + getIndexName(q.qType) + '</span></td><td style="padding:10px 12px; text-align:center; font-weight:600; border-bottom:1px solid #e9ecef;">' + formatTime(q.cumulativeTime) + '</td><td style="padding:10px 12px; text-align:center; font-weight:600; color:#c62828; border-bottom:1px solid #e9ecef;">' + q.cumulativeWrongClicks + 'íšŒ</td></tr>';
              });
              weakestQuestionsHtml += '</tbody></table></div>';
            }

            questionDetailsHtml = '<div style="margin-bottom:24px;"><div style="font-size:14px; font-weight:600; color:#495057; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #e9ecef;">ê° ë¬¸í•­ë³„ ëˆ„ì  ê¸°ë¡</div><div style="font-size:11px; color:#868e96; margin-bottom:8px;">í´ë¦­í•˜ë©´ ë¬¸ì œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div><table style="width:100%; border-collapse:collapse;"><thead style="background:#f8f9fa;"><tr><th style="padding:10px 12px; text-align:center; font-size:13px; font-weight:600; color:#495057;">ë¬¸í•­</th><th style="padding:10px 12px; text-align:center; font-size:13px; font-weight:600; color:#495057;">ë‹¨ì›ëª…</th><th style="padding:10px 12px; text-align:center; font-size:13px; font-weight:600; color:#495057;">ì§€ìˆ˜</th><th style="padding:10px 12px; text-align:center; font-size:13px; font-weight:600; color:#495057;">ëˆ„ì  ì‹œê°„</th><th style="padding:10px 12px; text-align:center; font-size:13px; font-weight:600; color:#495057;">ëˆ„ì  ì˜¤ë‹µ</th></tr></thead><tbody>';
            validQuestions.sort((a, b) => a.questionNo - b.questionNo).forEach(q => {
              const isWeak = weakestQuestionNos.has(q.questionNo);
              const rowBg = isWeak ? '#fff8f8' : '#ffffff';
              const rowHoverBg = isWeak ? '#ffe8e8' : '#f8f9fa';
              const cellStyle = isWeak ? 'color:#c62828; font-weight:600;' : '';
              const indexBg = q.qType === 'q2' ? '#e3f2fd' : '#fff3e0';
              const indexColor = q.qType === 'q2' ? '#1565c0' : '#e65100';
              questionDetailsHtml += '<tr style="background:' + rowBg + '; cursor:pointer; transition:all 0.2s;" onclick="showQuestionDetail(\\'' + (q.unitCode || '') + '\\', \\'' + (q.qType || 'q1') + '\\', ' + q.questionNo + ')" onmouseover="this.style.background=\\'' + rowHoverBg + '\\'" onmouseout="this.style.background=\\'' + rowBg + '\\'"><td style="padding:10px 12px; text-align:center; border-bottom:1px solid #e9ecef; ' + cellStyle + '">ë¬¸í•­ ' + q.questionNo + '</td><td style="padding:10px 12px; text-align:center; font-size:11px; border-bottom:1px solid #e9ecef;">' + (q.unitTitle || q.unitCode || '-') + '</td><td style="padding:10px 12px; text-align:center; border-bottom:1px solid #e9ecef;"><span style="display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; background:' + indexBg + '; color:' + indexColor + ';">' + getIndexName(q.qType) + '</span></td><td style="padding:10px 12px; text-align:center; border-bottom:1px solid #e9ecef;">' + formatTime(q.cumulativeTime) + '</td><td style="padding:10px 12px; text-align:center; border-bottom:1px solid #e9ecef; ' + cellStyle + '">' + q.cumulativeWrongClicks + 'íšŒ</td></tr>';
            });
            questionDetailsHtml += '</tbody></table></div>';
          }

          modalBody.innerHTML = '<div style="margin-bottom:24px;"><div style="font-size:14px; font-weight:600; color:#495057; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #e9ecef;">ìš”ì•½ ì •ë³´</div><div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;"><div style="background:#f8f9fa; border-radius:12px; padding:16px;"><div style="font-size:12px; color:#868e96; margin-bottom:4px;">ì¬ë„ì „ íšŸìˆ˜</div><div style="font-size:18px; font-weight:700; color:#495057;">' + data.retryCount + 'íšŒ</div></div><div style="background:#f8f9fa; border-radius:12px; padding:16px;"><div style="font-size:12px; color:#868e96; margin-bottom:4px;">ì´ ì‹œë„ íšŸìˆ˜</div><div style="font-size:18px; font-weight:700; color:#212529;">' + data.totalAttempts + 'íšŒ</div></div><div style="background:#f8f9fa; border-radius:12px; padding:16px;"><div style="font-size:12px; color:#868e96; margin-bottom:4px;">ëˆ„ì  ì „ì²´ í’€ì´ ì‹œê°„</div><div style="font-size:18px; font-weight:700; color:#212529;">' + formatTime(data.cumulativeTime) + '</div></div><div style="background:#f8f9fa; border-radius:12px; padding:16px;"><div style="font-size:12px; color:#868e96; margin-bottom:4px;">ëˆ„ì  ì „ì²´ ì˜¤ë‹µ í´ë¦­</div><div style="font-size:18px; font-weight:700; color:#212529;">' + data.cumulativeWrongClicks + 'íšŒ</div></div></div></div>' + (data.finalAttempt ? '<div style="margin-bottom:24px;"><div style="font-size:14px; font-weight:600; color:#495057; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #e9ecef;">ìµœì¢… ì‹œë„ (' + (data.finalAttempt.passed ? 'í†µê³¼' : 'ë¯¸í†µê³¼') + ')</div><div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;"><div style="background:#f8f9fa; border-radius:12px; padding:16px;"><div style="font-size:12px; color:#868e96; margin-bottom:4px;">ìµœì¢… í’€ì´ ì‹œê°„</div><div style="font-size:18px; font-weight:700; color:#212529;">' + formatTime(data.finalAttempt.totalTime) + '</div></div><div style="background:#f8f9fa; border-radius:12px; padding:16px;"><div style="font-size:12px; color:#868e96; margin-bottom:4px;">ìµœì¢… ì˜¤ë‹µ í´ë¦­</div><div style="font-size:18px; font-weight:700; color:#212529;">' + data.finalAttempt.totalWrongClicks + 'íšŒ</div></div></div></div>' : '') + weakestQuestionsHtml + questionDetailsHtml + '<div style="margin-bottom:0;"><div style="font-size:14px; font-weight:600; color:#495057; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #e9ecef;">í†µê³¼ ë‚ ì§œ</div><div style="background:#f8f9fa; border-radius:12px; padding:16px; text-align:center;"><div style="font-size:18px; font-weight:700; color:#212529;">' + passedDate + '</div></div></div>';
        }

        function closeGateDetailModal() {
          document.getElementById('gateDetailModal').style.display = 'none';
        }

        // ë¬¸ì œ ìƒì„¸ ë³´ê¸° íŒì—…
        async function showQuestionDetail(unitCode, qType, questionNo) {
          if (!unitCode) {
            alert('ë¬¸ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // ê¸°ì¡´ íŒì—…ì´ ìˆìœ¼ë©´ ì œê±°
          const existingPopup = document.getElementById('questionDetailPopup');
          if (existingPopup) existingPopup.remove();

          // íŒì—… ìƒì„±
          const popup = document.createElement('div');
          popup.id = 'questionDetailPopup';
          popup.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:10001; padding:20px;';
          popup.innerHTML = '<div style="background:white; border-radius:20px; max-width:600px; width:100%; max-height:80vh; overflow-y:auto; padding:24px; position:relative;"><div style="text-align:center; padding:40px; color:#868e96;">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>';
          document.body.appendChild(popup);

          // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          popup.addEventListener('click', function(e) {
            if (e.target === popup) {
              popup.remove();
            }
          });

          try {
            const response = await fetch('/api/gate-quiz/question?unitCode=' + encodeURIComponent(unitCode) + '&qType=' + encodeURIComponent(qType));
            const result = await response.json();

            if (!result.ok) {
              popup.querySelector('div > div').innerHTML = '<div style="text-align:center; padding:40px; color:#dc3545;"><p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><p style="font-size:12px; margin-top:8px;">' + (result.message || '') + '</p><button onclick="this.closest(\\'#questionDetailPopup\\').remove()" style="margin-top:16px; padding:10px 24px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button></div>';
              return;
            }

            const data = result.data;
            const indexName = data.qType === 'q2' ? 'êµ¬ì¡°íŒŒì•…ë ¥' : 'í•µì‹¬ì´í•´ë ¥';
            const indexBg = data.qType === 'q2' ? '#e3f2fd' : '#fff3e0';
            const indexColor = data.qType === 'q2' ? '#1565c0' : '#e65100';

            let optionsHtml = data.options.map((opt, idx) => {
              const symbol = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][idx];
              return '<div style="padding:12px 16px; border-radius:10px; margin-bottom:8px; border:2px solid; background:#f8f9fa; border-color:#dee2e6;"><span style="font-weight:600; margin-right:8px;">' + symbol + '</span>' + opt + '</div>';
            }).join('');

            const correctSymbol = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][data.correct - 1];
            const correctText = data.options[data.correct - 1];
            const answerHtml = '<div style="margin-top:20px; background:linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border:2px solid #28a745; border-radius:12px; padding:16px;"><div style="font-size:14px; font-weight:600; color:#155724; margin-bottom:8px;">ì •ë‹µ: ' + correctSymbol + '</div><div style="font-size:14px; color:#155724; line-height:1.6;">' + correctText + '</div></div>';

            popup.querySelector('div').innerHTML = '<button onclick="this.closest(\\'#questionDetailPopup\\').remove()" style="position:absolute; top:16px; right:16px; width:32px; height:32px; border:none; background:#f8f9fa; border-radius:50%; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;">âœ•</button><div style="margin-bottom:20px;"><div style="font-size:18px; font-weight:700; color:#212529; margin-bottom:8px;">ë¬¸í•­ ' + questionNo + '</div><div style="font-size:14px; color:#495057; margin-bottom:8px;">' + data.unitTitle + '</div><span style="display:inline-block; padding:4px 12px; border-radius:12px; font-size:12px; background:' + indexBg + '; color:' + indexColor + ';">' + indexName + '</span></div>' + (data.passage && data.passage.length > 0 ? '<div style="margin-bottom:20px;"><div style="font-size:14px; font-weight:600; color:#495057; margin-bottom:12px;">ë³¸ë¬¸</div><div style="background:#fffaf5; padding:16px; border-radius:12px; border:1px solid #f0e0d0; max-height:500px; overflow-y:auto;"><p style="font-size:14px; color:#4a3728; line-height:1.8; margin:0;">' + data.passage.join('</p><p style="font-size:14px; color:#4a3728; line-height:1.8; margin-top:12px;">') + '</p></div></div>' : '') + '<div style="background:#faf8f6; padding:20px; border-radius:12px; margin-bottom:20px; border-left:4px solid #8b2f2f;"><p style="font-size:16px; color:#333; font-weight:600; line-height:1.7; margin:0;">' + data.question + '</p></div><div style="margin-bottom:0;"><div style="font-size:14px; font-weight:600; color:#495057; margin-bottom:12px;">ì„ ì§€</div>' + optionsHtml + answerHtml + '</div>';
          } catch (err) {
            console.error('ë¬¸ì œ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', err);
            popup.querySelector('div > div').innerHTML = '<div style="text-align:center; padding:40px; color:#dc3545;"><p>ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p><button onclick="this.closest(\\'#questionDetailPopup\\').remove()" style="margin-top:16px; padding:10px 24px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button></div>';
          }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('gateDetailModal').addEventListener('click', function(e) {
          if (e.target.id === 'gateDetailModal') {
            closeGateDetailModal();
          }
        });

        // ===== í†µí•© AI í”¼ë“œë°± ë¡œë”© í•¨ìˆ˜ =====
        async function loadSingleFeedback(section, contentId, data) {
          const content = document.getElementById(contentId);
          if (!content) return;

          try {
            const grade = '${grade}';
            const name = '${name}';

            const response = await fetch('/api/ai-learning-feedback', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ grade, name, section, data })
            });

            const result = await response.json();
            if (result.ok && result.feedback) {
              content.innerHTML = result.feedback;
            } else {
              content.innerHTML = 'í”¼ë“œë°±ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
          } catch (err) {
            console.error('AI í”¼ë“œë°± ì˜¤ë¥˜:', err);
            content.innerHTML = 'í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          }
        }

        // ===== AI í”¼ë“œë°± ì „ì²´ ìˆ˜ì • ê¸°ëŠ¥ =====
        let originalFeedbackContent = {};

        function editAllFeedback() {
          const editAllBtn = document.getElementById('editAllBtn');
          const saveActions = document.getElementById('saveActions');

          // 5ê°œ ì„¹ì…˜ ëª¨ë‘ textareaë¡œ ë³€í™˜
          for (let num = 1; num <= 5; num++) {
            const contentDiv = document.getElementById('feedbackContent' + num);
            if (!contentDiv) continue;

            // ì›ë³¸ ë‚´ìš© ì €ì¥
            originalFeedbackContent[num] = contentDiv.innerHTML;

            // textareaë¡œ ë³€í™˜
            const currentText = contentDiv.innerText;
            contentDiv.innerHTML = '<textarea class="ai-feedback-textarea" id="feedbackTextarea' + num + '">' + currentText + '</textarea>';
          }

          // ì „ì²´ ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¸°ê³  ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
          editAllBtn.style.display = 'none';
          saveActions.style.display = 'flex';
        }

        function saveAllFeedback() {
          const editAllBtn = document.getElementById('editAllBtn');
          const saveActions = document.getElementById('saveActions');

          // 5ê°œ ì„¹ì…˜ ëª¨ë‘ ì €ì¥
          for (let num = 1; num <= 5; num++) {
            const textarea = document.getElementById('feedbackTextarea' + num);
            const contentDiv = document.getElementById('feedbackContent' + num);
            if (!textarea || !contentDiv) continue;

            // ìˆ˜ì •ëœ ë‚´ìš© ì ìš©
            const newText = textarea.value;
            contentDiv.innerHTML = newText;
          }

          // ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê³  ì „ì²´ ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ
          saveActions.style.display = 'none';
          editAllBtn.style.display = 'inline-block';
        }

        function cancelAllFeedback() {
          const editAllBtn = document.getElementById('editAllBtn');
          const saveActions = document.getElementById('saveActions');

          // 5ê°œ ì„¹ì…˜ ëª¨ë‘ ì›ë³¸ ë³µì›
          for (let num = 1; num <= 5; num++) {
            const contentDiv = document.getElementById('feedbackContent' + num);
            if (!contentDiv || !originalFeedbackContent[num]) continue;

            // ì›ë³¸ ë‚´ìš© ë³µì›
            contentDiv.innerHTML = originalFeedbackContent[num];
          }

          // ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê³  ì „ì²´ ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ
          saveActions.style.display = 'none';
          editAllBtn.style.display = 'inline-block';
        }

        // í†µí•© AI í”¼ë“œë°± ì´ˆê¸°í™” í•¨ìˆ˜ (í˜ì´ì§€ ë¡œë“œ ì‹œ í˜¸ì¶œ, ì£¼ê°„ëª¨ë“œ ì „í™˜ ì‹œì—ë„ í˜¸ì¶œ)
        async function initAIFeedbacks(skipDelay = false) {
          const runFeedback = async () => {
            const feedbackSection = document.getElementById('aiFeedbackSection');
            const loadingBox = document.getElementById('aiFeedbackLoading');
            const contentBox = document.getElementById('aiFeedbackContent');
            const mainTitle = document.getElementById('aiFeedbackMainTitle');
            const title1 = document.getElementById('feedbackTitle1');

            if (!feedbackSection) return;

            // í”¼ë“œë°± ì„¹ì…˜ í‘œì‹œ
            feedbackSection.style.display = 'block';

            // ì£¼ê°„/ì¼ê°„ ëª¨ë“œì— ë”°ë¥¸ íƒ€ì´í‹€ ë³€ê²½
            if (mainTitle) {
              mainTitle.textContent = isWeeklyMode ? 'ì£¼ê°„ í•™ìŠµ ë¶„ì„' : 'ì˜¤ëŠ˜ì˜ í•™ìŠµ ë¶„ì„';
            }
            if (title1) {
              title1.textContent = isWeeklyMode ? 'ğŸ“š ì£¼ê°„ í•™ìŠµ ê¸°ë¡' : 'ğŸ“š ì˜¤ëŠ˜ì˜ í•™ìŠµ ê¸°ë¡';
            }

            // ë¡œë”© í‘œì‹œ
            loadingBox.style.display = 'block';
            contentBox.style.display = 'none';

            // ì£¼ê°„ ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
            let weekDateRange = '';
            if (isWeeklyMode) {
              const weekStart = new Date(selectedWeekStart);
              const weekEnd = getWeekEnd(weekStart);
              const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
              weekDateRange = formatShort(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';
            }

            // ===== 1. í•™ìŠµ ê¸°ë¡ ë°ì´í„° ìƒì„¸ ìˆ˜ì§‘ =====
            const tableContainer = document.getElementById('todayTableContainer');
            const noDataMsg = isWeeklyMode ? 'í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤' : 'ì˜¤ëŠ˜ ì™„ë£Œí•œ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤';
            const hasTableData = tableContainer && tableContainer.innerHTML.trim() !== '' && !tableContainer.innerHTML.includes(noDataMsg);

            const rows = document.querySelectorAll('#todayTableContainer tbody tr');
            const todayData = { completedCount: rows.length, units: [], grades: [], scores: [], fields: [], isWeeklyMode: isWeeklyMode, weekDateRange: weekDateRange };

            if (hasTableData && rows.length > 0) {
              rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                  const series = cells[1]?.textContent?.trim() || '';
                  const field = cells[2]?.textContent?.trim() || '';
                  const unitName = cells[3]?.textContent?.trim() || '';
                  const grade = cells[4]?.textContent?.trim() || '';
                  const avgScore = cells[5]?.textContent?.trim() || '';
                  const vocabScore = cells[6]?.textContent?.trim() || '';

                  todayData.units.push(unitName);
                  todayData.grades.push(grade);
                  todayData.scores.push(avgScore);
                  todayData.fields.push(field);
                }
              });
              // ìš”ì•½ ì •ë³´ ì¶”ê°€
              todayData.unitList = todayData.units.slice(0, 5).join(', ') + (todayData.units.length > 5 ? ' ì™¸ ' + (todayData.units.length - 5) + 'ê°œ' : '');
              todayData.gradesSummary = todayData.grades.join(', ');
              todayData.fieldsSummary = [...new Set(todayData.fields)].join(', ');
              todayData.avgScore = todayData.scores.length > 0 ?
                (todayData.scores.reduce((a, b) => a + parseFloat(b || 0), 0) / todayData.scores.length).toFixed(1) : '-';
            }

            // ===== 2. ë ˆì´ë” ì°¨íŠ¸ ìƒì„¸ ë°ì´í„° ìˆ˜ì§‘ =====
            const radarWrap = document.getElementById('today-radar-wrap');
            const radarCards = radarWrap ? radarWrap.querySelectorAll('.radar-card') : [];
            const radarData = { hasData: false, chartCount: radarCards.length, radarScores: [], isWeeklyMode: isWeeklyMode, weekDateRange: weekDateRange };

            if (radarCards.length > 0) {
              // ê° ë ˆì´ë” ì¹´ë“œì—ì„œ ë‹¨ì›ëª…ê³¼ ì ìˆ˜ ì •ë³´ ìˆ˜ì§‘
              radarCards.forEach(card => {
                const title = card.querySelector('.radar-card-title')?.textContent?.trim() || '';
                // ë ˆì´ë” ì ìˆ˜ ë°ì´í„° ì†ì„±ì—ì„œ ê°€ì ¸ì˜¤ê¸° (data-radar ì†ì„± í™œìš©)
                const radarAttr = card.getAttribute('data-radar');
                if (radarAttr) {
                  try {
                    const scores = JSON.parse(radarAttr);
                    radarData.radarScores.push({ unit: title, ...scores });
                  } catch (e) {}
                }
              });

              // í‰ê·  ë ˆì´ë” ì ìˆ˜ ê³„ì‚°
              if (radarData.radarScores.length > 0) {
                radarData.hasData = true;
                const avgRadar = { literal: 0, structural: 0, lexical: 0, inferential: 0, critical: 0 };
                radarData.radarScores.forEach(r => {
                  avgRadar.literal += (r.literal || 0);
                  avgRadar.structural += (r.structural || 0);
                  avgRadar.lexical += (r.lexical || 0);
                  avgRadar.inferential += (r.inferential || 0);
                  avgRadar.critical += (r.critical || 0);
                });
                const count = radarData.radarScores.length;
                radarData.avgLiteral = (avgRadar.literal / count).toFixed(0);
                radarData.avgStructural = (avgRadar.structural / count).toFixed(0);
                radarData.avgLexical = (avgRadar.lexical / count).toFixed(0);
                radarData.avgInferential = (avgRadar.inferential / count).toFixed(0);
                radarData.avgCritical = (avgRadar.critical / count).toFixed(0);

                // ê°€ì¥ ê°•í•œ/ì•½í•œ ì˜ì—­ ì°¾ê¸°
                const avgScores = [
                  { name: 'ì‚¬ì‹¤ì  ì´í•´', score: parseFloat(radarData.avgLiteral) },
                  { name: 'êµ¬ì¡°ì  ì´í•´', score: parseFloat(radarData.avgStructural) },
                  { name: 'ì–´íœ˜ë ¥', score: parseFloat(radarData.avgLexical) },
                  { name: 'ì¶”ë¡ ì  ì´í•´', score: parseFloat(radarData.avgInferential) },
                  { name: 'ë¹„íŒì  ì´í•´', score: parseFloat(radarData.avgCritical) }
                ];
                avgScores.sort((a, b) => b.score - a.score);
                radarData.strongestArea = avgScores[0]?.name + '(' + avgScores[0]?.score + 'ì )';
                radarData.weakestArea = avgScores[4]?.name + '(' + avgScores[4]?.score + 'ì )';
              }
            }

            // ===== 3. ì„±ì¥ ì§€ìˆ˜ ì°¨íŠ¸ ë°ì´í„° ìˆ˜ì§‘ (ì‹¤ì œ ì°¨íŠ¸ ë°ì´í„° ì‚¬ìš©) =====
            const growthData = { hasData: false, isWeeklyMode: isWeeklyMode, weekDateRange: weekDateRange };

            // ì°¨íŠ¸ì—ì„œ ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚¬ìš© (ì°¨íŠ¸ì™€ ì™„ì „ ë™ê¸°í™”)
            const chartGrowthData = window.chartDataForAI?.growthTrend;
            if (chartGrowthData && chartGrowthData.hasData) {
              const chartDates = chartGrowthData.dates;  // MM/DD í˜•ì‹
              const chartScores = chartGrowthData.scores.filter(s => s !== null);

              if (chartDates.length > 0 && chartScores.length > 0) {
                growthData.hasData = true;
                growthData.dateCount = chartDates.length;
                growthData.dates = chartDates.join(', ');
                growthData.scores = chartScores.map(s => s?.toFixed(0) || '-').join(', ');
                growthData.latestScore = chartScores[chartScores.length - 1]?.toFixed(0) || '-';
                growthData.firstScore = chartScores[0]?.toFixed(0) || '-';

                // ê°€ì¥ ë†’ì€/ë‚®ì€ ë‚ ì§œì™€ ì ìˆ˜ ì°¾ê¸°
                let maxIdx = 0, minIdx = 0;
                chartScores.forEach((s, i) => {
                  if (s > chartScores[maxIdx]) maxIdx = i;
                  if (s < chartScores[minIdx]) minIdx = i;
                });
                growthData.highestDate = chartDates[maxIdx];
                growthData.highestScore = chartScores[maxIdx]?.toFixed(0);
                growthData.lowestDate = chartDates[minIdx];
                growthData.lowestScore = chartScores[minIdx]?.toFixed(0);

                // ì„ íƒí•œ ë‚ ì§œê°€ ìµœê³ /ìµœì €ì¸ì§€ í™•ì¸ (MM/DD í˜•ì‹ìœ¼ë¡œ ë¹„êµ)
                const selectedMonth = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
                const selectedDay = selectedDate.getDate().toString().padStart(2, '0');
                const selectedMD = selectedMonth + '/' + selectedDay;

                growthData.isSelectedDateHighest = (chartDates[maxIdx] === selectedMD);
                growthData.isSelectedDateLowest = (chartDates[minIdx] === selectedMD);

                console.log('[AIí”¼ë“œë°±-ì„±ì¥ì§€ìˆ˜] ì°¨íŠ¸ë°ì´í„° ì‚¬ìš©:', chartDates, chartScores);
                console.log('[AIí”¼ë“œë°±-ì„±ì¥ì§€ìˆ˜] selectedMD:', selectedMD, 'highestDate:', chartDates[maxIdx], 'lowestDate:', chartDates[minIdx]);

                growthData.trend = chartScores.length >= 2 ?
                  (chartScores[chartScores.length - 1] > chartScores[0] ? 'ìƒìŠ¹' :
                   chartScores[chartScores.length - 1] < chartScores[0] ? 'í•˜ë½' : 'ìœ ì§€') : 'ë¶„ì„ì¤‘';

                // 5ê°€ì§€ ë¬¸í•´ë ¥ ì§€ìˆ˜ ë°ì´í„° ì¶”ê°€
                const indices = chartGrowthData.literacyIndices;
                if (indices) {
                  const indexNames = {
                    literal: 'í•µì‹¬ ì´í•´ë ¥',
                    critical: 'ë¹„íŒ ì ìš©ë ¥',
                    structural: 'êµ¬ì¡° íŒŒì•…ë ¥',
                    inferential: 'ì¶”ë¡  í†µí•©ë ¥',
                    lexical: 'ì–´íœ˜ ë§¥ë½ë ¥'
                  };
                  const indexArr = Object.entries(indices)
                    .filter(([k, v]) => v !== null && v !== undefined)
                    .map(([k, v]) => ({ key: k, name: indexNames[k], score: v }))
                    .sort((a, b) => b.score - a.score);

                  if (indexArr.length > 0) {
                    growthData.literacyIndices = indexArr;
                    growthData.strongestIndex = indexArr[0].name + '(' + indexArr[0].score.toFixed(1) + 'ì )';
                    growthData.weakestIndex = indexArr[indexArr.length - 1].name + '(' + indexArr[indexArr.length - 1].score.toFixed(1) + 'ì )';
                    growthData.indexList = indexArr.map(i => i.name + ' ' + i.score.toFixed(1) + 'ì ').join(', ');
                    console.log('[AIí”¼ë“œë°±-ì„±ì¥ì§€ìˆ˜] ë¬¸í•´ë ¥ì§€ìˆ˜:', growthData.indexList);
                  }
                }
              }
            }

            // ===== 4. ê³¼ëª©ë³„ ì ìˆ˜ ì°¨íŠ¸ ë°ì´í„° ìˆ˜ì§‘ (ì‹¤ì œ ì°¨íŠ¸ ë°ì´í„° ì‚¬ìš©) =====
            const subjectData = { hasData: false, isWeeklyMode: isWeeklyMode, weekDateRange: weekDateRange };

            // ì°¨íŠ¸ì—ì„œ ì €ì¥ëœ ê³¼ëª©ë³„ ë°ì´í„°ë¥¼ ì‚¬ìš© (ì°¨íŠ¸ì™€ ì™„ì „ ë™ê¸°í™”)
            const chartSubjectData = window.chartDataForAI?.subjectScores;
            if (chartSubjectData && chartSubjectData.hasData) {
              const chartDates = chartSubjectData.dates;  // MM/DD í˜•ì‹
              const chartSubjects = chartSubjectData.subjects;  // { ê³¼ëª©ëª…: í‰ê· ì ìˆ˜ }

              subjectData.hasData = true;
              subjectData.dates = chartDates.join(', ');

              // ê³¼ëª©ë³„ ì ìˆ˜ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ì—¬ ê°•ì /ì•½ì  ë¶„ì„
              const subjectArr = Object.entries(chartSubjects).map(([name, score]) => ({
                name,
                avgScore: score.toFixed(1)
              }));

              if (subjectArr.length > 0) {
                subjectArr.sort((a, b) => parseFloat(b.avgScore) - parseFloat(a.avgScore));
                subjectData.subjects = subjectArr;
                subjectData.strongSubject = subjectArr[0]?.name + '(' + subjectArr[0]?.avgScore + 'ì )';
                subjectData.weakSubject = subjectArr[subjectArr.length - 1]?.name + '(' + subjectArr[subjectArr.length - 1]?.avgScore + 'ì )';
                subjectData.subjectList = subjectArr.map(s => s.name + ' ' + s.avgScore + 'ì ').join(', ');

                // ì„±ì¥ ì§€ìˆ˜ ì°¨íŠ¸ì˜ ë‚ ì§œë³„ ì ìˆ˜ ë°ì´í„°ë¡œ ìµœê³ /ìµœì € ë‚ ì§œ ë¶„ì„
                const growthDates = window.chartDataForAI?.growthTrend?.dates || [];
                const growthScores = window.chartDataForAI?.growthTrend?.scores?.filter(s => s !== null) || [];

                if (growthDates.length > 0 && growthScores.length > 0) {
                  let maxIdx = 0, minIdx = 0;
                  growthScores.forEach((s, i) => {
                    if (s > growthScores[maxIdx]) maxIdx = i;
                    if (s < growthScores[minIdx]) minIdx = i;
                  });

                  subjectData.highestDate = growthDates[maxIdx];
                  subjectData.highestScore = growthScores[maxIdx]?.toFixed(0);
                  subjectData.lowestDate = growthDates[minIdx];
                  subjectData.lowestScore = growthScores[minIdx]?.toFixed(0);
                  subjectData.scores = growthScores.map(s => s?.toFixed(0) || '-').join(', ');

                  // ì„ íƒí•œ ë‚ ì§œê°€ ìµœê³ /ìµœì €ì¸ì§€ í™•ì¸
                  const selectedMonth = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
                  const selectedDay = selectedDate.getDate().toString().padStart(2, '0');
                  const selectedMD = selectedMonth + '/' + selectedDay;

                  subjectData.isSelectedDateHighest = (growthDates[maxIdx] === selectedMD);
                  subjectData.isSelectedDateLowest = (growthDates[minIdx] === selectedMD);

                  console.log('[AIí”¼ë“œë°±-ê³¼ëª©ë³„] ì°¨íŠ¸ë°ì´í„° ì‚¬ìš©:', chartSubjects);
                  console.log('[AIí”¼ë“œë°±-ê³¼ëª©ë³„] dates:', growthDates, 'scores:', growthScores.map(s => s?.toFixed(0)));
                }
              }
            }

            // ===== 5. ì–´íœ˜ ì ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ (í…Œì´ë¸”ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°) =====
            const vocabScoreData = { hasData: false, items: [], summary: {}, isWeeklyMode: isWeeklyMode, weekDateRange: weekDateRange };

            // ê³¼ëª©ë³„ í‰ê·  ì ìˆ˜ ì„¤ì •
            const vocabSubjectAvgScores = {
              'ìƒë¬¼': 78, 'ì§€êµ¬ê³¼í•™': 75, 'ë¬¼ë¦¬': 63, 'í™”í•™': 68,
              'ì‚¬íšŒ': 82, 'ì§€ë¦¬': 79, 'ë²•': 72, 'ì •ì¹˜': 74,
              'ê³ ì „ë¬¸í•™': 78, 'í˜„ëŒ€ë¬¸í•™': 84,
              'ì„¸ê³„ë¬¸í•™': 85, 'ì¸ë¬¼': 80
            };

            // ë‹¨ì›ëª…ì—ì„œ ê³¼ëª© ì¶”ì¶œ
            function getVocabSubjectFromName(unitName) {
              if (unitName.includes('ìƒë¬¼')) return 'ìƒë¬¼';
              if (unitName.includes('ì§€êµ¬ê³¼í•™')) return 'ì§€êµ¬ê³¼í•™';
              if (unitName.includes('ë¬¼ë¦¬')) return 'ë¬¼ë¦¬';
              if (unitName.includes('í™”í•™')) return 'í™”í•™';
              if (unitName.includes('ì‚¬íšŒ')) return 'ì‚¬íšŒ';
              if (unitName.includes('ì§€ë¦¬')) return 'ì§€ë¦¬';
              if (unitName.includes('ë²•')) return 'ë²•';
              if (unitName.includes('ì •ì¹˜')) return 'ì •ì¹˜';
              if (unitName.includes('ê³ ì „')) return 'ê³ ì „ë¬¸í•™';
              if (unitName.includes('í˜„ëŒ€')) return 'í˜„ëŒ€ë¬¸í•™';
              if (unitName.includes('ì„¸ê³„')) return 'ì„¸ê³„ë¬¸í•™';
              if (unitName.includes('ì¸ë¬¼')) return 'ì¸ë¬¼';
              return null;
            }

            // í…Œì´ë¸”ì—ì„œ ì–´íœ˜ ì ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ (rowsëŠ” DOM ìš”ì†Œ)
            let vocabAboveAvgCount = 0;
            let vocabBelowAvgCount = 0;
            let vocabTotalScore = 0;
            let vocabItemCount = 0;

            // í•´ë‹¹ ë‚ ì§œ/ì£¼ê°„ í…Œì´ë¸” í–‰ì—ì„œ ì–´íœ˜ ì ìˆ˜ ìˆ˜ì§‘
            rows.forEach(row => {
              const cells = row.querySelectorAll('td');
              if (cells.length >= 7) {
                const unitName = cells[3]?.textContent?.trim() || '';
                const vocabScoreText = cells[6]?.textContent?.trim() || '';

                console.log('[AIí”¼ë“œë°±-ì–´íœ˜] ë‹¨ì›:', unitName, 'ì–´íœ˜ì ìˆ˜í…ìŠ¤íŠ¸:', vocabScoreText);

                // ì–´íœ˜ ì ìˆ˜ íŒŒì‹± (ì˜ˆ: "100ì " -> 100)
                // replace ë°©ì‹ìœ¼ë¡œ ìˆ«ìë§Œ ì¶”ì¶œ (ì¸ì½”ë”© ë¬¸ì œ ë°©ì§€)
                let vocabScorePercent = 0;
                if (vocabScoreText && vocabScoreText !== '-') {
                  const numOnly = vocabScoreText.replace(/[^0-9]/g, '');
                  vocabScorePercent = numOnly ? parseInt(numOnly, 10) : 0;
                }

                console.log('[AIí”¼ë“œë°±-ì–´íœ˜] íŒŒì‹±ê²°ê³¼:', vocabScorePercent);

                if (vocabScorePercent > 0) {
                  const subject = getVocabSubjectFromName(unitName);
                  const avgScore = vocabSubjectAvgScores[subject] || 75;
                  const isAboveAvg = vocabScorePercent >= avgScore;

                  vocabScoreData.items.push({
                    unit: unitName,
                    score: vocabScorePercent,
                    avgScore: avgScore,
                    isAboveAvg: isAboveAvg
                  });

                  if (isAboveAvg) vocabAboveAvgCount++;
                  else vocabBelowAvgCount++;

                  vocabTotalScore += vocabScorePercent;
                  vocabItemCount++;
                }
              }
            });
            console.log('[AIí”¼ë“œë°±-ì–´íœ˜] ìµœì¢… vocabItemCount:', vocabItemCount, 'vocabScoreData:', JSON.stringify(vocabScoreData));

            if (vocabItemCount > 0) {
              vocabScoreData.hasData = true;
              vocabScoreData.summary = {
                totalCount: vocabItemCount,
                avgScore: Math.round(vocabTotalScore / vocabItemCount),
                aboveAvgCount: vocabAboveAvgCount,
                belowAvgCount: vocabBelowAvgCount,
                aboveAvgPercent: Math.round((vocabAboveAvgCount / vocabItemCount) * 100),
                itemsList: vocabScoreData.items.map(v => v.unit + ' ' + v.score + 'ì (í‰ê· :' + v.avgScore + ')').join(', ')
              };
            }

            // 4ê°œ í”¼ë“œë°± ë™ì‹œ ë¡œë“œ (ë ˆì´ë” ì°¨íŠ¸ ìˆ¨ê¹€)
            try {
              await Promise.all([
                loadSingleFeedback('today_summary', 'feedbackContent1', todayData),
                // loadSingleFeedback('radar_chart', 'feedbackContent2', radarData), // ìˆ¨ê¹€
                loadSingleFeedback('growth_trend', 'feedbackContent3', growthData),
                loadSingleFeedback('subject_scores', 'feedbackContent4', subjectData),
                loadSingleFeedback('vocab_scores', 'feedbackContent5', vocabScoreData)
              ]);

              // ë¡œë”© ì™„ë£Œ í›„ ì½˜í…ì¸  í‘œì‹œ
              loadingBox.style.display = 'none';
              contentBox.style.display = 'flex';
            } catch (err) {
              console.error('AI í”¼ë“œë°± ë¡œë“œ ì˜¤ë¥˜:', err);
              loadingBox.innerHTML = '<div class="ai-feedback-error">AI í”¼ë“œë°±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
          };

          // skipDelayê°€ trueë©´ ë°”ë¡œ ì‹¤í–‰, ì•„ë‹ˆë©´ 3ì´ˆ ëŒ€ê¸° í›„ ì‹¤í–‰
          if (skipDelay) {
            runFeedback();
          } else {
            setTimeout(runFeedback, 3000);
          }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ AI í”¼ë“œë°± ì´ˆê¸°í™”
        window.addEventListener('load', initAIFeedbacks);

        // ===== ì„¸ë¶€ í•™ìŠµ ë‚´ì—­ í† ê¸€ ê¸°ëŠ¥ =====
        function toggleDetailedLog() {
          const section = document.getElementById("detailedLogSection");
          const icon = document.getElementById("toggleDetailedLogIcon");
          const text = document.getElementById("toggleDetailedLogText");
          const btn = document.getElementById("toggleDetailedLogBtn");

          if (section.style.display === "none") {
            section.style.display = "block";
            icon.textContent = "â–²";
            text.textContent = "ì„¸ë¶€ AI ìƒì„¸ í•™ìŠµ ë‚´ì—­ ì ‘ê¸°";
            btn.style.background = "linear-gradient(135deg, #6B4FA0 0%, #8B6FC0 100%)";
            btn.style.color = "#fff";
            section.scrollIntoView({ behavior: "smooth", block: "start" });
          } else {
            section.style.display = "none";
            icon.textContent = "â–¼";
            text.textContent = "ì„¸ë¶€ AI ìƒì„¸ í•™ìŠµ ë‚´ì—­ ë³´ê¸°";
            btn.style.background = "linear-gradient(135deg, #6B4FA0 0%, #8B6FC0 100%)";
            btn.style.color = "#fff";
          }
        }

        // ===== ì‚­ì œ ê¸°ëŠ¥ (ê´€ë¦¬ì ì „ìš©) =====
        function deleteLog(logId, key, grade, name) {
          if (!confirm('ì´ í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì‚­ì œëœ í•­ëª©ì€ íœ´ì§€í†µì—ì„œ ë³µêµ¬í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
            return;
          }

          fetch(\`/admin/log/delete/\${logId}?key=\${encodeURIComponent(key)}\`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
              window.location.reload();
            } else {
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
            }
          })
          .catch(err => {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
          });
        }

        // ===== ê²€ìƒ‰ ê¸°ëŠ¥ (ë‹¨ì›ëª… + ë“±ê¸‰ í†µí•© ê²€ìƒ‰) =====
        function searchLogs(query) {
          const rows = document.querySelectorAll('#logTableBody tr');
          const clearBtn = document.getElementById('logSearchClear');

          clearBtn.classList.toggle('show', query.length > 0);

          rows.forEach(row => {
            // í…Œì´ë¸” êµ¬ì¡°: ìˆœë²ˆ, ê³¼ëª©ëª…, AIê³¼ì œë¶€ì—¬, ìµœì¢…ì™„ë£Œ, ë“±ê¸‰(5ë²ˆì§¸), ì‹œë¦¬ì¦ˆ, ë‹¨ì›ëª…(ë§ˆì§€ë§‰)
            const gradeCell = row.querySelector('td:nth-child(5)');
            const unitCell = row.querySelector('td:last-child');

            if (unitCell && gradeCell) {
              const unitText = unitCell.textContent.toLowerCase();
              const rowGrade = gradeCell.textContent.trim();
              const queryLower = query.toLowerCase();

              // ë‹¨ì›ëª… ë˜ëŠ” ë“±ê¸‰ì— ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ë©´ í‘œì‹œ
              const unitMatch = unitText.includes(queryLower);
              const gradeMatch = rowGrade.includes(queryLower);

              row.style.display = (unitMatch || gradeMatch) ? 'table-row' : 'none';
            }
          });

          updateLogCount();
        }

        function clearLogSearch() {
          document.getElementById('logSearch').value = '';
          document.getElementById('logSearchClear').classList.remove('show');
          const rows = document.querySelectorAll('#logTableBody tr');
          rows.forEach(row => row.style.display = 'table-row');
          updateLogCount();
        }

        // í‘œì‹œëœ ë¡œê·¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateLogCount() {
          const visibleRows = document.querySelectorAll('#logTableBody tr:not([style*="display: none"])');
          const badge = document.getElementById('logCountBadge');
          if (badge) {
            badge.textContent = 'ğŸ“š ì´ ' + visibleRows.length + 'ê±´ì˜ í•™ìŠµ ê¸°ë¡';
          }
        }

        // ê³¼ëª©ë³„ ë ˆì´ë” ê²€ìƒ‰
        function searchSubjectRadar(query) {
          const cards = document.querySelectorAll('#summary-radar-wrap .radar-card');
          const clearBtn = document.getElementById('subjectSearchClear');
          const toggleBtn = document.getElementById('toggleSummaryBtn');
          const gradeFilterEl = document.getElementById('subjectGradeFilter');
          const gradeFilter = gradeFilterEl ? gradeFilterEl.value : 'all';

          clearBtn.classList.toggle('show', query.length > 0);

          cards.forEach((card, index) => {
            const title = card.querySelector('.radar-card-title');
            const gradeEl = card.querySelector('.stat-grade');
            const titleText = title ? title.textContent.toLowerCase() : '';
            const cardGrade = gradeEl ? gradeEl.textContent.trim() : '';

            const searchMatch = query === '' || titleText.includes(query.toLowerCase());
            const gradeMatch = gradeFilter === 'all' || cardGrade.includes(gradeFilter);

            if (searchMatch && gradeMatch) {
              card.style.display = 'block';
              if (query.length > 0 || gradeFilter !== 'all') {
                card.classList.remove('hidden-card');
              } else if (index >= 6) {
                card.classList.add('hidden-card');
              }
            } else {
              card.style.display = 'none';
            }
          });

          // ê²€ìƒ‰/í•„í„° ì¤‘ì´ë©´ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          if (query.length > 0 || gradeFilter !== 'all') {
            if (toggleBtn) toggleBtn.style.display = 'none';
          } else if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        function filterSubjectRadarByGrade(grade) {
          const searchInput = document.getElementById('subjectSearch');
          const query = searchInput ? searchInput.value : '';
          searchSubjectRadar(query);
        }

        function clearSubjectSearch() {
          document.getElementById('subjectSearch').value = '';
          document.getElementById('subjectSearchClear').classList.remove('show');
          document.getElementById('subjectGradeFilter').value = 'all';
          const cards = document.querySelectorAll('#summary-radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleSummaryBtn');

          cards.forEach((card, index) => {
            card.style.display = 'block';
            if (index >= 6) {
              card.classList.add('hidden-card');
            } else {
              card.classList.remove('hidden-card');
            }
          });

          if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        // ë‹¨ì›ë³„ ë ˆì´ë” ê²€ìƒ‰
        function searchUnitRadar(query) {
          const cards = document.querySelectorAll('#radar-wrap .radar-card');
          const clearBtn = document.getElementById('unitSearchClear');
          const toggleBtn = document.getElementById('toggleRadarBtn');
          const gradeFilterEl = document.getElementById('unitGradeFilter');
          const gradeFilter = gradeFilterEl ? gradeFilterEl.value : 'all';

          clearBtn.classList.toggle('show', query.length > 0);

          cards.forEach((card, index) => {
            const title = card.querySelector('.radar-card-title');
            const gradeEl = card.querySelector('.stat-grade');
            const titleText = title ? title.textContent.toLowerCase() : '';
            const cardGrade = gradeEl ? gradeEl.textContent.trim() : '';

            const searchMatch = query === '' || titleText.includes(query.toLowerCase());
            const gradeMatch = gradeFilter === 'all' || cardGrade.includes(gradeFilter);

            if (searchMatch && gradeMatch) {
              card.style.display = 'block';
              if (query.length > 0 || gradeFilter !== 'all') {
                card.classList.remove('hidden-card');
              } else if (index >= 6) {
                card.classList.add('hidden-card');
              }
            } else {
              card.style.display = 'none';
            }
          });

          // ê²€ìƒ‰/í•„í„° ì¤‘ì´ë©´ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          if (query.length > 0 || gradeFilter !== 'all') {
            if (toggleBtn) toggleBtn.style.display = 'none';
          } else if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        function filterUnitRadarByGrade(grade) {
          const searchInput = document.getElementById('unitSearch');
          const query = searchInput ? searchInput.value : '';
          searchUnitRadar(query);
        }

        function clearUnitSearch() {
          document.getElementById('unitSearch').value = '';
          document.getElementById('unitSearchClear').classList.remove('show');
          document.getElementById('unitGradeFilter').value = 'all';
          const cards = document.querySelectorAll('#radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleRadarBtn');

          cards.forEach((card, index) => {
            card.style.display = 'block';
            if (index >= 6) {
              card.classList.add('hidden-card');
            } else {
              card.classList.remove('hidden-card');
            }
          });

          if (toggleBtn && cards.length > 6) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          }
        }

        // ===== í•™ìŠµ ê¸°ë¡ ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
        function toggleRows() {
          const hiddenRows = document.querySelectorAll('.hidden-row');
          const toggleBtn = document.getElementById('toggleBtn');

          if (hiddenRows.length === 0) return;

          const isHidden = hiddenRows[0].style.display === 'none' || hiddenRows[0].style.display === '';

          hiddenRows.forEach(row => {
            row.style.display = isHidden ? 'table-row' : 'none';
          });

          toggleBtn.textContent = isHidden ? 'ì ‘ê¸° â–²' : 'ë”ë³´ê¸° â–¼';
        }

        // ===== ì¢…í•© ë ˆì´ë” ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
        function toggleSummaryRadar() {
          const allCards = document.querySelectorAll('#summary-radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleSummaryBtn');
          const isExpanded = toggleBtn.textContent.includes('ì ‘ê¸°');

          allCards.forEach((card, index) => {
            if (index >= 6) {
              if (isExpanded) {
                card.classList.add('hidden-card');
              } else {
                card.classList.remove('hidden-card');
              }
            }
          });

          toggleBtn.textContent = isExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
        }

        // ===== ë‹¨ì›ë³„ ë ˆì´ë” ë”ë³´ê¸°/ì ‘ê¸° ê¸°ëŠ¥ =====
        function toggleRadar() {
          const allCards = document.querySelectorAll('#radar-wrap .radar-card');
          const toggleBtn = document.getElementById('toggleRadarBtn');
          const isExpanded = toggleBtn.textContent.includes('ì ‘ê¸°');

          allCards.forEach((card, index) => {
            if (index >= 6) {
              if (isExpanded) {
                card.classList.add('hidden-card');
              } else {
                card.classList.remove('hidden-card');
              }
            }
          });

          toggleBtn.textContent = isExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
        }

        const logsForChart = ${JSON.stringify(logs)};
        const UNIT_TITLES = ${JSON.stringify(UNIT_TITLES)};
        const UNIT_PROGRESS_MAP = ${JSON.stringify(unitProgressMap)};  // âœ… ì–´íœ˜í•™ìŠµ ì ìˆ˜ í¬í•¨
        const rawSeries = '${series || 'all'}';  // í˜„ì¬ í˜ì´ì§€ì˜ ì‹œë¦¬ì¦ˆ (ë‹¨ì¶•ì½”ë“œ) - ê¸°ë³¸ê°’ ì „ì²´

        // ì‹œë¦¬ì¦ˆ ë‹¨ì¶•ì½”ë“œë¥¼ ì „ì²´ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
        function getFullSeriesName(series) {
          const seriesMap = {
            'all': 'ì „ì²´ ì‹œë¦¬ì¦ˆ',
            'up': 'BRAINì—…',
            'on': 'BRAINì˜¨',
            'fit': 'BRAINí•',
            'deep': 'BRAINë”¥',
            'BRAINì—…': 'BRAINì—…',
            'BRAINì˜¨': 'BRAINì˜¨',
            'BRAINí•': 'BRAINí•',
            'BRAINë”¥': 'BRAINë”¥'
          };
          return seriesMap[series] || 'ì „ì²´ ì‹œë¦¬ì¦ˆ';
        }
        let currentSeries = getFullSeriesName(rawSeries);
        console.log('[DEBUG] rawSeries:', rawSeries, ', currentSeries:', currentSeries);

        // ì‹œë¦¬ì¦ˆë³„ unit ì ‘ë‘ì‚¬ í•„í„° í•¨ìˆ˜ (filterLogsBySeriesì™€ ë™ì¼í•œ ë¡œì§ ì‚¬ìš©)
        function matchesSeries(unit, series) {
          if (!unit) return false;
          if (series === 'ì „ì²´ ì‹œë¦¬ì¦ˆ') return true; // ì „ì²´ ì‹œë¦¬ì¦ˆ: ëª¨ë“  ë¡œê·¸ í¬í•¨
          if (series === 'BRAINì˜¨') return unit.includes('on_');
          if (series === 'BRAINí•') return unit.includes('fit_');
          if (series === 'BRAINë”¥') return unit.includes('deep_');
          if (series === 'BRAINì—…') return !unit.includes('on_') && !unit.includes('fit_') && !unit.includes('deep_');
          return true; // ê¸°ë³¸ê°’: ëª¨ë“  ì‹œë¦¬ì¦ˆ
        }

        // ===== ì§€ìˆ˜ë³„ ì¶”ì´ êº¾ì€ì„  ê·¸ë˜í”„ (ë‚ ì§œë³„ í‰ê· ) =====
        let indexTrendChartInstance = null;
        let indexTrendCurrentPage = 0;
        let indexTrendAllDates = [];
        let indexTrendDateIndexMap = {};

        // AI í”¼ë“œë°±ìš© ì°¨íŠ¸ ë°ì´í„° ì €ì¥ (ì°¨íŠ¸ì™€ ë™ê¸°í™”)
        window.chartDataForAI = {
          growthTrend: { dates: [], scores: [], hasData: false },
          subjectScores: { dates: [], subjects: {}, hasData: false }
        };

        function renderIndexTrendChart() {
          const canvas = document.getElementById('indexTrendChart');
          const legendContainer = document.getElementById('indexTrendLegend');
          const chartContainer = canvas ? canvas.parentElement : null;
          const dateRangeSpan = document.getElementById('indexTrendDateRange');
          const prevBtn = document.getElementById('indexTrendPrev');
          const nextBtn = document.getElementById('indexTrendNext');

          if (!canvas || !legendContainer) return;

          // ë‚ ì§œë³„ ì§€ìˆ˜ ë°ì´í„° ì§‘ê³„ (ì™„ë£Œëœ ê¸°ë¡ë§Œ)
          const dateIndexMap = {};

          // í˜„ì¬ ì‹œë¦¬ì¦ˆì— ë§ëŠ” ë¡œê·¸ë§Œ í•„í„°ë§
          const seriesFilteredLogs = logsForChart.filter(log => matchesSeries(log.unit, currentSeries));

          seriesFilteredLogs.forEach(log => {
            // timestampë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©
            if (!log.timestamp) return;
            const logDate = log.timestamp;

            // KSTë¡œ ë³€í™˜í•˜ì—¬ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (+9ì‹œê°„)
            const kstDate = new Date(new Date(logDate).getTime() + 9 * 60 * 60 * 1000);
            const dateStr = kstDate.toISOString().split('T')[0];

            // radarì— ìœ íš¨í•œ ì ìˆ˜ê°€ ìˆëŠ” ê¸°ë¡ë§Œ ì°¨íŠ¸ ë°ì´í„°ë¡œ ì‚¬ìš©
            const r = log.radar || {};
            const hasValidScore = [r.literal, r.structural, r.lexical, r.inferential, r.critical].some(s => s != null && s > 0);
            if (!hasValidScore) return;

            if (!dateIndexMap[dateStr]) {
              dateIndexMap[dateStr] = {
                literal: [],      // í•µì‹¬ ì´í•´ë ¥
                critical: [],     // ë¹„íŒ ì ìš©ë ¥
                structural: [],   // êµ¬ì¡° íŒŒì•…ë ¥
                inferential: [],  // ì¶”ë¡  í†µí•©ë ¥
                lexical: []       // ì–´íœ˜ ë§¥ë½ë ¥
              };
            }

            if (r.literal != null) dateIndexMap[dateStr].literal.push(r.literal);
            if (r.critical != null) dateIndexMap[dateStr].critical.push(r.critical);
            if (r.structural != null) dateIndexMap[dateStr].structural.push(r.structural);
            if (r.inferential != null) dateIndexMap[dateStr].inferential.push(r.inferential);
            if (r.lexical != null) dateIndexMap[dateStr].lexical.push(r.lexical);
          });

          console.log('[renderIndexTrendChart] currentSeries:', currentSeries, ', í•„í„°ë§ëœ ë¡œê·¸:', seriesFilteredLogs.length, ', ë‚ ì§œ ìˆ˜:', Object.keys(dateIndexMap).length);

          // ë‚ ì§œ ì •ë ¬ ë° ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          indexTrendAllDates = Object.keys(dateIndexMap).sort();
          indexTrendDateIndexMap = dateIndexMap;

          if (indexTrendAllDates.length === 0) {
            chartContainer.innerHTML = '<div class="index-trend-no-data">í•™ìŠµ ê¸°ë¡ì´ ì—†ì–´ ì§€ìˆ˜ ì¶”ì´ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            legendContainer.innerHTML = '';
            if (dateRangeSpan) dateRangeSpan.textContent = '';
            return;
          }

          // 7ì¼ ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ì„¤ì • (ê¸°ë³¸: ìµœê·¼ 7ì¼)
          const DAYS_TO_SHOW = 7;
          indexTrendCurrentPage = Math.max(0, indexTrendAllDates.length - DAYS_TO_SHOW);

          // ë‚ ì§œë³„ í‰ê·  ê³„ì‚° í•¨ìˆ˜
          const calcAvg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : null;

          // ìƒ‰ìƒ ì •ì˜
          const colors = {
            literal: { line: '#667eea', bg: 'rgba(102, 126, 234, 0.2)' },      // ë³´ë¼
            critical: { line: '#f093fb', bg: 'rgba(240, 147, 251, 0.2)' },     // í•‘í¬
            structural: { line: '#4facfe', bg: 'rgba(79, 172, 254, 0.2)' },    // íŒŒë‘
            inferential: { line: '#43e97b', bg: 'rgba(67, 233, 123, 0.2)' },   // ì´ˆë¡
            lexical: { line: '#fa709a', bg: 'rgba(250, 112, 154, 0.2)' }       // ì½”ë„
          };

          // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
          function updateIndexTrendChart() {
            let displayDates;

            if (isWeeklyMode) {
              // ì£¼ê°„ ëª¨ë“œ: selectedWeekStart ê¸°ì¤€ ì›”~ì¼ 7ì¼
              const weekStart = new Date(selectedWeekStart);
              const weekDates = [];
              for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(toKSTDateString(d));
              }
              // í•´ë‹¹ ì£¼ê°„ ì¤‘ ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œë§Œ í‘œì‹œ
              displayDates = weekDates.filter(d => indexTrendDateIndexMap[d]);
            } else {
              // ì¼ê°„ ëª¨ë“œ: ê¸°ì¡´ 7ì¼ ìŠ¬ë¼ì´ë”© ìœˆë„ìš°
              const startIdx = indexTrendCurrentPage;
              const endIdx = Math.min(startIdx + DAYS_TO_SHOW, indexTrendAllDates.length);
              displayDates = indexTrendAllDates.slice(startIdx, endIdx);
            }

            // ë‚ ì§œ ë¼ë²¨ í¬ë§· (MM/DD)
            const dateLabels = displayDates.map(d => {
              const parts = d.split('-');
              return parts[1] + '/' + parts[2];
            });

            // ë°ì´í„° ê³„ì‚°
            const literalData = displayDates.map(d => indexTrendDateIndexMap[d] ? calcAvg(indexTrendDateIndexMap[d].literal) : null);
            const criticalData = displayDates.map(d => indexTrendDateIndexMap[d] ? calcAvg(indexTrendDateIndexMap[d].critical) : null);
            const structuralData = displayDates.map(d => indexTrendDateIndexMap[d] ? calcAvg(indexTrendDateIndexMap[d].structural) : null);
            const inferentialData = displayDates.map(d => indexTrendDateIndexMap[d] ? calcAvg(indexTrendDateIndexMap[d].inferential) : null);
            const lexicalData = displayDates.map(d => indexTrendDateIndexMap[d] ? calcAvg(indexTrendDateIndexMap[d].lexical) : null);

            // ===== AI í”¼ë“œë°±ìš© ë°ì´í„° ì €ì¥ (ì°¨íŠ¸ì™€ ì™„ì „ ë™ê¸°í™”) =====
            const avgScores = displayDates.map((d, i) => {
              const indices = [
                literalData[i],
                criticalData[i],
                structuralData[i],
                inferentialData[i],
                lexicalData[i]
              ].filter(v => v !== null && v !== undefined);
              return indices.length > 0 ? indices.reduce((a, b) => a + b, 0) / indices.length : null;
            });

            // 5ê°€ì§€ ë¬¸í•´ë ¥ ì§€ìˆ˜ë³„ í‰ê·  ê³„ì‚° (AI í”¼ë“œë°±ìš©)
            const calcIndexAvg = (arr) => {
              const valid = arr.filter(v => v !== null && v !== undefined);
              return valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : null;
            };
            const literacyIndices = {
              literal: calcIndexAvg(literalData),      // í•µì‹¬ ì´í•´ë ¥
              critical: calcIndexAvg(criticalData),    // ë¹„íŒ ì ìš©ë ¥
              structural: calcIndexAvg(structuralData), // êµ¬ì¡° íŒŒì•…ë ¥
              inferential: calcIndexAvg(inferentialData), // ì¶”ë¡  í†µí•©ë ¥
              lexical: calcIndexAvg(lexicalData)       // ì–´íœ˜ ë§¥ë½ë ¥
            };

            window.chartDataForAI.growthTrend = {
              dates: dateLabels,  // MM/DD í˜•ì‹
              scores: avgScores,
              literacyIndices: literacyIndices,  // 5ê°€ì§€ ë¬¸í•´ë ¥ ì§€ìˆ˜
              hasData: displayDates.length > 0 && avgScores.some(s => s !== null)
            };

            // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
            if (dateRangeSpan && isWeeklyMode) {
              // ì£¼ê°„ ëª¨ë“œ: í†µì¼ëœ í˜•ì‹ ì‚¬ìš© (2026ë…„ 1/6 (ì›”) ~ 1/11 (ì¼))
              const weekStart = new Date(selectedWeekStart);
              const weekEnd = getWeekEnd(weekStart);
              const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
              dateRangeSpan.textContent = weekStart.getFullYear() + 'ë…„ ' + formatShort(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';
            } else if (dateRangeSpan && displayDates.length > 0) {
              // ì¼ê°„ ëª¨ë“œ: ê¸°ì¡´ í˜•ì‹ ìœ ì§€
              const firstLabel = dateLabels[0];
              const lastLabel = dateLabels[dateLabels.length - 1];
              dateRangeSpan.textContent = firstLabel + ' ~ ' + lastLabel;
            }

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ (ì£¼ê°„ ëª¨ë“œì—ì„œëŠ” ìˆ¨ê¹€)
            if (isWeeklyMode) {
              if (prevBtn) prevBtn.style.display = 'none';
              if (nextBtn) nextBtn.style.display = 'none';
            } else {
              if (prevBtn) prevBtn.style.display = '';
              if (nextBtn) nextBtn.style.display = '';
              const endIdx = Math.min(indexTrendCurrentPage + DAYS_TO_SHOW, indexTrendAllDates.length);
              if (prevBtn) prevBtn.disabled = indexTrendCurrentPage === 0;
              if (nextBtn) nextBtn.disabled = endIdx >= indexTrendAllDates.length;
              if (prevBtn) prevBtn.style.opacity = indexTrendCurrentPage === 0 ? '0.4' : '1';
              if (nextBtn) nextBtn.style.opacity = endIdx >= indexTrendAllDates.length ? '0.4' : '1';
            }

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (indexTrendChartInstance) {
              indexTrendChartInstance.destroy();
            }

            // Chart.js êº¾ì€ì„  ê·¸ë˜í”„ ìƒì„±
            const ctx = canvas.getContext('2d');

            indexTrendChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: dateLabels,
                datasets: [
                  {
                    label: 'í•µì‹¬ ì´í•´ë ¥',
                    data: literalData,
                    borderColor: colors.literal.line,
                    backgroundColor: colors.literal.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    spanGaps: true
                  },
                  {
                    label: 'ë¹„íŒ ì ìš©ë ¥',
                    data: criticalData,
                    borderColor: colors.critical.line,
                    backgroundColor: colors.critical.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    spanGaps: true
                  },
                  {
                    label: 'êµ¬ì¡° íŒŒì•…ë ¥',
                    data: structuralData,
                    borderColor: colors.structural.line,
                    backgroundColor: colors.structural.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    spanGaps: true
                  },
                  {
                    label: 'ì¶”ë¡  í†µí•©ë ¥',
                    data: inferentialData,
                    borderColor: colors.inferential.line,
                    backgroundColor: colors.inferential.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    spanGaps: true
                  },
                  {
                    label: 'ì–´íœ˜ ë§¥ë½ë ¥',
                    data: lexicalData,
                    borderColor: colors.lexical.line,
                    backgroundColor: colors.lexical.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    spanGaps: true
                  },
                  {
                    label: 'í‰ê·  ê¸°ì¤€ì„  (7ì )',
                    data: dateLabels.map(() => 7),
                    borderColor: 'rgba(150, 150, 150, 0.6)',
                    borderWidth: 1.5,
                  borderDash: [6, 4],
                  fill: false,
                  tension: 0,
                  pointRadius: 0,
                  pointHoverRadius: 0,
                  order: 10
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  padding: 12,
                  callbacks: {
                    label: function(context) {
                      const value = context.parsed.y;
                      return context.dataset.label + ': ' + (value !== null ? value.toFixed(1) : '-');
                    }
                  }
                },
                datalabels: {
                  display: false,
                  anchor: 'top',
                  align: 'top',
                  offset: 4,
                  font: {
                    size: 11,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value !== null ? value.toFixed(1) : '';
                  }
                }
              },
              scales: {
                x: {
                  position: 'bottom',
                  grid: {
                    display: false
                  },
                  ticks: {
                    color: '#555',
                    font: { size: 11, weight: '600' },
                    maxRotation: 45,
                    minRotation: 0
                  },
                  border: {
                    display: true,
                    color: 'rgba(100, 100, 100, 0.3)'
                  }
                },
                y: {
                  min: 5,
                  max: 10.5,
                  grid: {
                    display: false
                  },
                  ticks: {
                    display: false
                  },
                  border: {
                    display: false
                  }
                }
              }
            }
          });

          // ë²”ë¡€ í´ë¦­ ì´ë²¤íŠ¸ - í•´ë‹¹ ê·¸ë˜í”„ ê°•ì¡°
          let highlightedIndex = null;
          const legendItemElements = legendContainer.querySelectorAll('.index-trend-legend-item');

          legendItemElements.forEach((el, idx) => {
            el.addEventListener('click', function() {
              const clickedIndex = parseInt(this.dataset.index);

              if (highlightedIndex === clickedIndex) {
                // ê°™ì€ í•­ëª© ë‹¤ì‹œ í´ë¦­ ì‹œ ì›ë˜ëŒ€ë¡œ ë³µì›
                highlightedIndex = null;
                indexTrendChartInstance.data.datasets.forEach((dataset, i) => {
                  if (i >= legendItems.length) return; // í‰ê·  ê¸°ì¤€ì„  ìŠ¤í‚µ
                  dataset.borderWidth = 2;
                  dataset.borderColor = legendItems[i].color;
                  dataset.pointRadius = 4;
                  dataset.datalabels = { display: false };
                });
                legendItemElements.forEach(item => {
                  item.classList.remove('active', 'dimmed');
                });
              } else {
                // ì„ íƒí•œ ê·¸ë˜í”„ ê°•ì¡°, ë‚˜ë¨¸ì§€ëŠ” í¬ë¯¸í•˜ê²Œ
                highlightedIndex = clickedIndex;
                indexTrendChartInstance.data.datasets.forEach((dataset, i) => {
                  if (i >= legendItems.length) return; // í‰ê·  ê¸°ì¤€ì„  ìŠ¤í‚µ
                  if (i === clickedIndex) {
                    dataset.borderWidth = 4;
                    dataset.borderColor = legendItems[i].color;
                    dataset.pointRadius = 6;
                    dataset.datalabels = {
                      display: true,
                      color: legendItems[i].color,
                      backgroundColor: 'rgba(255,255,255,0.9)',
                      borderRadius: 4,
                      padding: { top: 2, bottom: 2, left: 4, right: 4 }
                    };
                  } else {
                    dataset.borderWidth = 1;
                    dataset.borderColor = legendItems[i].color + '40'; // íˆ¬ëª…ë„ ì¶”ê°€
                    dataset.pointRadius = 2;
                    dataset.datalabels = { display: false };
                  }
                });
                legendItemElements.forEach((item, i) => {
                  if (i === clickedIndex) {
                    item.classList.add('active');
                    item.classList.remove('dimmed');
                  } else {
                    item.classList.add('dimmed');
                    item.classList.remove('active');
                  }
                });
              }
              indexTrendChartInstance.update();
            });
          });
          } // updateIndexTrendChart í•¨ìˆ˜ ë

          // ë²”ë¡€ ë¨¼ì € ìƒì„± (í•œ ë²ˆë§Œ)
          const legendItems = [
            { label: 'í•µì‹¬ ì´í•´ë ¥', color: colors.literal.line, index: 0 },
            { label: 'ë¹„íŒ ì ìš©ë ¥', color: colors.critical.line, index: 1 },
            { label: 'êµ¬ì¡° íŒŒì•…ë ¥', color: colors.structural.line, index: 2 },
            { label: 'ì¶”ë¡  í†µí•©ë ¥', color: colors.inferential.line, index: 3 },
            { label: 'ì–´íœ˜ ë§¥ë½ë ¥', color: colors.lexical.line, index: 4 }
          ];

          legendContainer.innerHTML = legendItems.map((item, idx) =>
            '<div class="index-trend-legend-item" data-index="' + idx + '" style="cursor: pointer;">' +
              '<div class="index-trend-legend-color" style="background: ' + item.color + ';"></div>' +
              '<span class="index-trend-legend-label">' + item.label + '</span>' +
            '</div>'
          ).join('');

          // ì´ˆê¸° ì°¨íŠ¸ ë Œë”ë§
          updateIndexTrendChart();

          // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ (í•˜ë£¨ì”© ì´ë™)
          if (prevBtn) {
            prevBtn.onclick = function() {
              if (indexTrendCurrentPage > 0) {
                indexTrendCurrentPage--;
                updateIndexTrendChart();
              }
            };
          }
          if (nextBtn) {
            nextBtn.onclick = function() {
              if (indexTrendCurrentPage + DAYS_TO_SHOW < indexTrendAllDates.length) {
                indexTrendCurrentPage++;
                updateIndexTrendChart();
              }
            };
          }

          // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ windowì— ë…¸ì¶œ
          window.updateIndexTrendChart = updateIndexTrendChart;
        }

        // ===== ë‚ ì§œë³„ ê³¼ëª© í‰ê·  í‰ì  ë§‰ëŒ€ ê·¸ë˜í”„ ë Œë”ë§ =====
        let subjectBarChartInstance = null;
        let subjectBarCurrentPage = 0;
        let subjectBarDatesWithData = [];

        function renderSubjectBarChart() {
          const canvas = document.getElementById('subjectBarChart');
          const legendContainer = document.getElementById('subjectBarLegend');
          const dateRangeSpan = document.getElementById('subjectBarDateRange');
          const prevBtn = document.getElementById('subjectBarPrev');
          const nextBtn = document.getElementById('subjectBarNext');

          if (!canvas || !legendContainer) return;

          // 14ê°œ ê³¼ëª© ì •ì˜ ë° ìƒ‰ìƒ
          const subjectConfig = [
            { key: 'bio', name: 'ìƒë¬¼', color: '#4CAF50' },
            { key: 'earth', name: 'ì§€êµ¬ê³¼í•™', color: '#2196F3' },
            { key: 'physics', name: 'ë¬¼ë¦¬', color: '#9C27B0' },
            { key: 'chem', name: 'í™”í•™', color: '#FF5722' },
            { key: 'soc', name: 'ì‚¬íšŒë¬¸í™”', color: '#E91E63' },
            { key: 'geo', name: 'ì§€ë¦¬', color: '#00BCD4' },
            { key: 'law', name: 'ë²•', color: '#795548' },
            { key: 'pol', name: 'ì •ì¹˜ê²½ì œ', color: '#607D8B' },
            { key: 'classic', name: 'ê³ ì „ì†Œì„¤', color: '#8BC34A' },
            { key: 'modern', name: 'í˜„ëŒ€ì†Œì„¤', color: '#FFC107' },
            { key: 'world1', name: 'ì„¸ê³„ë¬¸í•™1', color: '#FF9800' },
            { key: 'world2', name: 'ì„¸ê³„ë¬¸í•™2', color: '#F44336' },
            { key: 'person1', name: 'í•œêµ­ì¸ë¬¼', color: '#673AB7' },
            { key: 'person2', name: 'ì„¸ê³„ì¸ë¬¼', color: '#3F51B5' }
          ];

          // ê³¼ëª© í‚¤ ë§¤í•‘ (ë‹¤ì–‘í•œ í˜•íƒœì˜ ê³¼ëª© ì½”ë“œë¥¼ í‘œì¤€í™”)
          function normalizeSubjectKey(unitCode) {
            if (!unitCode) return null;
            const parts = unitCode.split('_');
            let subjectKey = parts[0];
            let numStr = parts[1] || '';

            // fit_, deep_, on_ ì ‘ë‘ì‚¬ ì²˜ë¦¬
            if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
              subjectKey = parts[1];
              numStr = parts[2] || '';
            }

            const number = numStr ? parseInt(numStr, 10) : 0;

            // ê³¼ëª© ì½”ë“œ ë§¤í•‘
            if (subjectKey === 'world') {
              return number > 40 ? 'world2' : 'world1';
            }
            if (subjectKey === 'people' || subjectKey === 'person') {
              return number > 40 ? 'person2' : 'person1';
            }
            // people1, people2, world1, world2 í˜•ì‹ ì²˜ë¦¬ (ìˆ«ìê°€ ë¶™ì–´ìˆëŠ” ê²½ìš°)
            if (subjectKey === 'people1' || subjectKey === 'person1') {
              return 'person1';
            }
            if (subjectKey === 'people2' || subjectKey === 'person2') {
              return 'person2';
            }
            if (subjectKey === 'world1') {
              return 'world1';
            }
            if (subjectKey === 'world2') {
              return 'world2';
            }

            return subjectKey;
          }

          // ë‚ ì§œë³„ ê³¼ëª©ë³„ í‰ê·  ì ìˆ˜ ê³„ì‚° (completedAtì´ ìˆëŠ” ì™„ë£Œëœ ê¸°ë¡ë§Œ)
          const dateSubjectScores = {};

          logsForChart.forEach(log => {
            // í˜„ì¬ ì‹œë¦¬ì¦ˆë§Œ í•„í„°ë§ (ë™ì )
            if (!matchesSeries(log.unit, currentSeries)) return;

            // radarì— ìœ íš¨í•œ ì ìˆ˜ê°€ ìˆëŠ” ì™„ë£Œëœ ê¸°ë¡ë§Œ ì‚¬ìš©
            const r = log.radar || {};
            const hasValidScore = [r.literal, r.structural, r.lexical, r.inferential, r.critical].some(s => s != null && s > 0);
            if (!hasValidScore) return;

            // timestampë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©
            if (!log.timestamp) return;
            const logDate = log.timestamp;

            // KSTë¡œ ë³€í™˜í•˜ì—¬ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (+9ì‹œê°„)
            const kstDate = new Date(new Date(logDate).getTime() + 9 * 60 * 60 * 1000);
            const dateStr = kstDate.toISOString().split('T')[0];
            const subjectKey = normalizeSubjectKey(log.unit);

            if (!subjectKey) return;

            // í‰ê·  ì ìˆ˜ ê³„ì‚° (radar ê°ì²´ì—ì„œ 5ê°œ ì§€ìˆ˜ í‰ê· )
            let score = null;
            if (log.radar) {
              const r = log.radar;
              const scores = [
                r.literal || 0,
                r.structural || 0,
                r.lexical || 0,
                r.inferential || 0,
                r.critical || 0
              ].filter(s => s > 0);
              if (scores.length > 0) {
                score = scores.reduce((a, b) => a + b, 0) / scores.length;
              }
            }
            if (score === null) return;

            if (!dateSubjectScores[dateStr]) {
              dateSubjectScores[dateStr] = {};
            }
            if (!dateSubjectScores[dateStr][subjectKey]) {
              dateSubjectScores[dateStr][subjectKey] = { sum: 0, count: 0, units: [] };
            }

            dateSubjectScores[dateStr][subjectKey].sum += score;
            dateSubjectScores[dateStr][subjectKey].count += 1;
            // ë‹¨ì›ë³„ ì ìˆ˜ ì €ì¥ (ë‹¨ì›ëª…, ì ìˆ˜)
            dateSubjectScores[dateStr][subjectKey].units.push({
              name: UNIT_TITLES[log.unit] || log.unit,
              score: score
            });
          });

          // ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œë§Œ ì¶”ì¶œ ë° ì •ë ¬
          subjectBarDatesWithData = Object.keys(dateSubjectScores).sort((a, b) => new Date(a) - new Date(b));

          if (subjectBarDatesWithData.length === 0) {
            canvas.parentElement.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            legendContainer.innerHTML = '';
            if (dateRangeSpan) dateRangeSpan.textContent = '';
            return;
          }

          // í™œì„±í™”ëœ ê³¼ëª© í•„í„° (nullì´ë©´ ëª¨ë‘ í‘œì‹œ, ê°’ì´ ìˆìœ¼ë©´ í•´ë‹¹ ê³¼ëª©ë§Œ í‘œì‹œ)
          let activeSubjectFilter = null;

          // ë²”ë¡€ ìƒì„± (í´ë¦­ ê°€ëŠ¥í•˜ê²Œ)
          function renderLegend() {
            legendContainer.innerHTML = subjectConfig.map(subj => {
              const isActive = activeSubjectFilter === null || activeSubjectFilter === subj.key;
              const opacity = isActive ? '1' : '0.3';
              return '<div class="subject-bar-legend-item" data-subject="' + subj.key + '" style="cursor: pointer; opacity: ' + opacity + '; transition: opacity 0.2s;">' +
                '<div class="subject-bar-legend-color" style="background: ' + subj.color + ';"></div>' +
                '<span>' + subj.name + '</span>' +
              '</div>';
            }).join('');

            // ë²”ë¡€ í´ë¦­ ì´ë²¤íŠ¸
            legendContainer.querySelectorAll('.subject-bar-legend-item').forEach(item => {
              item.onclick = function() {
                const clickedSubject = this.getAttribute('data-subject');
                if (activeSubjectFilter === clickedSubject) {
                  // ê°™ì€ ê³¼ëª© ë‹¤ì‹œ í´ë¦­í•˜ë©´ í•„í„° í•´ì œ (ëª¨ë‘ í‘œì‹œ)
                  activeSubjectFilter = null;
                } else {
                  // ìƒˆ ê³¼ëª© ì„ íƒ
                  activeSubjectFilter = clickedSubject;
                }
                renderLegend();
                updateChart();
              };
            });
          }
          renderLegend();

          // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë°©ì‹: í•˜ë£¨ì”© ì´ë™)
          function updateChart() {
            let visibleDates;
            const daysToShow = 4; // í™”ë©´ì— ë³´ì—¬ì¤„ ë‚ ì§œ ìˆ˜

            if (isWeeklyMode) {
              // ì£¼ê°„ ëª¨ë“œ: selectedWeekStart ê¸°ì¤€ ì›”~ì¼ 7ì¼ ì¤‘ ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œ
              const weekStart = new Date(selectedWeekStart);
              const weekDates = [];
              for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(toKSTDateString(d));
              }
              // í•´ë‹¹ ì£¼ê°„ ì¤‘ ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œë§Œ í•„í„°ë§
              visibleDates = weekDates.filter(d => dateSubjectScores[d]);
            } else {
              // ì¼ê°„ ëª¨ë“œ: ê¸°ì¡´ ìŠ¬ë¼ì´ë”© ìœˆë„ìš°
              const totalDates = subjectBarDatesWithData.length;
              const maxStartIdx = Math.max(0, totalDates - daysToShow);
              const startIdx = Math.min(subjectBarCurrentPage, maxStartIdx);
              const endIdx = Math.min(startIdx + daysToShow, totalDates);
              visibleDates = subjectBarDatesWithData.slice(startIdx, endIdx);
            }

            // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
            if (dateRangeSpan) {
              const formatDate = (d) => {
                const date = new Date(d);
                return (date.getMonth() + 1) + '/' + date.getDate();
              };
              if (isWeeklyMode) {
                // ì£¼ê°„ ëª¨ë“œ: í†µì¼ëœ í˜•ì‹ ì‚¬ìš© (2026ë…„ 1/5 (ì›”) ~ 1/11 (ì¼))
                const weekStart = new Date(selectedWeekStart);
                const weekEnd = getWeekEnd(weekStart);
                const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
                dateRangeSpan.textContent = weekStart.getFullYear() + 'ë…„ ' + formatShort(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';
              } else if (visibleDates.length > 0) {
                if (visibleDates.length === 1) {
                  dateRangeSpan.textContent = formatDate(visibleDates[0]);
                } else {
                  dateRangeSpan.textContent = formatDate(visibleDates[0]) + ' ~ ' + formatDate(visibleDates[visibleDates.length - 1]);
                }
              }
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ (ì£¼ê°„ ëª¨ë“œì—ì„œëŠ” ìˆ¨ê¹€)
            if (isWeeklyMode) {
              if (prevBtn) prevBtn.style.display = 'none';
              if (nextBtn) nextBtn.style.display = 'none';
            } else {
              if (prevBtn) prevBtn.style.display = '';
              if (nextBtn) nextBtn.style.display = '';
              const totalDates = subjectBarDatesWithData.length;
              const maxStartIdx = Math.max(0, totalDates - daysToShow);
              if (prevBtn) prevBtn.disabled = subjectBarCurrentPage <= 0;
              if (nextBtn) nextBtn.disabled = subjectBarCurrentPage >= maxStartIdx;
            }

            // Xì¶• ë¼ë²¨ (ë‚ ì§œ)
            const labels = visibleDates.map(d => {
              const date = new Date(d);
              return (date.getMonth() + 1) + '/' + date.getDate();
            });

            // ë°ì´í„°ì…‹ ìƒì„± (ê° ê³¼ëª©ë³„, í•„í„° ì ìš©)
            const filteredSubjects = activeSubjectFilter
              ? subjectConfig.filter(s => s.key === activeSubjectFilter)
              : subjectConfig;

            const datasets = filteredSubjects.map(subj => {
              const data = visibleDates.map(dateStr => {
                const subjData = dateSubjectScores[dateStr][subj.key];
                if (subjData && subjData.count > 0) {
                  return parseFloat((subjData.sum / subjData.count).toFixed(1));
                }
                return null;
              });

              // ê° ë‚ ì§œë³„ ë‹¨ì› ì •ë³´ ì €ì¥
              const unitsData = visibleDates.map(dateStr => {
                const subjData = dateSubjectScores[dateStr][subj.key];
                if (subjData && subjData.units && subjData.units.length > 0) {
                  return subjData.units;
                }
                return [];
              });

              return {
                label: subj.name,
                subjectKey: subj.key,
                data: data,
                unitsData: unitsData,
                backgroundColor: subj.color,
                borderColor: subj.color,
                borderWidth: 1,
                borderRadius: 3,
                barPercentage: 0.9,
                categoryPercentage: 0.9,
                skipNull: true
              };
            }).filter(ds => ds.data.some(v => v !== null)); // ë°ì´í„°ê°€ ìˆëŠ” ê³¼ëª©ë§Œ

            // ===== AI í”¼ë“œë°±ìš© ê³¼ëª©ë³„ ì ìˆ˜ ë°ì´í„° ì €ì¥ (ì°¨íŠ¸ì™€ ì™„ì „ ë™ê¸°í™”) =====
            const subjectAvgMap = {};
            subjectConfig.forEach(subj => {
              const allScores = visibleDates.map(dateStr => {
                const subjData = dateSubjectScores[dateStr]?.[subj.key];
                if (subjData && subjData.count > 0) {
                  return subjData.sum / subjData.count;
                }
                return null;
              }).filter(s => s !== null);

              if (allScores.length > 0) {
                subjectAvgMap[subj.name] = parseFloat((allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1));
              }
            });
            window.chartDataForAI.subjectScores = {
              dates: labels,  // MM/DD í˜•ì‹
              subjects: subjectAvgMap,
              hasData: Object.keys(subjectAvgMap).length > 0
            };

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (subjectBarChartInstance) {
              subjectBarChartInstance.destroy();
            }

            // Chart.js ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„±
            const ctx = canvas.getContext('2d');
            subjectBarChartInstance = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    padding: 12,
                    bodyFont: { size: 12 },
                    callbacks: {
                      label: function(context) {
                        const value = context.parsed.y;
                        const dataIndex = context.dataIndex;
                        const units = context.dataset.unitsData ? context.dataset.unitsData[dataIndex] : [];

                        // ê²°ê³¼ ë°°ì—´ (ì²« ì¤„: ê³¼ëª© í‰ê· )
                        const lines = [];
                        lines.push(context.dataset.label + ': ' + (value !== null ? value.toFixed(1) + 'ì  (í‰ê· )' : '-'));

                        // ë‹¨ì›ë³„ ì ìˆ˜ ì¶”ê°€
                        if (units && units.length > 0) {
                          units.forEach(function(unit) {
                            lines.push('  - ' + unit.name + ': ' + unit.score.toFixed(1) + 'ì ');
                          });
                        }

                        return lines;
                      }
                    }
                  },
                  datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'top',
                    offset: -2,
                    font: {
                      size: 9,
                      weight: 'bold'
                    },
                    color: function(context) {
                      return context.dataset.backgroundColor;
                    },
                    formatter: function(value) {
                      return value !== null ? value.toFixed(1) : '';
                    }
                  }
                },
                scales: {
                  x: {
                    position: 'bottom',
                    grid: {
                      display: false
                    },
                    ticks: {
                      color: '#333',
                      font: { size: 11, weight: '600' }
                    }
                  },
                  y: {
                    min: 0,
                    max: 10,
                    grid: {
                      color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                      color: '#666',
                      font: { size: 10 },
                      stepSize: 2
                    }
                  }
                }
              }
            });
          }

          // ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸
          if (prevBtn) {
            prevBtn.onclick = function() {
              if (subjectBarCurrentPage > 0) {
                subjectBarCurrentPage--;
                updateChart();
              }
            };
          }
          if (nextBtn) {
            nextBtn.onclick = function() {
              const daysToShow = 4;
              const maxStartIdx = Math.max(0, subjectBarDatesWithData.length - daysToShow);
              if (subjectBarCurrentPage < maxStartIdx) {
                subjectBarCurrentPage++;
                updateChart();
              }
            };
          }

          // ìµœì‹  ë‚ ì§œë¶€í„° ë³´ì—¬ì£¼ê¸° (ìŠ¬ë¼ì´ë”© ìœˆë„ìš°: ë§ˆì§€ë§‰ ìœ„ì¹˜ë¶€í„° ì‹œì‘)
          const daysToShow = 4;
          const maxStartIdx = Math.max(0, subjectBarDatesWithData.length - daysToShow);
          subjectBarCurrentPage = maxStartIdx;

          updateChart();

          // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ windowì— ë…¸ì¶œ
          window.updateSubjectBarChart = updateChart;
        }

        // ===== Today ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡ ë Œë”ë§ (ë‚˜ì˜ AI í•™ìŠµ ë¶„ì„ íŒì—…ìš©) =====
        // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ì„ ìœ„í•œ í˜„ì¬ ì„ íƒëœ ë‚ ì§œ (ê¸°ë³¸: ì˜¤ëŠ˜)
        let selectedDate = new Date();

        // ===== ì£¼ê°„ ëª¨ë“œ ê´€ë ¨ ë³€ìˆ˜ =====
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì£¼ê°„ ëª¨ë“œ ì •ë³´ ì½ê¸°
        const weeklyUrlParams = new URLSearchParams(window.location.search);
        const weeklyParamValue = weeklyUrlParams.get('weekly');
        const weekStartParam = weeklyUrlParams.get('weekStart');

        let isWeeklyMode = (weeklyParamValue !== 'false'); // ê¸°ë³¸ê°’: ì£¼ê°„ ëª¨ë“œ (weekly=falseì¼ ë•Œë§Œ ì¼ê°„ ëª¨ë“œ)
        let selectedWeekStart = weekStartParam ? new Date(weekStartParam) : getWeekStart(new Date()); // URL íŒŒë¼ë¯¸í„° ë˜ëŠ” í˜„ì¬ ì£¼ì˜ ì›”ìš”ì¼

        // í•´ë‹¹ ë‚ ì§œê°€ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼ì„ ë°˜í™˜
        function getWeekStart(date) {
          const d = new Date(date);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1); // ì›”ìš”ì¼ ê¸°ì¤€
          return new Date(d.setDate(diff));
        }

        // í•´ë‹¹ ë‚ ì§œê°€ ì†í•œ ì£¼ì˜ ì¼ìš”ì¼ì„ ë°˜í™˜
        function getWeekEnd(date) {
          const weekStart = getWeekStart(date);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          return weekEnd;
        }

        // ì£¼ê°„ ë ˆì´ë”ìš© ë³„ë„ ì£¼ì°¨ ë³€ìˆ˜
        let selectedWeekRadarStart = getWeekStart(new Date());

        // ì£¼ê°„ ë ˆì´ë” ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ ë°°ì—´
        let weeklyRadarCharts = [];

        // ì „ì²´ ë¡œê·¸ ë°ì´í„° (ì„±ì¥ ì§€ìˆ˜ ì°¨íŠ¸ ë“±ì—ì„œ ì‚¬ìš©)
        let allLogs = [];

        // URL íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì£¼ê°„ ëª¨ë“œ ê³µìœ ìš©)
        function updateWeeklyUrlParams() {
          const url = new URL(window.location.href);
          if (isWeeklyMode) {
            url.searchParams.set('weekly', 'true');
            const weekStartStr = selectedWeekStart.toISOString().split('T')[0];
            url.searchParams.set('weekStart', weekStartStr);
          } else {
            url.searchParams.delete('weekly');
            url.searchParams.delete('weekStart');
          }
          window.history.replaceState({}, '', url.toString());

          // ë¶€ëª¨ ì°½ì— ì£¼ê°„ ëª¨ë“œ ìƒíƒœ ì „ë‹¬ (ì¹´ì¹´ì˜¤í†¡ ê³µìœ  URLì— ë°˜ì˜í•˜ê¸° ìœ„í•¨)
          if (window.parent !== window) {
            window.parent.postMessage({
              type: 'weeklyModeUpdate',
              isWeeklyMode: isWeeklyMode,
              weekStart: isWeeklyMode ? selectedWeekStart.toISOString().split('T')[0] : null
            }, '*');
          }
        }

        // ì£¼ê°„ ëª¨ë“œ UI ì´ˆê¸°í™” í•¨ìˆ˜ (í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„°ë¡œ ì£¼ê°„ ëª¨ë“œ í™œì„±í™”)
        async function initWeeklyModeFromUrl() {
          if (isWeeklyMode) {
            const btn = document.getElementById('weeklyToggleBtn');
            const iconEl = document.getElementById('weeklyToggleIcon');
            const textEl = document.getElementById('weeklyToggleText');
            const titleEl = document.getElementById('sectionTitleText');
            const dailyNav = document.getElementById('dailyNavigator');
            const weeklyNav = document.getElementById('weeklyNavigator');
            const calendarIcon = document.getElementById('calendarIcon');
            const weeklyRadarNav = document.getElementById('weeklyRadarNavigator');

            // ì£¼ê°„ ëª¨ë“œ UI ì„¤ì •
            if (iconEl) iconEl.textContent = 'ğŸ“†';
            if (textEl) textEl.textContent = 'ì¼ê°„ë¦¬í¬íŠ¸';
            if (titleEl) titleEl.textContent = 'ì´ë²ˆ ì£¼ ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡';
            if (btn) {
              btn.style.background = 'linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.2) 100%)';
              btn.style.borderColor = 'rgba(255,215,0,0.6)';
            }
            if (dailyNav) dailyNav.style.display = 'none';
            if (weeklyNav) weeklyNav.style.display = 'flex';
            if (calendarIcon) calendarIcon.style.display = 'none';
            if (weeklyRadarNav) weeklyRadarNav.style.display = 'flex';

            selectedWeekRadarStart = new Date(selectedWeekStart);
            await renderWeeklySection();
            updateWeeklyRadarNav();
            if (typeof initAIFeedbacks === 'function') initAIFeedbacks(true);
            return true; // ì£¼ê°„ ëª¨ë“œë¡œ ì´ˆê¸°í™”ë¨
          }
          return false; // ì¼ê°„ ëª¨ë“œ
        }

        // ì£¼ê°„/ì¼ê°„ ëª¨ë“œ í† ê¸€
        async function toggleWeeklyMode() {
          isWeeklyMode = !isWeeklyMode;
          const btn = document.getElementById('weeklyToggleBtn');
          const iconEl = document.getElementById('weeklyToggleIcon');
          const textEl = document.getElementById('weeklyToggleText');
          const titleEl = document.getElementById('sectionTitleText');
          const descEl = document.getElementById('todayDescription');
          const dailyNav = document.getElementById('dailyNavigator');
          const weeklyNav = document.getElementById('weeklyNavigator');
          const calendarIcon = document.getElementById('calendarIcon');
          const weeklyRadarNav = document.getElementById('weeklyRadarNavigator');
          const radarTitle = document.getElementById('radarSectionTitle');

          if (isWeeklyMode) {
            // ì£¼ê°„ ëª¨ë“œë¡œ ì „í™˜
            iconEl.textContent = 'ğŸ“†';
            textEl.textContent = 'ì¼ê°„ë¦¬í¬íŠ¸';
            titleEl.textContent = 'ì´ë²ˆ ì£¼ ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡';
            btn.style.background = 'linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.2) 100%)';
            btn.style.borderColor = 'rgba(255,215,0,0.6)';
            dailyNav.style.display = 'none';
            weeklyNav.style.display = 'flex';
            calendarIcon.style.display = 'none';
            weeklyRadarNav.style.display = 'flex';
            selectedWeekStart = getWeekStart(selectedDate);
            selectedWeekRadarStart = new Date(selectedWeekStart);
            await renderWeeklySection();
            updateWeeklyRadarNav();
            // AI í•™ìŠµ ë¶„ì„ë„ ì£¼ê°„ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
            if (typeof initAIFeedbacks === 'function') initAIFeedbacks(true);
            // URL íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ (ê³µìœ  ì‹œ ì£¼ê°„ ëª¨ë“œ ìœ ì§€)
            updateWeeklyUrlParams();
          } else {
            // ì¼ê°„ ëª¨ë“œë¡œ ì „í™˜
            iconEl.textContent = 'ğŸ“…';
            textEl.textContent = 'ì£¼ê°„ë¦¬í¬íŠ¸';
            titleEl.textContent = 'Today ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡';
            btn.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%)';
            btn.style.borderColor = 'rgba(255,255,255,0.4)';
            dailyNav.style.display = 'flex';
            weeklyNav.style.display = 'none';
            calendarIcon.style.display = 'inline';
            weeklyRadarNav.style.display = 'none';
            if (radarTitle) radarTitle.textContent = 'ğŸ“Š ì˜¤ëŠ˜ ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”';
            renderTodaySection();
            // ì§€ìˆ˜ ì¶”ì´ ê·¸ë˜í”„ë„ ì¼ê°„ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
            if (typeof window.updateIndexTrendChart === 'function') window.updateIndexTrendChart();
            // ê³¼ëª© í‰ê·  í‰ì  ê·¸ë˜í”„ë„ ì¼ê°„ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
            if (typeof window.updateSubjectBarChart === 'function') window.updateSubjectBarChart();
            // ì–´íœ˜ ì ìˆ˜ ê·¸ë˜í”„ë„ ì¼ê°„ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
            if (typeof renderVocabScoreChart === 'function') renderVocabScoreChart();
            // ì°½ì˜í™œë™ ë‚´ì—­ë„ ì¼ê°„ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
            if (typeof renderCreativeTable === 'function') renderCreativeTable();
            // AI í•™ìŠµ ë¶„ì„ë„ ì¼ê°„ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
            if (typeof initAIFeedbacks === 'function') initAIFeedbacks(true);
            // URL íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ (ê³µìœ  ì‹œ ì¼ê°„ ëª¨ë“œë¡œ)
            updateWeeklyUrlParams();
          }
        }
        window.toggleWeeklyMode = toggleWeeklyMode;

        // ì£¼ì°¨ ë³€ê²½ í•¨ìˆ˜ (í•™ìŠµ ê¸°ë¡ í…Œì´ë¸”ìš©)
        async function changeWeek(delta) {
          selectedWeekStart.setDate(selectedWeekStart.getDate() + (delta * 7));
          await renderWeeklySection();
          // AI í•™ìŠµ ë¶„ì„ë„ í•´ë‹¹ ì£¼ì°¨ë¡œ ì—…ë°ì´íŠ¸
          if (typeof initAIFeedbacks === 'function') initAIFeedbacks(true);
          // URL íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ (ê³µìœ  ì‹œ í•´ë‹¹ ì£¼ì°¨ ìœ ì§€)
          updateWeeklyUrlParams();
        }
        window.changeWeek = changeWeek;

        // ì£¼ê°„ ë ˆì´ë” ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
        function updateWeeklyRadarNav() {
          const weekStart = new Date(selectedWeekRadarStart);
          const weekEnd = getWeekEnd(weekStart);
          const weekDisplay = document.getElementById('currentWeekRadarDisplay');
          const radarTitle = document.getElementById('radarSectionTitle');
          const nextBtn = document.getElementById('weekRadarNextBtn');

          const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
          const formatFull = (d) => d.getFullYear() + 'ë…„ ' + (d.getMonth() + 1) + 'ì›” ' + d.getDate() + 'ì¼';

          if (weekDisplay) {
            weekDisplay.textContent = formatFull(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';
          }
          if (radarTitle) {
            radarTitle.textContent = 'ğŸ“Š ' + formatShort(weekStart) + '~' + formatShort(weekEnd) + ' ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”';
          }

          // ì´ë²ˆ ì£¼ ì´í›„ë¡œëŠ” ì´ë™ ë¶ˆê°€
          const todayWeekStart = getWeekStart(new Date());
          if (nextBtn) {
            if (weekStart >= todayWeekStart) {
              nextBtn.style.opacity = '0.3';
              nextBtn.style.cursor = 'not-allowed';
              nextBtn.disabled = true;
            } else {
              nextBtn.style.opacity = '1';
              nextBtn.style.cursor = 'pointer';
              nextBtn.disabled = false;
            }
          }
        }

        // ì£¼ê°„ ë ˆì´ë” ì£¼ì°¨ ë³€ê²½ í•¨ìˆ˜
        function changeWeekRadar(delta) {
          selectedWeekRadarStart.setDate(selectedWeekRadarStart.getDate() + (delta * 7));
          updateWeeklyRadarNav();
          renderWeeklyRadarOnly();
        }
        window.changeWeekRadar = changeWeekRadar;

        // ì£¼ê°„ ë ˆì´ë”ë§Œ ë Œë”ë§ (í…Œì´ë¸”ì€ ê·¸ëŒ€ë¡œ)
        function renderWeeklyRadarOnly() {
          const weekStart = new Date(selectedWeekRadarStart);
          const weekEnd = getWeekEnd(weekStart);

          const weekDates = [];
          for (let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + i);
            weekDates.push(toKSTDateString(d));
          }

          const weeklyLogs = logsForChart.filter(log => {
            if (!matchesSeries(log.unit, currentSeries)) return false;
            const logDate = log.completedAt || log.timestamp;
            if (!logDate) return false;
            const logDateStr = toKSTDateString(new Date(logDate));
            return weekDates.includes(logDateStr);
          });

          const subjectMap = { 'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™', 'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ', 'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™1', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'people': 'í•œêµ­ì¸ë¬¼', 'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼', 'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼' };

          renderWeeklyRadarCards(weeklyLogs, subjectMap);
        }

        // ë‚ ì§œ ë³€ê²½ í•¨ìˆ˜ (Today í•™ìŠµ ê¸°ë¡ + ì–´íœ˜ ì ìˆ˜ + ì°½ì˜í™œë™ ë™ê¸°í™”)
        function changeDate(delta) {
          selectedDate.setDate(selectedDate.getDate() + delta);
          renderTodaySection();

          // âœ… ë‚ ì§œë³„ ì–´íœ˜ ì ìˆ˜ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          if (typeof vocabScoreCurrentDate !== 'undefined') {
            vocabScoreCurrentDate = new Date(selectedDate);
            if (typeof renderVocabScoreChart === 'function') {
              renderVocabScoreChart();
            }
          }

          // âœ… ì°½ì˜í™œë™ ë‚´ì—­ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          if (typeof creativeCurrentDate !== 'undefined') {
            creativeCurrentDate = new Date(selectedDate);
            if (typeof renderCreativeTable === 'function') {
              renderCreativeTable();
            }
          }

          // âœ… AI í•™ìŠµ ë¶„ì„ë„ í•´ë‹¹ ë‚ ì§œë¡œ ì—…ë°ì´íŠ¸
          if (typeof initAIFeedbacks === 'function') {
            initAIFeedbacks(true);
          }
        }
        window.changeDate = changeDate;

        // ì–´íœ˜ í•™ìŠµ í˜ì´ì§€ë¡œ ì´ë™ í•¨ìˆ˜
        function goToVocabPage(url) {
          window.location.href = url;
        }
        window.goToVocabPage = goToVocabPage;

        // ===== ë‹¬ë ¥ íŒì—… ê¸°ëŠ¥ =====
        let calendarMonth = new Date(); // ë‹¬ë ¥ì— í‘œì‹œí•  ì›”
        let completedDatesCount = new Map(); // ë‚ ì§œë³„ í•™ìŠµ ì™„ë£Œ ê°œìˆ˜ (YYYY-MM-DD -> count)

        // ë‹¬ë ¥ íŒì—… ì—´ê¸°
        function openCalendarPopup() {
          calendarMonth = new Date(selectedDate); // í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ ì›”ë¡œ ì‹œì‘
          document.getElementById('calendarPopup').style.display = 'flex';
          renderCalendar();
        }
        window.openCalendarPopup = openCalendarPopup;

        // ë‹¬ë ¥ íŒì—… ë‹«ê¸°
        function closeCalendarPopup() {
          document.getElementById('calendarPopup').style.display = 'none';
        }
        window.closeCalendarPopup = closeCalendarPopup;

        // ë‹¬ë ¥ ì›” ë³€ê²½
        function changeCalendarMonth(delta) {
          calendarMonth.setMonth(calendarMonth.getMonth() + delta);
          renderCalendar();
        }
        window.changeCalendarMonth = changeCalendarMonth;

        // ë‹¬ë ¥ ë‚ ì§œ ì„ íƒ (ì–´íœ˜ ì ìˆ˜ + ì°½ì˜í™œë™ë„ ë™ê¸°í™”)
        function selectCalendarDate(dateStr) {
          selectedDate = new Date(dateStr + 'T00:00:00');
          closeCalendarPopup();
          renderTodaySection();

          // âœ… ë‚ ì§œë³„ ì–´íœ˜ ì ìˆ˜ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          if (typeof vocabScoreCurrentDate !== 'undefined') {
            vocabScoreCurrentDate = new Date(selectedDate);
            if (typeof renderVocabScoreChart === 'function') {
              renderVocabScoreChart();
            }
          }

          // âœ… ì°½ì˜í™œë™ ë‚´ì—­ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          if (typeof creativeCurrentDate !== 'undefined') {
            creativeCurrentDate = new Date(selectedDate);
            if (typeof renderCreativeTable === 'function') {
              renderCreativeTable();
            }
          }
        }
        window.selectCalendarDate = selectCalendarDate;

        // ë‹¬ë ¥ ë Œë”ë§
        function renderCalendar() {
          const monthDisplay = document.getElementById('calendarMonthDisplay');
          const grid = document.getElementById('calendarGrid');
          if (!monthDisplay || !grid) return;

          const year = calendarMonth.getFullYear();
          const month = calendarMonth.getMonth();
          monthDisplay.textContent = year + 'ë…„ ' + (month + 1) + 'ì›”';

          // ìš”ì¼ í—¤ë”
          const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
          let html = days.map((d, i) => '<div style="padding:8px; font-weight:600; color:' + (i === 0 ? '#ef4444' : i === 6 ? '#3b82f6' : '#666') + ';">' + d + '</div>').join('');

          // ì›”ì˜ ì²« ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const startDayOfWeek = firstDay.getDay();

          // ì´ì „ ë‹¬ ë¹ˆ ì¹¸
          for (let i = 0; i < startDayOfWeek; i++) {
            html += '<div></div>';
          }

          // ì˜¤ëŠ˜ ë‚ ì§œ (KST)
          const todayStr = toKSTDateString(new Date());

          // ë‚ ì§œ ë Œë”ë§
          for (let d = 1; d <= lastDay.getDate(); d++) {
            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
            const isToday = dateStr === todayStr;
            const isSelected = dateStr === toKSTDateString(selectedDate);
            const learningCount = completedDatesCount.get(dateStr) || 0;
            const dayOfWeek = new Date(year, month, d).getDay();

            let bgColor = 'transparent';
            let textColor = dayOfWeek === 0 ? '#ef4444' : dayOfWeek === 6 ? '#3b82f6' : '#333';
            let border = 'none';
            let fontWeight = '400';

            if (isSelected) {
              bgColor = '#667eea';
              textColor = '#fff';
              fontWeight = '700';
            } else if (isToday) {
              border = '2px solid #667eea';
              fontWeight = '600';
            }

            html += '<div onclick="selectCalendarDate(' + "'" + dateStr + "'" + ')" style="padding:4px 2px; cursor:pointer; background:' + bgColor + '; color:' + textColor + '; border:' + border + '; border-radius:8px; font-weight:' + fontWeight + '; position:relative; min-height:44px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;">';
            html += '<span style="font-size:14px;">' + d + '</span>';
            if (learningCount > 0) {
              html += '<span style="display:flex; align-items:center; gap:2px; margin-top:2px;">';
              html += '<span style="width:6px; height:6px; background:#10b981; border-radius:50%;"></span>';
              html += '<span style="font-size:10px; color:#10b981; font-weight:600;">' + learningCount + '</span>';
              html += '</span>';
            }
            html += '</div>';
          }

          grid.innerHTML = html;
        }

        // í•™ìŠµ ì™„ë£Œëœ ë‚ ì§œ ëª©ë¡ ì—…ë°ì´íŠ¸ (ë‚ ì§œë³„ ê°œìˆ˜)
        function updateCompletedDates(logs) {
          completedDatesCount.clear();
          logs.forEach(log => {
            if (log.timestamp && log.completed) {
              const dateStr = toKSTDateString(new Date(log.timestamp));
              completedDatesCount.set(dateStr, (completedDatesCount.get(dateStr) || 0) + 1);
            }
          });
        }

        // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (YYYYë…„ MMì›” DDì¼ (ìš”ì¼))
        function formatDateKorean(date) {
          const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
          const y = date.getFullYear();
          const m = date.getMonth() + 1;
          const d = date.getDate();
          const dayName = days[date.getDay()];
          return y + 'ë…„ ' + m + 'ì›” ' + d + 'ì¼ (' + dayName + ')';
        }

        // KST ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ë°˜í™˜ (YYYY-MM-DD)
        function toKSTDateString(date) {
          const kst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
          return kst.toISOString().split('T')[0];
        }

        // ì˜¤ëŠ˜ ë‚ ì§œì¸ì§€ í™•ì¸ (KST ê¸°ì¤€)
        function isToday(date) {
          const today = new Date();
          return toKSTDateString(date) === toKSTDateString(today);
        }

        async function renderTodaySection() {
          console.log('[Today] UNIT_PROGRESS_MAP keys:', Object.keys(UNIT_PROGRESS_MAP));
          const selectedDateStr = toKSTDateString(selectedDate);

          // ë‹¬ë ¥ì— í‘œì‹œí•  ì™„ë£Œëœ ë‚ ì§œ ëª©ë¡ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì‹œë¦¬ì¦ˆë§Œ)
          const logsForCalendar = logsForChart.filter(log => matchesSeries(log.unit, currentSeries));
          updateCompletedDates(logsForCalendar);

          // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
          const dateDisplay = document.getElementById('currentDateDisplay');
          const description = document.getElementById('todayDescription');
          const nextBtn = document.getElementById('dateNextBtn');

          if (dateDisplay) {
            dateDisplay.textContent = formatDateKorean(selectedDate);
          }
          if (description) {
            if (isToday(selectedDate)) {
              description.textContent = 'ì˜¤ëŠ˜ ì™„ë£Œí•œ í•™ìŠµ ê¸°ë¡ì…ë‹ˆë‹¤.';
            } else {
              description.textContent = 'ì„ íƒí•œ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ì…ë‹ˆë‹¤.';
            }
          }
          // ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œë¡œëŠ” ì´ë™ ë¶ˆê°€
          if (nextBtn) {
            if (isToday(selectedDate)) {
              nextBtn.style.opacity = '0.3';
              nextBtn.style.cursor = 'not-allowed';
              nextBtn.disabled = true;
            } else {
              nextBtn.style.opacity = '1';
              nextBtn.style.cursor = 'pointer';
              nextBtn.disabled = false;
            }
          }

          // ì„ íƒëœ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ í•„í„°ë§ (í˜„ì¬ ì‹œë¦¬ì¦ˆë§Œ, KST ê¸°ì¤€)
          const todayLogs = logsForChart.filter(log => {
            // í˜„ì¬ ì‹œë¦¬ì¦ˆë§Œ í•„í„°ë§ (ë™ì )
            if (!matchesSeries(log.unit, currentSeries)) return false;
            const logDate = log.completedAt || log.timestamp;
            if (!logDate) return false;
            return toKSTDateString(new Date(logDate)) === selectedDateStr;
          });

          const tableContainer = document.getElementById('todayTableContainer');
          const radarWrap = document.getElementById('today-radar-wrap');

          if (!tableContainer || !radarWrap) return;

          // í•´ë‹¹ ë‚ ì§œì— í†µê³¼í•œ ê´€ë¬¸ ë°ì´í„° ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
          let passedGatesToday = [];
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const studentGrade = urlParams.get('grade') || '';
            const studentName = urlParams.get('name') || '';
            // íŠ¹ì • í•™ìƒì€ í˜•ì„±í‰ê°€ ìˆ¨ê¹€ (í…ŒìŠ¤íŠ¸ ê³„ì •)
            const hideGateStudents = ['ìµœìˆ˜ì¢…'];
            if (!hideGateStudents.includes(studentName)) {
              const gateRes = await fetch('/api/gate-quiz/passed-by-date?grade=' + encodeURIComponent(studentGrade) + '&name=' + encodeURIComponent(studentName) + '&date=' + selectedDateStr);
              const gateData = await gateRes.json();
              if (gateData.ok && gateData.data) {
                passedGatesToday = gateData.data;
              }
            }
          } catch (err) {
            console.error('ê´€ë¬¸ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', err);
          }

          if (todayLogs.length === 0 && passedGatesToday.length === 0) {
            const noDataMsg = isToday(selectedDate) ? 'ì˜¤ëŠ˜ ì™„ë£Œí•œ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' : 'í•´ë‹¹ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
            tableContainer.innerHTML = '<div class="no-data-message" style="text-align:center; color:#333; padding:20px; font-size:14px;">' + noDataMsg + '</div>';
            radarWrap.innerHTML = '<div class="no-data-message" style="width:100%; text-align:center; color:#fff; padding:30px; font-size:14px;">' + noDataMsg + '</div>';
            return;
          }

          // ê³¼ëª© ë§¤í•‘ (ì¢…í•© í•™ìŠµ ê¸°ë¡ê³¼ ë™ì¼)
          const subjectMap = { 'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™', 'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ', 'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™1', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'people': 'í•œêµ­ì¸ë¬¼', 'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼', 'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼' };

          // ë¶„ì•¼ ë§¤í•‘
          const fieldMap = {
            'bio': 'ê³¼í•™ë¶„ì•¼', 'earth': 'ê³¼í•™ë¶„ì•¼', 'physics': 'ê³¼í•™ë¶„ì•¼', 'chem': 'ê³¼í•™ë¶„ì•¼',
            'geo': 'ì‚¬íšŒë¶„ì•¼', 'soc': 'ì‚¬íšŒë¶„ì•¼', 'law': 'ì‚¬íšŒë¶„ì•¼', 'pol': 'ì‚¬íšŒë¶„ì•¼',
            'modern': 'í•œêµ­ë¬¸í•™', 'classic': 'í•œêµ­ë¬¸í•™',
            'world': 'ì„¸ê³„ë¬¸í•™', 'world1': 'ì„¸ê³„ë¬¸í•™', 'world2': 'ì„¸ê³„ë¬¸í•™',
            'people': 'ì¸ë¬¼ë¶„ì•¼', 'people1': 'ì¸ë¬¼ë¶„ì•¼', 'people2': 'ì¸ë¬¼ë¶„ì•¼', 'person1': 'ì¸ë¬¼ë¶„ì•¼', 'person2': 'ì¸ë¬¼ë¶„ì•¼'
          };

          // í´ë” ë§¤í•‘ (subjectKey -> í´ë”ëª…)
          const folderMap = {
            'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
            'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
            'modern': 'korlit', 'classic': 'korlit',
            'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
            'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
          };

          // í…Œì´ë¸” ìƒì„±
          let tableHtml = '<table class="today-table"><thead><tr>';
          tableHtml += '<th>#</th><th>ì‹œë¦¬ì¦ˆ</th><th>ë¶„ì•¼</th><th>ë‹¨ì›ëª…</th><th>ë“±ê¸‰</th><th>í‰ê· </th><th>ì–´íœ˜</th>';
          tableHtml += '</tr></thead><tbody>';

          todayLogs.forEach((log, idx) => {
            const unitCode = log.unit || '';

            // ê³¼ëª©ëª… ì¶”ì¶œ (ì¢…í•© í•™ìŠµ ê¸°ë¡ê³¼ ë™ì¼ ë¡œì§)
            let subjectName = '-';
            let subjectKey = '';
            let numStr = '';
            if (unitCode && unitCode.includes('_')) {
              const parts = unitCode.split('_');
              subjectKey = parts[0];
              numStr = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                subjectKey = parts[1];
                numStr = parts[2];
              }
              let number = numStr ? parseInt(numStr, 10) : 0;
              if (subjectKey === 'world' && number > 40) {
                subjectName = 'ì„¸ê³„ë¬¸í•™2';
              } else {
                subjectName = subjectMap[subjectKey] || subjectKey;
              }
            }

            // ì‹œë¦¬ì¦ˆ ì¶”ì¶œ
            let series = 'BRAINì—…';
            if (unitCode.includes('on_')) series = 'BRAINì˜¨';
            else if (unitCode.includes('fit_')) series = 'BRAINí•';
            else if (unitCode.includes('deep_')) series = 'BRAINë”¥';

            // ë¶„ì•¼
            const field = fieldMap[subjectKey] || 'ê¸°íƒ€';

            // ë‹¨ì›ëª… (UNIT_TITLESì—ì„œ í’€ë„¤ì„ ê°€ì ¸ì˜¤ê¸°)
            // ê³¼ëª©ëª… + ë²ˆí˜¸ í˜•íƒœë¡œ ê¸°ë³¸ê°’ ìƒì„±
            let shortName = unitCode;
            if (unitCode && unitCode.includes('_')) {
              const parts = unitCode.split('_');
              let sk = parts[0];
              let ns = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                sk = parts[1];
                ns = parts[2];
              }
              const subject = subjectMap[sk] || sk;
              let number = ns ? parseInt(ns, 10) : 0;
              shortName = subject + ' ' + number;
            }

            // UNIT_TITLESì—ì„œ í’€ë„¤ì„ ê°€ì ¸ì˜¤ê¸°, ì—†ìœ¼ë©´ shortName ì‚¬ìš©
            const fullTitle = UNIT_TITLES[unitCode];
            let unitName = fullTitle ? (shortName + ' ' + fullTitle) : shortName;

            // ë ˆì´ë” í‰ê·  ì ìˆ˜ ê³„ì‚° (ì¢…í•© í•™ìŠµ ê¸°ë¡ê³¼ ë™ì¼)
            const r = log.radar || {};
            const scores = [r.literal, r.structural, r.lexical, r.inferential, r.critical].filter(s => s != null);
            const avgScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;

            // ë“±ê¸‰ ê²°ì • (ì¢…í•© í•™ìŠµ ê¸°ë¡ê³¼ ë™ì¼)
            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            if (avgScore >= 9) {
              badgeClass = 'badge-excellent';
              badgeText = 'ìš°ìˆ˜';
            } else if (avgScore >= 8) {
              badgeClass = 'badge-good';
              badgeText = 'ì–‘í˜¸';
            } else if (avgScore >= 7) {
              badgeClass = 'badge-normal';
              badgeText = 'ë³´í†µ';
            } else {
              badgeClass = 'badge-encourage';
              badgeText = 'ê²©ë ¤';
            }

            // ì–´íœ˜ ì ìˆ˜ - UNIT_PROGRESS_MAPì—ì„œ vocabState ê°€ì ¸ì˜¤ê¸°
            // 1ì°¨: ì›ë³¸ unitCodeë¡œ ì¡°íšŒ (on_bio_01, fit_bio_01 ë“±)
            // 2ì°¨ fallback: ì ‘ë‘ì–´ ì œê±° ë²„ì „ìœ¼ë¡œ ì¡°íšŒ (bio_01 ë“±)
            let unitProgress = UNIT_PROGRESS_MAP[unitCode] || {};

            // fallback: ì ‘ë‘ì–´ ì œê±° ë²„ì „ìœ¼ë¡œ ì¬ì¡°íšŒ
            if (!unitProgress.vocabState) {
              let normalizedUnitCode = unitCode;
              if (unitCode.startsWith('fit_')) normalizedUnitCode = unitCode.substring(4);
              else if (unitCode.startsWith('deep_')) normalizedUnitCode = unitCode.substring(5);
              else if (unitCode.startsWith('on_')) normalizedUnitCode = unitCode.substring(3);
              unitProgress = UNIT_PROGRESS_MAP[normalizedUnitCode] || {};
            }

            // vocabStateì—ì„œ ì§ì ‘ ì ìˆ˜ ê³„ì‚°
            let vocabScorePercent = 0;
            const vocabState = unitProgress.vocabState;
            if (vocabState && vocabState.vocabData && Array.isArray(vocabState.vocabData)) {
              const total = vocabState.vocabData.length;
              const correct = vocabState.vocabData.filter(v => v.isCorrect).length;
              if (total > 0) {
                vocabScorePercent = Math.round((correct / total) * 100);
              }
            } else {
              // fallback: reportState.vocabScoreRatio ì‚¬ìš©
              const reportState = unitProgress.reportState || {};
              const vocabScoreRatio = reportState.vocabScoreRatio || 0;
              vocabScorePercent = Math.round(vocabScoreRatio * 100);
            }
            const vocabScoreDisplay = vocabScorePercent > 0 ? vocabScorePercent + 'ì ' : '-';

            // ì–´íœ˜ í•™ìŠµ í˜ì´ì§€ URL ìƒì„±
            const folder = folderMap[subjectKey] || 'science';
            const vocabPageUrl = '/BRAINUP/' + folder + '/' + unitCode + '.html?tab=vocab';

            tableHtml += '<tr>';
            tableHtml += '<td>' + (idx + 1) + '</td>';
            tableHtml += '<td>' + series + '</td>';
            tableHtml += '<td>' + field + '</td>';
            tableHtml += '<td>' + unitName + '</td>';
            tableHtml += '<td><span class="badge ' + badgeClass + '">' + badgeText + '</span></td>';
            tableHtml += '<td>' + avgScore.toFixed(1) + '</td>';
            // ì–´íœ˜ ì ìˆ˜ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì› ì–´íœ˜ í˜ì´ì§€ë¡œ ì´ë™
            if (vocabScorePercent > 0) {
              tableHtml += '<td><span class="vocab-score-link" onclick="goToVocabPage(' + "'" + vocabPageUrl + "'" + ')" style="cursor:pointer; color:#3b82f6 !important; font-weight:600;">' + vocabScoreDisplay + '</span></td>';
            } else {
              tableHtml += '<td>' + vocabScoreDisplay + '</td>';
            }
            tableHtml += '</tr>';
          });

          // í˜•ì„±í‰ê°€ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì¶”ê°€
          if (passedGatesToday.length > 0) {
            passedGatesToday.forEach((gateInfo) => {
              const passedTime = gateInfo.passedAt ? new Date(gateInfo.passedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';
              tableHtml += '<tr class="gate-pass-row" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); cursor: pointer;" onclick="showGateDetailModal(' + gateInfo.gate + ')">';
              tableHtml += '<td style="text-align:center;">ğŸ†</td>';
              tableHtml += '<td colspan="2" style="font-weight:600; color:#92400e;">í˜•ì„±í‰ê°€</td>';
              tableHtml += '<td style="font-weight:700; color:#78350f;">ê´€ë¬¸ ' + gateInfo.gate + ' í†µê³¼</td>';
              tableHtml += '<td><span class="badge" style="background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff;">í†µê³¼</span></td>';
              tableHtml += '<td style="color:#92400e;">' + passedTime + '</td>';
              tableHtml += '<td></td>';
              tableHtml += '</tr>';
            });
          }

          tableHtml += '</tbody></table>';
          tableContainer.innerHTML = tableHtml;

          // ë ˆì´ë” ì¹´ë“œ ìƒì„± (ë‹¨ì›ë³„ ë¬¸í•´ë ¥ ë ˆì´ë” ì°¨íŠ¸ì™€ ë™ì¼ ìŠ¤íƒ€ì¼)
          radarWrap.innerHTML = '';

          todayLogs.forEach((log, idx) => {
            const unitCode = log.unit || '';
            const r = log.radar || {};

            // ì ìˆ˜ ê³„ì‚°
            const scores = [
              r.literal || 0,
              r.structural || 0,
              r.lexical || 0,
              r.inferential || 0,
              r.critical || 0
            ];
            const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
            const maxScore = Math.max(...scores).toFixed(1);
            const minScore = Math.min(...scores).toFixed(1);

            // ë“±ê¸‰ ê²°ì •
            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            if (avgScore >= 9) {
              badgeClass = 'badge-excellent';
              badgeText = 'ìš°ìˆ˜';
            } else if (avgScore >= 8) {
              badgeClass = 'badge-good';
              badgeText = 'ì–‘í˜¸';
            } else if (avgScore >= 7) {
              badgeClass = 'badge-normal';
              badgeText = 'ë³´í†µ';
            } else {
              badgeClass = 'badge-encourage';
              badgeText = 'ê²©ë ¤';
            }

            // ë‹¨ì›ëª… (ì§§ì€ í˜•íƒœ)
            let shortName = unitCode;
            if (unitCode && unitCode.includes('_')) {
              const parts = unitCode.split('_');
              let sk = parts[0];
              let ns = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                sk = parts[1];
                ns = parts[2];
              }
              const subject = subjectMap[sk] || sk;
              let number = ns ? parseInt(ns, 10) : 0;
              shortName = subject + ' ' + number;
            }

            // ì¹´ë“œ ìƒì„± (radar-card í´ë˜ìŠ¤ ì‚¬ìš©)
            const card = document.createElement('div');
            card.className = 'radar-card';
            // AI í”¼ë“œë°±ìš© ë ˆì´ë” ì ìˆ˜ ë°ì´í„° ì €ì¥
            card.setAttribute('data-radar', JSON.stringify({
              literal: r.literal || 0,
              structural: r.structural || 0,
              lexical: r.lexical || 0,
              inferential: r.inferential || 0,
              critical: r.critical || 0
            }));

            const header = document.createElement('div');
            header.className = 'radar-card-header';

            const title = document.createElement('div');
            title.className = 'radar-card-title';
            title.textContent = shortName;

            const time = document.createElement('div');
            time.className = 'radar-card-time';
            time.innerHTML = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}) : '-';

            const badge = document.createElement('div');
            badge.className = 'score-badge ' + badgeClass;
            badge.textContent = badgeText;

            header.appendChild(title);
            header.appendChild(time);
            header.appendChild(badge);
            card.appendChild(header);

            const canvas = document.createElement('canvas');
            canvas.id = 'todayRadar' + idx;
            canvas.width = 130;
            canvas.height = 130;
            card.appendChild(canvas);

            // í†µê³„ ì •ë³´
            const stats = document.createElement('div');
            stats.className = 'radar-card-stats';
            stats.innerHTML =
              '<div class="stat-item">' +
                '<div class="stat-label">í‰ê· </div>' +
                '<div class="stat-value">' + avgScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœê³ </div>' +
                '<div class="stat-value">' + maxScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœì €</div>' +
                '<div class="stat-value">' + minScore + '</div>' +
              '</div>';
            card.appendChild(stats);

            // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì› í˜ì´ì§€ë¡œ ì´ë™
            card.style.cursor = 'pointer';
            card.addEventListener('click', function() {
              if (unitCode) {
                const parts = unitCode.split('_');
                let subject = parts[0] || '';
                if ((subject === 'fit' || subject === 'deep' || subject === 'on') && parts.length >= 3) {
                  subject = parts[1];
                }
                const folderMap = {
                  'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
                  'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
                  'modern': 'korlit', 'classic': 'korlit',
                  'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
                  'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
                };
                const folder = folderMap[subject] || 'social';
                const unitUrl = '/BRAINUP/' + folder + '/' + unitCode + '.html';
                window.location.href = unitUrl;
              }
            });

            radarWrap.appendChild(card);

            // Chart.js ë ˆì´ë” ì°¨íŠ¸ ìƒì„±
            new Chart(canvas.getContext('2d'), {
              type: 'radar',
              data: {
                labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
                datasets: [{
                  data: scores,
                  backgroundColor: 'rgba(102, 126, 234, 0.2)',
                  borderColor: '#667eea',
                  borderWidth: 2,
                  pointBackgroundColor: '#667eea',
                  pointBorderColor: '#fff',
                  pointBorderWidth: 1,
                  pointRadius: 3
                }]
              },
              options: {
                responsive: false,
                layout: {
                  padding: {
                    top: 10,
                    bottom: 5,
                    left: 5,
                    right: 5
                  }
                },
                plugins: {
                  legend: { display: false },
                  datalabels: { display: false }
                },
                scales: {
                  r: {
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: {
                      display: false,
                      stepSize: 2
                    },
                    grid: {
                      color: 'rgba(102, 126, 234, 0.1)'
                    },
                    angleLines: {
                      color: 'rgba(102, 126, 234, 0.1)'
                    },
                    pointLabels: {
                      display: false
                    }
                  }
                }
              }
            });
          });
        }

        // ===== ì£¼ê°„ ë¦¬í¬íŠ¸ ë Œë”ë§ í•¨ìˆ˜ =====
        async function renderWeeklySection() {
          const weekStart = new Date(selectedWeekStart);
          const weekEnd = getWeekEnd(weekStart);

          // ì£¼ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
          const weekDisplay = document.getElementById('currentWeekDisplay');
          const description = document.getElementById('todayDescription');
          const nextBtn = document.getElementById('weekNextBtn');

          const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
          const formatFull = (d) => d.getFullYear() + 'ë…„ ' + (d.getMonth() + 1) + 'ì›” ' + d.getDate() + 'ì¼';

          if (weekDisplay) {
            weekDisplay.textContent = formatFull(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';
          }
          if (description) {
            description.textContent = 'í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì…ë‹ˆë‹¤. (ì›”~ì¼)';
          }

          // ì´ë²ˆ ì£¼ ì´í›„ë¡œëŠ” ì´ë™ ë¶ˆê°€
          const todayWeekStart = getWeekStart(new Date());
          if (nextBtn) {
            if (weekStart >= todayWeekStart) {
              nextBtn.style.opacity = '0.3';
              nextBtn.style.cursor = 'not-allowed';
              nextBtn.disabled = true;
            } else {
              nextBtn.style.opacity = '1';
              nextBtn.style.cursor = 'pointer';
              nextBtn.disabled = false;
            }
          }

          // ì£¼ê°„ ë‚ ì§œ ë°°ì—´ ìƒì„± (ì›”~ì¼)
          const weekDates = [];
          for (let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + i);
            weekDates.push(toKSTDateString(d));
          }

          // ì£¼ê°„ í•™ìŠµ ê¸°ë¡ í•„í„°ë§
          const weeklyLogs = logsForChart.filter(log => {
            if (!matchesSeries(log.unit, currentSeries)) return false;
            const logDate = log.completedAt || log.timestamp;
            if (!logDate) return false;
            const logDateStr = toKSTDateString(new Date(logDate));
            return weekDates.includes(logDateStr);
          });

          const tableContainer = document.getElementById('todayTableContainer');
          const radarWrap = document.getElementById('today-radar-wrap');

          if (!tableContainer || !radarWrap) return;

          if (weeklyLogs.length === 0) {
            tableContainer.innerHTML = '<div class="no-data-message" style="text-align:center; color:#333; padding:20px; font-size:14px;">í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            radarWrap.innerHTML = '<div class="no-data-message" style="width:100%; text-align:center; color:#fff; padding:30px; font-size:14px;">í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            // ë‹¤ë¥¸ ì„¹ì…˜ íƒ€ì´í‹€ë„ ì£¼ê°„ìœ¼ë¡œ ë³€ê²½
            updateWeeklySectionTitles(weekStart, weekEnd);
            // ì§€ìˆ˜ ì¶”ì´ ê·¸ë˜í”„ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
            if (typeof window.updateIndexTrendChart === 'function') window.updateIndexTrendChart();
            // ê³¼ëª© í‰ê·  í‰ì  ê·¸ë˜í”„ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
            if (typeof window.updateSubjectBarChart === 'function') window.updateSubjectBarChart();
            // ì–´íœ˜ ì ìˆ˜ ê·¸ë˜í”„ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
            if (typeof renderVocabScoreChart === 'function') renderVocabScoreChart();
            // ì°½ì˜í™œë™ ë‚´ì—­ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
            if (typeof renderCreativeTable === 'function') renderCreativeTable();
            return;
          }

          // ê³¼ëª© ë§¤í•‘
          const subjectMap = { 'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™', 'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ', 'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™1', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'people': 'í•œêµ­ì¸ë¬¼', 'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼', 'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼' };

          // ë¶„ì•¼ ë§¤í•‘
          const fieldMap = {
            'bio': 'ê³¼í•™ë¶„ì•¼', 'earth': 'ê³¼í•™ë¶„ì•¼', 'physics': 'ê³¼í•™ë¶„ì•¼', 'chem': 'ê³¼í•™ë¶„ì•¼',
            'geo': 'ì‚¬íšŒë¶„ì•¼', 'soc': 'ì‚¬íšŒë¶„ì•¼', 'law': 'ì‚¬íšŒë¶„ì•¼', 'pol': 'ì‚¬íšŒë¶„ì•¼',
            'modern': 'í•œêµ­ë¬¸í•™', 'classic': 'í•œêµ­ë¬¸í•™',
            'world': 'ì„¸ê³„ë¬¸í•™', 'world1': 'ì„¸ê³„ë¬¸í•™', 'world2': 'ì„¸ê³„ë¬¸í•™',
            'people': 'ì¸ë¬¼ë¶„ì•¼', 'people1': 'ì¸ë¬¼ë¶„ì•¼', 'people2': 'ì¸ë¬¼ë¶„ì•¼', 'person1': 'ì¸ë¬¼ë¶„ì•¼', 'person2': 'ì¸ë¬¼ë¶„ì•¼'
          };

          const folderMap = {
            'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
            'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
            'modern': 'korlit', 'classic': 'korlit',
            'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
            'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
          };

          // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
          const logsByDate = {};
          weekDates.forEach(dateStr => { logsByDate[dateStr] = []; });
          weeklyLogs.forEach(log => {
            const logDate = log.completedAt || log.timestamp;
            const logDateStr = toKSTDateString(new Date(logDate));
            if (logsByDate[logDateStr]) {
              logsByDate[logDateStr].push(log);
            }
          });

          // ì£¼ê°„ ê¸°ê°„ ë™ì•ˆì˜ ê´€ë¬¸ í†µê³¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const urlParams = new URLSearchParams(window.location.search);
          const studentGrade = urlParams.get('grade') || '';
          const studentName = urlParams.get('name') || '';
          let weeklyGatePasses = [];
          // íŠ¹ì • í•™ìƒì€ í˜•ì„±í‰ê°€ ìˆ¨ê¹€ (í…ŒìŠ¤íŠ¸ ê³„ì •)
          const hideGateStudents = ['ìµœìˆ˜ì¢…'];
          if (!hideGateStudents.includes(studentName)) {
            try {
              const gatePromises = weekDates.map(dateStr =>
                fetch('/api/gate-quiz/passed-by-date?grade=' + encodeURIComponent(studentGrade) + '&name=' + encodeURIComponent(studentName) + '&date=' + dateStr)
                  .then(res => res.json())
                  .then(data => ({ date: dateStr, gates: data.ok && data.data ? data.data : [] }))
              );
              weeklyGatePasses = await Promise.all(gatePromises);
            } catch (err) {
              console.error('ì£¼ê°„ ê´€ë¬¸ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', err);
            }
          }
          // ë‚ ì§œë³„ ê´€ë¬¸ ë°ì´í„° ë§µ
          const gatesByDate = {};
          weeklyGatePasses.forEach(item => { gatesByDate[item.date] = item.gates; });

          // ìš”ì¼ ì´ë¦„
          const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

          // í…Œì´ë¸” ìƒì„± (ë‚ ì§œë³„ë¡œ êµ¬ë¶„ - ê¸°ë¡ì´ ìˆëŠ” ë‚ ë§Œ í‘œì‹œ)
          let tableHtml = '';
          let displayedCount = 0;
          weekDates.forEach((dateStr, dayIdx) => {
            const dayLogs = logsByDate[dateStr];
            const dayGates = gatesByDate[dateStr] || [];

            // í•™ìŠµ ê¸°ë¡ê³¼ ê´€ë¬¸ ëª¨ë‘ ì—†ëŠ” ë‚ ì€ ìŠ¤í‚µ
            if (dayLogs.length === 0 && dayGates.length === 0) return;

            const dateObj = new Date(dateStr + 'T00:00:00');
            const dayName = dayNames[dateObj.getDay()];
            const displayDate = (dateObj.getMonth() + 1) + '/' + dateObj.getDate() + ' (' + dayName + ')';

            // ë‚ ì§œ í—¤ë” (í°ìƒ‰ ë°°ê²½, ê²€ì€ ê¸€ì”¨)
            const totalCount = dayLogs.length + dayGates.length;
            tableHtml += '<div class="weekly-day-header" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%); padding: 12px 16px; margin-top: ' + (displayedCount === 0 ? '0' : '15px') + '; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(0,0,0,0.08); border-bottom: none;">';
            tableHtml += '<span style="color: #333; font-weight: 700; font-size: 15px;">ğŸ“… ' + displayDate + '</span>';
            tableHtml += '<span style="color: #667eea; font-size: 13px; font-weight: 600;">' + totalCount + 'ê±´</span>';
            tableHtml += '</div>';

            displayedCount++;
            {
              tableHtml += '<table class="today-table" style="margin-bottom: 0; border-radius: 0 0 10px 10px; overflow: hidden;"><thead><tr>';
              tableHtml += '<th>#</th><th>ì‹œë¦¬ì¦ˆ</th><th>ë¶„ì•¼</th><th>ë‹¨ì›ëª…</th><th>ë“±ê¸‰</th><th>í‰ê· </th><th>ì–´íœ˜</th>';
              tableHtml += '</tr></thead><tbody>';

              dayLogs.forEach((log, idx) => {
                const unitCode = log.unit || '';
                let subjectName = '-';
                let subjectKey = '';
                let numStr = '';
                if (unitCode && unitCode.includes('_')) {
                  const parts = unitCode.split('_');
                  subjectKey = parts[0];
                  numStr = parts[1];
                  if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                    subjectKey = parts[1];
                    numStr = parts[2];
                  }
                  let number = numStr ? parseInt(numStr, 10) : 0;
                  if (subjectKey === 'world' && number > 40) {
                    subjectName = 'ì„¸ê³„ë¬¸í•™2';
                  } else {
                    subjectName = subjectMap[subjectKey] || subjectKey;
                  }
                }

                let series = 'BRAINì—…';
                if (unitCode.includes('on_')) series = 'BRAINì˜¨';
                else if (unitCode.includes('fit_')) series = 'BRAINí•';
                else if (unitCode.includes('deep_')) series = 'BRAINë”¥';

                const field = fieldMap[subjectKey] || 'ê¸°íƒ€';

                let shortName = unitCode;
                if (unitCode && unitCode.includes('_')) {
                  const parts = unitCode.split('_');
                  let sk = parts[0];
                  let ns = parts[1];
                  if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                    sk = parts[1];
                    ns = parts[2];
                  }
                  const subject = subjectMap[sk] || sk;
                  let number = ns ? parseInt(ns, 10) : 0;
                  shortName = subject + ' ' + number;
                }

                const fullTitle = UNIT_TITLES[unitCode];
                let unitName = fullTitle ? (shortName + ' ' + fullTitle) : shortName;

                const r = log.radar || {};
                const scores = [r.literal, r.structural, r.lexical, r.inferential, r.critical].filter(s => s != null);
                const avgScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;

                // ë“±ê¸‰ ê²°ì • (ì¼ê°„ë¦¬í¬íŠ¸ì™€ ë™ì¼)
                let badgeClass = 'badge-normal';
                let badgeText = 'ë³´í†µ';
                if (avgScore >= 9) { badgeClass = 'badge-excellent'; badgeText = 'ìš°ìˆ˜'; }
                else if (avgScore >= 8) { badgeClass = 'badge-good'; badgeText = 'ì–‘í˜¸'; }
                else if (avgScore >= 7) { badgeClass = 'badge-normal'; badgeText = 'ë³´í†µ'; }
                else { badgeClass = 'badge-encourage'; badgeText = 'ê²©ë ¤'; }

                // ì–´íœ˜ ì ìˆ˜ - UNIT_PROGRESS_MAPì—ì„œ vocabState ê°€ì ¸ì˜¤ê¸° (ì¼ê°„ë¦¬í¬íŠ¸ì™€ ë™ì¼)
                let unitProgress = UNIT_PROGRESS_MAP[unitCode] || {};
                if (!unitProgress.vocabState) {
                  let normalizedUnitCode = unitCode;
                  if (unitCode.startsWith('fit_')) normalizedUnitCode = unitCode.substring(4);
                  else if (unitCode.startsWith('deep_')) normalizedUnitCode = unitCode.substring(5);
                  else if (unitCode.startsWith('on_')) normalizedUnitCode = unitCode.substring(3);
                  unitProgress = UNIT_PROGRESS_MAP[normalizedUnitCode] || {};
                }

                let vocabScorePercent = 0;
                const vocabState = unitProgress.vocabState;
                if (vocabState && vocabState.vocabData && Array.isArray(vocabState.vocabData)) {
                  const total = vocabState.vocabData.length;
                  const correct = vocabState.vocabData.filter(v => v.isCorrect).length;
                  if (total > 0) {
                    vocabScorePercent = Math.round((correct / total) * 100);
                  }
                } else {
                  const reportState = unitProgress.reportState || {};
                  const vocabScoreRatio = reportState.vocabScoreRatio || 0;
                  vocabScorePercent = Math.round(vocabScoreRatio * 100);
                }
                const vocabScoreDisplay = vocabScorePercent > 0 ? vocabScorePercent + 'ì ' : '-';

                const folder = folderMap[subjectKey] || 'science';
                const unitUrl = '/BRAINUP/' + folder + '/' + unitCode + '.html';
                const vocabPageUrl = '/BRAINUP/' + folder + '/' + unitCode + '.html?tab=vocab';

                tableHtml += '<tr onclick="window.open(\\'' + unitUrl + '\\', \\'_blank\\')" style="cursor:pointer;">';
                tableHtml += '<td>' + (idx + 1) + '</td>';
                tableHtml += '<td>' + series + '</td>';
                tableHtml += '<td>' + field + '</td>';
                tableHtml += '<td>' + unitName + '</td>';
                tableHtml += '<td><span class="badge ' + badgeClass + '">' + badgeText + '</span></td>';
                tableHtml += '<td>' + avgScore.toFixed(1) + '</td>';
                if (vocabScorePercent > 0) {
                  tableHtml += '<td><span style="color:#3b82f6; font-weight:600;">' + vocabScoreDisplay + '</span></td>';
                } else {
                  tableHtml += '<td>' + vocabScoreDisplay + '</td>';
                }
                tableHtml += '</tr>';
              });

              // í•´ë‹¹ ë‚ ì§œì˜ í˜•ì„±í‰ê°€ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì¶”ê°€
              if (dayGates.length > 0) {
                dayGates.forEach((gateInfo) => {
                  const passedTime = gateInfo.passedAt ? new Date(gateInfo.passedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';
                  tableHtml += '<tr class="gate-pass-row" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); cursor: pointer;" onclick="showGateDetailModal(' + gateInfo.gate + ')">';
                  tableHtml += '<td style="text-align:center;">ğŸ†</td>';
                  tableHtml += '<td colspan="2" style="font-weight:600; color:#92400e;">í˜•ì„±í‰ê°€</td>';
                  tableHtml += '<td style="font-weight:700; color:#78350f;">ê´€ë¬¸ ' + gateInfo.gate + ' í†µê³¼</td>';
                  tableHtml += '<td><span class="badge" style="background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff;">í†µê³¼</span></td>';
                  tableHtml += '<td style="color:#92400e;">' + passedTime + '</td>';
                  tableHtml += '<td></td>';
                  tableHtml += '</tr>';
                });
              }

              tableHtml += '</tbody></table>';
            }
          });

          tableContainer.innerHTML = tableHtml;

          // ì£¼ê°„ ë ˆì´ë” ì¹´ë“œ ë Œë”ë§
          renderWeeklyRadarCards(weeklyLogs, subjectMap);

          // ë ˆì´ë” ë„¤ë¹„ê²Œì´í„° ë‚ ì§œë„ í…Œì´ë¸”ê³¼ ë™ê¸°í™”
          selectedWeekRadarStart = new Date(weekStart);
          const weekRadarDisplay = document.getElementById('currentWeekRadarDisplay');
          const formatShortR = (d) => (d.getMonth() + 1) + '/' + d.getDate();
          const formatFullR = (d) => d.getFullYear() + 'ë…„ ' + (d.getMonth() + 1) + 'ì›” ' + d.getDate() + 'ì¼';
          if (weekRadarDisplay) {
            weekRadarDisplay.textContent = formatFullR(weekStart) + ' (ì›”) ~ ' + formatShortR(weekEnd) + ' (ì¼)';
          }
          const radarTitle = document.getElementById('radarSectionTitle');
          if (radarTitle) {
            radarTitle.textContent = 'ğŸ“Š ' + formatShortR(weekStart) + '~' + formatShortR(weekEnd) + ' ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”';
          }

          // ë‹¤ë¥¸ ì„¹ì…˜ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
          updateWeeklySectionTitles(weekStart, weekEnd);

          // ì§€ìˆ˜ ì¶”ì´ ê·¸ë˜í”„ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if (typeof window.updateIndexTrendChart === 'function') window.updateIndexTrendChart();
          // ê³¼ëª© í‰ê·  í‰ì  ê·¸ë˜í”„ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if (typeof window.updateSubjectBarChart === 'function') window.updateSubjectBarChart();
          // ì–´íœ˜ ì ìˆ˜ ê·¸ë˜í”„ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if (typeof renderVocabScoreChart === 'function') renderVocabScoreChart();
          // ì°½ì˜í™œë™ ë‚´ì—­ë„ ì£¼ê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if (typeof renderCreativeTable === 'function') renderCreativeTable();
        }

        // ì£¼ê°„ ë ˆì´ë” ì¹´ë“œ ë Œë”ë§ (ì¼ê°„ê³¼ ë™ì¼í•œ ë°©ì‹ - Chart.js ì‚¬ìš©)
        function renderWeeklyRadarCards(logs, subjectMap) {
          const radarWrap = document.getElementById('today-radar-wrap');
          const radarGrid = document.getElementById('todayRadarGrid');
          if (!radarWrap) return;

          // ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ íŒŒê´´
          weeklyRadarCharts.forEach(chart => {
            if (chart && typeof chart.destroy === 'function') {
              chart.destroy();
            }
          });
          weeklyRadarCharts = [];

          radarWrap.innerHTML = '';
          if (radarGrid) radarGrid.innerHTML = '';

          if (logs.length === 0) {
            radarWrap.innerHTML = '<div class="no-data-message" style="width:100%; text-align:center; color:#fff; padding:30px; font-size:14px;">í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }

          const folderMap = {
            'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
            'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
            'modern': 'korlit', 'classic': 'korlit',
            'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
            'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
          };

          logs.forEach((log, idx) => {
            const unitCode = log.unit || '';
            const r = log.radar || {};

            const scores = [
              r.literal || 0,
              r.structural || 0,
              r.lexical || 0,
              r.inferential || 0,
              r.critical || 0
            ];
            const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
            const maxScore = Math.max(...scores).toFixed(1);
            const minScore = Math.min(...scores).toFixed(1);

            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            if (avgScore >= 9) { badgeClass = 'badge-excellent'; badgeText = 'ìš°ìˆ˜'; }
            else if (avgScore >= 8) { badgeClass = 'badge-good'; badgeText = 'ì–‘í˜¸'; }
            else if (avgScore >= 7) { badgeClass = 'badge-normal'; badgeText = 'ë³´í†µ'; }
            else { badgeClass = 'badge-encourage'; badgeText = 'ê²©ë ¤'; }

            let shortName = unitCode;
            if (unitCode && unitCode.includes('_')) {
              const parts = unitCode.split('_');
              let sk = parts[0];
              let ns = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                sk = parts[1];
                ns = parts[2];
              }
              const subject = subjectMap[sk] || sk;
              let number = ns ? parseInt(ns, 10) : 0;
              shortName = subject + ' ' + number;
            }

            // ì™„ë£Œ ë‚ ì§œ
            const completedDate = new Date(log.completedAt || log.timestamp);
            const dateStr = (completedDate.getMonth() + 1) + '/' + completedDate.getDate();

            // ì¹´ë“œ ìƒì„± (radar-card í´ë˜ìŠ¤ ì‚¬ìš© - ì¼ê°„ê³¼ ë™ì¼)
            const card = document.createElement('div');
            card.className = 'radar-card';

            const header = document.createElement('div');
            header.className = 'radar-card-header';

            const title = document.createElement('div');
            title.className = 'radar-card-title';
            title.textContent = shortName;

            const time = document.createElement('div');
            time.className = 'radar-card-time';
            time.textContent = dateStr;

            const badge = document.createElement('div');
            badge.className = 'score-badge ' + badgeClass;
            badge.textContent = badgeText;

            header.appendChild(title);
            header.appendChild(time);
            header.appendChild(badge);
            card.appendChild(header);

            const canvas = document.createElement('canvas');
            canvas.id = 'weeklyRadar' + idx;
            canvas.width = 130;
            canvas.height = 130;
            card.appendChild(canvas);

            const stats = document.createElement('div');
            stats.className = 'radar-card-stats';
            stats.innerHTML =
              '<div class="stat-item">' +
                '<div class="stat-label">í‰ê· </div>' +
                '<div class="stat-value">' + avgScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœê³ </div>' +
                '<div class="stat-value">' + maxScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœì €</div>' +
                '<div class="stat-value">' + minScore + '</div>' +
              '</div>';
            card.appendChild(stats);

            // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì› í˜ì´ì§€ë¡œ ì´ë™
            card.style.cursor = 'pointer';
            card.addEventListener('click', function() {
              if (unitCode) {
                const parts = unitCode.split('_');
                let subject = parts[0] || '';
                if ((subject === 'fit' || subject === 'deep' || subject === 'on') && parts.length >= 3) {
                  subject = parts[1];
                }
                const folder = folderMap[subject] || 'social';
                const unitUrl = '/BRAINUP/' + folder + '/' + unitCode + '.html';
                window.location.href = unitUrl;
              }
            });

            radarWrap.appendChild(card);

            // Chart.js ë ˆì´ë” ì°¨íŠ¸ ìƒì„± ë° ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
            const chartInstance = new Chart(canvas.getContext('2d'), {
              type: 'radar',
              data: {
                labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
                datasets: [{
                  data: scores,
                  backgroundColor: 'rgba(102, 126, 234, 0.2)',
                  borderColor: '#667eea',
                  borderWidth: 2,
                  pointBackgroundColor: '#667eea',
                  pointBorderColor: '#fff',
                  pointBorderWidth: 1,
                  pointRadius: 3
                }]
              },
              options: {
                responsive: false,
                layout: {
                  padding: { top: 10, bottom: 5, left: 5, right: 5 }
                },
                plugins: {
                  legend: { display: false },
                  datalabels: { display: false }
                },
                scales: {
                  r: {
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: { display: false, stepSize: 2 },
                    grid: { color: 'rgba(102, 126, 234, 0.1)' },
                    angleLines: { color: 'rgba(102, 126, 234, 0.1)' },
                    pointLabels: { display: false }
                  }
                }
              }
            });
            weeklyRadarCharts.push(chartInstance);
          });
        }

        // ì£¼ê°„ ëª¨ë“œì¼ ë•Œ ë‹¤ë¥¸ ì„¹ì…˜ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        function updateWeeklySectionTitles(weekStart, weekEnd) {
          const formatRange = (s, e) => (s.getMonth() + 1) + '/' + s.getDate() + '~' + (e.getMonth() + 1) + '/' + e.getDate();
          const rangeStr = formatRange(weekStart, weekEnd);

          // ë ˆì´ë” ì„¹ì…˜ íƒ€ì´í‹€
          const radarTitle = document.querySelector('.today-radar-title');
          if (radarTitle && radarTitle.textContent.includes('ì˜¤ëŠ˜')) {
            radarTitle.textContent = 'ğŸ“Š ' + rangeStr + ' ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”';
          }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ì£¼ê°„/ì¼ê°„ ëª¨ë“œ ì´ˆê¸°í™”
        if (!initWeeklyModeFromUrl()) {
          // ì¼ê°„ ëª¨ë“œì¼ ë•Œë§Œ Today ì„¹ì…˜ ë Œë”ë§
          renderTodaySection();
        }

        // ì§€ìˆ˜ë³„ ì¶”ì´ ê·¸ë˜í”„ ë Œë”ë§
        renderIndexTrendChart();

        // ë‚ ì§œë³„ ê³¼ëª© í‰ê·  í‰ì  ë§‰ëŒ€ ê·¸ë˜í”„ ë Œë”ë§
        renderSubjectBarChart();

        // ===== ë‚ ì§œë³„ ì–´íœ˜ ì ìˆ˜ ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ ë Œë”ë§ =====
        let vocabScoreCurrentDate = new Date(); // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ

        // ê³¼ëª©ë³„ ìƒ‰ìƒ ì„¤ì • (ê¸°ì¡´ subjectConfig ì¬ì‚¬ìš©)
        const vocabSubjectConfig = [
          { key: 'bio', name: 'ìƒë¬¼', color: '#4CAF50' },
          { key: 'earth', name: 'ì§€êµ¬ê³¼í•™', color: '#2196F3' },
          { key: 'physics', name: 'ë¬¼ë¦¬', color: '#9C27B0' },
          { key: 'chem', name: 'í™”í•™', color: '#FF5722' },
          { key: 'soc', name: 'ì‚¬íšŒë¬¸í™”', color: '#E91E63' },
          { key: 'geo', name: 'ì§€ë¦¬', color: '#00BCD4' },
          { key: 'law', name: 'ë²•', color: '#795548' },
          { key: 'pol', name: 'ì •ì¹˜ê²½ì œ', color: '#607D8B' },
          { key: 'classic', name: 'ê³ ì „ì†Œì„¤', color: '#8BC34A' },
          { key: 'modern', name: 'í˜„ëŒ€ë¬¸í•™', color: '#FFC107' },
          { key: 'world1', name: 'ì„¸ê³„ë¬¸í•™1', color: '#FF9800' },
          { key: 'world2', name: 'ì„¸ê³„ë¬¸í•™2', color: '#F44336' },
          { key: 'person1', name: 'í•œêµ­ì¸ë¬¼', color: '#673AB7' },
          { key: 'person2', name: 'ì„¸ê³„ì¸ë¬¼', color: '#3F51B5' },
          { key: 'people1', name: 'í•œêµ­ì¸ë¬¼', color: '#673AB7' },
          { key: 'people2', name: 'ì„¸ê³„ì¸ë¬¼', color: '#3F51B5' }
        ];

        function getVocabSubjectColor(unitCode) {
          if (!unitCode) return '#888';
          const parts = unitCode.split('_');
          let subjectKey = parts[0];

          // fit_, deep_, on_ ì ‘ë‘ì‚¬ ì²˜ë¦¬
          if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
            subjectKey = parts[1];
          }

          const found = vocabSubjectConfig.find(s => s.key === subjectKey);
          return found ? found.color : '#888';
        }

        function getVocabSubjectName(unitCode) {
          if (!unitCode) return 'ê¸°íƒ€';
          const parts = unitCode.split('_');
          let subjectKey = parts[0];
          let unitNum = '';

          // fit_, deep_, on_ ì ‘ë‘ì‚¬ ì²˜ë¦¬
          if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
            subjectKey = parts[1];
            unitNum = parts[2] || '';
          } else {
            unitNum = parts[1] || '';
          }

          const found = vocabSubjectConfig.find(s => s.key === subjectKey);
          const subjectName = found ? found.name : subjectKey;
          return unitNum ? subjectName + ' ' + unitNum : subjectName;
        }

        function renderVocabScoreChart() {
          const section = document.getElementById('vocabScoreSection');
          const container = document.getElementById('vocabScoreChartContainer');
          const dateDisplay = document.getElementById('vocabScoreDate');
          const prevBtn = document.getElementById('vocabScorePrev');
          const nextBtn = document.getElementById('vocabScoreNext');

          if (!section || !container) return;

          let dayLogs;

          if (isWeeklyMode) {
            // ì£¼ê°„ ëª¨ë“œ: selectedWeekStart ê¸°ì¤€ ì›”~ì¼ 7ì¼
            const weekStart = new Date(selectedWeekStart);
            const weekEnd = getWeekEnd(weekStart);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
              const d = new Date(weekStart);
              d.setDate(d.getDate() + i);
              weekDates.push(toKSTDateString(d));
            }

            // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì£¼ê°„ ë²”ìœ„)
            const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
            dateDisplay.textContent = weekStart.getFullYear() + 'ë…„ ' + formatShort(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìˆ¨ê¹€
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';

            // í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ í•„í„°ë§
            dayLogs = allLogs.filter(log => {
              if (!log.timestamp || log.deleted) return false;
              if (!matchesSeries(log.unit, currentSeries)) return false;
              const logDateStr = toKSTDateString(new Date(log.timestamp));
              return weekDates.includes(logDateStr);
            });
          } else {
            // ì¼ê°„ ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹
            const dateStr = vocabScoreCurrentDate.toLocaleDateString('ko-KR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              weekday: 'short'
            });
            dateDisplay.textContent = dateStr;

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í‘œì‹œ
            if (prevBtn) prevBtn.style.display = '';
            if (nextBtn) nextBtn.style.display = '';

            // í•´ë‹¹ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ í•„í„°ë§
            const targetDateStr = toKSTDateString(vocabScoreCurrentDate);
            dayLogs = allLogs.filter(log => {
              if (!log.timestamp || log.deleted) return false;
              if (!matchesSeries(log.unit, currentSeries)) return false;
              const logDateStr = toKSTDateString(new Date(log.timestamp));
              return logDateStr === targetDateStr;
            });
          }

          // ì–´íœ˜ì ìˆ˜ê°€ ìˆëŠ” ë¡œê·¸ë§Œ í•„í„°
          const vocabLogs = dayLogs.filter(log => {
            // í…Œì´ë¸” í–‰ì—ì„œ ì–´íœ˜ì ìˆ˜ë¥¼ ì°¾ì•„ì•¼ í•¨ - allLogsì— vocabularyScoreê°€ ìˆëŠ”ì§€ í™•ì¸
            // ì‹¤ì œë¡œëŠ” í…Œì´ë¸”ì—ì„œ í‘œì‹œë˜ëŠ” ì–´íœ˜ì ìˆ˜ë¥¼ ì‚¬ìš©
            return log.unit && typeof log.vocabularyScore !== 'undefined';
          });

          // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
          if (dayLogs.length === 0) {
            const emptyMsg = isWeeklyMode ? 'í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' : 'í•´ë‹¹ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
            container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">' + emptyMsg + '</div>';
            section.style.display = 'block';
            return;
          }

          // ë‹¨ì›ë³„ ì–´íœ˜ ì ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ (UNIT_PROGRESS_MAP í™œìš©)
          const vocabData = [];

          dayLogs.forEach(log => {
            if (!log.unit) return;

            const unitCode = log.unit;
            // ë‹¨ì› ì½”ë“œ ì •ê·œí™” (fit_, deep_, on_ ì ‘ë‘ì‚¬ ì œê±°)
            let normalizedUnitCode = unitCode;
            const parts = unitCode.split('_');
            if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
              normalizedUnitCode = parts[1] + '_' + parts[2];
            }

            // UNIT_PROGRESS_MAPì—ì„œ ì–´íœ˜ ì ìˆ˜ ê³„ì‚°
            let vocabScorePercent = 0;
            const unitProgress = UNIT_PROGRESS_MAP[unitCode] || UNIT_PROGRESS_MAP[normalizedUnitCode] || {};
            const vocabState = unitProgress.vocabState;

            if (vocabState && vocabState.vocabData && Array.isArray(vocabState.vocabData)) {
              const total = vocabState.vocabData.length;
              const correct = vocabState.vocabData.filter(v => v.isCorrect).length;
              if (total > 0) {
                vocabScorePercent = Math.round((correct / total) * 100);
              }
            } else {
              // fallback: reportState.vocabScoreRatio ì‚¬ìš©
              const reportState = unitProgress.reportState || {};
              const vocabScoreRatio = reportState.vocabScoreRatio || 0;
              vocabScorePercent = Math.round(vocabScoreRatio * 100);
            }

            // ì–´íœ˜ ì ìˆ˜ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
            if (vocabScorePercent > 0) {
              // ë‚ ì§œ í¬ë§·íŒ… (MM/DD)
              let dateStr = '';
              if (log.timestamp) {
                const logDate = new Date(log.timestamp);
                dateStr = (logDate.getMonth() + 1) + '/' + logDate.getDate();
              }
              vocabData.push({
                unit: unitCode,
                name: getVocabSubjectName(unitCode),
                score: vocabScorePercent,
                color: getVocabSubjectColor(unitCode),
                date: dateStr
              });
            }
          });

          if (vocabData.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">í•´ë‹¹ ë‚ ì§œì˜ ì–´íœ˜ ì ìˆ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            section.style.display = 'block';
            return;
          }

          // ê³¼ëª©ë³„ í‰ê·  ì ìˆ˜ ì„¤ì •
          const subjectAvgScores = {
            'bio': 78,        // ìƒë¬¼
            'earth': 75,      // ì§€êµ¬ê³¼í•™
            'physics': 63,    // ë¬¼ë¦¬
            'chem': 68,       // í™”í•™
            'soc': 82,        // ì‚¬íšŒë¬¸í™”
            'geo': 79,        // ì§€ë¦¬
            'law': 72,        // ë²•
            'pol': 74,        // ì •ì¹˜ê²½ì œ
            'classic': 78,    // ê³ ì „ì†Œì„¤
            'modern': 84,     // í˜„ëŒ€ì†Œì„¤
            'world': 85,      // ì„¸ê³„ë¬¸í•™1
            'world1': 85,     // ì„¸ê³„ë¬¸í•™1
            'world2': 84,     // ì„¸ê³„ë¬¸í•™2
            'people': 80,     // í•œêµ­ì¸ë¬¼
            'people1': 80,    // í•œêµ­ì¸ë¬¼
            'people2': 80,    // ì„¸ê³„ì¸ë¬¼
            'person1': 80,    // í•œêµ­ì¸ë¬¼
            'person2': 80     // ì„¸ê³„ì¸ë¬¼
          };

          // ë‹¨ì› ì½”ë“œì—ì„œ ê³¼ëª© í‚¤ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
          function getSubjectKeyFromUnit(unitCode) {
            if (!unitCode || !unitCode.includes('_')) return null;
            const parts = unitCode.split('_');
            let subjectKey = parts[0];
            let numStr = parts[1];
            if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
              subjectKey = parts[1];
              numStr = parts[2];
            }
            // world_41~80ì€ ì„¸ê³„ë¬¸í•™2
            if (subjectKey === 'world') {
              const num = parseInt(numStr, 10) || 0;
              if (num > 40) return 'world2';
            }
            return subjectKey;
          }

          // folderMap for URL generation
          const folderMap = {
            'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
            'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
            'modern': 'korlit', 'classic': 'korlit',
            'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
            'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
          };

          // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ HTML ìƒì„±
          let html = '<div class="vocab-score-bars">';

          vocabData.forEach((item, idx) => {
            const barWidth = Math.min(100, item.score); // ìµœëŒ€ 100%
            // ê³¼ëª©ë³„ í‰ê·  ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            const subjectKey = getSubjectKeyFromUnit(item.unit);
            const avgScore = subjectAvgScores[subjectKey] || 75;
            const avgPosition = avgScore; // í‰ê· ì„  ìœ„ì¹˜ (%)
            const isAboveAvg = item.score >= avgScore;
            // í‰ê·  ê¸°ì¤€ ìƒ‰ìƒ: ì´ìƒ=ì´ˆë¡, ë¯¸ë§Œ=ì£¼í™©
            const barColor = isAboveAvg ? '#4CAF50' : '#FF9800';

            // ì–´íœ˜ í•™ìŠµ í˜ì´ì§€ URL ìƒì„±
            const folder = folderMap[subjectKey] || 'science';
            const vocabPageUrl = '/BRAINUP/' + folder + '/' + item.unit + '.html?tab=vocab';

            html += '<div class="vocab-bar-row" data-url="' + vocabPageUrl + '" style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: all 0.3s ease;">';

            // ë‹¨ì›ëª… + ë‚ ì§œ (ì¢Œì¸¡)
            html += '<div class="vocab-bar-label" style="width: 100px; font-size: 12px; color: #fff; text-align: right; padding-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
            html += '<div>' + item.name + '</div>';
            if (item.date) {
              html += '<div style="font-size: 10px; color: rgba(255,255,255,0.6);">' + item.date + '</div>';
            }
            html += '</div>';

            // ë§‰ëŒ€ ê·¸ë˜í”„ ì˜ì—­
            html += '<div class="vocab-bar-container" style="flex: 1; height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; position: relative; overflow: visible;">';

            // ì‹¤ì œ ë§‰ëŒ€ (í‰ê·  ê¸°ì¤€ ìƒ‰ìƒ ì ìš©)
            html += '<div class="vocab-bar" style="height: 100%; width: ' + barWidth + '%; background: ' + barColor + '; border-radius: 4px; transition: all 0.3s ease;"></div>';

            // í‰ê· ì„  (ê³¼ëª©ë³„ í‰ê·  ìœ„ì¹˜)
            html += '<div class="vocab-avg-line" style="position: absolute; left: ' + avgPosition + '%; top: -4px; bottom: -4px; width: 2px; background: #fff; opacity: 0.8;"></div>';

            html += '</div>';

            // ì ìˆ˜ í‘œì‹œ (ìš°ì¸¡) - ê³¼ëª©ë³„ í‰ê·  í‘œì‹œ
            html += '<div class="vocab-bar-score" style="width: 80px; display: flex; align-items: center; justify-content: flex-start; padding-left: 10px;">';
            html += '<span style="font-size: 14px; font-weight: 600; color: ' + (isAboveAvg ? '#4CAF50' : '#FF9800') + ';">' + item.score + 'ì </span>';
            html += '<span style="font-size: 11px; color: rgba(255,255,255,0.5); margin-left: 6px;">/ ' + avgScore + '</span>';
            html += '</div>';

            html += '</div>';
          });

          html += '</div>';

          // ë²”ë¡€ ì¶”ê°€
          html += '<div style="display: flex; justify-content: center; margin-top: 15px; gap: 8px; flex-wrap: wrap;">';
          html += '<div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 2px; background: #fff;"></div><span style="font-size: 11px; color: rgba(255,255,255,0.7);">ê³¼ëª©ë³„ í‰ê· </span></div>';
          html += '<div style="display: flex; align-items: center; gap: 4px;"><span style="color: #4CAF50; font-size: 11px;">â—</span><span style="font-size: 11px; color: rgba(255,255,255,0.7);">í‰ê·  ì´ìƒ</span></div>';
          html += '<div style="display: flex; align-items: center; gap: 4px;"><span style="color: #FF9800; font-size: 11px;">â—</span><span style="font-size: 11px; color: rgba(255,255,255,0.7);">í‰ê·  ë¯¸ë§Œ</span></div>';
          html += '</div>';

          container.innerHTML = html;
          section.style.display = 'block';

          // ë§‰ëŒ€ ê·¸ë˜í”„ í˜¸ë²„ íš¨ê³¼ ë° í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          const barRows = container.querySelectorAll('.vocab-bar-row');
          barRows.forEach(row => {
            // ë§ˆìš°ìŠ¤ í˜¸ë²„ íš¨ê³¼ (ë¹› ê°•ì¡°)
            row.addEventListener('mouseenter', function() {
              this.style.background = 'rgba(255, 255, 255, 0.15)';
              this.style.boxShadow = '0 0 15px rgba(255, 255, 255, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.1)';
              this.style.transform = 'scale(1.02)';
              const bar = this.querySelector('.vocab-bar');
              if (bar) {
                bar.style.boxShadow = '0 0 12px 2px ' + (bar.style.background.includes('76, 175, 80') || bar.style.background === '#4CAF50' ? 'rgba(76, 175, 80, 0.6)' : 'rgba(255, 152, 0, 0.6)');
                bar.style.filter = 'brightness(1.2)';
              }
            });

            row.addEventListener('mouseleave', function() {
              this.style.background = 'transparent';
              this.style.boxShadow = 'none';
              this.style.transform = 'scale(1)';
              const bar = this.querySelector('.vocab-bar');
              if (bar) {
                bar.style.boxShadow = 'none';
                bar.style.filter = 'brightness(1)';
              }
            });

            // í´ë¦­ ì‹œ ì–´íœ˜ í•™ìŠµ í˜ì´ì§€ë¡œ ì´ë™
            row.addEventListener('click', function() {
              const url = this.getAttribute('data-url');
              if (url) {
                window.location.href = url;
              }
            });
          });
        }

        // ì–´íœ˜ ì ìˆ˜ ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ (ëª¨ë“  ì„¹ì…˜ ë™ê¸°í™”)
        document.getElementById('vocabScorePrev')?.addEventListener('click', function() {
          vocabScoreCurrentDate.setDate(vocabScoreCurrentDate.getDate() - 1);
          renderVocabScoreChart();

          // âœ… Today í•™ìŠµ ê¸°ë¡ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          selectedDate = new Date(vocabScoreCurrentDate);
          renderTodaySection();

          // âœ… ì°½ì˜í™œë™ ë‚´ì—­ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          if (typeof creativeCurrentDate !== 'undefined') {
            creativeCurrentDate = new Date(vocabScoreCurrentDate);
            if (typeof renderCreativeTable === 'function') {
              renderCreativeTable();
            }
          }
        });

        document.getElementById('vocabScoreNext')?.addEventListener('click', function() {
          const today = new Date();
          today.setHours(23, 59, 59, 999);
          const nextDate = new Date(vocabScoreCurrentDate);
          nextDate.setDate(nextDate.getDate() + 1);

          if (nextDate <= today) {
            vocabScoreCurrentDate = nextDate;
            renderVocabScoreChart();

            // âœ… Today í•™ìŠµ ê¸°ë¡ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
            selectedDate = new Date(vocabScoreCurrentDate);
            renderTodaySection();

            // âœ… ì°½ì˜í™œë™ ë‚´ì—­ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
            if (typeof creativeCurrentDate !== 'undefined') {
              creativeCurrentDate = new Date(vocabScoreCurrentDate);
              if (typeof renderCreativeTable === 'function') {
                renderCreativeTable();
              }
            }
          }
        });

        // ì–´íœ˜ ì ìˆ˜ ì°¨íŠ¸ ì´ˆê¸° ë Œë”ë§ì€ allLogs ì´ˆê¸°í™” í›„ì— ìˆ˜í–‰
        // renderVocabScoreChart(); // allLogs ì´ˆê¸°í™” í›„ í˜¸ì¶œë¨

        // ===== ì°½ì˜í™œë™ ë‚´ì—­ ê¸°ëŠ¥ =====
        let creativeCurrentDate = new Date();
        let creativeDataCache = null;
        const pageGrade = '${grade}';
        const pageName = '${name}';

        // ë‹¨ì› ì½”ë“œë¥¼ ë‹¨ì›ëª…ìœ¼ë¡œ ë³€í™˜
        function getUnitDisplayName(unitCode) {
          if (!unitCode || !unitCode.includes('_')) return unitCode;
          const parts = unitCode.split('_');
          let subjectKey = parts[0];
          let number = parts[1] ? parts[1].replace(/^0+/, '') : '';

          // on_bio_01, fit_geo_01, deep_modern_01 í˜•ì‹ ì²˜ë¦¬
          if ((parts[0] === 'on' || parts[0] === 'fit' || parts[0] === 'deep') && parts.length >= 3) {
            subjectKey = parts[1];
            number = parts[2] ? parts[2].replace(/^0+/, '') : '';
          }

          const subjectNames = {
            'bio': 'ìƒëª…ê³¼í•™', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬í•™', 'chem': 'í™”í•™',
            'geo': 'ì§€ë¦¬', 'soc': 'ì‚¬íšŒ', 'law': 'ë²•', 'pol': 'ì •ì¹˜',
            'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™',
            'world': 'ì„¸ê³„ë¬¸í•™', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2',
            'people': 'ì¸ë¬¼', 'people1': 'ì¸ë¬¼1', 'people2': 'ì¸ë¬¼2', 'person1': 'ì¸ë¬¼1', 'person2': 'ì¸ë¬¼2'
          };
          const subject = subjectNames[subjectKey] || subjectKey;
          return subject + ' ' + number;
        }

        // ì°½ì˜í™œë™ í…Œì´ë¸” ë Œë”ë§
        async function renderCreativeTable() {
          const dateLabel = document.getElementById('creativeDate');
          const tbody = document.getElementById('creativeTableBody');
          const prevBtn = document.getElementById('creativePrev');
          const nextBtn = document.getElementById('creativeNext');
          if (!dateLabel || !tbody) {
            console.log('[renderCreativeTable] ìš”ì†Œ ì—†ìŒ');
            return;
          }

          console.log('[renderCreativeTable] ì‹œì‘:', pageGrade, pageName, 'ì£¼ê°„ëª¨ë“œ:', isWeeklyMode);

          // ì£¼ê°„ ëª¨ë“œì¼ ë•Œ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìˆ¨ê¹€
          if (isWeeklyMode) {
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
          } else {
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
          }

          // ë‚ ì§œ í‘œì‹œ
          let filteredData = [];
          let weekDates = [];

          if (isWeeklyMode) {
            // ì£¼ê°„ ëª¨ë“œ: ì£¼ê°„ ë²”ìœ„ í‘œì‹œ
            const weekStart = new Date(selectedWeekStart);
            const weekEnd = getWeekEnd(weekStart);
            const formatShort = (d) => (d.getMonth() + 1) + '/' + d.getDate();
            dateLabel.textContent = weekStart.getFullYear() + 'ë…„ ' + formatShort(weekStart) + ' (ì›”) ~ ' + formatShort(weekEnd) + ' (ì¼)';

            // ì£¼ê°„ ë‚ ì§œ ë°°ì—´ ìƒì„±
            for (let i = 0; i < 7; i++) {
              const d = new Date(weekStart);
              d.setDate(d.getDate() + i);
              weekDates.push(toKSTDateString(d));
            }
          } else {
            // ì¼ê°„ ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹
            const year = creativeCurrentDate.getFullYear();
            const month = creativeCurrentDate.getMonth() + 1;
            const date = creativeCurrentDate.getDate();
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayName = days[creativeCurrentDate.getDay()];
            dateLabel.textContent = year + 'ë…„ ' + month + 'ì›” ' + date + 'ì¼ ' + dayName;
          }

          // í•­ìƒ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          try {
            console.log('[renderCreativeTable] API í˜¸ì¶œ ì¤‘...');
            const res = await fetch('/api/user-progress/creative-activities?grade=' + encodeURIComponent(pageGrade) + '&name=' + encodeURIComponent(pageName));
            if (res.ok) {
              const json = await res.json();
              creativeDataCache = json.data || [];
              console.log('[renderCreativeTable] ë°ì´í„° ìˆ˜ì‹ :', creativeDataCache.length + 'ê±´');
            } else {
              console.log('[renderCreativeTable] API ì‘ë‹µ ì˜¤ë¥˜:', res.status);
              creativeDataCache = [];
            }
          } catch (e) {
            console.error('[renderCreativeTable] ì°½ì˜í™œë™ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', e);
            creativeDataCache = [];
          }

          // unit codeë¡œ ì‹œë¦¬ì¦ˆ íŒë‹¨í•˜ëŠ” í•¨ìˆ˜
          function getSeriesFromUnit(unitCode) {
            if (!unitCode) return 'BRAINì—…';
            if (unitCode.startsWith('on_')) return 'BRAINì˜¨';
            if (unitCode.startsWith('fit_')) return 'BRAINí•';
            if (unitCode.startsWith('deep_')) return 'BRAINë”¥';
            return 'BRAINì—…'; // ì ‘ë‘ì‚¬ ì—†ìœ¼ë©´ ë¸Œë ˆì¸ì—…
          }

          // ë°ì´í„° í•„í„°ë§
          if (isWeeklyMode) {
            // ì£¼ê°„ ëª¨ë“œ: í•´ë‹¹ ì£¼ê°„ì˜ ë°ì´í„° í•„í„°ë§
            filteredData = creativeDataCache.filter(item => {
              if (!item.submittedAt) return false;
              const itemDateStr = toKSTDateString(new Date(item.submittedAt));
              if (!weekDates.includes(itemDateStr)) return false;

              // ì‹œë¦¬ì¦ˆ í•„í„°ë§
              if (currentSelectedSeries && currentSelectedSeries !== 'all') {
                const itemSeries = getSeriesFromUnit(item.unit);
                return itemSeries === currentSelectedSeries;
              }
              return true;
            });
          } else {
            // ì¼ê°„ ëª¨ë“œ: ì„ íƒí•œ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° í•„í„°ë§
            const year = creativeCurrentDate.getFullYear();
            const month = creativeCurrentDate.getMonth() + 1;
            const date = creativeCurrentDate.getDate();
            const selectedDateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(date).padStart(2, '0');
            filteredData = creativeDataCache.filter(item => {
              if (!item.submittedAt) return false;
              const itemDate = new Date(item.submittedAt);
              const itemDateStr = itemDate.getFullYear() + '-' + String(itemDate.getMonth() + 1).padStart(2, '0') + '-' + String(itemDate.getDate()).padStart(2, '0');
              if (itemDateStr !== selectedDateStr) return false;

              // ì‹œë¦¬ì¦ˆ í•„í„°ë§ (currentSelectedSeriesê°€ 'all'ì´ ì•„ë‹ˆë©´ í•´ë‹¹ ì‹œë¦¬ì¦ˆë§Œ)
              if (currentSelectedSeries && currentSelectedSeries !== 'all') {
                const itemSeries = getSeriesFromUnit(item.unit);
                return itemSeries === currentSelectedSeries;
              }
              return true;
            });
          }

          // í…Œì´ë¸” ë Œë”ë§
          const emptyMsg = isWeeklyMode ? 'í•´ë‹¹ ì£¼ê°„ì— ì œì¶œëœ ì°½ì˜í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.' : 'í•´ë‹¹ ë‚ ì§œì— ì œì¶œëœ ì°½ì˜í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.';
          if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="creative-empty">' + emptyMsg + '</td></tr>';
            return;
          }

          let html = '';
          filteredData.forEach((item, index) => {
            const unitName = getUnitDisplayName(item.unit);
            const topic = item.topic || 'ììœ  ê¸€ì“°ê¸°';
            const charCount = item.text ? item.text.length : 0;
            const textContent = item.text || 'ë‚´ìš© ì—†ìŒ';
            const rowId = 'creative-row-' + index;
            const contentId = 'creative-content-' + index;

            // ì‘ì„±ì¼ í¬ë§·íŒ… (MM/DD)
            let submitDateStr = '-';
            if (item.submittedAt) {
              const submitDate = new Date(item.submittedAt);
              submitDateStr = (submitDate.getMonth() + 1) + '/' + submitDate.getDate();
            }

            // ë©”ì¸ í–‰
            html += '<tr id="' + rowId + '" class="creative-row" data-index="' + index + '" onclick="toggleCreativeContent(' + index + ')">';
            html += '<td class="creative-num"><span class="creative-arrow" id="arrow-' + index + '">â–¶</span>' + (index + 1) + '</td>';
            html += '<td class="creative-date">' + submitDateStr + '</td>';
            html += '<td class="creative-unit">' + unitName + '</td>';
            html += '<td class="creative-topic">' + topic + '</td>';
            html += '<td><div class="creative-chars">' + charCount.toLocaleString() + '</div></td>';
            html += '</tr>';

            // ë“œë¡­ë‹¤ìš´ ë‚´ìš© í–‰ (ì²˜ìŒì—” ìˆ¨ê¹€)
            html += '<tr id="' + contentId + '" class="creative-content-row" style="display: none;">';
            html += '<td colspan="5">';
            html += '<div class="creative-content-box">';
            html += '<div class="creative-content-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>ì‘ì„± ë‚´ìš©</div>';
            html += '<div class="creative-content-text">' + textContent.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
            html += '</div>';
            html += '</td>';
            html += '</tr>';
          });

          tbody.innerHTML = html;
        }

        // ì°½ì˜í™œë™ ë“œë¡­ë‹¤ìš´ í† ê¸€ í•¨ìˆ˜ (ì „ì—­)
        window.toggleCreativeContent = function(index) {
          const contentRow = document.getElementById('creative-content-' + index);
          const arrow = document.getElementById('arrow-' + index);

          if (!contentRow || !arrow) return;

          const isVisible = contentRow.style.display !== 'none';

          if (isVisible) {
            // ë‹«ê¸°
            contentRow.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
          } else {
            // ì—´ê¸°
            contentRow.style.display = 'table-row';
            arrow.style.transform = 'rotate(90deg)';
          }
        };

        // ì°½ì˜í™œë™ ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ (ëª¨ë“  ì„¹ì…˜ ë™ê¸°í™”)
        document.getElementById('creativePrev')?.addEventListener('click', function() {
          creativeCurrentDate.setDate(creativeCurrentDate.getDate() - 1);
          renderCreativeTable();

          // âœ… Today í•™ìŠµ ê¸°ë¡ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          selectedDate = new Date(creativeCurrentDate);
          renderTodaySection();

          // âœ… ì–´íœ˜ ì ìˆ˜ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
          if (typeof vocabScoreCurrentDate !== 'undefined') {
            vocabScoreCurrentDate = new Date(creativeCurrentDate);
            if (typeof renderVocabScoreChart === 'function') {
              renderVocabScoreChart();
            }
          }
        });

        document.getElementById('creativeNext')?.addEventListener('click', function() {
          const today = new Date();
          today.setHours(23, 59, 59, 999);
          const nextDate = new Date(creativeCurrentDate);
          nextDate.setDate(nextDate.getDate() + 1);

          if (nextDate <= today) {
            creativeCurrentDate = nextDate;
            renderCreativeTable();

            // âœ… Today í•™ìŠµ ê¸°ë¡ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
            selectedDate = new Date(creativeCurrentDate);
            renderTodaySection();

            // âœ… ì–´íœ˜ ì ìˆ˜ë„ ê°™ì€ ë‚ ì§œë¡œ ë™ê¸°í™”
            if (typeof vocabScoreCurrentDate !== 'undefined') {
              vocabScoreCurrentDate = new Date(creativeCurrentDate);
              if (typeof renderVocabScoreChart === 'function') {
                renderVocabScoreChart();
              }
            }
          }
        });

        // ì´ˆê¸° ë Œë”ë§
        renderCreativeTable();

        // ===== Today ë ˆì´ë” ìŠ¬ë¼ì´ë” ê¸°ëŠ¥ =====
        let todayRadarSlideIndex = 0;

        function slideTodayRadar(direction) {
          const wrap = document.getElementById('today-radar-wrap');
          const viewport = document.querySelector('.today-radar-viewport');
          const cards = wrap.querySelectorAll('.radar-card');
          const prevBtn = document.getElementById('todayRadarPrev');
          const nextBtn = document.getElementById('todayRadarNext');

          if (cards.length === 0) return;

          const cardWidth = 180 + 15; // ì¹´ë“œ ë„ˆë¹„ + gap
          const viewportWidth = viewport.offsetWidth;
          const visibleCards = Math.floor(viewportWidth / cardWidth);
          const maxSlide = Math.max(0, cards.length - visibleCards);

          todayRadarSlideIndex += direction;
          todayRadarSlideIndex = Math.max(0, Math.min(todayRadarSlideIndex, maxSlide));

          const translateX = todayRadarSlideIndex * cardWidth;
          wrap.style.transform = 'translateX(-' + translateX + 'px)';

          // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          prevBtn.disabled = todayRadarSlideIndex === 0;
          nextBtn.disabled = todayRadarSlideIndex >= maxSlide;
        }

        function updateSliderButtons() {
          const wrap = document.getElementById('today-radar-wrap');
          const viewport = document.querySelector('.today-radar-viewport');
          const cards = wrap.querySelectorAll('.radar-card');
          const prevBtn = document.getElementById('todayRadarPrev');
          const nextBtn = document.getElementById('todayRadarNext');

          if (cards.length === 0) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            return;
          }

          const cardWidth = 180 + 15;
          const viewportWidth = viewport.offsetWidth;
          const visibleCards = Math.floor(viewportWidth / cardWidth);
          const maxSlide = Math.max(0, cards.length - visibleCards);

          // ì¹´ë“œê°€ ë·°í¬íŠ¸ ì•ˆì— ëª¨ë‘ ë“¤ì–´ê°€ë©´ í™”ì‚´í‘œ ìˆ¨ê¹€
          if (cards.length <= visibleCards) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
          } else {
            prevBtn.style.display = 'flex';
            nextBtn.style.display = 'flex';
            prevBtn.disabled = todayRadarSlideIndex === 0;
            nextBtn.disabled = todayRadarSlideIndex >= maxSlide;
          }
        }

        // ë Œë”ë§ í›„ ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        setTimeout(updateSliderButtons, 100);
        window.addEventListener('resize', updateSliderButtons);

        // ===== ì „ì²´ ë³´ê¸° í† ê¸€ ê¸°ëŠ¥ =====
        let isTodayRadarExpanded = false;
        let todayGridCharts = [];

        function toggleTodayRadarView() {
          const slider = document.getElementById('todayRadarSlider');
          const grid = document.getElementById('todayRadarGrid');
          const toggleBtn = document.getElementById('todayRadarToggle');
          const toggleText = document.getElementById('todayRadarToggleText');
          const toggleWrap = document.getElementById('todayRadarToggleWrap');

          isTodayRadarExpanded = !isTodayRadarExpanded;

          if (isTodayRadarExpanded) {
            // ì „ì²´ ë³´ê¸° ëª¨ë“œ
            slider.style.display = 'none';
            grid.style.display = 'flex';
            toggleText.textContent = 'ì ‘ê¸°';
            toggleBtn.classList.add('expanded');

            // ê·¸ë¦¬ë“œì— ì°¨íŠ¸ ë Œë”ë§
            renderTodayRadarGrid();
          } else {
            // ìŠ¬ë¼ì´ë” ëª¨ë“œ
            slider.style.display = 'flex';
            grid.style.display = 'none';
            toggleText.textContent = 'ì „ì²´ ë³´ê¸°';
            toggleBtn.classList.remove('expanded');

            // ê·¸ë¦¬ë“œ ì°¨íŠ¸ ì •ë¦¬
            todayGridCharts.forEach(chart => chart.destroy());
            todayGridCharts = [];
            grid.innerHTML = '';
          }
        }

        function renderTodayRadarGrid() {
          const grid = document.getElementById('todayRadarGrid');
          grid.innerHTML = '';
          todayGridCharts = [];

          let filteredLogs;

          if (isWeeklyMode) {
            // ì£¼ê°„ ëª¨ë“œ: selectedWeekRadarStart ê¸°ì¤€ìœ¼ë¡œ ì£¼ê°„ ë°ì´í„° í•„í„°ë§
            const weekStart = new Date(selectedWeekRadarStart);
            const weekEnd = getWeekEnd(weekStart);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
              const d = new Date(weekStart);
              d.setDate(d.getDate() + i);
              weekDates.push(toKSTDateString(d));
            }
            filteredLogs = logsForChart.filter(log => {
              if (!matchesSeries(log.unit, currentSeries)) return false;
              const logDate = log.completedAt || log.timestamp;
              if (!logDate) return false;
              const logDateStr = toKSTDateString(new Date(logDate));
              return weekDates.includes(logDateStr);
            });
          } else {
            // ì¼ê°„ ëª¨ë“œ: ì„ íƒëœ ë‚ ì§œ ê¸°ì¤€
            const selectedDateStr = toKSTDateString(selectedDate);
            filteredLogs = logsForChart.filter(log => {
              if (!matchesSeries(log.unit, currentSeries)) return false;
              const logDate = log.completedAt || log.timestamp;
              if (!logDate) return false;
              return toKSTDateString(new Date(logDate)) === selectedDateStr;
            });
          }

          if (filteredLogs.length === 0) {
            grid.innerHTML = '<div class="today-empty-cards">' + (isWeeklyMode ? 'í•´ë‹¹ ì£¼ê°„ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' : 'í•´ë‹¹ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.') + '</div>';
            return;
          }

          const todayLogs = filteredLogs;

          const subjectMap = { 'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™', 'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ', 'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™1', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'people': 'í•œêµ­ì¸ë¬¼', 'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼', 'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼' };

          todayLogs.forEach((log, idx) => {
            const unitCode = log.unit || '';
            const r = log.radar || {};

            const scores = [
              r.literal || 0,
              r.structural || 0,
              r.lexical || 0,
              r.inferential || 0,
              r.critical || 0
            ];
            const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
            const maxScore = Math.max(...scores).toFixed(1);
            const minScore = Math.min(...scores).toFixed(1);

            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            if (avgScore >= 9) {
              badgeClass = 'badge-excellent';
              badgeText = 'ìš°ìˆ˜';
            } else if (avgScore >= 8) {
              badgeClass = 'badge-good';
              badgeText = 'ì–‘í˜¸';
            } else if (avgScore >= 7) {
              badgeClass = 'badge-normal';
              badgeText = 'ë³´í†µ';
            } else {
              badgeClass = 'badge-encourage';
              badgeText = 'ê²©ë ¤';
            }

            let shortName = unitCode;
            if (unitCode && unitCode.includes('_')) {
              const parts = unitCode.split('_');
              let sk = parts[0];
              let ns = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                sk = parts[1];
                ns = parts[2];
              }
              const subject = subjectMap[sk] || sk;
              let number = ns ? parseInt(ns, 10) : 0;
              shortName = subject + ' ' + number;
            }

            const card = document.createElement('div');
            card.className = 'radar-card';

            const header = document.createElement('div');
            header.className = 'radar-card-header';

            const title = document.createElement('div');
            title.className = 'radar-card-title';
            title.textContent = shortName;

            const time = document.createElement('div');
            time.className = 'radar-card-time';
            time.innerHTML = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}) : '-';

            const badge = document.createElement('div');
            badge.className = 'score-badge ' + badgeClass;
            badge.textContent = badgeText;

            header.appendChild(title);
            header.appendChild(time);
            header.appendChild(badge);
            card.appendChild(header);

            const canvas = document.createElement('canvas');
            canvas.id = 'gridRadar' + idx;
            canvas.width = 130;
            canvas.height = 130;
            card.appendChild(canvas);

            // í†µê³„ ì •ë³´
            const stats = document.createElement('div');
            stats.className = 'radar-card-stats';
            stats.innerHTML =
              '<div class="stat-item">' +
                '<div class="stat-label">í‰ê· </div>' +
                '<div class="stat-value">' + avgScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœê³ </div>' +
                '<div class="stat-value">' + maxScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœì €</div>' +
                '<div class="stat-value">' + minScore + '</div>' +
              '</div>';
            card.appendChild(stats);

            // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì› í˜ì´ì§€ë¡œ ì´ë™
            card.style.cursor = 'pointer';
            card.addEventListener('click', function() {
              if (unitCode) {
                const parts = unitCode.split('_');
                let subject = parts[0] || '';
                if ((subject === 'fit' || subject === 'deep' || subject === 'on') && parts.length >= 3) {
                  subject = parts[1];
                }
                const folderMap = {
                  'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
                  'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
                  'modern': 'korlit', 'classic': 'korlit',
                  'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
                  'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
                };
                const folder = folderMap[subject] || 'social';
                const unitUrl = '/BRAINUP/' + folder + '/' + unitCode + '.html';
                window.location.href = unitUrl;
              }
            });

            grid.appendChild(card);

            const chart = new Chart(canvas.getContext('2d'), {
              type: 'radar',
              data: {
                labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
                datasets: [{
                  data: scores,
                  backgroundColor: 'rgba(102, 126, 234, 0.2)',
                  borderColor: '#667eea',
                  borderWidth: 2,
                  pointBackgroundColor: '#667eea',
                  pointBorderColor: '#fff',
                  pointBorderWidth: 1,
                  pointRadius: 3
                }]
              },
              options: {
                responsive: false,
                plugins: {
                  legend: { display: false },
                  datalabels: { display: false }
                },
                scales: {
                  r: {
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: { display: false, stepSize: 2 },
                    grid: { color: 'rgba(102, 126, 234, 0.1)' },
                    angleLines: { color: 'rgba(102, 126, 234, 0.1)' },
                    pointLabels: { display: false }
                  }
                }
              }
            });
            todayGridCharts.push(chart);
          });
        }

        // ===== ì§„í–‰ë¥  í‘œì‹œë¥¼ ìœ„í•œ í—¬í¼ í•¨ìˆ˜ ë° ë°ì´í„° =====
        // ê³¼ëª© ì½”ë“œ â†’ ì´ ë‹¨ì› ìˆ˜ ë§¤í•‘
        const subjectUnitCounts = {
          'bio': 20, 'earth': 20, 'physics': 20, 'chem': 20,
          'geo': 20, 'soc': 20, 'law': 20, 'pol': 20,
          'modern': 40, 'classic': 40,
          'world': 40, 'world1': 40, 'world2': 40,
          'people': 40, 'people1': 40, 'people2': 40, 'person1': 40, 'person2': 40
        };

        // ë¶„ì•¼ë³„ ì´ ë‹¨ì› ìˆ˜
        const fieldUnitCounts = {
          'ê³¼í•™ë¶„ì•¼': 80,
          'ì‚¬íšŒë¶„ì•¼': 80,
          'í•œêµ­ë¬¸í•™': 80,
          'ì„¸ê³„ë¬¸í•™': 80,
          'ì¸ë¬¼ë¶„ì•¼': 80
        };

        // ì‹œë¦¬ì¦ˆ ì´ ë‹¨ì› ìˆ˜
        const seriesTotalUnits = 400;

        // ë‹¨ì› ì½”ë“œ ì •ê·œí™” í•¨ìˆ˜ (world1_XX, world2_XX, people1_XX, people2_XXê°€ í‘œì¤€ í˜•ì‹)
        function normalizeUnitCode(unit) {
          // fit_ ì ‘ë‘ì–´ ì œê±°: fit_bio_01 -> bio_01
          if (unit.startsWith('fit_')) {
            unit = unit.substring(4);
          }
          // deep_ ì ‘ë‘ì–´ ì œê±°: deep_bio_01 -> bio_01
          if (unit.startsWith('deep_')) {
            unit = unit.substring(5);
          }
          // on_ ì ‘ë‘ì–´ ì œê±°: on_bio_01 -> bio_01
          if (unit.startsWith('on_')) {
            unit = unit.substring(3);
          }
          // world1_XX, world2_XXëŠ” ì´ë¯¸ í‘œì¤€ í˜•ì‹
          if (unit.startsWith('world1_') || unit.startsWith('world2_')) {
            return unit;
          }
          // people1_XX, people2_XXëŠ” ì´ë¯¸ í‘œì¤€ í˜•ì‹
          if (unit.startsWith('people1_') || unit.startsWith('people2_')) {
            return unit;
          }
          // ë ˆê±°ì‹œ: world_01~40 -> world1_XX, world_41~80 -> world2_XX
          if (unit.startsWith('world_')) {
            const numMatch = unit.match(/world_([0-9]+)$/);
            if (numMatch) {
              const num = parseInt(numMatch[1]);
              if (num >= 1 && num <= 40) {
                return 'world1_' + String(num).padStart(2, '0');
              } else if (num >= 41 && num <= 80) {
                return 'world2_' + String(num - 40).padStart(2, '0');
              }
            }
          }
          // ë ˆê±°ì‹œ: people_01~40 -> people1_XX, people_41~80 -> people2_XX
          if (unit.startsWith('people_')) {
            const numMatch = unit.match(/people_([0-9]+)$/);
            if (numMatch) {
              const num = parseInt(numMatch[1]);
              if (num >= 1 && num <= 40) {
                return 'people1_' + String(num).padStart(2, '0');
              } else if (num >= 41 && num <= 80) {
                return 'people2_' + String(num - 40).padStart(2, '0');
              }
            }
          }
          return unit;
        }

        // logsForChartì—ì„œ ì™„ë£Œëœ ê³ ìœ  ë‹¨ì› ìˆ˜ì§‘ (ì •ê·œí™”ëœ ì½”ë“œ ì‚¬ìš©)
        const completedUnitsSet = new Set();
        logsForChart.forEach(log => {
          if (log.unit) {
            completedUnitsSet.add(normalizeUnitCode(log.unit));
          }
        });

        // ê³¼ëª©ë³„ ì™„ë£Œ ê°œìˆ˜ ê³„ì‚° (logsForChart ê¸°ë°˜)
        function getCompletedCount(subjectCode) {
          let count = 0;
          completedUnitsSet.forEach(unit => {
            // world1, world2, people1, people2ëŠ” ì´ì œ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­
            if (unit.startsWith(subjectCode + '_')) {
              count++;
            }
          });
          return count;
        }

        // ë¶„ì•¼ë³„ ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°
        function getFieldCompletedCount(fieldName) {
          const fieldSubjects = {
            'ê³¼í•™ë¶„ì•¼': ['bio', 'earth', 'physics', 'chem'],
            'ì‚¬íšŒë¶„ì•¼': ['geo', 'soc', 'law', 'pol'],
            'í•œêµ­ë¬¸í•™': ['modern', 'classic'],
            'ì„¸ê³„ë¬¸í•™': ['world1', 'world2'],
            'ì¸ë¬¼ë¶„ì•¼': ['people1', 'people2']
          };
          const subjects = fieldSubjects[fieldName] || [];
          let total = 0;
          subjects.forEach(subjectCode => {
            total += getCompletedCount(subjectCode);
          });
          return total;
        }

        // ì‹œë¦¬ì¦ˆ ì „ì²´ ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°
        function getSeriesCompletedCount() {
          return completedUnitsSet.size;
        }

        // ===== ì¢…í•© ë ˆì´ë” ì°¨íŠ¸ ìƒì„± =====
        const summaryWrap = document.getElementById('summary-radar-wrap');

        // ê³¼ëª© ì½”ë“œ â†’ ê³¼ëª©ëª… ë§¤í•‘
        const subjectNames = {
          'geo': 'ì§€ë¦¬',
          'bio': 'ìƒë¬¼',
          'earth': 'ì§€êµ¬ê³¼í•™',
          'physics': 'ë¬¼ë¦¬',
          'chem': 'í™”í•™',
          'soc': 'ì‚¬íšŒë¬¸í™”',
          'law': 'ë²•',
          'pol': 'ì •ì¹˜ê²½ì œ',
          'modern': 'í˜„ëŒ€ë¬¸í•™',
          'classic': 'ê³ ì „ë¬¸í•™',
          'world': 'ì„¸ê³„ë¬¸í•™1',
          'world1': 'ì„¸ê³„ë¬¸í•™1',
          'world2': 'ì„¸ê³„ë¬¸í•™2',
          'people': 'í•œêµ­ì¸ë¬¼',
          'people1': 'í•œêµ­ì¸ë¬¼',
          'people2': 'ì„¸ê³„ì¸ë¬¼',
          'person1': 'í•œêµ­ì¸ë¬¼',
          'person2': 'ì„¸ê³„ì¸ë¬¼'
        };

        // ê³¼ëª© ì½”ë“œ â†’ ë¶„ì•¼ í´ë˜ìŠ¤ ë§¤í•‘
        const subjectToFieldClass = {
          'bio': 'science',
          'earth': 'science',
          'physics': 'science',
          'chem': 'science',
          'geo': 'society',
          'soc': 'society',
          'law': 'society',
          'pol': 'society',
          'modern': 'korean-lit',
          'classic': 'korean-lit',
          'world': 'world-lit',
          'world1': 'world-lit',
          'world2': 'world-lit',
          'people': 'person',
          'people1': 'person',
          'people2': 'person',
          'person1': 'person',
          'person2': 'person'
        };

        // ===== ê³¼ëª©ë³„ ì¢…í•© ë ˆì´ë” í•¨ìˆ˜ =====
        function renderSubjectRadar(logs) {
          // ê¸°ì¡´ ì¹´ë“œ ì œê±°
          summaryWrap.innerHTML = '';

          // í•„í„°ë§ëœ ë¡œê·¸ì—ì„œ ì™„ë£Œëœ ê³¼ëª©ë³„ ë‹¨ì› ìˆ˜ ê³„ì‚°
          function getFilteredCompletedCount(subjectCode, filteredLogs) {
            const unitSet = new Set();
            filteredLogs.forEach(log => {
              if (log.unit) {
                let unitCode = log.unit;
                if (unitCode.startsWith('fit_')) unitCode = unitCode.substring(4);
                else if (unitCode.startsWith('deep_')) unitCode = unitCode.substring(5);
                else if (unitCode.startsWith('on_')) unitCode = unitCode.substring(3);
                if (unitCode.startsWith(subjectCode + '_')) {
                  unitSet.add(unitCode);
                }
              }
            });
            return unitSet.size;
          }

          // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™” (unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ: geo, history ë“±)
          const subjectGroups = {};
          logs.forEach(log => {
            if (!log.radar || !log.unit) return;

            // unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ (geo_01 -> geo, history_01 -> history)
            // fit_ / deep_ / on_ ì ‘ë‘ì–´ ì œê±°: fit_bio_01 -> bio_01, deep_bio_01 -> bio_01, on_bio_01 -> bio_01
            let unitForSubject = log.unit;
            if (unitForSubject.startsWith('fit_')) {
              unitForSubject = unitForSubject.substring(4);
            } else if (unitForSubject.startsWith('deep_')) {
              unitForSubject = unitForSubject.substring(5);
            } else if (unitForSubject.startsWith('on_')) {
              unitForSubject = unitForSubject.substring(3);
            }
            let subjectCode = unitForSubject.split('_')[0];

          // world_01~40 -> world1, world_41~80 -> world2 (peopleë„ ë™ì¼)
          // world2_XX, people2_XXëŠ” ì§ì ‘ world2, people2ë¡œ ë§¤í•‘
          if (subjectCode === 'world' || subjectCode === 'people') {
            const numMatch = unitForSubject.match(/_([0-9]+)$/);
            const num = numMatch ? parseInt(numMatch[1]) : 0;
            if (subjectCode === 'world') {
              subjectCode = num <= 40 ? 'world1' : 'world2';
            } else {
              subjectCode = num <= 40 ? 'people1' : 'people2';
            }
          } else if (subjectCode === 'world1' || subjectCode === 'world2' || subjectCode === 'people1' || subjectCode === 'people2' || subjectCode === 'person1' || subjectCode === 'person2') {
            // world1, world2, people1, people2, person1, person2ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
            // person1 -> people1, person2 -> people2ë¡œ í†µí•©
            if (subjectCode === 'person1') subjectCode = 'people1';
            if (subjectCode === 'person2') subjectCode = 'people2';
          }

          // unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆëª… ì¶”ì¶œ
          const seriesFromUnit = (function(unit) {
            if (!unit) return 'BRAINì—…';
            if (unit.includes('on_')) return 'BRAINì˜¨';
            if (unit.includes('fit_')) return 'BRAINí•';
            if (unit.includes('deep_')) return 'BRAINë”¥';
            return 'BRAINì—…';
          })(log.unit);
          const subjectKey = seriesFromUnit + '_' + subjectCode;

          if (!subjectGroups[subjectKey]) {
            subjectGroups[subjectKey] = {
              series: seriesFromUnit,
              subjectCode: subjectCode,
              logs: []
            };
          }
          subjectGroups[subjectKey].logs.push(log);
        });

        // ê° ê³¼ëª©ë³„ë¡œ í‰ê·  ê³„ì‚° ë° ì°¨íŠ¸ ìƒì„±
        let summaryIndex = 0;
        Object.keys(subjectGroups).forEach(key => {
          const group = subjectGroups[key];
          const seriesLogs = group.logs;
          const subjectName = subjectNames[group.subjectCode] || group.subjectCode;
          const subjectTotal = subjectUnitCounts[group.subjectCode] || 20;
          const subjectCompleted = getFilteredCompletedCount(group.subjectCode, logs);
          const displayTitle = group.series + ' ' + subjectName + ' (' + subjectCompleted + '/' + subjectTotal + ')';

          // í‰ê·  ê³„ì‚°
          let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
          let totalInferential = 0, totalCritical = 0;
          let count = 0;

          seriesLogs.forEach(log => {
            if (log.radar) {
              totalLiteral += log.radar.literal || 0;
              totalStructural += log.radar.structural || 0;
              totalLexical += log.radar.lexical || 0;
              totalInferential += log.radar.inferential || 0;
              totalCritical += log.radar.critical || 0;
              count++;
            }
          });

          if (count === 0) return;

          const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
          const avgStructural = Math.round((totalStructural / count) * 10) / 10;
          const avgLexical = Math.round((totalLexical / count) * 10) / 10;
          const avgInferential = Math.round((totalInferential / count) * 10) / 10;
          const avgCritical = Math.round((totalCritical / count) * 10) / 10;

          const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
          const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
          const maxScore = Math.max(...scores).toFixed(1);
          const minScore = Math.min(...scores).toFixed(1);

          // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
          let badgeClass = 'badge-normal';
          let badgeText = 'ë³´í†µ';
          if (avgScore >= 9) {
            badgeClass = 'badge-excellent';
            badgeText = 'ìš°ìˆ˜';
          } else if (avgScore >= 8) {
            badgeClass = 'badge-good';
            badgeText = 'ì–‘í˜¸';
          } else if (avgScore >= 7) {
            badgeClass = 'badge-normal';
            badgeText = 'ë³´í†µ';
          } else {
            badgeClass = 'badge-encourage';
            badgeText = 'ê²©ë ¤';
          }

          // ì°¨íŠ¸ ì¹´ë“œ ìƒì„±
          const fieldClass = subjectToFieldClass[group.subjectCode] || '';
          const card = document.createElement('div');
          card.className = 'radar-card summary-card subject-card ' + fieldClass + (summaryIndex >= 6 ? ' hidden-card' : '');
          summaryIndex++;

          const header = document.createElement('div');
          header.className = 'radar-card-header';

          const title = document.createElement('div');
          title.className = 'radar-card-title';
          title.textContent = displayTitle;

          const badge = document.createElement('span');
          badge.className = 'badge ' + badgeClass;
          badge.textContent = badgeText;

          header.appendChild(title);
          header.appendChild(badge);
          card.appendChild(header);

          const canvas = document.createElement('canvas');
          card.appendChild(canvas);

          // ë“±ê¸‰ í´ë˜ìŠ¤ ê²°ì •
          let gradeClass = 'encourage';
          if (avgScore >= 9) gradeClass = 'excellent';
          else if (avgScore >= 8) gradeClass = 'good';
          else if (avgScore >= 7) gradeClass = 'normal';

          // í†µê³„ ì •ë³´ ì¶”ê°€
          const stats = document.createElement('div');
          stats.className = 'radar-card-stats';
          stats.innerHTML =
            '<div class="stat-item">' +
              '<div class="stat-label">í‰ê· </div>' +
              '<div class="stat-value ' + gradeClass + '">' + avgScore + '</div>' +
              '<div class="stat-grade ' + gradeClass + '">' + badgeText + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœê³ </div>' +
              '<div class="stat-value">' + maxScore + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœì €</div>' +
              '<div class="stat-value">' + minScore + '</div>' +
            '</div>';
          card.appendChild(stats);

          summaryWrap.appendChild(card);

          // ì°¨íŠ¸ ìƒì„±
          new Chart(canvas.getContext('2d'), {
            type: 'radar',
            data: {
              labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
              datasets: [{
                label: displayTitle,
                data: scores,
                backgroundColor: 'rgba(245, 87, 108, 0.2)',
                borderColor: '#f5576c',
                borderWidth: 3,
                pointBackgroundColor: '#f5576c',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#f5576c',
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                r: {
                  beginAtZero: true,
                  max: 10,
                  ticks: {
                    stepSize: 2,
                    font: { size: 11 }
                  },
                  pointLabels: {
                    font: { size: 12, weight: 'bold' }
                  },
                  grid: { color: '#f5c6cb' },
                  angleLines: { color: '#f5c6cb' }
                }
              }
            }
          });
        });

          // ì¢…í•© ë ˆì´ë” ì°¨íŠ¸ ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
          if (summaryIndex > 6) {
            document.getElementById('toggleSummaryBtn').style.display = 'block';
          } else {
            document.getElementById('toggleSummaryBtn').style.display = 'none';
          }
        }
        // renderSubjectRadar í•¨ìˆ˜ ë

        // ===== ê°œë³„ ë ˆì´ë” ì°¨íŠ¸ í•¨ìˆ˜ =====
        const radarWrap = document.getElementById('radar-wrap');

        function renderIndividualRadar(logs) {
          // ê¸°ì¡´ ì¹´ë“œ ì œê±°
          radarWrap.innerHTML = '';
          let radarIndex = 0;

          logs.forEach(function(log, idx) {
            if (!log.radar) return;

          const r = log.radar || {};

          // í†µê³„ ê³„ì‚°
          const scores = [
            r.literal || 0,
            r.structural || 0,
            r.lexical || 0,
            r.inferential || 0,
            r.critical || 0
          ];
          const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
          const maxScore = Math.max(...scores).toFixed(1);
          const minScore = Math.min(...scores).toFixed(1);

          // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
          let badgeClass = 'badge-normal';
          let badgeText = 'ë³´í†µ';
          if (avgScore >= 9) {
            badgeClass = 'badge-excellent';
            badgeText = 'ìš°ìˆ˜';
          } else if (avgScore >= 8) {
            badgeClass = 'badge-good';
            badgeText = 'ì–‘í˜¸';
          } else if (avgScore >= 7) {
            badgeClass = 'badge-normal';
            badgeText = 'ë³´í†µ';
          } else {
            badgeClass = 'badge-encourage';
            badgeText = 'ê²©ë ¤';
          }

          // ì¹´ë“œ ìƒì„±
          const card = document.createElement('div');
          card.className = 'radar-card' + (radarIndex >= 6 ? ' hidden-card' : '');
          card.style.cursor = 'pointer';

          // ë‹¨ì› í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì›ìœ¼ë¡œ ì´ë™
          const unitCode = log.unit || '';
          // FIT ì‹œë¦¬ì¦ˆëŠ” í•­ìƒ BRAINUP í´ë”ì— ì €ì¥ë¨
          let seriesCode = 'BRAINUP';
          if (unitCode) {
            // unit ì½”ë“œì—ì„œ ê³¼ëª©ê³¼ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: bio_01, geo_01, fit_bio_01, deep_bio_01)
            const parts = unitCode.split('_');
            let subject = parts[0] || '';

            // fit_ / deep_ ì ‘ë‘ì–´ì¸ ê²½ìš° ì‹¤ì œ ê³¼ëª©ëª…ì€ parts[1]
            if ((subject === 'fit' || subject === 'deep') && parts.length >= 3) {
              subject = parts[1]; // fit_bio_01 â†’ bio, deep_bio_01 â†’ bio
            }

            // ê³¼ëª©ë³„ í´ë” ë§¤í•‘
            const folderMap = {
              'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
              'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
              'modern': 'korlit', 'classic': 'korlit',
              'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
              'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
            };
            const folder = folderMap[subject] || 'social';

            // ë””ë²„ê·¸ ë¡œê·¸
            console.log('[ë‹¨ì› ì´ë™] unitCode:', unitCode, 'subject:', subject, 'folder:', folder);

            const unitPath = '/' + seriesCode + '/' + folder + '/' + unitCode + '.html';

            card.onclick = function() {
              console.log('[í´ë¦­] ì´ë™ ê²½ë¡œ:', unitPath);
              window.location.href = unitPath;
            };
            card.title = 'í´ë¦­í•˜ì—¬ ë‹¨ì›ìœ¼ë¡œ ì´ë™';
          }
          radarIndex++;

          const header = document.createElement('div');
          header.className = 'radar-card-header';

          const titleSection = document.createElement('div');
          titleSection.style.cssText = 'flex: 1; text-align: center;';

          const seriesLabel = document.createElement('div');
          seriesLabel.style.cssText = 'font-size: 11px; color: #95a5a6; margin-bottom: 4px;';
          // unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆëª… ì¶”ì¶œ
          const seriesFromUnitForLabel = (function(unit) {
            if (!unit) return 'BRAINì—…';
            if (unit.includes('on_')) return 'BRAINì˜¨';
            if (unit.includes('fit_')) return 'BRAINí•';
            if (unit.includes('deep_')) return 'BRAINë”¥';
            return 'BRAINì—…';
          })(log.unit);
          seriesLabel.textContent = 'ğŸ“š ' + seriesFromUnitForLabel;

          const title = document.createElement('div');
          title.className = 'radar-card-title';

          // ë‹¨ì› ì½”ë“œ â†’ ë‹¨ì›ëª… ë³€í™˜ (ì˜ˆ: geo_01 â†’ ì§€ë¦¬ 01, world2_01 â†’ ì„¸ê³„ë¬¸í•™2 1, fit_bio_01 â†’ ìƒë¬¼ 1, on_bio_01 â†’ ìƒë¬¼ 1)
          let unitName = log.unit || 'ë‹¨ì›';
          if (unitName && unitName.includes('_')) {
            const parts = unitName.split('_');
            const subjectMap = { 'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™', 'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ', 'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™1', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'people': 'í•œêµ­ì¸ë¬¼', 'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼', 'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼' };
            // fit_/deep_/on_ ì ‘ë‘ì–´ ì²˜ë¦¬: fit_bio_01 â†’ ['fit', 'bio', '01'], deep_bio_01 â†’ ['deep', 'bio', '01'], on_bio_01 â†’ ['on', 'bio', '01']
            let subjectKey = parts[0];
            let numStr = parts[1];
            if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
              subjectKey = parts[1];
              numStr = parts[2];
            }
            const subject = subjectMap[subjectKey] || subjectKey;
            let number = numStr ? parseInt(numStr, 10) : 0;
            // world_41~80ì€ ì„¸ê³„ë¬¸í•™2ë¡œ í‘œì‹œ (world_41 â†’ ì„¸ê³„ë¬¸í•™2 1)
            if (subjectKey === 'world' && number > 40) {
              number = number - 40;
              unitName = 'ì„¸ê³„ë¬¸í•™2 ' + number;
            } else {
              unitName = subject + ' ' + number;
            }
          }
          title.textContent = unitName + ' ë¶„ì„';

          const timeLabel = document.createElement('div');
          timeLabel.className = 'radar-card-time';
          const ts = log.timestamp ? new Date(log.timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }) : '-';
          timeLabel.innerHTML = 'ğŸ• ' + ts;

          titleSection.appendChild(seriesLabel);
          titleSection.appendChild(title);
          titleSection.appendChild(timeLabel);

          const badge = document.createElement('span');
          badge.className = 'badge ' + badgeClass;
          badge.textContent = badgeText;

          header.appendChild(titleSection);
          header.appendChild(badge);
          card.appendChild(header);

          const canvas = document.createElement('canvas');
          card.appendChild(canvas);

          // ë“±ê¸‰ í´ë˜ìŠ¤ ê²°ì •
          let gradeClass = 'encourage';
          if (avgScore >= 9) gradeClass = 'excellent';
          else if (avgScore >= 8) gradeClass = 'good';
          else if (avgScore >= 7) gradeClass = 'normal';

          // í†µê³„ ì •ë³´ ì¶”ê°€
          const stats = document.createElement('div');
          stats.className = 'radar-card-stats';
          stats.innerHTML =
            '<div class="stat-item">' +
              '<div class="stat-label">í‰ê· </div>' +
              '<div class="stat-value ' + gradeClass + '">' + avgScore + '</div>' +
              '<div class="stat-grade ' + gradeClass + '">' + badgeText + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœê³ </div>' +
              '<div class="stat-value">' + maxScore + '</div>' +
            '</div>' +
            '<div class="stat-item">' +
              '<div class="stat-label">ìµœì €</div>' +
              '<div class="stat-value">' + minScore + '</div>' +
            '</div>';
          card.appendChild(stats);

          // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì› í˜ì´ì§€ë¡œ ì´ë™
          card.style.cursor = 'pointer';
          card.addEventListener('click', function() {
            const unitCode = log.unit; // ì˜ˆ: geo_01, bio_01, fit_bio_01
            if (unitCode) {
              // ë‹¨ì› ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ (fit_ / deep_ ì ‘ë‘ì–´ ì²˜ë¦¬)
              const parts = unitCode.split('_');
              let subject = parts[0] || '';

              // fit_ / deep_ / on_ ì ‘ë‘ì–´ì¸ ê²½ìš° ì‹¤ì œ ê³¼ëª©ëª…ì€ parts[1]
              if ((subject === 'fit' || subject === 'deep' || subject === 'on') && parts.length >= 3) {
                subject = parts[1]; // fit_bio_01 â†’ bio, deep_bio_01 â†’ bio, on_bio_01 â†’ bio
              }

              // ê³¼ëª©ë³„ í´ë” ë§¤í•‘
              const folderMap = {
                'geo': 'social', 'soc': 'social', 'law': 'social', 'pol': 'social',
                'bio': 'science', 'earth': 'science', 'physics': 'science', 'chem': 'science',
                'modern': 'korlit', 'classic': 'korlit',
                'world': 'worldlit', 'world1': 'worldlit', 'world2': 'worldlit',
                'people': 'person', 'people1': 'person', 'people2': 'person', 'person1': 'person', 'person2': 'person'
              };
              const folder = folderMap[subject] || 'social';

              // series ì½”ë“œë¥¼ unitì—ì„œ ì¶”ì¶œ
              let seriesCode = 'BRAINUP';
              if (unitCode.includes('on_')) seriesCode = 'BRAINUP'; // on_ íŒŒì¼ì€ BRAINUP í´ë”ì— ìˆìŒ
              else if (unitCode.includes('fit_')) seriesCode = 'BRAINUP';
              else if (unitCode.includes('deep_')) seriesCode = 'BRAINUP';

              const unitUrl = '/' + seriesCode + '/' + folder + '/' + unitCode + '.html';
              console.log('[ë ˆì´ë” í´ë¦­] unitCode:', unitCode, 'subject:', subject, 'folder:', folder, 'url:', unitUrl);
              window.location.href = unitUrl;
            }
          });

          radarWrap.appendChild(card);

          // ì°¨íŠ¸ ìƒì„±
          new Chart(canvas.getContext('2d'), {
            type: 'radar',
            data: {
              labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
              datasets: [{
                label: unitName + ' ë¶„ì„ë¦¬í¬íŠ¸',
                data: scores,
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: '#667eea',
                borderWidth: 3,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#667eea',
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                r: {
                  beginAtZero: true,
                  max: 10,
                  ticks: {
                    stepSize: 2,
                    font: { size: 11 }
                  },
                  pointLabels: {
                    font: { size: 12, weight: 'bold' }
                  },
                  grid: { color: '#e5d4c1' },
                  angleLines: { color: '#e5d4c1' }
                }
              }
            }
          });
        });

          // ê°œë³„ ë ˆì´ë” ì°¨íŠ¸ ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
          if (radarIndex > 6) {
            document.getElementById('toggleRadarBtn').style.display = 'block';
          } else {
            document.getElementById('toggleRadarBtn').style.display = 'none';
          }
        }
        // renderIndividualRadar í•¨ìˆ˜ ë

        // PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ (html2canvas + jsPDF ë°©ì‹)
        console.log('ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');

        window.addEventListener('message', async function(event) {
          console.log('ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);

          if (event.data && event.data.action === 'downloadPDF') {
            console.log('âœ… PDF ë‹¤ìš´ë¡œë“œ ì‹œì‘');

            try {
              window.scrollTo(0, 0);
              const target = document.querySelector('.container');

              if (!target) {
                console.error('âŒ ì»¨í…Œì´ë„ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                alert('PDF ìƒì„± ì‹¤íŒ¨: ì»¨í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              console.log('ğŸ“¦ ì»¨í…Œì´ë„ˆ ìš”ì†Œ ì°¾ìŒ:', target);

              const filename = \`í•™ìŠµë¶„ì„_${grade}_${name}_\${new Date().toISOString().split('T')[0]}.pdf\`;
              console.log('ğŸ“ íŒŒì¼ëª…:', filename);

              // ìº¡ì²˜ ì „ì— ìŠ¤í¬ë¡¤ ì˜ì—­ ë†’ì´ ìë™ ì¡°ì •
              const body = document.body;
              const html = document.documentElement;
              const originalBodyHeight = body.style.height;
              const originalHtmlHeight = html.style.height;
              const originalBodyOverflow = body.style.overflow;
              const originalHtmlOverflow = html.style.overflow;

              // ì „ì²´ ë‚´ìš©ì´ ë³´ì´ë„ë¡ ë†’ì´ ì¡°ì •
              body.style.height = 'auto';
              html.style.height = 'auto';
              body.style.overflow = 'visible';
              html.style.overflow = 'visible';

              console.log('ğŸ¨ ìº”ë²„ìŠ¤ ìƒì„± ì¤‘... (ìŠ¤í¬ë¡¤ ì—†ìŒ ëª¨ë“œ)');
              const canvas = await html2canvas(target, {
                scale: 1.5,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                logging: false,
                windowHeight: target.scrollHeight,
                height: target.scrollHeight
              });

              // ì›ë˜ëŒ€ë¡œ ë³µêµ¬
              body.style.height = originalBodyHeight;
              html.style.height = originalHtmlHeight;
              body.style.overflow = originalBodyOverflow;
              html.style.overflow = originalHtmlOverflow;

              console.log('âœ… ìº”ë²„ìŠ¤ ìƒì„± ì™„ë£Œ:', canvas.width, 'x', canvas.height);

              // PNG ëŒ€ì‹  JPEG ì‚¬ìš© (í’ˆì§ˆ 0.5, ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ)
              const imgData = canvas.toDataURL('image/jpeg', 0.5);
              console.log('ğŸ“¸ ì´ë¯¸ì§€ ë°ì´í„° ìƒì„± ì™„ë£Œ (JPEG, í’ˆì§ˆ 0.5)');

              // jsPDFë¡œ PDF ìƒì„±
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF('p', 'mm', 'a4');
              const pdfW = pdf.internal.pageSize.getWidth();
              const pdfH = pdf.internal.pageSize.getHeight();

              const imgW = pdfW;
              const imgH = canvas.height * imgW / canvas.width;

              let heightLeft = imgH;
              let position = 0;

              console.log('ğŸ“„ PDF ìƒì„± ì¤‘... (í˜ì´ì§€ ë†’ì´:', imgH, 'mm)');

              // ì²« í˜ì´ì§€ (JPEG í˜•ì‹ ì‚¬ìš©)
              pdf.addImage(imgData, 'JPEG', 0, position, imgW, imgH);
              heightLeft -= pdfH;

              // ì¶”ê°€ í˜ì´ì§€
              while (heightLeft > 0) {
                position = heightLeft - imgH;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, imgW, imgH);
                heightLeft -= pdfH;
              }

              // PDF ì €ì¥
              pdf.save(filename);
              console.log('âœ… PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');

            } catch (error) {
              console.error('âŒ PDF ìƒì„± ì˜¤ë¥˜:', error);
              alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
          }
        });

        // ===== ì‹œë¦¬ì¦ˆ ì¢…í•© ë ˆì´ë” =====
        function renderSeriesRadar(logs) {
          console.log('ğŸ¯ renderSeriesRadar ì‹¤í–‰, ì´ ë¡œê·¸:', logs.length);
          const seriesWrap = document.getElementById('series-radar-wrap');

          // ê¸°ì¡´ ì¹´ë“œ ì œê±°
          seriesWrap.innerHTML = '';

          // ëª¨ë“  radar ë°ì´í„°ê°€ ìˆëŠ” ë¡œê·¸ ìˆ˜ì§‘
          const validLogs = logs.filter(log => log.radar);
          console.log('ğŸ“Š radar ë°ì´í„°ê°€ ìˆëŠ” ë¡œê·¸:', validLogs.length);

          if (validLogs.length === 0) {
            console.log('âš ï¸ ìœ íš¨í•œ ë¡œê·¸ê°€ ì—†ìŒ');
            seriesWrap.innerHTML = '<p style="color:#777; font-size:13px;">ì•„ì§ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìˆëŠ” í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          console.log('âœ… ì‹œë¦¬ì¦ˆ ë ˆì´ë” ì°¨íŠ¸ ìƒì„± ì‹œì‘');

          // ì‹œë¦¬ì¦ˆë³„ë¡œ ê·¸ë£¹í™” (unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆ ì¶”ì¶œ)
          const seriesGroups = {};
          validLogs.forEach(log => {
            // unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆëª… ì¶”ì¶œ
            let series = 'BRAINì—…';
            if (log.unit) {
              if (log.unit.includes('on_')) series = 'BRAINì˜¨';
              else if (log.unit.includes('fit_')) series = 'BRAINí•';
              else if (log.unit.includes('deep_')) series = 'BRAINë”¥';
            }
            if (!seriesGroups[series]) {
              seriesGroups[series] = [];
            }
            seriesGroups[series].push(log);
          });

          // ê° ì‹œë¦¬ì¦ˆë³„ë¡œ ì¹´ë“œ ìƒì„±
          Object.keys(seriesGroups).forEach(seriesName => {
            const seriesLogs = seriesGroups[seriesName];

            // í‰ê·  ê³„ì‚°
            let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
            let totalInferential = 0, totalCritical = 0;
            let count = 0;

            seriesLogs.forEach(log => {
              totalLiteral += log.radar.literal || 0;
              totalStructural += log.radar.structural || 0;
              totalLexical += log.radar.lexical || 0;
              totalInferential += log.radar.inferential || 0;
              totalCritical += log.radar.critical || 0;
              count++;
            });

            const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
            const avgStructural = Math.round((totalStructural / count) * 10) / 10;
            const avgLexical = Math.round((totalLexical / count) * 10) / 10;
            const avgInferential = Math.round((totalInferential / count) * 10) / 10;
            const avgCritical = Math.round((totalCritical / count) * 10) / 10;

            const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
            const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
            const maxScore = Math.max(...scores).toFixed(1);
            const minScore = Math.min(...scores).toFixed(1);

            // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            let gradeClass = 'normal';
            if (avgScore >= 9) {
              badgeClass = 'badge-excellent';
              badgeText = 'ìš°ìˆ˜';
              gradeClass = 'excellent';
            } else if (avgScore >= 8) {
              badgeClass = 'badge-good';
              badgeText = 'ì–‘í˜¸';
              gradeClass = 'good';
            } else if (avgScore >= 7) {
              badgeClass = 'badge-normal';
              badgeText = 'ë³´í†µ';
              gradeClass = 'normal';
            } else {
              badgeClass = 'badge-encourage';
              badgeText = 'ê²©ë ¤';
              gradeClass = 'encourage';
            }

            // í•´ë‹¹ ì‹œë¦¬ì¦ˆì˜ ê³ ìœ  ë‹¨ì› ìˆ˜ ê³„ì‚°
            const seriesUnitsSet = new Set();
            seriesLogs.forEach(log => {
              if (log.unit) {
                seriesUnitsSet.add(normalizeUnitCode(log.unit));
              }
            });
            const seriesCompleted = seriesUnitsSet.size;

            // ì°¨íŠ¸ ì¹´ë“œ ìƒì„±
            const card = document.createElement('div');
            card.className = 'radar-card summary-card series-card';

            const header = document.createElement('div');
            header.className = 'radar-card-header';

            const title = document.createElement('div');
            title.className = 'radar-card-title';
            title.textContent = seriesName + ' (' + seriesCompleted + '/' + seriesTotalUnits + ')';

            const badge = document.createElement('div');
            badge.className = 'badge ' + badgeClass;
            badge.textContent = badgeText;

            header.appendChild(title);
            header.appendChild(badge);
            card.appendChild(header);

            const canvas = document.createElement('canvas');
            canvas.width = 280;
            canvas.height = 280;
            card.appendChild(canvas);

            // í†µê³„ ì •ë³´
            const stats = document.createElement('div');
            stats.className = 'radar-card-stats';
            stats.innerHTML =
              '<div class="stat-item">' +
                '<div class="stat-label">í‰ê· </div>' +
                '<div class="stat-value">' + avgScore + '</div>' +
                '<div class="stat-grade ' + gradeClass + '">' + badgeText + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœê³ </div>' +
                '<div class="stat-value">' + maxScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœì €</div>' +
                '<div class="stat-value">' + minScore + '</div>' +
              '</div>';
            card.appendChild(stats);

            seriesWrap.appendChild(card);

            // ì°¨íŠ¸ ìƒì„±
            new Chart(canvas.getContext('2d'), {
              type: 'radar',
              data: {
                labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
                datasets: [{
                  label: seriesName + ' ì „ì²´',
                  data: scores,
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  borderColor: 'rgb(54, 162, 235)',
                  borderWidth: 3,
                  pointBackgroundColor: 'rgb(54, 162, 235)',
                  pointBorderColor: '#fff',
                  pointBorderWidth: 2,
                  pointRadius: 5,
                  pointHoverRadius: 7
                }]
              },
              options: {
                responsive: false,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  r: {
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: {
                      stepSize: 2,
                      backdropColor: 'transparent',
                      font: { size: 11 }
                    },
                    pointLabels: {
                      font: { size: 12, weight: 'bold' }
                    },
                    grid: { color: '#e5d4c1' },
                    angleLines: { color: '#e5d4c1' }
                  }
                }
              }
            });
          });
        }

        // ===== ë¶„ì•¼ë³„ ì¢…í•© ë ˆì´ë” =====
        function renderFieldRadar(logs) {
          console.log('ğŸ¯ renderFieldRadar ì‹¤í–‰, ì´ ë¡œê·¸:', logs.length);
          const fieldWrap = document.getElementById('field-radar-wrap');
          fieldWrap.innerHTML = '';  // ê¸°ì¡´ ì¹´ë“œ ì œê±°

          // ê³¼ëª© ì½”ë“œ â†’ ë¶„ì•¼ ë§¤í•‘
          const subjectToField = {
            'geo': 'ì‚¬íšŒë¶„ì•¼',
            'soc': 'ì‚¬íšŒë¶„ì•¼',
            'law': 'ì‚¬íšŒë¶„ì•¼',
            'pol': 'ì‚¬íšŒë¶„ì•¼',
            'bio': 'ê³¼í•™ë¶„ì•¼',
            'earth': 'ê³¼í•™ë¶„ì•¼',
            'physics': 'ê³¼í•™ë¶„ì•¼',
            'chem': 'ê³¼í•™ë¶„ì•¼',
            'modern': 'í•œêµ­ë¬¸í•™',
            'classic': 'í•œêµ­ë¬¸í•™',
            'world': 'ì„¸ê³„ë¬¸í•™',
            'world1': 'ì„¸ê³„ë¬¸í•™',
            'world2': 'ì„¸ê³„ë¬¸í•™',
            'people': 'ì¸ë¬¼ë¶„ì•¼',
            'people1': 'ì¸ë¬¼ë¶„ì•¼',
            'people2': 'ì¸ë¬¼ë¶„ì•¼',
            'person1': 'ì¸ë¬¼ë¶„ì•¼',
            'person2': 'ì¸ë¬¼ë¶„ì•¼'
          };

          // ë¶„ì•¼ëª… â†’ CSS í´ë˜ìŠ¤ ë§¤í•‘
          const fieldToClass = {
            'ê³¼í•™ë¶„ì•¼': 'science',
            'ì‚¬íšŒë¶„ì•¼': 'society',
            'í•œêµ­ë¬¸í•™': 'korean-lit',
            'ì„¸ê³„ë¬¸í•™': 'world-lit',
            'ì¸ë¬¼ë¶„ì•¼': 'person'
          };

          // ì •ê·œí™”ëœ ë‹¨ì› ì½”ë“œë¡œ ì¤‘ë³µ ì œê±° í›„ ì‹œë¦¬ì¦ˆ+ë¶„ì•¼ë³„ë¡œ ê·¸ë£¹í™”
          const fieldGroups = {};
          const processedUnits = new Set(); // ì´ë¯¸ ì²˜ë¦¬ëœ ì‹œë¦¬ì¦ˆ_ì •ê·œí™”ë‹¨ì›ì½”ë“œ ì¶”ì 

          logs.forEach(log => {
            if (!log.radar || !log.unit) return;

            // ì •ê·œí™”ëœ ë‹¨ì› ì½”ë“œ ìƒì„±
            const normalizedUnit = normalizeUnitCode(log.unit);
            // unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆëª… ì¶”ì¶œ
            let seriesName = 'BRAINì—…';
            if (log.unit.includes('on_')) seriesName = 'BRAINì˜¨';
            else if (log.unit.includes('fit_')) seriesName = 'BRAINí•';
            else if (log.unit.includes('deep_')) seriesName = 'BRAINë”¥';

            // ì‹œë¦¬ì¦ˆ+ë‹¨ì› ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬
            const uniqueKey = seriesName + '_' + normalizedUnit;
            if (processedUnits.has(uniqueKey)) return;
            processedUnits.add(uniqueKey);

            // ì •ê·œí™”ëœ unit ì½”ë“œì—ì„œ ê³¼ëª© ì¶”ì¶œ
            const subjectCode = normalizedUnit.split('_')[0];
            const fieldName = subjectToField[subjectCode];

            if (!fieldName) return; // ë§¤í•‘ë˜ì§€ ì•Šì€ ê³¼ëª©ì€ ì œì™¸

            // ì‹œë¦¬ì¦ˆ+ë¶„ì•¼ë¥¼ í‚¤ë¡œ ì‚¬ìš©
            const groupKey = seriesName + '_' + fieldName;
            if (!fieldGroups[groupKey]) {
              fieldGroups[groupKey] = {
                series: seriesName,
                field: fieldName,
                logs: []
              };
            }
            fieldGroups[groupKey].logs.push(log);
          });

          // ê° ì‹œë¦¬ì¦ˆ+ë¶„ì•¼ë³„ë¡œ í‰ê·  ê³„ì‚° ë° ì°¨íŠ¸ ìƒì„±
          let fieldIndex = 0;
          console.log('ğŸ“Š ë¶„ì•¼ë³„ ê·¸ë£¹í™” ê²°ê³¼:', Object.keys(fieldGroups).map(f => f + ': ' + fieldGroups[f].logs.length + 'ê°œ'));
          Object.keys(fieldGroups).forEach(groupKey => {
            const group = fieldGroups[groupKey];
            const seriesName = group.series;
            const fieldName = group.field;
            const fieldLogs = group.logs;
            console.log('ğŸ¯ ì‹œë¦¬ì¦ˆ+ë¶„ì•¼:', groupKey, 'ë¡œê·¸ ìˆ˜:', fieldLogs.length, 'ë‹¨ì›:', fieldLogs.map(l => l.unit));

            // í‰ê·  ê³„ì‚°
            let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
            let totalInferential = 0, totalCritical = 0;
            let count = 0;

            fieldLogs.forEach(log => {
              if (log.radar) {
                totalLiteral += log.radar.literal || 0;
                totalStructural += log.radar.structural || 0;
                totalLexical += log.radar.lexical || 0;
                totalInferential += log.radar.inferential || 0;
                totalCritical += log.radar.critical || 0;
                count++;
              }
            });

            if (count === 0) return;

            const avgLiteral = Math.round((totalLiteral / count) * 10) / 10;
            const avgStructural = Math.round((totalStructural / count) * 10) / 10;
            const avgLexical = Math.round((totalLexical / count) * 10) / 10;
            const avgInferential = Math.round((totalInferential / count) * 10) / 10;
            const avgCritical = Math.round((totalCritical / count) * 10) / 10;

            const scores = [avgLiteral, avgStructural, avgLexical, avgInferential, avgCritical];
            const avgScore = (scores.reduce((a, b) => a + b, 0) / 5).toFixed(1);
            const maxScore = Math.max(...scores).toFixed(1);
            const minScore = Math.min(...scores).toFixed(1);

            // ë±ƒì§€ ë“±ê¸‰ ê²°ì •
            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            let gradeClass = 'normal';
            if (avgScore >= 9) {
              badgeClass = 'badge-excellent';
              badgeText = 'ìš°ìˆ˜';
              gradeClass = 'excellent';
            } else if (avgScore >= 8) {
              badgeClass = 'badge-good';
              badgeText = 'ì–‘í˜¸';
              gradeClass = 'good';
            } else if (avgScore >= 7) {
              badgeClass = 'badge-normal';
              badgeText = 'ë³´í†µ';
              gradeClass = 'normal';
            }

            // ì°¨íŠ¸ ì¹´ë“œ ìƒì„±
            const fieldCssClass = fieldToClass[fieldName] || '';
            const card = document.createElement('div');
            card.className = 'radar-card summary-card field-card ' + fieldCssClass + (fieldIndex >= 5 ? ' hidden-card' : '');
            fieldIndex++;

            const header = document.createElement('div');
            header.className = 'radar-card-header';

            // ë¶„ì•¼ë³„ ì´ ë‹¨ì› ìˆ˜
            const fieldTotal = fieldUnitCounts[fieldName] || 80;
            // fieldLogs.lengthê°€ ì´ë¯¸ í•´ë‹¹ ë¶„ì•¼ì˜ ê³ ìœ  ë‹¨ì› ìˆ˜ (processedUnitsì—ì„œ ì¤‘ë³µ ì œê±°ë¨)
            const fieldCompleted = fieldLogs.length;

            const title = document.createElement('div');
            title.className = 'radar-card-title';
            title.textContent = seriesName + ' ' + fieldName + ' (' + fieldCompleted + '/' + fieldTotal + ')';

            const badge = document.createElement('div');
            badge.className = 'badge ' + badgeClass;
            badge.textContent = badgeText;

            header.appendChild(title);
            header.appendChild(badge);
            card.appendChild(header);

            const canvas = document.createElement('canvas');
            canvas.width = 280;
            canvas.height = 280;
            card.appendChild(canvas);

            // í†µê³„ ì •ë³´
            const stats = document.createElement('div');
            stats.className = 'radar-card-stats';
            stats.innerHTML =
              '<div class="stat-item">' +
                '<div class="stat-label">í‰ê· </div>' +
                '<div class="stat-value">' + avgScore + '</div>' +
                '<div class="stat-grade ' + gradeClass + '">' + badgeText + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœê³ </div>' +
                '<div class="stat-value">' + maxScore + '</div>' +
              '</div>' +
              '<div class="stat-item">' +
                '<div class="stat-label">ìµœì €</div>' +
                '<div class="stat-value">' + minScore + '</div>' +
              '</div>';
            card.appendChild(stats);

            fieldWrap.appendChild(card);

            // ì°¨íŠ¸ ìƒì„±
            new Chart(canvas.getContext('2d'), {
              type: 'radar',
              data: {
                labels: ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡ Â·í†µí•©ë ¥', 'ë¹„íŒÂ·ì ìš©ë ¥'],
                datasets: [{
                  label: fieldName,
                  data: scores,
                  backgroundColor: 'rgba(153, 102, 255, 0.2)',
                  borderColor: 'rgb(153, 102, 255)',
                  borderWidth: 3,
                  pointBackgroundColor: 'rgb(153, 102, 255)',
                  pointBorderColor: '#fff',
                  pointBorderWidth: 2,
                  pointRadius: 5,
                  pointHoverRadius: 7
                }]
              },
              options: {
                responsive: false,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  r: {
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: {
                      stepSize: 2,
                      backdropColor: 'transparent',
                      font: { size: 11 }
                    },
                    pointLabels: {
                      font: { size: 12, weight: 'bold' }
                    },
                    grid: { color: '#e5d4c1' },
                    angleLines: { color: '#e5d4c1' }
                  }
                }
              }
            });
          });

          // ë¶„ì•¼ë³„ ë ˆì´ë”ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
          if (fieldIndex === 0) {
            console.log('âš ï¸ ë¶„ì•¼ë³„ ë ˆì´ë” ë°ì´í„° ì—†ìŒ');
            fieldWrap.innerHTML = '<p style="color:#777; font-size:13px;">ì•„ì§ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìˆëŠ” í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          } else {
            console.log('âœ… ë¶„ì•¼ë³„ ë ˆì´ë” ì°¨íŠ¸ ìƒì„± ì™„ë£Œ, ì´:', fieldIndex);
          }
        }

        // ===== ì‹œë¦¬ì¦ˆ ì„ íƒ ê¸°ëŠ¥ =====
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì´ˆê¸° ì‹œë¦¬ì¦ˆ ì„¤ì •
        const urlParams = new URLSearchParams(window.location.search);
        const initialSeries = urlParams.get('series');
        let currentSelectedSeries = 'all';

        // series íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ì´ˆê¸° ì‹œë¦¬ì¦ˆ ì„¤ì •
        if (initialSeries === 'fit') {
          currentSelectedSeries = 'BRAINí•';
        } else if (initialSeries === 'up') {
          currentSelectedSeries = 'BRAINì—…';
        } else if (initialSeries === 'deep') {
          currentSelectedSeries = 'BRAINë”¥';
        } else if (initialSeries === 'on') {
          currentSelectedSeries = 'BRAINì˜¨';
        }

        allLogs = logsForChart;

        // ì–´íœ˜ ì ìˆ˜ ì°¨íŠ¸ ì´ˆê¸° ë Œë”ë§ (allLogs ì´ˆê¸°í™” í›„)
        renderVocabScoreChart();

        // ë“œë¡­ë‹¤ìš´ í† ê¸€
        document.getElementById('seriesButton').addEventListener('click', function() {
          const menu = document.getElementById('seriesMenu');
          const button = this;
          menu.classList.toggle('show');
          button.classList.toggle('active');
        });

        // ===== ì •ë ¬ ê¸°ì¤€ ë³€ìˆ˜ =====
        let currentSortBy = 'final'; // ê¸°ë³¸ê°’: ìµœì¢…
        let aiSortDirection = 'desc'; // AIê³¼ì œë¶€ì—¬ ì •ë ¬ ë°©í–¥: desc(ë‚´ë¦¼ì°¨ìˆœ), asc(ì˜¤ë¦„ì°¨ìˆœ)

        // ===== ì •ë ¬ í•¨ìˆ˜ =====
        function sortLogsByTime(sortBy) {
          currentSortBy = sortBy;
          const filteredLogs = getFilteredLogs();
          const sortedLogs = sortLogs(filteredLogs, sortBy);
          renderLogTable(sortedLogs);
        }

        // ===== AIê³¼ì œë¶€ì—¬ ë‚ ì§œ ì •ë ¬ í•¨ìˆ˜ (í´ë¦­ ê°€ëŠ¥í•œ í—¤ë”ìš©) =====
        function sortByAIAssignDate() {
          // í† ê¸€: í˜„ì¬ aiTask ì •ë ¬ì´ë©´ ë°©í–¥ ì „í™˜, ì•„ë‹ˆë©´ aiTask ì •ë ¬ë¡œ ë³€ê²½
          if (currentSortBy === 'aiTask') {
            aiSortDirection = aiSortDirection === 'desc' ? 'asc' : 'desc';
          } else {
            currentSortBy = 'aiTask';
            aiSortDirection = 'desc'; // ê¸°ë³¸ê°’: ìµœì‹ ìˆœ
          }

          const filteredLogs = getFilteredLogs();
          const sortedLogs = sortLogsWithAIDirection(filteredLogs, aiSortDirection);
          renderLogTable(sortedLogs);

          // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
          const sortIcon = document.getElementById('aiSortIcon');
          if (sortIcon) {
            sortIcon.textContent = aiSortDirection === 'desc' ? 'â†“' : 'â†‘';
          }

          console.log('ğŸ“Š AIê³¼ì œë¶€ì—¬ ì •ë ¬:', aiSortDirection === 'desc' ? 'ìµœì‹ ìˆœ' : 'ì˜¤ë˜ëœìˆœ');

          // ë‹¤ë¥¸ ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
          const finalIcon = document.getElementById('finalSortIcon');
          if (finalIcon) finalIcon.textContent = 'â‡…';
          const gradeIcon = document.getElementById('gradeSortIcon');
          if (gradeIcon) gradeIcon.textContent = 'â‡…';
        }

        // ===== ìµœì¢… ë‚ ì§œ ì •ë ¬ í•¨ìˆ˜ (í´ë¦­ ê°€ëŠ¥í•œ í—¤ë”ìš©) =====
        let finalSortDirection = 'desc'; // ìµœì¢… ë‚ ì§œ ì •ë ¬ ë°©í–¥

        function sortByFinalDate() {
          // í† ê¸€: í˜„ì¬ final ì •ë ¬ì´ë©´ ë°©í–¥ ì „í™˜, ì•„ë‹ˆë©´ final ì •ë ¬ë¡œ ë³€ê²½
          if (currentSortBy === 'final') {
            finalSortDirection = finalSortDirection === 'desc' ? 'asc' : 'desc';
          } else {
            currentSortBy = 'final';
            finalSortDirection = 'desc'; // ê¸°ë³¸ê°’: ìµœì‹ ìˆœ
          }

          const filteredLogs = getFilteredLogs();
          const sortedLogs = sortLogsWithFinalDirection(filteredLogs, finalSortDirection);
          renderLogTable(sortedLogs);

          // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
          const sortIcon = document.getElementById('finalSortIcon');
          if (sortIcon) {
            sortIcon.textContent = finalSortDirection === 'desc' ? 'â†“' : 'â†‘';
          }

          // ë‹¤ë¥¸ ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
          const aiIcon = document.getElementById('aiSortIcon');
          if (aiIcon) aiIcon.textContent = 'â‡…';

          console.log('ğŸ“Š ìµœì¢… ë‚ ì§œ ì •ë ¬:', finalSortDirection === 'desc' ? 'ìµœì‹ ìˆœ' : 'ì˜¤ë˜ëœìˆœ');

          // ë‹¤ë¥¸ ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
          const gradeIcon = document.getElementById('gradeSortIcon');
          if (gradeIcon) gradeIcon.textContent = 'â‡…';
        }

        // ===== ë“±ê¸‰ ì •ë ¬ í•¨ìˆ˜ (í´ë¦­ ê°€ëŠ¥í•œ í—¤ë”ìš©) =====
        let gradeSortDirection = 'desc'; // ë“±ê¸‰ ì •ë ¬ ë°©í–¥: desc(ë†’ì€ìˆœ), asc(ë‚®ì€ìˆœ)

        function sortByGrade() {
          // í† ê¸€: í˜„ì¬ grade ì •ë ¬ì´ë©´ ë°©í–¥ ì „í™˜, ì•„ë‹ˆë©´ grade ì •ë ¬ë¡œ ë³€ê²½
          if (currentSortBy === 'grade') {
            gradeSortDirection = gradeSortDirection === 'desc' ? 'asc' : 'desc';
          } else {
            currentSortBy = 'grade';
            gradeSortDirection = 'desc'; // ê¸°ë³¸ê°’: ë†’ì€ìˆœ (ìš°ìˆ˜â†’ê²©ë ¤)
          }

          const filteredLogs = getFilteredLogs();
          const sortedLogs = sortLogsWithGradeDirection(filteredLogs, gradeSortDirection);
          renderLogTable(sortedLogs);

          // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
          const sortIcon = document.getElementById('gradeSortIcon');
          if (sortIcon) {
            sortIcon.textContent = gradeSortDirection === 'desc' ? 'â†“' : 'â†‘';
          }

          // ë‹¤ë¥¸ ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
          const aiIcon = document.getElementById('aiSortIcon');
          if (aiIcon) aiIcon.textContent = 'â‡…';
          const finalIcon = document.getElementById('finalSortIcon');
          if (finalIcon) finalIcon.textContent = 'â‡…';

          console.log('ğŸ“Š ë“±ê¸‰ ì •ë ¬:', gradeSortDirection === 'desc' ? 'ë†’ì€ìˆœ' : 'ë‚®ì€ìˆœ');
        }

        // ===== ë“±ê¸‰ ì •ë ¬ (ë°©í–¥ ì§€ì • ê°€ëŠ¥) =====
        function sortLogsWithGradeDirection(logs, direction) {
          // ë“±ê¸‰ ì ìˆ˜ ë§¤í•‘: ìš°ìˆ˜(9+) > ì–‘í˜¸(8+) > ë³´í†µ(7+) > ê²©ë ¤(7ë¯¸ë§Œ)
          function getGradeScore(log) {
            const r = log.radar || {};
            const scores = [r.literal, r.structural, r.lexical, r.inferential, r.critical].filter(s => s != null);
            if (scores.length === 0) return 0;
            return scores.reduce((a, b) => a + b, 0) / scores.length;
          }

          return [...logs].sort((a, b) => {
            const scoreA = getGradeScore(a);
            const scoreB = getGradeScore(b);
            return direction === 'desc' ? (scoreB - scoreA) : (scoreA - scoreB);
          });
        }

        // ===== ìµœì¢… ë‚ ì§œ ì •ë ¬ (ë°©í–¥ ì§€ì • ê°€ëŠ¥) =====
        function sortLogsWithFinalDirection(logs, direction) {
          return [...logs].sort((a, b) => {
            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
            return direction === 'desc' ? (timeB - timeA) : (timeA - timeB);
          });
        }

        // ===== AIê³¼ì œë¶€ì—¬ ì •ë ¬ (ë°©í–¥ ì§€ì • ê°€ëŠ¥) =====
        function sortLogsWithAIDirection(logs, direction) {
          return [...logs].sort((a, b) => {
            // AIê³¼ì œë¶€ì—¬ê°€ ì—†ëŠ” í•­ëª©(-)ì€ í•­ìƒ ë§¨ ì•„ë˜
            const hasAiA = a.aiTaskAssignedAt ? 1 : 0;
            const hasAiB = b.aiTaskAssignedAt ? 1 : 0;
            if (hasAiA !== hasAiB) {
              return hasAiB - hasAiA; // AIê³¼ì œë¶€ì—¬ ìˆëŠ” ê²ƒì´ ë¨¼ì €
            }

            // ë‘˜ ë‹¤ AIê³¼ì œë¶€ì—¬ê°€ ìˆìœ¼ë©´ ì‹œê°„ìˆœ ì •ë ¬
            if (hasAiA && hasAiB) {
              const timeA = new Date(a.aiTaskAssignedAt).getTime();
              const timeB = new Date(b.aiTaskAssignedAt).getTime();
              return direction === 'desc' ? (timeB - timeA) : (timeA - timeB);
            }

            // ë‘˜ ë‹¤ AIê³¼ì œë¶€ì—¬ê°€ ì—†ìœ¼ë©´ ìµœì¢… ì‹œê°„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
            return timeB - timeA;
          });
        }

        function sortLogs(logs, sortBy) {
          return [...logs].sort((a, b) => {
            let timeA, timeB;

            if (sortBy === 'first') {
              // ìµœì´ˆ ì‹œê°„ (timestamp) - ì˜¤ë¦„ì°¨ìˆœ (ê°€ì¥ ì˜¤ë˜ëœ ê¸°ë¡ì´ ë§¨ ìœ„)
              timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
              timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
              return timeA - timeB; // ì˜¤ë¦„ì°¨ìˆœ (ì˜¤ë˜ëœ ê²ƒì´ ë§¨ ìœ„)
            } else if (sortBy === 'aiTask') {
              // AIê³¼ì œë¶€ì—¬ ì‹œê°„ - ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹ ì´ ë§¨ ìœ„)
              // AIê³¼ì œë¶€ì—¬ê°€ ìˆëŠ” í•­ëª©ì´ ë¨¼ì €, ì—†ëŠ” í•­ëª©ì€ ë’¤ë¡œ
              const hasAiA = a.aiTaskAssignedAt ? 1 : 0;
              const hasAiB = b.aiTaskAssignedAt ? 1 : 0;
              if (hasAiA !== hasAiB) {
                return hasAiB - hasAiA; // AIê³¼ì œë¶€ì—¬ ìˆëŠ” ê²ƒì´ ë¨¼ì €
              }
              // ë‘˜ ë‹¤ AIê³¼ì œë¶€ì—¬ê°€ ìˆìœ¼ë©´ ì‹œê°„ìˆœ ë‚´ë¦¼ì°¨ìˆœ
              if (hasAiA && hasAiB) {
                timeA = new Date(a.aiTaskAssignedAt).getTime();
                timeB = new Date(b.aiTaskAssignedAt).getTime();
                return timeB - timeA;
              }
              // ë‘˜ ë‹¤ AIê³¼ì œë¶€ì—¬ê°€ ì—†ìœ¼ë©´ ìµœì¢… ì‹œê°„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
              timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
              timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
              return timeB - timeA;
            } else {
              // ìµœì¢… ì‹œê°„ = í•™ìŠµ ì™„ë£Œ ì‹œì  (timestamp) - ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹ ì´ ë§¨ ìœ„)
              timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
              timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
              return timeB - timeA; // ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹ ì´ ë§¨ ìœ„)
            }
          });
        }

        // ì‹œë¦¬ì¦ˆë³„ ë¡œê·¸ í•„í„°ë§ í—¬í¼ í•¨ìˆ˜ (unit prefix ê¸°ë°˜)
        function filterLogsBySeries(logs, series) {
          if (series === 'all') return logs;
          return logs.filter(log => {
            if (!log.unit) return false;
            if (series === 'BRAINì˜¨') return log.unit.includes('on_');
            if (series === 'BRAINí•') return log.unit.includes('fit_');
            if (series === 'BRAINë”¥') return log.unit.includes('deep_');
            if (series === 'BRAINì—…') return !log.unit.includes('fit_') && !log.unit.includes('deep_') && !log.unit.includes('on_');
            return log.series === series;
          });
        }

        function getFilteredLogs() {
          // í˜„ì¬ ì‹œë¦¬ì¦ˆ í•„í„° ì ìš©
          return filterLogsBySeries(allLogs, currentSelectedSeries);
        }

        // ===== í•„í„° ì ìš© í•¨ìˆ˜ =====
        window.newApplyFilters = function() {
          // 1. ì‹œë¦¬ì¦ˆ í•„í„° ì ìš© (unit prefix ê¸°ë°˜)
          let filteredLogs = filterLogsBySeries([...allLogs], currentSelectedSeries);

          // 2. ìµœì¢…ìˆœ ì •ë ¬ (ê¸°ë³¸)
          filteredLogs.sort((a, b) => {
            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
            return timeB - timeA;
          });

          // 3. í…Œì´ë¸” ë Œë”ë§
          renderLogTable(filteredLogs);
        };

        // ===== ë‹¨ì› ì½”ë“œë¡œ í•™ìŠµ í˜ì´ì§€ ê²½ë¡œ ìƒì„± =====
        function getUnitPath(unitCode, series) {
          if (!unitCode) return null;

          // ì‹œë¦¬ì¦ˆë³„ í´ë” ë§¤í•‘ (BRAINí•, BRAINì˜¨, BRAINë”¥ ëª¨ë‘ BRAINUP í´ë” ì‚¬ìš©)
          const seriesFolders = {
            'BRAINì—…': 'BRAINUP',
            'BRAINì˜¨': 'BRAINUP',  // on_ íŒŒì¼ë“¤ë„ BRAINUP í´ë”ì— ìˆìŒ
            'BRAINí•': 'BRAINUP',
            'BRAINë”¥': 'BRAINUP',
            'BRAINì¤‘ë“±': 'BRAINMID',
            'BRAINê³ ë“±': 'BRAINHIGH'
          };

          // ê³¼ëª© ì½”ë“œ â†’ í´ë” ë§¤í•‘
          const subjectFolders = {
            'geo': 'social',
            'soc': 'social',
            'law': 'social',
            'pol': 'social',
            'bio': 'science',
            'chem': 'science',
            'physics': 'science',
            'earth': 'science',
            'classic': 'korlit',
            'modern': 'korlit',
            'world': 'worldlit',
            'world1': 'worldlit',
            'world2': 'worldlit',
            'people': 'person',
            'people1': 'person',
            'people2': 'person',
            'person1': 'person',
            'person2': 'person'
          };

          const parts = unitCode.split('_');
          console.log('ğŸ” getUnitPath - parts:', parts, 'series:', series);
          if (parts.length < 2) {
            console.log('âŒ parts.length < 2');
            return null;
          }

          // fit_ / deep_ / on_ ì ‘ë‘ì–´ ì²˜ë¦¬: fit_geo_13 â†’ subjectCode = 'geo', deep_bio_01 â†’ subjectCode = 'bio', on_bio_01 â†’ subjectCode = 'bio'
          let subjectCode = parts[0];
          if ((subjectCode === 'fit' || subjectCode === 'deep' || subjectCode === 'on') && parts.length >= 3) {
            subjectCode = parts[1];
          }
          console.log('ğŸ” getUnitPath - subjectCode:', subjectCode);

          const seriesFolder = seriesFolders[series] || 'BRAINUP';
          const subjectFolder = subjectFolders[subjectCode];
          console.log('ğŸ” getUnitPath - seriesFolder:', seriesFolder, 'subjectFolder:', subjectFolder);

          if (!subjectFolder) {
            console.log('âŒ subjectFolder not found for subjectCode:', subjectCode);
            return null;
          }

          // ê²½ë¡œ ìƒì„±: /BRAINUP/social/geo_01.html, /BRAINUP/social/fit_geo_01.html, /BRAINUP/science/deep_bio_01.html
          const finalPath = '/' + seriesFolder + '/' + subjectFolder + '/' + unitCode + '.html';
          console.log('âœ… getUnitPath - finalPath:', finalPath);
          return finalPath;
        }

        // ===== ë‹¨ì› í˜ì´ì§€ë¡œ ì´ë™ =====
        function goToUnit(unitCode, series) {
          const path = getUnitPath(unitCode, series);
          console.log('ğŸ” goToUnit í˜¸ì¶œ:', { unitCode, series, path });
          if (path) {
            window.open(path, '_blank');
          } else {
            alert('í•´ë‹¹ ë‹¨ì› í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\n\\nunitCode: ' + unitCode + '\\nseries: ' + series);
          }
        }

        // ===== í•™ìŠµ ê¸°ë¡ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ =====
        function renderLogTable(logs) {
          const tbody = document.getElementById('logTableBody');
          const toggleBtn = document.getElementById('toggleBtn');
          const logCountBadge = document.getElementById('logCountBadge');
          const normalLearningCount = document.getElementById('normalLearningCount');
          const aiLearningCount = document.getElementById('aiLearningCount');

          // ì¼ë°˜í•™ìŠµê³¼ AIì¶”ì²œí•™ìŠµ ê±´ìˆ˜ ê³„ì‚°
          let normalCount = 0;
          let aiCount = 0;

          logs.forEach(log => {
            // ì¼ë°˜í•™ìŠµ: LearningLogì— ê¸°ë¡ëœ ëª¨ë“  í•™ìŠµ
            normalCount++;

            // AIì¶”ì²œí•™ìŠµ: aiTaskAssignedAtì´ ìˆëŠ” ê²½ìš° (ê³¼ì œ ë¶€ì—¬ë¨)
            if (log.aiTaskAssignedAt) {
              aiCount++;
            }
          });

          // ë°°ì§€ ì—…ë°ì´íŠ¸
          const totalCount = normalCount;
          logCountBadge.textContent = \`ğŸ“š ì´ \${totalCount}ê±´ì˜ í•™ìŠµ ê¸°ë¡\`;
          normalLearningCount.textContent = \`ğŸ“– ì¼ë°˜í•™ìŠµ \${normalCount}ê±´\`;
          aiLearningCount.textContent = \`ğŸ¤– AIì¶”ì²œí•™ìŠµ \${aiCount}ê±´\`;

          // í…Œì´ë¸” ì´ˆê¸°í™”
          tbody.innerHTML = '';

          // ê³¼ëª© ë§¤í•‘ (world1/world2ëŠ” ì„¸ê³„ë¬¸í•™1/ì„¸ê³„ë¬¸í•™2, people1/people2ëŠ” í•œêµ­ì¸ë¬¼/ì„¸ê³„ì¸ë¬¼ë¡œ ë¶„ë¦¬)
          const subjectMap = { 'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™', 'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ', 'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™1', 'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'people': 'í•œêµ­ì¸ë¬¼', 'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼', 'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼' };

          logs.forEach((log, idx) => {
            // ê³¼ëª©ëª… ì¶”ì¶œ (unit ì½”ë“œì—ì„œ)
            let subjectName = '-';
            const unitCode = log.unit || '';
            if (unitCode && unitCode.includes('_')) {
              const parts = unitCode.split('_');
              // fit_/deep_/on_ ì ‘ë‘ì–´ ì²˜ë¦¬: fit_bio_01 â†’ ['fit', 'bio', '01'], deep_bio_01 â†’ ['deep', 'bio', '01'], on_bio_01 â†’ ['on', 'bio', '01']
              let subjectKey = parts[0];
              let numStr = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                subjectKey = parts[1];
                numStr = parts[2];
              }
              let number = numStr ? parseInt(numStr, 10) : 0;
              // world_41~80ì€ ì„¸ê³„ë¬¸í•™2
              if (subjectKey === 'world' && number > 40) {
                subjectName = 'ì„¸ê³„ë¬¸í•™2';
              } else {
                subjectName = subjectMap[subjectKey] || subjectKey;
              }
            }

            // í‰ê·  ì ìˆ˜ ê³„ì‚°
            const r = log.radar || {};
            const scores = [r.literal, r.structural, r.lexical, r.inferential, r.critical].filter(s => s != null);
            const avgScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;

            // ë“±ê¸‰ ê²°ì •
            let badgeClass = 'badge-normal';
            let badgeText = 'ë³´í†µ';
            if (avgScore >= 9) {
              badgeClass = 'badge-excellent';
              badgeText = 'ìš°ìˆ˜';
            } else if (avgScore >= 8) {
              badgeClass = 'badge-good';
              badgeText = 'ì–‘í˜¸';
            } else if (avgScore >= 7) {
              badgeClass = 'badge-normal';
              badgeText = 'ë³´í†µ';
            } else {
              badgeClass = 'badge-encourage';
              badgeText = 'ê²©ë ¤';
            }

            // ë‹¨ì› ì½”ë“œ â†’ ë‹¨ì›ëª… ë³€í™˜ (ì˜ˆ: world2_01 â†’ ì„¸ê³„ë¬¸í•™2 1, fit_bio_01 â†’ ìƒë¬¼ 1, deep_bio_01 â†’ ìƒë¬¼ 1)
            let unitName = log.unit || "";
            if (unitName && unitName.includes('_')) {
              const parts = unitName.split('_');
              // fit_/deep_/on_ ì ‘ë‘ì–´ ì²˜ë¦¬: fit_bio_01 â†’ ['fit', 'bio', '01'], deep_bio_01 â†’ ['deep', 'bio', '01'], on_bio_01 â†’ ['on', 'bio', '01']
              let subjectKey = parts[0];
              let numStr = parts[1];
              if ((parts[0] === 'fit' || parts[0] === 'deep' || parts[0] === 'on') && parts.length >= 3) {
                subjectKey = parts[1];
                numStr = parts[2];
              }
              const subject = subjectMap[subjectKey] || subjectKey;
              let number = numStr ? parseInt(numStr, 10) : 0;
              // world_41~80ì€ ì„¸ê³„ë¬¸í•™2ë¡œ í‘œì‹œ (world_41 â†’ ì„¸ê³„ë¬¸í•™2 1)
              if (subjectKey === 'world' && number > 40) {
                number = number - 40;
                unitName = 'ì„¸ê³„ë¬¸í•™2 ' + number;
              } else {
                unitName = subject + ' ' + number;
              }
            }

            const hiddenClass = idx >= 10 ? 'hidden-row' : '';

            // AIê³¼ì œë¶€ì—¬ ì˜ˆì • ì‹œê°„ ê³„ì‚° (í•™ìŠµ ì™„ë£Œ ì‹œê°„ + ë“±ê¸‰ë³„ ëŒ€ê¸° ì‹œê°„)
            // ìš°ìˆ˜: ë¶€ì—¬ ì•ˆ í•¨, ì–‘í˜¸: 14ì¼, ë³´í†µ: 7ì¼, ê²©ë ¤: 3ì¼
            let aiTaskTimestamp = '-';
            let aiTaskStyle = 'color: #999;';
            if (log.timestamp && avgScore < 9) { // ìš°ìˆ˜ ë“±ê¸‰ì´ ì•„ë‹Œ ê²½ìš°ë§Œ
              const completedAt = new Date(log.timestamp);
              let waitHours = 168; // ê¸°ë³¸: ë³´í†µ 7ì¼(168ì‹œê°„)
              if (avgScore >= 8) {
                waitHours = 336; // ì–‘í˜¸: 14ì¼(336ì‹œê°„)
              } else if (avgScore < 7) {
                waitHours = 72; // ê²©ë ¤: 3ì¼(72ì‹œê°„)
              }
              const scheduledAt = new Date(completedAt.getTime() + waitHours * 60 * 60 * 1000);
              aiTaskTimestamp = scheduledAt.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
              aiTaskStyle = 'color: #6b21a8; font-weight: 600;';
            }

            // ìµœì¢…ì™„ë£Œ ì‹œê°„ = í•™ìŠµ ì™„ë£Œ ì‹œì  (timestamp) - AIê³¼ì œë¶€ì—¬ì™€ ë¬´ê´€
            const finalTimestamp = log.timestamp ?
              new Date(log.timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }) : '-';
            const finalTimeStyle = 'color: #059669; font-weight: 600;';

            const unitCodeForClick = log.unit || '';
            // unit ì½”ë“œì—ì„œ ì‹œë¦¬ì¦ˆëª… ì¶”ì¶œ
            let seriesForClick = 'BRAINì—…';
            if (log.unit) {
              if (log.unit.includes('on_')) seriesForClick = 'BRAINì˜¨';
              else if (log.unit.includes('fit_')) seriesForClick = 'BRAINí•';
              else if (log.unit.includes('deep_')) seriesForClick = 'BRAINë”¥';
            }

            const row = document.createElement('tr');
            if (hiddenClass) row.className = hiddenClass;
            row.title = 'í´ë¦­í•˜ì—¬ ë‹¨ì›ìœ¼ë¡œ ì´ë™';
            row.style.cursor = 'pointer';
            row.onclick = (function(uc, sr) {
              return function() { goToUnit(uc, sr); };
            })(unitCodeForClick, seriesForClick);
            row.innerHTML = \`
              <td>\${idx + 1}</td>
              <td>\${subjectName}</td>
              <td style="\${aiTaskStyle}">\${aiTaskTimestamp}</td>
              <td style="\${finalTimeStyle}">\${finalTimestamp}</td>
              <td><span class="badge \${badgeClass}">\${badgeText}</span></td>
              <td>\${(function(unit) {
                if (!unit) return log.series || '';
                if (unit.includes('on_')) return 'BRAINì˜¨';
                if (unit.includes('fit_')) return 'BRAINí•';
                if (unit.includes('deep_')) return 'BRAINë”¥';
                return 'BRAINì—…';
              })(log.unit)}</td>
              <td class="unit-link">\${unitName}</td>
            \`;
            tbody.appendChild(row);
          });

          // ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
          if (logs.length > 10) {
            toggleBtn.style.display = 'inline-block';
            toggleBtn.textContent = 'ë”ë³´ê¸° â–¼';
          } else {
            toggleBtn.style.display = 'none';
          }
        }

        // ì‹œë¦¬ì¦ˆ ì„ íƒ
        document.querySelectorAll('.series-item').forEach(item => {
          item.addEventListener('click', function() {
            const series = this.dataset.series;
            currentSelectedSeries = series;

            // ë©”ë‰´ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.series-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('currentSeries').textContent = this.textContent;
            document.getElementById('seriesMenu').classList.remove('show');
            document.getElementById('seriesButton').classList.remove('active');

            // currentSeries ì—…ë°ì´íŠ¸ (ì°¨íŠ¸ í•¨ìˆ˜ë“¤ì´ ì‚¬ìš©)
            currentSeries = series;

            // ë°ì´í„° í•„í„°ë§ (unit prefix ê¸°ë°˜ìœ¼ë¡œ ì‹œë¦¬ì¦ˆ íŒë‹¨)
            const filteredLogs = filterLogsBySeries(allLogs, series);

            console.log('ì„ íƒëœ ì‹œë¦¬ì¦ˆ:', series, 'í•„í„°ë§ëœ ë¡œê·¸:', filteredLogs.length);

            // ì°¨íŠ¸, ì§„ë„ìœ¨ ë° í•™ìŠµ ê¸°ë¡ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            renderSeriesRadar(filteredLogs);
            renderFieldRadar(filteredLogs);
            renderSubjectRadar(filteredLogs);
            renderIndividualRadar(filteredLogs);
            calculateProgress(filteredLogs);
            renderLogTable(filteredLogs);

            // ë‚ ì§œë³„ ì°¨íŠ¸ ì¬ë Œë”ë§ (ì‹œë¦¬ì¦ˆ ë³€ê²½ ì‹œ)
            renderIndexTrendChart();
            renderSubjectBarChart();

            // ì°½ì˜í™œë™ í…Œì´ë¸” ì¬ë Œë”ë§ (ì‹œë¦¬ì¦ˆ ë³€ê²½ ì‹œ)
            renderCreativeTable();

            // ë°ì´í„° ìœ ë¬´ì— ë”°ë¼ ë‚ ì§œë³„ ì°¨íŠ¸ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            const indexTrendSection = document.getElementById('indexTrendSection');
            const subjectBarSection = document.getElementById('subjectBarSection');
            if (filteredLogs.length > 0) {
              if (indexTrendSection) indexTrendSection.style.display = 'block';
              if (subjectBarSection) subjectBarSection.style.display = 'block';
            } else {
              if (indexTrendSection) indexTrendSection.style.display = 'none';
              if (subjectBarSection) subjectBarSection.style.display = 'none';
            }

            // ë¶€ëª¨ ì°½(menu.html)ì— ì‹œë¦¬ì¦ˆ ë³€ê²½ ì•Œë¦¼ - ë±ƒì§€ ì—…ë°ì´íŠ¸ìš©
            // iframe ë‚´ë¶€ì—ì„œ ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜, ì§ì ‘ ì—´ë¦° ê²½ìš°ì—ë„ ë™ì‘í•˜ë„ë¡ try-catch ì‚¬ìš©
            try {
              // ì‹œë¦¬ì¦ˆë³„ ì´ ë‹¨ì› ìˆ˜
              const seriesTotals = {
                'BRAINì˜¨': 400,
                'BRAINì—…': 400,
                'BRAINí•': 400,
                'BRAINë”¥': 400,
                'BRAINì¤‘ë“±': 400,
                'BRAINê³ ë“±': 400
              };
              const totalUnits = series === 'all' ? 400 : (seriesTotals[series] || 400);

              // í‰ê·  ì ìˆ˜ ë° ì§„ë„ìœ¨ ê³„ì‚°
              const validLogs = filteredLogs.filter(log => log.radar);
              let avgScore = 0;
              if (validLogs.length > 0) {
                let totalLiteral = 0, totalStructural = 0, totalLexical = 0;
                let totalInferential = 0, totalCritical = 0;
                validLogs.forEach(log => {
                  totalLiteral += log.radar.literal || 0;
                  totalStructural += log.radar.structural || 0;
                  totalLexical += log.radar.lexical || 0;
                  totalInferential += log.radar.inferential || 0;
                  totalCritical += log.radar.critical || 0;
                });
                const count = validLogs.length;
                const scores = [
                  totalLiteral / count,
                  totalStructural / count,
                  totalLexical / count,
                  totalInferential / count,
                  totalCritical / count
                ];
                avgScore = parseFloat((scores.reduce((a, b) => a + b, 0) / 5).toFixed(1));
              }

              // ê³ ìœ  ë‹¨ì› ìˆ˜ ê³„ì‚°
              const completedUnits = new Set();
              filteredLogs.forEach(log => {
                if (log.unit) completedUnits.add(log.unit);
              });
              const progressPercent = Math.round((completedUnits.size / totalUnits) * 100);

              // ë¶€ëª¨ ì°½ì— ë©”ì‹œì§€ ì „ì†¡ (iframe ë‚´ë¶€ì¸ ê²½ìš°)
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                  type: 'seriesChanged',
                  series: series,
                  avgScore: avgScore,
                  progressPercent: progressPercent,
                  completedCount: completedUnits.size,
                  totalUnits: totalUnits
                }, '*');
                console.log('ğŸ“¤ ë¶€ëª¨ ì°½ì— ì‹œë¦¬ì¦ˆ ë³€ê²½ ì•Œë¦¼:', series, avgScore, progressPercent + '%');
              } else {
                console.log('ğŸ“¤ ì§ì ‘ ì—´ë¦° í˜ì´ì§€ - postMessage ê±´ë„ˆëœ€');
              }

              // localStorageì—ë„ ì €ì¥ (ëª¨ë‹¬ ë‹«ì„ ë•Œ ë³µì›ìš©)
              localStorage.setItem('selectedSeriesBadge', JSON.stringify({
                series: series,
                avgScore: avgScore,
                progressPercent: progressPercent
              }));

              // ì‹œë¦¬ì¦ˆ ë³€ê²½ ì‹œ URL íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ í›„ ìƒˆë¡œê³ ì¹¨
              const seriesParamMap = {
                'BRAINì—…': 'up',
                'BRAINì˜¨': 'on',
                'BRAINí•': 'fit',
                'BRAINë”¥': 'deep'
              };
              const newSeriesParam = seriesParamMap[series];
              if (newSeriesParam) {
                const url = new URL(window.location.href);
                const currentSeriesParam = url.searchParams.get('series');
                if (currentSeriesParam !== newSeriesParam) {
                  url.searchParams.set('series', newSeriesParam);
                  console.log('ğŸ”„ ì‹œë¦¬ì¦ˆ ë³€ê²½ìœ¼ë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨:', series, '->', newSeriesParam);
                  window.location.href = url.toString();
                }
              }
            } catch (e) {
              console.log('postMessage ì˜¤ë¥˜:', e);
            }
          });
        });

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', function(e) {
          const selector = document.querySelector('.series-selector');
          if (!selector.contains(e.target)) {
            document.getElementById('seriesMenu').classList.remove('show');
            document.getElementById('seriesButton').classList.remove('active');
          }
        });

        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        window.addEventListener('load', function() {
          console.log('ğŸ“š í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
          console.log('ğŸ“š html2canvas:', typeof html2canvas);
          console.log('ğŸ“š jsPDF:', typeof window.jspdf);

          // âœ… URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ ì‹œë¦¬ì¦ˆê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
          let defaultSeries = currentSelectedSeries; // ì´ë¯¸ URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¤ì •ë¨

          // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ í•™ìŠµí•œ ì‹œë¦¬ì¦ˆ ì°¾ê¸°
          if (defaultSeries === 'all' && logsForChart.length > 0) {
            // ê°€ì¥ ìµœê·¼ ë¡œê·¸ì˜ ì‹œë¦¬ì¦ˆ (ì´ë¯¸ timestamp ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ë˜ì–´ ìˆìŒ)
            const recentSeries = logsForChart[0].series;
            if (recentSeries) {
              defaultSeries = recentSeries;
              currentSelectedSeries = recentSeries;
            }
          }

          // UI ì—…ë°ì´íŠ¸ (URL íŒŒë¼ë¯¸í„° ë˜ëŠ” ìµœê·¼ ì‹œë¦¬ì¦ˆ)
          if (defaultSeries !== 'all') {
            document.querySelectorAll('.series-item').forEach(item => {
              if (item.dataset.series === defaultSeries) {
                item.classList.add('active');
                document.getElementById('currentSeries').textContent = item.textContent;
              } else {
                item.classList.remove('active');
              }
            });
            console.log('ğŸ“Š ì´ˆê¸° ì‹œë¦¬ì¦ˆ ì„¤ì •:', defaultSeries);
          }

          // ì„ íƒëœ ì‹œë¦¬ì¦ˆì— ë§ê²Œ í•„í„°ë§ (unit prefix ê¸°ë°˜)
          const initialLogs = filterLogsBySeries(logsForChart, defaultSeries);

          // ë ˆì´ë” ì°¨íŠ¸ ë Œë”ë§
          renderSeriesRadar(initialLogs);
          renderFieldRadar(initialLogs);
          renderSubjectRadar(initialLogs);
          renderIndividualRadar(initialLogs);

          // ì§„ë„ìœ¨ ê³„ì‚° ë° í‘œì‹œ
          calculateProgress(initialLogs);

          // í•™ìŠµ ê¸°ë¡ í…Œì´ë¸” ë Œë”ë§ (ê¸°ë³¸ê°’: ìµœì¢… ì‹œê°„ ê¸°ì¤€ ì •ë ¬)
          const sortedInitialLogs = sortLogs(initialLogs, 'final');
          renderLogTable(sortedInitialLogs);

          // ë°ì´í„° ìœ ë¬´ì— ë”°ë¼ ë‚ ì§œë³„ ì°¨íŠ¸ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ (ì´ˆê¸° ë¡œë“œ)
          const indexTrendSection = document.getElementById('indexTrendSection');
          const subjectBarSection = document.getElementById('subjectBarSection');
          if (initialLogs.length > 0) {
            if (indexTrendSection) indexTrendSection.style.display = 'block';
            if (subjectBarSection) subjectBarSection.style.display = 'block';
          } else {
            if (indexTrendSection) indexTrendSection.style.display = 'none';
            if (subjectBarSection) subjectBarSection.style.display = 'none';
          }
        });

        // ===== ì§„ë„ìœ¨ ê³„ì‚° í•¨ìˆ˜ =====
        function calculateProgress(logs) {
          // ê³¼ëª© ì½”ë“œ ë§¤í•‘
          const subjectMapping = {
            bio: 'science',
            earth: 'science',
            physics: 'science',
            chem: 'science',
            soc: 'society',
            geo: 'society',
            law: 'society',
            pol: 'society',
            modern: 'korean-lit',
            classic: 'korean-lit',
            world: 'world-lit',  // world_01 ~ world_80
            world1: 'world-lit',
            world2: 'world-lit',
            people: 'person',  // people_01 ~ people_80
            people1: 'person',  // people1_01 ~ people1_40 (í•œêµ­ì¸ë¬¼)
            people2: 'person',  // people2_01 ~ people2_40 (ì„¸ê³„ì¸ë¬¼)
            person1: 'person',
            person2: 'person'
          };

          // ì§„ë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
          const progress = {
            total: 0,
            science: { total: 0, bio: 0, earth: 0, physics: 0, chem: 0 },
            society: { total: 0, soc: 0, geo: 0, law: 0, pol: 0 },
            'korean-lit': { total: 0, modern: 0, classic: 0 },
            'world-lit': { total: 0, world1: 0, world2: 0 },
            person: { total: 0, person1: 0, person2: 0 }
          };

          // ì™„ë£Œëœ ë‹¨ì› ì§‘í•© (ì¤‘ë³µ ì œê±° - ì •ê·œí™”ëœ ì½”ë“œ ì‚¬ìš©)
          const completedUnits = new Set();

          // ë‹¨ì› ì½”ë“œ ì •ê·œí™” í•¨ìˆ˜ (ì§„ë„ìœ¨ìš©)
          function normalizeForProgress(unit) {
            // fit_ ì ‘ë‘ì–´ ì œê±°: fit_bio_01 -> bio_01
            if (unit.startsWith('fit_')) {
              unit = unit.substring(4); // 'fit_' ì œê±°
            }
            // deep_ ì ‘ë‘ì–´ ì œê±°: deep_bio_01 -> bio_01
            if (unit.startsWith('deep_')) {
              unit = unit.substring(5); // 'deep_' ì œê±°
            }
            // on_ ì ‘ë‘ì–´ ì œê±°: on_bio_01 -> bio_01
            if (unit.startsWith('on_')) {
              unit = unit.substring(3); // 'on_' ì œê±°
            }
            // world_41~80 -> world2_01~40
            if (unit.startsWith('world_')) {
              const numMatch = unit.match(/world_([0-9]+)$/);
              if (numMatch) {
                const num = parseInt(numMatch[1]);
                if (num >= 41 && num <= 80) {
                  return 'world2_' + String(num - 40).padStart(2, '0');
                } else if (num >= 1 && num <= 40) {
                  return 'world1_' + String(num).padStart(2, '0');
                }
              }
            }
            // people_41~80 -> people2_01~40
            if (unit.startsWith('people_')) {
              const numMatch = unit.match(/people_([0-9]+)$/);
              if (numMatch) {
                const num = parseInt(numMatch[1]);
                if (num >= 41 && num <= 80) {
                  return 'people2_' + String(num - 40).padStart(2, '0');
                } else if (num >= 1 && num <= 40) {
                  return 'people1_' + String(num).padStart(2, '0');
                }
              }
            }
            return unit;
          }

          logs.forEach(log => {
            const unit = log.unit;
            if (!unit) return;

            // ì •ê·œí™”ëœ ë‹¨ì› ì½”ë“œë¡œ ì¤‘ë³µ ì²´í¬
            const normalizedUnit = normalizeForProgress(unit);
            if (completedUnits.has(normalizedUnit)) return;

            completedUnits.add(normalizedUnit);
            progress.total++;

            // ì •ê·œí™”ëœ ì½”ë“œì—ì„œ ê³¼ëª© ì½”ë“œ ì¶”ì¶œ (ì˜ˆ: "bio_01" -> "bio", "world2_01" -> "world2")
            const subjectCode = normalizedUnit.match(/^[a-z]+[0-9]*/)?.[0];
            if (!subjectCode) return;

            const field = subjectMapping[subjectCode];
            if (field && progress[field]) {
              progress[field].total++;

              // world1, world2ëŠ” ì§ì ‘ ì²˜ë¦¬
              if (subjectCode === 'world1' || subjectCode === 'world2') {
                if (progress[field][subjectCode] !== undefined) {
                  progress[field][subjectCode]++;
                }
              } else if (subjectCode === 'people1') {
                // people1_XX -> person1ë¡œ ì²˜ë¦¬ (í•œêµ­ì¸ë¬¼)
                if (progress[field].person1 !== undefined) {
                  progress[field].person1++;
                }
              } else if (subjectCode === 'people2') {
                // people2_XX -> person2ë¡œ ì²˜ë¦¬ (ì„¸ê³„ì¸ë¬¼)
                if (progress[field].person2 !== undefined) {
                  progress[field].person2++;
                }
              } else if (subjectCode === 'person1') {
                // person1_XX í˜•íƒœ ì§ì ‘ ì²˜ë¦¬
                if (progress[field][subjectCode] !== undefined) {
                  progress[field][subjectCode]++;
                }
              } else if (subjectCode === 'person2') {
                // person2_XX í˜•íƒœ ì§ì ‘ ì²˜ë¦¬
                if (progress[field][subjectCode] !== undefined) {
                  progress[field][subjectCode]++;
                }
              } else if (progress[field][subjectCode] !== undefined) {
                progress[field][subjectCode]++;
              }
            }
          });

          // ì§„ë„ìœ¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
          function updateProgress(barId, textId, completed, total) {
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            const bar = document.getElementById(barId);
            const text = document.getElementById(textId);

            if (bar) {
              bar.style.width = percent + '%';
              if (barId.includes('total')) {
                bar.querySelector('span').textContent = percent + '%';
              }
            }
            if (text) {
              text.textContent = completed + ' / ' + total;
            }
            return percent;
          }

          function updateSubjectProgress(barId, percentId, completed, total) {
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            const bar = document.getElementById(barId);
            const percentEl = document.getElementById(percentId);

            if (bar) {
              bar.style.width = percent + '%';
            }
            if (percentEl) {
              percentEl.textContent = percent + '%';
            }
          }

          // ì „ì²´ ì‹œë¦¬ì¦ˆ ì§„ë„ìœ¨
          const totalPercent = updateProgress('totalProgressBar', 'totalProgressTextCount', progress.total, 400);
          const totalPercentEl = document.getElementById('totalProgressTextPercent');
          if (totalPercentEl) {
            totalPercentEl.textContent = '(' + totalPercent + '%)';
          }

          // ê³¼í•™ë¶„ì•¼
          const sciencePercent = updateProgress('scienceFieldBar', 'scienceFieldText', progress.science.total, 80);
          document.getElementById('scienceFieldPercent').textContent = sciencePercent + '%';
          updateSubjectProgress('bioBar', 'bioPercent', progress.science.bio, 20);
          updateSubjectProgress('earthBar', 'earthPercent', progress.science.earth, 20);
          updateSubjectProgress('physicsBar', 'physicsPercent', progress.science.physics, 20);
          updateSubjectProgress('chemBar', 'chemPercent', progress.science.chem, 20);

          // ì‚¬íšŒë¶„ì•¼
          const societyPercent = updateProgress('societyFieldBar', 'societyFieldText', progress.society.total, 80);
          document.getElementById('societyFieldPercent').textContent = societyPercent + '%';
          updateSubjectProgress('socBar', 'socPercent', progress.society.soc, 20);
          updateSubjectProgress('geoBar', 'geoPercent', progress.society.geo, 20);
          updateSubjectProgress('lawBar', 'lawPercent', progress.society.law, 20);
          updateSubjectProgress('polBar', 'polPercent', progress.society.pol, 20);

          // í•œêµ­ë¬¸í•™
          const koreanLitPercent = updateProgress('koreanLitFieldBar', 'koreanLitFieldText', progress['korean-lit'].total, 80);
          document.getElementById('koreanLitFieldPercent').textContent = koreanLitPercent + '%';
          updateSubjectProgress('modernBar', 'modernPercent', progress['korean-lit'].modern, 40);
          updateSubjectProgress('classicBar', 'classicPercent', progress['korean-lit'].classic, 40);

          // ì„¸ê³„ë¬¸í•™ (ê° 40ê°œì”©, ì´ 80ê°œ)
          const worldLitPercent = updateProgress('worldLitFieldBar', 'worldLitFieldText', progress['world-lit'].total, 80);
          document.getElementById('worldLitFieldPercent').textContent = worldLitPercent + '%';
          updateSubjectProgress('world1Bar', 'world1Percent', progress['world-lit'].world1, 40);
          updateSubjectProgress('world2Bar', 'world2Percent', progress['world-lit'].world2, 40);

          // ì¸ë¬¼ë¶„ì•¼ (ê° 40ê°œì”©, ì´ 80ê°œ)
          const personPercent = updateProgress('personFieldBar', 'personFieldText', progress.person.total, 80);
          document.getElementById('personFieldPercent').textContent = personPercent + '%';
          updateSubjectProgress('person1Bar', 'person1Percent', progress.person.person1, 40);
          updateSubjectProgress('person2Bar', 'person2Percent', progress.person.person2, 40);

          console.log('ì§„ë„ìœ¨ ê³„ì‚° ì™„ë£Œ:', progress);
        }

        // ===== ë±ƒì§€ ë°ì´í„°ëŠ” menu.htmlì—ì„œ ì‹¤ì‹œê°„ ê³„ì‚° =====
        // DB ì €ì¥ ë¡œì§ ì œê±°: í•­ìƒ ìµœì‹  í•™ìŠµ ê¸°ë¡ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°

        // ğŸ”„ ë¡œë”© ìŠ¤í”¼ë„ˆ ì œì–´
        window.addEventListener('load', function() {
          const loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
            }, 500);
          }
        });
      </script>

    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /my-learning ì—ëŸ¬:", err);
    res.status(500).send("í•™ìŠµ ì´ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ===== íœ´ì§€í†µ íšŒì› ëª©ë¡ (ìŠˆí¼ê´€ë¦¬ì ì „ìš©) =====
// ===== íœ´ì§€í†µ íšŒì› ëª©ë¡ (ìŠˆí¼ê´€ë¦¬ì + ë¸Œëœì¹˜ ê³µìš©) =====
app.get("/admin/trash", async (req, res) => {
  const { key, view } = req.query;   // âœ… view ì¶”ê°€

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }

  try {
    const users = await User.find({ deleted: true })
      .sort({ deletedAt: -1 })
      .lean();

    // âœ… ì–´ë””ë¡œ ëŒì•„ê°ˆì§€ ê²°ì • (ë¸Œëœì¹˜ì—ì„œ ì˜¨ ê²½ìš° /admin/branch/users)
    const backHref =
      view === "branch"
        ? "/admin/branch/users"
        : `/admin/users?key=${encodeURIComponent(key)}`;

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>íœ´ì§€í†µ íšŒì› ëª©ë¡</title>
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; padding: 20px; }
        h1 { margin-bottom: 8px; }
        .small { font-size: 12px; color: #666; margin-bottom: 16px; }
        table { border-collapse: collapse; width: 100%; max-width: 960px; }
        th, td { border: 1px solid #ddd; padding: 8px 10px; font-size: 14px; }
        th { background: #f5f2eb; text-align: left; }
        tr:nth-child(even) { background: #faf7f0; }
        a.btn-restore { color: #1565c0; text-decoration: none; font-size: 12px; }
        a.btn-restore:hover { text-decoration: underline; }
        a.btn-delete { color: #b00020; text-decoration: none; font-size: 12px; }
        a.btn-delete:hover { text-decoration: underline; }
      </style>
    </head>
    <body>
      <h1>íœ´ì§€í†µ (${users.length}ëª…)</h1>
      <p class="small">
        <a href="${backHref}">â† íšŒì› ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </p>
      <p class="small">
        â€» íœ´ì§€ ìƒíƒœ íšŒì›ì€ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•„ìš”í•  ë•Œë§Œ <b>ë³µêµ¬</b> ë˜ëŠ” <b>ì™„ì „ ì‚­ì œ</b>ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
      </p>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>í•™ë…„</th>
            <th>í•™êµëª…</th>
            <th>ì´ë¦„</th>
            <th>í•™ë…„ë°˜ë²ˆí˜¸(ID)</th>
            <th>íœ´ì§€ë¡œ ë³´ë‚¸ ì‹œê°</th>
            <th>ë³µêµ¬</th>
            <th>ì™„ì „ ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody>
    `;

    users.forEach((u, idx) => {
      const idOrPhone = u.id || u.phone || "";
      const deletedAt = u.deletedAt
        ? new Date(u.deletedAt).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          })
        : "-";

      // âœ… ë¸Œëœì¹˜ì—ì„œ ì˜¨ ê²½ìš° view=branch ë¥¼ ê³„ì† ë¶™ì—¬ì¤€ë‹¤
      const viewQuery = view ? `&view=${encodeURIComponent(view)}` : "";

      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${u.grade || ""}</td>
          <td>${u.school || ""}</td>
          <td>${u.name || ""}</td>
          <td>${idOrPhone}</td>
          <td>${deletedAt}</td>
          <td>
            <a class="btn-restore"
               href="/admin/trash-restore?id=${encodeURIComponent(
                 idOrPhone
               )}&key=${encodeURIComponent(key)}${viewQuery}">
              ë³µêµ¬
            </a>
          </td>
          <td>
            <a class="btn-delete"
               href="/admin/trash-delete?id=${encodeURIComponent(
                 idOrPhone
               )}&key=${encodeURIComponent(
        key
      )}${viewQuery}"
               onclick="return confirm('ì •ë§ ì™„ì „ ì‚­ì œí• ê¹Œìš”? [${u.name} / ${idOrPhone}]\\në³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
              ì™„ì „ ì‚­ì œ
            </a>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("âŒ /admin/trash ì—ëŸ¬:", err);
    res.status(500).send("íœ´ì§€í†µ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
});


// ===== íœ´ì§€í†µ íšŒì› ë³µêµ¬ =====
// ===== íœ´ì§€í†µ íšŒì› ë³µêµ¬ =====
app.get("/admin/trash-restore", async (req, res) => {
  const { id: rawId, key, view } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }
  if (!rawId) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  const id = String(rawId).trim();

  try {
    const user = await User.findOne({
      $or: [{ id }, { phone: id }],
      deleted: true,
    });

    if (!user) {
      return res.status(404).send("íœ´ì§€í†µì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    }

    user.deleted = false;
    user.deletedAt = null;
    await user.save();

    console.log("âœ… íœ´ì§€ ë³µêµ¬ ì™„ë£Œ:", user.name, user.id || user.phone);

    const viewQuery = view ? `&view=${encodeURIComponent(view)}` : "";
    res.redirect(`/admin/trash?key=${encodeURIComponent(key)}${viewQuery}`);
  } catch (err) {
    console.error("âŒ /admin/trash-restore ì—ëŸ¬:", err);
    res.status(500).send("íœ´ì§€ ë³µêµ¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
});


// ===== íœ´ì§€í†µ íšŒì› ì™„ì „ ì‚­ì œ =====
// ===== íœ´ì§€í†µ íšŒì› ì™„ì „ ì‚­ì œ =====
app.get("/admin/trash-delete", async (req, res) => {
  const { id: rawId, key, view } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨ (key ë¶ˆì¼ì¹˜)");
  }
  if (!rawId) return res.status(400).send("id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  const id = String(rawId).trim();

  try {
    const user = await User.findOne({
      $or: [{ id }, { phone: id }],
      deleted: true,
    });

    if (!user) {
      return res.status(404).send("íœ´ì§€í†µì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    }

    await User.deleteOne({ _id: user._id });

    console.log("ğŸ—‘ ì™„ì „ ì‚­ì œ ì™„ë£Œ:", user.name, user.id || user.phone);

    const viewQuery = view ? `&view=${encodeURIComponent(view)}` : "";
    res.redirect(`/admin/trash?key=${encodeURIComponent(key)}${viewQuery}`);
  } catch (err) {
    console.error("âŒ /admin/trash-delete ì—ëŸ¬:", err);
    res.status(500).send("ì™„ì „ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
});


// âœ… ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (AJAXìš© - í•™ìƒ/ê´€ë¦¬ì ê³µí†µ ì„¸ì…˜ ì‚­ì œ)
app.post("/logout", (req, res) => {
  console.log("ğŸ“¤ [POST] /logout í˜¸ì¶œ");

  if (!req.session) {
    return res.json({ ok: true });
  }

  req.session.destroy((err) => {
    if (err) {
      console.error("âŒ ì„¸ì…˜ ì‚­ì œ ì˜¤ë¥˜:", err);
      return res.status(500).json({ ok: false, message: "ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨" });
    }

    res.clearCookie("connect.sid");
    return res.json({ ok: true });
  });
});

// âœ… í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬ (lastLogin ê¸°ë¡ + íœ´ì§€/ìŠ¹ì¸ ìƒíƒœ ì²´í¬)
// âœ… í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬
app.post("/login", async (req, res) => {
  try {
    const { grade, name, phone } = req.body;
    const cleanPhone = String(phone || "").trim();

    console.log("ğŸ“¥ [POST] /login:", grade, name, cleanPhone);

    // í•„ìˆ˜ê°’ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹¤íŒ¨
    if (!grade || !name || !cleanPhone) {
      return res.redirect("/?loginError=1");
    }

    // âœ… ê¸°ì¡´/ì‹ ê·œ ëª¨ë‘ ì»¤ë²„:
    //  - pw = ì „í™”ë²ˆí˜¸
    //  - phone = ì „í™”ë²ˆí˜¸
    //  - id   = ì „í™”ë²ˆí˜¸ (ì˜› êµ¬ì¡°)
    const user = await User.findOne({
      grade,
      name,
      deleted: { $ne: true },
      $or: [
        { pw: cleanPhone },
        { phone: cleanPhone },
        { id: cleanPhone },
      ],
    });

    if (!user) {
      console.log("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: í•´ë‹¹ í•™ìƒ ì—†ìŒ");
      return res.redirect("/?loginError=1");
    }

    // ğŸ”¹ ì§€ì  í†µì§¸ë¡œ íœ´ì§€(ë¸Œëœì¹˜ ì‚­ì œ)ëœ ê²½ìš°
    if (user.branchDeleted) {
      console.log("ğŸš« ë¸Œëœì¹˜ íœ´ì§€ ìƒíƒœ ê³„ì •:", user.name);
      return res.redirect("/?loginError=trashed");
    }

    // ğŸ”¹ ê°œì¸ ê³„ì • íœ´ì§€ ìƒíƒœ
    if (user.deleted) {
      console.log("ğŸš« íœ´ì§€ ìƒíƒœ ê³„ì •:", user.name);
      return res.redirect("/?loginError=trashed");
    }

    // ğŸ”¹ ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœ(pending)ë©´ ì „ìš© íŒì—…
    if (user.status && user.status !== "approved") {
      console.log("â³ ìŠ¹ì¸ ëŒ€ê¸° ê³„ì •:", user.name);
      return res.redirect("/?loginError=pending");
    }

    // âœ… ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ ì •ìƒ ë¡œê·¸ì¸
req.session.user = {
  _id: user._id,
  name: user.name,
  grade: user.grade,
  school: user.school || user.academyName || "",
  role: "student",
  assignedSeries: user.assignedSeries || [],
};

await User.updateOne(
  { _id: user._id },
  { $set: { lastLogin: new Date() } }
);

// â— ì‹¤ì œë¡œ ë“¤ì–´ê°ˆ ë©”ì¸/ëª©ì°¨ í˜ì´ì§€ ê²½ë¡œ
const NEXT_URL = "/menu.html"; 
// ë§Œì•½ ë„¤ê°€ ë°”ë¡œ geo_01ë¡œ ë³´ë‚´ê³  ì‹¶ìœ¼ë©´ "/geo_01.html" ì²˜ëŸ¼ ìˆ˜ì •

// ğŸ”¥ ë¡œë”© í˜ì´ì§€ë¡œ ë¨¼ì € ì´ë™ â†’ ë¡œë”©ì´ ëë‚˜ë©´ JSê°€ NEXT_URLë¡œ ë³´ë‚´ì¤Œ
return res.redirect(
  "/loading.html?to=" + encodeURIComponent(NEXT_URL)
);


    console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ:", user.name, user.grade, user.school);

    // ğŸ”¥ ì—¬ê¸°ë¥¼ ë„¤ ëª©ì°¨(ë©”ì¸) í˜ì´ì§€ ê²½ë¡œë¡œ!
    return res.redirect("/menu.html");
    // ì˜ˆ) return res.redirect("/brain-main.html");
  } catch (err) {
    console.error("âŒ /login ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
    return res.redirect("/?loginError=1");
  }
});

// âœ… ì„¸ì…˜ ì •ë³´ ì¡°íšŒ API (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©)
app.get("/api/session", (req, res) => {
  if (req.session && req.session.user) {
    return res.json({ ok: true, user: req.session.user });
  } else {
    return res.json({ ok: false, user: null });
  }
});

// ============================================
// ğŸ“º ì¤Œ ìˆ˜ì—… ë§í¬ API
// ============================================
let currentZoomLink = ''; // ë©”ëª¨ë¦¬ì— ì €ì¥ (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”)

// ì¤Œ ë§í¬ ì¡°íšŒ
app.get('/api/zoom-link', (req, res) => {
  res.json({ success: true, zoomLink: currentZoomLink });
});

// ì¤Œ ë§í¬ ì €ì¥
app.post('/api/zoom-link', (req, res) => {
  const { zoomLink } = req.body;
  if (!zoomLink) {
    return res.json({ success: false, message: 'ì¤Œ ë§í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
  }
  currentZoomLink = zoomLink;
  res.json({ success: true, message: 'ì¤Œ ë§í¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' });
});

// âœ… ë§ì¶¤ë²• ê²€ì‚¬ API
app.post("/api/spell-check", async (req, res) => {
  console.log("âœ… [POST] /api/spell-check í˜¸ì¶œ");

  const { text } = req.body;

  if (!text || text.trim().length === 0) {
    return res.status(400).json({ error: "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
  }

  try {
    const OpenAI = require('openai');
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });

    console.log("ğŸ¤– OpenAI APIë¡œ ë§ì¶¤ë²• ê²€ì‚¬ ì‹œì‘...");

    // OpenAI API í˜¸ì¶œ
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: "ë‹¹ì‹ ì€ í•œêµ­ì–´ ë§ì¶¤ë²• ë° ë„ì–´ì“°ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ì˜ ë§ì¶¤ë²•ê³¼ ë„ì–´ì“°ê¸° ì˜¤ë¥˜ë¥¼ ì°¾ì•„ ìˆ˜ì •í•´ì£¼ì„¸ìš”."
        },
        {
          role: "user",
          content: `ë‹¤ìŒ í…ìŠ¤íŠ¸ì˜ ë§ì¶¤ë²•ê³¼ ë„ì–´ì“°ê¸° ì˜¤ë¥˜ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”. ì˜¤ë¥˜ê°€ ìˆë‹¤ë©´ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ê³ , ì—†ë‹¤ë©´ "ì˜¤ë¥˜ ì—†ìŒ"ì´ë¼ê³ ë§Œ ë‹µí•´ì£¼ì„¸ìš”.

í…ìŠ¤íŠ¸: "${text}"

JSON í˜•ì‹:
{
  "has_errors": true,
  "errors": [
    {"wrong": "ì˜ëª»ëœë¶€ë¶„", "correct": "ì˜¬ë°”ë¥¸ë¶€ë¶„", "type": "ë„ì–´ì“°ê¸°" or "ë§ì¶¤ë²•"}
  ],
  "corrected_text": "ì „ì²´ ìˆ˜ì •ëœ í…ìŠ¤íŠ¸"
}`
        }
      ],
      temperature: 0.3,
      max_tokens: 2000
    });

    const aiResponse = response.choices[0].message.content;
    console.log("ğŸ¤– OpenAI ì‘ë‹µ:", aiResponse.substring(0, 200));

    // "ì˜¤ë¥˜ ì—†ìŒ" ì‘ë‹µ ì²˜ë¦¬
    if (aiResponse.includes("ì˜¤ë¥˜ ì—†ìŒ") || aiResponse.includes("ì˜¤ë¥˜ê°€ ì—†")) {
      console.log("âœ… ë§ì¶¤ë²• ê²€ì‚¬ ì™„ë£Œ: ì˜¤ë¥˜ ì—†ìŒ");
      return res.json({
        errata_count: 0,
        origin_html: text,
        html: text,
        notag_html: text
      });
    }

    // JSON ì‘ë‹µ íŒŒì‹±
    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const result = JSON.parse(jsonMatch[0]);

      if (result.has_errors && result.errors && result.errors.length > 0) {
        let htmlText = text;
        let correctedHtml = result.corrected_text || text;

        // ì˜¤ë¥˜ ë¶€ë¶„ì— ë¹¨ê°„ ë°‘ì¤„ ì¶”ê°€
        result.errors.forEach(error => {
          const wrongText = error.wrong;
          htmlText = htmlText.replace(
            new RegExp(wrongText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
            `<span class="highlight-wrong">${wrongText}</span>`
          );

          // ìˆ˜ì •ëœ í…ìŠ¤íŠ¸ì— ë…¹ìƒ‰ í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
          const correctText = error.correct;
          correctedHtml = correctedHtml.replace(
            new RegExp(correctText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
            `<span class="highlight-correct">${correctText}</span>`
          );
        });

        console.log(`âœ… ë§ì¶¤ë²• ê²€ì‚¬ ì™„ë£Œ: ${result.errors.length}ê°œ ì˜¤ë¥˜ ë°œê²¬`);

        return res.json({
          errata_count: result.errors.length,
          origin_html: text,
          html: htmlText,
          notag_html: result.corrected_text || text,
          corrected_html: correctedHtml,
          errors: result.errors
        });
      }
    }

    // JSON íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ì˜¤ë¥˜ ì—†ìŒ
    console.log("âœ… ë§ì¶¤ë²• ê²€ì‚¬ ì™„ë£Œ: ì˜¤ë¥˜ ì—†ìŒ");
    res.json({
      errata_count: 0,
      origin_html: text,
      html: text,
      notag_html: text
    });

  } catch (err) {
    console.error("âŒ /api/spell-check ì—ëŸ¬:", err.message);
    // ì—ëŸ¬ ì‹œì—ë„ ì›ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜
    res.json({
      errata_count: 0,
      origin_html: text,
      html: text,
      notag_html: text
    });
  }
});

// âœ… AI ê¸€ ë‹¤ë“¬ê¸° API (ë§ì¶¤ë²• + ë¬¸ì¥ ê°œì„ )
app.post("/api/polish-writing", async (req, res) => {
  console.log("âœ… [POST] /api/polish-writing í˜¸ì¶œ");

  const { text } = req.body;

  if (!text || text.trim().length === 0) {
    return res.status(400).json({ error: "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
  }

  try {
    const OpenAI = require('openai');
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });

    console.log("ğŸ¤– OpenAI APIë¡œ ê¸€ ë‹¤ë“¬ê¸° ì‹œì‘...");

    // OpenAI API í˜¸ì¶œ
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒ~ì¤‘í•™ìƒì˜ ê¸€ì“°ê¸°ë¥¼ ë„ì™€ì£¼ëŠ” ì¹œì ˆí•œ AI ì„ ìƒë‹˜ì…ë‹ˆë‹¤.
í•™ìƒì´ ì‘ì„±í•œ ê¸€ì„ ë‹¤ë“¬ì–´ì£¼ì„¸ìš”. ë‹¤ìŒ ì‚¬í•­ì„ ì§€ì¼œì£¼ì„¸ìš”:

1. ë§ì¶¤ë²•ê³¼ ë„ì–´ì“°ê¸° ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤
2. ë¬¸ì¥ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì½íˆë„ë¡ ê°œì„ í•©ë‹ˆë‹¤
3. í•™ìƒì˜ ì›ë˜ ì˜ë„ì™€ í‘œí˜„ì„ ìµœëŒ€í•œ ì‚´ë¦½ë‹ˆë‹¤
4. ë„ˆë¬´ ì–´ë ¤ìš´ ë‹¨ì–´ëŠ” í”¼í•˜ê³  í•™ìƒ ìˆ˜ì¤€ì— ë§ê²Œ ìœ ì§€í•©ë‹ˆë‹¤
5. ê¸€ì˜ êµ¬ì¡°ê°€ ë…¼ë¦¬ì ìœ¼ë¡œ íë¥´ë„ë¡ ê°œì„ í•©ë‹ˆë‹¤

ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "polished_text": "ë‹¤ë“¬ì–´ì§„ ê¸€ (ì „ì²´ í…ìŠ¤íŠ¸)",
  "changes": [
    {"before": "ì›ë˜ í‘œí˜„", "after": "ìˆ˜ì •ëœ í‘œí˜„", "reason": "ìˆ˜ì • ì´ìœ "}
  ],
  "feedback": "ì „ì²´ì ì¸ í”¼ë“œë°± (ì¹­ì°¬ê³¼ ê°œì„ ì  í¬í•¨, 2-3ë¬¸ì¥)"
}`
        },
        {
          role: "user",
          content: `ë‹¤ìŒ ê¸€ì„ ë‹¤ë“¬ì–´ì£¼ì„¸ìš”:\n\n"${text}"`
        }
      ],
      temperature: 0.7,
      max_tokens: 2000
    });

    const aiResponse = response.choices[0].message.content.trim();
    console.log("ğŸ¤– AI ì‘ë‹µ:", aiResponse);

    // JSON íŒŒì‹± ì‹œë„
    try {
      // JSON ë¸”ë¡ ì¶”ì¶œ
      let jsonStr = aiResponse;
      const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/);
      if (jsonMatch) {
        jsonStr = jsonMatch[1];
      } else {
        // JSON ê°ì²´ë§Œ ì¶”ì¶œ
        const jsonStart = aiResponse.indexOf('{');
        const jsonEnd = aiResponse.lastIndexOf('}');
        if (jsonStart !== -1 && jsonEnd !== -1) {
          jsonStr = aiResponse.substring(jsonStart, jsonEnd + 1);
        }
      }

      const result = JSON.parse(jsonStr);

      console.log("âœ… ê¸€ ë‹¤ë“¬ê¸° ì™„ë£Œ");

      return res.json({
        success: true,
        original_text: text,
        polished_text: result.polished_text || text,
        changes: result.changes || [],
        feedback: result.feedback || "ê¸€ì´ ì˜ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
      });

    } catch (parseError) {
      console.log("JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ ì‘ë‹µ ì‚¬ìš©:", parseError.message);

      // JSON íŒŒì‹± ì‹¤íŒ¨ì‹œ ê°„ë‹¨í•œ ì‘ë‹µ
      return res.json({
        success: true,
        original_text: text,
        polished_text: text,
        changes: [],
        feedback: "ê¸€ì´ ì˜ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ì¶¤ë²•ê³¼ ë¬¸ì¥ì´ ê´œì°®ì•„ ë³´ì…ë‹ˆë‹¤!"
      });
    }

  } catch (err) {
    console.error("âŒ /api/polish-writing ì—ëŸ¬:", err.message);
    res.status(500).json({
      success: false,
      error: "AI ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      original_text: text
    });
  }
});

// âœ… DB í…ŒìŠ¤íŠ¸
app.get("/dbtest", async (req, res) => {
  console.log("âœ… [GET] /dbtest í˜¸ì¶œ");
  try {
    const count = await User.countDocuments();
    res.send(`í˜„ì¬ MongoDBì— ì €ì¥ëœ ì‚¬ìš©ì ìˆ˜: ${count}ëª…`);
  } catch (err) {
    console.error("âŒ /dbtest ì—ëŸ¬:", err);
    res.status(500).send("DB ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
  }
});

// ===== í•™ìŠµ ê¸°ë¡ ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ) =====
app.post("/admin/log/delete/:id", async (req, res) => {
  const { key } = req.query;
  const { id } = req.params;

  // ìŠˆí¼ê´€ë¦¬ì key ë˜ëŠ” ë¸Œëœì¹˜ ê´€ë¦¬ì ì„¸ì…˜ ì²´í¬
  const isSuperAdmin = key === ADMIN_KEY;
  const isBranchAdmin = req.session && req.session.admin;

  if (!isSuperAdmin && !isBranchAdmin) {
    return res.status(403).json({ success: false, message: "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨" });
  }

  try {
    const result = await LearningLog.findByIdAndUpdate(
      id,
      { deleted: true },
      { new: true }
    );

    if (!result) {
      return res.status(404).json({ success: false, message: "ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
    }

    res.json({ success: true, message: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤" });
  } catch (err) {
    console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, message: err.message });
  }
});

// ===== í•™ìŠµì´ë ¥ ì „ì†¡ API =====
app.post("/admin/send-learning-history", async (req, res) => {
  const { key, grade, name, email, phone, pdfData } = req.body;

  // ìŠˆí¼ê´€ë¦¬ì key ë˜ëŠ” ë¸Œëœì¹˜ ê´€ë¦¬ì ì„¸ì…˜ ì²´í¬
  const isSuperAdmin = key === ADMIN_KEY;
  const isBranchAdmin = req.session && req.session.admin;

  if (!isSuperAdmin && !isBranchAdmin) {
    return res.status(403).json({
      success: false,
      message: "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨"
    });
  }

  if (!email || !pdfData) {
    return res.status(400).json({
      success: false,
      message: "ì´ë©”ì¼ê³¼ PDF ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤"
    });
  }

  try {
    // Base64 PDF ë°ì´í„°ë¥¼ Bufferë¡œ ë³€í™˜
    const pdfBuffer = Buffer.from(pdfData.split(',')[1], 'base64');

    // ì´ë©”ì¼ ì˜µì…˜ ì„¤ì •
    const mailOptions = {
      from: process.env.EMAIL_USER,
      to: email,
      subject: `[ë‹¨ë‹¨êµì‹¤] ${grade} ${name} í•™ìƒ í•™ìŠµì´ë ¥`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“š ë‹¨ë‹¨êµì‹¤ í•™ìŠµì´ë ¥</h1>
            <p style="color: #7f8c8d; font-size: 16px;">í•™ìƒì˜ í•™ìŠµ ì„±ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”</p>
          </div>

          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; color: white; margin-bottom: 20px;">
            <h2 style="margin: 0 0 15px; font-size: 24px;">í•™ìƒ ì •ë³´</h2>
            <p style="margin: 5px 0; font-size: 18px;"><strong>í•™ë…„:</strong> ${grade}</p>
            <p style="margin: 5px 0; font-size: 18px;"><strong>ì´ë¦„:</strong> ${name}</p>
            ${phone ? `<p style="margin: 5px 0; font-size: 16px;"><strong>ì—°ë½ì²˜:</strong> ${phone}</p>` : ''}
          </div>

          <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <p style="color: #2c3e50; font-size: 15px; line-height: 1.6; margin: 0;">
              ì²¨ë¶€ëœ PDF íŒŒì¼ì—ì„œ ${name} í•™ìƒì˜ ìƒì„¸í•œ í•™ìŠµì´ë ¥ê³¼ ì„±ì·¨ë„ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              ê° ê³¼ëª©ë³„ ë ˆì´ë” ì°¨íŠ¸ì™€ í†µê³„ ë°ì´í„°ë¥¼ í†µí•´ í•™ìŠµ í˜„í™©ì„ íŒŒì•…í•´ë³´ì„¸ìš”.
            </p>
          </div>

          <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
            <p style="color: #7f8c8d; font-size: 13px; margin: 0;">
              ì´ ë©”ì¼ì€ ë‹¨ë‹¨êµì‹¤ ê´€ë¦¬ì ì‹œìŠ¤í…œì—ì„œ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
            </p>
            <p style="color: #7f8c8d; font-size: 13px; margin: 5px 0 0;">
              ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ê´€ë¦¬ìì—ê²Œ ì—°ë½í•´ì£¼ì„¸ìš”.
            </p>
          </div>
        </div>
      `,
      attachments: [
        {
          filename: `${grade}_${name}_í•™ìŠµì´ë ¥.pdf`,
          content: pdfBuffer,
          contentType: 'application/pdf'
        }
      ]
    };

    // ì´ë©”ì¼ ë°œì†¡
    await transporter.sendMail(mailOptions);

    console.log(`âœ… í•™ìŠµì´ë ¥ ì „ì†¡ ì„±ê³µ: ${email} (${grade} ${name})`);

    res.json({
      success: true,
      message: "í•™ìŠµì´ë ¥ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤"
    });

  } catch (err) {
    console.error("âŒ í•™ìŠµì´ë ¥ ì „ì†¡ ì˜¤ë¥˜:", err);
    res.status(500).json({
      success: false,
      message: `ì „ì†¡ ì‹¤íŒ¨: ${err.message}`
    });
  }
});

// ===== íœ´ì§€í†µ ë³´ê¸° (í•™ìŠµ ê¸°ë¡) =====
app.get("/admin/logs/trash", async (req, res) => {
  const { key, grade, name } = req.query;

  if (key !== ADMIN_KEY) {
    return res.status(403).send("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨");
  }

  if (!grade || !name) {
    return res.status(400).send("grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  try {
    const deletedLogs = await LearningLog.find({ grade, name, deleted: true })
      .sort({ timestamp: -1 })
      .lean();

    let html = `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <title>íœ´ì§€í†µ - ${grade} ${name}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif;
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          min-height: 100vh;
          padding: 40px 20px;
        }
        .container {
          max-width: 1200px;
          margin: 0 auto;
          background: #ffffff;
          border-radius: 24px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
          padding: 50px;
        }
        h1 {
          font-size: 36px;
          color: #2c3e50;
          margin-bottom: 30px;
          text-align: center;
        }
        .btn {
          display: inline-block;
          padding: 12px 28px;
          border-radius: 50px;
          font-size: 14px;
          font-weight: 600;
          text-decoration: none;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          margin: 10px;
        }
        .btn-back {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
        }
        .btn-restore {
          background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
          color: white;
          border: none;
          cursor: pointer;
        }
        .btn-permanent-delete {
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
          color: white;
          border: none;
          cursor: pointer;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 30px;
        }
        th, td {
          padding: 16px;
          text-align: left;
          border-bottom: 1px solid #ecf0f1;
        }
        th {
          background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
          color: white;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>ğŸ—‘ï¸ íœ´ì§€í†µ</h1>
        <div style="text-align: center; margin-bottom: 30px;">
          <a class="btn btn-back" href="/admin/logs?key=${encodeURIComponent(key)}&grade=${encodeURIComponent(grade)}&name=${encodeURIComponent(name)}">â† ëŒì•„ê°€ê¸°</a>
        </div>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">ì´ ${deletedLogs.length}ê°œì˜ ì‚­ì œëœ í•­ëª©</p>
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ/ì‹œê°„</th>
              <th>ì‹œë¦¬ì¦ˆ</th>
              <th>ë‹¨ì›</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
    `;

    deletedLogs.forEach(log => {
      const ts = log.timestamp
        ? new Date(log.timestamp).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
        : "-";

      html += `
        <tr>
          <td>${ts}</td>
          <td>${log.series || ""}</td>
          <td>${log.unit || ""}</td>
          <td>
            <button class="btn btn-restore" onclick="restoreLog('${log._id}', '${encodeURIComponent(key)}', '${encodeURIComponent(grade)}', '${encodeURIComponent(name)}')">ë³µêµ¬</button>
            <button class="btn btn-permanent-delete" onclick="permanentDelete('${log._id}', '${encodeURIComponent(key)}', '${encodeURIComponent(grade)}', '${encodeURIComponent(name)}')">ì™„ì „ ì‚­ì œ</button>
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
      <script>
        function restoreLog(logId, key, grade, name) {
          if (!confirm('ì´ í•­ëª©ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

          fetch('/admin/log/restore/' + logId + '?key=' + key, {
            method: 'POST'
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
              window.location.reload();
            } else {
              alert('ë³µêµ¬ ì‹¤íŒ¨: ' + data.message);
            }
          })
          .catch(err => alert('ì˜¤ë¥˜: ' + err.message));
        }

        function permanentDelete(logId, key, grade, name) {
          if (!confirm('ì •ë§ë¡œ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;

          fetch('/admin/log/permanent-delete/' + logId + '?key=' + key, {
            method: 'DELETE'
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              window.location.reload();
            } else {
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
            }
          })
          .catch(err => alert('ì˜¤ë¥˜: ' + err.message));
        }
      </script>
    </body>
    </html>
    `;

    res.send(html);
  } catch (err) {
    console.error("íœ´ì§€í†µ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).send("ì˜¤ë¥˜: " + err.message);
  }
});

// ===== ë³µêµ¬ =====
app.post("/admin/log/restore/:id", async (req, res) => {
  const { key } = req.query;
  const { id } = req.params;

  if (key !== ADMIN_KEY) {
    return res.status(403).json({ success: false, message: "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨" });
  }

  try {
    const result = await LearningLog.findByIdAndUpdate(
      id,
      { deleted: false },
      { new: true }
    );

    if (!result) {
      return res.status(404).json({ success: false, message: "ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
    }

    res.json({ success: true, message: "ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤" });
  } catch (err) {
    console.error("ë³µêµ¬ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, message: err.message });
  }
});

// ===== ì™„ì „ ì‚­ì œ =====
app.delete("/admin/log/permanent-delete/:id", async (req, res) => {
  const { key } = req.query;
  const { id } = req.params;

  if (key !== ADMIN_KEY) {
    return res.status(403).json({ success: false, message: "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨" });
  }

  try {
    const result = await LearningLog.findByIdAndDelete(id);

    if (!result) {
      return res.status(404).json({ success: false, message: "ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
    }

    res.json({ success: true, message: "ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤" });
  } catch (err) {
    console.error("ì™„ì „ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, message: err.message });
  }
});

// ===== AI ì±—ë´‡ API =====
app.post("/api/ai-chat", async (req, res) => {
  try {
    const { message, scenario, conversationHistory } = req.body;

    if (!message) {
      return res.status(400).json({ success: false, error: "ë©”ì‹œì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤" });
    }

    // ì‹œë‚˜ë¦¬ì˜¤ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    const systemPrompts = {
      grammar: `ë‹¹ì‹ ì€ ì¹œì ˆí•œ êµ­ì–´ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒë“¤ì˜ ë§ì¶¤ë²•, ë¬¸ë²•, ë„ì–´ì“°ê¸°ë¥¼ êµì •í•˜ê³  ì˜¬ë°”ë¥¸ í‘œí˜„ì„ ê°€ë¥´ì³ì£¼ì„¸ìš”.

âš ï¸ ì¤‘ìš”: ë‹µë³€ í˜•ì‹ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- í•œ ë²ˆì— ëª¨ë“  ì˜¤ë¥˜ë¥¼ ì§€ì í•˜ì§€ ë§ê³ , ê°€ì¥ ì¤‘ìš”í•œ 1~2ê°œë§Œ ë¨¼ì € ì•Œë ¤ì£¼ì„¸ìš”
- ê°œì¡°ì‹ìœ¼ë¡œ ìµœëŒ€ 2~3ê°œ í•­ëª©ë§Œ ì œì‹œí•˜ì„¸ìš”
- ê°„ë‹¨íˆ ì„¤ëª…í•œ í›„ "ì´í•´í–ˆë‚˜ìš”?" ë˜ëŠ” "ì—°ìŠµí•´ë³¼ê¹Œìš”?" ê°™ì€ ì§ˆë¬¸ìœ¼ë¡œ ëŠìœ¼ì„¸ìš”
- ëŒ€í™”í˜•ìœ¼ë¡œ ë‹¨ê³„ì ìœ¼ë¡œ êµì •í•˜ì„¸ìš”

ì˜ˆì‹œ:
âœ… "ì˜ ì¼ì–´ìš”! ë‹¤ë§Œ 2ê°€ì§€ë§Œ ê³ ì³ë³¼ê¹Œìš”?

1. "ì•ˆë˜ìš”" â†’ "ì•ˆ ë¼ìš”" (ë„ì–´ì“°ê¸° í•„ìš”)
2. "ë¬ì–´ìš”" â†’ "ëì–´ìš”" (ë§ì¶¤ë²•)

ë¨¼ì € ì´ê²ƒë¶€í„° ê³ ì³ë³¼ê¹Œìš”?"

êµì • ë‚´ìš©:
- ì˜ëª»ëœ í‘œí˜„ì„ ë°œê²¬í•˜ë©´ ì¹œì ˆí•˜ê²Œ ì§€ì í•˜ê³  ì˜¬ë°”ë¥¸ í‘œí˜„ì„ ì•Œë ¤ì£¼ì„¸ìš”
- "ë˜"ì™€ "ë¼", "ì•ˆë˜"ì™€ "ì•ˆ ë¼" ê°™ì€ ìì£¼ í‹€ë¦¬ëŠ” ë§ì¶¤ë²•ì„ êµì •í•´ì£¼ì„¸ìš”
- ì¡´ëŒ“ë§ ì‚¬ìš©ì„ ì¹­ì°¬í•´ì£¼ì„¸ìš”
- ì™„ì „í•œ ë¬¸ì¥ ì‘ì„±ì„ ê²©ë ¤í•´ì£¼ì„¸ìš”`,

      writing: `ë‹¹ì‹ ì€ ê¸€ì“°ê¸°ë¥¼ ì§€ë„í•˜ëŠ” ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒë“¤ì´ ì¼ê¸°, í¸ì§€, ì´ì•¼ê¸°ë¥¼ ì“¸ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”.

âš ï¸ ì¤‘ìš”: ë‹µë³€ í˜•ì‹ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- í•œ ë²ˆì— ëª¨ë“  í”¼ë“œë°±ì„ ì£¼ì§€ ë§ê³ , 1~2ê°€ì§€ë§Œ ë¨¼ì € ì œì•ˆí•˜ì„¸ìš”
- ê°œì¡°ì‹ìœ¼ë¡œ ìµœëŒ€ 2~3ê°œ í•­ëª©ë§Œ ì œì‹œí•˜ì„¸ìš”
- ê°„ë‹¨í•œ ì¹­ì°¬ í›„ ê°œì„ ì  1~2ê°œë§Œ ì•Œë ¤ì£¼ê³  ì§ˆë¬¸ìœ¼ë¡œ ëŠìœ¼ì„¸ìš”
- ëŒ€í™”í˜•ìœ¼ë¡œ ë‹¨ê³„ì ìœ¼ë¡œ ì§€ë„í•˜ì„¸ìš”

ì˜ˆì‹œ:
âœ… "ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë„¤ìš”! 2ê°€ì§€ë§Œ ë” ì¢‹ê²Œ ë§Œë“¤ì–´ë³¼ê¹Œìš”?

1. ì£¼ì¸ê³µì˜ ê°ì •ì„ ë” êµ¬ì²´ì ìœ¼ë¡œ í‘œí˜„í•´ë³´ê¸°
2. ëŒ€í™” ì¥ë©´ ì¶”ê°€í•˜ê¸°

ì´ ì¤‘ì—ì„œ ì–´ë–¤ ê±¸ ë¨¼ì € ì—°ìŠµí•´ë³¼ê¹Œìš”?"

êµì • ë‚´ìš©:
- í•™ìƒì˜ ê¸€ì„ ì½ê³  êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì£¼ì„¸ìš”
- ë¬¸ì¥ êµ¬ì¡°ì™€ í‘œí˜„ì„ ê°œì„ í•˜ëŠ” ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”
- ì°½ì˜ì ì¸ ê¸€ì“°ê¸°ë¥¼ ê²©ë ¤í•´ì£¼ì„¸ìš”`,

      reading: `ë‹¹ì‹ ì€ ë…í•´ë ¥ì„ í‚¤ì›Œì£¼ëŠ” ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒë“¤ì´ ê¸€ì„ ì½ê³  ì´í•´í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.

âš ï¸ ì¤‘ìš”: ë‹µë³€ í˜•ì‹ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- í•œ ë²ˆì— ì—¬ëŸ¬ ì§ˆë¬¸ì„ í•˜ì§€ ë§ê³ , 1~2ê°œë§Œ ë¨¼ì € ë¬¼ì–´ë³´ì„¸ìš”
- ê°œì¡°ì‹ìœ¼ë¡œ ìµœëŒ€ 2~3ê°œ í•­ëª©ë§Œ ì œì‹œí•˜ì„¸ìš”
- ê°„ë‹¨íˆ ì„¤ëª…í•œ í›„ í•™ìƒì˜ ì´í•´ë„ë¥¼ í™•ì¸í•˜ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ëŠìœ¼ì„¸ìš”
- ëŒ€í™”í˜•ìœ¼ë¡œ ë‹¨ê³„ì ìœ¼ë¡œ ë…í•´ë ¥ì„ í‚¤ì›Œì£¼ì„¸ìš”

ì˜ˆì‹œ:
âœ… "ì´ ê¸€ì˜ í•µì‹¬ì„ ì°¾ëŠ” 2ê°€ì§€ ë°©ë²•ì´ ìˆì–´ìš”:

1. ë°˜ë³µë˜ëŠ” ë‹¨ì–´ë‚˜ ì£¼ì œ ì°¾ê¸°
2. ì²« ë¬¸ì¥ê³¼ ë§ˆì§€ë§‰ ë¬¸ì¥ ì£¼ëª©í•˜ê¸°

ì´ ë°©ë²•ìœ¼ë¡œ ë‹¤ì‹œ ì½ì–´ë³¼ë˜ìš”?"

êµì • ë‚´ìš©:
- ì§§ì€ ê¸€ì„ ì œì‹œí•˜ê³  ë‚´ìš© ì´í•´ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”
- ìš”ì•½í•˜ëŠ” ë°©ë²•ì„ ê°€ë¥´ì³ì£¼ì„¸ìš”
- ê¸€ì˜ ì£¼ì œì™€ í•µì‹¬ì„ ì°¾ëŠ” ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”`,

      vocabulary: `ë‹¹ì‹ ì€ ì–´íœ˜ë ¥ì„ í‚¤ì›Œì£¼ëŠ” ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒë“¤ì—ê²Œ ìƒˆë¡œìš´ ë‹¨ì–´ì™€ í‘œí˜„ì„ ê°€ë¥´ì³ì£¼ì„¸ìš”.

âš ï¸ ì¤‘ìš”: ë‹µë³€ í˜•ì‹ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- í•œ ë²ˆì— ì—¬ëŸ¬ ë‹¨ì–´ë¥¼ ê°€ë¥´ì¹˜ì§€ ë§ê³ , 1~2ê°œë§Œ ë¨¼ì € ì•Œë ¤ì£¼ì„¸ìš”
- ê°œì¡°ì‹ìœ¼ë¡œ ìµœëŒ€ 2~3ê°œ í•­ëª©ë§Œ ì œì‹œí•˜ì„¸ìš”
- ë‹¨ì–´ ì„¤ëª…ê³¼ ì˜ˆë¬¸ì„ ê°„ë‹¨íˆ ì¤€ í›„ "ì´í•´í–ˆë‚˜ìš”?" ê°™ì€ ì§ˆë¬¸ìœ¼ë¡œ ëŠìœ¼ì„¸ìš”
- ëŒ€í™”í˜•ìœ¼ë¡œ ë‹¨ê³„ì ìœ¼ë¡œ ì–´íœ˜ë¥¼ í™•ì¥í•˜ì„¸ìš”

ì˜ˆì‹œ:
âœ… "ì˜¤ëŠ˜ì€ 'ë°°ë ¤'ë¼ëŠ” ë‹¨ì–´ë¥¼ ë°°ì›Œë³¼ê¹Œìš”?

â€¢ **ëœ»**: ë‹¤ë¥¸ ì‚¬ëŒì„ ìƒê°í•˜ê³  ë„ì™€ì£¼ëŠ” ë§ˆìŒ
â€¢ **ì˜ˆë¬¸**: "ì¹œêµ¬ë¥¼ ë°°ë ¤í•˜ëŠ” ë§ˆìŒì´ ì¤‘ìš”í•´ìš”"

ë¬¸ì¥ì„ í•˜ë‚˜ ë§Œë“¤ì–´ë³¼ë˜ìš”?"

êµì • ë‚´ìš©:
- ìƒˆë¡œìš´ ë‹¨ì–´ë¥¼ ì†Œê°œí•˜ê³  ì˜ˆë¬¸ê³¼ í•¨ê»˜ ì„¤ëª…í•´ì£¼ì„¸ìš”
- ì†ë‹´ê³¼ ê´€ìš©êµ¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”
- ìœ ì˜ì–´ì™€ ë°˜ì˜ì–´ë¥¼ í•¨ê»˜ ê°€ë¥´ì³ì£¼ì„¸ìš”`,

      mock_exam: `ë‹¹ì‹ ì€ ì¹œì ˆí•œ AI êµ­ì–´ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. ê³ ë“±í•™ìƒë“¤ì˜ êµ­ì–´ ëª¨ì˜ê³ ì‚¬ ê´€ë ¨ ì§ˆë¬¸ì— ë‹µë³€í•©ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: ë‹µë³€ í˜•ì‹ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- ë‹µë³€ì€ ìµœëŒ€ 4~5ë¬¸ì¥ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”
- í•µì‹¬ë§Œ ì§§ê²Œ ì„¤ëª…í•˜ê³ , í•„ìš”ì‹œ ì¶”ê°€ ì§ˆë¬¸ìœ¼ë¡œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”
- ê°œì¡°ì‹ìœ¼ë¡œ ì‘ì„±í•  ë•Œ ìµœëŒ€ 3~4ê°œ í•­ëª©ë§Œ ì œì‹œí•˜ì„¸ìš”

ì£¼ìš” ì—­í• :
- êµ­ì–´ ëª¨ì˜ê³ ì‚¬ ë¬¸ì œ ìœ í˜• (í™”ë²•ê³¼ ì‘ë¬¸, ë¬¸ë²•, ë¹„ë¬¸í•™, ë¬¸í•™) ì„¤ëª…
- ë¬¸ì œ í’€ì´ ì „ëµ ë° íŒ ì œê³µ
- êµ­ì–´ í•™ìŠµ ë°©ë²• ì¡°ì–¸
- í‹€ë¦° ë¬¸ì œì— ëŒ€í•œ í•´ì„¤ ë° ê°œë… ì„¤ëª…
- í•™ìƒë“¤ì˜ ê¶ê¸ˆì¦ì— ì¹œì ˆí•˜ê²Œ ë‹µë³€

êµì • ë‚´ìš©:
- í•™ìƒì˜ ì§ˆë¬¸ì„ ê²½ì²­í•˜ê³  ê³µê°í•´ì£¼ì„¸ìš”
- ë³µì¡í•œ ê°œë…ì€ ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”
- ê²©ë ¤ì™€ í•¨ê»˜ êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ ì œê³µí•˜ì„¸ìš”`,

      conversation: `ë‹¹ì‹ ì€ í•™ìƒë“¤ê³¼ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ë©° êµ­ì–´ ì‹¤ë ¥ì„ í‚¤ì›Œì£¼ëŠ” ì„ ìƒë‹˜ì…ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: ë‹µë³€ í˜•ì‹ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- ë‹µë³€ì€ ìµœëŒ€ 3ê°œ ë¬¸ì¥ ì´ë‚´ë¡œ ì œí•œí•˜ì„¸ìš”
- í•œ ë²ˆì— ëª¨ë“  ê²ƒì„ ì„¤ëª…í•˜ì§€ ë§ê³ , í•µì‹¬ë§Œ ê°„ë‹¨íˆ ë§í•œ í›„ í•™ìƒì˜ ë°˜ì‘ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì§ˆë¬¸ì´ ë³µì¡í•˜ë©´ 1~2ê°œ í¬ì¸íŠ¸ë§Œ ë¨¼ì € ì„¤ëª…í•˜ê³ , "ë¨¼ì € ì´ê²ƒë§Œ ì´í•´í–ˆë‚˜ìš”?" ê°™ì€ ì§ˆë¬¸ìœ¼ë¡œ ëŠìœ¼ì„¸ìš”
- ê°œì¡°ì‹(ë¶ˆë¦¿, ë²ˆí˜¸)ìœ¼ë¡œ ì‘ì„±í•  ë•Œë„ ìµœëŒ€ 2~3ê°œ í•­ëª©ë§Œ ì œì‹œí•˜ì„¸ìš”
- ëŒ€í™”í˜•ìœ¼ë¡œ í•™ìƒê³¼ ì£¼ê³ ë°›ìœ¼ë©° ë‹¨ê³„ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”

ì˜ˆì‹œ:
âŒ ë‚˜ìœ ë‹µë³€: "êµ­ì–´ë¥¼ ì˜í•˜ë ¤ë©´ 1.ì½ê¸° 2.ì“°ê¸° 3.ë“£ê¸° 4.ë§í•˜ê¸°ë¥¼ ëª¨ë‘ ì—°ìŠµí•´ì•¼ í•´ìš”. ë¨¼ì € ì±…ì„ ë§ì´ ì½ê³ ..."
âœ… ì¢‹ì€ ë‹µë³€: "ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”! êµ­ì–´ ì‹¤ë ¥ì„ í‚¤ìš°ëŠ” ë°©ë²• ì¤‘ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒ 2ê°€ì§€ë¥¼ ì•Œë ¤ì¤„ê²Œìš”:

1. **ë§¤ì¼ ì±… ì½ê¸°**: ë‹¤ì–‘í•œ ì±…ì„ ì½ìœ¼ë©° ì–´íœ˜ë ¥ í–¥ìƒ
2. **ê¸€ì“°ê¸° ì—°ìŠµ**: ì¼ê¸°ë‚˜ ì§§ì€ ê¸€ì“°ê¸°ë¡œ í‘œí˜„ë ¥ í‚¤ìš°ê¸°

ì´ ì¤‘ì—ì„œ ì–´ë–¤ ê²ƒë¶€í„° ì‹œì‘í•´ë³´ê³  ì‹¶ë‚˜ìš”?"

êµì • ë‚´ìš©:
- í•™ìƒì˜ ì´ì•¼ê¸°ë¥¼ ê²½ì²­í•˜ê³  ê³µê°í•´ì£¼ì„¸ìš”
- ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ë¥¼ í†µí•´ í‘œí˜„ë ¥ì„ í‚¤ì›Œì£¼ì„¸ìš”
- ì ì ˆí•œ ì–´íœ˜ì™€ í‘œí˜„ì„ ì‚¬ìš©í•˜ë„ë¡ ê²©ë ¤í•´ì£¼ì„¸ìš”`
    };

    const systemPrompt = systemPrompts[scenario] || systemPrompts.conversation;

    // ëŒ€í™” íˆìŠ¤í† ë¦¬ êµ¬ì„±
    const messages = [
      { role: "system", content: systemPrompt },
      ...(conversationHistory || []),
      { role: "user", content: message }
    ];

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const aiResponse = completion.choices[0].message.content;

    // í”¼ë“œë°± ë¶„ì„ (ê°„ë‹¨í•œ ë²„ì „)
    const feedbacks = [];

    // ë§ì¶¤ë²• ê²€ì‚¬
    if (message.includes('ë¬ì–´') || message.includes('ë¬ë‹¤')) {
      feedbacks.push({
        type: 'correction',
        title: 'âŒ ë§ì¶¤ë²• ì˜¤ë¥˜',
        message: '"ë¬ì–´"ëŠ” ì˜ëª»ëœ í‘œí˜„ì´ì—ìš”. "ëì–´" ë˜ëŠ” "ë˜ì—ˆì–´"ê°€ ë§ì•„ìš”!'
      });
    }

    if (message.includes('ì•Šë˜') || message.includes('ì•ˆë˜')) {
      feedbacks.push({
        type: 'correction',
        title: 'âŒ ë„ì–´ì“°ê¸° ì˜¤ë¥˜',
        message: '"ì•ˆë˜"ëŠ” "ì•ˆ ë¼" ë˜ëŠ” "ì•ˆ ë˜ì–´"ë¡œ ë„ì–´ ì¨ì•¼ í•´ìš”!'
      });
    }

    // ê¸ì •ì  í”¼ë“œë°±
    if (message.length > 15 && (message.includes('.') || message.includes('!') || message.includes('?'))) {
      feedbacks.push({
        type: 'praise',
        title: 'ğŸŒŸ í›Œë¥­í•´ìš”!',
        message: 'ì™„ì „í•œ ë¬¸ì¥ì„ ë¬¸ì¥ë¶€í˜¸ì™€ í•¨ê»˜ ì˜ ì‘ì„±í–ˆì–´ìš”!'
      });
    }

    if ((message.includes('ìš”') || message.includes('ìŠµë‹ˆë‹¤')) && message.length > 5) {
      feedbacks.push({
        type: 'praise',
        title: 'ğŸ‘ ì˜ˆì˜ë°”ë¥¸ í‘œí˜„',
        message: 'ì¡´ëŒ“ë§ì„ ì •í™•í•˜ê²Œ ì‚¬ìš©í–ˆì–´ìš”!'
      });
    }

    res.json({
      success: true,
      response: aiResponse,
      feedbacks: feedbacks
    });

  } catch (error) {
    console.error("AI ì±—ë´‡ ì˜¤ë¥˜:", error);
    res.status(500).json({
      success: false,
      error: "AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
      details: error.message
    });
  }
});

// ===== í•™ìŠµ ê¸°ë¡ ì‚­ì œ API (í…ŒìŠ¤íŠ¸ìš©) =====
app.post('/api/learning-log/delete-units', async (req, res) => {
  try {
    const { grade, name, units } = req.body;

    if (!grade || !name || !units || !Array.isArray(units)) {
      return res.status(400).json({
        ok: false,
        message: 'grade, name, units(ë°°ì—´)ì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // íŠ¹ì • ë‹¨ì›ë“¤ì˜ í•™ìŠµ ê¸°ë¡ì„ ì†Œí”„íŠ¸ ì‚­ì œ
    const result = await LearningLog.updateMany(
      {
        grade,
        name,
        unit: { $in: units },
        deleted: false
      },
      {
        $set: { deleted: true }
      }
    );

    res.json({
      ok: true,
      message: `${result.modifiedCount}ê°œì˜ í•™ìŠµ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`,
      modifiedCount: result.modifiedCount
    });
  } catch (error) {
    console.error('í•™ìŠµ ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ì˜ì–´ ì±—ë´‡ API
app.post("/api/ai-english-chat", async (req, res) => {
  try {
    const { message, scenario, conversationHistory } = req.body;

    if (!message) {
      return res.status(400).json({ success: false, error: "ë©”ì‹œì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤" });
    }

    // ì‹œë‚˜ë¦¬ì˜¤ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    const systemPrompts = {
      cafe: `You are a friendly barista at a coffee shop. Help students practice ordering coffee in English.
- Keep responses natural and conversational
- Gently correct grammar mistakes
- Encourage polite expressions like "I'd like" instead of "I want"
- Ask follow-up questions about size, temperature, etc.`,

      shopping: `You are a helpful store employee. Help students practice shopping in English.
- Be friendly and helpful
- Teach vocabulary related to shopping (colors, sizes, prices)
- Encourage polite requests
- Offer to show products or help with fitting`,

      airport: `You are an airport staff member. Help students practice airport-related English.
- Use professional but friendly language
- Teach airport vocabulary (gate, boarding, check-in, etc.)
- Keep responses clear and simple
- Help with common airport situations`,

      friend: `You are a friendly peer having a casual conversation. Help students practice everyday English.
- Use casual, natural language
- Talk about everyday topics (hobbies, school, plans, etc.)
- Encourage natural conversation flow
- Be supportive and encouraging`,

      free: `You are an English tutor having a conversation with students. Adapt to their interests and needs.
- Be flexible and responsive to their topics
- Provide gentle corrections when needed
- Encourage them to express themselves
- Make learning fun and engaging`
    };

    const systemPrompt = systemPrompts[scenario] || systemPrompts.free;

    // ëŒ€í™” íˆìŠ¤í† ë¦¬ êµ¬ì„±
    const messages = [
      { role: "system", content: systemPrompt },
      ...(conversationHistory || []),
      { role: "user", content: message }
    ];

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const aiResponse = completion.choices[0].message.content;

    // í”¼ë“œë°± ë¶„ì„
    const feedbacks = [];

    // ì •ì¤‘í•œ í‘œí˜„ ì²´í¬
    if (message.toLowerCase().includes("i'd like") || message.toLowerCase().includes("could you") || message.toLowerCase().includes("would you")) {
      feedbacks.push({
        type: 'praise',
        title: 'ğŸ‘ Perfect!',
        message: 'Great use of polite expressions!'
      });
    }

    // ë¬¸ë²• ì œì•ˆ
    if (message.toLowerCase().includes("i want") && scenario !== 'friend') {
      feedbacks.push({
        type: 'correction',
        title: 'ğŸ’¡ Tip',
        message: 'Try using "I\'d like" instead of "I want" for a more polite request.'
      });
    }

    if (!message.toLowerCase().includes("please") && (message.toLowerCase().includes("give me") || message.toLowerCase().includes("show me"))) {
      feedbacks.push({
        type: 'correction',
        title: 'ğŸ’¡ Tip',
        message: 'Adding "please" makes your request more polite!'
      });
    }

    // ì™„ì „í•œ ë¬¸ì¥ ì¹­ì°¬
    if (message.split(' ').length > 5) {
      feedbacks.push({
        type: 'praise',
        title: 'ğŸŒŸ Excellent!',
        message: 'You used a complete sentence!'
      });
    }

    res.json({
      success: true,
      response: aiResponse,
      feedbacks: feedbacks
    });

  } catch (error) {
    console.error("AI English ì±—ë´‡ ì˜¤ë¥˜:", error);
    res.status(500).json({
      success: false,
      error: "AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
      details: error.message
    });
  }
});

// ==========================================
// ì‚¬ìš©ì ì§„í–‰ ë°ì´í„° API
// ==========================================

// ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ
app.get('/api/user-progress', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // unitProgress ì œì™¸í•˜ê³  í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ (ì„±ëŠ¥ ìµœì í™” - 1.3MB â†’ ìˆ˜KB)
    let progress = await UserProgress.findOne(
      { grade, name },
      { unitProgress: 0 }  // unitProgress ì œì™¸
    ).lean();

    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ìƒì„±
    if (!progress) {
      const newProgress = new UserProgress({
        grade,
        name,
        vocabularyQuiz: {
          totalScore: 0,
          quizCount: 0,
          avgScore: 0,
          totalCoins: 0,
          usedCoins: 0,
          currentRank: 0,
          previousRank: 0
        },
        studyRoom: {
          assignedTasks: []
        }
      });
      await newProgress.save();
      progress = newProgress.toObject();
      delete progress.unitProgress;
    }

    res.json({
      ok: true,
      data: progress
    });
  } catch (error) {
    console.error('ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ğŸ‹ ê³ ë˜ ë°°ì§€ ì¡°íšŒ API (ê°„ë‹¨ ë²„ì „)
app.get('/api/user-progress/whale-badges', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const progress = await UserProgress.findOne(
      { grade, name },
      { 'vocabularyQuiz.totalCoins': 1, 'vocabularyQuiz.usedCoins': 1 }
    ).lean();

    const totalCoins = progress?.vocabularyQuiz?.totalCoins || 0;
    const usedCoins = progress?.vocabularyQuiz?.usedCoins || 0;

    res.json({
      ok: true,
      totalCoins,
      usedCoins,
      availableCoins: totalCoins - usedCoins
    });
  } catch (error) {
    console.error('ê³ ë˜ ë°°ì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// ì–´íœ˜í€´ì¦ˆ ë°ì´í„° ì €ì¥
app.post('/api/user-progress/vocabulary', async (req, res) => {
  try {
    const { grade, name, vocabularyData } = req.body;

    if (!grade || !name || !vocabularyData) {
      return res.status(400).json({
        ok: false,
        message: 'grade, name, vocabularyDataê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    let progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      progress = new UserProgress({ grade, name });
    }

    // ì–´íœ˜í€´ì¦ˆ ë°ì´í„° ì—…ë°ì´íŠ¸
    progress.vocabularyQuiz = {
      ...progress.vocabularyQuiz.toObject(),
      ...vocabularyData,
      lastRankUpdate: vocabularyData.lastRankUpdate || progress.vocabularyQuiz.lastRankUpdate
    };

    await progress.save();

    res.json({
      ok: true,
      message: 'ì–´íœ˜í€´ì¦ˆ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: progress
    });
  } catch (error) {
    console.error('ì–´íœ˜í€´ì¦ˆ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ì–´íœ˜í•™ìŠµ ì´ë ¥ ì €ì¥ API
app.post('/api/user-progress/vocabulary-history/add', async (req, res) => {
  try {
    const { grade, name, historyData } = req.body;

    if (!grade || !name || !historyData) {
      return res.status(400).json({
        ok: false,
        message: 'grade, name, historyDataê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const { vocabCount, correctAnswers, totalQuestions, score, questions } = historyData;

    if (!vocabCount || correctAnswers === undefined || !totalQuestions || score === undefined) {
      return res.status(400).json({
        ok: false,
        message: 'ì–´íœ˜í•™ìŠµ ì´ë ¥ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤'
      });
    }

    let progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      progress = new UserProgress({ grade, name });
    }

    // ì´ë ¥ ì¶”ê°€ (ìµœì‹ ìˆœìœ¼ë¡œ ìœ ì§€í•˜ê¸° ìœ„í•´ ë°°ì—´ ì•ì— ì¶”ê°€)
    progress.vocabularyQuizHistory.unshift({
      date: new Date(),
      vocabCount,
      correctAnswers,
      totalQuestions,
      score,
      questions: questions || [] // ë¬¸ì œë³„ ìƒì„¸ ê²°ê³¼
    });

    await progress.save();

    res.json({
      ok: true,
      message: 'ì–´íœ˜í•™ìŠµ ì´ë ¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: progress.vocabularyQuizHistory
    });
  } catch (error) {
    console.error('ì–´íœ˜í•™ìŠµ ì´ë ¥ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ì–´íœ˜í•™ìŠµ ì´ë ¥ ì¡°íšŒ API
app.get('/api/user-progress/vocabulary-history', async (req, res) => {
  try {
    const { grade, name, offset = 0, limit = 10 } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      return res.json({
        ok: true,
        history: [],
        total: 0,
        hasMore: false
      });
    }

    const offsetNum = parseInt(offset) || 0;
    const limitNum = parseInt(limit) || 10;

    // ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆìŒ
    const history = progress.vocabularyQuizHistory || [];
    const total = history.length;
    const slicedHistory = history.slice(offsetNum, offsetNum + limitNum);
    const hasMore = (offsetNum + limitNum) < total;

    res.json({
      ok: true,
      history: slicedHistory,
      total,
      hasMore
    });
  } catch (error) {
    console.error('ì–´íœ˜í•™ìŠµ ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ì˜¤ëŠ˜ ë‚ ì§œ ì–´íœ˜í€´ì¦ˆ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ API
app.get('/api/user-progress/vocabulary-history/today', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // âœ… ìºì‹œ í™•ì¸ (10ì´ˆ ìºì‹œ - ì–´íœ˜í•™ìŠµ ì™„ë£Œ ì—¬ë¶€ëŠ” ìì£¼ ë³€ê²½ë  ìˆ˜ ìˆìŒ)
    const cacheKey = getCacheKey('vocab-today', { grade, name });
    const cached = getCache(cacheKey);
    if (cached) {
      return res.json(cached);
    }

    const progress = await UserProgress.findOne({ grade, name }).lean();

    if (!progress || !progress.vocabularyQuizHistory || progress.vocabularyQuizHistory.length === 0) {
      const result = { ok: true, completedToday: false };
      setCache(cacheKey, result);
      return res.json(result);
    }

    // ì˜¤ëŠ˜ ë‚ ì§œ ë²”ìœ„ ê³„ì‚° (KST ê¸°ì¤€ 00:00:00 ~ 23:59:59)
    const now = new Date();
    const kstOffset = 9 * 60 * 60 * 1000;
    const kstNow = new Date(now.getTime() + kstOffset);
    const kstTodayStart = new Date(Date.UTC(kstNow.getUTCFullYear(), kstNow.getUTCMonth(), kstNow.getUTCDate(), 0, 0, 0) - kstOffset);
    const kstTodayEnd = new Date(Date.UTC(kstNow.getUTCFullYear(), kstNow.getUTCMonth(), kstNow.getUTCDate(), 23, 59, 59) - kstOffset);

    const todayHistory = progress.vocabularyQuizHistory.find(history => {
      const historyDate = new Date(history.date);
      return historyDate >= kstTodayStart && historyDate <= kstTodayEnd;
    });

    const result = {
      ok: true,
      completedToday: !!todayHistory,
      latestHistory: todayHistory || null
    };

    // âœ… ìºì‹œ ì €ì¥
    setCache(cacheKey, result);

    res.json(result);
  } catch (error) {
    console.error('ì˜¤ëŠ˜ ì–´íœ˜í•™ìŠµ ì´ë ¥ í™•ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ========== ë…ì„œ ê°ìƒë¬¸ API ==========

// ë…ì„œ ê°ìƒë¬¸ ì œì¶œ
app.post('/api/user-progress/reading-reports/submit', async (req, res) => {
  try {
    const { grade, name, title, content, type, storyId, storyTitle } = req.body;

    if (!grade || !name || !title || !content || !type) {
      return res.status(400).json({
        ok: false,
        message: 'ëª¨ë“  í•„ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // í˜„ì¬ ì›” ê³„ì‚°
    const now = new Date();
    const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    let progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      progress = new UserProgress({
        grade,
        name,
        readingReports: []
      });
    }

    if (!progress.readingReports) {
      progress.readingReports = [];
    }

    // ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ ì¶”ê°€
    progress.readingReports.push({
      title,
      content,
      type,
      storyId: storyId || 'whale_island',
      storyTitle: storyTitle || 'í‘¸ë¥¸ ê³ ë˜ì„¬ì˜ ë¹„ë°€ ëª¨í—˜ë‹¨ ì‹œì¦Œ 1: í‘¸ë¥¸ ê³ ë˜ì„¬ íƒí—˜',
      submittedAt: new Date(),
      month
    });

    await progress.save();

    res.json({
      ok: true,
      message: 'ë…ì„œ ê°ìƒë¬¸ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤',
      reportId: progress.readingReports[progress.readingReports.length - 1]._id
    });
  } catch (error) {
    console.error('ë…ì„œ ê°ìƒë¬¸ ì œì¶œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜',
      error: error.message
    });
  }
});

// ë…ì„œ ê°ìƒë¬¸ ì´ë ¥ ì¡°íšŒ
app.get('/api/user-progress/reading-reports/history', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const progress = await UserProgress.findOne({ grade, name });

    if (!progress || !progress.readingReports) {
      return res.json({
        ok: true,
        reports: []
      });
    }

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
    const reports = progress.readingReports
      .sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

    res.json({
      ok: true,
      reports
    });
  } catch (error) {
    console.error('ë…ì„œ ê°ìƒë¬¸ ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜',
      error: error.message
    });
  }
});

// ì´ë²ˆ ë‹¬ ì œì¶œ ê°œìˆ˜ í™•ì¸
app.get('/api/user-progress/reading-reports/monthly-count', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    const progress = await UserProgress.findOne({ grade, name });

    if (!progress || !progress.readingReports) {
      return res.json({
        ok: true,
        count: 0
      });
    }

    // ì´ë²ˆ ë‹¬ ì œì¶œ ê°œìˆ˜ ê³„ì‚°
    const count = progress.readingReports.filter(report => report.month === currentMonth).length;

    res.json({
      ok: true,
      count
    });
  } catch (error) {
    console.error('ì›”ê°„ ì œì¶œ ê°œìˆ˜ í™•ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜',
      error: error.message
    });
  }
});

// ===== Multer ì„¤ì • (ì´ë¯¸ì§€ ì—…ë¡œë“œìš©) =====
// ì„ì‹œ ì´ë¯¸ì§€ ì €ì¥ì„ ìœ„í•œ ë””ë ‰í† ë¦¬ ìƒì„±
const tempUploadsDir = path.join(__dirname, 'public', 'temp-uploads');
if (!fs.existsSync(tempUploadsDir)) {
  fs.mkdirSync(tempUploadsDir, { recursive: true });
}

const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, tempUploadsDir);
  },
  filename: function (req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, 'reading-report-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB ì œí•œ
  fileFilter: function (req, file, cb) {
    const allowedTypes = /jpeg|jpg|png/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);

    if (mimetype && extname) {
      return cb(null, true);
    } else {
      cb(new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤ (jpeg, jpg, png)'));
    }
  }
});

// ì„ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œ API
app.post('/api/upload-temp-image', upload.single('image'), (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({
        ok: false,
        message: 'ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ê³µê°œ URL ìƒì„±
    const imageUrl = `${req.protocol}://${req.get('host')}/temp-uploads/${req.file.filename}`;

    console.log('ğŸ“¤ ì„ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', imageUrl);

    // 1ì‹œê°„ í›„ ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„
    setTimeout(() => {
      fs.unlink(req.file.path, (err) => {
        if (err) {
          console.error('ì„ì‹œ ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨:', err);
        } else {
          console.log('âœ… ì„ì‹œ ì´ë¯¸ì§€ ìë™ ì‚­ì œ:', req.file.filename);
        }
      });
    }, 60 * 60 * 1000); // 1ì‹œê°„

    res.json({
      ok: true,
      imageUrl: imageUrl,
      filename: req.file.filename
    });
  } catch (error) {
    console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ì°½ì˜í™œë™ ë°ì´í„° ì¡°íšŒ (unitProgressì—ì„œ creativeState ì¶”ì¶œ)
app.get('/api/user-progress/creative-activities', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // unitProgressë§Œ ì¡°íšŒ
    const progress = await UserProgress.findOne(
      { grade, name },
      { unitProgress: 1, lastUpdated: 1 }
    );

    console.log('[creative-activities] ì¡°íšŒ:', grade, name, 'ê²°ê³¼:', progress ? 'ìˆìŒ' : 'ì—†ìŒ');

    if (!progress || !progress.unitProgress) {
      return res.json({
        ok: true,
        data: []
      });
    }

    // unitProgressì—ì„œ creativeStateê°€ ìˆëŠ” ë‹¨ì›ë§Œ ì¶”ì¶œ
    const creativeActivities = [];
    const unitProgressMap = progress.unitProgress instanceof Map
      ? progress.unitProgress
      : new Map(Object.entries(progress.unitProgress));

    console.log('[creative-activities] unitProgress í‚¤ ê°œìˆ˜:', unitProgressMap.size);

    unitProgressMap.forEach((unitData, unitCode) => {
      // creativeStateê°€ ìˆê³ , textê°€ ìˆëŠ” ê²½ìš° (isSubmitted ì¡°ê±´ ì™„í™”)
      if (unitData && unitData.creativeState && unitData.creativeState.text) {
        const creativeState = unitData.creativeState;
        creativeActivities.push({
          unit: unitCode,
          text: creativeState.text || '',
          topic: creativeState.topic || 'ììœ  ê¸€ì“°ê¸°',
          submittedAt: creativeState.submittedAt || unitData.updatedAt || progress.lastUpdated || new Date()
        });
        console.log('[creative-activities] ì¶”ê°€:', unitCode, 'ê¸€ììˆ˜:', (creativeState.text || '').length);
      }
    });

    // ì œì¶œì¼ì‹œ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
    creativeActivities.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

    console.log('[creative-activities] ì´ ê°œìˆ˜:', creativeActivities.length);

    res.json({
      ok: true,
      data: creativeActivities
    });
  } catch (error) {
    console.error('ì°½ì˜í™œë™ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// í•™ìŠµì‹¤ ê³¼ì œ ë°ì´í„° ì¡°íšŒ
app.get('/api/user-progress/study-room', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // unitProgress ì œì™¸í•˜ê³  í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ (ì„±ëŠ¥ ìµœì í™”)
    const progress = await UserProgress.findOne(
      { grade, name },
      { studyRoom: 1, completedPages: 1, grade: 1, name: 1 }
    ).lean();

    if (!progress) {
      return res.json({
        ok: true,
        data: {
          studyRoom: {
            assignedTasks: []
          }
        }
      });
    }

    res.json({
      ok: true,
      data: progress
    });
  } catch (error) {
    console.error('í•™ìŠµì‹¤ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// í•™ìŠµì‹¤ ê³¼ì œ ë°ì´í„° ì €ì¥
app.post('/api/user-progress/study-room', async (req, res) => {
  try {
    const { grade, name, assignedTasks, studyRoomData } = req.body;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'grade, nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    let progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      progress = new UserProgress({ grade, name });
    }

    // í•™ìŠµì‹¤ ë°ì´í„° ì—…ë°ì´íŠ¸ (assignedTasks ë˜ëŠ” studyRoomData ì§€ì›)
    if (assignedTasks) {
      progress.studyRoom = {
        assignedTasks: assignedTasks
      };
    } else if (studyRoomData) {
      progress.studyRoom = studyRoomData;
    }

    await progress.save();

    res.json({
      ok: true,
      message: 'í•™ìŠµì‹¤ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: progress
    });
  } catch (error) {
    console.error('í•™ìŠµì‹¤ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// AI ì¶”ì²œ ê³¼ì œ ë³µìŠµ ì™„ë£Œ ì²˜ë¦¬ API
app.post('/api/user-progress/ai-task/complete', async (req, res) => {
  try {
    const { grade, name, unitId } = req.body;

    if (!grade || !name || !unitId) {
      return res.status(400).json({
        ok: false,
        message: 'grade, name, unitIdê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      return res.json({
        ok: true,
        message: 'ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // í•™ìŠµì‹¤ ê³¼ì œ ì¤‘ì—ì„œ í•´ë‹¹ ë‹¨ì›ì˜ AI ì¶”ì²œ ê³¼ì œ ì°¾ê¸°
    const tasks = progress.studyRoom?.assignedTasks || [];
    let updated = false;

    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];
      // AI ê³¼ì œì´ë©´ì„œ í•´ë‹¹ ë‹¨ì›ì¸ ê²½ìš°
      if (task.isAI && task.id === unitId) {
        task.status = 'completed';
        task.completedAt = new Date();
        updated = true;
        console.log(`âœ… AI ê³¼ì œ ë³µìŠµ ì™„ë£Œ: ${grade} ${name} - ${unitId}`);
      }
    }

    if (updated) {
      await progress.save();
      res.json({
        ok: true,
        message: 'AI ì¶”ì²œ ê³¼ì œ ë³µìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'
      });
    } else {
      res.json({
        ok: true,
        message: 'í•´ë‹¹ ë‹¨ì›ì˜ AI ì¶”ì²œ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤'
      });
    }

  } catch (error) {
    console.error('AI ê³¼ì œ ë³µìŠµ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// AI ì¶”ì²œê³¼ì œ ëª©ë¡ ì¡°íšŒ API (ê´€ë¦¬ì ì „ìš©)
app.get('/api/admin/ai-tasks', async (req, res) => {
  try {
    const { key } = req.query;

    // ê´€ë¦¬ì í‚¤ í™•ì¸
    if (key !== ADMIN_KEY) {
      return res.status(403).json({
        ok: false,
        message: 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ëª¨ë“  UserProgressì—ì„œ AI ì¶”ì²œê³¼ì œë§Œ ì¶”ì¶œ
    const allProgress = await UserProgress.find({});

    const aiTasksList = [];

    for (const progress of allProgress) {
      const aiTasks = progress.studyRoom?.assignedTasks?.filter(t => t.isAI) || [];

      // User ëª¨ë¸ì—ì„œ academyName ê°€ì ¸ì˜¤ê¸°
      const user = await User.findOne({ grade: progress.grade, name: progress.name });
      const academyName = user?.academyName || progress.school || '-';

      aiTasks.forEach(task => {
        aiTasksList.push({
          grade: progress.grade,
          name: progress.name,
          school: progress.school || '-',
          academyName: academyName,
          taskTitle: task.title,
          series: task.series,
          field: task.field || task.domain,
          subject: task.subject,
          assignedAt: task.assignedAt,
          status: task.status,
          unitId: task.id || task.unitId
        });
      });
    }

    // ë¶€ì—¬ì‹œê°„ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
    aiTasksList.sort((a, b) => {
      const dateA = new Date(a.assignedAt || 0);
      const dateB = new Date(b.assignedAt || 0);
      return dateB - dateA;
    });

    res.json({
      ok: true,
      tasks: aiTasksList,
      total: aiTasksList.length
    });

  } catch (error) {
    console.error('AI ì¶”ì²œê³¼ì œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ë°ì´í„° ê°œìˆ˜ í™•ì¸ API (ê´€ë¦¬ì ì „ìš©)
app.get('/api/check-data-count', async (req, res) => {
  try {
    const { key } = req.query;

    // ê´€ë¦¬ì í‚¤ í™•ì¸
    if (key !== ADMIN_KEY) {
      return res.status(403).json({
        success: false,
        message: 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    const usersCount = await User.countDocuments({});
    const logsCount = await LearningLog.countDocuments({});

    let progressCount = 0;
    try {
      progressCount = await UserProgress.countDocuments({});
    } catch (e) {
      console.log('UserProgress ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', e.message);
    }

    res.json({
      success: true,
      users: usersCount,
      learningLogs: logsCount,
      userProgress: progressCount,
      total: usersCount + logsCount + progressCount
    });

  } catch (err) {
    console.error('ë°ì´í„° ê°œìˆ˜ í™•ì¸ ì—ëŸ¬:', err);
    res.status(500).json({
      success: false,
      message: 'ë°ì´í„° í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message
    });
  }
});

// ì „ì²´ ë°ì´í„° ì‚­ì œ API (ê´€ë¦¬ì ì „ìš©)
app.post('/api/delete-all-data', async (req, res) => {
  try {
    const { key } = req.body;

    // ê´€ë¦¬ì í‚¤ í™•ì¸
    if (key !== ADMIN_KEY) {
      return res.status(403).json({
        success: false,
        message: 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ëª¨ë“  íšŒì› ì‚­ì œ
    const usersResult = await User.deleteMany({});

    // ëª¨ë“  í•™ìŠµ ê¸°ë¡ ì‚­ì œ
    const logsResult = await LearningLog.deleteMany({});

    // UserProgress ì»¬ë ‰ì…˜ë„ ì‚­ì œ (ìˆë‹¤ë©´)
    let progressResult = { deletedCount: 0 };
    try {
      progressResult = await UserProgress.deleteMany({});
    } catch (e) {
      console.log('UserProgress ì‚­ì œ ì¤‘ ì˜¤ë¥˜ (ì»¬ë ‰ì…˜ì´ ì—†ì„ ìˆ˜ ìˆìŒ):', e.message);
    }

    console.log(`ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ: íšŒì› ${usersResult.deletedCount}ëª…, í•™ìŠµê¸°ë¡ ${logsResult.deletedCount}ê°œ, ì§„ë„ ${progressResult.deletedCount}ê°œ`);

    res.json({
      success: true,
      deletedUsers: usersResult.deletedCount,
      deletedRecords: logsResult.deletedCount,
      deletedProgress: progressResult.deletedCount
    });

  } catch (err) {
    console.error('ì „ì²´ ë°ì´í„° ì‚­ì œ ì—ëŸ¬:', err);
    res.status(500).json({
      success: false,
      message: 'ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message
    });
  }
});

// í•™ìŠµì‹¤ ë°ì´í„° ì‚­ì œ API
app.post('/api/user-progress/clear-study-room', async (req, res) => {
  try {
    const { grade, name } = req.body;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'grade, nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    const progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      return res.json({
        ok: true,
        message: 'í•´ë‹¹ í•™ìƒì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // í•™ìŠµì‹¤ ë°ì´í„° ì´ˆê¸°í™”
    progress.studyRoom = {
      assignedTasks: []
    };

    await progress.save();

    res.json({
      ok: true,
      message: 'í•™ìŠµì‹¤ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  } catch (error) {
    console.error('í•™ìŠµì‹¤ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// ì¢…í•©ë¦¬í¬íŠ¸ ë±ƒì§€ ë°ì´í„° ì €ì¥
app.post('/api/user-progress/report-badge', async (req, res) => {
  try {
    const { grade, name, radarAvg, totalProgress } = req.body;

    if (!grade || !name || radarAvg === undefined || totalProgress === undefined) {
      return res.status(400).json({
        ok: false,
        message: 'grade, name, radarAvg, totalProgressê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    let progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      progress = new UserProgress({ grade, name });
    }

    // ì¢…í•©ë¦¬í¬íŠ¸ ë±ƒì§€ ë°ì´í„° ì—…ë°ì´íŠ¸
    progress.reportBadge = {
      radarAvg: Number(radarAvg),
      totalProgress: Number(totalProgress),
      lastUpdated: new Date()
    };

    await progress.save();

    res.json({
      ok: true,
      message: 'ì¢…í•©ë¦¬í¬íŠ¸ ë±ƒì§€ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: progress.reportBadge
    });
  } catch (error) {
    console.error('ì¢…í•©ë¦¬í¬íŠ¸ ë±ƒì§€ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// ë©”ë‰´ ì™„ë£Œ ìƒíƒœ ì €ì¥
app.post('/api/user-progress/menu-completion', async (req, res) => {
  try {
    const { grade, name, completionData } = req.body;

    if (!grade || !name || !completionData) {
      return res.status(400).json({
        ok: false,
        message: 'grade, name, completionDataê°€ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    let progress = await UserProgress.findOne({ grade, name });

    if (!progress) {
      progress = new UserProgress({ grade, name });
    }

    // ë©”ë‰´ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
    progress.menuCompletion = new Map(Object.entries(completionData));

    await progress.save();

    res.json({
      ok: true,
      message: 'ë©”ë‰´ ì™„ë£Œ ìƒíƒœê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: progress
    });
  } catch (error) {
    console.error('ë©”ë‰´ ì™„ë£Œ ìƒíƒœ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

/* ====================================
 * âœ… ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • API
 * ==================================== */

// ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • ìŠ¤í‚¤ë§ˆ
const autoTaskSettingsSchema = new mongoose.Schema({
  grade: { type: String, required: true },
  name: { type: String, required: true },
  series: [{ type: String }],        // ì„ íƒëœ ì‹œë¦¬ì¦ˆ ('up', 'fit')
  days: [{ type: String }],          // ì„ íƒëœ ìš”ì¼ (0~6, 'everyday')
  domains: [{ type: String }], // ì„ íƒëœ ë¶„ì•¼ ë°°ì—´ (['all'], ['science', 'social'], etc.)
  taskCount: { type: Number, default: 3 }, // ê³¼ì œ ê°œìˆ˜
  status: { type: String, enum: ['running', 'paused', 'stopped'], default: 'stopped' },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
});
autoTaskSettingsSchema.index({ grade: 1, name: 1 }, { unique: true });
const AutoTaskSettings = mongoose.model('AutoTaskSettings', autoTaskSettingsSchema);

// ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • ì¡°íšŒ
app.get('/api/auto-task-settings', async (req, res) => {
  try {
    const { grade, name } = req.query;
    if (!grade || !name) {
      return res.status(400).json({ ok: false, message: 'grade, nameì´ í•„ìš”í•©ë‹ˆë‹¤' });
    }

    const settings = await AutoTaskSettings.findOne({ grade, name });
    res.json({ ok: true, settings: settings || null });
  } catch (error) {
    console.error('ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ ok: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' });
  }
});

// ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • ì €ì¥
app.post('/api/auto-task-settings', async (req, res) => {
  try {
    const { grade, name, settings } = req.body;
    if (!grade || !name || !settings) {
      return res.status(400).json({ ok: false, message: 'grade, name, settingsê°€ í•„ìš”í•©ë‹ˆë‹¤' });
    }

    // ê¸°ì¡´ ì„¤ì • ì¡°íšŒ (ì„¤ì • ë³€ê²½ ì—¬ë¶€ í™•ì¸ìš©)
    const existingSettings = await AutoTaskSettings.findOne({ grade, name });

    // ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì‹œë¦¬ì¦ˆ, ìš”ì¼, ê°œìˆ˜ ë³€ê²½ ì‹œ)
    const settingsChanged = existingSettings && (
      JSON.stringify(existingSettings.series?.sort()) !== JSON.stringify(settings.series?.sort()) ||
      JSON.stringify(existingSettings.days?.sort()) !== JSON.stringify(settings.days?.sort()) ||
      existingSettings.taskCount !== settings.taskCount
    );

    // ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ê¸°ì¡´ ìë™ë¶€ì—¬ ê³¼ì œ ì‚­ì œ
    if (settingsChanged || settings.status === 'running') {
      console.log(`ğŸ—‘ï¸ [${grade} ${name}] ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • ë³€ê²½ - ê¸°ì¡´ ìë™ë¶€ì—¬ ê³¼ì œ ì‚­ì œ`);

      // í•™ìŠµì‹¤ì—ì„œ isAutoAssigned === trueì¸ ê³¼ì œë§Œ ì‚­ì œ (ì¼ë°˜ ê³¼ì œëŠ” ìœ ì§€)
      const userProgress = await UserProgress.findOne({ grade, name });
      if (userProgress?.studyRoom?.assignedTasks) {
        const manualTasks = userProgress.studyRoom.assignedTasks.filter(task => !task.isAutoAssigned);
        const deletedCount = userProgress.studyRoom.assignedTasks.length - manualTasks.length;

        await UserProgress.updateOne(
          { grade, name },
          { $set: { 'studyRoom.assignedTasks': manualTasks } }
        );

        console.log(`  âœ… ${deletedCount}ê°œ ìë™ë¶€ì—¬ ê³¼ì œ ì‚­ì œ ì™„ë£Œ`);
      }
    }

    const updatedSettings = await AutoTaskSettings.findOneAndUpdate(
      { grade, name },
      {
        ...settings,
        grade,
        name,
        updatedAt: new Date()
      },
      { upsert: true, new: true }
    );

    // "ì‹œì‘" ìƒíƒœì´ë©´ ë°”ë¡œ ìë™ê³¼ì œë¶€ì—¬ ì‹¤í–‰
    if (settings.status === 'running') {
      console.log(`â–¶ï¸ [${grade} ${name}] ìë™ê³¼ì œë¶€ì—¬ ì¦‰ì‹œ ì‹¤í–‰`);
      // ë¹„ë™ê¸°ë¡œ ìë™ê³¼ì œ ë¶€ì—¬ ì‹¤í–‰ (ì‘ë‹µì€ ë¨¼ì € ë³´ëƒ„)
      executeAutoTaskForStudent(grade, name, updatedSettings).catch(err => {
        console.error(`âŒ [${grade} ${name}] ìë™ê³¼ì œë¶€ì—¬ ì‹¤í–‰ ì˜¤ë¥˜:`, err);
      });
    }

    res.json({ ok: true, settings: updatedSettings });
  } catch (error) {
    console.error('ìë™ê³¼ì œë¶€ì—¬ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ ok: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' });
  }
});

/* ====================================
 * âœ… AI ìë™ ê³¼ì œ ë¶€ì—¬ ì‹œìŠ¤í…œ
 * ==================================== */

// AI ê³¼ì œ ìŠ¤ì¼€ì¤„ ìŠ¤í‚¤ë§ˆ
const aiTaskScheduleSchema = new mongoose.Schema({
  studentGrade: { type: String, required: true },
  studentName: { type: String, required: true },
  unitId: { type: String, required: true },
  unitTitle: { type: String, required: true },
  seriesName: { type: String, required: true },
  fieldName: { type: String, required: true },
  subjectName: { type: String, required: true },
  grade: { type: String, required: true }, // ë“±ê¸‰: excellent, good, average, encourage
  gradeText: { type: String, required: true }, // ë“±ê¸‰ í…ìŠ¤íŠ¸: ìš°ìˆ˜, ì–‘í˜¸, ë³´í†µ, ê²©ë ¤
  avgScore: { type: Number, required: true }, // í‰ê·  ì ìˆ˜
  completedAt: { type: Date, required: true }, // í•™ìŠµ ì™„ë£Œ ë‚ ì§œ
  scheduledDate: { type: Date, required: true }, // ë¶€ì—¬ ì˜ˆì • ë‚ ì§œ
  assignedAt: { type: Date }, // ì‹¤ì œ ë¶€ì—¬ëœ ë‚ ì§œ
  status: {
    type: String,
    enum: ['pending', 'assigned', 'completed'],
    default: 'pending'
  },
  createdAt: { type: Date, default: Date.now }
});

const AITaskSchedule = mongoose.model('AITaskSchedule', aiTaskScheduleSchema);

// ë“±ê¸‰ íŒì • í•¨ìˆ˜ (menu.htmlê³¼ ë™ì¼í•œ ë¡œì§)
// AI ì¶”ì²œê³¼ì œ ë¶€ì—¬ ì‹œê°„ ì„¤ì •
function getGradeInfo(avgScore) {
  if (avgScore >= 9) {
    return { grade: 'excellent', text: 'ìš°ìˆ˜', hours: 0 }; // ìš°ìˆ˜ëŠ” ë¶€ì—¬ ì•ˆ í•¨
  } else if (avgScore >= 8) {
    return { grade: 'good', text: 'ì–‘í˜¸', hours: 336 }; // ì–‘í˜¸: 14ì¼(336ì‹œê°„) í›„
  } else if (avgScore >= 7) {
    return { grade: 'average', text: 'ë³´í†µ', hours: 168 }; // ë³´í†µ: 7ì¼(168ì‹œê°„) í›„
  } else {
    return { grade: 'encourage', text: 'ê²©ë ¤', hours: 72 }; // ê²©ë ¤: 3ì¼(72ì‹œê°„) í›„
  }
}

// [DEPRECATED] AI ê³¼ì œ ìŠ¤ì¼€ì¤„ ìƒì„±/ì—…ë°ì´íŠ¸ API
// ì´ì œ assignAITasksDaily()ê°€ LearningLog í…Œì´ë¸”ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì½ì–´ ê³¼ì œë¥¼ ë¶€ì—¬í•¨
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë” ì´ìƒ ì´ APIë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
app.post('/api/ai-task/create-schedule', async (req, res) => {
  try {
    const {
      studentGrade,
      studentName,
      unitId,
      unitTitle,
      seriesName,
      fieldName,
      subjectName,
      avgScore,
      completedAt
    } = req.body;

    // ë“±ê¸‰ íŒì •
    const gradeInfo = getGradeInfo(avgScore);

    // ìš°ìˆ˜ ë“±ê¸‰ì€ ìŠ¤ì¼€ì¤„ ìƒì„± ì•ˆ í•¨
    if (gradeInfo.grade === 'excellent') {
      return res.json({
        ok: true,
        message: 'ìš°ìˆ˜ ë“±ê¸‰ì€ ì¬í•™ìŠµì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤',
        schedule: null
      });
    }

    // ë¶€ì—¬ ì˜ˆì • ë‚ ì§œ ê³„ì‚° - í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (ë³µìŠµ ì™„ë£Œ ì‹œì  = ì§€ê¸ˆ)
    const now = new Date();
    const scheduledDate = new Date(now);
    // ë“±ê¸‰ë³„ ì¼ì • ì ìš©: ê²©ë ¤ 24ì‹œê°„, ë³´í†µ 48ì‹œê°„, ì–‘í˜¸ 72ì‹œê°„
    scheduledDate.setHours(scheduledDate.getHours() + gradeInfo.hours);

    // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ í™•ì¸ (ê°™ì€ í•™ìƒ, ê°™ì€ ë‹¨ì›)
    let schedule = await AITaskSchedule.findOne({
      studentGrade,
      studentName,
      unitId,
      status: { $in: ['pending', 'assigned'] }
    });

    if (schedule) {
      // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸
      schedule.grade = gradeInfo.grade;
      schedule.gradeText = gradeInfo.text;
      schedule.avgScore = avgScore;
      schedule.completedAt = now;  // í˜„ì¬ ì‹œê°„ (ë³µìŠµ ì™„ë£Œ ì‹œì )
      schedule.scheduledDate = scheduledDate;
      schedule.status = 'pending';
      schedule.assignedAt = null;
      await schedule.save();
    } else {
      // ìƒˆ ìŠ¤ì¼€ì¤„ ìƒì„±
      schedule = await AITaskSchedule.create({
        studentGrade,
        studentName,
        unitId,
        unitTitle,
        seriesName,
        fieldName,
        subjectName,
        grade: gradeInfo.grade,
        gradeText: gradeInfo.text,
        avgScore,
        completedAt: now,  // í˜„ì¬ ì‹œê°„ (ë³µìŠµ ì™„ë£Œ ì‹œì )
        scheduledDate
      });
    }

    res.json({
      ok: true,
      message: 'AI ê³¼ì œ ìŠ¤ì¼€ì¤„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
      schedule
    });

  } catch (error) {
    console.error('AI ê³¼ì œ ìŠ¤ì¼€ì¤„ ìƒì„± ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      error: error.message
    });
  }
});

// ë§¤ì¼ ìì • ì‹¤í–‰: AI ê³¼ì œ ìë™ ë¶€ì—¬ (LearningLog í…Œì´ë¸” ê¸°ì¤€)
// - ìµœì¢…ì™„ë£Œ ì‹œê°„ê³¼ ìµœì¢…ë“±ê¸‰ì„ ê¸°ì¤€ìœ¼ë¡œ AI ì¶”ì²œê³¼ì œ ë¶€ì—¬
// - ê²©ë ¤: 24ì‹œê°„ í›„, ë³´í†µ: 48ì‹œê°„ í›„, ì–‘í˜¸: 72ì‹œê°„ í›„, ìš°ìˆ˜: ë¶€ì—¬ ì•ˆ í•¨
async function assignAITasksDaily() {
  try {
    console.log('ğŸ¤– [NEW] AI ìë™ ê³¼ì œ ë¶€ì—¬ ì‹œì‘ (LearningLog ê¸°ì¤€):', new Date().toISOString());

    const now = new Date();

    // ëª¨ë“  LearningLog ì¡°íšŒ (completedëœ ê²ƒë§Œ)
    const allLogs = await LearningLog.find({ completed: true, deleted: { $ne: true } });
    console.log(`ğŸ“š ì¡°íšŒëœ í•™ìŠµ ë¡œê·¸ ìˆ˜: ${allLogs.length}ê°œ`);

    // í•™ìƒë³„ë¡œ ê·¸ë£¹í™” (grade + name ì¡°í•©)
    const studentLogsMap = {};
    for (const log of allLogs) {
      const studentKey = `${log.grade}::${log.name}`;
      if (!studentLogsMap[studentKey]) {
        studentLogsMap[studentKey] = {
          grade: log.grade,
          name: log.name,
          logs: []
        };
      }
      studentLogsMap[studentKey].logs.push(log);
    }

    const studentKeys = Object.keys(studentLogsMap);
    console.log(`ğŸ‘¥ ì²˜ë¦¬í•  í•™ìƒ ìˆ˜: ${studentKeys.length}ëª…`);

    for (const studentKey of studentKeys) {
      const studentData = studentLogsMap[studentKey];
      const { grade, name, logs } = studentData;

      if (!logs || logs.length === 0) continue;

      // ë‹¨ì›ë³„ë¡œ ìµœì‹  ê¸°ë¡ë§Œ ì¶”ì¶œ (ìµœì¢…ì™„ë£Œ ì‹œê°„ = timestamp or aiReviewCompletedAt ì¤‘ ìµœì‹ )
      const unitLatestLogs = {};

      for (const log of logs) {
        let unitId = log.unit;
        if (!unitId || !log.radar) continue;

        // ğŸ”§ unit ì½”ë“œ ì •ê·œí™”: world2_XX â†’ world_4X
        // LearningLogì— world2_01 ê°™ì€ ì½”ë“œê°€ ì €ì¥ë˜ì–´ ìˆì§€ë§Œ, ì‹¤ì œ íŒŒì¼ì€ world_41.html
        // (ì¸ë¬¼ì€ people2_XX.html íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ë¯€ë¡œ ë³€í™˜í•˜ì§€ ì•ŠìŒ)
        if (unitId.startsWith('world2_')) {
          const num = parseInt(unitId.replace('world2_', ''), 10);
          unitId = `world_${num + 40}`;
          console.log(`ğŸ”„ [${name}] ì½”ë“œ ë³€í™˜: ${log.unit} â†’ ${unitId}`);
        }

        // ìµœì¢…ì™„ë£Œ ì‹œê°„ = í•™ìŠµ ì™„ë£Œ ì‹œê°„ (timestamp) ê¸°ì¤€ìœ¼ë¡œë§Œ ê³„ì‚°
        // í•™ìŠµ ê¸°ë¡ ëª©ë¡ì—ì„œ ë³´ì—¬ì£¼ëŠ” ì˜ˆì • ì‹œê°„ê³¼ ë™ì¼í•˜ê²Œ ì ìš©
        const finalCompletedAt = log.timestamp ? new Date(log.timestamp) : new Date(0);

        // í‰ê·  ì ìˆ˜ ê³„ì‚°
        const scores = [
          log.radar.literal || 0,
          log.radar.structural || 0,
          log.radar.lexical || 0,
          log.radar.inferential || 0,
          log.radar.critical || 0
        ];
        const avgScore = scores.reduce((a, b) => a + b, 0) / 5;

        // ë‹¨ì›ë³„ ìµœì‹  ê¸°ë¡ë§Œ ìœ ì§€ (timestamp ê¸°ì¤€)
        const existingEntry = unitLatestLogs[unitId];
        if (!existingEntry || finalCompletedAt.getTime() > existingEntry.finalCompletedAt.getTime()) {
          unitLatestLogs[unitId] = {
            unitId,
            originalUnit: log.unit, // ì›ë³¸ unit ì½”ë“œ ë³´ì¡´ (title ìƒì„±ìš©)
            avgScore,
            finalCompletedAt,
            series: log.series
          };
        }
      }

      // UserProgress ì¡°íšŒ
      let progress = await UserProgress.findOne({ grade, name });
      if (!progress) {
        progress = new UserProgress({
          grade,
          name,
          studyRoom: { assignedTasks: [] }
        });
      }

      // ê¸°ì¡´ í•™ìŠµì‹¤ ê³¼ì œ ëª©ë¡
      const existingTasks = progress.studyRoom?.assignedTasks || [];
      // ê¸°ì¡´ ê³¼ì œì˜ unitId ì¶”ì¶œ (./BRAINUP/science/bio_02.html -> bio_02, ë˜ëŠ” bio_02 ê·¸ëŒ€ë¡œ)
      const existingUnitIds = new Set(existingTasks.map(t => {
        const taskId = t.unitId || t.id;
        // ./BRAINUP/xxx/yyy.html í˜•ì‹ì—ì„œ unit ì½”ë“œ ì¶”ì¶œ
        const match = taskId.match(/([a-z]+\d*_\d+)\.html$/i);
        if (match) return match[1];
        // ì´ë¯¸ unit ì½”ë“œ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        return taskId;
      }));

      let assignedCount = 0;

      // ë””ë²„ê·¸: ê¸°ì¡´ í•™ìŠµì‹¤ ê³¼ì œ ID ì¶œë ¥
      console.log(`ğŸ” [${name}] ê¸°ì¡´ í•™ìŠµì‹¤ ê³¼ì œ IDs:`, Array.from(existingUnitIds));

      // ê° ë‹¨ì›ì˜ ìµœì¢…ë“±ê¸‰ê³¼ ìµœì¢…ì™„ë£Œ ì‹œê°„ í™•ì¸
      for (const unitId in unitLatestLogs) {
        const unitInfo = unitLatestLogs[unitId];
        const { avgScore, finalCompletedAt, series } = unitInfo;

        // ë“±ê¸‰ íŒì •
        const gradeInfo = getGradeInfo(avgScore);

        // ìš°ìˆ˜ ë“±ê¸‰ì€ AI ê³¼ì œ ë¶€ì—¬ ì•ˆ í•¨
        if (gradeInfo.grade === 'excellent') {
          console.log(`â­ï¸ [${name}] ${unitId}: ìš°ìˆ˜ ë“±ê¸‰ â†’ ìŠ¤í‚µ`);
          continue;
        }

        // ì´ë¯¸ í•™ìŠµì‹¤ì— ìˆìœ¼ë©´ ìŠ¤í‚µ
        if (existingUnitIds.has(unitId)) {
          console.log(`â­ï¸ [${name}] ${unitId}: ì´ë¯¸ í•™ìŠµì‹¤ì— ìˆìŒ â†’ ìŠ¤í‚µ`);
          continue;
        }

        // ë“±ê¸‰ë³„ ëŒ€ê¸° ì‹œê°„ ê³„ì‚°
        const waitHours = gradeInfo.hours;
        const assignableAt = new Date(finalCompletedAt.getTime() + waitHours * 60 * 60 * 1000);

        // í˜„ì¬ ì‹œê°„ì´ ë¶€ì—¬ ê°€ëŠ¥ ì‹œê°„ì„ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
        console.log(`ğŸ• [${name}] ${unitId}: ë“±ê¸‰=${gradeInfo.text}, ëŒ€ê¸°=${waitHours}ì‹œê°„, ë¶€ì—¬ê°€ëŠ¥ì‹œê°„=${assignableAt.toISOString()}, í˜„ì¬=${now.toISOString()}`);
        if (now >= assignableAt) {
          // ë‹¨ì› ì •ë³´ ì¶”ì¶œ (ì›ë³¸ unit ì½”ë“œì—ì„œ íŒŒì‹± - title ìƒì„±ìš©)
          const originalUnit = unitInfo.originalUnit || unitId;
          const parts = originalUnit.split('_');
          const subjectCode = parts[0];
          const unitNumber = parts[1] ? parseInt(parts[1], 10) : 1;

          // ê³¼ëª©ëª… ë§¤í•‘ (world1, world2ë¥¼ êµ¬ë¶„í•˜ì—¬ ì„¸ê³„ë¬¸í•™1, ì„¸ê³„ë¬¸í•™2ë¡œ í‘œì‹œ)
          const subjectMap = {
            'geo': 'ì§€ë¦¬', 'bio': 'ìƒë¬¼', 'earth': 'ì§€êµ¬ê³¼í•™', 'physics': 'ë¬¼ë¦¬', 'chem': 'í™”í•™',
            'soc': 'ì‚¬íšŒë¬¸í™”', 'law': 'ë²•', 'pol': 'ì •ì¹˜ê²½ì œ',
            'modern': 'í˜„ëŒ€ë¬¸í•™', 'classic': 'ê³ ì „ë¬¸í•™',
            'world1': 'ì„¸ê³„ë¬¸í•™1', 'world2': 'ì„¸ê³„ë¬¸í•™2', 'world': 'ì„¸ê³„ë¬¸í•™1',
            'person1': 'í•œêµ­ì¸ë¬¼', 'person2': 'ì„¸ê³„ì¸ë¬¼', 'people': 'í•œêµ­ì¸ë¬¼',
            'people1': 'í•œêµ­ì¸ë¬¼', 'people2': 'ì„¸ê³„ì¸ë¬¼'
          };
          const subjectName = subjectMap[subjectCode] || subjectCode;

          // ë¶„ì•¼ëª… ë§¤í•‘
          const fieldMap = {
            'geo': 'ì‚¬íšŒ', 'soc': 'ì‚¬íšŒ', 'law': 'ì‚¬íšŒ', 'pol': 'ì‚¬íšŒ',
            'bio': 'ê³¼í•™', 'earth': 'ê³¼í•™', 'physics': 'ê³¼í•™', 'chem': 'ê³¼í•™',
            'modern': 'í•œêµ­ë¬¸í•™', 'classic': 'í•œêµ­ë¬¸í•™',
            'world1': 'ì„¸ê³„ë¬¸í•™', 'world2': 'ì„¸ê³„ë¬¸í•™', 'world': 'ì„¸ê³„ë¬¸í•™',
            'person1': 'ì¸ë¬¼', 'person2': 'ì¸ë¬¼', 'people': 'ì¸ë¬¼',
            'people1': 'ì¸ë¬¼', 'people2': 'ì¸ë¬¼'
          };
          const fieldName = fieldMap[subjectCode] || 'ê¸°íƒ€';

          // ë‹¨ì›ëª… ìƒì„± (ì›ë³¸ ë‹¨ì›ë²ˆí˜¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©, +40 ë³€í™˜ ì œê±°)
          const unitTitle = `${subjectName} ${unitNumber}`;

          // í•™ìŠµì‹¤ì— ì¶”ê°€
          existingTasks.push({
            id: unitId,
            title: unitTitle,
            series: series || 'BRAINUP',
            field: fieldName,
            subject: subjectName,
            isAI: true,
            assignedAt: now,
            originalGrade: gradeInfo.text // ì›ë˜ ë“±ê¸‰ ê¸°ë¡
          });

          existingUnitIds.add(unitId);
          assignedCount++;

          // ğŸ”¥ LearningLogì—ë„ aiTaskAssignedAt ì €ì¥ (í•™ìŠµ ê¸°ë¡ í…Œì´ë¸”ì— í‘œì‹œ)
          await LearningLog.updateOne(
            { grade, name, unit: unitId },
            { $set: { aiTaskAssignedAt: now } }
          );

          console.log(`âœ… [${name}] AI ê³¼ì œ ë¶€ì—¬: ${unitTitle} (${gradeInfo.text}, ìµœì¢…ì™„ë£Œ: ${finalCompletedAt.toLocaleString('ko-KR')})`);
        }
      }

      if (assignedCount > 0) {
        // UserProgress ì €ì¥
        progress.studyRoom = {
          assignedTasks: existingTasks,
          lastAIAssignedAt: now
        };
        await progress.save();

        console.log(`ğŸ‰ ${name} í•™ìƒì—ê²Œ ${assignedCount}ê°œ AI ê³¼ì œ ë¶€ì—¬ ì™„ë£Œ`);
      }
    }

    console.log('ğŸ¤– [NEW] AI ìë™ ê³¼ì œ ë¶€ì—¬ ì™„ë£Œ:', new Date().toISOString());

  } catch (error) {
    console.error('âŒ AI ìë™ ê³¼ì œ ë¶€ì—¬ ì˜¤ë¥˜:', error);
  }
}

// (ê¸°ì¡´ AI ê³¼ì œ cron ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ì´ë¯¸ ìƒë‹¨ì— êµ¬í˜„ë˜ì–´ ìˆìŒ)

// ì„œë²„ ì‹œì‘ ì‹œ í•œ ë²ˆ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš© - í”„ë¡œë•ì…˜ì—ì„œëŠ” ì£¼ì„ ì²˜ë¦¬)
// assignAITasksDaily();

// AI ê³¼ì œ title ì¡°íšŒ API (ë””ë²„ê·¸ìš©)
app.get('/api/debug-ai-task-titles', async (req, res) => {
  try {
    const allProgress = await UserProgress.find({ 'studyRoom.assignedTasks': { $exists: true, $ne: [] } });
    const titles = [];
    for (const progress of allProgress) {
      const tasks = progress.studyRoom?.assignedTasks || [];
      for (const task of tasks) {
        if (task.isAI) {
          titles.push({ userId: progress.userId, title: task.title, taskId: task.taskId });
        }
      }
    }
    res.json({ ok: true, count: titles.length, titles });
  } catch (error) {
    res.status(500).json({ ok: false, message: error.message });
  }
});

// AI ì¶”ì²œê³¼ì œ title ì¼ê´„ ìˆ˜ì • API (ë§ˆì´ê·¸ë ˆì´ì…˜ìš©)
app.post('/api/migrate-ai-task-titles', async (req, res) => {
  try {
    const allProgress = await UserProgress.find({ 'studyRoom.assignedTasks': { $exists: true, $ne: [] } });

    let updatedCount = 0;
    let taskCount = 0;

    for (const progress of allProgress) {
      const tasks = progress.studyRoom?.assignedTasks || [];
      let modified = false;

      for (const task of tasks) {
        if (!task.isAI) continue;

        const oldTitle = task.title || '';
        let newTitle = oldTitle;

        // "ì„¸ê³„ë¬¸í•™1 01" â†’ "ì„¸ê³„ë¬¸í•™1 1" (ì•ì— 0 ì œê±°)
        // "ì„¸ê³„ë¬¸í•™ 01" â†’ "ì„¸ê³„ë¬¸í•™1 1"
        const worldMatch1 = oldTitle.match(/^ì„¸ê³„ë¬¸í•™1?\s+0*(\d+)$/);
        if (worldMatch1) {
          const num = parseInt(worldMatch1[1], 10);
          if (num >= 1 && num <= 40) {
            newTitle = `ì„¸ê³„ë¬¸í•™1 ${num}`;
          } else if (num >= 41 && num <= 80) {
            newTitle = `ì„¸ê³„ë¬¸í•™2 ${num - 40}`;
          }
        }

        // "ì„¸ê³„ë¬¸í•™2 01" â†’ "ì„¸ê³„ë¬¸í•™2 1"
        const worldMatch2 = oldTitle.match(/^ì„¸ê³„ë¬¸í•™2\s+0*(\d+)$/);
        if (worldMatch2) {
          const num = parseInt(worldMatch2[1], 10);
          newTitle = `ì„¸ê³„ë¬¸í•™2 ${num}`;
        }

        // "í•œêµ­ì¸ë¬¼ 01" â†’ "í•œêµ­ì¸ë¬¼ 1"
        const personMatch1 = oldTitle.match(/^í•œêµ­ì¸ë¬¼\s+0*(\d+)$/);
        if (personMatch1) {
          const num = parseInt(personMatch1[1], 10);
          newTitle = `í•œêµ­ì¸ë¬¼ ${num}`;
        }

        // "ì„¸ê³„ì¸ë¬¼ 01" â†’ "ì„¸ê³„ì¸ë¬¼ 1"
        const personMatch2 = oldTitle.match(/^ì„¸ê³„ì¸ë¬¼\s+0*(\d+)$/);
        if (personMatch2) {
          const num = parseInt(personMatch2[1], 10);
          newTitle = `ì„¸ê³„ì¸ë¬¼ ${num}`;
        }

        // "ì¸ë¬¼ 41" â†’ "ì„¸ê³„ì¸ë¬¼ 1" (people_41 í˜•ì‹)
        const personMatch3 = oldTitle.match(/^ì¸ë¬¼\s+(\d+)$/);
        if (personMatch3) {
          const num = parseInt(personMatch3[1], 10);
          if (num >= 41) {
            newTitle = `ì„¸ê³„ì¸ë¬¼ ${num - 40}`;
          } else {
            newTitle = `í•œêµ­ì¸ë¬¼ ${num}`;
          }
        }

        // "ì§€ë¦¬ 01ë‹¨ì›" â†’ "ì§€ë¦¬ 1" (ë‹¨ì› ì œê±° + 0 ì œê±°)
        const unitMatch = oldTitle.match(/^(.+?)\s+0*(\d+)ë‹¨ì›$/);
        if (unitMatch) {
          const subject = unitMatch[1];
          const num = parseInt(unitMatch[2], 10);
          newTitle = `${subject} ${num}`;
        }

        // "people1 1" â†’ "í•œêµ­ì¸ë¬¼ 1"
        const people1Match = oldTitle.match(/^people1\s+(\d+)$/);
        if (people1Match) {
          const num = parseInt(people1Match[1], 10);
          newTitle = `í•œêµ­ì¸ë¬¼ ${num}`;
        }

        // "people2 1" â†’ "ì„¸ê³„ì¸ë¬¼ 1"
        const people2Match = oldTitle.match(/^people2\s+(\d+)$/);
        if (people2Match) {
          const num = parseInt(people2Match[1], 10);
          newTitle = `ì„¸ê³„ì¸ë¬¼ ${num}`;
        }

        if (newTitle !== oldTitle) {
          console.log(`ğŸ”„ title ë³€í™˜: "${oldTitle}" â†’ "${newTitle}"`);
          task.title = newTitle;
          modified = true;
          taskCount++;
        }
      }

      if (modified) {
        await progress.save();
        updatedCount++;
      }
    }

    res.json({ ok: true, message: `${updatedCount}ëª…ì˜ ${taskCount}ê°œ AI ê³¼ì œ titleì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.` });
  } catch (error) {
    console.error('AI ê³¼ì œ title ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
    res.status(500).json({ ok: false, message: error.message });
  }
});

// AI ê³¼ì œ ìŠ¤ì¼€ì¤„ ì¡°íšŒ API (ê´€ë¦¬ììš©)
app.get('/api/ai-task/schedules', async (req, res) => {
  try {
    const { studentGrade, studentName, status } = req.query;

    const filter = {};
    if (studentGrade) filter.studentGrade = studentGrade;
    if (studentName) filter.studentName = studentName;
    if (status) filter.status = status;

    const schedules = await AITaskSchedule.find(filter).sort({ scheduledDate: 1 });

    res.json({
      ok: true,
      schedules
    });
  } catch (error) {
    console.error('AI ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// í•™ìƒì˜ ë§ˆì§€ë§‰ AI ê³¼ì œ ë¶€ì—¬ ì‹œê°„ ì¡°íšŒ
app.get('/api/ai-task/last-assigned', async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: 'gradeì™€ nameì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }

    // âœ… ìºì‹œ í™•ì¸
    const cacheKey = getCacheKey('last-assigned', { grade, name });
    const cached = getCache(cacheKey);
    if (cached) {
      return res.json(cached);
    }

    const progress = await UserProgress.findOne({ grade, name }).lean();

    const result = {
      ok: true,
      lastAIAssignedAt: progress?.studyRoom?.lastAIAssignedAt || null
    };

    // âœ… ìºì‹œ ì €ì¥
    setCache(cacheKey, result);

    res.json(result);

  } catch (error) {
    console.error('ë§ˆì§€ë§‰ AI ë¶€ì—¬ ì‹œê°„ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// AI ê³¼ì œ ìˆ˜ë™ ë¶€ì—¬ API (í…ŒìŠ¤íŠ¸ìš©)
app.post('/api/ai-task/manual-assign', async (req, res) => {
  try {
    await assignAITasksDaily();
    res.json({
      ok: true,
      message: 'AI ê³¼ì œ ë¶€ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  } catch (error) {
    console.error('ìˆ˜ë™ AI ê³¼ì œ ë¶€ì—¬ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// AI ìŠ¤ì¼€ì¤„ ì´ˆê¸°í™” API (í…ŒìŠ¤íŠ¸ìš© - assignedë¥¼ pendingìœ¼ë¡œ ë³€ê²½)
app.post('/api/ai-task/reset-schedules', async (req, res) => {
  try {
    const { studentGrade, studentName } = req.body;

    const filter = {};
    if (studentGrade) filter.studentGrade = studentGrade;
    if (studentName) filter.studentName = studentName;
    filter.status = 'assigned';

    const result = await AITaskSchedule.updateMany(filter, {
      status: 'pending',
      assignedAt: null
    });

    res.json({
      ok: true,
      message: `${result.modifiedCount}ê°œ ìŠ¤ì¼€ì¤„ì´ pendingìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`,
      count: result.modifiedCount
    });
  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// ========================================
// ìë™ ê³¼ì œ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ API
// ========================================

// 1. ìë™ ê³¼ì œ ìŠ¤ì¼€ì¤„ ì €ì¥ (POST)
app.post('/api/auto-task-schedule', async (req, res) => {
  try {
    const { studentIds, subjects, days, taskCount } = req.body;

    console.log('ğŸ“¥ [POST] /api/auto-task-schedule ìš”ì²­:', { studentIds, subjects, days, taskCount });

    // ì…ë ¥ ê²€ì¦
    if (!studentIds || !Array.isArray(studentIds) || studentIds.length === 0) {
      return res.status(400).json({ success: false, message: 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.' });
    }
    if (!subjects || !Array.isArray(subjects) || subjects.length === 0) {
      return res.status(400).json({ success: false, message: 'ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.' });
    }
    if (!days || !Array.isArray(days) || days.length === 0) {
      return res.status(400).json({ success: false, message: 'ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.' });
    }
    if (!taskCount || taskCount < 1 || taskCount > 5) {
      return res.status(400).json({ success: false, message: 'ê³¼ì œ ê°œìˆ˜ëŠ” 1~5ê°œ ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.' });
    }

    const results = [];

    // ê° í•™ìƒì—ê²Œ ìŠ¤ì¼€ì¤„ ì¶”ê°€
    for (const student of studentIds) {
      // studentIdëŠ” ì´ì œ { grade, name } ê°ì²´
      const user = await UserProgress.findOne({
        grade: student.grade,
        name: student.name
      });

      if (!user) {
        console.log(`âš ï¸  í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${student.grade} ${student.name}`);
        results.push({ student, success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
        continue;
      }

      // ê³ ìœ  ìŠ¤ì¼€ì¤„ ID ìƒì„±
      const scheduleId = `schedule_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

      // ë‹¤ìŒ ì‹¤í–‰ ì˜ˆì •ì¼ ê³„ì‚°
      const nextScheduledDate = calculateNextScheduledDate(days);

      const newSchedule = {
        scheduleId,
        subjects,
        days: days.map(d => parseInt(d)),
        taskCount: parseInt(taskCount),
        isActive: true,
        createdAt: new Date(),
        lastExecutedAt: null,
        nextScheduledDate
      };

      // ìŠ¤ì¼€ì¤„ ì¶”ê°€
      if (!user.studyRoom) {
        user.studyRoom = { assignedTasks: [], autoTaskSchedules: [] };
      }
      if (!user.studyRoom.autoTaskSchedules) {
        user.studyRoom.autoTaskSchedules = [];
      }

      user.studyRoom.autoTaskSchedules.push(newSchedule);
      await user.save();

      console.log(`âœ… ìŠ¤ì¼€ì¤„ ì €ì¥ ì„±ê³µ: ${student.grade} ${student.name} - ${scheduleId}`);
      results.push({ student, success: true, scheduleId });
    }

    const successCount = results.filter(r => r.success).length;
    const failCount = results.filter(r => !r.success).length;

    res.json({
      success: true,
      message: `ìŠ¤ì¼€ì¤„ ë“±ë¡ ì™„ë£Œ (ì„±ê³µ: ${successCount}ëª…, ì‹¤íŒ¨: ${failCount}ëª…)`,
      results
    });

  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë‹¤ìŒ ì‹¤í–‰ ì˜ˆì •ì¼ ê³„ì‚° í•¨ìˆ˜
function calculateNextScheduledDate(days) {
  const now = new Date();
  const currentDay = now.getDay(); // 0(ì¼) ~ 6(í† )
  const sortedDays = days.map(d => parseInt(d)).sort((a, b) => a - b);

  // ì˜¤ëŠ˜ ì´í›„ ê°€ì¥ ê°€ê¹Œìš´ ìš”ì¼ ì°¾ê¸°
  let nextDay = sortedDays.find(d => d > currentDay);

  // ì—†ìœ¼ë©´ ë‹¤ìŒ ì£¼ ì²« ë²ˆì§¸ ìš”ì¼
  if (nextDay === undefined) {
    nextDay = sortedDays[0];
  }

  const daysUntilNext = nextDay >= currentDay
    ? nextDay - currentDay
    : 7 - currentDay + nextDay;

  const nextDate = new Date(now);
  nextDate.setDate(now.getDate() + daysUntilNext);
  nextDate.setHours(0, 0, 0, 0);

  return nextDate;
}

// 2. íŠ¹ì • í•™ìƒì˜ ìŠ¤ì¼€ì¤„ ëª©ë¡ ì¡°íšŒ (GET)
app.get('/api/auto-task-schedule', async (req, res) => {
  try {
    const { studentId } = req.query;

    if (!studentId) {
      return res.status(400).json({ success: false, message: 'í•™ìƒ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const user = await UserProgress.findOne({
      $or: [{ grade: studentId }, { name: studentId }]
    });

    if (!user) {
      return res.status(404).json({ success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const schedules = user.studyRoom?.autoTaskSchedules || [];

    res.json({
      success: true,
      schedules
    });

  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// 3. ìŠ¤ì¼€ì¤„ ì¼ì‹œì •ì§€/ì¬ê°œ (PATCH)
app.patch('/api/auto-task-schedule/:scheduleId/toggle', async (req, res) => {
  try {
    const { scheduleId } = req.params;
    const { grade, name } = req.body;

    console.log(`ğŸ“¥ [PATCH] /api/auto-task-schedule/${scheduleId}/toggle:`, { grade, name });

    if (!grade || !name) {
      return res.status(400).json({ success: false, message: 'í•™ë…„ê³¼ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const user = await UserProgress.findOne({
      grade: grade,
      name: name
    });

    if (!user) {
      console.log(`âš ï¸  ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${grade} ${name}`);
      return res.status(404).json({ success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const schedule = user.studyRoom?.autoTaskSchedules?.find(s => s.scheduleId === scheduleId);

    if (!schedule) {
      return res.status(404).json({ success: false, message: 'ìŠ¤ì¼€ì¤„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // ìƒíƒœ í† ê¸€
    schedule.isActive = !schedule.isActive;
    await user.save();

    res.json({
      success: true,
      message: schedule.isActive ? 'ìŠ¤ì¼€ì¤„ì´ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìŠ¤ì¼€ì¤„ì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
      isActive: schedule.isActive
    });

  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ í† ê¸€ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// 4. ìŠ¤ì¼€ì¤„ ì‚­ì œ (DELETE)
app.delete('/api/auto-task-schedule/:scheduleId', async (req, res) => {
  try {
    const { scheduleId } = req.params;
    const { grade, name } = req.query;

    console.log(`ğŸ“¥ [DELETE] /api/auto-task-schedule/${scheduleId}:`, { grade, name });

    if (!grade || !name) {
      return res.status(400).json({ success: false, message: 'í•™ë…„ê³¼ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const user = await UserProgress.findOne({
      grade: grade,
      name: name
    });

    if (!user) {
      console.log(`âš ï¸  ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${grade} ${name}`);
      return res.status(404).json({ success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // ìŠ¤ì¼€ì¤„ ì œê±°
    const originalLength = user.studyRoom?.autoTaskSchedules?.length || 0;
    user.studyRoom.autoTaskSchedules = user.studyRoom?.autoTaskSchedules?.filter(
      s => s.scheduleId !== scheduleId
    ) || [];

    const newLength = user.studyRoom.autoTaskSchedules.length;

    if (originalLength === newLength) {
      return res.status(404).json({ success: false, message: 'ìŠ¤ì¼€ì¤„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    await user.save();

    res.json({
      success: true,
      message: 'ìŠ¤ì¼€ì¤„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ğŸ” ë””ë²„ê·¸: ì „ì²´ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
app.get('/api/debug/schedules', async (req, res) => {
  try {
    const allProgress = await UserProgress.find({
      'studyRoom.autoTaskSchedules': { $exists: true, $ne: [] }
    }).select('grade name studyRoom.autoTaskSchedules').lean();

    const result = allProgress.map(p => ({
      student: `${p.grade} ${p.name}`,
      scheduleCount: p.studyRoom?.autoTaskSchedules?.length || 0,
      schedules: p.studyRoom?.autoTaskSchedules || []
    }));

    res.json({
      success: true,
      totalStudents: result.length,
      data: result
    });
  } catch (error) {
    console.error('ë””ë²„ê·¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

// ========================================
// ìë™ ê³¼ì œ ë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ (ë§¤ì¼ 0ì‹œ ì‹¤í–‰)
// ========================================

// ê³¼ëª©ë³„ ì „ì²´ ë‹¨ì› ë§µí•‘
const SUBJECT_UNITS_MAP = {
  'science/bio': Array.from({ length: 80 }, (_, i) => `bio_${String(i + 1).padStart(2, '0')}`),
  'science/geo_earth': Array.from({ length: 80 }, (_, i) => `geo_${String(i + 1).padStart(2, '0')}`),
  'science/physics': Array.from({ length: 80 }, (_, i) => `phy_${String(i + 1).padStart(2, '0')}`),
  'science/chemistry': Array.from({ length: 80 }, (_, i) => `chem_${String(i + 1).padStart(2, '0')}`),
  'social/geo': Array.from({ length: 80 }, (_, i) => `geo_${String(i + 1).padStart(2, '0')}`),
  'social/history': Array.from({ length: 80 }, (_, i) => `history_${String(i + 1).padStart(2, '0')}`),
  'social/politic': Array.from({ length: 80 }, (_, i) => `politic_${String(i + 1).padStart(2, '0')}`),
  'korlit/classic': Array.from({ length: 80 }, (_, i) => `classic_${String(i + 1).padStart(2, '0')}`),
  'korlit/modern': Array.from({ length: 80 }, (_, i) => `modern_${String(i + 1).padStart(2, '0')}`),
  'korlit/essay': Array.from({ length: 80 }, (_, i) => `essay_${String(i + 1).padStart(2, '0')}`),
  'korlit/nonfiction': Array.from({ length: 80 }, (_, i) => `nonfiction_${String(i + 1).padStart(2, '0')}`),
  'worldlit/classic': Array.from({ length: 80 }, (_, i) => `classic_${String(i + 1).padStart(2, '0')}`),
  'worldlit/modern': Array.from({ length: 80 }, (_, i) => `modern_${String(i + 1).padStart(2, '0')}`),
  'worldlit/essay': Array.from({ length: 80 }, (_, i) => `essay_${String(i + 1).padStart(2, '0')}`),
  'worldlit/nonfiction': Array.from({ length: 80 }, (_, i) => `nonfiction_${String(i + 1).padStart(2, '0')}`),
  'person/korea': Array.from({ length: 80 }, (_, i) => `korea_${String(i + 1).padStart(2, '0')}`),
  'person/world': Array.from({ length: 80 }, (_, i) => `world_${String(i + 1).padStart(2, '0')}`)
};

// ê³¼ëª©ë³„ ë©”íƒ€ë°ì´í„° ë§¤í•‘
const SUBJECT_META_MAP = {
  'science/bio': { series: 'BRAINì—…', field: 'ê³¼í•™ë¶„ì•¼', subject: 'ìƒë¬¼' },
  'science/geo_earth': { series: 'BRAINì—…', field: 'ê³¼í•™ë¶„ì•¼', subject: 'ì§€êµ¬ê³¼í•™' },
  'science/physics': { series: 'BRAINì—…', field: 'ê³¼í•™ë¶„ì•¼', subject: 'ë¬¼ë¦¬' },
  'science/chemistry': { series: 'BRAINì—…', field: 'ê³¼í•™ë¶„ì•¼', subject: 'í™”í•™' },
  'social/geo': { series: 'BRAINì—…', field: 'ì‚¬íšŒë¶„ì•¼', subject: 'ì§€ë¦¬' },
  'social/history': { series: 'BRAINì—…', field: 'ì‚¬íšŒë¶„ì•¼', subject: 'ì—­ì‚¬' },
  'social/politic': { series: 'BRAINì—…', field: 'ì‚¬íšŒë¶„ì•¼', subject: 'ì •ì¹˜ê²½ì œ' },
  'korlit/classic': { series: 'BRAINì—…', field: 'êµ­ë¬¸í•™', subject: 'ê³ ì „ì†Œì„¤' },
  'korlit/modern': { series: 'BRAINì—…', field: 'êµ­ë¬¸í•™', subject: 'í˜„ëŒ€ì†Œì„¤' },
  'korlit/essay': { series: 'BRAINì—…', field: 'êµ­ë¬¸í•™', subject: 'ìˆ˜í•„ì‹œ' },
  'korlit/nonfiction': { series: 'BRAINì—…', field: 'êµ­ë¬¸í•™', subject: 'ë¹„ë¬¸í•™' },
  'worldlit/classic': { series: 'BRAINì—…', field: 'ì„¸ê³„ë¬¸í•™', subject: 'ê³ ì „ì†Œì„¤' },
  'worldlit/modern': { series: 'BRAINì—…', field: 'ì„¸ê³„ë¬¸í•™', subject: 'í˜„ëŒ€ì†Œì„¤' },
  'worldlit/essay': { series: 'BRAINì—…', field: 'ì„¸ê³„ë¬¸í•™', subject: 'ìˆ˜í•„ì‹œ' },
  'worldlit/nonfiction': { series: 'BRAINì—…', field: 'ì„¸ê³„ë¬¸í•™', subject: 'ë¹„ë¬¸í•™' },
  'person/korea': { series: 'BRAINì—…', field: 'ì¸ë¬¼', subject: 'í•œêµ­ì¸ë¬¼' },
  'person/world': { series: 'BRAINì—…', field: 'ì¸ë¬¼', subject: 'ì„¸ê³„ì¸ë¬¼' }
};

// ë¯¸ì™„ë£Œ ë‹¨ì› ì¡°íšŒ í•¨ìˆ˜
async function getIncompleteUnits(grade, name, subjectPath) {
  try {
    // ëª¨ë“  ë‹¨ì›
    const allUnits = SUBJECT_UNITS_MAP[subjectPath] || [];

    // ì™„ë£Œëœ ë‹¨ì› ì¡°íšŒ (í•™ìŠµ ë¡œê·¸ì—ì„œ)
    const completedLogs = await LearningLog.find({
      grade,
      name,
      subject: SUBJECT_META_MAP[subjectPath]?.subject
    });

    const completedUnits = new Set(completedLogs.map(log => log.unitId));

    // ë¯¸ì™„ë£Œ ë‹¨ì› í•„í„°ë§
    const incompleteUnits = allUnits.filter(unit => !completedUnits.has(unit));

    return incompleteUnits;
  } catch (error) {
    console.error('ë¯¸ì™„ë£Œ ë‹¨ì› ì¡°íšŒ ì˜¤ë¥˜:', error);
    return [];
  }
}

// ìë™ ê³¼ì œ ë¶€ì—¬ í•¨ìˆ˜
async function executeAutoTaskSchedules() {
  try {
    console.log('ğŸ• ìë™ ê³¼ì œ ë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹œì‘...');

    const today = new Date().getDay(); // 0(ì¼) ~ 6(í† )

    // ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ
    const users = await UserProgress.find({
      'studyRoom.autoTaskSchedules': { $exists: true, $ne: [] }
    });

    let totalSchedules = 0;
    let successCount = 0;
    let failCount = 0;

    for (const user of users) {
      const schedules = user.studyRoom?.autoTaskSchedules || [];

      for (const schedule of schedules) {
        // í™œì„±í™”ë˜ì§€ ì•Šì€ ìŠ¤ì¼€ì¤„ì€ ê±´ë„ˆë›°ê¸°
        if (!schedule.isActive) continue;

        // ì˜¤ëŠ˜ ìš”ì¼ì´ ì‹¤í–‰ ìš”ì¼ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
        if (!schedule.days.includes(today)) continue;

        totalSchedules++;

        try {
          // ê³¼ëª©ë³„ë¡œ ê³¼ì œ ë¶€ì—¬
          let tasksAssigned = 0;

          for (const subjectPath of schedule.subjects) {
            // ë¯¸ì™„ë£Œ ë‹¨ì› ì¡°íšŒ
            const incompleteUnits = await getIncompleteUnits(user.grade, user.name, subjectPath);

            if (incompleteUnits.length === 0) {
              console.log(`âš ï¸ ${user.name} - ${subjectPath}: ë¯¸ì™„ë£Œ ë‹¨ì› ì—†ìŒ`);
              continue;
            }

            // taskCountë§Œí¼ ìˆœì°¨ì ìœ¼ë¡œ ê³¼ì œ ë¶€ì—¬
            const unitsToAssign = incompleteUnits.slice(0, schedule.taskCount);
            const meta = SUBJECT_META_MAP[subjectPath];

            for (const unitId of unitsToAssign) {
              const newTask = {
                id: unitId,
                unitId: unitId,
                title: `${meta.subject} ${unitId}`,
                series: meta.series,
                field: meta.field,
                subject: meta.subject,
                isAI: false,
                assignedAt: new Date(),
                dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7ì¼ í›„
                status: 'pending',
                progress: 0
              };

              if (!user.studyRoom.assignedTasks) {
                user.studyRoom.assignedTasks = [];
              }

              user.studyRoom.assignedTasks.push(newTask);
              tasksAssigned++;
            }
          }

          // ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸
          schedule.lastExecutedAt = new Date();
          schedule.nextScheduledDate = calculateNextScheduledDate(schedule.days);

          await user.save();

          console.log(`âœ… ${user.name}: ${tasksAssigned}ê°œ ê³¼ì œ ë¶€ì—¬ ì™„ë£Œ`);
          successCount++;

        } catch (error) {
          console.error(`âŒ ${user.name} ê³¼ì œ ë¶€ì—¬ ì‹¤íŒ¨:`, error);
          failCount++;
        }
      }
    }

    console.log(`ğŸ‰ ìë™ ê³¼ì œ ë¶€ì—¬ ì™„ë£Œ - ì´ ${totalSchedules}ê°œ ìŠ¤ì¼€ì¤„ (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${failCount})`);

  } catch (error) {
    console.error('ìë™ ê³¼ì œ ë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ ì˜¤ë¥˜:', error);
  }
}

// [DEPRECATED] êµ¬ë²„ì „ ìë™ ê³¼ì œ ìŠ¤ì¼€ì¤„ëŸ¬ - ë¹„í™œì„±í™”
// ì‹ ë²„ì „ executeAutoTaskAssignment()ê°€ ë§¤ì¼ 0ì‹œì— ì‹¤í–‰ë¨ (19344 ë¼ì¸)
// cron.schedule('0 0 * * *', () => {
//   console.log('â° ë§¤ì¼ 0ì‹œ - ìë™ ê³¼ì œ ë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°');
//   executeAutoTaskSchedules();
// }, {
//   timezone: "Asia/Seoul"
// });

console.log('â­ï¸ êµ¬ë²„ì „ ìë™ ê³¼ì œ ë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ ë¹„í™œì„±í™”ë¨ (ì‹ ë²„ì „ ì‚¬ìš©)');

// AI ì¶”ì²œê³¼ì œ ìŠ¤ì¼€ì¤„ëŸ¬ (ë§¤ì‹œ ì •ê° ì‹¤í–‰ - ë“±ê¸‰ë³„ ì‹œê°„ ì²´í¬)
cron.schedule('0 * * * *', () => {
  console.log('â° AI ì¶”ì²œê³¼ì œ ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±° (ë§¤ì‹œ ì •ê°)');
  assignAITasksDaily();
}, {
  timezone: "Asia/Seoul"
});

console.log('âœ… AI ì¶”ì²œê³¼ì œ ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡ ì™„ë£Œ (ë§¤ì‹œ ì •ê° ì‹¤í–‰)');

// ========== ë…ì„œ ê°ìƒë¬¸ ì›”ê°„ ë¦¬ì…‹ ==========
// ë§¤ì›” 1ì¼ 0ì‹œ 0ë¶„ì— ì‹¤í–‰ (ì›”ê°„ ê³¼ì œ ë¦¬ì…‹)
cron.schedule('0 0 1 * *', async () => {
  console.log('ğŸ“š ë…ì„œ ê°ìƒë¬¸ ì›”ê°„ ë¦¬ì…‹ ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°');

  try {
    // ëª¨ë“  ì‚¬ìš©ìì˜ ë…ì„œ ê°ìƒë¬¸ ë°ì´í„° ì¡°íšŒ
    const allUsers = await UserProgress.find({
      'readingReports.0': { $exists: true }
    });

    console.log(`ğŸ“Š ì´ ${allUsers.length}ëª…ì˜ ì‚¬ìš©ì ë…ì„œ ê°ìƒë¬¸ ë°ì´í„° í™•ì¸`);

    // ì°¸ê³ : ì‹¤ì œë¡œëŠ” ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³  ìœ ì§€í•©ë‹ˆë‹¤.
    // ê° ë¦¬í¬íŠ¸ì— month í•„ë“œê°€ ìˆì–´ì„œ ì›”ë³„ë¡œ í•„í„°ë§ ê°€ëŠ¥
    // ì´ ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ë¡œê¹… ë° í†µê³„ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©

    let totalReports = 0;
    allUsers.forEach(user => {
      if (user.readingReports && user.readingReports.length > 0) {
        totalReports += user.readingReports.length;
      }
    });

    console.log(`âœ… ë…ì„œ ê°ìƒë¬¸ ì›”ê°„ ë¦¬ì…‹ ì™„ë£Œ - ì´ ${totalReports}ê°œ ë¦¬í¬íŠ¸ ë³´ê´€ ì¤‘`);
  } catch (error) {
    console.error('âŒ ë…ì„œ ê°ìƒë¬¸ ì›”ê°„ ë¦¬ì…‹ ì˜¤ë¥˜:', error);
  }
}, {
  timezone: "Asia/Seoul"
});

console.log('âœ… ë…ì„œ ê°ìƒë¬¸ ì›”ê°„ ë¦¬ì…‹ ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡ ì™„ë£Œ (ë§¤ì›” 1ì¼ 0ì‹œ ì‹¤í–‰)');

// ========== ìë™ê³¼ì œë¶€ì—¬ ì‹œìŠ¤í…œ (í•™ìƒë³„ ì„¤ì • ê¸°ë°˜) ==========

// ê³¼ëª© ìš°ì„ ìˆœìœ„ ìˆœì„œ (ì‚¬ìš©ì ì§€ì •)
// ìƒë¬¼ > ì§€êµ¬ê³¼í•™ > ë¬¼ë¦¬ > í™”í•™ > ì‚¬íšŒë¬¸í™” > ì§€ë¦¬ > ë²• > ì •ì¹˜ê²½ì œ > í˜„ëŒ€ë¬¸í•™ > ê³ ì „ë¬¸í•™ > ì„¸ê³„ë¬¸í•™1 > ì„¸ê³„ë¬¸í•™2 > í•œêµ­ì¸ë¬¼ > ì„¸ê³„ì¸ë¬¼
const AUTO_TASK_SUBJECT_PRIORITY = ['bio', 'earth', 'physics', 'chem', 'soc', 'geo', 'law', 'pol', 'modern', 'classic', 'world1', 'world2', 'people1', 'people2'];

// ê° ê³¼ëª©ë³„ ìµœëŒ€ ë‹¨ì› ìˆ˜
const SUBJECT_MAX_UNITS = {
  bio: 20, chem: 20, physics: 20, earth: 20,
  geo: 20, soc: 20, law: 20, pol: 20, econ: 20,
  classic: 30, modern: 30, world1: 20, world2: 20, people1: 20, people2: 20
};

// ê³¼ëª© ì •ë³´ ë§¤í•‘ (fieldëŠ” í•œê¸€ë¡œ í‘œì‹œ)
const SUBJECT_INFO = {
  bio: { field: 'ê³¼í•™ë¶„ì•¼', label: 'ìƒë¬¼' },
  chem: { field: 'ê³¼í•™ë¶„ì•¼', label: 'í™”í•™' },
  physics: { field: 'ê³¼í•™ë¶„ì•¼', label: 'ë¬¼ë¦¬' },
  earth: { field: 'ê³¼í•™ë¶„ì•¼', label: 'ì§€êµ¬ê³¼í•™' },
  geo: { field: 'ì‚¬íšŒë¶„ì•¼', label: 'ì§€ë¦¬' },
  soc: { field: 'ì‚¬íšŒë¶„ì•¼', label: 'ì‚¬íšŒë¬¸í™”' },
  law: { field: 'ì‚¬íšŒë¶„ì•¼', label: 'ë²•ê³¼ì •ì¹˜' },
  pol: { field: 'ì‚¬íšŒë¶„ì•¼', label: 'ì •ì¹˜' },
  econ: { field: 'ì‚¬íšŒë¶„ì•¼', label: 'ê²½ì œ' },
  classic: { field: 'êµ­ì–´ë¶„ì•¼', label: 'ê³ ì „ë¬¸í•™' },
  modern: { field: 'êµ­ì–´ë¶„ì•¼', label: 'í˜„ëŒ€ë¬¸í•™' },
  world1: { field: 'êµ­ì–´ë¶„ì•¼', label: 'ì„¸ê³„ë¬¸í•™1' },
  world2: { field: 'êµ­ì–´ë¶„ì•¼', label: 'ì„¸ê³„ë¬¸í•™2' },
  people1: { field: 'ì¸ë¬¼ë¶„ì•¼', label: 'í•œêµ­ì¸ë¬¼' },
  people2: { field: 'ì¸ë¬¼ë¶„ì•¼', label: 'ì„¸ê³„ì¸ë¬¼' }
};

// ë¶„ì•¼ë³„ ê³¼ëª© ë§¤í•‘ (ìë™ê³¼ì œë¶€ì—¬ ë¶„ì•¼ í•„í„°ë§ìš©)
const DOMAIN_SUBJECTS = {
  all: ['bio', 'earth', 'physics', 'chem', 'soc', 'geo', 'law', 'pol', 'modern', 'classic', 'world1', 'world2', 'people1', 'people2'],
  science: ['bio', 'earth', 'physics', 'chem'],
  social: ['soc', 'geo', 'law', 'pol'],
  korlit: ['modern', 'classic'],
  worldlit: ['world1', 'world2'],
  person: ['people1', 'people2']
};

// ê°œë³„ í•™ìƒë³„ ìë™ê³¼ì œë¶€ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ìš© ë½
const studentAutoTaskLocks = new Map();

// ê°œë³„ í•™ìƒìš© ìë™ê³¼ì œë¶€ì—¬ ì‹¤í–‰ í•¨ìˆ˜ (ì„¤ì • ë³€ê²½ ì‹œ ì¦‰ì‹œ ì‹¤í–‰ìš©)
async function executeAutoTaskForStudent(grade, name, setting) {
  const lockKey = `${grade}_${name}`;

  // í•´ë‹¹ í•™ìƒì˜ ìë™ê³¼ì œë¶€ì—¬ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
  if (studentAutoTaskLocks.get(lockKey)) {
    console.log(`âš ï¸ [${grade} ${name}] ìë™ê³¼ì œë¶€ì—¬ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤.`);
    return;
  }

  studentAutoTaskLocks.set(lockKey, true);

  try {
    console.log(`ğŸ¯ [${grade} ${name}] ê°œë³„ ìë™ê³¼ì œë¶€ì—¬ ì‹œì‘`);

    // ì˜¤ëŠ˜ ë‚ ì§œ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
    const now = new Date();
    const kstOffset = 9 * 60 * 60 * 1000;
    const kstDate = new Date(now.getTime() + kstOffset);
    const todayKST = kstDate.toISOString().split('T')[0];

    // í˜„ì¬ í•™ìŠµì‹¤ ì¡°íšŒí•˜ì—¬ ì˜¤ëŠ˜ ì´ë¯¸ ìë™ê³¼ì œë¥¼ ë¶€ì—¬í–ˆëŠ”ì§€ ì²´í¬
    const existingProgress = await UserProgress.findOne({ grade, name });
    if (existingProgress?.studyRoom?.assignedTasks) {
      const todayAutoTasks = existingProgress.studyRoom.assignedTasks.filter(task => {
        if (!task.isAutoAssigned || !task.assignedAt) return false;
        const taskDate = new Date(task.assignedAt);
        const taskKST = new Date(taskDate.getTime() + kstOffset);
        const taskDateStr = taskKST.toISOString().split('T')[0];
        return taskDateStr === todayKST;
      });

      if (todayAutoTasks.length >= setting.taskCount * setting.series.length) {
        console.log(`â­ï¸ [${grade} ${name}] ì˜¤ëŠ˜(${todayKST}) ì´ë¯¸ ìë™ê³¼ì œ ${todayAutoTasks.length}ê°œ ë¶€ì—¬ë¨. ìŠ¤í‚µí•©ë‹ˆë‹¤.`);
        return;
      }
    }

    // í•´ë‹¹ í•™ìƒì˜ ì™„ë£Œëœ í•™ìŠµ ê¸°ë¡ ì¡°íšŒ
    const completedLogs = await LearningLog.find({
      grade,
      name,
      completed: true,
      deleted: { $ne: true }
    });

    // ì™„ë£Œëœ ë‹¨ì› ëª©ë¡ ì¶”ì¶œ
    const completedUnits = new Set();
    for (const log of completedLogs) {
      const unitValue = log.unit || log.unitId;
      if (unitValue && unitValue !== 'undefined') {
        const match = unitValue.match(/((?:fit_|deep_|on_)?[a-z]+\d?)_(\d+)/i);
        if (match) {
          completedUnits.add(`${match[1].toLowerCase()}_${match[2]}`);
        }
      }
    }
    console.log(`  ğŸ“Š ì™„ë£Œëœ ë‹¨ì›: ${completedUnits.size}ê°œ`);

    // í˜„ì¬ í•™ìŠµì‹¤ì— ìˆëŠ” ê³¼ì œ ì¡°íšŒ (ì¼ë°˜ ê³¼ì œë§Œ - ìë™ë¶€ì—¬ ê³¼ì œëŠ” ì´ë¯¸ ì‚­ì œë¨)
    const userProgress = await UserProgress.findOne({ grade, name });

    const existingTasks = new Set();
    if (userProgress?.studyRoom?.assignedTasks) {
      for (const task of userProgress.studyRoom.assignedTasks) {
        const match = task.unitId?.match(/((?:fit_|deep_|on_)?[a-z]+\d?)_(\d+)/i);
        if (match) {
          existingTasks.add(`${match[1].toLowerCase()}_${match[2]}`);
        }
      }
    }

    // ë¶€ì—¬í•  ê³¼ì œ ëª©ë¡ ìƒì„±
    const tasksToAssign = [];

    // ì‹œë¦¬ì¦ˆë³„, ë¶„ì•¼ë³„ë¡œ ê°ê° taskCountê°œì”© ë¶€ì—¬
    const selectedDomains = setting.domains && setting.domains.length > 0 ? setting.domains : ['all'];

    for (const series of setting.series) {
      console.log(`  ğŸ”¹ ì‹œë¦¬ì¦ˆ: ${series}`);

      let prefix = '';
      let seriesName = 'BRAINì—…';
      if (series === 'fit') {
        prefix = 'fit_';
        seriesName = 'BRAINí•';
      } else if (series === 'deep') {
        prefix = 'deep_';
        seriesName = 'BRAINë”¥';
      } else if (series === 'on') {
        prefix = 'on_';
        seriesName = 'BRAINì˜¨';
      } else if (series === 'up') {
        prefix = '';
        seriesName = 'BRAINì—…';
      }

      // ë¶„ì•¼ë³„ë¡œ ê°ê° taskCountê°œì”© ë¶€ì—¬
      for (const domain of selectedDomains) {
        console.log(`    ğŸ“‚ ë¶„ì•¼: ${domain}`);
        let domainTaskCount = 0;

        const domainSubjects = DOMAIN_SUBJECTS[domain] || DOMAIN_SUBJECTS.all;
        const filteredSubjects = AUTO_TASK_SUBJECT_PRIORITY.filter(s => domainSubjects.includes(s));

        const maxUnitNum = 30;

        domainLoop:
        for (let unitNum = 1; unitNum <= maxUnitNum; unitNum++) {
          if (domainTaskCount >= setting.taskCount) break;

          const unitNo = String(unitNum).padStart(2, '0');

          for (const subject of filteredSubjects) {
            if (domainTaskCount >= setting.taskCount) break domainLoop;

            const maxUnits = SUBJECT_MAX_UNITS[subject] || 20;
            if (unitNum > maxUnits) continue;

            const subjectInfo = SUBJECT_INFO[subject];
            const unitKey = `${prefix}${subject}_${unitNo}`;

            if (completedUnits.has(unitKey) || existingTasks.has(unitKey)) {
              continue;
            }

            if (tasksToAssign.some(t => t.unitKey === unitKey && t.series === series)) {
              continue;
            }

            let unitPath;
            if (['bio', 'chem', 'physics', 'earth'].includes(subject)) {
              unitPath = `./BRAINUP/science/${prefix}${subject}_${unitNo}.html`;
            } else if (['geo', 'soc', 'law', 'pol', 'econ'].includes(subject)) {
              unitPath = `./BRAINUP/social/${prefix}${subject}_${unitNo}.html`;
            } else if (['classic', 'modern'].includes(subject)) {
              unitPath = `./BRAINUP/korlit/${prefix}${subject}_${unitNo}.html`;
            } else if (['world1', 'world2'].includes(subject)) {
              unitPath = `./BRAINUP/worldlit/${prefix}${subject}_${unitNo}.html`;
            } else if (['people1', 'people2'].includes(subject)) {
              unitPath = `./BRAINUP/person/${prefix}${subject}_${unitNo}.html`;
            }

            const contentTitle = getContentTitle(unitKey, unitPath);
            const fullTitle = contentTitle
              ? `${subjectInfo.label} ${unitNo} ${contentTitle}`
              : `${subjectInfo.label} ${unitNo}`;

            tasksToAssign.push({
              unitKey,
              unitId: unitPath,
              unitTitle: fullTitle,
              series: series,
              seriesName: seriesName,
              fieldName: subjectInfo.field,
              subjectName: subjectInfo.label,
              assignedAt: new Date(),
              isAutoAssigned: true
            });
            domainTaskCount++;
          }
        }
      }
    }

    // ê³¼ì œ ë¶€ì—¬
    if (tasksToAssign.length > 0) {
      let progress = userProgress;
      if (!progress) {
        progress = new UserProgress({
          grade,
          name,
          studyRoom: { assignedTasks: [] }
        });
      }

      if (!progress.studyRoom) {
        progress.studyRoom = { assignedTasks: [] };
      }

      for (const task of tasksToAssign) {
        progress.studyRoom.assignedTasks.push({
          unitId: task.unitId,
          unitTitle: task.unitTitle,
          seriesName: task.seriesName,
          fieldName: task.fieldName,
          subjectName: task.subjectName,
          assignedAt: task.assignedAt,
          isAutoAssigned: true
        });
      }

      await progress.save();
      console.log(`âœ… [${grade} ${name}] ${tasksToAssign.length}ê°œ ê³¼ì œ ë¶€ì—¬ ì™„ë£Œ`);
      tasksToAssign.forEach(t => console.log(`   - ${t.seriesName} > ${t.subjectName} ${t.unitTitle.split(' ')[1]}`));
    } else {
      console.log(`â„¹ï¸ [${grade} ${name}] ë¶€ì—¬í•  ë¯¸ì™„ë£Œ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤`);
    }

  } catch (error) {
    console.error(`âŒ [${grade} ${name}] ê°œë³„ ìë™ê³¼ì œë¶€ì—¬ ì˜¤ë¥˜:`, error);
    throw error;
  } finally {
    studentAutoTaskLocks.delete(lockKey);
  }
}

// ìë™ê³¼ì œë¶€ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ìš© ë½
let isAutoTaskRunning = false;

// ìë™ê³¼ì œë¶€ì—¬ ì‹¤í–‰ í•¨ìˆ˜
async function executeAutoTaskAssignment() {
  // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ (ë©”ëª¨ë¦¬ ë½)
  if (isAutoTaskRunning) {
    console.log('âš ï¸ ìë™ê³¼ì œë¶€ì—¬ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤.');
    return;
  }

  // ì˜¤ëŠ˜ ë‚ ì§œ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
  const now = new Date();
  const kstOffset = 9 * 60 * 60 * 1000; // UTC+9
  const kstDate = new Date(now.getTime() + kstOffset);
  const todayKST = kstDate.toISOString().split('T')[0]; // YYYY-MM-DD (KST)

  // DBì—ì„œ ë§ˆì§€ë§‰ ì‹¤í–‰ ë‚ ì§œ í™•ì¸ (ì¸ìŠ¤í„´ìŠ¤ ê°„ ì¤‘ë³µ ë°©ì§€)
  try {
    const lastRunDoc = await mongoose.connection.db.collection('system_settings').findOne({ key: 'lastAutoTaskRunDate' });
    if (lastRunDoc && lastRunDoc.value === todayKST) {
      console.log(`âš ï¸ ìë™ê³¼ì œë¶€ì—¬ê°€ ì˜¤ëŠ˜(${todayKST} KST) ì´ë¯¸ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤.`);
      return;
    }

    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¤‘ë³µ ì‹¤í–‰í•˜ì§€ ì•Šë„ë¡)
    await mongoose.connection.db.collection('system_settings').updateOne(
      { key: 'lastAutoTaskRunDate' },
      { $set: { key: 'lastAutoTaskRunDate', value: todayKST, updatedAt: new Date() } },
      { upsert: true }
    );
  } catch (dbError) {
    console.error('âŒ DB ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', dbError);
    // DB ì˜¤ë¥˜ ì‹œì—ë„ ë©”ëª¨ë¦¬ ë½ìœ¼ë¡œ ì§„í–‰
  }

  isAutoTaskRunning = true;

  try {
    console.log('ğŸ¯ ìë™ê³¼ì œë¶€ì—¬ ì‹œì‘:', new Date().toISOString(), `(KST: ${todayKST})`);

    const now = new Date();
    const dayOfWeek = now.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 

    // running ìƒíƒœì¸ ëª¨ë“  ì„¤ì • ì¡°íšŒ
    const activeSettings = await AutoTaskSettings.find({ status: 'running' });
    console.log(`ğŸ“‹ í™œì„±í™”ëœ ìë™ê³¼ì œë¶€ì—¬ ì„¤ì •: ${activeSettings.length}ê°œ`);

    for (const setting of activeSettings) {
      try {
        // ìš”ì¼ ì²´í¬
        const shouldAssignToday = setting.days.includes('everyday') ||
                                   setting.days.includes(String(dayOfWeek));

        if (!shouldAssignToday) {
          console.log(`â­ï¸ [${setting.grade} ${setting.name}] ì˜¤ëŠ˜(${dayOfWeek})ì€ ë¶€ì—¬ ìš”ì¼ì´ ì•„ë‹™ë‹ˆë‹¤`);
          continue;
        }

        // ì˜¤ëŠ˜ ì´ë¯¸ ìë™ê³¼ì œë¥¼ ë¶€ì—¬í–ˆëŠ”ì§€ ì²´í¬ (í•™ìƒë³„ ì¤‘ë³µ ë°©ì§€)
        const userProgress = await UserProgress.findOne({
          grade: setting.grade,
          name: setting.name
        });

        if (userProgress?.studyRoom?.assignedTasks) {
          const todayAutoTasks = userProgress.studyRoom.assignedTasks.filter(task => {
            if (!task.isAutoAssigned || !task.assignedAt) return false;
            const taskDate = new Date(task.assignedAt);
            const taskKST = new Date(taskDate.getTime() + kstOffset);
            const taskDateStr = taskKST.toISOString().split('T')[0];
            return taskDateStr === todayKST;
          });

          if (todayAutoTasks.length >= setting.taskCount * setting.series.length) {
            console.log(`â­ï¸ [${setting.grade} ${setting.name}] ì˜¤ëŠ˜(${todayKST}) ì´ë¯¸ ìë™ê³¼ì œ ${todayAutoTasks.length}ê°œ ë¶€ì—¬ë¨. ìŠ¤í‚µí•©ë‹ˆë‹¤.`);
            continue;
          }
        }

        console.log(`ğŸ”„ [${setting.grade} ${setting.name}] ìë™ê³¼ì œ ë¶€ì—¬ ì‹œì‘ (${setting.taskCount}ê°œ)`);

        // í•´ë‹¹ í•™ìƒì˜ ì™„ë£Œëœ í•™ìŠµ ê¸°ë¡ ì¡°íšŒ
        const completedLogs = await LearningLog.find({
          grade: setting.grade,
          name: setting.name,
          completed: true,
          deleted: { $ne: true }
        });

        // ì™„ë£Œëœ ë‹¨ì› ëª©ë¡ ì¶”ì¶œ (ì‹œë¦¬ì¦ˆ prefix í¬í•¨: deep_bio_06, fit_bio_06, bio_06)
        const completedUnits = new Set();
        for (const log of completedLogs) {
          // LearningLogì—ì„œëŠ” 'unit' í•„ë“œ ì‚¬ìš© (ì˜ˆ: deep_bio_06, fit_physics_02)
          const unitValue = log.unit || log.unitId;
          if (unitValue && unitValue !== 'undefined') {
            // ì‹œë¦¬ì¦ˆ prefix í¬í•¨ íŒ¨í„´: (fit_|deep_|on_)?(ê³¼ëª©ì½”ë“œ\d?)_(ë²ˆí˜¸)
            const match = unitValue.match(/((?:fit_|deep_|on_)?[a-z]+\d?)_(\d+)/i);
            if (match) {
              completedUnits.add(`${match[1].toLowerCase()}_${match[2]}`);
            }
          }
        }
        console.log(`  ğŸ“Š ì™„ë£Œëœ ë‹¨ì›: ${completedUnits.size}ê°œ`);

        // userProgressëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì¡°íšŒí–ˆìœ¼ë¯€ë¡œ ì¬ì‚¬ìš©
        const existingTasks = new Set();
        if (userProgress?.studyRoom?.assignedTasks) {
          for (const task of userProgress.studyRoom.assignedTasks) {
            // ì‹œë¦¬ì¦ˆ prefix í¬í•¨ íŒ¨í„´
            const match = task.unitId?.match(/((?:fit_|deep_|on_)?[a-z]+\d?)_(\d+)/i);
            if (match) {
              existingTasks.add(`${match[1].toLowerCase()}_${match[2]}`);
            }
          }
        }

        // ë¶€ì—¬í•  ê³¼ì œ ëª©ë¡ ìƒì„±
        const tasksToAssign = [];

        // â˜… ë¶„ì•¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ì „ì²´)
        const selectedDomains = setting.domains && setting.domains.length > 0
          ? (setting.domains.includes('all') ? ['all'] : setting.domains)
          : ['all'];

        // ì‹œë¦¬ì¦ˆë³„ë¡œ ê°ê° taskCountê°œì”© ë¶€ì—¬
        for (const series of setting.series) {
          console.log(`  ğŸ”¹ ì‹œë¦¬ì¦ˆ: ${series}`);

          // ì‹œë¦¬ì¦ˆë³„ prefixì™€ ì´ë¦„ ì„¤ì •
          let prefix = '';
          let seriesName = 'BRAINì—…';
          if (series === 'fit') {
            prefix = 'fit_';
            seriesName = 'BRAINí•';
          } else if (series === 'deep') {
            prefix = 'deep_';
            seriesName = 'BRAINë”¥';
          } else if (series === 'on') {
            prefix = 'on_';
            seriesName = 'BRAINì˜¨';
          } else if (series === 'up') {
            prefix = '';
            seriesName = 'BRAINì—…';
          }

          // â˜… ë¶„ì•¼ë³„ë¡œ ê°ê° taskCountê°œì”© ë¶€ì—¬
          for (const domain of selectedDomains) {
            console.log(`    ğŸ“‚ ë¶„ì•¼: ${domain}`);
            let domainTaskCount = 0;

            // í•´ë‹¹ ë¶„ì•¼ì˜ ê³¼ëª©ë§Œ í•„í„°ë§
            const domainSubjects = DOMAIN_SUBJECTS[domain] || DOMAIN_SUBJECTS.all;
            const filteredSubjects = AUTO_TASK_SUBJECT_PRIORITY.filter(s => domainSubjects.includes(s));

            const maxUnitNum = 30;  // ê°€ì¥ í° ë‹¨ì› ìˆ˜ (í˜„ëŒ€/ê³ ì „ë¬¸í•™)

            domainLoop:
            for (let unitNum = 1; unitNum <= maxUnitNum; unitNum++) {
              if (domainTaskCount >= setting.taskCount) break;

              const unitNo = String(unitNum).padStart(2, '0');

              // ê°™ì€ ë‹¨ì›ë²ˆí˜¸ ë‚´ì—ì„œ í•´ë‹¹ ë¶„ì•¼ì˜ ê³¼ëª©ë§Œ ìˆœíšŒ
              for (const subject of filteredSubjects) {
                if (domainTaskCount >= setting.taskCount) break domainLoop;

                const maxUnits = SUBJECT_MAX_UNITS[subject] || 20;
                if (unitNum > maxUnits) continue;  // í•´ë‹¹ ê³¼ëª©ì˜ ìµœëŒ€ ë‹¨ì› ìˆ˜ ì´ˆê³¼í•˜ë©´ ìŠ¤í‚µ

                const subjectInfo = SUBJECT_INFO[subject];
                const unitKey = `${prefix}${subject}_${unitNo}`;

                // ì´ë¯¸ ì™„ë£Œí–ˆê±°ë‚˜ í•™ìŠµì‹¤ì— ìˆëŠ” ê²½ìš° ìŠ¤í‚µ
                if (completedUnits.has(unitKey) || existingTasks.has(unitKey)) {
                  continue;
                }

                // ì¤‘ë³µ ì²´í¬ (ì´ë²ˆì— ì¶”ê°€í•  ëª©ë¡ì—ì„œ)
                if (tasksToAssign.some(t => t.unitKey === unitKey && t.series === series)) {
                  continue;
                }

                // ê²½ë¡œ ì„¤ì •
                let unitPath;
                if (['bio', 'chem', 'physics', 'earth'].includes(subject)) {
                  unitPath = `./BRAINUP/science/${prefix}${subject}_${unitNo}.html`;
                } else if (['geo', 'soc', 'law', 'pol', 'econ'].includes(subject)) {
                  unitPath = `./BRAINUP/social/${prefix}${subject}_${unitNo}.html`;
                } else if (['classic', 'modern'].includes(subject)) {
                  unitPath = `./BRAINUP/korlit/${prefix}${subject}_${unitNo}.html`;
                } else if (['world1', 'world2'].includes(subject)) {
                  unitPath = `./BRAINUP/worldlit/${prefix}${subject}_${unitNo}.html`;
                } else if (['people1', 'people2'].includes(subject)) {
                  unitPath = `./BRAINUP/person/${prefix}${subject}_${unitNo}.html`;
                }

                // ì½˜í…ì¸  íŒŒì¼ì—ì„œ ì „ì²´ ì œëª© ê°€ì ¸ì˜¤ê¸°
                const contentTitle = getContentTitle(unitKey, unitPath);
                const fullTitle = contentTitle
                  ? `${subjectInfo.label} ${unitNo} ${contentTitle}`
                  : `${subjectInfo.label} ${unitNo}`;

                tasksToAssign.push({
                  unitKey,
                  unitId: unitPath,
                  unitTitle: fullTitle,
                  series: series,
                  seriesName: seriesName,
                  fieldName: subjectInfo.field,
                  subjectName: subjectInfo.label,
                  assignedAt: new Date(),
                  isAutoAssigned: true
                });
                domainTaskCount++;
                console.log(`      âœ… ${unitKey} ì¶”ê°€ (${domainTaskCount}/${setting.taskCount})`);
              }
            }
          }
        }

        // ê³¼ì œ ë¶€ì—¬
        if (tasksToAssign.length > 0) {
          let progress = userProgress;
          if (!progress) {
            progress = new UserProgress({
              grade: setting.grade,
              name: setting.name,
              studyRoom: { assignedTasks: [] }
            });
          }

          if (!progress.studyRoom) {
            progress.studyRoom = { assignedTasks: [] };
          }

          // ì €ì¥ ì§ì „ ì¤‘ë³µ ì²´í¬ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€)
          const existingUnitIds = new Set(
            progress.studyRoom.assignedTasks.map(t => t.unitId).filter(Boolean)
          );
          const filteredTasks = tasksToAssign.filter(task => !existingUnitIds.has(task.unitId));

          if (filteredTasks.length === 0) {
            console.log(`â­ï¸ [${setting.grade} ${setting.name}] ì´ë¯¸ ë™ì¼í•œ ê³¼ì œê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤.`);
            continue;
          }

          // ìƒˆ ê³¼ì œ ì¶”ê°€
          for (const task of filteredTasks) {
            const newTask = {
              unitId: task.unitId,
              unitTitle: task.unitTitle,
              seriesName: task.seriesName,
              fieldName: task.fieldName,
              subjectName: task.subjectName,
              assignedAt: task.assignedAt,
              isAutoAssigned: true
            };
            console.log(`    ğŸ“¦ ì €ì¥í•  ê³¼ì œ: ${JSON.stringify(newTask)}`);
            progress.studyRoom.assignedTasks.push(newTask);
          }

          await progress.save();
          console.log(`âœ… [${setting.grade} ${setting.name}] ${filteredTasks.length}ê°œ ê³¼ì œ ë¶€ì—¬ ì™„ë£Œ`);
          filteredTasks.forEach(t => console.log(`   - ${t.seriesName} > ${t.subjectName} ${t.unitTitle.split(' ')[1]}`));
        } else {
          console.log(`â„¹ï¸ [${setting.grade} ${setting.name}] ë¶€ì—¬í•  ë¯¸ì™„ë£Œ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤`);
        }

      } catch (studentError) {
        console.error(`âŒ [${setting.grade} ${setting.name}] ê³¼ì œ ë¶€ì—¬ ì˜¤ë¥˜:`, studentError);
      }
    }

    console.log('ğŸ¯ ìë™ê³¼ì œë¶€ì—¬ ì™„ë£Œ:', new Date().toISOString());

  } catch (error) {
    console.error('âŒ ìë™ê³¼ì œë¶€ì—¬ ì „ì²´ ì˜¤ë¥˜:', error);
  } finally {
    isAutoTaskRunning = false;
  }
}

// ìë™ê³¼ì œë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ (ë§¤ì¼ 0ì‹œ ì‹¤í–‰)
cron.schedule('0 0 * * *', () => {
  console.log('â° ë§¤ì¼ 0ì‹œ - ìë™ê³¼ì œë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°');
  executeAutoTaskAssignment();
}, {
  timezone: "Asia/Seoul"
});

console.log('âœ… ìë™ê³¼ì œë¶€ì—¬ ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡ ì™„ë£Œ (ë§¤ì¼ 0ì‹œ ì‹¤í–‰)');

// ğŸ§ª í…ŒìŠ¤íŠ¸ìš© ì—”ë“œí¬ì¸íŠ¸: ìë™ê³¼ì œë¶€ì—¬ ìˆ˜ë™ íŠ¸ë¦¬ê±°
app.post('/api/test/auto-task-trigger', async (req, res) => {
  try {
    console.log('ğŸ§ª [í…ŒìŠ¤íŠ¸] ìë™ê³¼ì œë¶€ì—¬ ìˆ˜ë™ íŠ¸ë¦¬ê±° ì‹œì‘');

    // ìë™ê³¼ì œë¶€ì—¬ í•¨ìˆ˜ ì‹¤í–‰
    await executeAutoTaskAssignment();

    res.json({
      ok: true,
      message: 'ìë™ê³¼ì œë¶€ì—¬ê°€ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.',
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('âŒ [í…ŒìŠ¤íŠ¸] ìë™ê³¼ì œë¶€ì—¬ ì‹¤í–‰ ì˜¤ë¥˜:', error);
    res.status(500).json({
      ok: false,
      message: 'ìë™ê³¼ì œë¶€ì—¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      error: error.message
    });
  }
});

// ========================================
// ğŸ“ ì§„ë‹¨í…ŒìŠ¤íŠ¸ ë° ìˆ˜ê°•ì‹ ì²­ API
// ========================================

// ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì •ë³´ ì €ì¥ (ì§„ë‹¨ ì‹œì‘í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ)
app.post("/api/diagnostic-test", async (req, res) => {
  try {
    const { branchName, studentGrade, studentClassNum, studentName, studentPhone, parentName, parentPhone } = req.body;

    const diagnosticTest = new DiagnosticTest({
      branchName,
      studentGrade,
      studentClassNum: studentClassNum || '',
      studentName,
      studentPhone,
      parentName,
      parentPhone
    });

    await diagnosticTest.save();

    res.json({ success: true, message: "ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (error) {
    console.error("ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì €ì¥ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìˆ˜ê°•ì‹ ì²­(ìƒë‹´) ì •ë³´ ì €ì¥ (ìƒë‹´ì‹ ì²­ íŒì—…ì—ì„œ ì œì¶œ ì‹œ)
app.post("/api/course-application", async (req, res) => {
  try {
    const { branchName, studentGrade, studentClassNum, studentName, studentPhone, parentPhone, grade, series, answers, score, duration } = req.body;

    const courseApplication = new CourseApplication({
      branchName,
      studentGrade,
      studentClassNum: studentClassNum || '',
      studentName,
      studentPhone,
      parentPhone,
      grade,
      series,
      answers: answers || [],
      score: score || 0,
      duration: duration || ''
    });

    await courseApplication.save();

    res.json({ success: true, message: "ìˆ˜ê°•ì‹ ì²­ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", applicationId: courseApplication._id });
  } catch (error) {
    console.error("ìˆ˜ê°•ì‹ ì²­ ì €ì¥ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì§„ë‹¨í…ŒìŠ¤íŠ¸ ëª©ë¡ ì¡°íšŒ (ìŠˆí¼ ê´€ë¦¬ììš©)
app.get("/api/diagnostic-tests", async (req, res) => {
  try {
    const tests = await DiagnosticTest.find().sort({ createdAt: -1 });
    res.json({ success: true, data: tests });
  } catch (error) {
    console.error("ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìˆ˜ê°•ì‹ ì²­ ëª©ë¡ ì¡°íšŒ (ìŠˆí¼ ê´€ë¦¬ììš©)
app.get("/api/course-applications", async (req, res) => {
  try {
    const applications = await CourseApplication.find().sort({ createdAt: -1 });
    res.json({ success: true, data: applications });
  } catch (error) {
    console.error("ìˆ˜ê°•ì‹ ì²­ ì¡°íšŒ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ê°œë³„ ìˆ˜ê°•ì‹ ì²­ ì‹œí—˜ì§€ ì¡°íšŒ (ê´€ë¦¬ììš© - IDë¡œ ì¡°íšŒ)
app.get("/api/course-application/:id", async (req, res) => {
  try {
    const application = await CourseApplication.findById(req.params.id);
    if (!application) {
      return res.status(404).json({ success: false, message: "í•´ë‹¹ ìˆ˜ê°•ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }
    res.json({ success: true, data: application });
  } catch (error) {
    console.error("ìˆ˜ê°•ì‹ ì²­ ê°œë³„ ì¡°íšŒ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì •ë³´ ìˆ˜ì • (ìŠˆí¼ ê´€ë¦¬ììš©)
app.put("/api/diagnostic-tests/:id", async (req, res) => {
  try {
    const { branchName, studentGrade, studentName, studentPhone, parentName, parentPhone } = req.body;

    const updatedTest = await DiagnosticTest.findByIdAndUpdate(
      req.params.id,
      {
        branchName,
        studentGrade,
        studentName,
        studentPhone,
        parentName,
        parentPhone
      },
      { new: true }
    );

    if (!updatedTest) {
      return res.status(404).json({ success: false, message: "í•´ë‹¹ ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ success: true, data: updatedTest });
  } catch (error) {
    console.error("ì§„ë‹¨í…ŒìŠ¤íŠ¸ ìˆ˜ì • ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìˆ˜ê°•ì‹ ì²­ ì •ë³´ ìˆ˜ì • (ìŠˆí¼ ê´€ë¦¬ììš©)
app.put("/api/course-applications/:id", async (req, res) => {
  try {
    const { branchName, studentGrade, studentName, studentPhone, parentPhone } = req.body;

    const updatedApplication = await CourseApplication.findByIdAndUpdate(
      req.params.id,
      {
        branchName,
        studentGrade,
        studentName,
        studentPhone,
        parentPhone
      },
      { new: true }
    );

    if (!updatedApplication) {
      return res.status(404).json({ success: false, message: "í•´ë‹¹ ìˆ˜ê°•ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ success: true, data: updatedApplication });
  } catch (error) {
    console.error("ìˆ˜ê°•ì‹ ì²­ ìˆ˜ì • ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì„ íƒì‚­ì œ (ìŠˆí¼ ê´€ë¦¬ììš©)
app.delete("/api/diagnostic-tests/delete-selected", async (req, res) => {
  try {
    const { ids } = req.body;
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ success: false, message: "ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”." });
    }
    const result = await DiagnosticTest.deleteMany({ _id: { $in: ids } });
    res.json({ success: true, deletedCount: result.deletedCount });
  } catch (error) {
    console.error("ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì„ íƒì‚­ì œ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìˆ˜ê°•ì‹ ì²­(ì§„ë‹¨í…ŒìŠ¤íŠ¸ ê²°ê³¼) ì„ íƒì‚­ì œ (ìŠˆí¼ ê´€ë¦¬ììš©)
app.delete("/api/course-applications/delete-selected", async (req, res) => {
  try {
    const { ids } = req.body;
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ success: false, message: "ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”." });
    }
    const result = await CourseApplication.deleteMany({ _id: { $in: ids } });
    res.json({ success: true, deletedCount: result.deletedCount });
  } catch (error) {
    console.error("ìˆ˜ê°•ì‹ ì²­ ì„ íƒì‚­ì œ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ê´€ë¦¬ì ì •ë³´ ì¡°íšŒ (ë¸Œëœì¹˜ ê´€ë¦¬ììš©)
app.get("/api/admin/info", async (req, res) => {
  try {
    if (!req.session || !req.session.admin) {
      return res.status(401).json({ success: false, message: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }
    res.json({
      success: true,
      academyName: req.session.admin.academyName || "",
      adminId: req.session.admin.adminId || "",
      grade: req.session.admin.grade || "",
      classNum: req.session.admin.classNum || ""
    });
  } catch (error) {
    console.error("ê´€ë¦¬ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// í•™ìƒ ì¶”ê°€ API (ë¸Œëœì¹˜ ê´€ë¦¬ììš©)
app.post("/api/admin/branch/add-student", async (req, res) => {
  try {
    // ì„¸ì…˜ì—ì„œ ê´€ë¦¬ì ì •ë³´ í™•ì¸
    if (!req.session || !req.session.admin || !req.session.admin.academyName) {
      return res.status(401).json({ success: false, message: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const { grade, name, school, number, classNum } = req.body;

    if (!name || !number) {
      return res.status(400).json({ success: false, message: "ì´ë¦„ê³¼ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤." });
    }

    // ê´€ë¦¬ìì˜ í•™êµ/í•™ë…„/ë°˜ ì •ë³´ ì‚¬ìš©
    const academyName = req.session.admin.academyName;
    const adminGrade = req.session.admin.grade || grade || "";
    const adminClassNum = req.session.admin.classNum || classNum || "";

    // ì „í™”ë²ˆí˜¸(ID) ìë™ ìƒì„±: í•™ë…„+ë°˜+ë²ˆí˜¸ ì¡°í•© (ì˜ˆ: 4í•™ë…„7ë°˜15ë²ˆ â†’ 040715)
    // í•™ë…„ì—ì„œ ìˆ«ì ì¶”ì¶œ
    const gradeNum = (adminGrade || "").replace(/[^0-9]/g, "").padStart(2, "0");
    // ë°˜ì—ì„œ ìˆ«ì ì¶”ì¶œ
    const classNumDigit = (adminClassNum || "").replace(/[^0-9]/g, "").padStart(2, "0");
    // ë²ˆí˜¸ íŒ¨ë”©
    const studentNum = String(number).padStart(2, "0");
    // ìë™ ìƒì„± ID
    const autoPhone = gradeNum + classNumDigit + studentNum;

    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì „í™”ë²ˆí˜¸ì¸ì§€ í™•ì¸
    const existingUser = await User.findOne({ phone: autoPhone });
    if (existingUser) {
      return res.status(400).json({ success: false, message: "ì´ë¯¸ ë“±ë¡ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤. (ID: " + autoPhone + ")" });
    }

    // ìƒˆ í•™ìƒ ìƒì„±
    const newUser = new User({
      grade: adminGrade,
      name: name.trim(),
      phone: autoPhone,
      school: school ? school.trim() : academyName,
      classNum: adminClassNum,
      studentNum: number.trim(),
      status: "approved",
      createdAt: new Date()
    });

    await newUser.save();
    console.log("âœ… í•™ìƒ ì¶”ê°€ ì™„ë£Œ:", newUser.name, "ID:", autoPhone);

    res.json({ success: true, message: "í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: " + autoPhone + ")", data: newUser });
  } catch (error) {
    console.error("í•™ìƒ ì¶”ê°€ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "í•™ìƒ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì§„ë‹¨í…ŒìŠ¤íŠ¸ ëª©ë¡ ì¡°íšŒ (ë¸Œëœì¹˜ ê´€ë¦¬ììš© - ì§€ì ëª…/í•™ë…„ í•„í„°ë§)
app.get("/api/admin/diagnostic-tests", async (req, res) => {
  try {
    // ì„¸ì…˜ì—ì„œ ê´€ë¦¬ì ì •ë³´ í™•ì¸
    if (!req.session || !req.session.admin || !req.session.admin.academyName) {
      return res.status(401).json({ success: false, message: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const academyName = req.session.admin.academyName;
    const adminGrade = req.session.admin.grade;
    const adminClassNum = req.session.admin.classNum;

    // ì§€ì ëª…ìœ¼ë¡œ í•„í„°ë§í•˜ì—¬ ì¡°íšŒ (ì§€ì ëª…ì— academyNameì´ í¬í•¨ëœ ê²½ìš° ë§¤ì¹­)
    const filter = {
      branchName: { $regex: academyName, $options: 'i' }
    };

    // âœ… "ì „ì²´" í•™ë…„ ì„ íƒ ì‹œ í•™ë…„ í•„í„°ë§ ê±´ë„ˆë›°ê¸° (í•´ë‹¹ í•™êµ ì „ì²´ í•™ë…„ í‘œì‹œ)
    if (adminGrade && adminGrade !== "ì „ì²´") {
      filter.studentGrade = adminGrade;
    }

    // âœ… "ì „ì²´" ë°˜ ì„ íƒ ì‹œ ë°˜ í•„í„°ë§ ê±´ë„ˆë›°ê¸° (í•´ë‹¹ í•™êµ ì „ì²´ ë°˜ í‘œì‹œ)
    if (adminClassNum && adminClassNum !== "ì „ì²´") {
      filter.studentClassNum = adminClassNum;
    }

    const tests = await DiagnosticTest.find(filter).sort({ createdAt: -1 });

    res.json({
      success: true,
      data: tests,
      academyName: academyName,
      adminGrade: adminGrade,
      adminClassNum: adminClassNum
    });
  } catch (error) {
    console.error("ë¸Œëœì¹˜ ê´€ë¦¬ì ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìˆ˜ê°•ì‹ ì²­ ëª©ë¡ ì¡°íšŒ (ë¸Œëœì¹˜ ê´€ë¦¬ììš© - ì§€ì ëª… í•„í„°ë§)
app.get("/api/admin/course-applications", async (req, res) => {
  try {
    // ì„¸ì…˜ì—ì„œ ê´€ë¦¬ì ì •ë³´ í™•ì¸
    if (!req.session || !req.session.admin || !req.session.admin.academyName) {
      return res.status(401).json({ success: false, message: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const academyName = req.session.admin.academyName;
    const adminGrade = req.session.admin.grade;
    const adminClassNum = req.session.admin.classNum;

    // ì§€ì ëª…ìœ¼ë¡œ í•„í„°ë§í•˜ì—¬ ì¡°íšŒ (ì§€ì ëª…ì— academyNameì´ í¬í•¨ëœ ê²½ìš° ë§¤ì¹­)
    const filter = {
      branchName: { $regex: academyName, $options: 'i' }
    };

    // âœ… "ì „ì²´" í•™ë…„ ì„ íƒ ì‹œ í•™ë…„ í•„í„°ë§ ê±´ë„ˆë›°ê¸°
    if (adminGrade && adminGrade !== "ì „ì²´") {
      filter.studentGrade = adminGrade;
    }

    // âœ… ë°˜ í•„í„°ë§: ê¸°ì¡´ ë°ì´í„°ëŠ” studentClassNumì´ ì—†ìœ¼ë¯€ë¡œ, í•´ë‹¹ ë°˜ì´ê±°ë‚˜ ë¹ˆ ê°’ì¸ ê²½ìš° ëª¨ë‘ í¬í•¨
    if (adminClassNum && adminClassNum !== "ì „ì²´") {
      filter.$or = [
        { studentClassNum: adminClassNum },
        { studentClassNum: { $exists: false } },
        { studentClassNum: '' },
        { studentClassNum: null }
      ];
    }

    const applications = await CourseApplication.find(filter).sort({ createdAt: -1 });

    res.json({ success: true, data: applications, academyName: academyName, adminGrade: adminGrade, adminClassNum: adminClassNum });
  } catch (error) {
    console.error("ë¸Œëœì¹˜ ê´€ë¦¬ì ìˆ˜ê°•ì‹ ì²­ ì¡°íšŒ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì„ íƒì‚­ì œ (ë¸Œëœì¹˜ ê´€ë¦¬ììš©)
app.delete("/api/admin/diagnostic-tests/delete-selected", async (req, res) => {
  try {
    if (!req.session || !req.session.admin || !req.session.admin.academyName) {
      return res.status(401).json({ success: false, message: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const { ids } = req.body;
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ success: false, message: "ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”." });
    }

    const academyName = req.session.admin.academyName;

    // ìì‹ ì˜ í•™êµì— ì†í•œ í•­ëª©ë§Œ ì‚­ì œ
    const result = await DiagnosticTest.deleteMany({
      _id: { $in: ids },
      branchName: { $regex: academyName, $options: 'i' }
    });

    res.json({ success: true, deletedCount: result.deletedCount });
  } catch (error) {
    console.error("ë¸Œëœì¹˜ ê´€ë¦¬ì ì§„ë‹¨í…ŒìŠ¤íŠ¸ ì„ íƒì‚­ì œ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìˆ˜ê°•ì‹ ì²­(ì§„ë‹¨í…ŒìŠ¤íŠ¸ ê²°ê³¼) ì„ íƒì‚­ì œ (ë¸Œëœì¹˜ ê´€ë¦¬ììš©)
app.delete("/api/admin/course-applications/delete-selected", async (req, res) => {
  try {
    if (!req.session || !req.session.admin || !req.session.admin.academyName) {
      return res.status(401).json({ success: false, message: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const { ids } = req.body;
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ success: false, message: "ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”." });
    }

    const academyName = req.session.admin.academyName;

    // ìì‹ ì˜ í•™êµì— ì†í•œ í•­ëª©ë§Œ ì‚­ì œ
    const result = await CourseApplication.deleteMany({
      _id: { $in: ids },
      branchName: { $regex: academyName, $options: 'i' }
    });

    res.json({ success: true, deletedCount: result.deletedCount });
  } catch (error) {
    console.error("ë¸Œëœì¹˜ ê´€ë¦¬ì ìˆ˜ê°•ì‹ ì²­ ì„ íƒì‚­ì œ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== í•™ìŠµ ì§„í–‰ ë°ì´í„° API (localStorage ëŒ€ì²´) =====

// ë‹¨ì›ë³„ í•™ìŠµ ì§„í–‰ ë°ì´í„° ì €ì¥
app.post("/api/unit-progress/save", async (req, res) => {
  try {
    const { grade, name, unit, data } = req.body;
    console.log('[unit-progress/save] ìš”ì²­:', { grade, name, unit, data });

    if (!grade || !name || !unit) {
      return res.status(400).json({ success: false, message: "grade, name, unitì€ í•„ìˆ˜ì…ë‹ˆë‹¤." });
    }

    let userProgress = await UserProgress.findOne({ grade, name });
    console.log('[unit-progress/save] ê¸°ì¡´ ë¬¸ì„œ:', userProgress ? 'ìˆìŒ' : 'ì—†ìŒ');

    if (!userProgress) {
      userProgress = new UserProgress({ grade, name });
    }

    // unitProgress Mapì— ë°ì´í„° ì €ì¥
    if (!userProgress.unitProgress) {
      userProgress.unitProgress = new Map();
    }

    // Mapì´ ì•„ë‹Œ ê²½ìš° Mapìœ¼ë¡œ ë³€í™˜
    if (!(userProgress.unitProgress instanceof Map)) {
      console.log('[unit-progress/save] unitProgressë¥¼ Mapìœ¼ë¡œ ë³€í™˜');
      userProgress.unitProgress = new Map(Object.entries(userProgress.unitProgress || {}));
    }

    let existingData = userProgress.unitProgress.get(unit) || {};
    // Mongoose subdocumentë¥¼ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜
    if (existingData && typeof existingData.toObject === 'function') {
      existingData = existingData.toObject();
    }
    console.log('[unit-progress/save] ê¸°ì¡´ ë°ì´í„°:', existingData);

    const updatedData = {
      ...existingData,
      ...data,
      lastUpdated: new Date()
    };
    console.log('[unit-progress/save] ì—…ë°ì´íŠ¸ëœ ë°ì´í„°:', updatedData);

    userProgress.unitProgress.set(unit, updatedData);

    // ì™„ë£Œ í˜ì´ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
    if (data.completedPages && Array.isArray(data.completedPages)) {
      if (!userProgress.completedPages) {
        userProgress.completedPages = [];
      }
      data.completedPages.forEach(pageId => {
        if (!userProgress.completedPages.includes(pageId)) {
          userProgress.completedPages.push(pageId);
        }
      });
    }

    await userProgress.save();
    console.log('[unit-progress/save] ì €ì¥ ì™„ë£Œ');

    res.json({ success: true, message: "í•™ìŠµ ì§„í–‰ ë°ì´í„° ì €ì¥ ì™„ë£Œ" });
  } catch (error) {
    console.error("í•™ìŠµ ì§„í–‰ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ë‹¨ì›ë³„ í•™ìŠµ ì§„í–‰ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
app.get("/api/unit-progress/load", async (req, res) => {
  try {
    const { grade, name, unit } = req.query;
    console.log('[unit-progress/load] ìš”ì²­:', { grade, name, unit });

    if (!grade || !name) {
      return res.status(400).json({ success: false, message: "grade, nameì€ í•„ìˆ˜ì…ë‹ˆë‹¤." });
    }

    const userProgress = await UserProgress.findOne({ grade, name });
    console.log('[unit-progress/load] ë¬¸ì„œ:', userProgress ? 'ìˆìŒ' : 'ì—†ìŒ');

    if (!userProgress) {
      return res.json({ success: true, data: null, completedPages: [] });
    }

    // ë””ë²„ê·¸ ë¡œê·¸ ì œê±° (ì„±ëŠ¥ í–¥ìƒ)

    // íŠ¹ì • ë‹¨ì› ë°ì´í„° ë°˜í™˜
    if (unit) {
      let unitData = null;
      if (userProgress.unitProgress) {
        // Mapì¸ ê²½ìš°
        if (userProgress.unitProgress instanceof Map) {
          unitData = userProgress.unitProgress.get(unit);
        } else {
          // Objectì¸ ê²½ìš°
          unitData = userProgress.unitProgress[unit];
        }
      }
      return res.json({
        success: true,
        data: unitData || null,
        completedPages: userProgress.completedPages || []
      });
    }

    // ì „ì²´ ë°ì´í„° ë°˜í™˜ (unit ë¯¸ì§€ì • ì‹œ)
    const allUnitProgress = {};
    if (userProgress.unitProgress) {
      if (userProgress.unitProgress instanceof Map) {
        userProgress.unitProgress.forEach((value, key) => {
          allUnitProgress[key] = value;
        });
      } else {
        Object.assign(allUnitProgress, userProgress.unitProgress);
      }
    }

    res.json({
      success: true,
      data: allUnitProgress,
      completedPages: userProgress.completedPages || []
    });
  } catch (error) {
    console.error("í•™ìŠµ ì§„í–‰ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ë‹¨ì›ë³„ í•™ìŠµ ì§„í–‰ ë°ì´í„° ì‚­ì œ (ë¦¬ì…‹)
app.post("/api/unit-progress/reset", async (req, res) => {
  try {
    const { grade, name, unit } = req.body;

    if (!grade || !name || !unit) {
      return res.status(400).json({ success: false, message: "grade, name, unitì€ í•„ìˆ˜ì…ë‹ˆë‹¤." });
    }

    const userProgress = await UserProgress.findOne({ grade, name });

    if (!userProgress) {
      return res.json({ success: true, message: "ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." });
    }

    // í•´ë‹¹ ë‹¨ì› ë°ì´í„° ì‚­ì œ
    if (userProgress.unitProgress) {
      userProgress.unitProgress.delete(unit);
    }

    // completedPagesì—ì„œ í•´ë‹¹ ë‹¨ì› ê´€ë ¨ í˜ì´ì§€ ì œê±°
    if (userProgress.completedPages) {
      userProgress.completedPages = userProgress.completedPages.filter(
        pageId => !pageId.startsWith(unit)
      );
    }

    await userProgress.save();

    res.json({ success: true, message: "í•™ìŠµ ì§„í–‰ ë°ì´í„° ì‚­ì œ ì™„ë£Œ" });
  } catch (error) {
    console.error("í•™ìŠµ ì§„í–‰ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:", error);
    res.status(500).json({ success: false, message: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ì‹œìŠ¤í…œ =====

// ëª¨ì˜ê³ ì‚¬ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìŠ¤í‚¤ë§ˆ
const mockExamRecommendTaskSchema = new mongoose.Schema({
  userId: { type: String, required: true },           // MockExamUser ID
  phone: { type: String, required: true },            // ì‚¬ìš©ì ì „í™”ë²ˆí˜¸
  areaKey: { type: String, required: true },          // 12ê°œ ì„¸ë¶€ ì˜ì—­ í‚¤ (speechTalk, grammarModern ë“±)
  areaName: { type: String, required: true },         // ì˜ì—­ í•œê¸€ëª… (í™”ë²•, í˜„ëŒ€ë¬¸ë²• ë“±)
  parentArea: { type: String, required: true },       // ìƒìœ„ ì˜ì—­ (speech, grammar, reading, literature)
  correctCount: { type: Number, default: 0 },         // ë§íŒ ë¬¸í•­ ìˆ˜ (-ëŠ” ìµœì´ˆ)
  totalCount: { type: Number, default: 0 },           // ì´ ë¬¸í•­ ìˆ˜ (-ëŠ” ìµœì´ˆ)
  userRate: { type: Number, required: true },         // ì‚¬ìš©ì ì •ë‹µë¥  (%)
  avgRate: { type: Number, required: true },          // í‰ê·  ì •ë‹µë¥  (%)
  diffPercent: { type: Number, required: true },      // ì°¨ì´ (í‰ê·  - ì‚¬ìš©ì)
  weekNumber: { type: Number, required: true },       // í•´ë‹¹ ì£¼ì°¨ ë²ˆí˜¸ (ì£¼ê°„ êµ¬ë¶„ìš©)
  targetMockRound: { type: Number, default: null },   // ëŒ€ìƒ ëª¨ì˜ê³ ì‚¬ íšŒì°¨ (í•™ìƒì´ ì‘ì‹œí•œ íšŒì°¨)
  supplementExamId: { type: String, default: null },  // ì¶”ì²œëœ ë³´ì™„í•™ìŠµ ì‹œí—˜ì§€ ID
  status: {
    type: String,
    enum: ['pending', 'completed'],
    default: 'pending'
  },
  createdAt: { type: Date, default: Date.now },
  completedAt: { type: Date }                         // ì™„ë£Œ ì‹œì 
});
mockExamRecommendTaskSchema.index({ userId: 1, weekNumber: 1 });
mockExamRecommendTaskSchema.index({ phone: 1, weekNumber: 1 });
const MockExamRecommendTask = mongoose.model('MockExamRecommendTask', mockExamRecommendTaskSchema);

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ìŠ¤í‚¤ë§ˆ (ì˜ì—­ë³„ ì‹œí—˜ë¬¸ì œ ì„¸íŠ¸)
const supplementExamSchema = new mongoose.Schema({
  examId: { type: String, required: true, unique: true }, // ì‹œí—˜ì§€ ê³ ìœ  ID (ì˜ˆ: supplement_speechTalk_1)
  areaKey: { type: String, required: true },              // 12ê°œ ì„¸ë¶€ ì˜ì—­ í‚¤ (speechTalk, grammarModern ë“±)
  areaName: { type: String, required: true },             // ì˜ì—­ í•œê¸€ëª… (í™”ë²•, í˜„ëŒ€ë¬¸ë²• ë“±)
  parentArea: { type: String, required: true },           // ìƒìœ„ ì˜ì—­ (speech, grammar, reading, literature)
  title: { type: String, required: true },                // ì‹œí—˜ì§€ ì œëª©
  targetMockRound: { type: Number, default: null },       // ëŒ€ìƒ ëª¨ì˜ê³ ì‚¬ íšŒì°¨ (1, 2, 3...) - í•´ë‹¹ íšŒì°¨ ì‘ì‹œìì—ê²Œ ì¶”ì²œ
  questionCount: { type: Number, default: 0 },            // ë¬¸í•­ ìˆ˜
  questions: [{                                           // ë¬¸ì œ ë°°ì—´
    questionNumber: Number,
    questionText: String,
    passage: String,                                      // ì§€ë¬¸
    options: [String],                                    // ì„ íƒì§€ ë°°ì—´
    correctAnswer: Number,                                // ì •ë‹µ (1-5)
    explanation: String                                   // í•´ì„¤
  }],
  isActive: { type: Boolean, default: true },             // í™œì„±í™” ì—¬ë¶€
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
});
supplementExamSchema.index({ areaKey: 1 });
supplementExamSchema.index({ parentArea: 1 });
const SupplementExam = mongoose.model('SupplementExam', supplementExamSchema);

// ë³´ì™„ í•™ìŠµ í’€ì´ ê²°ê³¼ ìŠ¤í‚¤ë§ˆ (ì‚¬ìš©ìë³„ ì €ì¥)
const supplementResultSchema = new mongoose.Schema({
  examId: { type: String, required: true },              // ì‹œí—˜ì§€ ID (ì˜ˆ: supplement_classic_poem)
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
  phone: { type: String },                               // ì „í™”ë²ˆí˜¸ (ë°±ì—… ì‹ë³„ì)
  studentInfo: {
    name: String,
    school: String,
    grade: String
  },
  answers: { type: Map, of: Number },                    // ë¬¸ì œë³„ ë‹µì•ˆ { "1": 2, "2": 1, ... }
  correctCount: { type: Number, default: 0 },            // ì •ë‹µ ê°œìˆ˜
  totalQuestions: { type: Number, default: 0 },          // ì „ì²´ ë¬¸í•­ ìˆ˜
  score: { type: Number, default: 0 },                   // ì´ì 
  isGraded: { type: Boolean, default: false },           // ì±„ì  ì™„ë£Œ ì—¬ë¶€
  completedAt: { type: Date },                           // ì™„ë£Œ ì‹œì 
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
});
supplementResultSchema.index({ examId: 1, userId: 1 });
supplementResultSchema.index({ examId: 1, phone: 1 });
const SupplementResult = mongoose.model('SupplementResult', supplementResultSchema);

// 12ê°œ ì„¸ë¶€ ì˜ì—­ ì •ë³´
const DETAIL_AREA_INFO = {
  speechTalk: { name: 'í™”ë²•', parent: 'speech' },
  speechWrite: { name: 'ì‘ë¬¸', parent: 'speech' },
  speechIntegrated: { name: 'í™”ì‘í†µí•©', parent: 'speech' },
  grammarModern: { name: 'í˜„ëŒ€ë¬¸ë²•', parent: 'grammar' },
  grammarClassic: { name: 'ì¤‘ì„¸ë¬¸ë²•', parent: 'grammar' },
  readingHumanities: { name: 'ì¸ë¬¸ì‚¬íšŒì˜ˆìˆ ', parent: 'reading' },
  readingScience: { name: 'ê³¼í•™ê¸°ìˆ ', parent: 'reading' },
  readingLaw: { name: 'ë²•ê²½ì œ', parent: 'reading' },
  litModernPoem: { name: 'í˜„ëŒ€ì‹œ', parent: 'literature' },
  litModernNovel: { name: 'í˜„ëŒ€ì†Œì„¤', parent: 'literature' },
  litClassicPoem: { name: 'ê³ ì „ì‹œê°€', parent: 'literature' },
  litClassicProse: { name: 'ê³ ì „ì‚°ë¬¸', parent: 'literature' }
};

// ì‹œí—˜ë³„ 12ê°œ ì„¸ë¶€ ì˜ì—­ ë¬¸í•­ ë§¤í•‘
const examDetailMappingsServer = {
  'korean_mock_1': {
    speechTalk: [1, 2, 4, 5, 6],
    speechWrite: [28, 29, 30],
    speechIntegrated: [24, 25, 26, 27],
    grammarModern: [3, 7, 9, 10],
    grammarClassic: [8],
    readingHumanities: [11, 12, 13],
    readingScience: [14, 15, 16, 17],
    readingLaw: [18, 19, 20, 21, 22, 23],
    litModernPoem: [43, 44, 45],
    litModernNovel: [39, 40, 41, 42],
    litClassicPoem: [34, 35, 36, 37, 38],
    litClassicProse: [31, 32, 33]
  },
  'korean_mock_2': {
    speechTalk: [1, 2, 3],
    speechWrite: [8, 9, 10],
    speechIntegrated: [4, 5, 6, 7],
    grammarModern: [11, 12, 13, 14],
    grammarClassic: [15],
    readingHumanities: [16, 17, 18, 19, 20, 21],
    readingScience: [26, 27, 28, 29],
    readingLaw: [30, 31, 32, 33, 34],
    litModernPoem: [43, 44, 45],
    litModernNovel: [22, 23, 24, 25],
    litClassicPoem: [35, 36, 37, 38],
    litClassicProse: [39, 40, 41, 42]
  },
  'korean_mock_3': {
    speechTalk: [1, 2, 3],
    speechWrite: [8, 9, 10],
    speechIntegrated: [4, 5, 6, 7],
    grammarModern: [11, 12, 14, 15],
    grammarClassic: [13],
    readingHumanities: [20, 21, 22, 23, 24],
    readingScience: [32, 33, 34, 35, 36, 37],
    readingLaw: [28, 29, 30, 31],
    litModernPoem: [43, 44, 45],
    litModernNovel: [16, 17, 18, 19],
    litClassicPoem: [38, 39, 40, 41, 42],
    litClassicProse: [25, 26, 27]
  },
  'korean_mock_4': {
    speechTalk: [1, 2, 3],
    speechWrite: [8, 9, 10],
    speechIntegrated: [4, 5, 6, 7],
    grammarModern: [11, 12, 13, 14],
    grammarClassic: [15],
    readingHumanities: [29, 30, 31, 32, 33],
    readingScience: [38, 39, 40, 41, 42],
    readingLaw: [21, 22, 23, 24, 25],
    litModernPoem: [43, 44, 45],
    litModernNovel: [26, 27, 28],
    litClassicPoem: [16, 17, 18, 19, 20],
    litClassicProse: [34, 35, 36, 37]
  }
};

// í˜„ì¬ ì£¼ì°¨ ë²ˆí˜¸ ê³„ì‚° (2025ë…„ 1ì£¼ì°¨ë¶€í„° ì‹œì‘)
function getWeekNumber(date = new Date()) {
  const startOfYear = new Date(date.getFullYear(), 0, 1);
  const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
  return Math.ceil((days + startOfYear.getDay() + 1) / 7);
}

// AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ì¡°íšŒ API
app.get('/api/mock-exam/recommend-tasks/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const currentWeek = getWeekNumber();

    // userId ë˜ëŠ” visitorIdë¡œ ì‚¬ìš©ì ì¡°íšŒí•˜ì—¬ phone ê°€ì ¸ì˜¤ê¸°
    let phone = null;
    if (mongoose.Types.ObjectId.isValid(userId)) {
      const user = await MockExamUser.findById(userId).select('phone').lean();
      if (user) phone = user.phone;
    }

    // ë¯¸ì™„ë£Œ/ì™„ë£Œ ê³¼ì œ ëª¨ë‘ ì¡°íšŒ (ì™„ë£Œëœ ê³¼ì œë„ ìœ ì§€)
    // userId ë˜ëŠ” phoneìœ¼ë¡œ ì¡°íšŒ
    const userCondition = phone
      ? { $or: [{ userId }, { phone }] }
      : { userId };

    const tasks = await MockExamRecommendTask.find(userCondition)
      .sort({ status: 1, weekNumber: -1, diffPercent: -1 }).lean(); // ë¯¸ì™„ë£Œ(pending) ë¨¼ì €, ê·¸ ë‹¤ìŒ ìµœì‹  ì£¼ì°¨, ì°¨ì´ê°€ í° ìˆœì„œ

    // ê° ê³¼ì œì— í•´ë‹¹í•˜ëŠ” ì‹œí—˜ì§€ ì •ë³´ ì¶”ê°€
    const dbExams = await SupplementExam.find({}).lean();

    // í•˜ë“œì½”ë”©ëœ ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ëª©ë¡ (HTML íŒŒì¼ë¡œ ì§ì ‘ ë§Œë“  ì‹œí—˜ì§€)
    const hardcodedExamsList = [
      { areaKey: 'litClassicPoem', examId: 'supplement_classic_poem', title: 'ê°œì•”ì •ê°€ + ì²­ì²­ê°ê¸°', questionCount: 6, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_classic_poem.html' },
      { areaKey: 'litClassicPoem', examId: 'supplement_classic_poem_geumrusa', title: 'ê¸ˆë£¨ì‚¬ + ê·¸ë¦¬ìš´ ì™¸ì†ë…€', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_classic_poem_geumrusa.html' },
      { areaKey: 'litClassicPoem', examId: 'supplement_classic_poem_gangho', title: 'ê°•í˜¸êµ¬ê°€ + ë°±ìƒë£¨ë³„ê³¡', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_classic_poem_gangho.html' },
      { areaKey: 'speechWrite', examId: 'supplement_writing', title: 'ìì „ê±° ì£¼ì°¨ì¥ ë°©ì¹˜ ë¬¸ì œ', questionCount: 7, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_writing.html' },
      { areaKey: 'grammarClassic', examId: 'supplement_grammar_classic', title: 'ì—°ê²°ì–´ë¯¸+ì£¼ê²©ì¡°ì‚¬', questionCount: 2, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_grammar_classic.html' },
      { areaKey: 'grammarClassic', examId: 'supplement_grammar_classic_case', title: 'ëª©ì ê²©ì¡°ì‚¬+ì„œìˆ ê²©ì¡°ì‚¬', questionCount: 2, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_grammar_classic_case.html' },
      { areaKey: 'grammarClassic', examId: 'supplement_grammar_medieval_honorific', title: 'ë†’ì„ë²•+ì¡°ì‚¬', questionCount: 2, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_grammar_medieval_honorific.html' },
      { areaKey: 'litModernNovel', examId: 'supplement_modern_novel', title: '213í˜¸ ì£¼íƒ', questionCount: 7, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_modern_novel.html' },
      { areaKey: 'speechTalk', examId: 'supplement_speech', title: 'ë°œí‘œ : ì‹ë¬¼ì˜ ì¸ì§€ í–‰ë™', questionCount: 7, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_speech.html' },
      { areaKey: 'speechTalk', examId: 'supplement_speech_food', title: 'ê°•ì—° : ì‹ì¤‘ë… ì˜ˆë°©ë²•', questionCount: 7, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_speech_food.html' },
      { areaKey: 'speechTalk', examId: 'supplement_speech_tea', title: 'ë°œí‘œ : í™ì°¨', questionCount: 8, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_speech_tea.html' },
      { areaKey: 'speechWrite', examId: 'supplement_writing_subscription', title: 'êµ¬ë… ê²½ì œ ì´ìš©', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_writing_subscription.html' },
      { areaKey: 'speechWrite', examId: 'supplement_writing_donation', title: 'ì‘ë¬¸ : ê¸°ë¶€ ë°©ë²•', questionCount: 6, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_writing_donation.html' },
      { areaKey: 'litClassicProse', examId: 'supplement_classic_prose', title: 'ë‹¹íƒœì¢…ì „', questionCount: 6, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_classic_prose.html' },
      { areaKey: 'litClassicProse', examId: 'supplement_classic_prose_nakseong', title: 'ë‚™ì„±ë¹„ë£¡', questionCount: 8, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_classic_prose_nakseong.html' },
      { areaKey: 'litClassicProse', examId: 'supplement_literature_classic_hwangun', title: 'í™©ìš´ì „', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_literature_classic_hwangun.html' },
      { areaKey: 'speechIntegrated', examId: 'supplement_speech_integrated', title: 'í™˜ê²½ ë™ì•„ë¦¬ ëŒ€í™” + ì´ˆê³ ', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_speech_integrated.html' },
      { areaKey: 'speechIntegrated', examId: 'supplement_speech_integrated_job', title: 'ë¯¸ìˆ  ì‹¬ë¦¬ ìƒë‹´ì‚¬', questionCount: 7, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_speech_integrated_job.html' },
      { areaKey: 'speechIntegrated', examId: 'supplement_speech_integrated_aijudge', title: 'ì¸ê³µì§€ëŠ¥ íŒì‚¬ ë„ì… í† ë¡ ', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_speech_integrated_aijudge.html' },
      { areaKey: 'litModernPoem', examId: 'supplement_modern_poem', title: 'ëª©ë ¨ë‚˜ë¬´ ì˜†+ê·¸ë¦¬ìš´ ê³³', questionCount: 6, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_modern_poem.html' },
      { areaKey: 'litModernPoem', examId: 'supplement_literature_poem_sea', title: 'ì£¼ë¨¸ë‹ˆ ì†ì˜ ë°”ë‹¤+ì†ë¦¬ì‚°ì—ì„œ', questionCount: 6, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_literature_poem_sea.html' },
      { areaKey: 'litModernPoem', examId: 'supplement_literature_poem_flower', title: 'ê½ƒí”¼ëŠ” ì‹œì ˆ+ì €ìˆ˜ì§€', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_literature_poem_flower.html' },
      { areaKey: 'litModernNovel', examId: 'supplement_literature_novel_rondo', title: 'ë¡ ë„', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_literature_novel_rondo.html' },
      { areaKey: 'litModernNovel', examId: 'supplement_literature_novel_mother', title: 'ëŠ™ìœ¼ì‹  ì–´ë¨¸ë‹ˆì˜ í–¥ê¸°', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_literature_novel_mother.html' },
      { areaKey: 'grammarModern', examId: 'supplement_grammar_modern', title: 'ë¬¸ì¥ì˜ ì¢…ë¥˜+ìŒìš´ë³€ë™', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_grammar_modern.html' },
      { areaKey: 'grammarModern', examId: 'supplement_grammar_modern_semantic', title: 'ë‹¨ì–´ì˜ë¯¸ê´€ê³„+ìŒìš´ë³€ë™+ì•ˆì€ë¬¸ì¥', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_grammar_modern_semantic.html' },
      { areaKey: 'grammarModern', examId: 'supplement_grammar_word_sound', title: 'ë‹¨ì–´í˜•ì„±ë²•+ìŒìš´ë³€ë™', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_grammar_word_sound.html' },
      { areaKey: 'readingScience', examId: 'supplement_reading_science', title: 'ê¸°ìˆ  : í–…í‹±ìŠ¤', questionCount: 6, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_reading_science.html' },
      { areaKey: 'readingScience', examId: 'supplement_reading_science_tech', title: 'ê¸°ìˆ  : ê·¼ì ‘ ìŠµë„ ì„¼ì„œ', questionCount: 9, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_reading_science_tech.html' },
      { areaKey: 'readingLaw', examId: 'supplement_reading_law', title: 'ë²• : ë¯¼ë²• ê³µìœ ë¬¼ ë¶„í• ', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_reading_law.html' },
      { areaKey: 'readingLaw', examId: 'supplement_reading_law_property', title: 'ë²• : ë¬¼ê¶Œë²•', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_reading_law_property.html' },
      { areaKey: 'readingLaw', examId: 'supplement_reading_law_tax', title: 'ë²• : ë‚©ì„¸ ì˜ë¬´', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_reading_law_tax.html' },
      { areaKey: 'readingHumanities', examId: 'supplement_reading_humanities', title: 'ì¸ë¬¸ : ì–¸ì–´ì² í•™ í¼íŠ¸ë„˜', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 1, pageUrl: '/supplement_reading_humanities.html' },
      { areaKey: 'readingHumanities', examId: 'supplement_reading_humanities_art', title: 'ì˜ˆìˆ  : ë¶„ì„ë¯¸í•™ì˜ ì´í•´', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 2, pageUrl: '/supplement_reading_humanities_art.html' },
      { areaKey: 'readingHumanities', examId: 'supplement_reading_humanities_mimesis', title: 'ì¸ë¬¸ : ë¯¸ë©”ì‹œìŠ¤ì˜ ì‚¼ì¤‘êµ¬ì¡°', questionCount: 5, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_reading_humanities_mimesis.html' },
      { areaKey: 'readingScience', examId: 'supplement_reading_science_solar', title: 'ê³¼í•™ : íƒœì–‘ì „ì§€', questionCount: 4, isActive: true, isHardcoded: true, targetMockRound: 3, pageUrl: '/supplement_reading_science_solar.html' }
    ];

    const allExams = [...dbExams, ...hardcodedExamsList];

    const tasksWithExamInfo = tasks.map(task => {
      // í•´ë‹¹ ì˜ì—­ + íšŒì°¨ì— ë§ëŠ” ì‹œí—˜ì§€ ì°¾ê¸°
      const targetRound = task.targetMockRound;
      let matchedExam = null;

      // 1ì°¨: ì˜ì—­ + íšŒì°¨ ì¼ì¹˜í•˜ëŠ” ì‹œí—˜ì§€
      matchedExam = allExams.find(exam => {
        return exam.areaKey === task.areaKey && exam.targetMockRound === targetRound && exam.isActive !== false;
      });

      // 2ì°¨: ì˜ì—­ë§Œ ì¼ì¹˜í•˜ê³  íšŒì°¨ ë¯¸ì§€ì •ì¸ ì‹œí—˜ì§€
      if (!matchedExam) {
        matchedExam = allExams.find(exam => {
          return exam.areaKey === task.areaKey && (exam.targetMockRound === null || exam.targetMockRound === undefined) && exam.isActive !== false;
        });
      }

      // 3ì°¨: ì˜ì—­ë§Œ ì¼ì¹˜í•˜ëŠ” ì•„ë¬´ ì‹œí—˜ì§€
      if (!matchedExam) {
        matchedExam = allExams.find(exam => exam.areaKey === task.areaKey && exam.isActive !== false);
      }

      return {
        ...task,
        examInfo: matchedExam ? {
          examId: matchedExam.examId,
          title: matchedExam.title,
          pageUrl: matchedExam.pageUrl,
          questionCount: matchedExam.questionCount
        } : null
      };
    });

    res.json({ ok: true, tasks: tasksWithExamInfo, weekNumber: currentWeek });
  } catch (err) {
    console.error('âŒ [/api/mock-exam/recommend-tasks] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ì™„ë£Œ ì²˜ë¦¬ API
app.post('/api/mock-exam/recommend-tasks/:taskId/complete', async (req, res) => {
  try {
    const { taskId } = req.params;

    const task = await MockExamRecommendTask.findByIdAndUpdate(
      taskId,
      { status: 'completed', completedAt: new Date() },
      { new: true }
    );

    if (!task) {
      return res.status(404).json({ ok: false, message: 'ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    res.json({ ok: true, task });
  } catch (err) {
    console.error('âŒ [/api/mock-exam/recommend-tasks/complete] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ëª©í‘œ ì ìˆ˜ ì¡°íšŒ API
app.get('/api/mock-exam/target-score/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const user = await MockExamUser.findById(userId).select('targetScore');

    if (!user) {
      return res.status(404).json({ ok: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    res.json({ ok: true, targetScore: user.targetScore });
  } catch (err) {
    console.error('âŒ [/api/mock-exam/target-score GET] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ëª©í‘œ ì ìˆ˜ ì €ì¥ API
app.put('/api/mock-exam/target-score/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const { targetScore } = req.body;

    if (targetScore !== null && (typeof targetScore !== 'number' || targetScore < 0 || targetScore > 100)) {
      return res.status(400).json({ ok: false, message: 'ëª©í‘œ ì ìˆ˜ëŠ” 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.' });
    }

    const user = await MockExamUser.findByIdAndUpdate(
      userId,
      { targetScore },
      { new: true }
    ).select('targetScore');

    if (!user) {
      return res.status(404).json({ ok: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    console.log(`âœ… [ëª©í‘œì ìˆ˜ ì„¤ì •] ì‚¬ìš©ì ${userId}: ${targetScore}ì `);
    res.json({ ok: true, targetScore: user.targetScore });
  } catch (err) {
    console.error('âŒ [/api/mock-exam/target-score PUT] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// =============================================
// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ê´€ë¦¬ API
// =============================================

// ì‚­ì œëœ í•˜ë“œì½”ë”© ì‹œí—˜ì§€ IDë¥¼ ì €ì¥í•˜ëŠ” Set (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”ë¨)
const deletedHardcodedExams = new Set();

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ì „ì²´ ì¡°íšŒ (ì˜ì—­ë³„ ê·¸ë£¹í•‘)
app.get('/api/supplement-exams', async (req, res) => {
  try {
    const exams = await SupplementExam.find().sort({ areaKey: 1, createdAt: -1 });

    // ì˜ì—­ë³„ë¡œ ê·¸ë£¹í•‘
    const grouped = {};
    for (const key of Object.keys(DETAIL_AREA_INFO)) {
      grouped[key] = {
        areaKey: key,
        areaName: DETAIL_AREA_INFO[key].name,
        parentArea: DETAIL_AREA_INFO[key].parent,
        exams: []
      };
    }

    exams.forEach(exam => {
      if (grouped[exam.areaKey]) {
        grouped[exam.areaKey].exams.push({
          _id: exam._id,
          examId: exam.examId,
          title: exam.title,
          questionCount: exam.questionCount,
          isActive: exam.isActive,
          targetMockRound: exam.targetMockRound || null,
          createdAt: exam.createdAt,
          updatedAt: exam.updatedAt
        });
      }
    });

    // í•˜ë“œì½”ë”©ëœ ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ì¶”ê°€ (HTML íŒŒì¼ë¡œ ì§ì ‘ ë§Œë“  ì‹œí—˜ì§€)
    // targetMockRound: í•´ë‹¹ íšŒì°¨ ëª¨ì˜ê³ ì‚¬ ì‘ì‹œìì—ê²Œ ìš°ì„  ì¶”ì²œ (1=1íšŒì°¨ìš©)
    const hardcodedExams = [
      {
        areaKey: 'litClassicPoem',
        examId: 'supplement_classic_poem',
        title: 'ê°œì•”ì •ê°€ + ì²­ì²­ê°ê¸°',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_classic_poem.html',
        createdAt: new Date('2024-12-30'),
        updatedAt: new Date('2024-12-30')
      },
      {
        areaKey: 'litClassicPoem',
        examId: 'supplement_classic_poem_geumrusa',
        title: 'ê¸ˆë£¨ì‚¬ + ê·¸ë¦¬ìš´ ì™¸ì†ë…€',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_classic_poem_geumrusa.html',
        createdAt: new Date('2025-01-16'),
        updatedAt: new Date('2025-01-16')
      },
      {
        areaKey: 'litClassicPoem',
        examId: 'supplement_classic_poem_gangho',
        title: 'ê°•í˜¸êµ¬ê°€ + ë°±ìƒë£¨ë³„ê³¡',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_classic_poem_gangho.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'speechWrite',
        examId: 'supplement_writing',
        title: 'ìì „ê±° ì£¼ì°¨ì¥ ë°©ì¹˜ ë¬¸ì œ',
        questionCount: 7,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_writing.html',
        createdAt: new Date('2024-12-31'),
        updatedAt: new Date('2024-12-31')
      },
      {
        areaKey: 'grammarClassic',
        examId: 'supplement_grammar_classic',
        title: 'ì—°ê²°ì–´ë¯¸+ì£¼ê²©ì¡°ì‚¬',
        questionCount: 2,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_grammar_classic.html',
        createdAt: new Date('2024-12-31'),
        updatedAt: new Date('2024-12-31')
      },
      {
        areaKey: 'grammarClassic',
        examId: 'supplement_grammar_classic_case',
        title: 'ëª©ì ê²©ì¡°ì‚¬+ì„œìˆ ê²©ì¡°ì‚¬',
        questionCount: 2,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_grammar_classic_case.html',
        createdAt: new Date('2024-12-31'),
        updatedAt: new Date('2024-12-31')
      },
      {
        areaKey: 'grammarClassic',
        examId: 'supplement_grammar_medieval_honorific',
        title: 'ë†’ì„ë²•+ì¡°ì‚¬',
        questionCount: 2,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_grammar_medieval_honorific.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'litModernNovel',
        examId: 'supplement_modern_novel',
        title: '213í˜¸ ì£¼íƒ',
        questionCount: 7,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_modern_novel.html',
        createdAt: new Date('2024-12-31'),
        updatedAt: new Date('2024-12-31')
      },
      {
        areaKey: 'speechTalk',
        examId: 'supplement_speech',
        title: 'ë°œí‘œ : ì‹ë¬¼ì˜ ì¸ì§€ í–‰ë™',
        questionCount: 7,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_speech.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'speechTalk',
        examId: 'supplement_speech_food',
        title: 'ê°•ì—° : ì‹ì¤‘ë… ì˜ˆë°©ë²•',
        questionCount: 7,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_speech_food.html',
        createdAt: new Date('2025-01-16'),
        updatedAt: new Date('2025-01-16')
      },
      {
        areaKey: 'speechTalk',
        examId: 'supplement_speech_tea',
        title: 'ë°œí‘œ : í™ì°¨',
        questionCount: 8,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_speech_tea.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'speechWrite',
        examId: 'supplement_writing_subscription',
        title: 'êµ¬ë… ê²½ì œ ì´ìš©',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_writing_subscription.html',
        createdAt: new Date('2025-01-16'),
        updatedAt: new Date('2025-01-16')
      },
      {
        areaKey: 'speechWrite',
        examId: 'supplement_writing_donation',
        title: 'ì‘ë¬¸ : ê¸°ë¶€ ë°©ë²•',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_writing_donation.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'litClassicProse',
        examId: 'supplement_classic_prose',
        title: 'ë‹¹íƒœì¢…ì „',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_classic_prose.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'litClassicProse',
        examId: 'supplement_classic_prose_nakseong',
        title: 'ë‚™ì„±ë¹„ë£¡',
        questionCount: 8,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_classic_prose_nakseong.html',
        createdAt: new Date('2025-01-16'),
        updatedAt: new Date('2025-01-16')
      },
      {
        areaKey: 'litClassicProse',
        examId: 'supplement_literature_classic_hwangun',
        title: 'í™©ìš´ì „',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_literature_classic_hwangun.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'speechIntegrated',
        examId: 'supplement_speech_integrated',
        title: 'í™˜ê²½ ë™ì•„ë¦¬ ëŒ€í™” + ì´ˆê³ ',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_speech_integrated.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'speechIntegrated',
        examId: 'supplement_speech_integrated_job',
        title: 'ë¯¸ìˆ  ì‹¬ë¦¬ ìƒë‹´ì‚¬',
        questionCount: 7,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_speech_integrated_job.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'speechIntegrated',
        examId: 'supplement_speech_integrated_aijudge',
        title: 'ì¸ê³µì§€ëŠ¥ íŒì‚¬ ë„ì… í† ë¡ ',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_speech_integrated_aijudge.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'litModernPoem',
        examId: 'supplement_modern_poem',
        title: 'ëª©ë ¨ë‚˜ë¬´ ì˜†+ê·¸ë¦¬ìš´ ê³³',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_modern_poem.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'litModernPoem',
        examId: 'supplement_literature_poem_sea',
        title: 'ì£¼ë¨¸ë‹ˆ ì†ì˜ ë°”ë‹¤+ì†ë¦¬ì‚°ì—ì„œ',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_literature_poem_sea.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'litModernPoem',
        examId: 'supplement_literature_poem_flower',
        title: 'ê½ƒí”¼ëŠ” ì‹œì ˆ+ì €ìˆ˜ì§€',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_literature_poem_flower.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'litModernNovel',
        examId: 'supplement_literature_novel_rondo',
        title: 'ë¡ ë„',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_literature_novel_rondo.html',
        createdAt: new Date('2025-01-16'),
        updatedAt: new Date('2025-01-16')
      },
      {
        areaKey: 'litModernNovel',
        examId: 'supplement_literature_novel_mother',
        title: 'ëŠ™ìœ¼ì‹  ì–´ë¨¸ë‹ˆì˜ í–¥ê¸°',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_literature_novel_mother.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'grammarModern',
        examId: 'supplement_grammar_modern',
        title: 'ë¬¸ì¥ì˜ ì¢…ë¥˜+ìŒìš´ë³€ë™',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_grammar_modern.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'grammarModern',
        examId: 'supplement_grammar_modern_semantic',
        title: 'ë‹¨ì–´ì˜ë¯¸ê´€ê³„+ìŒìš´ë³€ë™+ì•ˆì€ë¬¸ì¥',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_grammar_modern_semantic.html',
        createdAt: new Date('2025-01-16'),
        updatedAt: new Date('2025-01-16')
      },
      {
        areaKey: 'grammarModern',
        examId: 'supplement_grammar_word_sound',
        title: 'ë‹¨ì–´í˜•ì„±ë²•+ìŒìš´ë³€ë™',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_grammar_word_sound.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'readingScience',
        examId: 'supplement_reading_science',
        title: 'ê¸°ìˆ  : í–…í‹±ìŠ¤',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_reading_science.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'readingScience',
        examId: 'supplement_reading_science_tech',
        title: 'ê¸°ìˆ  : ê·¼ì ‘ ìŠµë„ ì„¼ì„œ',
        questionCount: 9,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_reading_science_tech.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'readingLaw',
        examId: 'supplement_reading_law',
        title: 'ë²• : ë¯¼ë²• ê³µìœ ë¬¼ ë¶„í• ',
        questionCount: 7,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_reading_law.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'readingLaw',
        examId: 'supplement_reading_law_property',
        title: 'ë²• : ë¬¼ê¶Œë²•',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_reading_law_property.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'readingLaw',
        examId: 'supplement_reading_law_tax',
        title: 'ë²• : ë‚©ì„¸ ì˜ë¬´',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_reading_law_tax.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'readingHumanities',
        examId: 'supplement_reading_humanities',
        title: 'ì¸ë¬¸ : ì–¸ì–´ì² í•™ í¼íŠ¸ë„˜',
        questionCount: 6,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 1,
        pageUrl: '/supplement_reading_humanities.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'readingHumanities',
        examId: 'supplement_reading_humanities_art',
        title: 'ì˜ˆìˆ  : ë¶„ì„ë¯¸í•™ì˜ ì´í•´',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 2,
        pageUrl: '/supplement_reading_humanities_art.html',
        createdAt: new Date('2025-01-01'),
        updatedAt: new Date('2025-01-01')
      },
      {
        areaKey: 'readingHumanities',
        examId: 'supplement_reading_humanities_mimesis',
        title: 'ì¸ë¬¸ : ë¯¸ë©”ì‹œìŠ¤ì˜ ì‚¼ì¤‘êµ¬ì¡°',
        questionCount: 5,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_reading_humanities_mimesis.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
      {
        areaKey: 'readingScience',
        examId: 'supplement_reading_science_solar',
        title: 'ê³¼í•™ : íƒœì–‘ì „ì§€',
        questionCount: 4,
        isActive: true,
        isHardcoded: true,
        targetMockRound: 3,
        pageUrl: '/supplement_reading_science_solar.html',
        createdAt: new Date('2025-01-23'),
        updatedAt: new Date('2025-01-23')
      },
    ];

    hardcodedExams.forEach(exam => {
      // ì‚­ì œëœ í•˜ë“œì½”ë”© ì‹œí—˜ì§€ëŠ” ìŠ¤í‚µ
      if (deletedHardcodedExams.has(exam.examId)) {
        return;
      }
      if (grouped[exam.areaKey]) {
        // ë©”ëª¨ë¦¬ì— ì €ì¥ëœ íšŒì°¨ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        const savedRound = hardcodedExamRounds.get(exam.examId);
        const targetMockRound = savedRound !== undefined ? savedRound : exam.targetMockRound;

        grouped[exam.areaKey].exams.unshift({
          _id: exam.examId,
          examId: exam.examId,
          title: exam.title,
          questionCount: exam.questionCount,
          isActive: exam.isActive,
          isHardcoded: exam.isHardcoded,
          targetMockRound: targetMockRound,
          pageUrl: exam.pageUrl,
          createdAt: exam.createdAt,
          updatedAt: exam.updatedAt
        });
      }
    });

    res.json({ ok: true, data: grouped });
  } catch (err) {
    console.error('âŒ [/api/supplement-exams] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ìƒì„¸ ì¡°íšŒ
app.get('/api/supplement-exams/:examId', async (req, res) => {
  try {
    const { examId } = req.params;
    const exam = await SupplementExam.findOne({ examId });

    if (!exam) {
      return res.status(404).json({ ok: false, message: 'ì‹œí—˜ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    res.json({ ok: true, exam });
  } catch (err) {
    console.error('âŒ [/api/supplement-exams/:examId] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ìƒì„±
app.post('/api/supplement-exams', async (req, res) => {
  try {
    const { areaKey, title, questions } = req.body;

    if (!areaKey || !DETAIL_AREA_INFO[areaKey]) {
      return res.status(400).json({ ok: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì˜ì—­ì…ë‹ˆë‹¤.' });
    }

    // examId ìë™ ìƒì„± (supplement_ì˜ì—­í‚¤_ë²ˆí˜¸)
    const existingCount = await SupplementExam.countDocuments({ areaKey });
    const examId = `supplement_${areaKey}_${existingCount + 1}`;

    const exam = await SupplementExam.create({
      examId,
      areaKey,
      areaName: DETAIL_AREA_INFO[areaKey].name,
      parentArea: DETAIL_AREA_INFO[areaKey].parent,
      title: title || `${DETAIL_AREA_INFO[areaKey].name} ë³´ì™„ í•™ìŠµ ${existingCount + 1}`,
      questionCount: questions ? questions.length : 0,
      questions: questions || []
    });

    res.json({ ok: true, exam });
  } catch (err) {
    console.error('âŒ [POST /api/supplement-exams] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// í•˜ë“œì½”ë”© ì‹œí—˜ì§€ íšŒì°¨ ìˆ˜ì • (ë©”ëª¨ë¦¬ì— ì €ì¥) - ë” êµ¬ì²´ì ì¸ ë¼ìš°íŠ¸ê°€ ë¨¼ì € ì™€ì•¼ í•¨!
const hardcodedExamRounds = new Map(); // examId -> targetMockRound

app.put('/api/supplement-exams/hardcoded/:examId/round', async (req, res) => {
  try {
    const { examId } = req.params;
    const { targetMockRound } = req.body;

    hardcodedExamRounds.set(examId, targetMockRound);

    console.log(`âœ… [PUT /api/supplement-exams/hardcoded/${examId}/round] íšŒì°¨ ì„¤ì •: ${targetMockRound || 'ì—†ìŒ'}`);
    res.json({ ok: true, message: 'íšŒì°¨ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì˜êµ¬ ì €ì¥í•˜ë ¤ë©´ server.jsë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.)' });
  } catch (err) {
    console.error('âŒ [PUT /api/supplement-exams/hardcoded/:examId/round] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'íšŒì°¨ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ íšŒì°¨ ìˆ˜ì • (DB ì‹œí—˜ì§€ìš©)
app.put('/api/supplement-exams/:examId/round', async (req, res) => {
  try {
    const { examId } = req.params;
    const { targetMockRound } = req.body;

    const exam = await SupplementExam.findOneAndUpdate(
      { examId },
      { targetMockRound, updatedAt: new Date() },
      { new: true }
    );

    if (!exam) {
      return res.status(404).json({ ok: false, message: 'ì‹œí—˜ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    console.log(`âœ… [PUT /api/supplement-exams/${examId}/round] íšŒì°¨ ì„¤ì •: ${targetMockRound || 'ì—†ìŒ'}`);
    res.json({ ok: true, exam });
  } catch (err) {
    console.error('âŒ [PUT /api/supplement-exams/:examId/round] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'íšŒì°¨ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ìˆ˜ì •
app.put('/api/supplement-exams/:examId', async (req, res) => {
  try {
    const { examId } = req.params;
    const { title, questions, isActive } = req.body;

    const updateData = { updatedAt: new Date() };
    if (title !== undefined) updateData.title = title;
    if (questions !== undefined) {
      updateData.questions = questions;
      updateData.questionCount = questions.length;
    }
    if (isActive !== undefined) updateData.isActive = isActive;

    const exam = await SupplementExam.findOneAndUpdate(
      { examId },
      updateData,
      { new: true }
    );

    if (!exam) {
      return res.status(404).json({ ok: false, message: 'ì‹œí—˜ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    res.json({ ok: true, exam });
  } catch (err) {
    console.error('âŒ [PUT /api/supplement-exams/:examId] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ë³´ì™„ í•™ìŠµ ì‹œí—˜ì§€ ì‚­ì œ
app.delete('/api/supplement-exams/:examId', async (req, res) => {
  try {
    const { examId } = req.params;

    const exam = await SupplementExam.findOneAndDelete({ examId });

    if (!exam) {
      return res.status(404).json({ ok: false, message: 'ì‹œí—˜ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    res.json({ ok: true, message: 'ì‹œí—˜ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (err) {
    console.error('âŒ [DELETE /api/supplement-exams/:examId] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// í•˜ë“œì½”ë”©ëœ ì‹œí—˜ì§€ ì‚­ì œ (ë¹„í™œì„±í™”) - ëŸ°íƒ€ì„ì—ì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¹„í™œì„±í™” ì²˜ë¦¬
app.delete('/api/supplement-exams/hardcoded/:examId', async (req, res) => {
  try {
    const { examId } = req.params;

    // ì‚­ì œëœ ëª©ë¡ì— ì¶”ê°€
    deletedHardcodedExams.add(examId);

    console.log(`âœ… [DELETE /api/supplement-exams/hardcoded/${examId}] í•˜ë“œì½”ë”© ì‹œí—˜ì§€ ë¹„í™œì„±í™”ë¨`);
    res.json({ ok: true, message: 'ì‹œí—˜ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì¬ì‹œì‘ ì‹œ ë³µêµ¬ë©ë‹ˆë‹¤. ì˜êµ¬ ì‚­ì œí•˜ë ¤ë©´ server.jsì—ì„œ ì§ì ‘ ì œê±°í•˜ì„¸ìš”.)' });
  } catch (err) {
    console.error('âŒ [DELETE /api/supplement-exams/hardcoded/:examId] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ===== ë³´ì™„ í•™ìŠµ í’€ì´ ê²°ê³¼ ì €ì¥/ì¡°íšŒ API =====

// ë³´ì™„ í•™ìŠµ ë‹µì•ˆ ì €ì¥ (ì‹¤ì‹œê°„ ì €ì¥)
app.post('/api/supplement-result/save-answer', async (req, res) => {
  try {
    const { examId, questionNumber, answer } = req.body;
    const userId = req.session?.user?._id;
    const phone = req.session?.user?.phone;

    if (!examId || !questionNumber || answer === undefined) {
      return res.status(400).json({ ok: false, message: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ (orphan ë°ì´í„° ë°©ì§€)
    if (!userId && !phone) {
      console.log(`âš ï¸ [ë³´ì™„í•™ìŠµ] ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ë‹µì•ˆ ì €ì¥ ìŠ¤í‚µ: ${examId}`);
      return res.json({ ok: true, skipped: true, message: 'ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' });
    }

    // ê¸°ì¡´ ê²°ê³¼ ì°¾ê¸° ë˜ëŠ” ìƒˆë¡œ ìƒì„±
    const queryConditions = [];
    if (userId) queryConditions.push({ userId });
    if (phone) queryConditions.push({ phone });

    let result = await SupplementResult.findOne({
      examId,
      $or: queryConditions
    });

    if (!result) {
      result = new SupplementResult({
        examId,
        userId,
        phone,
        studentInfo: {
          name: req.session?.user?.name,
          school: req.session?.user?.school,
          grade: req.session?.user?.grade
        },
        answers: new Map()
      });
    }

    // ë‹µì•ˆ ì €ì¥
    result.answers.set(String(questionNumber), answer);
    result.updatedAt = new Date();
    await result.save();

    console.log(`âœ… [ë³´ì™„í•™ìŠµ] ë‹µì•ˆ ì €ì¥: ${examId} - ë¬¸ì œ ${questionNumber} = ${answer} (ì‚¬ìš©ì: ${phone || userId})`);
    res.json({ ok: true });
  } catch (err) {
    console.error('âŒ [POST /api/supplement-result/save-answer] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ë‹µì•ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë³´ì™„ í•™ìŠµ ì±„ì  ê²°ê³¼ ì €ì¥
app.post('/api/supplement-result/save-grade', async (req, res) => {
  try {
    const { examId, answers, correctCount, totalQuestions, score, userId: clientUserId, phone: clientPhone, studentInfo: clientStudentInfo } = req.body;
    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•œ ì •ë³´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜´
    const userId = clientUserId || req.session?.user?._id;
    const phone = clientPhone || req.session?.user?.phone;
    const studentInfo = clientStudentInfo || {
      name: req.session?.user?.name,
      school: req.session?.user?.school,
      grade: req.session?.user?.grade
    };

    if (!examId) {
      return res.status(400).json({ ok: false, message: 'ì‹œí—˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
    if (!userId && !phone) {
      return res.status(400).json({ ok: false, message: 'ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // ê¸°ì¡´ ê²°ê³¼ ì°¾ê¸° ë˜ëŠ” ìƒˆë¡œ ìƒì„±
    const queryConditions = [];
    if (userId) queryConditions.push({ userId });
    if (phone) queryConditions.push({ phone });

    let result = await SupplementResult.findOne({
      examId,
      $or: queryConditions
    });

    if (!result) {
      result = new SupplementResult({
        examId,
        userId,
        phone,
        studentInfo
      });
    }

    // ì±„ì  ê²°ê³¼ ì €ì¥
    if (answers) {
      result.answers = new Map(Object.entries(answers));
    }
    result.correctCount = correctCount || 0;
    result.totalQuestions = totalQuestions || 0;
    result.score = score || 0;
    result.isGraded = true;
    result.completedAt = new Date();
    result.updatedAt = new Date();
    await result.save();

    // í•´ë‹¹ ë³´ì™„í•™ìŠµ ê³¼ì œì˜ statusë¥¼ completedë¡œ ì—…ë°ì´íŠ¸
    const taskQueryConditions = [];
    if (userId && mongoose.Types.ObjectId.isValid(userId)) {
      taskQueryConditions.push({ userId });
    }
    if (phone) taskQueryConditions.push({ phone });

    if (taskQueryConditions.length > 0) {
      await MockExamRecommendTask.updateMany(
        {
          $or: taskQueryConditions,
          supplementExamId: examId,
          status: { $ne: 'completed' }
        },
        { $set: { status: 'completed', completedAt: new Date() } }
      );
    }

    console.log(`âœ… [ë³´ì™„í•™ìŠµ] ì±„ì  ì™„ë£Œ: ${examId} - ${correctCount}/${totalQuestions} (${score}ì ) (ì‚¬ìš©ì: ${phone || userId})`);
    res.json({ ok: true, result: { correctCount, totalQuestions, score } });
  } catch (err) {
    console.error('âŒ [POST /api/supplement-result/save-grade] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì±„ì  ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë³´ì™„ í•™ìŠµ ê²°ê³¼ ì¡°íšŒ (ì‚¬ìš©ìë³„)
app.get('/api/supplement-result/:examId', async (req, res) => {
  try {
    const { examId } = req.params;
    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•œ ì •ë³´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜´
    const userId = req.query.userId || req.session?.user?._id;
    const phone = req.query.phone || req.session?.user?.phone;

    // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ê²°ê³¼ ì—†ìŒìœ¼ë¡œ ë°˜í™˜ (ë³´ì•ˆ)
    if (!userId && !phone) {
      return res.json({ ok: true, result: null });
    }

    // userIdë‚˜ phoneì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¡°íšŒ
    // visitor_xxx í˜•íƒœì˜ userIdëŠ” ObjectIdê°€ ì•„ë‹ˆë¯€ë¡œ ê²€ì¦ í•„ìš”
    const queryConditions = [];
    if (userId && mongoose.Types.ObjectId.isValid(userId)) {
      queryConditions.push({ userId });
    }
    if (phone) queryConditions.push({ phone });

    // ì¿¼ë¦¬ ì¡°ê±´ì´ ì—†ìœ¼ë©´ ê²°ê³¼ ì—†ìŒ ë°˜í™˜
    if (queryConditions.length === 0) {
      return res.json({ ok: true, result: null });
    }

    const result = await SupplementResult.findOne({
      examId,
      $or: queryConditions
    });

    if (!result) {
      return res.json({ ok: true, result: null });
    }

    // Mapì„ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜
    const answersObj = {};
    if (result.answers) {
      result.answers.forEach((value, key) => {
        answersObj[key] = value;
      });
    }

    res.json({
      ok: true,
      result: {
        examId: result.examId,
        answers: answersObj,
        correctCount: result.correctCount,
        totalQuestions: result.totalQuestions,
        score: result.score,
        isGraded: result.isGraded,
        completedAt: result.completedAt
      }
    });
  } catch (err) {
    console.error('âŒ [GET /api/supplement-result/:examId] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ê²°ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë³´ì™„ í•™ìŠµ ê²°ê³¼ ì´ˆê¸°í™” (ë‹¤ì‹œ í’€ê¸°)
app.delete('/api/supplement-result/:examId', async (req, res) => {
  try {
    const { examId } = req.params;
    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë°›ê¸° (ì„¸ì…˜ ë§Œë£Œ ëŒ€ë¹„)
    const userId = req.query.userId || req.session?.user?._id;
    const phone = req.query.phone || req.session?.user?.phone;

    // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
    if (!userId && !phone) {
      return res.status(400).json({ ok: false, message: 'ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const queryConditions = [];
    if (userId) queryConditions.push({ userId });
    if (phone) queryConditions.push({ phone });

    await SupplementResult.deleteOne({
      examId,
      $or: queryConditions
    });

    console.log(`âœ… [ë³´ì™„í•™ìŠµ] ê²°ê³¼ ì´ˆê¸°í™”: ${examId} (ì‚¬ìš©ì: ${phone || userId})`);
    res.json({ ok: true });
  } catch (err) {
    console.error('âŒ [DELETE /api/supplement-result/:examId] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ===== ì˜ˆì¸¡ ë ˆì´ë” ë°ì´í„° API (ì‹¤ì œ ëª¨ì˜ê³ ì‚¬ + ë³´ì™„í•™ìŠµ ëˆ„ì ) =====
app.get('/api/mock-exam/supplement-progress/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const phone = req.query.phone;

    if (!userId && !phone) {
      return res.json({ ok: false, message: 'ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // 1. ì‚¬ìš©ìì˜ ëª¨ë“  ë³´ì™„í•™ìŠµ ê²°ê³¼ ì¡°íšŒ (ì±„ì  ì™„ë£Œëœ ê²ƒë§Œ)
    const queryConditions = [];
    // SupplementResult.userIdëŠ” ObjectId íƒ€ì…ì´ë¯€ë¡œ ë³€í™˜ í•„ìš”
    if (userId && userId !== 'undefined') {
      try {
        queryConditions.push({ userId: new mongoose.Types.ObjectId(userId) });
      } catch (e) {
        // ObjectId ë³€í™˜ ì‹¤íŒ¨ì‹œ ë¬¸ìì—´ë¡œ ì‹œë„
        queryConditions.push({ userId });
      }
    }
    if (phone) queryConditions.push({ phone });

    // ì¡°ê±´ì´ ì—†ìœ¼ë©´ ë¹ˆ ê²°ê³¼ ë°˜í™˜
    if (queryConditions.length === 0) {
      return res.json({ ok: true, progress: { speech: { correct: 0, total: 0, percent: 0 }, grammar: { correct: 0, total: 0, percent: 0 }, reading: { correct: 0, total: 0, percent: 0 }, literature: { correct: 0, total: 0, percent: 0 } } });
    }

    const supplementResults = await SupplementResult.find({
      $or: queryConditions,
      isGraded: true
    });

    // 2. ëª¨ë“  ë³´ì™„í•™ìŠµ ì‹œí—˜ì§€ ì¡°íšŒ (parentArea, areaKey ë§¤í•‘ì„ ìœ„í•´)
    const supplementExams = await SupplementExam.find({});
    const examAreaMap = {
      // í•˜ë“œì½”ë”©ëœ ì‹œí—˜ì§€ ë§¤í•‘ (HTML íŒŒì¼ ê¸°ë°˜)
      'supplement_classic_poem': { parentArea: 'literature', areaKey: 'litClassicPoem' },
      'supplement_classic_poem_geumrusa': { parentArea: 'literature', areaKey: 'litClassicPoem' },
      'supplement_classic_poem_gangho': { parentArea: 'literature', areaKey: 'litClassicPoem' },
      'supplement_classic_prose': { parentArea: 'literature', areaKey: 'litClassicProse' },
      'supplement_classic_prose_nakseong': { parentArea: 'literature', areaKey: 'litClassicProse' },
      'supplement_writing': { parentArea: 'speech', areaKey: 'speechWrite' },
      'supplement_grammar_classic': { parentArea: 'grammar', areaKey: 'grammarClassic' },
      'supplement_grammar_classic_case': { parentArea: 'grammar', areaKey: 'grammarClassic' },
      'supplement_modern_novel': { parentArea: 'literature', areaKey: 'litModernNovel' },
      'supplement_speech': { parentArea: 'speech', areaKey: 'speechTalk' },
      'supplement_modern_poem': { parentArea: 'literature', areaKey: 'litModernPoem' },
      'supplement_grammar_modern': { parentArea: 'grammar', areaKey: 'grammarModern' },
      'supplement_grammar_modern_semantic': { parentArea: 'grammar', areaKey: 'grammarModern' },
      'supplement_reading_science': { parentArea: 'reading', areaKey: 'readingScience' },
      'supplement_reading_science_tech': { parentArea: 'reading', areaKey: 'readingScience' },
      'supplement_reading_science_solar': { parentArea: 'reading', areaKey: 'readingScience' },
      'supplement_reading_law': { parentArea: 'reading', areaKey: 'readingLaw' },
      'supplement_reading_law_property': { parentArea: 'reading', areaKey: 'readingLaw' },
      'supplement_reading_social': { parentArea: 'reading', areaKey: 'readingHumanities' },
      'supplement_reading_tech': { parentArea: 'reading', areaKey: 'readingScience' },
      'supplement_reading_humanities': { parentArea: 'reading', areaKey: 'readingHumanities' },
      'supplement_reading_humanities_art': { parentArea: 'reading', areaKey: 'readingHumanities' },
      'supplement_reading_humanities_mimesis': { parentArea: 'reading', areaKey: 'readingHumanities' },
      'supplement_reading_art': { parentArea: 'reading', areaKey: 'readingHumanities' },
      'supplement_speech_integrated': { parentArea: 'speech', areaKey: 'speechIntegrated' },
      'supplement_speech_integrated_job': { parentArea: 'speech', areaKey: 'speechIntegrated' },
      'supplement_speech_integrated_aijudge': { parentArea: 'speech', areaKey: 'speechIntegrated' },
      'supplement_speech_food': { parentArea: 'speech', areaKey: 'speechTalk' },
      'supplement_speech_tea': { parentArea: 'speech', areaKey: 'speechTalk' },
      'supplement_writing_subscription': { parentArea: 'speech', areaKey: 'speechWrite' },
      'supplement_writing_donation': { parentArea: 'speech', areaKey: 'speechWrite' },
      'supplement_literature_poem_sea': { parentArea: 'literature', areaKey: 'litModernPoem' },
      'supplement_literature_novel_rondo': { parentArea: 'literature', areaKey: 'litModernNovel' },
      'supplement_literature_novel_mother': { parentArea: 'literature', areaKey: 'litModernNovel' },
      'supplement_literature_classic_hwangun': { parentArea: 'literature', areaKey: 'litClassicProse' },
      'supplement_literature_poem_flower': { parentArea: 'literature', areaKey: 'litModernPoem' },
      'supplement_reading_law_tax': { parentArea: 'reading', areaKey: 'readingLaw' },
      'supplement_grammar_word_sound': { parentArea: 'grammar', areaKey: 'grammarModern' },
      'supplement_grammar_medieval_honorific': { parentArea: 'grammar', areaKey: 'grammarClassic' }
    };
    // DBì— ì €ì¥ëœ ì‹œí—˜ì§€ ë§¤í•‘ ì¶”ê°€
    supplementExams.forEach(exam => {
      examAreaMap[exam.examId] = { parentArea: exam.parentArea, areaKey: exam.areaKey };
    });

    // 3. ì˜ì—­ë³„ ë³´ì™„í•™ìŠµ ì •ë‹µ ì§‘ê³„ (4ê°œ ëŒ€ë¶„ë¥˜)
    const supplementProgress = {
      speech: { correct: 0, total: 0 },
      grammar: { correct: 0, total: 0 },
      reading: { correct: 0, total: 0 },
      literature: { correct: 0, total: 0 }
    };

    // 12ê°œ ì„¸ë¶€ ì˜ì—­ë³„ ì§‘ê³„
    const detailProgress = {
      speechTalk: { correct: 0, total: 0 },
      speechWrite: { correct: 0, total: 0 },
      speechIntegrated: { correct: 0, total: 0 },
      grammarModern: { correct: 0, total: 0 },
      grammarClassic: { correct: 0, total: 0 },
      readingHumanities: { correct: 0, total: 0 },
      readingScience: { correct: 0, total: 0 },
      readingLaw: { correct: 0, total: 0 },
      litModernPoem: { correct: 0, total: 0 },
      litClassicPoem: { correct: 0, total: 0 },
      litModernNovel: { correct: 0, total: 0 },
      litClassicProse: { correct: 0, total: 0 }
    };

    supplementResults.forEach(result => {
      const mapping = examAreaMap[result.examId];
      if (mapping) {
        const { parentArea, areaKey } = mapping;
        // ëŒ€ë¶„ë¥˜ ì§‘ê³„
        if (parentArea && supplementProgress[parentArea]) {
          supplementProgress[parentArea].correct += result.correctCount || 0;
          supplementProgress[parentArea].total += result.totalQuestions || 0;
        }
        // ì„¸ë¶€ ì˜ì—­ ì§‘ê³„
        if (areaKey && detailProgress[areaKey]) {
          detailProgress[areaKey].correct += result.correctCount || 0;
          detailProgress[areaKey].total += result.totalQuestions || 0;
        }
      }
    });

    // 4. AI ì¶”ì²œ ë³´ì™„ ê³¼ì œ ì™„ë£Œ ë°ì´í„°ë„ ì¶”ê°€ (MockExamRecommendTaskì—ì„œ status='completed'ì¸ ê²ƒ)
    // ë‹¨, SupplementResultì— ì´ë¯¸ ìˆëŠ” ë³´ì™„í•™ìŠµì€ ì¤‘ë³µ ì§‘ê³„í•˜ì§€ ì•ŠìŒ
    const recommendTaskQuery = [];
    if (userId && userId !== 'undefined') recommendTaskQuery.push({ userId });
    if (phone) recommendTaskQuery.push({ phone });

    // SupplementResultì—ì„œ ì´ë¯¸ ì§‘ê³„ëœ examId ëª©ë¡ ìƒì„±
    const alreadyCountedExamIds = new Set(supplementResults.map(r => r.examId));

    if (recommendTaskQuery.length > 0) {
      const completedTasks = await MockExamRecommendTask.find({
        $or: recommendTaskQuery,
        status: 'completed'
      });

      let skippedCount = 0;
      completedTasks.forEach(task => {
        // ì´ë¯¸ SupplementResultì—ì„œ ì§‘ê³„ëœ ë³´ì™„í•™ìŠµì´ë©´ ìŠ¤í‚µ (ì¤‘ë³µ ë°©ì§€)
        if (task.supplementExamId && alreadyCountedExamIds.has(task.supplementExamId)) {
          skippedCount++;
          return;
        }

        const parentArea = task.parentArea;
        const areaKey = task.areaKey;
        const taskTotal = task.totalCount || 5;
        const taskCorrect = task.correctCount || Math.round(taskTotal * (task.avgRate || 70) / 100);

        // ëŒ€ë¶„ë¥˜ ì§‘ê³„
        if (parentArea && supplementProgress[parentArea]) {
          supplementProgress[parentArea].correct += taskCorrect;
          supplementProgress[parentArea].total += taskTotal;
        }
        // ì„¸ë¶€ ì˜ì—­ ì§‘ê³„
        if (areaKey && detailProgress[areaKey]) {
          detailProgress[areaKey].correct += taskCorrect;
          detailProgress[areaKey].total += taskTotal;
        }
      });

      console.log(`[ì˜ˆì¸¡ë ˆì´ë”] AI ì¶”ì²œ ê³¼ì œ ì™„ë£Œ ${completedTasks.length}ê±´ ì¤‘ ${skippedCount}ê±´ ì¤‘ë³µìœ¼ë¡œ ìŠ¤í‚µ, ${completedTasks.length - skippedCount}ê±´ ë°˜ì˜`);
    }

    // 5. í¼ì„¼íŠ¸ ê³„ì‚° (ëŒ€ë¶„ë¥˜)
    Object.keys(supplementProgress).forEach(area => {
      const data = supplementProgress[area];
      data.percent = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
    });

    // ì„¸ë¶€ ì˜ì—­ í¼ì„¼íŠ¸ ê³„ì‚°
    Object.keys(detailProgress).forEach(area => {
      const data = detailProgress[area];
      data.percent = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
    });

    console.log(`[ì˜ˆì¸¡ë ˆì´ë”] ì‚¬ìš©ì ${userId || phone} ë³´ì™„í•™ìŠµ ì§„í–‰í˜„í™©:`, supplementProgress);

    res.json({
      ok: true,
      progress: supplementProgress,
      detailProgress: detailProgress
    });
  } catch (err) {
    console.error('âŒ [GET /api/mock-exam/supplement-progress] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„± í•¨ìˆ˜ (ì‚¬ìš©ìë³„)
async function generateRecommendTasksForUser(userId, phone, targetRound = null) {
  try {
    const currentWeek = getWeekNumber();

    // ê¸°ì¡´ ê³¼ì œ ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ ìƒˆ íšŒì°¨ ê³¼ì œëŠ” ì¶”ê°€ ìƒì„± (ì•„ë˜ existingTaskKeysë¡œ ì¤‘ë³µ ì²´í¬)
    // targetRoundê°€ ì§€ì •ë˜ë©´ í•´ë‹¹ íšŒì°¨ë§Œ, ì—†ìœ¼ë©´ ëª¨ë“  ì™„ë£Œ íšŒì°¨ì— ëŒ€í•´ ê³¼ì œ ìƒì„±

    // ì‚¬ìš©ìì˜ ëª¨ë“  ëª¨ì˜ê³ ì‚¬ ê²°ê³¼ ì¡°íšŒ
    const results = await MockExamResult.find({
      $or: [
        { userId },
        { 'studentInfo.phoneNumber': phone }
      ]
    }).sort({ completedAt: -1 });

    if (!results || results.length === 0) {
      console.log(`[RecommendTask] ì‚¬ìš©ì ${userId}ì˜ ëª¨ì˜ê³ ì‚¬ ê²°ê³¼ ì—†ìŒ`);
      return;
    }

    // 12ê°œ ì„¸ë¶€ ì˜ì—­ë³„ ì ìˆ˜ ê³„ì‚°
    const scores = {};
    Object.keys(DETAIL_AREA_INFO).forEach(key => {
      scores[key] = { correct: 0, total: 0 };
    });

    // ê° íšŒì°¨ë³„ ìµœì‹  ê²°ê³¼ 1ê°œì”©ë§Œ ì‚¬ìš©
    const latestByExam = {};
    results.forEach(result => {
      const examId = result.examId || 'korean_mock_1';
      if (!latestByExam[examId]) {
        latestByExam[examId] = result;
      }
    });

    Object.values(latestByExam).forEach(result => {
      const examId = result.examId || 'korean_mock_1';
      const areaQuestions = examDetailMappingsServer[examId] || examDetailMappingsServer['korean_mock_1'];
      const wrongAnswers = result.wrongAnswers || [];
      const wrongQuestionNums = wrongAnswers.map(w => w.questionNum);

      Object.keys(areaQuestions).forEach(key => {
        const questions = areaQuestions[key];
        questions.forEach(qNum => {
          scores[key].total++;
          if (!wrongQuestionNums.includes(qNum)) {
            scores[key].correct++;
          }
        });
      });
    });

    // ì •ë‹µë¥  ê³„ì‚°
    Object.keys(scores).forEach(key => {
      scores[key].rate = scores[key].total > 0
        ? Math.round((scores[key].correct / scores[key].total) * 100)
        : 0;
    });

    // ì‚¬ìš©ìì˜ ì „ì²´ í‰ê·  ì ìˆ˜ ê³„ì‚° (ìƒë‹¨ì— í‘œì‹œë˜ëŠ” í‰ê·  ì ìˆ˜ì™€ ë™ì¼)
    // ê° íšŒì°¨ë³„ ìµœì‹  ê²°ê³¼ì˜ ì ìˆ˜ í‰ê· 
    const examResults = Object.values(latestByExam);
    const totalScore = examResults.reduce((sum, r) => sum + (r.score || 0), 0);
    const avgScore = examResults.length > 0 ? Math.round(totalScore / examResults.length) : 0;

    // ì‚¬ìš©ìì˜ ëª©í‘œ ì ìˆ˜ ì¡°íšŒ (ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ëª©í‘œ ì ìˆ˜, ì—†ìœ¼ë©´ í˜„ì¬ í‰ê·  ì ìˆ˜ ì‚¬ìš©)
    const user = await MockExamUser.findById(userId).select('targetScore');
    const targetScore = (user && user.targetScore !== null) ? user.targetScore : avgScore;

    // ëª©í‘œ ì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
    const AVG_RATE = targetScore;
    console.log(`[RecommendTask] ì‚¬ìš©ì ${userId} í‰ê·  ì ìˆ˜: ${avgScore}ì , ëª©í‘œ ì ìˆ˜: ${targetScore}ì `);

    // í‰ê·  ëŒ€ë¹„ ì°¨ì´ ê³„ì‚° ë° ê³¼ì œ ëŒ€ìƒ ì„ ì •
    const taskCandidates = [];
    Object.keys(scores).forEach(key => {
      const userRate = scores[key].rate;
      const diff = AVG_RATE - userRate; // í‰ê·  - ì‚¬ìš©ì (ì–‘ìˆ˜ë©´ ì‚¬ìš©ìê°€ ë‚®ìŒ)

      if (diff > 5) { // 6% ì´ìƒ ì°¨ì´ë‚˜ë©´ ê³¼ì œ ëŒ€ìƒ
        taskCandidates.push({
          areaKey: key,
          areaName: DETAIL_AREA_INFO[key].name,
          parentArea: DETAIL_AREA_INFO[key].parent,
          correctCount: scores[key].correct,
          totalCount: scores[key].total,
          userRate,
          avgRate: AVG_RATE,
          diffPercent: diff
        });
      }
    });

    // ì°¨ì´ê°€ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬
    taskCandidates.sort((a, b) => b.diffPercent - a.diffPercent);

    // í•™ìƒì´ ì‘ì‹œí•œ ëª¨ì˜ê³ ì‚¬ íšŒì°¨ ëª©ë¡ ì¶”ì¶œ (1íšŒì°¨, 2íšŒì°¨ ë“±)
    const completedRounds = new Set();
    Object.keys(latestByExam).forEach(examId => {
      // examId í˜•ì‹: korean_mock_1, korean_mock_2 ë“±ì—ì„œ íšŒì°¨ ì¶”ì¶œ
      const match = examId.match(/korean_mock_(\d+)/);
      if (match) {
        completedRounds.add(parseInt(match[1]));
      }
    });
    const latestCompletedRound = Math.max(...completedRounds) || 1;
    console.log(`[RecommendTask] ì‚¬ìš©ì ${userId} ì‘ì‹œ íšŒì°¨: ${[...completedRounds].join(', ')}, ìµœì‹  íšŒì°¨: ${latestCompletedRound}`);

    // í•´ë‹¹ íšŒì°¨ì— ë§ëŠ” ë³´ì™„í•™ìŠµ ì‹œí—˜ì§€ ì¡°íšŒ (DB + í•˜ë“œì½”ë”©)
    const supplementExams = await SupplementExam.find({ isActive: true }).lean();

    // í•˜ë“œì½”ë”©ëœ ì‹œí—˜ì§€ë„ í¬í•¨
    const HARDCODED_SUPPLEMENT_EXAMS = [
      { examId: 'supplement_classic_poem', areaKey: 'litClassicPoem', targetMockRound: 1 },
      { examId: 'supplement_writing', areaKey: 'speechWrite', targetMockRound: 1 },
      { examId: 'supplement_writing_subscription', areaKey: 'speechWrite', targetMockRound: 2 },
      { examId: 'supplement_grammar_classic', areaKey: 'grammarClassic', targetMockRound: 1 },
      { examId: 'supplement_grammar_classic_case', areaKey: 'grammarClassic', targetMockRound: 2 },
      { examId: 'supplement_modern_novel', areaKey: 'litModernNovel', targetMockRound: 1 },
      { examId: 'supplement_speech', areaKey: 'speechTalk', targetMockRound: 1 },
      { examId: 'supplement_speech_food', areaKey: 'speechTalk', targetMockRound: 2 },
      { examId: 'supplement_classic_prose', areaKey: 'litClassicProse', targetMockRound: 1 },
      { examId: 'supplement_classic_prose_nakseong', areaKey: 'litClassicProse', targetMockRound: 2 },
      { examId: 'supplement_speech_integrated', areaKey: 'speechIntegrated', targetMockRound: 1 },
      { examId: 'supplement_speech_integrated_job', areaKey: 'speechIntegrated', targetMockRound: 2 },
      { examId: 'supplement_speech_integrated_aijudge', areaKey: 'speechIntegrated', targetMockRound: 3 },
      { examId: 'supplement_modern_poem', areaKey: 'litModernPoem', targetMockRound: 1 },
      { examId: 'supplement_literature_poem_sea', areaKey: 'litModernPoem', targetMockRound: 2 },
      { examId: 'supplement_literature_novel_rondo', areaKey: 'litModernNovel', targetMockRound: 2 },
      { examId: 'supplement_literature_novel_mother', areaKey: 'litModernNovel', targetMockRound: 3 },
      { examId: 'supplement_grammar_modern', areaKey: 'grammarModern', targetMockRound: 1 },
      { examId: 'supplement_grammar_modern_semantic', areaKey: 'grammarModern', targetMockRound: 2 },
      { examId: 'supplement_reading_science', areaKey: 'readingScience', targetMockRound: 1 },
      { examId: 'supplement_reading_science_tech', areaKey: 'readingScience', targetMockRound: 2 },
      { examId: 'supplement_reading_law', areaKey: 'readingLaw', targetMockRound: 1 },
      { examId: 'supplement_reading_law_property', areaKey: 'readingLaw', targetMockRound: 2 },
      { examId: 'supplement_reading_humanities', areaKey: 'readingHumanities', targetMockRound: 1 },
      { examId: 'supplement_reading_humanities_art', areaKey: 'readingHumanities', targetMockRound: 2 },
      { examId: 'supplement_speech_tea', areaKey: 'speechTalk', targetMockRound: 3 },
      { examId: 'supplement_writing_donation', areaKey: 'speechWrite', targetMockRound: 3 },
      { examId: 'supplement_literature_classic_hwangun', areaKey: 'litClassicProse', targetMockRound: 3 },
      { examId: 'supplement_literature_poem_flower', areaKey: 'litModernPoem', targetMockRound: 3 },
      { examId: 'supplement_classic_poem_gangho', areaKey: 'litClassicPoem', targetMockRound: 3 },
      { examId: 'supplement_reading_law_tax', areaKey: 'readingLaw', targetMockRound: 3 },
      { examId: 'supplement_reading_humanities_mimesis', areaKey: 'readingHumanities', targetMockRound: 3 },
      { examId: 'supplement_reading_science_solar', areaKey: 'readingScience', targetMockRound: 3 },
      { examId: 'supplement_grammar_word_sound', areaKey: 'grammarModern', targetMockRound: 3 },
      { examId: 'supplement_grammar_medieval_honorific', areaKey: 'grammarClassic', targetMockRound: 3 }
    ];

    // ê° ì‘ì‹œ íšŒì°¨ë³„ë¡œ í•´ë‹¹ íšŒì°¨ ë³´ì™„í•™ìŠµ ë§¤í•‘ (íšŒì°¨ë³„ë¡œ ë³„ë„ ê³¼ì œ ìƒì„±)
    // targetRoundê°€ ìˆìœ¼ë©´ í•´ë‹¹ íšŒì°¨ë§Œ, ì—†ìœ¼ë©´ ëª¨ë“  ì™„ë£Œ íšŒì°¨ì— ëŒ€í•´ ë§¤í•‘
    const roundToAreaExamMap = {}; // { round: { areaKey: examId } }
    const roundsForMapping = targetRound !== null ? [targetRound] : [...completedRounds];

    roundsForMapping.forEach(round => {
      roundToAreaExamMap[round] = {};
    });

    [...supplementExams, ...HARDCODED_SUPPLEMENT_EXAMS].forEach(exam => {
      const round = hardcodedExamRounds.get(exam.examId) !== undefined
        ? hardcodedExamRounds.get(exam.examId)
        : exam.targetMockRound;

      // í•´ë‹¹ íšŒì°¨ì— ë§ëŠ” ê³¼ì œ ë§¤í•‘ (ë˜ëŠ” íšŒì°¨ ì§€ì • ì•ˆëœ ê³¼ì œëŠ” ëª¨ë“  íšŒì°¨ì— ë§¤í•‘)
      if (round !== null && roundsForMapping.includes(round)) {
        if (!roundToAreaExamMap[round][exam.areaKey]) {
          roundToAreaExamMap[round][exam.areaKey] = exam.examId;
        }
      } else if (round === null) {
        // íšŒì°¨ ì§€ì • ì•ˆëœ ê³¼ì œëŠ” ëª¨ë“  ì‘ì‹œ íšŒì°¨ì— ë§¤í•‘
        roundsForMapping.forEach(r => {
          if (!roundToAreaExamMap[r][exam.areaKey]) {
            roundToAreaExamMap[r][exam.areaKey] = exam.examId;
          }
        });
      }
    });

    // ê¸°ì¡´ ê³¼ì œ ì¡°íšŒ (areaKey + targetMockRound ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬)
    const existingTasks = await MockExamRecommendTask.find({
      $or: [{ userId }, { phone }]
    }).select('areaKey targetMockRound').lean();
    const existingTaskKeys = new Set(existingTasks.map(t => `${t.areaKey}_${t.targetMockRound}`));
    console.log(`[RecommendTask] ì‚¬ìš©ì ${userId} ê¸°ì¡´ ê³¼ì œ: ${existingTaskKeys.size}ê°œ`);

    // ê³¼ì œ ê°œìˆ˜ ê²°ì •: 6% ì´ìƒ ì°¨ì´ë‚˜ëŠ” ëª¨ë“  ì˜ì—­ì— ëŒ€í•´, ê° ì‘ì‹œ íšŒì°¨ë³„ë¡œ ê³¼ì œ ìƒì„±
    // ëª©í‘œ ì ìˆ˜ ëŒ€ë¹„ ë¶€ì¡±í•œ ì˜ì—­ì€ ëª¨ë‘ ë³´ì™„ ê³¼ì œë¡œ ì¶”ì²œ
    // targetRoundê°€ ì§€ì •ë˜ë©´ í•´ë‹¹ íšŒì°¨ë§Œ, ì—†ìœ¼ë©´ ëª¨ë“  ì™„ë£Œ íšŒì°¨ì— ëŒ€í•´ ìƒì„±
    const roundsToProcess = targetRound !== null ? [targetRound] : [...completedRounds];
    console.log(`[RecommendTask] ì²˜ë¦¬í•  íšŒì°¨: ${roundsToProcess.join(', ')} (targetRound: ${targetRound})`);

    let createdCount = 0;
    for (const task of taskCandidates) {
      // ì§€ì •ëœ íšŒì°¨ì— ëŒ€í•´ì„œë§Œ ê³¼ì œ ìƒì„±
      for (const round of roundsToProcess) {
        const taskKey = `${task.areaKey}_${round}`;

        // ì´ë¯¸ ê°™ì€ ì˜ì—­ + íšŒì°¨ ì¡°í•©ì˜ ê³¼ì œê°€ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
        if (existingTaskKeys.has(taskKey)) {
          console.log(`[RecommendTask] ${task.areaKey} ì˜ì—­ ${round}íšŒì°¨ ê³¼ì œ ì´ë¯¸ ì¡´ì¬ - ê±´ë„ˆë›°ê¸°`);
          continue;
        }

        // í•´ë‹¹ íšŒì°¨ì— ë§ëŠ” ë³´ì™„í•™ìŠµ ì‹œí—˜ì§€ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ìƒì„±
        const supplementExamId = roundToAreaExamMap[round]?.[task.areaKey] || null;
        if (!supplementExamId) {
          console.log(`[RecommendTask] ${task.areaKey} ì˜ì—­ ${round}íšŒì°¨ ë³´ì™„í•™ìŠµ ì—†ìŒ - ê±´ë„ˆë›°ê¸°`);
          continue;
        }

        await MockExamRecommendTask.create({
          userId,
          phone,
          ...task,
          targetMockRound: round,
          supplementExamId,
          weekNumber: currentWeek
        });
        createdCount++;
        existingTaskKeys.add(taskKey); // ìƒˆë¡œ ìƒì„±í•œ ê³¼ì œë„ ì¤‘ë³µ ì²´í¬ì— ì¶”ê°€
      }
    }

    console.log(`[RecommendTask] ì‚¬ìš©ì ${userId}ì—ê²Œ ${createdCount}ê°œ ê³¼ì œ ìƒì„± (${currentWeek}ì£¼ì°¨, ${[...completedRounds].join(',')}íšŒì°¨ìš©)`);
  } catch (err) {
    console.error(`[RecommendTask] ì‚¬ìš©ì ${userId} ê³¼ì œ ìƒì„± ì˜¤ë¥˜:`, err);
  }
}

// ëª¨ë“  ì‚¬ìš©ìì—ê²Œ AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„± (ìŠ¤ì¼€ì¤„ëŸ¬ìš©)
async function generateRecommendTasksForAllUsers() {
  try {
    console.log('ğŸ”„ AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„± ì‹œì‘...');

    // ëª¨ë“  ëª¨ì˜ê³ ì‚¬ ì‚¬ìš©ì ì¡°íšŒ
    const users = await MockExamUser.find({}).lean();
    console.log(`ğŸ“Š ì´ ${users.length}ëª…ì˜ ì‚¬ìš©ì ëŒ€ìƒ`);

    for (const user of users) {
      await generateRecommendTasksForUser(user._id.toString(), user.phone);
    }

    console.log('âœ… AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„± ì™„ë£Œ');
  } catch (err) {
    console.error('âŒ AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„± ì˜¤ë¥˜:', err);
  }
}

// ë§¤ì£¼ ì›”ìš”ì¼ 00:00 ìŠ¤ì¼€ì¤„ëŸ¬ - AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„±
cron.schedule('0 0 * * 1', () => {
  console.log('â° ë§¤ì£¼ ì›”ìš”ì¼ 00:00 - AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ê³¼ì œ ìƒì„± ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°');
  generateRecommendTasksForAllUsers();
}, {
  timezone: "Asia/Seoul"
});

console.log('âœ… AI ì¶”ì²œ ë³´ì™„ í•™ìŠµ ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡ ì™„ë£Œ (ë§¤ì£¼ ì›”ìš”ì¼ 00:00 ì‹¤í–‰)');

// í…ŒìŠ¤íŠ¸ìš© ìˆ˜ë™ íŠ¸ë¦¬ê±° ì—”ë“œí¬ì¸íŠ¸
app.post('/api/mock-exam/recommend-tasks/generate/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const user = await MockExamUser.findById(userId);
    if (!user) {
      return res.status(404).json({ ok: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // ê¸°ì¡´ ê³¼ì œëŠ” ìœ ì§€í•˜ê³  ìƒˆ íšŒì°¨ ê³¼ì œë§Œ ì¶”ê°€
    await generateRecommendTasksForUser(userId, user.phone);

    // ëª¨ë“  ê³¼ì œ ì¡°íšŒ (ì£¼ì°¨ ê´€ê³„ì—†ì´)
    const tasks = await MockExamRecommendTask.find({
      userId,
      $or: [
        { status: { $ne: 'completed' } },
        { weekNumber: getWeekNumber() }
      ]
    });
    res.json({ ok: true, message: 'ê³¼ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', tasks });
  } catch (err) {
    console.error('âŒ [/api/mock-exam/recommend-tasks/generate] ì˜¤ë¥˜:', err);
    res.status(500).json({ ok: false, message: 'ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error: err.message });
  }
});

// ===== í˜•ì„±í‰ê°€ ê´€ë¬¸ ì‹œìŠ¤í…œ API =====

// ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ìŠ¤í‚¤ë§ˆ
const gatePassSchema = new mongoose.Schema({
  grade: String,
  name: String,
  gate: Number,           // ê´€ë¬¸ ë ˆë²¨ (1, 2, 3, ...)
  passedAt: { type: Date, default: Date.now },
  units: [String]         // í•´ë‹¹ ê´€ë¬¸ì— í¬í•¨ëœ ë‹¨ì›ë“¤
});
const GatePass = mongoose.model("GatePass", gatePassSchema);

// ê´€ë¬¸ ì‹œë„ ê¸°ë¡ ìŠ¤í‚¤ë§ˆ (ìƒì„¸ ë°ì´í„°)
const gateAttemptSchema = new mongoose.Schema({
  grade: String,
  name: String,
  gate: Number,                    // ê´€ë¬¸ ë ˆë²¨
  attemptAt: { type: Date, default: Date.now },  // ì‹œë„ ì‹œê°
  passed: { type: Boolean, default: false },     // í†µê³¼ ì—¬ë¶€
  totalTime: { type: Number, default: 0 },       // ì „ì²´ í’€ì´ ì‹œê°„ (ì´ˆ)
  totalWrongClicks: { type: Number, default: 0 }, // ì „ì²´ ì˜¤ë‹µ í´ë¦­ íšŸìˆ˜
  questionDetails: [{              // ê° ë¬¸í•­ë³„ ìƒì„¸
    questionNo: Number,            // ë¬¸í•­ ë²ˆí˜¸ (1, 2, 3, ...)
    unitCode: String,              // ë‹¨ì› ì½”ë“œ
    unitTitle: String,             // ë‹¨ì› ì œëª©
    qType: String,                 // ì§€ìˆ˜ ìœ í˜• (q1: í•µì‹¬ì´í•´ë ¥, q2: êµ¬ì¡°íŒŒì•…ë ¥)
    timeSpent: Number,             // ë¨¸ë¬¸ ì‹œê°„ (ì´ˆ)
    wrongClicks: Number,           // ì˜¤ë‹µ í´ë¦­ íšŸìˆ˜
    correct: Boolean               // ì •ë‹µ ì—¬ë¶€
  }]
});
const GateAttempt = mongoose.model("GateAttempt", gateAttemptSchema);

// ê´€ë¬¸ ë¬¸ì œ ìƒì„± API
app.get("/api/gate-quiz/generate", async (req, res) => {
  try {
    const { grade, name, gate } = req.query;
    const gateLevel = parseInt(gate) || 1;

    console.log(`[gate-quiz/generate] grade=${grade}, name=${name}, gate=${gateLevel}`);

    if (!grade || !name) {
      return res.json({ ok: false, message: "í•™ìƒ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // 1) í•´ë‹¹ í•™ìƒì˜ ì™„ë£Œëœ ë‹¨ì› ì¡°íšŒ (ì™„ë£Œ ì‹œê°„ìˆœ ì •ë ¬, ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­)
    let completedLogs = await LearningLog.find({
      grade,
      name,
      completed: true,
      deleted: { $ne: true }
    }).select('unit timestamp').sort({ timestamp: 1 }).lean();

    // í´ë°±: grade|nameìœ¼ë¡œ ëª» ì°¾ìœ¼ë©´ nameìœ¼ë¡œë§Œ ê²€ìƒ‰ (ë³µêµ¬ëœ í•™ìƒìš©)
    if (completedLogs.length === 0) {
      completedLogs = await LearningLog.find({
        name,
        completed: true,
        deleted: { $ne: true }
      }).select('unit timestamp').sort({ timestamp: 1 }).lean();
      if (completedLogs.length > 0) {
        console.log(`[gate-quiz/generate] ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­ ì‚¬ìš©: ${name}`);
      }
    }

    // ì¤‘ë³µ ì œê±° (ì²« ë²ˆì§¸ ì™„ë£Œ ê¸°ë¡ë§Œ ìœ ì§€, ì™„ë£Œ ìˆœì„œ ë³´ì¡´)
    const seen = new Set();
    const allCompletedUnits = [];
    for (const log of completedLogs) {
      if (!seen.has(log.unit)) {
        seen.add(log.unit);
        allCompletedUnits.push(log.unit);
      }
    }
    console.log(`[gate-quiz/generate] ì „ì²´ ì™„ë£Œ ë‹¨ì› (ìˆœì„œëŒ€ë¡œ): ${allCompletedUnits.length}ê°œ`);

    // 2) ì´ë¯¸ í†µê³¼í•œ ê´€ë¬¸ í™•ì¸ (ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­)
    let passedGates = await GatePass.find({ grade, name }).select('gate').lean();

    // í´ë°±: grade|nameìœ¼ë¡œ ëª» ì°¾ìœ¼ë©´ nameìœ¼ë¡œë§Œ ê²€ìƒ‰ (ë³µêµ¬ëœ í•™ìƒìš©)
    if (passedGates.length === 0) {
      passedGates = await GatePass.find({ name }).select('gate').lean();
      if (passedGates.length > 0) {
        console.log(`[gate-quiz/generate] GatePass ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­ ì‚¬ìš©: ${name}`);
      }
    }
    const passedGateNums = passedGates.map(g => g.gate);
    console.log(`[gate-quiz/generate] í†µê³¼í•œ ê´€ë¬¸: ${passedGateNums}`);

    // 3) í•´ë‹¹ ê´€ë¬¸ì— í•´ë‹¹í•˜ëŠ” ë‹¨ì› ë²”ìœ„ ê³„ì‚° (ì™„ë£Œ ìˆœì„œ ê¸°ì¤€)
    // ê´€ë¬¸ 1: 1~5ë²ˆì§¸ ì™„ë£Œ, ê´€ë¬¸ 2: 6~10ë²ˆì§¸ ì™„ë£Œ, ...
    const startIdx = (gateLevel - 1) * 5;  // ê´€ë¬¸ 1: 0, ê´€ë¬¸ 2: 5, ê´€ë¬¸ 3: 10
    const endIdx = gateLevel * 5;          // ê´€ë¬¸ 1: 5, ê´€ë¬¸ 2: 10, ê´€ë¬¸ 3: 15

    // ì™„ë£Œ ìˆœì„œëŒ€ë¡œ í•´ë‹¹ ë²”ìœ„ì˜ ë‹¨ì›ë“¤
    const gateUnits = allCompletedUnits.slice(startIdx, endIdx);
    console.log(`[gate-quiz/generate] ê´€ë¬¸ ${gateLevel} ë²”ìœ„ ë‹¨ì› (${startIdx + 1}~${endIdx}ë²ˆì§¸ ì™„ë£Œ): ${gateUnits.length}ê°œ`, gateUnits);

    if (gateUnits.length < 5) {
      return res.json({
        ok: false,
        message: `ê´€ë¬¸ ${gateLevel} ì‹œí—˜ì„ ë³´ë ¤ë©´ ${endIdx}ê°œ ë‹¨ì› ì™„ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤. (í˜„ì¬: ${allCompletedUnits.length}ê°œ)`
      });
    }

    // 4) ê° ë‹¨ì›ì—ì„œ q1 ë˜ëŠ” q2 ë¬¸ì œ ì¶”ì¶œ (ì„œë²„ì—ì„œ ì½˜í…ì¸  íŒŒì¼ ì½ê¸°)
    const quizzes = [];

    for (const unitCode of gateUnits.slice(0, 5)) {
      // unitCode ì˜ˆ: "geo_01", "bio_05", "classic_12", "fit_physics_01", "fit_bio_02", "on_physics_01", "deep_physics_01"
      // FIT ì‹œë¦¬ì¦ˆ: fit_physics_01, fit_bio_02 ë“±
      // ON ì‹œë¦¬ì¦ˆ (ë¸Œë ˆì¸ì˜¨): on_physics_01, on_bio_02 ë“±
      // DEEP ì‹œë¦¬ì¦ˆ (ë¸Œë ˆì¸ë”¥): deep_physics_01, deep_chem_01 ë“±
      const isFit = unitCode.startsWith('fit_');
      const isOn = unitCode.startsWith('on_');
      const isDeep = unitCode.startsWith('deep_');
      let subject, num;

      if (isFit) {
        // fit_physics_01 â†’ subject: physics, num: 01
        const fitMatch = unitCode.match(/fit_([a-z]+\d?)_(\d{1,2})/);
        if (!fitMatch) continue;
        subject = fitMatch[1];
        num = fitMatch[2].padStart(2, '0');
      } else if (isOn) {
        // on_physics_01 â†’ subject: physics, num: 01
        const onMatch = unitCode.match(/on_([a-z]+\d?)_(\d{1,2})/);
        if (!onMatch) continue;
        subject = onMatch[1];
        num = onMatch[2].padStart(2, '0');
      } else if (isDeep) {
        // deep_physics_01 â†’ subject: physics, num: 01
        const deepMatch = unitCode.match(/deep_([a-z]+\d?)_(\d{1,2})/);
        if (!deepMatch) continue;
        subject = deepMatch[1];
        num = deepMatch[2].padStart(2, '0');
      } else {
        // geo_01, bio_05 â†’ subject: geo, num: 01
        const match = unitCode.match(/([a-z]+\d?)_(\d{1,2})/);
        if (!match) continue;
        subject = match[1];
        num = match[2].padStart(2, '0');
      }

      // ê³¼ëª©ì— ë”°ë¥¸ í´ë” ê²½ë¡œ ê²°ì •
      let folder = 'social';
      if (['bio', 'physics', 'chem', 'earth'].includes(subject)) folder = 'science';
      else if (['modern', 'classic'].includes(subject)) folder = 'korlit';
      else if (['world1', 'world2'].includes(subject)) folder = 'worldlit';
      else if (['people1', 'people2'].includes(subject)) folder = 'person';

      // FIT ì‹œë¦¬ì¦ˆëŠ” fit_xxx_content.js, ON ì‹œë¦¬ì¦ˆëŠ” on_xxx_content.js, DEEP ì‹œë¦¬ì¦ˆëŠ” deep_xxx_content.js íŒŒì¼ ì‚¬ìš©
      let contentFileName;
      if (isFit) {
        contentFileName = `fit_${subject}_content.js`;
      } else if (isOn) {
        contentFileName = `on_${subject}_content.js`;
      } else if (isDeep) {
        contentFileName = `deep_${subject}_content.js`;
      } else {
        contentFileName = `${subject}_content.js`;
      }
      const contentPath = path.join(__dirname, 'public', 'BRAINUP', folder, contentFileName);

      try {
        if (fs.existsSync(contentPath)) {
          const content = fs.readFileSync(contentPath, 'utf8');

          // í•´ë‹¹ ë‹¨ì›ì˜ quiz ê°ì²´ ì°¾ê¸°
          // FIT ì‹œë¦¬ì¦ˆëŠ” fit_physics_01 í˜•ì‹, ON ì‹œë¦¬ì¦ˆëŠ” on_physics_01, DEEP ì‹œë¦¬ì¦ˆëŠ” deep_physics_01, ì¼ë°˜ ì‹œë¦¬ì¦ˆëŠ” physics_01 í˜•ì‹
          let unitKey;
          if (isFit) {
            unitKey = `fit_${subject}_${num}`;
          } else if (isOn) {
            unitKey = `on_${subject}_${num}`;
          } else if (isDeep) {
            unitKey = `deep_${subject}_${num}`;
          } else {
            unitKey = `${subject}_${num}`;
          }
          const labelNoMatch = content.match(new RegExp(`labelNo:\\s*["']${num}["']`));

          if (labelNoMatch) {
            // í•´ë‹¹ ë‹¨ì› ë¸”ë¡ì—ì„œ quiz ì¶”ì¶œ
            const unitIndex = content.indexOf(labelNoMatch[0]);
            const nextUnitMatch = content.slice(unitIndex + 100).match(/labelNo:\s*["']\d{2}["']/);
            const endIndex = nextUnitMatch ? unitIndex + 100 + content.slice(unitIndex + 100).indexOf(nextUnitMatch[0]) : content.length;
            const unitBlock = content.slice(unitIndex, endIndex);

            // title ì¶”ì¶œ
            const titleMatch = unitBlock.match(/title:\s*["'](.+?)["']/);
            const unitTitle = titleMatch ? titleMatch[1] : `${subject} ${num}`;

            // answerKeyì—ì„œ ì •ë‹µ ì°¾ê¸° (q1: '1' ë˜ëŠ” q1: 1 í˜•íƒœ)
            const answerKeyMatch = unitBlock.match(/answerKey:\s*\{([^}]+)\}/);
            let q1Answer = 1;
            let q2Answer = 1;
            if (answerKeyMatch) {
              const answerKeyBlock = answerKeyMatch[1];
              const q1AnsMatch = answerKeyBlock.match(/q1:\s*['"]?(\d)['"]?/);
              const q2AnsMatch = answerKeyBlock.match(/q2:\s*['"]?(\d)['"]?/);
              if (q1AnsMatch) q1Answer = parseInt(q1AnsMatch[1]);
              if (q2AnsMatch) q2Answer = parseInt(q2AnsMatch[1]);
            }

            // passage ì¶”ì¶œ (ë³¸ë¬¸ 4ë¬¸ë‹¨ - ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ ì²˜ë¦¬)
            const passageMatch = unitBlock.match(/passage:\s*\[([\s\S]*?)\],?\s*\n\s*vocab:/);
            let passages = [];
            if (passageMatch) {
              // ê° ë¬¸ë‹¨ ì¶”ì¶œ - ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ(\')ë¥¼ í¬í•¨í•œ íŒ¨í„´ ì‚¬ìš©
              const passageRaw = passageMatch[1];
              // '...' íŒ¨í„´ì—ì„œ ë‚´ë¶€ì˜ \' ë¥¼ í—ˆìš© (ì—­ìŠ¬ë˜ì‹œ+ë”°ì˜´í‘œëŠ” ì¢…ë£Œë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ)
              passages = passageRaw.match(/'((?:\\'|[^'])+)'/g)?.map(s => {
                // ì–‘ìª½ ë”°ì˜´í‘œ ì œê±° í›„ ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œë¥¼ ì¼ë°˜ ë”°ì˜´í‘œë¡œ ë³€í™˜
                return s.slice(1, -1).replace(/\\'/g, "'");
              }) || [];
            }

            // q1_textì™€ q1_opts ì¶”ì¶œ (ì‹¤ì œ ì½˜í…ì¸  êµ¬ì¡°)
            // ì‘ì€ë”°ì˜´í‘œë¡œ ì‹œì‘í•˜ë©´ ì‘ì€ë”°ì˜´í‘œë¡œë§Œ ì¢…ë£Œ (ë‚´ë¶€ ìŒë”°ì˜´í‘œ í—ˆìš©)
            const q1TextMatch = unitBlock.match(/q1_text:\s*'((?:\\'|[^'])+?)'/) ||
                                unitBlock.match(/q1_text:\s*"((?:\\"|[^"])+?)"/);
            const q1OptsMatch = unitBlock.match(/q1_opts:\s*\[([\s\S]*?)\]/);

            if (q1TextMatch && q1OptsMatch) {
              // ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì ì œê±° (\' â†’ ', \" â†’ ")
              const q1Question = q1TextMatch[1].replace(/\\'/g, "'").replace(/\\"/g, '"');

              // ì˜µì…˜ íŒŒì‹± - â‘  â‘¡ â‘¢ â‘£ ì œê±°, ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì ì²˜ë¦¬
              const optionsRaw = q1OptsMatch[1];
              let options = optionsRaw.match(/['"]((\\['"]|[^'"])+?)['"]/g)?.map(s => {
                let opt = s.slice(1, -1).replace(/\\'/g, "'").replace(/\\"/g, '"').trim();
                // â‘  â‘¡ â‘¢ â‘£ ì œê±°
                opt = opt.replace(/^[â‘ â‘¡â‘¢â‘£]\s*/, '');
                return opt;
              }) || [];

              if (options.length === 4) {
                quizzes.push({
                  unit: unitKey,
                  unitCode: unitCode,
                  unitTitle: unitTitle,
                  passage: passages,
                  question: q1Question,
                  options: options,
                  correct: q1Answer,
                  qType: 'q1'  // ì§€ìˆ˜ ìœ í˜•: í•µì‹¬ì´í•´ë ¥
                });
                console.log(`[gate-quiz] ${unitKey} q1 ì¶”ì¶œ ì„±ê³µ (passage: ${passages.length}ë¬¸ë‹¨)`);
              }
            }

            // q2ë„ ì¶”ì¶œ (5ë‹¨ì› Ã— 2ë¬¸ì œ = 10ë¬¸ì œ)
            const q2TextMatch = unitBlock.match(/q2_text:\s*'((?:\\'|[^'])+?)'/) ||
                                unitBlock.match(/q2_text:\s*"((?:\\"|[^"])+?)"/);
            const q2OptsMatch = unitBlock.match(/q2_opts:\s*\[([\s\S]*?)\]/);

            if (q2TextMatch && q2OptsMatch) {
              // ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì ì œê±°
              const q2Question = q2TextMatch[1].replace(/\\'/g, "'").replace(/\\"/g, '"');
              const optionsRaw = q2OptsMatch[1];
              let options = optionsRaw.match(/['"]((\\['"]|[^'"])+?)['"]/g)?.map(s => {
                let opt = s.slice(1, -1).replace(/\\'/g, "'").replace(/\\"/g, '"').trim();
                opt = opt.replace(/^[â‘ â‘¡â‘¢â‘£]\s*/, '');
                return opt;
              }) || [];

              if (options.length === 4) {
                quizzes.push({
                  unit: unitKey,
                  unitCode: unitCode,
                  unitTitle: unitTitle,
                  passage: passages,
                  question: q2Question,
                  options: options,
                  correct: q2Answer,
                  qType: 'q2'  // ì§€ìˆ˜ ìœ í˜•: êµ¬ì¡°íŒŒì•…ë ¥
                });
                console.log(`[gate-quiz] ${unitKey} q2 ì¶”ì¶œ ì„±ê³µ (passage: ${passages.length}ë¬¸ë‹¨)`);
              }
            }
          }
        }
      } catch (err) {
        console.error(`[gate-quiz] ${unitCode} ë¬¸ì œ ì¶”ì¶œ ì‹¤íŒ¨:`, err.message);
      }
    }

    console.log(`[gate-quiz/generate] ìƒì„±ëœ ë¬¸ì œ: ${quizzes.length}ê°œ`);

    if (quizzes.length < 10) {
      return res.json({
        ok: false,
        message: `ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒì„±: ${quizzes.length}/10)`
      });
    }

    res.json({
      ok: true,
      gate: gateLevel,
      quizzes: quizzes.slice(0, 10),
      units: gateUnits.slice(0, 5)
    });

  } catch (err) {
    console.error("[gate-quiz/generate] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ê´€ë¬¸ í†µê³¼ ì €ì¥ API
app.post("/api/gate-quiz/pass", async (req, res) => {
  try {
    const { grade, name, gate, units } = req.body;

    console.log(`[gate-quiz/pass] grade=${grade}, name=${name}, gate=${gate}`);

    if (!grade || !name || !gate) {
      return res.json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." });
    }

    // ì´ë¯¸ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸
    const existing = await GatePass.findOne({ grade, name, gate });
    if (existing) {
      return res.json({ ok: true, message: "ì´ë¯¸ í†µê³¼í•œ ê´€ë¬¸ì…ë‹ˆë‹¤." });
    }

    // ìƒˆ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ì €ì¥
    const gatePass = new GatePass({
      grade,
      name,
      gate,
      units: units || []
    });
    await gatePass.save();

    // ğŸ‹ ê´€ë¬¸ í†µê³¼ ì‹œ ê³ ë˜ ë°°ì§€ 20ê°œ ì§€ê¸‰
    let badgesAwarded = 0;
    try {
      const badgeResult = await UserProgress.findOneAndUpdate(
        { grade, name },
        {
          $inc: { 'vocabularyQuiz.totalCoins': 20 },
          $set: { 'vocabularyQuiz.lastRankUpdate': new Date() }
        },
        { upsert: true, new: true }
      );
      badgesAwarded = 20;
      console.log(`ğŸ‹ [gate-quiz/pass] ê´€ë¬¸ ${gate} í†µê³¼! ê³ ë˜ ë°°ì§€ 20ê°œ ì§€ê¸‰: ${grade} ${name}`);
      console.log(`ğŸ‹ [gate-quiz/pass] í˜„ì¬ ì´ ë°°ì§€: ${badgeResult.vocabularyQuiz?.totalCoins || 20}ê°œ`);
    } catch (badgeErr) {
      console.error("âš ï¸ [gate-quiz/pass] ê³ ë˜ ë°°ì§€ ì§€ê¸‰ ì‹¤íŒ¨:", badgeErr.message);
    }

    console.log(`[gate-quiz/pass] ê´€ë¬¸ ${gate} í†µê³¼ ì €ì¥ ì™„ë£Œ`);
    res.json({ ok: true, message: "ê´€ë¬¸ í†µê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", badgesAwarded });

  } catch (err) {
    console.error("[gate-quiz/pass] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ê´€ë¬¸ ì‹œë„ ê¸°ë¡ ì €ì¥ API
app.post("/api/gate-quiz/attempt", async (req, res) => {
  try {
    const { grade, name, gate, passed, totalTime, totalWrongClicks, questionDetails } = req.body;

    console.log(`[gate-quiz/attempt] grade=${grade}, name=${name}, gate=${gate}, passed=${passed}`);

    if (!grade || !name || !gate) {
      return res.json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." });
    }

    // ìƒˆ ì‹œë„ ê¸°ë¡ ì €ì¥
    const attempt = new GateAttempt({
      grade,
      name,
      gate,
      passed: passed || false,
      totalTime: totalTime || 0,
      totalWrongClicks: totalWrongClicks || 0,
      questionDetails: questionDetails || []
    });
    await attempt.save();

    console.log(`[gate-quiz/attempt] ê´€ë¬¸ ${gate} ì‹œë„ ê¸°ë¡ ì €ì¥ ì™„ë£Œ`);
    res.json({ ok: true, message: "ì‹œë„ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", attemptId: attempt._id });

  } catch (err) {
    console.error("[gate-quiz/attempt] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ê´€ë¬¸ ìƒì„¸ ì •ë³´ ì¡°íšŒ API (ìŠˆí¼ê´€ë¦¬ììš©)
app.get("/api/super/gate-pass-details", requireSuperAdmin, async (req, res) => {
  try {
    const { grade, name, gate } = req.query;

    if (!grade || !name || !gate) {
      return res.json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." });
    }

    // í•´ë‹¹ ê´€ë¬¸ì˜ ëª¨ë“  ì‹œë„ ê¸°ë¡ ì¡°íšŒ
    const attempts = await GateAttempt.find({
      grade,
      name,
      gate: parseInt(gate)
    }).sort({ attemptAt: 1 }).lean();

    // í†µê³¼ ê¸°ë¡ ì¡°íšŒ
    const passRecord = await GatePass.findOne({
      grade,
      name,
      gate: parseInt(gate)
    }).lean();

    // ì¬ë„ì „ íšŸìˆ˜ ê³„ì‚° (í†µê³¼ ì „ ì‹œë„ íšŸìˆ˜)
    const retryCount = attempts.filter(a => !a.passed).length;

    // ëˆ„ì  ë°ì´í„° ê³„ì‚°
    let totalTimeAll = 0;
    let totalWrongClicksAll = 0;
    const questionTimeMap = {};  // ë¬¸í•­ë³„ ëˆ„ì  ì‹œê°„
    const questionWrongMap = {}; // ë¬¸í•­ë³„ ëˆ„ì  ì˜¤ë‹µ

    attempts.forEach(attempt => {
      totalTimeAll += attempt.totalTime || 0;
      totalWrongClicksAll += attempt.totalWrongClicks || 0;

      if (attempt.questionDetails) {
        attempt.questionDetails.forEach(q => {
          // questionNoê°€ ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
          if (q.questionNo == null || isNaN(q.questionNo)) return;

          const key = q.questionNo;
          if (!questionTimeMap[key]) {
            questionTimeMap[key] = {
              time: 0,
              wrongs: 0,
              unitCode: q.unitCode,
              unitTitle: q.unitTitle || '',
              qType: q.qType || 'q1'
            };
          }
          // ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ (unitTitle, qTypeì€ ë§ˆì§€ë§‰ ì‹œë„ ê¸°ì¤€)
          if (q.unitTitle) questionTimeMap[key].unitTitle = q.unitTitle;
          if (q.qType) questionTimeMap[key].qType = q.qType;
          questionTimeMap[key].time += q.timeSpent || 0;
          questionTimeMap[key].wrongs += q.wrongClicks || 0;
        });
      }
    });

    // ìµœì¢… í†µê³¼ ì‹œë„ ë°ì´í„°
    const finalAttempt = attempts.find(a => a.passed) || attempts[attempts.length - 1];

    res.json({
      ok: true,
      data: {
        grade,
        name,
        gate: parseInt(gate),
        passedAt: passRecord?.passedAt,
        retryCount,                          // ì¬ë„ì „ íšŸìˆ˜
        totalAttempts: attempts.length,      // ì´ ì‹œë„ íšŸìˆ˜
        cumulativeTime: totalTimeAll,        // ëˆ„ì  ì „ì²´ ì‹œê°„
        cumulativeWrongClicks: totalWrongClicksAll, // ëˆ„ì  ì˜¤ë‹µ í´ë¦­
        questionDetails: Object.entries(questionTimeMap).map(([no, data]) => ({
          questionNo: parseInt(no),
          unitCode: data.unitCode,
          unitTitle: data.unitTitle || UNIT_TITLES[data.unitCode] || '',
          qType: data.qType || 'q1',
          cumulativeTime: data.time,         // ë¬¸í•­ë³„ ëˆ„ì  ì‹œê°„
          cumulativeWrongClicks: data.wrongs // ë¬¸í•­ë³„ ëˆ„ì  ì˜¤ë‹µ
        })),
        finalAttempt: finalAttempt ? {
          totalTime: finalAttempt.totalTime,
          totalWrongClicks: finalAttempt.totalWrongClicks,
          passed: finalAttempt.passed,
          attemptAt: finalAttempt.attemptAt
        } : null,
        attempts: attempts.map(a => ({
          attemptAt: a.attemptAt,
          passed: a.passed,
          totalTime: a.totalTime,
          totalWrongClicks: a.totalWrongClicks
        }))
      }
    });

  } catch (err) {
    console.error("[gate-pass-details] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íŠ¹ì • ë‚ ì§œì— í†µê³¼í•œ ê´€ë¬¸ ì¡°íšŒ API
app.get("/api/gate-quiz/passed-by-date", async (req, res) => {
  try {
    const { grade, name, date } = req.query;

    if (!grade || !name) {
      return res.json({ ok: false, message: "í•™ìƒ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // dateê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ, ì—†ìœ¼ë©´ ì˜¤ëŠ˜
    let targetDate = date ? new Date(date) : new Date();

    // KST ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ë‚ ì§œì˜ ì‹œì‘ê³¼ ë
    const kstOffset = 9 * 60 * 60 * 1000;
    const kstTargetDate = new Date(targetDate.getTime() + kstOffset);
    const startOfDay = new Date(Date.UTC(kstTargetDate.getUTCFullYear(), kstTargetDate.getUTCMonth(), kstTargetDate.getUTCDate(), 0, 0, 0) - kstOffset);
    const endOfDay = new Date(Date.UTC(kstTargetDate.getUTCFullYear(), kstTargetDate.getUTCMonth(), kstTargetDate.getUTCDate(), 23, 59, 59, 999) - kstOffset);

    const passedGates = await GatePass.find({
      grade,
      name,
      passedAt: { $gte: startOfDay, $lte: endOfDay }
    }).sort({ gate: 1 }).lean();

    res.json({
      ok: true,
      data: passedGates.map(g => ({
        gate: g.gate,
        passedAt: g.passedAt,
        units: g.units || []
      }))
    });

  } catch (err) {
    console.error("[gate-quiz/passed-by-date] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// í•™ìƒìš© ê´€ë¬¸ ìƒì„¸ ì •ë³´ ì¡°íšŒ API
app.get("/api/gate-quiz/details", async (req, res) => {
  try {
    const { grade, name, gate } = req.query;

    if (!grade || !name || !gate) {
      return res.json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." });
    }

    // í•´ë‹¹ ê´€ë¬¸ì˜ ëª¨ë“  ì‹œë„ ê¸°ë¡ ì¡°íšŒ
    const attempts = await GateAttempt.find({
      grade,
      name,
      gate: parseInt(gate)
    }).sort({ createdAt: 1 }).lean();

    // í†µê³¼ ê¸°ë¡ ì¡°íšŒ
    const passRecord = await GatePass.findOne({
      grade,
      name,
      gate: parseInt(gate)
    }).lean();

    if (attempts.length === 0) {
      return res.json({
        ok: true,
        data: {
          totalAttempts: 0,
          retryCount: 0,
          cumulativeTime: 0,
          cumulativeWrongClicks: 0,
          finalAttempt: null,
          questionDetails: [],
          passedAt: passRecord?.passedAt || null
        }
      });
    }

    // ì¬ë„ì „ íšŸìˆ˜ (ì‹¤íŒ¨í•œ ì‹œë„ ìˆ˜)
    const retryCount = attempts.filter(a => !a.passed).length;

    // ëˆ„ì  í’€ì´ ì‹œê°„ ê³„ì‚°
    const cumulativeTime = attempts.reduce((sum, a) => sum + (a.totalTime || 0), 0);

    // ëˆ„ì  ì˜¤ë‹µ í´ë¦­ ê³„ì‚°
    const cumulativeWrongClicks = attempts.reduce((sum, a) => sum + (a.totalWrongClicks || 0), 0);

    // ìµœì¢… ì‹œë„ ì •ë³´
    const finalAttempt = attempts[attempts.length - 1];

    // ë¬¸í•­ë³„ ìƒì„¸ ì •ë³´ ì§‘ê³„
    const questionMap = new Map();
    attempts.forEach(attempt => {
      if (attempt.questionDetails && Array.isArray(attempt.questionDetails)) {
        attempt.questionDetails.forEach(q => {
          const key = q.questionNo;
          if (!questionMap.has(key)) {
            questionMap.set(key, {
              questionNo: q.questionNo,
              unitCode: q.unitCode,
              unitTitle: q.unitTitle,
              qType: q.qType,
              cumulativeTime: 0,
              cumulativeWrongClicks: 0
            });
          }
          const existing = questionMap.get(key);
          existing.cumulativeTime += (q.timeSpent || 0);
          existing.cumulativeWrongClicks += (q.wrongClicks || 0);
        });
      }
    });

    const questionDetails = Array.from(questionMap.values());

    res.json({
      ok: true,
      data: {
        totalAttempts: attempts.length,
        retryCount,
        cumulativeTime,
        cumulativeWrongClicks,
        finalAttempt: {
          totalTime: finalAttempt.totalTime,
          totalWrongClicks: finalAttempt.totalWrongClicks,
          passed: finalAttempt.passed
        },
        questionDetails,
        passedAt: passRecord?.passedAt || null
      }
    });

  } catch (err) {
    console.error("[gate-quiz/details] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íŠ¹ì • ë‹¨ì›ì˜ ë¬¸ì œ/ì„ ì§€ ì¡°íšŒ API (ê´€ë¬¸ ìƒì„¸ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
app.get("/api/gate-quiz/question", async (req, res) => {
  try {
    const { unitCode, qType } = req.query;

    if (!unitCode || !qType) {
      return res.json({ ok: false, message: "unitCodeì™€ qTypeì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // unitCode íŒŒì‹± (ì˜ˆ: "geo_01", "fit_physics_01", "on_bio_02")
    const isFit = unitCode.startsWith('fit_');
    const isOn = unitCode.startsWith('on_');
    let subject, num;

    if (isFit) {
      const fitMatch = unitCode.match(/fit_([a-z]+\d?)_(\d{1,2})/);
      if (!fitMatch) return res.json({ ok: false, message: "ì˜ëª»ëœ unitCode í˜•ì‹ì…ë‹ˆë‹¤." });
      subject = fitMatch[1];
      num = fitMatch[2].padStart(2, '0');
    } else if (isOn) {
      const onMatch = unitCode.match(/on_([a-z]+\d?)_(\d{1,2})/);
      if (!onMatch) return res.json({ ok: false, message: "ì˜ëª»ëœ unitCode í˜•ì‹ì…ë‹ˆë‹¤." });
      subject = onMatch[1];
      num = onMatch[2].padStart(2, '0');
    } else {
      const match = unitCode.match(/([a-z]+\d?)_(\d{1,2})/);
      if (!match) return res.json({ ok: false, message: "ì˜ëª»ëœ unitCode í˜•ì‹ì…ë‹ˆë‹¤." });
      subject = match[1];
      num = match[2].padStart(2, '0');
    }

    // í´ë” ê²½ë¡œ ê²°ì •
    let folder = 'social';
    if (['bio', 'physics', 'chem', 'earth'].includes(subject)) folder = 'science';
    else if (['modern', 'classic'].includes(subject)) folder = 'korlit';
    else if (['world1', 'world2'].includes(subject)) folder = 'worldlit';
    else if (['people1', 'people2'].includes(subject)) folder = 'person';

    // ì½˜í…ì¸  íŒŒì¼ ê²½ë¡œ
    let contentFileName;
    if (isFit) {
      contentFileName = `fit_${subject}_content.js`;
    } else if (isOn) {
      contentFileName = `on_${subject}_content.js`;
    } else {
      contentFileName = `${subject}_content.js`;
    }
    const contentPath = path.join(__dirname, 'public', 'BRAINUP', folder, contentFileName);

    if (!fs.existsSync(contentPath)) {
      return res.json({ ok: false, message: "ì½˜í…ì¸  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    const content = fs.readFileSync(contentPath, 'utf8');

    // í•´ë‹¹ ë‹¨ì› ë¸”ë¡ ì°¾ê¸°
    const labelNoMatch = content.match(new RegExp(`labelNo:\\s*["']${num}["']`));
    if (!labelNoMatch) {
      return res.json({ ok: false, message: "í•´ë‹¹ ë‹¨ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    const unitIndex = content.indexOf(labelNoMatch[0]);
    const nextUnitMatch = content.slice(unitIndex + 100).match(/labelNo:\s*["']\d{2}["']/);
    const endIndex = nextUnitMatch ? unitIndex + 100 + content.slice(unitIndex + 100).indexOf(nextUnitMatch[0]) : content.length;
    const unitBlock = content.slice(unitIndex, endIndex);

    // title ì¶”ì¶œ
    const titleMatch = unitBlock.match(/title:\s*["'](.+?)["']/);
    const unitTitle = titleMatch ? titleMatch[1] : `${subject} ${num}`;

    // passage ì¶”ì¶œ
    const passageMatch = unitBlock.match(/passage:\s*\[([\s\S]*?)\],?\s*\n\s*vocab:/);
    let passages = [];
    if (passageMatch) {
      const passageRaw = passageMatch[1];
      passages = passageRaw.match(/'((?:\\'|[^'])+)'/g)?.map(s => {
        return s.slice(1, -1).replace(/\\'/g, "'");
      }) || [];
    }

    // ìš”ì²­ëœ ë¬¸ì œ íƒ€ì…ì— ë”°ë¼ ë¬¸ì œ/ì„ ì§€ ì¶”ì¶œ
    const qKey = qType === 'q2' ? 'q2' : 'q1';
    const textMatch = unitBlock.match(new RegExp(`${qKey}_text:\\s*'((?:\\\\'|[^'])+?)'`)) ||
                      unitBlock.match(new RegExp(`${qKey}_text:\\s*"((?:\\\\"|[^"])+?)"`));
    const optsMatch = unitBlock.match(new RegExp(`${qKey}_opts:\\s*\\[([\\s\\S]*?)\\]`));

    if (!textMatch || !optsMatch) {
      return res.json({ ok: false, message: "ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    const question = textMatch[1].replace(/\\'/g, "'").replace(/\\"/g, '"');
    const optionsRaw = optsMatch[1];
    let options = optionsRaw.match(/['"]((\\['"]|[^'"])+?)['"]/g)?.map(s => {
      let opt = s.slice(1, -1).replace(/\\'/g, "'").replace(/\\"/g, '"').trim();
      opt = opt.replace(/^[â‘ â‘¡â‘¢â‘£]\s*/, '');
      return opt;
    }) || [];

    // ì •ë‹µ ì¶”ì¶œ
    const answerKeyMatch = unitBlock.match(/answerKey:\s*\{([^}]+)\}/);
    let correctAnswer = 1;
    if (answerKeyMatch) {
      const answerKeyBlock = answerKeyMatch[1];
      const ansMatch = answerKeyBlock.match(new RegExp(`${qKey}:\\s*['"]?(\\d)['"]?`));
      if (ansMatch) correctAnswer = parseInt(ansMatch[1]);
    }

    res.json({
      ok: true,
      data: {
        unitCode,
        unitTitle,
        qType,
        question,
        options,
        correct: correctAnswer,
        passage: passages  // ì „ì²´ ë³¸ë¬¸ ì œê³µ
      }
    });

  } catch (err) {
    console.error("[gate-quiz/question] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ê´€ë¬¸ ìƒíƒœ í™•ì¸ API
app.get("/api/gate-quiz/status", async (req, res) => {
  try {
    const { grade, name } = req.query;

    if (!grade || !name) {
      return res.json({ ok: false, message: "í•™ìƒ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // ì™„ë£Œëœ ë‹¨ì› ëª©ë¡ (ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­)
    let completedLogs = await LearningLog.find({
      grade,
      name,
      completed: true,
      deleted: { $ne: true }
    }).select('unit').lean();

    // í´ë°±: grade|nameìœ¼ë¡œ ëª» ì°¾ìœ¼ë©´ nameìœ¼ë¡œë§Œ ê²€ìƒ‰ (ë³µêµ¬ëœ í•™ìƒìš©)
    if (completedLogs.length === 0) {
      completedLogs = await LearningLog.find({
        name,
        completed: true,
        deleted: { $ne: true }
      }).select('unit').lean();
      if (completedLogs.length > 0) {
        console.log(`[gate-quiz/status] ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­ ì‚¬ìš©: ${name}`);
      }
    }
    const completedUnitIds = [...new Set(completedLogs.map(log => log.unit))];
    const completedCount = completedUnitIds.length;

    // í†µê³¼í•œ ê´€ë¬¸ë“¤ (ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­)
    let passedGates = await GatePass.find({ grade, name }).select('gate passedAt').lean();

    // í´ë°±: grade|nameìœ¼ë¡œ ëª» ì°¾ìœ¼ë©´ nameìœ¼ë¡œë§Œ ê²€ìƒ‰ (ë³µêµ¬ëœ í•™ìƒìš©)
    if (passedGates.length === 0) {
      passedGates = await GatePass.find({ name }).select('gate passedAt').lean();
      if (passedGates.length > 0) {
        console.log(`[gate-quiz/status] GatePass ì´ë¦„ ê¸°ë°˜ í´ë°± ë§¤ì¹­ ì‚¬ìš©: ${name}`);
      }
    }

    // ë‹¤ìŒ ê´€ë¬¸ ë ˆë²¨ ê³„ì‚°
    const highestPassedGate = passedGates.length > 0
      ? Math.max(...passedGates.map(g => g.gate))
      : 0;
    const nextGate = highestPassedGate + 1;

    // ë‹¤ìŒ ê´€ë¬¸ì„ ë³¼ ìˆ˜ ìˆëŠ”ì§€ (5ê°œ ë‹¨ì›ë§ˆë‹¤)
    const requiredUnits = nextGate * 5;
    const canTakeGate = completedCount >= requiredUnits;

    res.json({
      ok: true,
      completedUnits: completedCount,
      completedUnitIds,  // ì™„ë£Œëœ ë‹¨ì› ID ëª©ë¡ ì¶”ê°€
      passedGates: passedGates.map(g => g.gate),
      highestPassedGate,  // ê°€ì¥ ë†’ì€ í†µê³¼ ê´€ë¬¸ ì¶”ê°€
      nextGate,
      canTakeGate,
      requiredUnits
    });

  } catch (err) {
    console.error("[gate-quiz/status] error:", err);
    res.status(500).json({ ok: false, message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== ë©”ë‰´ ì´ˆê¸°í™” í†µí•© API (ì„±ëŠ¥ ìµœì í™”) =====
// ì—¬ëŸ¬ APIë¥¼ í•œ ë²ˆì— í˜¸ì¶œí•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì™•ë³µ íšŸìˆ˜ë¥¼ ì¤„ì„
app.get("/api/menu-init", async (req, res) => {
  const startTime = Date.now();

  try {
    const { grade, name, series, phone } = req.query;

    if (!grade || !name) {
      return res.status(400).json({
        ok: false,
        message: "grade, name íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤."
      });
    }

    // âœ… ìºì‹œ í‚¤ ìƒì„± ë° í™•ì¸ (30ì´ˆ ìºì‹œ)
    const cacheKey = getCacheKey('menu-init', { grade, name, series: series || '', phone: phone || '' });
    const cached = getCache(cacheKey);
    if (cached) {
      console.log("ğŸ’¾ [/api/menu-init] ìºì‹œ ì‚¬ìš©");
      return res.json(cached);
    }

    console.log("ğŸš€ [/api/menu-init] DB ì¡°íšŒ ì‹œì‘");

    // ì„¸ì…˜ ì •ë³´
    const session = req.session && req.session.user
      ? { ok: true, user: req.session.user }
      : { ok: false, user: null };

    // ë³‘ë ¬ë¡œ ëª¨ë“  ë°ì´í„° ì¡°íšŒ (âœ… ì¤‘ë³µ ì¿¼ë¦¬ ì œê±°: allLogs í•˜ë‚˜ë¡œ í†µí•©)
    const [
      userInfo,
      userProgress,
      completedLogs,
      allLogs
    ] = await Promise.all([
      // 1. user-info: ì‚¬ìš©ì ì •ë³´
      User.findOne({ grade, name, deleted: { $ne: true } }).lean(),

      // 2. UserProgress: study-room, today, last-assigned ëª¨ë‘ í¬í•¨
      UserProgress.findOne({ grade, name }).lean(),

      // 3. completion-status: ì™„ë£Œëœ ë‹¨ì› ëª©ë¡ (seriesê°€ ìˆì„ ë•Œë§Œ)
      series
        ? LearningLog.find({ grade, name, series, completed: true }).select('unit').lean()
        : Promise.resolve([]),

      // 4. learning-logs: í•™ìŠµ ê¸°ë¡ (âœ… unitGradesDataì™€ í†µí•© - deleted í•„í„° ì œê±°í•˜ì—¬ í•œ ë²ˆë§Œ ì¡°íšŒ)
      LearningLog.find(phone ? { grade, name, phone } : { grade, name })
        .sort({ timestamp: -1 })
        .lean()
    ]);

    // âœ… unitGradesDataëŠ” allLogsì—ì„œ í•„í„°ë§ (ì¤‘ë³µ ì¿¼ë¦¬ ì œê±°)
    const unitGradesData = allLogs.filter(log => log.deleted !== true);

    // user-info ê°€ê³µ
    const userInfoResult = userInfo
      ? {
          _id: userInfo._id,
          grade: userInfo.grade,
          name: userInfo.name,
          school: userInfo.school,
          assignedSeries: userInfo.assignedSeries || []
        }
      : null;

    // study-room ê°€ê³µ
    const studyRoom = {
      ok: true,
      data: userProgress
        ? {
            studyRoom: userProgress.studyRoom || { assignedTasks: [] },
            completedPages: userProgress.completedPages || [],
            grade: userProgress.grade,
            name: userProgress.name
          }
        : {
            studyRoom: { assignedTasks: [] }
          }
    };

    // today (ì–´íœ˜í€´ì¦ˆ ì™„ë£Œ ì—¬ë¶€)
    let todayResult = { ok: true, completedToday: false };
    if (userProgress && userProgress.vocabularyQuizHistory && userProgress.vocabularyQuizHistory.length > 0) {
      const now = new Date();
      const kstOffset = 9 * 60 * 60 * 1000;
      const kstNow = new Date(now.getTime() + kstOffset);
      const kstTodayStart = new Date(Date.UTC(kstNow.getUTCFullYear(), kstNow.getUTCMonth(), kstNow.getUTCDate(), 0, 0, 0) - kstOffset);
      const kstTodayEnd = new Date(Date.UTC(kstNow.getUTCFullYear(), kstNow.getUTCMonth(), kstNow.getUTCDate(), 23, 59, 59) - kstOffset);

      const todayHistory = userProgress.vocabularyQuizHistory.find(history => {
        const historyDate = new Date(history.date);
        return historyDate >= kstTodayStart && historyDate <= kstTodayEnd;
      });

      todayResult = {
        ok: true,
        completedToday: !!todayHistory,
        latestHistory: todayHistory || null
      };
    }

    // last-assigned
    const lastAssigned = {
      ok: true,
      lastAIAssignedAt: userProgress?.studyRoom?.lastAIAssignedAt || null
    };

    // completion-status
    const completionStatus = {
      ok: true,
      completedUnits: completedLogs.map(log => log.unit)
    };

    // learning-logs ê°€ê³µ (AI ë³µìŠµ ì™„ë£Œ ì‹œê°„ ì¶”ê°€)
    const aiTaskMap = new Map();
    if (userProgress && userProgress.studyRoom && userProgress.studyRoom.assignedTasks) {
      userProgress.studyRoom.assignedTasks.forEach(task => {
        if (task.isAI && task.completedAt) {
          aiTaskMap.set(task.id, task.completedAt);
        }
      });
    }
    const learningLogs = allLogs.map(log => ({
      ...log,
      aiReviewCompletedAt: aiTaskMap.get(log.unit) || null
    }));

    // unit-grades ê°€ê³µ
    const unitGradesMap = {};
    unitGradesData.forEach(log => {
      const unitId = log.unit;
      if (!unitGradesMap[unitId] && log.radar) {
        const radarValues = Object.values(log.radar);
        const radarAvg = radarValues.reduce((sum, val) => sum + val, 0) / radarValues.length;

        let gradeLabel = 'ê²©ë ¤';
        if (radarAvg >= 9) {
          gradeLabel = 'ìš°ìˆ˜';
        } else if (radarAvg >= 8) {
          gradeLabel = 'ì–‘í˜¸';
        } else if (radarAvg >= 7) {
          gradeLabel = 'ë³´í†µ';
        }

        unitGradesMap[unitId] = {
          unit: unitId,
          grade: gradeLabel,
          radarAvg: Math.round(radarAvg * 10) / 10,
          radar: log.radar,
          timestamp: log.timestamp
        };
      }
    });

    const elapsed = Date.now() - startTime;
    console.log(`âœ… [/api/menu-init] ì™„ë£Œ (${elapsed}ms)`);

    // ëª¨ë“  ê²°ê³¼ë¥¼ í•œ ë²ˆì— ë°˜í™˜
    const result = {
      ok: true,
      session,
      userInfo: userInfoResult,
      studyRoom,
      today: todayResult,
      lastAssigned,
      completionStatus,
      learningLogs,
      unitGrades: unitGradesMap,  // /api/unit-gradesì™€ ë™ì¼í•œ í˜•ì‹ (ê°ì²´)
      _meta: {
        elapsed: elapsed,
        timestamp: new Date().toISOString()
      }
    };

    // âœ… ìºì‹œì— ì €ì¥ (30ì´ˆ)
    setCache(cacheKey, result);

    res.json(result);

  } catch (err) {
    console.error("âŒ [/api/menu-init] ì˜¤ë¥˜:", err);
    res.status(500).json({
      ok: false,
      message: "í†µí•© API ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      error: err.message
    });
  }
});

// ===== ëª¨ì˜ê³ ì‚¬ ê²°ê³¼ ì €ì¥ API =====
app.post("/api/mock-exam/submit", async (req, res) => {
  try {
    const { visitorId, studentInfo, examId, examTitle, grade, answers, score, correctCount, totalQuestions, wrongAnswers, elapsedTimeStr } = req.body;

    if (!visitorId || !answers || !studentInfo) {
      return res.status(400).json({ ok: false, message: "í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }

    const result = new MockExamResult({
      userId: visitorId,
      studentInfo: {
        schoolName: studentInfo.schoolName,
        grade: studentInfo.grade,
        studentName: studentInfo.studentName,
        phoneNumber: studentInfo.phoneNumber
      },
      examId: examId || 'korean_mock_1',
      examTitle: examTitle || 'êµ­ì–´ ëª¨ì˜ê³ ì‚¬ 1íšŒ',
      grade: grade,
      answers: new Map(Object.entries(answers)),
      score,
      correctCount,
      totalQuestions: totalQuestions || 45,
      wrongAnswers: wrongAnswers || [],
      elapsedTimeStr: elapsedTimeStr || '--:--'
    });

    await result.save();

    // ì‚¬ìš©ìì˜ examProgress ì—…ë°ì´íŠ¸ (ëŒ€ì‹œë³´ë“œ ì—°ë™ìš©)
    try {
      const user = await MockExamUser.findById(visitorId);
      if (user) {
        // examProgress ë°°ì—´ì—ì„œ í•´ë‹¹ ì‹œí—˜ ì°¾ê¸°
        const examIndex = user.examProgress.findIndex(p => p.examId === (examId || 'korean_mock_1'));

        if (examIndex >= 0) {
          // ê¸°ì¡´ ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
          user.examProgress[examIndex].status = 'completed';
          user.examProgress[examIndex].resultId = result._id;
          user.examProgress[examIndex].completedAt = new Date();
          // ì±„ì  íšŸìˆ˜ ì¦ê°€
          user.examProgress[examIndex].attemptCount = (user.examProgress[examIndex].attemptCount || 0) + 1;
        } else {
          // ìƒˆë¡œ ì¶”ê°€
          user.examProgress.push({
            examId: examId || 'korean_mock_1',
            status: 'completed',
            resultId: result._id,
            completedAt: new Date(),
            attemptCount: 1  // ì²« ì±„ì 
          });
        }

        await user.save();
        console.log(`âœ… [submit] ì‚¬ìš©ì ${visitorId}ì˜ examProgress ì—…ë°ì´íŠ¸ ì™„ë£Œ`);

        // AI ì¶”ì²œ ê³¼ì œ ìë™ ìƒì„± (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬)
        // í˜„ì¬ ì œì¶œí•œ íšŒì°¨ë§Œ ê³¼ì œ ìƒì„±í•˜ë„ë¡ íšŒì°¨ ì¶”ì¶œ
        const currentExamId = examId || 'korean_mock_1';
        const roundMatch = currentExamId.match(/korean_mock_(\d+)/);
        const currentRound = roundMatch ? parseInt(roundMatch[1]) : 1;
        console.log(`âœ… [submit] í˜„ì¬ ì œì¶œ íšŒì°¨: ${currentRound}íšŒì°¨ (examId: ${currentExamId})`);

        generateRecommendTasksForUser(visitorId, user.phone, currentRound).catch(err => {
          console.error("âŒ [submit] AI ì¶”ì²œ ê³¼ì œ ìƒì„± ì‹¤íŒ¨:", err);
        });

        // 2íšŒì°¨ ì´ìƒì¼ ë•Œ ì´ì „ íšŒì°¨ ë³´ì™„í•™ìŠµ ê¸°ë°˜ ì˜ˆì¸¡ê°’ ê³„ì‚° ë° ì €ì¥
        if (currentRound >= 2) {
          try {
            // ë³´ì™„í•™ìŠµ ë°ì´í„° ì¡°íšŒ (supplement-progress APIì™€ ë™ì¼í•œ ë¡œì§)
            const queryConditions = [{ userId: visitorId }];
            if (user.phone) queryConditions.push({ phone: user.phone });

            const supplementResults = await SupplementResult.find({
              $or: queryConditions,
              isGraded: true
            });

            // AI ì¶”ì²œ ê³¼ì œ ë°ì´í„°ë„ ì¡°íšŒ (status: 'completed' - supplement-progress APIì™€ ë™ì¼)
            const completedTasks = await MockExamRecommendTask.find({
              $or: queryConditions,
              status: 'completed'
            });

            // ë³´ì™„í•™ìŠµ ì˜ì—­ë³„ ì§‘ê³„
            const supplementProgress = {
              speech: { correct: 0, total: 0 },
              grammar: { correct: 0, total: 0 },
              reading: { correct: 0, total: 0 },
              literature: { correct: 0, total: 0 }
            };

            // SupplementResult ì§‘ê³„
            const examAreaMap = {
              'supplement_classic_poem': 'literature', 'supplement_classic_poem_geumrusa': 'literature', 'supplement_classic_poem_gangho': 'literature',
              'supplement_classic_prose': 'literature', 'supplement_classic_prose_nakseong': 'literature',
              'supplement_writing': 'speech', 'supplement_grammar_classic': 'grammar',
              'supplement_grammar_classic_case': 'grammar', 'supplement_modern_novel': 'literature',
              'supplement_speech': 'speech', 'supplement_modern_poem': 'literature',
              'supplement_grammar_modern': 'grammar', 'supplement_grammar_modern_semantic': 'grammar',
              'supplement_reading_science': 'reading', 'supplement_reading_science_tech': 'reading',
              'supplement_reading_law': 'reading', 'supplement_reading_law_property': 'reading',
              'supplement_reading_social': 'reading', 'supplement_reading_tech': 'reading',
              'supplement_reading_humanities': 'reading', 'supplement_reading_humanities_art': 'reading',
              'supplement_reading_art': 'reading', 'supplement_speech_integrated': 'speech',
              'supplement_speech_integrated_job': 'speech', 'supplement_speech_integrated_aijudge': 'speech', 'supplement_speech_food': 'speech', 'supplement_speech_tea': 'speech',
              'supplement_writing_subscription': 'speech', 'supplement_writing_donation': 'speech',
              'supplement_literature_poem_sea': 'literature', 'supplement_literature_novel_rondo': 'literature',
              'supplement_literature_novel_mother': 'literature', 'supplement_literature_classic_hwangun': 'literature',
              'supplement_literature_poem_flower': 'literature', 'supplement_reading_law_tax': 'reading',
              'supplement_reading_humanities_mimesis': 'reading',
              'supplement_reading_science_solar': 'reading',
              'supplement_grammar_word_sound': 'grammar',
              'supplement_grammar_medieval_honorific': 'grammar'
            };

            supplementResults.forEach(sr => {
              const parentArea = examAreaMap[sr.examId];
              if (parentArea && supplementProgress[parentArea]) {
                supplementProgress[parentArea].correct += sr.correctCount || 0;
                supplementProgress[parentArea].total += sr.totalQuestions || 0;
              }
            });

            // AI ì¶”ì²œ ê³¼ì œ ì§‘ê³„ (supplement-progress APIì™€ ë™ì¼ ë¡œì§)
            const alreadyCountedExamIds = new Set(supplementResults.map(r => r.examId));
            completedTasks.forEach(task => {
              // ì´ë¯¸ SupplementResultì—ì„œ ì§‘ê³„ëœ ë³´ì™„í•™ìŠµì´ë©´ ìŠ¤í‚µ (ì¤‘ë³µ ë°©ì§€)
              if (task.supplementExamId && alreadyCountedExamIds.has(task.supplementExamId)) return;
              const parentArea = task.parentArea;
              const taskTotal = task.totalCount || 5;
              const taskCorrect = task.correctCount || Math.round(taskTotal * (task.avgRate || 70) / 100);
              if (parentArea && supplementProgress[parentArea]) {
                supplementProgress[parentArea].correct += taskCorrect;
                supplementProgress[parentArea].total += taskTotal;
              }
            });

            // í˜„ì¬ íšŒì°¨ ì‹¤ì œ ì ìˆ˜ ì‚¬ìš© (ë ˆì´ë” ì°¨íŠ¸ì™€ ë™ì¼: í˜„ì¬ íšŒì°¨ + ë³´ì™„í•™ìŠµ)
            // ì‹œí—˜ë³„ ì˜ì—­ë³„ ë¬¸í•­ ë²ˆí˜¸
            const areaQuestionsByExam = {
              'korean_mock_1': {
                speech: [1, 2, 4, 5, 6, 24, 25, 26, 27, 28, 29, 30],
                grammar: [3, 7, 8, 9, 10],
                reading: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
                literature: [31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]
              },
              'korean_mock_2': {
                speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                grammar: [11, 12, 13, 14, 15],
                reading: [16, 17, 18, 19, 20, 21, 26, 27, 28, 29, 30, 31, 32, 33, 34],
                literature: [22, 23, 24, 25, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]
              },
              'korean_mock_3': {
                speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                grammar: [11, 12, 13, 14, 15],
                reading: [20, 21, 22, 23, 24, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37],
                literature: [16, 17, 18, 19, 25, 26, 27, 38, 39, 40, 41, 42, 43, 44, 45]
              },
              'korean_mock_4': {
                speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                grammar: [11, 12, 13, 14, 15],
                reading: [21, 22, 23, 24, 25, 29, 30, 31, 32, 33, 34, 38, 39, 40, 41, 42],
                literature: [16, 17, 18, 19, 20, 26, 27, 28, 34, 35, 36, 37, 43, 44, 45]
              }
            };

            const currentExamId = `korean_mock_${currentRound}`;
            const currentWrongSet = new Set(wrongAnswers.map(w => w.questionNum));

            // ëˆ„ì  ì˜ˆì¸¡ê°’ ê³„ì‚°: (ì´ì „ íšŒì°¨ë“¤ + ë³´ì™„í•™ìŠµ) - í˜„ì¬ íšŒì°¨ ì œì™¸
            // 1. ì´ì „ íšŒì°¨ë“¤ì˜ ê²°ê³¼ ì¡°íšŒ (MockExamResultìš© ì¿¼ë¦¬ ì¡°ê±´ ë³„ë„ êµ¬ì„±)
            const mockExamQueryConditions = [{ userId: visitorId }];
            if (user.phone) mockExamQueryConditions.push({ 'studentInfo.phoneNumber': user.phone });

            const previousResults = await MockExamResult.find({
              $or: mockExamQueryConditions,
              examId: { $in: Array.from({ length: currentRound - 1 }, (_, i) => `korean_mock_${i + 1}`) }
            }).sort({ examId: 1, completedAt: -1 });

            // ê° íšŒì°¨ë³„ë¡œ ìµœì‹  ê²°ê³¼ 1ê°œì”©ë§Œ ì‚¬ìš© (completedAt ê¸°ì¤€ ì •ë ¬ í›„ ì²« ë²ˆì§¸)
            const latestByExam = {};
            previousResults.forEach(r => {
              const examId = r.examId;
              if (!latestByExam[examId] || r.completedAt > latestByExam[examId].completedAt) {
                latestByExam[examId] = r;
              }
            });

            // 2. ëˆ„ì  ì˜ì—­ë³„ í•©ê³„ ê³„ì‚° (ì´ì „ íšŒì°¨ë“¤)
            const cumulativeTotals = {
              speech: { correct: 0, total: 0 },
              grammar: { correct: 0, total: 0 },
              reading: { correct: 0, total: 0 },
              literature: { correct: 0, total: 0 }
            };

            Object.values(latestByExam).forEach(prevResult => {
              const prevWrongSet = new Set((prevResult.wrongAnswers || []).map(w => w.questionNum));
              const prevAreaQuestions = areaQuestionsByExam[prevResult.examId] || areaQuestionsByExam['korean_mock_1'];

              ['speech', 'grammar', 'reading', 'literature'].forEach(area => {
                const questions = prevAreaQuestions[area];
                const wrongCount = questions.filter(q => prevWrongSet.has(q)).length;
                cumulativeTotals[area].correct += questions.length - wrongCount;
                cumulativeTotals[area].total += questions.length;
              });
            });

            // 3. ì˜ˆì¸¡ê°’ ê³„ì‚°: (ì´ì „ íšŒì°¨ë“¤ ëˆ„ì  + ë³´ì™„í•™ìŠµ) - í˜„ì¬ íšŒì°¨ëŠ” ì œì™¸!
            // ì˜ˆì¸¡ = "ì´ë²ˆ íšŒì°¨ë¥¼ í’€ê¸° ì „ ì˜ˆìƒ ì ìˆ˜"
            const predictionScores = {};
            let totalPredCorrect = 0;
            let totalPredTotal = 0;

            ['speech', 'grammar', 'reading', 'literature'].forEach(area => {
              const cumulativeCorrect = cumulativeTotals[area].correct;
              const cumulativeTotal = cumulativeTotals[area].total;

              const suppCorrect = supplementProgress[area].correct;
              const suppTotal = supplementProgress[area].total;

              const areaCorrect = cumulativeCorrect + suppCorrect;
              const areaTotal = cumulativeTotal + suppTotal;
              predictionScores[area] = areaTotal > 0 ? Math.round((areaCorrect / areaTotal) * 100) : 0;

              totalPredCorrect += areaCorrect;
              totalPredTotal += areaTotal;
            });

            // ì¢…í•© ì˜ˆì¸¡ í‰ê· 
            predictionScores.avg = totalPredTotal > 0 ? Math.round((totalPredCorrect / totalPredTotal) * 100) : 0;

            // MockExamResultì— ì˜ˆì¸¡ê°’ ì €ì¥
            result.predictionAtSubmit = predictionScores;
            await result.save();
            console.log(`âœ… [submit] ${currentRound}íšŒì°¨ ì˜ˆì¸¡ê°’ ì €ì¥:`, predictionScores);
          } catch (predErr) {
            console.error("âŒ [submit] ì˜ˆì¸¡ê°’ ê³„ì‚°/ì €ì¥ ì‹¤íŒ¨:", predErr);
          }
        }
      }
    } catch (userErr) {
      console.error("âŒ [submit] examProgress ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", userErr);
      // ê²°ê³¼ ì €ì¥ì€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì—ëŸ¬ë¥¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
    }

    res.json({
      ok: true,
      message: "ì±„ì  ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.",
      resultId: result._id
    });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/submit] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// ëª¨ì˜ê³ ì‚¬ ê²°ê³¼ ì¡°íšŒ API
app.get("/api/mock-exam/results/:visitorId", async (req, res) => {
  try {
    const { visitorId } = req.params;
    const { examId } = req.query;

    // MockExamUserì˜ _idì¸ ê²½ìš° í•´ë‹¹ ì‚¬ìš©ìì˜ phone + ì´ë¦„ìœ¼ë¡œ ê²°ê³¼ ì¡°íšŒ
    let query = {};
    if (mongoose.Types.ObjectId.isValid(visitorId)) {
      const user = await MockExamUser.findById(visitorId);
      if (user) {
        // ì „í™”ë²ˆí˜¸ì™€ ì´ë¦„ ëª¨ë‘ ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ë§Œ ì¡°íšŒ (ê°™ì€ ì „í™”ë²ˆí˜¸ ë‹¤ë¥¸ í•™ìƒ êµ¬ë¶„)
        query = {
          'studentInfo.phoneNumber': user.phone,
          'studentInfo.studentName': user.name
        };
      } else {
        query = { userId: visitorId };
      }
    } else {
      query = { userId: visitorId };
    }

    if (examId) query.examId = examId;

    const results = await MockExamResult.find(query)
      .sort({ completedAt: -1 });
      // limit ì œê±°: 12+ ìƒì„¸ ì§€í‘œì—ì„œ ëª¨ë“  íšŒì°¨ ê²°ê³¼ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•¨

    res.json({ ok: true, results });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/results] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// examIdì™€ userIdë¡œ ê²°ê³¼ ì¡°íšŒ (AI ë¶„ì„ íŒì—…ìš©) - ë” êµ¬ì²´ì ì¸ ë¼ìš°íŠ¸ë¥¼ ë¨¼ì € ë°°ì¹˜
app.get("/api/mock-exam/result/:examId/:userId", async (req, res) => {
  try {
    const { examId, userId } = req.params;

    // ë¨¼ì € MockExamUserì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì°¾ê¸°
    const user = await MockExamUser.findById(userId);

    let result;
    if (user) {
      // ì‚¬ìš©ìì˜ ì „í™”ë²ˆí˜¸ë¡œ ê²°ê³¼ ì¡°íšŒ
      result = await MockExamResult.findOne({
        examId,
        'studentInfo.phoneNumber': user.phone
      }).sort({ completedAt: -1 });
    }

    // ì‚¬ìš©ìë¡œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ì§ì ‘ userIdë¡œ ì‹œë„
    if (!result) {
      result = await MockExamResult.findOne({ examId, userId }).sort({ completedAt: -1 });
    }

    if (!result) {
      return res.status(404).json({ ok: false, message: "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, result });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/result/:examId/:userId] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// ë‹¨ì¼ ê²°ê³¼ ì¡°íšŒ (ì‹œí—˜ì§€ ë³´ê¸°ìš©) - ObjectIdë¡œ ì¡°íšŒ
app.get("/api/mock-exam/result/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const result = await MockExamResult.findById(id);

    if (!result) {
      return res.status(404).json({ ok: false, message: "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, result });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/result] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// ===== ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬ì API =====
// ì „ì²´ ê²°ê³¼ ì¡°íšŒ (ê´€ë¦¬ììš©)
app.get("/api/mock-exam/admin/results", async (req, res) => {
  try {
    const results = await MockExamResult.find({})
      .sort({ completedAt: -1 });

    res.json({ ok: true, results });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/results] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// í•™ìƒ ì •ë³´ ìˆ˜ì • (ê´€ë¦¬ììš©)
app.put("/api/mock-exam/admin/update/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const { studentInfo } = req.body;

    const result = await MockExamResult.findByIdAndUpdate(
      id,
      { studentInfo },
      { new: true }
    );

    if (!result) {
      return res.status(404).json({ ok: false, message: "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, message: "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", result });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/update] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// ê²°ê³¼ ì‚­ì œ (ê´€ë¦¬ììš©)
app.delete("/api/mock-exam/admin/delete/:id", async (req, res) => {
  try {
    const { id } = req.params;

    const result = await MockExamResult.findByIdAndDelete(id);

    if (!result) {
      return res.status(404).json({ ok: false, message: "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, message: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/delete] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, message: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error: err.message });
  }
});

// ===== ëª¨ì˜ê³ ì‚¬ íšŒì› API =====
// íšŒì›ê°€ì… (ì „í™”ë²ˆí˜¸ê°€ ë¹„ë°€ë²ˆí˜¸ ì—­í• )
app.post("/api/mock-exam/register", async (req, res) => {
  try {
    const { name, school, grade, phone } = req.body;

    // í•„ìˆ˜ í•„ë“œ í™•ì¸
    if (!name || !school || !grade || !phone) {
      return res.status(400).json({ ok: false, error: "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    // ë™ì¼ í•™ë…„+ì´ë¦„+ì „í™”ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸
    const existingUser = await MockExamUser.findOne({
      grade,
      name,
      phone,
      deleted: { $ne: true }
    });
    if (existingUser) {
      return res.status(400).json({ ok: false, error: "ì´ë¯¸ ë“±ë¡ëœ íšŒì›ì…ë‹ˆë‹¤." });
    }

    // ìƒˆ ì‚¬ìš©ì ìƒì„±
    const newUser = new MockExamUser({
      name,
      school,
      grade,
      phone,
      password: phone, // ì „í™”ë²ˆí˜¸ë¥¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ì‚¬ìš©
      examProgress: []
    });

    await newUser.save();

    console.log(`âœ… [ëª¨ì˜ê³ ì‚¬] ì‹ ê·œ íšŒì›ê°€ì…: ${name} (${phone})`);
    res.json({ ok: true, message: "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/register] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ë¡œê·¸ì¸ (í•™ë…„ + ì´ë¦„ + ì „í™”ë²ˆí˜¸ë¡œ ì¸ì¦)
app.post("/api/mock-exam/login", async (req, res) => {
  try {
    const { grade, name, phone } = req.body;

    if (!grade || !name || !phone) {
      return res.status(400).json({ ok: false, error: "í•™ë…„, ì´ë¦„, ì „í™”ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    // í•™ë…„ + ì´ë¦„ + ì „í™”ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì°¾ê¸°
    const user = await MockExamUser.findOne({
      grade,
      name,
      phone,
      deleted: { $ne: true }
    });

    if (!user) {
      return res.status(401).json({ ok: false, error: "ì¼ì¹˜í•˜ëŠ” íšŒì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. í•™ë…„, ì´ë¦„, ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." });
    }

    if (user.status !== 'active') {
      return res.status(403).json({ ok: false, error: "ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”." });
    }

    // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
    user.lastLogin = new Date();
    await user.save();

    console.log(`âœ… [ëª¨ì˜ê³ ì‚¬] ë¡œê·¸ì¸: ${user.name} (${phone})`);

    // ë¹„ë°€ë²ˆí˜¸ ì œì™¸í•˜ê³  ë°˜í™˜
    const userInfo = {
      _id: user._id,
      name: user.name,
      school: user.school,
      grade: user.grade,
      phone: user.phone,
      examProgress: user.examProgress
    };

    res.json({ ok: true, user: userInfo });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/login] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ë‚˜ì˜ ëª¨ì˜ê³ ì‚¬ ëª©ë¡ ì¡°íšŒ
app.get("/api/mock-exam/my-exams", async (req, res) => {
  try {
    const userId = req.headers['x-user-id'];

    if (!userId) {
      return res.status(401).json({ ok: false, error: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ObjectIdì¸ ê²½ìš°ì—ë§Œ)
    let user = null;
    if (mongoose.Types.ObjectId.isValid(userId)) {
      user = await MockExamUser.findById(userId);
    }

    // ëª¨ì˜ê³ ì‚¬ ëª©ë¡ (í˜„ì¬ëŠ” í•˜ë“œì½”ë”©, ì¶”í›„ DBì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ)
    const exams = [
      { id: 'korean_mock_1', round: 1, title: '1ì›” AI ëª¨ì˜ê³ ì‚¬ 1íšŒ' },
      { id: 'korean_mock_2', round: 2, title: '1ì›” AI ëª¨ì˜ê³ ì‚¬ 2íšŒ' },
      { id: 'korean_mock_3', round: 3, title: '1ì›” AI ëª¨ì˜ê³ ì‚¬ 3íšŒ' },
      { id: 'korean_mock_4', round: 4, title: '1ì›” AI ëª¨ì˜ê³ ì‚¬ 4íšŒ' }
    ];

    // ì‚¬ìš©ìì˜ ì‹œí—˜ ì§„í–‰ ìƒíƒœì™€ ì™„ë£Œëœ ê²°ê³¼ ì¡°íšŒ
    const progress = [];

    // MockExamResultì—ì„œ ì§ì ‘ ì‚¬ìš©ìì˜ ëª¨ë“  ì™„ë£Œëœ ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ
    // userId ë˜ëŠ” ì „í™”ë²ˆí˜¸+ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­ (visitor_xxx í˜•íƒœì˜ userIdë„ ì§€ì›)
    let queryConditions = [{ userId: userId }];
    if (user) {
      queryConditions.push({
        'studentInfo.phoneNumber': user.phone,
        'studentInfo.studentName': user.name
      });
    }
    const allResults = await MockExamResult.find({
      $or: queryConditions
    }).sort({ completedAt: -1 });

    for (const exam of exams) {
      const examProg = user && user.examProgress ? user.examProgress.find(p => p.examId === exam.id) : null;

      // ë¨¼ì € MockExamResultì—ì„œ í•´ë‹¹ ì‹œí—˜ ê²°ê³¼ ì°¾ê¸° (ê°€ì¥ ìµœê·¼ ê²°ê³¼)
      const directResult = allResults.find(r => r.examId === exam.id);

      // attemptCount: í•´ë‹¹ ì‹œí—˜ì˜ ê²°ê³¼ ê°œìˆ˜ë¥¼ ì¹´ìš´íŠ¸ (ì±„ì  íšŸìˆ˜)
      const attemptCount = allResults.filter(r => r.examId === exam.id).length;

      if (directResult) {
        // ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ
        progress.push({
          examId: exam.id,
          status: 'completed',
          score: directResult.score,
          grade: directResult.grade ? `${directResult.grade}ë“±ê¸‰` : '-ë“±ê¸‰',
          correctCount: directResult.correctCount,
          elapsedTimeStr: directResult.elapsedTimeStr || '--:--',
          wrongAnswers: directResult.wrongAnswers || [],
          completedAt: directResult.completedAt,
          attemptCount: attemptCount
        });
      } else if (examProg) {
        if (examProg.status === 'completed' && examProg.resultId) {
          // examProgressì—ì„œ ì™„ë£Œ ìƒíƒœì¸ ê²½ìš° ê²°ê³¼ ì¡°íšŒ
          const result = await MockExamResult.findById(examProg.resultId);
          if (result) {
            progress.push({
              examId: exam.id,
              status: 'completed',
              score: result.score,
              grade: result.grade ? `${result.grade}ë“±ê¸‰` : '-ë“±ê¸‰',
              correctCount: result.correctCount,
              elapsedTimeStr: result.elapsedTimeStr || '--:--',
              wrongAnswers: result.wrongAnswers || [],
              completedAt: result.completedAt,
              attemptCount: attemptCount
            });
          } else {
            progress.push({
              examId: exam.id,
              status: examProg.status,
              remainingTime: examProg.remainingTime,
              attemptCount: attemptCount
            });
          }
        } else {
          progress.push({
            examId: exam.id,
            status: examProg.status,
            remainingTime: examProg.remainingTime,
            attemptCount: attemptCount
          });
        }
      } else {
        progress.push({
          examId: exam.id,
          status: 'not_started',
          attemptCount: 0
        });
      }
    }

    res.json({ ok: true, exams, progress });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/my-exams] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì˜ì—­ë³„ ë¶„ì„ ë°ì´í„° ì¡°íšŒ
app.get("/api/mock-exam/area-analysis/:userId", async (req, res) => {
  try {
    const { userId } = req.params;

    if (!userId) {
      return res.status(401).json({ ok: false, error: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ì „í™”ë²ˆí˜¸+ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­í•˜ê¸° ìœ„í•´)
    // visitor_xxx í˜•íƒœì˜ userIdëŠ” ObjectIdê°€ ì•„ë‹ˆë¯€ë¡œ ê²€ì¦ í•„ìš”
    let user = null;
    if (mongoose.Types.ObjectId.isValid(userId)) {
      user = await MockExamUser.findById(userId);
    }

    // í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œëœ ëª¨ë“  ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ
    // userId ë˜ëŠ” ì „í™”ë²ˆí˜¸+ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­ (visitor_xxx í˜•íƒœì˜ userIdë„ ì§€ì›)
    const queryConditions = [{ userId }];
    if (user) {
      queryConditions.push({
        'studentInfo.phoneNumber': user.phone,
        'studentInfo.studentName': user.name
      });
    }
    const allResults = await MockExamResult.find({ $or: queryConditions }).sort({ completedAt: -1 });

    if (!allResults || allResults.length === 0) {
      return res.json({ ok: true, hasData: false });
    }

    // ê° íšŒì°¨(examId)ë³„ë¡œ ìµœì‹  ê²°ê³¼ 1ê°œì”©ë§Œ ì‚¬ìš©
    const latestByExam = {};
    allResults.forEach(result => {
      const examId = result.examId || 'korean_mock_1';
      if (!latestByExam[examId]) {
        latestByExam[examId] = result;
      }
    });
    const results = Object.values(latestByExam);

    // ì‹œí—˜ë³„ ì˜ì—­ë³„ ë¬¸í•­ ë²ˆí˜¸
    const areaQuestionsByExam = {
      'korean_mock_1': {
        speech: [1, 2, 4, 5, 6, 24, 25, 26, 27, 28, 29, 30],  // í™”ë²•ê³¼ ì‘ë¬¸ (12ë¬¸í•­)
        grammar: [3, 7, 8, 9, 10],                             // ë¬¸ë²• (5ë¬¸í•­)
        reading: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23], // ë¹„ë¬¸í•™ (13ë¬¸í•­)
        literature: [31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      },
      'korean_mock_2': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],   // í™”ë²•ê³¼ ì‘ë¬¸ (10ë¬¸í•­)
        grammar: [11, 12, 13, 14, 15],              // ë¬¸ë²• (5ë¬¸í•­)
        reading: [16, 17, 18, 19, 20, 21, 26, 27, 28, 29, 30, 31, 32, 33, 34], // ë¹„ë¬¸í•™ (15ë¬¸í•­)
        literature: [22, 23, 24, 25, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      },
      'korean_mock_3': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],   // í™”ë²•ê³¼ ì‘ë¬¸ (10ë¬¸í•­)
        grammar: [11, 12, 13, 14, 15],              // ë¬¸ë²• (5ë¬¸í•­)
        reading: [20, 21, 22, 23, 24, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37], // ë¹„ë¬¸í•™ (15ë¬¸í•­)
        literature: [16, 17, 18, 19, 25, 26, 27, 38, 39, 40, 41, 42, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      },
      'korean_mock_4': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],   // í™”ë²•ê³¼ ì‘ë¬¸ (10ë¬¸í•­)
        grammar: [11, 12, 13, 14, 15],              // ë¬¸ë²• (5ë¬¸í•­)
        reading: [21, 22, 23, 24, 25, 29, 30, 31, 32, 33, 38, 39, 40, 41, 42], // ë¹„ë¬¸í•™ (15ë¬¸í•­)
        literature: [16, 17, 18, 19, 20, 26, 27, 28, 34, 35, 36, 37, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      }
    };
    // ê¸°ë³¸ê°’ (1íšŒì°¨)
    const defaultAreaQuestions = areaQuestionsByExam['korean_mock_1'];

    // ëˆ„ì  í†µê³„ ê³„ì‚°
    const totals = {
      speech: { correct: 0, total: 0 },
      grammar: { correct: 0, total: 0 },
      reading: { correct: 0, total: 0 },
      literature: { correct: 0, total: 0 }
    };

    results.forEach(result => {
      const wrongSet = new Set((result.wrongAnswers || []).map(w => w.questionNum));
      // í•´ë‹¹ ì‹œí—˜ì˜ ì˜ì—­ ë§¤í•‘ ì‚¬ìš©
      const areaQuestions = areaQuestionsByExam[result.examId] || defaultAreaQuestions;

      ['speech', 'grammar', 'reading', 'literature'].forEach(area => {
        const questions = areaQuestions[area];
        const wrongCount = questions.filter(q => wrongSet.has(q)).length;
        totals[area].total += questions.length;
        totals[area].correct += questions.length - wrongCount;
      });
    });

    const areaScores = {
      speech: {
        correct: totals.speech.correct,
        total: totals.speech.total,
        percent: totals.speech.total > 0 ? Math.round((totals.speech.correct / totals.speech.total) * 100) : 0
      },
      grammar: {
        correct: totals.grammar.correct,
        total: totals.grammar.total,
        percent: totals.grammar.total > 0 ? Math.round((totals.grammar.correct / totals.grammar.total) * 100) : 0
      },
      reading: {
        correct: totals.reading.correct,
        total: totals.reading.total,
        percent: totals.reading.total > 0 ? Math.round((totals.reading.correct / totals.reading.total) * 100) : 0
      },
      literature: {
        correct: totals.literature.correct,
        total: totals.literature.total,
        percent: totals.literature.total > 0 ? Math.round((totals.literature.correct / totals.literature.total) * 100) : 0
      }
    };

    res.json({ ok: true, hasData: true, areaScores, examCount: results.length });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/area-analysis] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// AI í”¼ë“œë°± ìƒì„± API
app.post("/api/mock-exam/generate-ai-feedback", async (req, res) => {
  try {
    const { areaScores, examCount } = req.body;

    if (!areaScores) {
      return res.status(400).json({ ok: false, error: "ì˜ì—­ë³„ ì ìˆ˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // ì˜ì—­ë³„ ì ìˆ˜ ì •ë¦¬
    const scores = {
      grammar: areaScores.grammar?.percent || 0,
      speech: areaScores.speech?.percent || 0,
      reading: areaScores.reading?.percent || 0,
      literature: areaScores.literature?.percent || 0
    };

    // ì˜ì—­ë³„ ì „ì²´ í‰ê·  ê³„ì‚° (ëª¨ë“  ì‘ì‹œì ëŒ€ìƒ)
    const areaQuestionsByExam = {
      'korean_mock_1': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
        grammar: [11, 12, 13, 14, 15],
        reading: [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30],
        literature: [31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]
      }
    };

    // ëª¨ë“  ì‘ì‹œ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
    const allResults = await MockExamResult.find({});

    // ì˜ì—­ë³„ ì „ì²´ í‰ê·  ê³„ì‚°
    const globalAreaAvg = { grammar: 0, speech: 0, reading: 0, literature: 0 };

    if (allResults.length > 0) {
      const areaTotals = { grammar: 0, speech: 0, reading: 0, literature: 0 };

      allResults.forEach(result => {
        const wrongSet = new Set((result.wrongAnswers || []).map(w => w.questionNum));
        const areaQuestions = areaQuestionsByExam[result.examId] || areaQuestionsByExam['korean_mock_1'];

        ['speech', 'grammar', 'reading', 'literature'].forEach(area => {
          const questions = areaQuestions[area];
          const wrongCount = questions.filter(q => wrongSet.has(q)).length;
          const correctCount = questions.length - wrongCount;
          areaTotals[area] += Math.round((correctCount / questions.length) * 100);
        });
      });

      ['grammar', 'speech', 'reading', 'literature'].forEach(area => {
        globalAreaAvg[area] = Math.round(areaTotals[area] / allResults.length);
      });
    }

    // ì ìˆ˜ ìˆœìœ¼ë¡œ ì˜ì—­ ì •ë ¬
    const sortedAreas = Object.entries(scores)
      .sort((a, b) => b[1] - a[1])
      .map(([area]) => area);

    const areaNames = {
      grammar: 'ë¬¸ë²•',
      speech: 'í™”ë²•ê³¼ ì‘ë¬¸',
      reading: 'ë¹„ë¬¸í•™',
      literature: 'ë¬¸í•™'
    };

    const strongestArea = areaNames[sortedAreas[0]];
    const weakestArea = areaNames[sortedAreas[3]];
    const areaOrder = sortedAreas.slice(1).map(a => areaNames[a]).join(' â†’ ');

    // í‰ê·  ëŒ€ë¹„ ì°¨ì´ ê³„ì‚°
    const diffFromAvg = {
      grammar: scores.grammar - globalAreaAvg.grammar,
      speech: scores.speech - globalAreaAvg.speech,
      reading: scores.reading - globalAreaAvg.reading,
      literature: scores.literature - globalAreaAvg.literature
    };

    // OpenAI í”„ë¡¬í”„íŠ¸
    const prompt = `ë‹¹ì‹ ì€ í•™ìƒë“¤ì„ ì§„ì‹¬ìœ¼ë¡œ ì‘ì›í•˜ëŠ” ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ êµ­ì–´ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
í•™ìƒì˜ ëª¨ì˜ê³ ì‚¬ ì˜ì—­ë³„ ì„±ì ì„ **ì „ì²´ í‰ê· ê³¼ ë¹„êµ**í•˜ì—¬ ë¶„ì„í•˜ê³ , ë§ˆì¹˜ ì¢‹ì€ ì„ ìƒë‹˜ì´ í•™ìƒì—ê²Œ ì§ì ‘ ë§í•´ì£¼ë“¯ì´ ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.

í•™ìƒ ì„±ì  ë°ì´í„°:
- ë¬¸ë²•: ${scores.grammar}% (ì „ì²´ í‰ê· : ${globalAreaAvg.grammar}%, ${diffFromAvg.grammar >= 0 ? '+' : ''}${diffFromAvg.grammar}%p)
- í™”ë²•ê³¼ ì‘ë¬¸: ${scores.speech}% (ì „ì²´ í‰ê· : ${globalAreaAvg.speech}%, ${diffFromAvg.speech >= 0 ? '+' : ''}${diffFromAvg.speech}%p)
- ë¹„ë¬¸í•™: ${scores.reading}% (ì „ì²´ í‰ê· : ${globalAreaAvg.reading}%, ${diffFromAvg.reading >= 0 ? '+' : ''}${diffFromAvg.reading}%p)
- ë¬¸í•™: ${scores.literature}% (ì „ì²´ í‰ê· : ${globalAreaAvg.literature}%, ${diffFromAvg.literature >= 0 ? '+' : ''}${diffFromAvg.literature}%p)
- ì‘ì‹œ íšŸìˆ˜: ${examCount || 1}íšŒ

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ JSONì„ ë°˜í™˜í•´ì£¼ì„¸ìš” (ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ì¶œë ¥):
{
  "summary": "ì „ì²´ ì„±ì ì— ëŒ€í•œ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” 4-5ë¬¸ì¥ ìš”ì•½. í‰ê·  ëŒ€ë¹„ ì˜í•˜ëŠ” ì˜ì—­ì€ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•˜ê³ , í‰ê· ë³´ë‹¤ ë‚®ì€ ì˜ì—­ì€ ê¸ì •ì ì¸ ì‹œì„ ìœ¼ë¡œ ê²©ë ¤í•´ì£¼ì„¸ìš”.",
  "areaFeedback": {
    "grammar": {
      "level": "9ë‹¨ê³„ ë“±ê¸‰ ì¤‘ í•˜ë‚˜ (ìƒìƒ/ìƒì¤‘/ìƒí•˜/ì¤‘ìƒ/ì¤‘ì¤‘/ì¤‘í•˜/í•˜ìƒ/í•˜ì¤‘/í•˜í•˜)",
      "tip": "ë¬¸ë²• ì˜ì—­ì— ëŒ€í•œ ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ í•™ìŠµ ì¡°ì–¸ 3-4ë¬¸ì¥. í‰ê·  ëŒ€ë¹„ í˜„ì¬ ìƒíƒœë¥¼ ì–¸ê¸‰í•˜ê³ , êµ¬ì²´ì ì¸ í•™ìŠµ ë°©ë²•ì„ ì œì•ˆí•˜ê³ , ê²©ë ¤ë¡œ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”."
    },
    "speech": {
      "level": "9ë‹¨ê³„ ë“±ê¸‰ ì¤‘ í•˜ë‚˜",
      "tip": "í™”ë²•ê³¼ ì‘ë¬¸ ì˜ì—­ì— ëŒ€í•œ ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ í•™ìŠµ ì¡°ì–¸ 3-4ë¬¸ì¥."
    },
    "reading": {
      "level": "9ë‹¨ê³„ ë“±ê¸‰ ì¤‘ í•˜ë‚˜",
      "tip": "ë¹„ë¬¸í•™ ì˜ì—­ì— ëŒ€í•œ ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ í•™ìŠµ ì¡°ì–¸ 3-4ë¬¸ì¥."
    },
    "literature": {
      "level": "9ë‹¨ê³„ ë“±ê¸‰ ì¤‘ í•˜ë‚˜",
      "tip": "ë¬¸í•™ ì˜ì—­ì— ëŒ€í•œ ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ í•™ìŠµ ì¡°ì–¸ 3-4ë¬¸ì¥."
    }
  }
}

9ë‹¨ê³„ level ê¸°ì¤€ (í¼ì„¼íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì •í™•íˆ ì ìš©):
- ìƒìƒ: 95% ì´ìƒ
- ìƒì¤‘: 90-94%
- ìƒí•˜: 85-89%
- ì¤‘ìƒ: 80-84%
- ì¤‘ì¤‘: 75-79%
- ì¤‘í•˜: 70-74%
- í•˜ìƒ: 60-69%
- í•˜ì¤‘: 50-59%
- í•˜í•˜: 50% ë¯¸ë§Œ

**í•µì‹¬ ê°€ì´ë“œë¼ì¸ - ë°˜ë“œì‹œ í‰ê· ê³¼ ë¹„êµí•´ì„œ í”¼ë“œë°±í•˜ì„¸ìš”!**

1. í‰ê· ë³´ë‹¤ ë†’ì€ ì˜ì—­ (+5%p ì´ìƒ):
   - "í‰ê· ë³´ë‹¤ í›¨ì”¬ ë†’ì•„ìš”!", "ë‹¤ë¥¸ í•™ìƒë“¤ë³´ë‹¤ ì˜í•˜ê³  ìˆì–´ìš”!", "ì´ ì˜ì—­ì€ ê°•ì ì´ì—ìš”!"
   - êµ¬ì²´ì ìœ¼ë¡œ ëª‡ %p ë†’ì€ì§€ ì–¸ê¸‰í•´ì£¼ì„¸ìš”.

2. í‰ê· ê³¼ ë¹„ìŠ·í•œ ì˜ì—­ (Â±5%p ì´ë‚´):
   - "í‰ê·  ìˆ˜ì¤€ì´ì—ìš”. ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ìƒìœ„ê¶Œì— ê°ˆ ìˆ˜ ìˆì–´ìš”!"
   - í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°ê´€ì ìœ¼ë¡œ ì•Œë ¤ì£¼ê³  ê²©ë ¤í•´ì£¼ì„¸ìš”.

3. í‰ê· ë³´ë‹¤ ë‚®ì€ ì˜ì—­ (-5%p ì´í•˜):
   - **ì ˆëŒ€ë¡œ "í›Œë¥­í•´ìš”", "ì˜í•˜ê³  ìˆì–´ìš”"ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš”!**
   - ëŒ€ì‹ : "ì´ ì˜ì—­ì€ ì•„ì§ í‰ê· ì— ëª» ë¯¸ì¹˜ì§€ë§Œ, ì¶©ë¶„íˆ ë”°ë¼ì¡ì„ ìˆ˜ ìˆì–´ìš”!"
   - "í‰ê· ê¹Œì§€ ì˜¬ë¦¬ë ¤ë©´ ì´ëŸ° í•™ìŠµì´ í•„ìš”í•´ìš”"ë¼ê³  êµ¬ì²´ì ì¸ ë°©í–¥ì„ ì œì‹œí•´ì£¼ì„¸ìš”.
   - í˜„ì‹¤ì ì¸ ëª©í‘œ(ì˜ˆ: "ë¨¼ì € í‰ê· ê¹Œì§€ ì˜¬ë ¤ë³´ì!")ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.

4. ë”°ëœ»í•˜ì§€ë§Œ ì†”ì§í•˜ê²Œ!
   - ê±°ì§“ ì¹­ì°¬ì€ í•˜ì§€ ë§ˆì„¸ìš”. í‰ê· ë³´ë‹¤ ë‚®ì€ë° "í›Œë¥­í•´ìš”"ë¼ê³  í•˜ë©´ í•™ìƒì—ê²Œ ë„ì›€ì´ ì•ˆ ë¼ìš”.
   - í˜„ì‹¤ì„ ì¸ì •í•˜ë˜, í¬ë§ê³¼ êµ¬ì²´ì ì¸ ë°©ë²•ì„ í•¨ê»˜ ì œì‹œí•´ì£¼ì„¸ìš”.
   - ë°˜ë“œì‹œ ~í•´ìš”, ~ì˜ˆìš”, ~ê±°ì˜ˆìš”, ~ì´ì—ìš” ê°™ì€ ì¹œê·¼í•œ ì¢…ê²°ì–´ë¯¸ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.

5. summary ì‘ì„± ì‹œ:
   - ìµœì†Œ 4-5ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
   - í‰ê·  ëŒ€ë¹„ ê°•ì  ì˜ì—­ ì¹­ì°¬ + í‰ê·  ëŒ€ë¹„ ì•½ì  ì˜ì—­ í˜„ì‹¤ì  ê²©ë ¤ + ì•ìœ¼ë¡œì˜ ëª©í‘œ + ì‘ì› ë©”ì‹œì§€

ì¤‘ìš”: í•™ìƒì´ ìì‹ ì˜ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì •í™•íˆ ì•Œê³ , "í‰ê· ê¹Œì§€ ì˜¬ë¼ê°€ì!", "í‰ê· ì„ ë„˜ì–´ì„œì!"ë¼ëŠ” êµ¬ì²´ì ì¸ ëª©í‘œë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”!`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "ë‹¹ì‹ ì€ í•™ìƒë“¤ì„ ì§„ì‹¬ìœ¼ë¡œ ì‘ì›í•˜ëŠ” ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ êµ­ì–´ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•™ìƒë“¤ì—ê²Œ ì¹­ì°¬ê³¼ ê²©ë ¤ë¥¼ ì•„ë¼ì§€ ì•Šê³ , í•­ìƒ ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ë©”ì‹œì§€ë¥¼ ì „í•©ë‹ˆë‹¤. ì¹œê·¼í•œ ë§íˆ¬(~í•´ìš”, ~ì˜ˆìš”, ~ê±°ì˜ˆìš”)ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ê³ , ê° ì˜ì—­ì˜ ê°ì²´ëŠ” ë°˜ë“œì‹œ ë‹«ëŠ” ê´„í˜¸ë¡œ ì™„ì„±í•´ì£¼ì„¸ìš”." },
        { role: "user", content: prompt }
      ],
      response_format: { type: "json_object" },
      temperature: 0.7,
      max_tokens: 2000
    });

    const responseText = completion.choices[0].message.content.trim();

    // JSON íŒŒì‹± ì‹œë„
    let feedbackData;
    try {
      // JSON ë¸”ë¡ ì¶”ì¶œ (```json ... ``` í˜•íƒœì¼ ê²½ìš° ëŒ€ë¹„)
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        feedbackData = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error("JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    } catch (parseError) {
      console.error("âŒ JSON íŒŒì‹± ì‹¤íŒ¨:", parseError, responseText);
      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì‘ë‹µ ìƒì„± (9ë‹¨ê³„ ë“±ê¸‰, í‰ê·  ë¹„êµ ë°˜ì˜)
      const getLevel9 = (p) => {
        if (p >= 95) return "ìƒìƒ";
        if (p >= 90) return "ìƒì¤‘";
        if (p >= 85) return "ìƒí•˜";
        if (p >= 80) return "ì¤‘ìƒ";
        if (p >= 75) return "ì¤‘ì¤‘";
        if (p >= 70) return "ì¤‘í•˜";
        if (p >= 60) return "í•˜ìƒ";
        if (p >= 50) return "í•˜ì¤‘";
        return "í•˜í•˜";
      };
      // í‰ê·  ëŒ€ë¹„ ì°¨ì´ì— ë”°ë¥¸ íŒ ìƒì„±
      const getTipWithAvg = (area, score, avg) => {
        const diff = score - avg;
        const areaNameMap = { grammar: 'ë¬¸ë²•', speech: 'í™”ë²•ê³¼ ì‘ë¬¸', reading: 'ë¹„ë¬¸í•™', literature: 'ë¬¸í•™' };
        const areaName = areaNameMap[area];

        if (diff >= 5) {
          // í‰ê· ë³´ë‹¤ ë†’ìŒ
          return `${areaName} ì˜ì—­ì—ì„œ í‰ê· ë³´ë‹¤ ${diff}%pë‚˜ ë†’ì•„ìš”! ì •ë§ ì˜í•˜ê³  ìˆì–´ìš”. ì´ ê°•ì ì„ ìœ ì§€í•˜ë©´ì„œ ë‹¤ë¥¸ ì˜ì—­ë„ ëŒì–´ì˜¬ë ¤ ë³´ì„¸ìš”. ì´ í˜ì´ìŠ¤ë©´ ìƒìœ„ê¶Œ ì§„ì…ë„ ì–´ë µì§€ ì•Šì•„ìš”!`;
        } else if (diff >= -5) {
          // í‰ê· ê³¼ ë¹„ìŠ·
          return `${areaName} ì˜ì—­ì€ í‰ê·  ìˆ˜ì¤€ì´ì—ìš”. ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ìƒìœ„ê¶Œì— ì§„ì…í•  ìˆ˜ ìˆì–´ìš”! ê¸°ë³¸ê¸°ëŠ” ê°–ì¶°ì ¸ ìˆìœ¼ë‹ˆ, ì·¨ì•½í•œ ìœ í˜• ìœ„ì£¼ë¡œ ì§‘ì¤‘ ì—°ìŠµí•´ë³´ì„¸ìš”. ì¶©ë¶„íˆ í•  ìˆ˜ ìˆì–´ìš”!`;
        } else {
          // í‰ê· ë³´ë‹¤ ë‚®ìŒ
          return `${areaName} ì˜ì—­ì€ ì•„ì§ í‰ê· ì— ${Math.abs(diff)}%p ëª» ë¯¸ì¹˜ì§€ë§Œ, ì¶©ë¶„íˆ ë”°ë¼ì¡ì„ ìˆ˜ ìˆì–´ìš”! ë¨¼ì € ê¸°ì´ˆ ê°œë…ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì •ë¦¬í•˜ê³ , ì‰¬ìš´ ë¬¸ì œë¶€í„° í’€ì–´ë³´ì„¸ìš”. í‰ê· ê¹Œì§€ ì˜¬ë¦¬ëŠ” ê²ƒì„ ì²« ë²ˆì§¸ ëª©í‘œë¡œ ì‚¼ì•„ë´ìš”!`;
        }
      };

      // í‰ê·  ëŒ€ë¹„ ê°•ì /ì•½ì  íŒŒì•…
      const aboveAvgAreas = Object.entries(diffFromAvg).filter(([_, d]) => d >= 5).map(([a]) => areaNames[a]);
      const belowAvgAreas = Object.entries(diffFromAvg).filter(([_, d]) => d < -5).map(([a]) => areaNames[a]);

      let summaryText = '';
      if (aboveAvgAreas.length > 0) {
        summaryText += `${aboveAvgAreas.join(', ')} ì˜ì—­ì—ì„œ í‰ê· ë³´ë‹¤ ë†’ì€ ì„±ì ì„ ë³´ì—¬ì£¼ê³  ìˆì–´ìš”! ì´ ë¶€ë¶„ì€ ìì‹ ê°ì„ ê°€ì ¸ë„ ì¢‹ì•„ìš”. `;
      }
      if (belowAvgAreas.length > 0) {
        summaryText += `${belowAvgAreas.join(', ')} ì˜ì—­ì€ ì•„ì§ í‰ê· ì— ëª» ë¯¸ì¹˜ì§€ë§Œ, ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ë©´ ì¶©ë¶„íˆ ë”°ë¼ì¡ì„ ìˆ˜ ìˆì–´ìš”! `;
      }
      if (aboveAvgAreas.length === 0 && belowAvgAreas.length === 0) {
        summaryText += `ì „ì²´ì ìœ¼ë¡œ í‰ê·  ìˆ˜ì¤€ì˜ ì„±ì ì´ì—ìš”. ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ìƒìœ„ê¶Œì— ê°ˆ ìˆ˜ ìˆì–´ìš”! `;
      }
      summaryText += `ë¨¼ì € í‰ê· ê¹Œì§€ ì˜¬ë¦¬ëŠ” ê²ƒì„ ëª©í‘œë¡œ, ì·¨ì•½í•œ ì˜ì—­ë¶€í„° ì§‘ì¤‘ì ìœ¼ë¡œ ê³µë¶€í•´ë³´ì„¸ìš”. í™”ì´íŒ…!`;

      feedbackData = {
        summary: summaryText,
        areaFeedback: {
          grammar: { level: getLevel9(scores.grammar), tip: getTipWithAvg('grammar', scores.grammar, globalAreaAvg.grammar) },
          speech: { level: getLevel9(scores.speech), tip: getTipWithAvg('speech', scores.speech, globalAreaAvg.speech) },
          reading: { level: getLevel9(scores.reading), tip: getTipWithAvg('reading', scores.reading, globalAreaAvg.reading) },
          literature: { level: getLevel9(scores.literature), tip: getTipWithAvg('literature', scores.literature, globalAreaAvg.literature) }
        }
      };
    }

    res.json({
      ok: true,
      feedback: {
        strongestArea,
        weakestArea,
        areaOrder,
        ...feedbackData
      },
      scores
    });

  } catch (err) {
    console.error("âŒ [/api/mock-exam/generate-ai-feedback] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "AI í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì˜ì—­ë³„ ì„±ì  ë³€í™” ì¶”ì´ ë°ì´í„° ì¡°íšŒ
app.get("/api/mock-exam/area-trend/:userId", async (req, res) => {
  try {
    const { userId } = req.params;

    if (!userId) {
      return res.status(401).json({ ok: false, error: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ì „í™”ë²ˆí˜¸+ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­í•˜ê¸° ìœ„í•´)
    // visitor_xxx í˜•íƒœì˜ userIdëŠ” ObjectIdê°€ ì•„ë‹ˆë¯€ë¡œ ê²€ì¦ í•„ìš”
    let user = null;
    if (mongoose.Types.ObjectId.isValid(userId)) {
      user = await MockExamUser.findById(userId);
    }

    // í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œëœ ëª¨ë“  ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ (ìµœì‹ ìˆœìœ¼ë¡œ)
    const queryConditions = [{ userId }];
    if (user) {
      queryConditions.push({
        'studentInfo.phoneNumber': user.phone,
        'studentInfo.studentName': user.name
      });
    }
    const allResults = await MockExamResult.find({ $or: queryConditions }).sort({ completedAt: -1 });

    if (!allResults || allResults.length < 1) {
      return res.json({ ok: true, hasData: false, trendData: [] });
    }

    // ê° íšŒì°¨(examId)ë³„ë¡œ ìµœì‹  ê²°ê³¼ 1ê°œì”©ë§Œ ì‚¬ìš©
    const latestByExam = {};
    allResults.forEach(result => {
      const examId = result.examId || 'korean_mock_1';
      if (!latestByExam[examId]) {
        latestByExam[examId] = result;
      }
    });
    // íšŒì°¨ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (korean_mock_1, korean_mock_2, ...)
    const results = Object.values(latestByExam).sort((a, b) => {
      const aNum = parseInt((a.examId || 'korean_mock_1').replace('korean_mock_', ''));
      const bNum = parseInt((b.examId || 'korean_mock_1').replace('korean_mock_', ''));
      return aNum - bNum;
    });

    // ì‹œí—˜ë³„ ì˜ì—­ë³„ ë¬¸í•­ ë²ˆí˜¸
    const areaQuestionsByExam = {
      'korean_mock_1': {
        speech: [1, 2, 4, 5, 6, 24, 25, 26, 27, 28, 29, 30],  // í™”ë²•ê³¼ ì‘ë¬¸ (12ë¬¸í•­)
        grammar: [3, 7, 8, 9, 10],                             // ë¬¸ë²• (5ë¬¸í•­)
        reading: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23], // ë¹„ë¬¸í•™ (13ë¬¸í•­)
        literature: [31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      },
      'korean_mock_2': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],   // í™”ë²•ê³¼ ì‘ë¬¸ (10ë¬¸í•­)
        grammar: [11, 12, 13, 14, 15],              // ë¬¸ë²• (5ë¬¸í•­)
        reading: [16, 17, 18, 19, 20, 21, 26, 27, 28, 29, 30, 31, 32, 33, 34], // ë¹„ë¬¸í•™ (15ë¬¸í•­)
        literature: [22, 23, 24, 25, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      },
      'korean_mock_3': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],   // í™”ë²•ê³¼ ì‘ë¬¸ (10ë¬¸í•­)
        grammar: [11, 12, 13, 14, 15],              // ë¬¸ë²• (5ë¬¸í•­)
        reading: [20, 21, 22, 23, 24, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37], // ë¹„ë¬¸í•™ (15ë¬¸í•­)
        literature: [16, 17, 18, 19, 25, 26, 27, 38, 39, 40, 41, 42, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      },
      'korean_mock_4': {
        speech: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],   // í™”ë²•ê³¼ ì‘ë¬¸ (10ë¬¸í•­)
        grammar: [11, 12, 13, 14, 15],              // ë¬¸ë²• (5ë¬¸í•­)
        reading: [21, 22, 23, 24, 25, 29, 30, 31, 32, 33, 38, 39, 40, 41, 42], // ë¹„ë¬¸í•™ (15ë¬¸í•­)
        literature: [16, 17, 18, 19, 20, 26, 27, 28, 34, 35, 36, 37, 43, 44, 45]  // ë¬¸í•™ (15ë¬¸í•­)
      }
    };

    // ê° íšŒì°¨ë³„ ì „ì²´ í‰ê·  ê³„ì‚° (ëª¨ë“  ì‘ì‹œì ëŒ€ìƒ)
    const examIds = [...new Set(results.map(r => r.examId || 'korean_mock_1'))];
    const globalAvgByExam = {};

    for (const examId of examIds) {
      const allExamResults = await MockExamResult.find({ examId });
      if (allExamResults.length > 0) {
        const totalCorrect = allExamResults.reduce((sum, r) => {
          const wrongCount = (r.wrongAnswers || []).length;
          return sum + (45 - wrongCount);
        }, 0);
        globalAvgByExam[examId] = Math.round((totalCorrect / allExamResults.length / 45) * 100);
      } else {
        globalAvgByExam[examId] = 0;
      }
    }

    // ê° ì‹œí—˜ë³„ ì˜ì—­ ì ìˆ˜ ê³„ì‚°
    const trendData = results.map((result, idx) => {
      const wrongSet = new Set((result.wrongAnswers || []).map(w => w.questionNum));

      // í•´ë‹¹ ì‹œí—˜ì˜ ì˜ì—­ ë§¤í•‘ ì‚¬ìš© (ì—†ìœ¼ë©´ 1íšŒì°¨ ê¸°ë³¸ê°’)
      const areaQuestions = areaQuestionsByExam[result.examId] || areaQuestionsByExam['korean_mock_1'];

      // ë””ë²„ê·¸ ë¡œê·¸
      console.log(`[area-trend] examId: ${result.examId}, wrongAnswers: ${JSON.stringify(result.wrongAnswers)}`);
      console.log(`[area-trend] speech questions: ${areaQuestions.speech}, wrongSet: ${[...wrongSet]}`);

      const areaScores = {};
      const areaDetails = {};  // ì˜ì—­ë³„ ë§ì€ê°œìˆ˜/ì´ê°œìˆ˜ ì •ë³´
      ['speech', 'grammar', 'reading', 'literature'].forEach(area => {
        const questions = areaQuestions[area];
        const wrongCount = questions.filter(q => wrongSet.has(q)).length;
        const correctCount = questions.length - wrongCount;
        areaScores[area] = Math.round((correctCount / questions.length) * 100);
        areaDetails[area] = { correct: correctCount, total: questions.length };
        console.log(`[area-trend] ${area}: questions=${questions.length}, wrongCount=${wrongCount}, correctCount=${correctCount}, score=${areaScores[area]}`);
      });

      // ì „ì²´ í‰ê·  ì ìˆ˜ ê³„ì‚° (45ë¬¸í•­ ê¸°ì¤€)
      const totalQuestions = 45;
      const wrongCount = wrongSet.size;
      const correctCount = totalQuestions - wrongCount;
      const avgScore = Math.round((correctCount / totalQuestions) * 100);

      // ì‘ì‹œì¼ í¬ë§·íŒ…
      const date = new Date(result.completedAt);
      const dateStr = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;

      // ì˜ˆì¸¡ ì ìˆ˜: ì œì¶œ ì‹œ ì €ì¥ëœ predictionAtSubmit ê°’ ì‚¬ìš©
      // (2íšŒì°¨ ì´ìƒ ì œì¶œ ì‹œ ë ˆì´ë” ì°¨íŠ¸ì™€ ë™ì¼í•œ ì˜ˆì¸¡ê°’ì´ ì €ì¥ë¨)
      let predictionScores = result.predictionAtSubmit || null;

      return {
        date: dateStr,
        fullDate: result.completedAt,
        examId: result.examId,
        examTitle: result.examTitle,
        correctCount,
        totalQuestions,
        avgScore,
        globalAvg: globalAvgByExam[result.examId || 'korean_mock_1'] || 0,
        areaDetails,  // ì˜ì—­ë³„ ë§ì€ê°œìˆ˜/ì´ê°œìˆ˜ ì •ë³´
        prediction: predictionScores,  // ì˜ˆì¸¡ ì ìˆ˜ (2íšŒì°¨ë¶€í„°, ë³´ì™„í•™ìŠµ ìˆì„ ë•Œë§Œ)
        ...areaScores
      };
    });

    res.json({ ok: true, hasData: trendData.length >= 1, trendData });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/area-trend] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì‹œí—˜ ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
app.post("/api/mock-exam/update-progress", async (req, res) => {
  try {
    const { userId, examId, status, currentAnswers, remainingTime, resultId } = req.body;

    if (!userId || !examId) {
      return res.status(400).json({ ok: false, error: "í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }

    const user = await MockExamUser.findById(userId);
    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    // ê¸°ì¡´ ì§„í–‰ ìƒíƒœ ì°¾ê¸°
    const existingIndex = user.examProgress.findIndex(p => p.examId === examId);

    const progressData = {
      examId,
      status: status || 'in_progress',
      currentAnswers: currentAnswers ? new Map(Object.entries(currentAnswers)) : undefined,
      remainingTime,
      startedAt: status === 'in_progress' ? new Date() : undefined,
      resultId: resultId || undefined
    };

    if (existingIndex >= 0) {
      // ê¸°ì¡´ ìƒíƒœ ì—…ë°ì´íŠ¸
      user.examProgress[existingIndex] = {
        ...user.examProgress[existingIndex].toObject(),
        ...progressData
      };
    } else {
      // ìƒˆë¡œ ì¶”ê°€
      user.examProgress.push(progressData);
    }

    await user.save();

    res.json({ ok: true, message: "ì§„í–‰ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/update-progress] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== ëª¨ì˜ê³ ì‚¬ íšŒì› ê´€ë¦¬ì API =====
// areaKey â†’ ë³´ì¶©í•™ìŠµ examId ë§¤í•‘
const AREA_TO_SUPPLEMENT_EXAM_MAP = {
  litClassicPoem: 'supplement_classic_poem',
  litClassicProse: 'supplement_classic_prose',
  speechWrite: 'supplement_writing',
  grammarClassic: 'supplement_grammar_classic',
  litModernNovel: 'supplement_modern_novel',
  speechTalk: 'supplement_speech',
  speechIntegrated: 'supplement_speech_integrated',
  litModernPoem: 'supplement_modern_poem',
  grammarModern: 'supplement_grammar_modern',
  readingScience: 'supplement_reading_science',
  readingLaw: 'supplement_reading_law',
  readingSocial: 'supplement_reading_social',
  readingTech: 'supplement_reading_tech',
  readingHumanities: 'supplement_reading_humanities',
  readingArt: 'supplement_reading_art'
};

// ëª¨ë“  íšŒì› ì¡°íšŒ
app.get("/api/mock-exam/admin/users", async (req, res) => {
  try {
    const users = await MockExamUser.find({ deleted: { $ne: true } })
      .select('-password')
      .sort({ createdAt: -1 });

    // ê° ìœ ì €ë³„ AI ì¶”ì²œ ê³¼ì œ í˜„í™© ì¡°íšŒ
    const currentWeek = getWeekNumber();
    const usersWithTasks = await Promise.all(users.map(async (user) => {
      const userObj = user.toObject();

      // í•´ë‹¹ ìœ ì €ì˜ ì „ì²´ AI ì¶”ì²œ ê³¼ì œ ì¡°íšŒ (userId ë˜ëŠ” phoneìœ¼ë¡œ ë§¤ì¹­)
      const tasks = await MockExamRecommendTask.find({
        $or: [
          { userId: user._id.toString() },
          { phone: user.phone }
        ]
      });

      // í•™ìƒ ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•˜ê²Œ examId ë˜ëŠ” areaKey_targetMockRound ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì œê±°
      const uniqueTaskMap = new Map();
      for (const task of tasks) {
        // examInfoë¥¼ ê³„ì‚° (í•™ìƒ ëŒ€ì‹œë³´ë“œ APIì™€ ë™ì¼í•œ ë¡œì§)
        const targetRound = task.targetMockRound;
        let examId = null;

        // hardcodedExamsListì—ì„œ ë§¤ì¹­ë˜ëŠ” examId ì°¾ê¸°
        const hardcodedExamsList = [
          { areaKey: 'litClassicPoem', examId: 'supplement_classic_poem', targetMockRound: 1 },
          { areaKey: 'litClassicPoem', examId: 'supplement_classic_poem_geumrusa', targetMockRound: 2 },
          { areaKey: 'litClassicPoem', examId: 'supplement_classic_poem_gangho', targetMockRound: 3 },
          { areaKey: 'speechWrite', examId: 'supplement_writing', targetMockRound: 1 },
          { areaKey: 'grammarClassic', examId: 'supplement_grammar_classic', targetMockRound: 1 },
          { areaKey: 'grammarClassic', examId: 'supplement_grammar_classic_case', targetMockRound: 2 },
          { areaKey: 'grammarClassic', examId: 'supplement_grammar_medieval_honorific', targetMockRound: 3 },
          { areaKey: 'litModernNovel', examId: 'supplement_modern_novel', targetMockRound: 1 },
          { areaKey: 'speechTalk', examId: 'supplement_speech', targetMockRound: 1 },
          { areaKey: 'speechTalk', examId: 'supplement_speech_food', targetMockRound: 2 },
          { areaKey: 'speechTalk', examId: 'supplement_speech_tea', targetMockRound: 3 },
          { areaKey: 'speechWrite', examId: 'supplement_writing_subscription', targetMockRound: 2 },
          { areaKey: 'speechWrite', examId: 'supplement_writing_donation', targetMockRound: 3 },
          { areaKey: 'litClassicProse', examId: 'supplement_classic_prose', targetMockRound: 1 },
          { areaKey: 'litClassicProse', examId: 'supplement_classic_prose_nakseong', targetMockRound: 2 },
          { areaKey: 'speechIntegrated', examId: 'supplement_speech_integrated', targetMockRound: 1 },
          { areaKey: 'speechIntegrated', examId: 'supplement_speech_integrated_job', targetMockRound: 2 },
          { areaKey: 'speechIntegrated', examId: 'supplement_speech_integrated_aijudge', targetMockRound: 3 },
          { areaKey: 'litModernPoem', examId: 'supplement_modern_poem', targetMockRound: 1 },
          { areaKey: 'litModernPoem', examId: 'supplement_literature_poem_sea', targetMockRound: 2 },
          { areaKey: 'litModernNovel', examId: 'supplement_literature_novel_rondo', targetMockRound: 2 },
          { areaKey: 'litModernNovel', examId: 'supplement_literature_novel_mother', targetMockRound: 3 },
          { areaKey: 'grammarModern', examId: 'supplement_grammar_modern', targetMockRound: 1 },
          { areaKey: 'grammarModern', examId: 'supplement_grammar_modern_semantic', targetMockRound: 2 },
          { areaKey: 'grammarModern', examId: 'supplement_grammar_word_sound', targetMockRound: 3 },
          { areaKey: 'readingScience', examId: 'supplement_reading_science', targetMockRound: 1 },
          { areaKey: 'readingScience', examId: 'supplement_reading_science_tech', targetMockRound: 2 },
          { areaKey: 'readingLaw', examId: 'supplement_reading_law', targetMockRound: 1 },
          { areaKey: 'readingLaw', examId: 'supplement_reading_law_property', targetMockRound: 2 },
          { areaKey: 'readingLaw', examId: 'supplement_reading_law_tax', targetMockRound: 3 },
          { areaKey: 'readingHumanities', examId: 'supplement_reading_humanities', targetMockRound: 1 },
          { areaKey: 'readingHumanities', examId: 'supplement_reading_humanities_art', targetMockRound: 2 },
          { areaKey: 'readingHumanities', examId: 'supplement_reading_humanities_mimesis', targetMockRound: 3 },
          { areaKey: 'readingScience', examId: 'supplement_reading_science_solar', targetMockRound: 3 }
        ];

        // 1ì°¨: ì˜ì—­ + íšŒì°¨ ì¼ì¹˜
        let matchedExam = hardcodedExamsList.find(e => e.areaKey === task.areaKey && e.targetMockRound === targetRound);
        // 2ì°¨: ì˜ì—­ë§Œ ì¼ì¹˜
        if (!matchedExam) {
          matchedExam = hardcodedExamsList.find(e => e.areaKey === task.areaKey);
        }
        if (matchedExam) examId = matchedExam.examId;

        const key = examId || `${task.areaKey}_${task.targetMockRound || 'null'}`;
        if (!uniqueTaskMap.has(key)) {
          uniqueTaskMap.set(key, { task, examId });
        }
      }

      const uniqueTasks = Array.from(uniqueTaskMap.values());
      const totalTasks = uniqueTasks.length;

      // ì™„ë£Œ ê°œìˆ˜: task.status === 'completed' OR ë³´ì¶©í•™ìŠµ ê²°ê³¼ê°€ ì±„ì  ì™„ë£Œëœ ê²½ìš°
      let completedCount = 0;
      for (const { task, examId } of uniqueTasks) {
        // 1) task.statusê°€ completedì´ë©´ ì™„ë£Œ
        if (task.status === 'completed') {
          completedCount++;
          continue;
        }

        // 2) ë³´ì¶©í•™ìŠµ ê²°ê³¼ í™•ì¸ (í•´ë‹¹ examIdë¡œ SupplementResult ì¡°íšŒ)
        const supplementExamId = examId || AREA_TO_SUPPLEMENT_EXAM_MAP[task.areaKey];
        if (supplementExamId) {
          const supplementResult = await SupplementResult.findOne({
            examId: supplementExamId,
            $or: [
              { userId: user._id.toString() },
              { phone: user.phone }
            ],
            isGraded: true
          });
          if (supplementResult) {
            completedCount++;
          }
        }
      }

      userObj.aiTaskTotal = totalTasks;
      userObj.aiTaskCompleted = completedCount;

      return userObj;
    }));

    res.json({ ok: true, users: usersWithTasks });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/users] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬ (ê´€ë¦¬ì) - :id ë¼ìš°íŠ¸ë³´ë‹¤ ë¨¼ì € ì •ì˜í•´ì•¼ í•¨
app.put("/api/mock-exam/admin/users/bulk-tickets", async (req, res) => {
  try {
    const { userIds, addTickets } = req.body;

    if (!Array.isArray(userIds) || userIds.length === 0) {
      return res.status(400).json({ ok: false, error: "ì„ íƒëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤." });
    }

    if (typeof addTickets !== 'number' || addTickets <= 0) {
      return res.status(400).json({ ok: false, error: "ë¶€ì—¬í•  ì´ìš©ê¶Œ ìˆ˜ë¥¼ 1 ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    // ì„ íƒëœ ëª¨ë“  ì‚¬ìš©ìì˜ ì´ìš©ê¶Œ ì¶”ê°€
    const result = await MockExamUser.updateMany(
      { _id: { $in: userIds } },
      { $inc: { tickets: addTickets } }
    );

    console.log(`âœ… ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬: ${result.modifiedCount}ëª…ì—ê²Œ ${addTickets}íšŒ ì¶”ê°€`);

    res.json({
      ok: true,
      updatedCount: result.modifiedCount,
      addedTickets: addTickets
    });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/users/bulk-tickets] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì¼ê´„ ì´ìš©ê¶Œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íšŒì› ì •ë³´ ìˆ˜ì •
app.put("/api/mock-exam/admin/users/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const { name, school, grade, phone } = req.body;

    const user = await MockExamUser.findByIdAndUpdate(
      id,
      { name, school, grade, phone, password: phone },
      { new: true }
    ).select('-password');

    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    console.log(`âœ… [ëª¨ì˜ê³ ì‚¬] íšŒì› ì •ë³´ ìˆ˜ì •: ${name} (${phone})`);
    res.json({ ok: true, user });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/users] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íšŒì› ìƒíƒœ ë³€ê²½
app.put("/api/mock-exam/admin/users/:id/status", async (req, res) => {
  try {
    const { id } = req.params;
    const { status } = req.body;

    const user = await MockExamUser.findByIdAndUpdate(
      id,
      { status },
      { new: true }
    ).select('-password');

    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, user });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/users/status] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íšŒì› ì´ìš©ê¶Œ ì¡°íšŒ
app.get("/api/mock-exam/user/:id/tickets", async (req, res) => {
  try {
    const { id } = req.params;

    // visitor_xxx í˜•íƒœì˜ userIdëŠ” ObjectIdê°€ ì•„ë‹ˆë¯€ë¡œ ê²€ì¦ í•„ìš”
    if (!mongoose.Types.ObjectId.isValid(id)) {
      // visitor ì‚¬ìš©ìëŠ” ì´ìš©ê¶Œ ë¬´ì œí•œìœ¼ë¡œ ì²˜ë¦¬
      return res.json({ ok: true, tickets: 999 });
    }

    const user = await MockExamUser.findById(id).select('tickets');

    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, tickets: user.tickets || 0 });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/user/tickets] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íšŒì› ì´ìš©ê¶Œ ë¶€ì—¬ (ê´€ë¦¬ì)
app.put("/api/mock-exam/admin/users/:id/tickets", async (req, res) => {
  try {
    const { id } = req.params;
    const { tickets } = req.body;

    if (typeof tickets !== 'number' || tickets < 0) {
      return res.status(400).json({ ok: false, error: "ìœ íš¨í•œ ì´ìš©ê¶Œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    const user = await MockExamUser.findByIdAndUpdate(
      id,
      { tickets },
      { new: true }
    ).select('-password');

    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, user });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/users/tickets] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì´ìš©ê¶Œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì¬ì‘ì‹œ ì—¬ë¶€ í™•ì¸ (ì´ìš©ê¶Œ ì°¨ê° ì—†ì´ ì²´í¬ë§Œ)
app.post("/api/mock-exam/check-retake", async (req, res) => {
  try {
    const { userId, examId } = req.body;

    if (!userId || !examId) {
      return res.status(400).json({ ok: false, error: "ì‚¬ìš©ì IDì™€ ì‹œí—˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const user = await MockExamUser.findById(userId);
    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    // 1. í•´ë‹¹ íšŒì°¨ì— ì´ë¯¸ ì±„ì  ì™„ë£Œëœ ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingResult = await MockExamResult.findOne({
      'studentInfo.phoneNumber': user.phone,
      examId: examId
    });

    // 2. ë˜ëŠ” ì´ë¯¸ ì´ìš©ê¶Œì„ ì‚¬ìš©í•´ì„œ ì‹œí—˜ì„ ì‹œì‘í•œ ì ì´ ìˆëŠ”ì§€ í™•ì¸ (examProgress)
    const examProgressEntry = user.examProgress?.find(ep => ep.examId === examId);
    const hasStarted = examProgressEntry && (examProgressEntry.status === 'in_progress' || examProgressEntry.status === 'completed');

    res.json({
      ok: true,
      isRetake: !!existingResult || hasStarted,
      tickets: user.tickets || 0
    });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/check-retake] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ì´ìš©ê¶Œ ì‚¬ìš© (ì‹œí—˜ ì‹œì‘ ì‹œ)
app.post("/api/mock-exam/use-ticket", async (req, res) => {
  try {
    const { userId, examId } = req.body;

    if (!userId || !examId) {
      return res.status(400).json({ ok: false, error: "ì‚¬ìš©ì IDì™€ ì‹œí—˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const user = await MockExamUser.findById(userId);
    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    // 1. í•´ë‹¹ íšŒì°¨ì— ì´ë¯¸ ì±„ì  ì™„ë£Œëœ ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingResult = await MockExamResult.findOne({
      'studentInfo.phoneNumber': user.phone,
      examId: examId
    });

    if (existingResult) {
      // ì´ë¯¸ ì‘ì‹œí•œ íšŒì°¨ - ì´ìš©ê¶Œ ì°¨ê° ì—†ì´ ì‹œì‘ í—ˆìš©
      return res.json({ ok: true, ticketUsed: false, message: "ì¬ì‘ì‹œì…ë‹ˆë‹¤. ì´ìš©ê¶Œì´ ì°¨ê°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
    }

    // 2. ì´ë¯¸ ì´ìš©ê¶Œì„ ì‚¬ìš©í•´ì„œ ì‹œí—˜ì„ ì‹œì‘í•œ ì ì´ ìˆëŠ”ì§€ í™•ì¸ (examProgress)
    const examProgressEntry = user.examProgress?.find(ep => ep.examId === examId);
    if (examProgressEntry && (examProgressEntry.status === 'in_progress' || examProgressEntry.status === 'completed')) {
      // ì´ë¯¸ ì´ìš©ê¶Œ ì‚¬ìš©í•´ì„œ ì‹œì‘í•¨ - ì¶”ê°€ ì°¨ê° ì—†ì´ í—ˆìš©
      return res.json({ ok: true, ticketUsed: false, message: "ì´ë¯¸ ì‹œì‘ëœ ì‹œí—˜ì…ë‹ˆë‹¤. ì´ìš©ê¶Œì´ ì°¨ê°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
    }

    // ì²« ì‘ì‹œ - ì´ìš©ê¶Œ í™•ì¸
    if (!user.tickets || user.tickets <= 0) {
      return res.status(400).json({ ok: false, error: "ì´ìš©ê¶Œì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", needPurchase: true });
    }

    // ì´ìš©ê¶Œ ì°¨ê° ë° examProgressì— ê¸°ë¡
    user.tickets -= 1;

    // examProgressì— ì‹œí—˜ ì‹œì‘ ê¸°ë¡ ì¶”ê°€
    if (!user.examProgress) {
      user.examProgress = [];
    }

    const existingProgressIndex = user.examProgress.findIndex(ep => ep.examId === examId);
    if (existingProgressIndex >= 0) {
      // ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸
      user.examProgress[existingProgressIndex].status = 'in_progress';
      user.examProgress[existingProgressIndex].startedAt = new Date();
    } else {
      // ìƒˆ ê¸°ë¡ ì¶”ê°€
      user.examProgress.push({
        examId: examId,
        status: 'in_progress',
        startedAt: new Date()
      });
    }

    await user.save();

    res.json({ ok: true, ticketUsed: true, remainingTickets: user.tickets, message: "ì´ìš©ê¶Œì´ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/use-ticket] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì´ìš©ê¶Œ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// íšŒì› ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ)
app.delete("/api/mock-exam/admin/users/:id", async (req, res) => {
  try {
    const { id } = req.params;

    const user = await MockExamUser.findByIdAndUpdate(
      id,
      { deleted: true, deletedAt: new Date() },
      { new: true }
    );

    if (!user) {
      return res.status(404).json({ ok: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, message: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/users/delete] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== ìƒë‹´ ì‹ ì²­ API =====
// ìƒë‹´ ì‹ ì²­ (ëœë”© í˜ì´ì§€ì—ì„œ í˜¸ì¶œ)
app.post("/api/mock-exam/consultation", async (req, res) => {
  try {
    const { school, grade, name, phone } = req.body;

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!school || !grade || !name || !phone) {
      return res.status(400).json({ ok: false, error: "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    const consultation = new MockExamConsultation({
      school,
      grade,
      name,
      phone,
      status: 'pending'
    });

    await consultation.save();
    console.log(`âœ… [ìƒë‹´ì‹ ì²­] ${name} (${school} ${grade}) - ${phone}`);

    res.json({ ok: true, message: "ìƒë‹´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/consultation] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ìƒë‹´ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìƒë‹´ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ì)
app.get("/api/mock-exam/admin/consultations", async (req, res) => {
  try {
    const consultations = await MockExamConsultation.find()
      .sort({ createdAt: -1 });
    res.json({ ok: true, consultations });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/consultations] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìƒë‹´ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì)
app.put("/api/mock-exam/admin/consultations/:id/status", async (req, res) => {
  try {
    const { id } = req.params;
    const { status } = req.body;

    if (!['pending', 'contacted', 'completed'].includes(status)) {
      return res.status(400).json({ ok: false, error: "ì˜ëª»ëœ ìƒíƒœê°’ì…ë‹ˆë‹¤." });
    }

    const consultation = await MockExamConsultation.findByIdAndUpdate(
      id,
      { status },
      { new: true }
    );

    if (!consultation) {
      return res.status(404).json({ ok: false, error: "ìƒë‹´ ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, consultation });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/consultations/status] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// 12+ ìƒì„¸ ì„¸ë¶€ ì§€í‘œ AI í”¼ë“œë°± API
app.post("/api/openai/detail-feedback", async (req, res) => {
  try {
    const { scores, scoreText } = req.body;

    if (!scores) {
      return res.status(400).json({ ok: false, error: "ì ìˆ˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const prompt = `ë‹¹ì‹ ì€ ìˆ˜ëŠ¥ êµ­ì–´ ì „ë¬¸ ê°•ì‚¬ì…ë‹ˆë‹¤. í•™ìƒì˜ 12ê°œ ì„¸ë¶€ ì˜ì—­ ì„±ì ì„ ë¶„ì„í•˜ì—¬ ê°•ì ê³¼ ë³´ì™„ì ì„ ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ í”¼ë“œë°±í•´ì£¼ì„¸ìš”.

${scoreText}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "strength": "ê°•ì  ë¶„ì„ (80% ì´ìƒ ì˜ì—­ ì¤‘ì‹¬ìœ¼ë¡œ, ì˜í•˜ëŠ” ì˜ì—­ê³¼ ì™œ ì˜í•˜ëŠ”ì§€ ì¹­ì°¬. 2-3ë¬¸ì¥)",
  "weakness": "ë³´ì™„ì  ë¶„ì„ (60% ë¯¸ë§Œ ì˜ì—­ ì¤‘ì‹¬ìœ¼ë¡œ, êµ¬ì²´ì ì¸ í•™ìŠµ íŒ ì œê³µ. 2-3ë¬¸ì¥)"
}

ì‘ë‹µ ê°€ì´ë“œ:
1. ì¹œê·¼í•œ ë§íˆ¬ ì‚¬ìš© (~í•´ìš”, ~ì˜ˆìš”, ~ê±°ì˜ˆìš”)
2. êµ¬ì²´ì ì¸ ì˜ì—­ëª… ì–¸ê¸‰
3. ê²©ë ¤ì™€ ì¹­ì°¬ í¬í•¨
4. ì‹¤ì§ˆì ì¸ í•™ìŠµ ì¡°ì–¸ ì œê³µ
5. ë§Œì•½ ëª¨ë“  ì˜ì—­ì´ 80% ì´ìƒì´ë©´ ê°•ì ì—ì„œ ì¹­ì°¬í•˜ê³ , ë³´ì™„ì ì—ì„œëŠ” ë” ì™„ë²½í•´ì§€ê¸° ìœ„í•œ íŒ ì œê³µ
6. ë§Œì•½ ëª¨ë“  ì˜ì—­ì´ 60% ë¯¸ë§Œì´ë©´ ë³´ì™„ì ì—ì„œ ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì ‘ê·¼í•˜ëŠ” ë°©ë²• ì•ˆë‚´, ê°•ì ì—ì„œëŠ” ì¡°ê¸ˆì´ë¼ë„ ë†’ì€ ì˜ì—­ ì¹­ì°¬`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "ë‹¹ì‹ ì€ í•™ìƒë“¤ì„ ì§„ì‹¬ìœ¼ë¡œ ì‘ì›í•˜ëŠ” ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ êµ­ì–´ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”." },
        { role: "user", content: prompt }
      ],
      response_format: { type: "json_object" },
      temperature: 0.7,
      max_tokens: 500
    });

    const responseText = completion.choices[0].message.content.trim();
    let feedbackData;

    try {
      feedbackData = JSON.parse(responseText);
    } catch (parseError) {
      console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", parseError);
      // ê¸°ë³¸ ì‘ë‹µ
      feedbackData = {
        strength: "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        weakness: "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
      };
    }

    res.json({
      ok: true,
      strength: feedbackData.strength || "ê°•ì  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
      weakness: feedbackData.weakness || "ë³´ì™„ì  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    });

  } catch (err) {
    console.error("âŒ [/api/openai/detail-feedback] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "AI í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ë¬¸í•´ë ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ AI í”¼ë“œë°± ìƒì„± API
app.post("/api/literacy-test/ai-feedback", async (req, res) => {
  try {
    const { studentName, studentGrade, skillPercentages, categoryPercentages, gradeAverage, totalScore } = req.body;

    if (!skillPercentages || !categoryPercentages) {
      return res.status(400).json({ ok: false, error: "ì ìˆ˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    console.log(`ğŸ¤– [ë¬¸í•´ë ¥ AI í”¼ë“œë°±] ${studentGrade} ${studentName} - í”¼ë“œë°± ìƒì„± ìš”ì²­`);

    // ì´ë¦„ ì²˜ë¦¬: "ì´ìŠ¹ì°¬" -> "ìŠ¹ì°¬", "ê¹€ì² ìˆ˜" -> "ì² ìˆ˜" (ì„± ì œì™¸, ì´ë¦„ë§Œ ì‚¬ìš©)
    const friendlyName = studentName && studentName.length >= 2
      ? studentName.slice(-2) + ' í•™ìƒ'  // ë§ˆì§€ë§‰ 2ê¸€ì + í•™ìƒ
      : (studentName || 'í•™ìƒ') + ' í•™ìƒ';

    // ë¬¸í•´ë ¥ ì§€ìˆ˜ ë°ì´í„° ë¶„ì„
    const skills = ['í•µì‹¬ ì´í•´ë ¥', 'êµ¬ì¡° íŒŒì•…ë ¥', 'ì–´íœ˜ ë§¥ë½ë ¥', 'ì¶”ë¡  í†µí•©ë ¥', 'ë¹„íŒ ì ìš©ë ¥'];
    const categories = ['ì‚¬íšŒ', 'ê³¼í•™', 'ì¸ë¬¸', 'ê²½ì œ', 'ë²•'];

    // í•™ë…„ë³„ ì§€ìˆ˜ë³„ ì„¸ë¶€ í‰ê· 
    const gradeSkillAverages = {
      'ì´ˆ3-4': { 'í•µì‹¬ ì´í•´ë ¥': 53, 'êµ¬ì¡° íŒŒì•…ë ¥': 48, 'ì–´íœ˜ ë§¥ë½ë ¥': 70, 'ì¶”ë¡  í†µí•©ë ¥': 55, 'ë¹„íŒ ì ìš©ë ¥': 58 },
      'ì´ˆ5-6': { 'í•µì‹¬ ì´í•´ë ¥': 63, 'êµ¬ì¡° íŒŒì•…ë ¥': 58, 'ì–´íœ˜ ë§¥ë½ë ¥': 75, 'ì¶”ë¡  í†µí•©ë ¥': 65, 'ë¹„íŒ ì ìš©ë ¥': 68 },
      'ì¤‘1-2': { 'í•µì‹¬ ì´í•´ë ¥': 73, 'êµ¬ì¡° íŒŒì•…ë ¥': 68, 'ì–´íœ˜ ë§¥ë½ë ¥': 85, 'ì¶”ë¡  í†µí•©ë ¥': 75, 'ë¹„íŒ ì ìš©ë ¥': 78 },
      'ì¤‘3-ê³ 1': { 'í•µì‹¬ ì´í•´ë ¥': 73, 'êµ¬ì¡° íŒŒì•…ë ¥': 78, 'ì–´íœ˜ ë§¥ë½ë ¥': 85, 'ì¶”ë¡  í†µí•©ë ¥': 85, 'ë¹„íŒ ì ìš©ë ¥': 78 },
      'ê³ 2-3': { 'í•µì‹¬ ì´í•´ë ¥': 83, 'êµ¬ì¡° íŒŒì•…ë ¥': 88, 'ì–´íœ˜ ë§¥ë½ë ¥': 95, 'ì¶”ë¡  í†µí•©ë ¥': 85, 'ë¹„íŒ ì ìš©ë ¥': 88 }
    };

    // í•™ë…„ë³„ ê³¼ëª©ë³„ ì„¸ë¶€ í‰ê· 
    const gradeCategoryAverages = {
      'ì´ˆ3-4': { 'ì‚¬íšŒ': 60, 'ê³¼í•™': 48, 'ì¸ë¬¸': 55, 'ê²½ì œ': 48, 'ë²•': 53 },
      'ì´ˆ5-6': { 'ì‚¬íšŒ': 65, 'ê³¼í•™': 52, 'ì¸ë¬¸': 60, 'ê²½ì œ': 52, 'ë²•': 58 },
      'ì¤‘1-2': { 'ì‚¬íšŒ': 70, 'ê³¼í•™': 62, 'ì¸ë¬¸': 70, 'ê²½ì œ': 62, 'ë²•': 68 },
      'ì¤‘3-ê³ 1': { 'ì‚¬íšŒ': 80, 'ê³¼í•™': 72, 'ì¸ë¬¸': 80, 'ê²½ì œ': 72, 'ë²•': 78 },
      'ê³ 2-3': { 'ì‚¬íšŒ': 90, 'ê³¼í•™': 82, 'ì¸ë¬¸': 90, 'ê²½ì œ': 82, 'ë²•': 88 }
    };

    // í•™ë…„ ê·¸ë£¹ ê²°ì •
    const grade = (studentGrade || '').toLowerCase();
    let gradeGroup = 'ì´ˆ5-6'; // ê¸°ë³¸ê°’
    if (grade.includes('3') || grade.includes('4') || grade.includes('ì´ˆ3') || grade.includes('ì´ˆ4')) {
      gradeGroup = 'ì´ˆ3-4';
    } else if (grade.includes('5') || grade.includes('6') || grade.includes('ì´ˆ5') || grade.includes('ì´ˆ6')) {
      gradeGroup = 'ì´ˆ5-6';
    } else if (grade.includes('ì¤‘1') || grade.includes('ì¤‘2')) {
      gradeGroup = 'ì¤‘1-2';
    } else if (grade.includes('ì¤‘3') || grade.includes('ê³ 1')) {
      gradeGroup = 'ì¤‘3-ê³ 1';
    } else if (grade.includes('ê³ 2') || grade.includes('ê³ 3')) {
      gradeGroup = 'ê³ 2-3';
    }

    const skillAverages = gradeSkillAverages[gradeGroup];
    const categoryAverages = gradeCategoryAverages[gradeGroup];

    // ê°•ì /ì•½ì  ë¶„ì„ (ì§€ìˆ˜ë³„ ì„¸ë¶€ í‰ê·  ê¸°ì¤€)
    // skillPercentagesê°€ ê°ì²´ì¸ ê²½ìš°ì™€ ë°°ì—´ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
    const skillEntries = skills.map((name, i) => ({
      name,
      value: Array.isArray(skillPercentages) ? skillPercentages[i] : (skillPercentages[name] || 0),
      avg: skillAverages[name]
    }));
    const categoryEntries = categories.map((name, i) => ({
      name,
      value: Array.isArray(categoryPercentages) ? categoryPercentages[i] : (categoryPercentages[name] || 0),
      avg: categoryAverages[name]
    }));

    const sortedSkills = [...skillEntries].sort((a, b) => b.value - a.value);
    const sortedCategories = [...categoryEntries].sort((a, b) => b.value - a.value);

    // ê° ì§€ìˆ˜ë³„/ê³¼ëª©ë³„ í‰ê· ê³¼ ë¹„êµí•˜ì—¬ ê°•ì /ì•½ì  íŒë‹¨
    const strongSkills = skillEntries.filter(s => s.value >= s.avg);
    const weakSkills = skillEntries.filter(s => s.value < s.avg);
    const strongCategories = categoryEntries.filter(c => c.value >= c.avg);
    const weakCategories = categoryEntries.filter(c => c.value < c.avg);

    const prompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒê³¼ ì¤‘í•™ìƒì„ ìœ„í•œ ë¬¸í•´ë ¥ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
í•™ìƒì˜ ë¬¸í•´ë ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.

[í•™ìƒ ì •ë³´]
- ì´ë¦„: ${friendlyName}
- í•™ë…„: ${studentGrade} (${gradeGroup} ê·¸ë£¹)
- ì´ì : ${totalScore}/25ë¬¸ì œ

[ë¬¸í•´ë ¥ ì§€ìˆ˜ë³„ ì •ë‹µë¥  vs ${gradeGroup} í‰ê· ]
${skillEntries.map(s => `- ${s.name}: ${s.value}% (${gradeGroup} í‰ê·  ${s.avg}%) â†’ ${s.value >= s.avg ? `í‰ê· ë³´ë‹¤ ${s.value - s.avg}%p ë†’ìŒ âœ“` : `í‰ê· ë³´ë‹¤ ${s.avg - s.value}%p ë‚®ìŒ â–³`}`).join('\n')}

[ê³¼ëª©ë³„ ì •ë‹µë¥  vs ${gradeGroup} í‰ê· ]
${categoryEntries.map(c => `- ${c.name}: ${c.value}% (${gradeGroup} í‰ê·  ${c.avg}%) â†’ ${c.value >= c.avg ? `í‰ê· ë³´ë‹¤ ${c.value - c.avg}%p ë†’ìŒ âœ“` : `í‰ê· ë³´ë‹¤ ${c.avg - c.value}%p ë‚®ìŒ â–³`}`).join('\n')}

[ë¶„ì„ ê²°ê³¼ ìš”ì•½]
- í‰ê·  ì´ìƒ ë¬¸í•´ë ¥ ì§€ìˆ˜ (${strongSkills.length}ê°œ): ${strongSkills.length > 0 ? strongSkills.map(s => `${s.name}(${s.value}%, +${s.value - s.avg}%p)`).join(', ') : 'ì—†ìŒ'}
- í‰ê·  ë¯¸ë§Œ ë¬¸í•´ë ¥ ì§€ìˆ˜ (${weakSkills.length}ê°œ): ${weakSkills.length > 0 ? weakSkills.map(s => `${s.name}(${s.value}%, -${s.avg - s.value}%p)`).join(', ') : 'ì—†ìŒ'}
- í‰ê·  ì´ìƒ ê³¼ëª© (${strongCategories.length}ê°œ): ${strongCategories.length > 0 ? strongCategories.map(c => `${c.name}(${c.value}%, +${c.value - c.avg}%p)`).join(', ') : 'ì—†ìŒ'}
- í‰ê·  ë¯¸ë§Œ ê³¼ëª© (${weakCategories.length}ê°œ): ${weakCategories.length > 0 ? weakCategories.map(c => `${c.name}(${c.value}%, -${c.avg - c.value}%p)`).join(', ') : 'ì—†ìŒ'}

[ì‘ë‹µ í˜•ì‹ - ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ]
{
  "overall": "ì¢…í•© í‰ê°€ (3-4ë¬¸ì¥): ì´ì ê³¼ ì „ì²´ì ì¸ ìˆ˜ì¤€ì„ ì–¸ê¸‰í•˜ê³ , í‰ê·  ëŒ€ë¹„ ì˜í•œ ì§€ìˆ˜/ê³¼ëª© ìˆ˜ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬",
  "strengths": "ê°•ì  ë¶„ì„ (3-4ë¬¸ì¥): í‰ê·  ì´ìƒì¸ ì§€ìˆ˜ì™€ ê³¼ëª©ì„ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜(%)ì™€ í•¨ê»˜ ì–¸ê¸‰. ì˜ˆ: 'í•µì‹¬ ì´í•´ë ¥ì´ 80%ë¡œ í‰ê·  63%ë³´ë‹¤ 17%pë‚˜ ë†’ì•„ìš”!'",
  "improvements": "ì„±ì¥ í¬ì¸íŠ¸ (3-4ë¬¸ì¥): í‰ê·  ë¯¸ë§Œì¸ ì§€ìˆ˜ì™€ ê³¼ëª©ì„ ë¶€ë“œëŸ½ê²Œ ì–¸ê¸‰í•˜ê³  ê°œì„  ë°©ë²• ì œì•ˆ. ì˜ˆ: 'êµ¬ì¡° íŒŒì•…ë ¥ì€ 40%ë¡œ í‰ê·  58%ë³´ë‹¤ ì¡°ê¸ˆ ë‚®ì§€ë§Œ, ê¸€ì˜ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ëŠ” ì—°ìŠµì„ í•˜ë©´ ê¸ˆë°© ì˜¬ë¼ê°ˆ ê±°ì˜ˆìš”!'",
  "tips": "í•™ìŠµ TIP (3-4ë¬¸ì¥): êµ¬ì²´ì ì¸ í•™ìŠµ ë°©ë²• ì œì•ˆ + ë°˜ë“œì‹œ ë§ˆì§€ë§‰ì— 'AI ë¸Œë ˆì¸ ë¬¸í•´ë ¥'ì„ ì–¸ê¸‰í•˜ë©° ê¾¸ì¤€íˆ í•™ìŠµí•˜ë©´ ë¬¸í•´ë ¥ì´ í–¥ìƒëœë‹¤ëŠ” ê²©ë ¤ ë©”ì‹œì§€ í¬í•¨"
}

[ì¤‘ìš” ê·œì¹™]
1. ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜(%)ì™€ í‰ê·  ëŒ€ë¹„ ì°¨ì´(%p)ë¥¼ ì–¸ê¸‰í•´ì•¼ í•¨
2. í•™ìƒ ì´ë¦„(${friendlyName})ì„ ìì£¼ ë¶ˆëŸ¬ì£¼ë©° ì¹œê·¼í•˜ê²Œ ì‘ì„± (ì˜ˆ: "ìŠ¹ì°¬ í•™ìƒ")
3. ë°˜ë§ì²´ ì‚¬ìš© (~í•´ìš”, ~ì˜ˆìš”, ~ë„¤ìš”, ~ê±°ì˜ˆìš”)
4. ë¶€ì •ì  í‘œí˜„ ëŒ€ì‹  ê¸ì •ì  í‘œí˜„ ("ëª»í–ˆì–´" â†’ "ë” ì—°ìŠµí•˜ë©´ ì¢‹ê² ì–´", "ë¶€ì¡±í•´" â†’ "ì„±ì¥ ê°€ëŠ¥ì„±ì´ ìˆì–´")
5. ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš© (ë¬¸ì¥ë‹¹ 1ê°œ ì •ë„)
6. ëª¨ë“  ì ìˆ˜ê°€ ë‚®ì•„ë„ ê²©ë ¤ì™€ í¬ë§ì ì¸ ë©”ì‹œì§€ í¬í•¨
7. í‰ê·  ì´ìƒì¸ í•­ëª©ì´ ì—†ìœ¼ë©´ "í…ŒìŠ¤íŠ¸ì— ë„ì „í•œ ìš©ê¸°"ë¥¼ ì¹­ì°¬
8. tips ë§ˆì§€ë§‰ì— ë°˜ë“œì‹œ "AI ë¸Œë ˆì¸ ë¬¸í•´ë ¥ì„ ê¾¸ì¤€íˆ í•™ìŠµí•˜ë©´ ë¬¸í•´ë ¥ì´ ì‘¥ì‘¥ ìë„ ê±°ì˜ˆìš”!" ë˜ëŠ” ë¹„ìŠ·í•œ ë¬¸ì¥ í¬í•¨`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "ë‹¹ì‹ ì€ í•™ìƒë“¤ì„ ì§„ì‹¬ìœ¼ë¡œ ì‘ì›í•˜ëŠ” ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ë¬¸í•´ë ¥ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜(%)ì™€ í‰ê·  ëŒ€ë¹„ ì°¨ì´(%p)ë¥¼ ì–¸ê¸‰í•˜ì—¬ ë¶„ì„í•˜ì„¸ìš”. ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”." },
        { role: "user", content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 1200
    });

    const aiResponse = completion.choices[0].message.content;
    console.log("ğŸ¤– AI ì‘ë‹µ:", aiResponse.substring(0, 200));

    // JSON íŒŒì‹±
    let feedback;
    try {
      // JSON ë¸”ë¡ ì¶”ì¶œ
      const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        feedback = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error("JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");
      }
    } catch (parseError) {
      console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", parseError);
      // ê¸°ë³¸ í”¼ë“œë°± ì œê³µ
      feedback = {
        overall: `${friendlyName}, ë¬¸í•´ë ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí–ˆì–´ìš”! ì•ìœ¼ë¡œ ê¾¸ì¤€íˆ ì—°ìŠµí•˜ë©´ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì„ ê±°ì˜ˆìš” ğŸ’ª`,
        strengths: "í…ŒìŠ¤íŠ¸ì— ëê¹Œì§€ ì°¸ì—¬í•œ ê²ƒë§Œìœ¼ë¡œë„ ëŒ€ë‹¨í•´ìš”! ì´ëŸ° ë„ì „ ì •ì‹ ì´ ì•ìœ¼ë¡œ í° ì„±ì¥ì˜ ë°‘ê±°ë¦„ì´ ë  ê±°ì˜ˆìš” â­",
        improvements: "ì¡°ê¸ˆ ë” ì—°ìŠµì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ì°¨ê·¼ì°¨ê·¼ í•™ìŠµí•˜ë©´ ê¸ˆë°© ëŠ˜ ìˆ˜ ìˆì–´ìš” ğŸ“š",
        tips: "ë§¤ì¼ ì§§ì€ ê¸€ì´ë¼ë„ ì½ê³  ë‚´ìš©ì„ ì •ë¦¬í•˜ëŠ” ìŠµê´€ì„ ë“¤ì´ë©´ ë¬¸í•´ë ¥ì´ ì‘¥ì‘¥ ìë„ ê±°ì˜ˆìš”! í™”ì´íŒ… ğŸŒŸ"
      };
    }

    res.json({ ok: true, feedback });

  } catch (err) {
    console.error("âŒ [/api/literacy-test/ai-feedback] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "AI í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìƒë‹´ ì‹ ì²­ ì‚­ì œ (ê´€ë¦¬ì)
app.delete("/api/mock-exam/admin/consultations/:id", async (req, res) => {
  try {
    const { id } = req.params;

    const consultation = await MockExamConsultation.findByIdAndDelete(id);

    if (!consultation) {
      return res.status(404).json({ ok: false, error: "ìƒë‹´ ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({ ok: true, message: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    console.error("âŒ [/api/mock-exam/admin/consultations/delete] ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== AI í•™ìŠµ í”¼ë“œë°± ìƒì„± API =====
app.post("/api/ai-learning-feedback", async (req, res) => {
  try {
    const { grade, name, section, data } = req.body;

    if (!grade || !name || !section || !data) {
      return res.status(400).json({ error: "í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }

    console.log(`ğŸ¤– [AI í”¼ë“œë°±] ${grade} ${name} - ${section} ì„¹ì…˜ í”¼ë“œë°± ìƒì„± ìš”ì²­`);

    // ì„¹ì…˜ë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
    // ì´ë¦„ì—ì„œ ì„±ì„ ì œê±°í•˜ê³  ì´ë¦„ë§Œ ì¶”ì¶œ (ì˜ˆ: "ì•ˆìœ ë¹ˆ" -> "ìœ ë¹ˆ", "ê¹€ì² ìˆ˜" -> "ì² ìˆ˜")
    const friendlyName = name && name.length >= 2 ? name.slice(1) : name;

    let systemPrompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒê³¼ ì¤‘í•™ìƒì„ ìœ„í•œ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” êµìœ¡ í”¼ë“œë°± ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
í•™ìƒì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì¹œê·¼í•˜ê³  ê¸ì •ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.

[í•„ìˆ˜ ê·œì¹™]
- ë°˜ë§ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼í•˜ê²Œ ë§í•©ë‹ˆë‹¤
- í•™ìƒ ì´ë¦„ì„ ë¶€ë¥¼ ë•ŒëŠ” ì„±ì„ ë¹¼ê³  ì´ë¦„ë§Œ ë¶€ë¥´ë©°, ë°›ì¹¨ ìœ ë¬´ì— ë”°ë¼ "~ì•„" ë˜ëŠ” "~ì•¼"ë¥¼ ë¶™ì…ë‹ˆë‹¤
  ì˜ˆì‹œ: "ë‚˜ë„í•´" â†’ "ë„í•´ì•¼", "ì•ˆìœ ë¹ˆ" â†’ "ìœ ë¹ˆì•„", "ê¹€ì² ìˆ˜" â†’ "ì² ìˆ˜ì•¼"
- âš ï¸ ì ˆëŒ€ ê¸ˆì§€: "ë‚˜ë„ì•¼", "ë‚˜ë„í•´ì•¼", "ìœ ë¹ˆì´ì•¼" ê°™ì´ ì„±ì„ í¬í•¨í•˜ê±°ë‚˜ ì´ìƒí•œ í˜•íƒœë¡œ ë¶€ë¥´ì§€ ë§ˆì„¸ìš”
- ì´ëª¨ì§€ë¥¼ ë¬¸ì¥ ì¤‘ê°„ì´ë‚˜ ëì— ì ì ˆíˆ 1-2ê°œ ì‚¬ìš©í•©ë‹ˆë‹¤
- ì•ìœ¼ë¡œì˜ ì„±ì¥ ê°€ëŠ¥ì„±ì„ ì–¸ê¸‰í•©ë‹ˆë‹¤

[ì¤‘ìš”: ë“±ê¸‰ë³„ í”¼ë“œë°± í†¤ ì¡°ì ˆ]
ë“±ê¸‰ì€ ì ìˆ˜ì— ë”°ë¼ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¥˜ë©ë‹ˆë‹¤:
- "íƒì›”" (10ì ): ìµœê³  ë“±ê¸‰! ì •ë§ ëŒ€ë‹¨í•˜ë‹¤ê³  ì¹­ì°¬í•´ì£¼ì„¸ìš”.
- "ìš°ìˆ˜" (9ì ): ë§¤ìš° ì˜í–ˆë‹¤ê³  ì¹­ì°¬í•´ì£¼ì„¸ìš”.
- "ì–‘í˜¸" (8ì ): ì˜í•˜ê³  ìˆë‹¤ê³  ì¹­ì°¬í•˜ê³ , ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ìš°ìˆ˜í•´ì§ˆ ìˆ˜ ìˆë‹¤ê³  ê²©ë ¤í•´ì£¼ì„¸ìš”.
- "ë³´í†µ" (7ì ): ê´œì°®ì€ ìˆ˜ì¤€ì´ì§€ë§Œ, ë” ì˜í•  ìˆ˜ ìˆë‹¤ê³  ì‘ì›í•´ì£¼ì„¸ìš”.
- "ê²©ë ¤" (6ì ): ê°€ì¥ ë‚®ì€ ë“±ê¸‰ì…ë‹ˆë‹¤. "ì˜í–ˆë‹¤"ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš”! ëŒ€ì‹  "í˜ë“¤ì—ˆì„ í…ë° ëê¹Œì§€ í’€ì–´ë³¸ ê²ƒë§Œìœ¼ë¡œë„ ëŒ€ê²¬í•´", "ë‹¤ìŒì—” ë” ì˜í•  ìˆ˜ ìˆì„ ê±°ì•¼", "í¬ê¸°í•˜ì§€ ì•Šê³  ë„ì „í•œ ê²Œ ì¤‘ìš”í•´"ì²˜ëŸ¼ ì§„ì‹¬ìœ¼ë¡œ ê²©ë ¤í•´ì£¼ì„¸ìš”. ë¶€ì¡±í•œ ì ì„ ì¸ì •í•˜ë˜ ë”°ëœ»í•˜ê²Œ ì‘ì›í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

[ì¤‘ìš”: ë°˜ë“œì‹œ 5ì¤„ë¡œ ì‘ì„±]
í”¼ë“œë°±ì€ ë°˜ë“œì‹œ 5ì¤„(5ë¬¸ì¥)ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
ê° ì¤„ì€ ì¤„ë°”ê¿ˆ(\\n)ìœ¼ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.
ì˜ˆì‹œ:
1ì¤„: í•™ìŠµì— ëŒ€í•œ ì´í‰ (ë“±ê¸‰ì— ë§ê²Œ)
2ì¤„: êµ¬ì²´ì ì¸ ì„±ê³¼ ë˜ëŠ” ë…¸ë ¥ ì–¸ê¸‰
3ì¤„: ì˜í•œ ì  ë˜ëŠ” ê°œì„  ê°€ëŠ¥í•œ ì 
4ì¤„: ê²©ë ¤ì™€ ì‘ì›
5ì¤„: ì•ìœ¼ë¡œì˜ ê¸°ëŒ€`;

    let userPrompt = "";

    switch (section) {
      case "today_summary":
        const periodText1 = data.isWeeklyMode ? `ì´ë²ˆ ì£¼ (${data.weekDateRange || ''})` : 'ì˜¤ëŠ˜';
        const sectionText1 = data.isWeeklyMode ? 'ì£¼ê°„ ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡' : 'ì˜¤ëŠ˜ ë‚˜ì˜ AI í•™ìŠµ ê¸°ë¡';
        userPrompt = `ë‹¤ìŒì€ ${grade} ${name} í•™ìƒì˜ ${periodText1} í•™ìŠµ ê¸°ë¡ì…ë‹ˆë‹¤.

í•™ìŠµ ë°ì´í„°:
- ì´ í•™ìŠµ ê±´ìˆ˜: ${data.completedCount || 0}ê±´
- ì™„ë£Œí•œ ë‹¨ì›: ${data.unitList || "ì—†ìŒ"}
- ë“±ê¸‰ ë¶„í¬: ${data.gradesSummary || "ì—†ìŒ"}
- í•™ìŠµ ì˜ì—­: ${data.fieldsSummary || "ì—†ìŒ"}
- í‰ê·  ì ìˆ˜: ${data.avgScore || "ì¸¡ì • ì¤‘"}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ "${sectionText1}" ì„¹ì…˜ì— ëŒ€í•œ ë”°ëœ»í•œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
í•™ìƒì´ ${periodText1} ì—´ì‹¬íˆ ê³µë¶€í•œ ê²ƒì„ ì¹­ì°¬í•˜ê³ , êµ¬ì²´ì ì¸ ë‹¨ì›ëª…ì´ë‚˜ ì„±ê³¼ë¥¼ ì–¸ê¸‰í•˜ë©° ê²©ë ¤í•´ì£¼ì„¸ìš”.
${data.completedCount > 0 ? `íŠ¹íˆ "${data.units?.[0] || ''}"ê³¼ ê°™ì€ ë‹¨ì›ì„ ì™„ë£Œí•œ ì ì„ ì¹­ì°¬í•´ì£¼ì„¸ìš”.` : ''}`;
        break;

      case "radar_chart":
        if (!data.hasData) {
          return res.json({ ok: true, feedback: "ì•„ì§ ë¬¸í•´ë ¥ ë ˆì´ë” ë¶„ì„ ê¸°ë¡ì´ ì—†ì–´ìš”. í•™ìŠµì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì—ì„œ 5ê°€ì§€ ë¬¸í•´ë ¥ ì˜ì—­ë³„ ë¶„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆì„ ê±°ì•¼! í™”ì´íŒ…!" });
        }
        const periodText2 = data.isWeeklyMode ? `ì´ë²ˆ ì£¼ (${data.weekDateRange || ''})` : 'ì˜¤ëŠ˜';
        const sectionText2 = data.isWeeklyMode ? 'ì£¼ê°„ ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”' : 'ì˜¤ëŠ˜ ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë”';
        userPrompt = `ë‹¤ìŒì€ ${grade} ${name} í•™ìƒì˜ ${periodText2} ì™„ë£Œí•œ ë‹¨ì›ë³„ ë¬¸í•´ë ¥ AI ë ˆì´ë” ë°ì´í„°ì…ë‹ˆë‹¤.

ë ˆì´ë” ë°ì´í„°:
- ì™„ë£Œí•œ ë‹¨ì› ìˆ˜: ${data.chartCount || 0}ê°œ
- ë¬¸í•´ë ¥ ì˜ì—­ë³„ í‰ê·  ì ìˆ˜:
  * ì‚¬ì‹¤ì  ì´í•´: ${data.avgLiteral || "-"}ì 
  * êµ¬ì¡°ì  ì´í•´: ${data.avgStructural || "-"}ì 
  * ì–´íœ˜ë ¥: ${data.avgLexical || "-"}ì 
  * ì¶”ë¡ ì  ì´í•´: ${data.avgInferential || "-"}ì 
  * ë¹„íŒì  ì´í•´: ${data.avgCritical || "-"}ì 
- ê°€ì¥ ê°•í•œ ì˜ì—­: ${data.strongestArea || "-"}
- ë³´ì™„ì´ í•„ìš”í•œ ì˜ì—­: ${data.weakestArea || "-"}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ "${sectionText2}" ì„¹ì…˜ì— ëŒ€í•œ ë”°ëœ»í•œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
ê°•í•œ ì˜ì—­ì„ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•˜ê³ , ë³´ì™„ì´ í•„ìš”í•œ ì˜ì—­ì€ ì„±ì¥ ê°€ëŠ¥ì„±ìœ¼ë¡œ ì–¸ê¸‰í•´ì£¼ì„¸ìš”.`;
        break;

      case "growth_trend":
        if (!data.hasData) {
          return res.json({ ok: true, feedback: "ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ì–´ì„œ ì„±ì¥ ì§€ìˆ˜ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ì–´ìš”. í•™ìŠµì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì—ì„œ ì„±ì¥ ê·¸ë˜í”„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì„ ê±°ì•¼! í™”ì´íŒ…!" });
        }
        const sectionText3 = data.isWeeklyMode ? 'ì£¼ê°„ ë¬¸í•´ë ¥ ì„±ì¥ ì§€ìˆ˜ ë³€í™”' : 'ë‚ ì§œë³„ ë¬¸í•´ë ¥ ì„±ì¥ ì§€ìˆ˜ ë³€í™”';

        userPrompt = `ë‹¤ìŒì€ ${grade} ${name} í•™ìƒì˜ ${sectionText3} ë°ì´í„°ì…ë‹ˆë‹¤.

5ê°€ì§€ ë¬¸í•´ë ¥ ì§€ìˆ˜:
${data.indexList || 'ë°ì´í„° ì—†ìŒ'}
- ê°€ì¥ ê°•í•œ ì§€ìˆ˜: ${data.strongestIndex || '-'}
- ë³´ì™„ì´ í•„ìš”í•œ ì§€ìˆ˜: ${data.weakestIndex || '-'}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ "${sectionText3}" ì„¹ì…˜ì— ëŒ€í•œ ë”°ëœ»í•œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

âš ï¸ ì‘ì„± ê·œì¹™:
1. "ì˜¤ëŠ˜ì€ ì¡°ê¸ˆ í˜ë“¤ì—ˆë‚˜ ë³´ë„¤", "ë…¸ë ¥í•œ ê²ƒ ìì²´ê°€ ëŒ€ë‹¨í•´" ê°™ì€ ì¼ë°˜ì ì¸ ìœ„ë¡œ ë©˜íŠ¸ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
2. ê°€ì¥ ë†’ì€ ë¬¸í•´ë ¥ ì§€ìˆ˜(${data.strongestIndex || '-'})ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•´ì£¼ì„¸ìš”. ì˜ˆ: "í•µì‹¬ ì´í•´ë ¥ 10ì , ì •ë§ ëŒ€ë‹¨í•´!"
3. ìƒëŒ€ì ìœ¼ë¡œ ë‚®ì€ ì§€ìˆ˜(${data.weakestIndex || '-'})ëŠ” ì„±ì¥ ê°€ëŠ¥ì„±ìœ¼ë¡œ ê²©ë ¤í•´ì£¼ì„¸ìš”. ì˜ˆ: "ì–´íœ˜ ë§¥ë½ë ¥ì€ ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ê¸ˆë°© ì˜¬ë¼ê°ˆ ê±°ì•¼!"
4. êµ¬ì²´ì ì¸ ì§€ìˆ˜ ì´ë¦„ê³¼ ì ìˆ˜ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.
5. ê¾¸ì¤€íˆ í•™ìŠµí•˜ë©´ ëª¨ë“  ì§€ìˆ˜ê°€ ê· í˜• ìˆê²Œ ì„±ì¥í•  ìˆ˜ ìˆë‹¤ëŠ” ë©”ì‹œì§€ë¡œ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”.`;
        break;

      case "subject_scores":
        if (!data.hasData) {
          return res.json({ ok: true, feedback: "ì•„ì§ ê³¼ëª©ë³„ ì ìˆ˜ ê¸°ë¡ì´ ì—†ì–´ìš”. í•™ìŠµì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì—ì„œ ê³¼ëª©ë³„ ë¶„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆì„ ê±°ì•¼! í™”ì´íŒ…!" });
        }
        const sectionText4 = data.isWeeklyMode ? 'ì£¼ê°„ ê³¼ëª© í‰ê·  í‰ì ' : 'ë‚ ì§œë³„ ê³¼ëª© í‰ê·  í‰ì ';

        userPrompt = `ë‹¤ìŒì€ ${grade} ${name} í•™ìƒì˜ ${sectionText4} ë°ì´í„°ì…ë‹ˆë‹¤.

ê³¼ëª©ë³„ í‰ê·  í‰ì :
${data.subjectList || 'ë°ì´í„° ì—†ìŒ'}
- ê°€ì¥ ê°•í•œ ê³¼ëª©: ${data.strongSubject || '-'}
- ë³´ì™„ì´ í•„ìš”í•œ ê³¼ëª©: ${data.weakSubject || '-'}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ "${sectionText4}" ì„¹ì…˜ì— ëŒ€í•œ ë”°ëœ»í•œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

âš ï¸ ì‘ì„± ê·œì¹™:
1. "ì˜¤ëŠ˜ì€ ì¡°ê¸ˆ í˜ë“¤ì—ˆë‚˜ ë³´ë„¤", "ë…¸ë ¥í•œ ê²ƒ ìì²´ê°€ ëŒ€ë‹¨í•´", "ì ìˆ˜ë¥¼ ë°›ì•˜ì§€ë§Œ ì´ë ‡ê²Œ ë…¸ë ¥í•œ ê²ƒ ìì²´ê°€ ëŒ€ë‹¨í•´" ê°™ì€ ì¼ë°˜ì ì¸ ìœ„ë¡œ ë©˜íŠ¸ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
2. ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ê³¼ëª©(${data.strongSubject || '-'})ì„ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•´ì£¼ì„¸ìš”. ì˜ˆ: "ìƒë¬¼ 10ì , ì •ë§ ëŒ€ë‹¨í•´! ê³¼í•™ì  ì‚¬ê³ ë ¥ì´ ë›°ì–´ë‚˜ë„¤!"
3. ìƒëŒ€ì ìœ¼ë¡œ ë‚®ì€ ê³¼ëª©(${data.weakSubject || '-'})ì€ ì„±ì¥ ê°€ëŠ¥ì„±ìœ¼ë¡œ ê²©ë ¤í•´ì£¼ì„¸ìš”. ì˜ˆ: "í˜„ëŒ€ì†Œì„¤ì€ ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ê¸ˆë°© ì˜¬ë¼ê°ˆ ê±°ì•¼!"
4. êµ¬ì²´ì ì¸ ê³¼ëª©ëª…ê³¼ ì ìˆ˜ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.
5. ë‹¤ì–‘í•œ ê³¼ëª©ì„ í•™ìŠµí•˜ë©´ì„œ ê· í˜• ì¡íŒ ì‹¤ë ¥ì„ í‚¤ì›Œê°€ê³  ìˆë‹¤ëŠ” ë©”ì‹œì§€ë¡œ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”.`;
        break;

      case "vocab_scores":
        if (!data.hasData) {
          return res.json({ ok: true, feedback: "ì•„ì§ ì–´íœ˜ í€´ì¦ˆ ì ìˆ˜ ê¸°ë¡ì´ ì—†ì–´ìš”. ë³¸ë¬¸ í•™ìŠµ í›„ ì–´íœ˜ í€´ì¦ˆë¥¼ í’€ì–´ë³´ë©´ ì—¬ê¸°ì— ë¶„ì„ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚  ê±°ì˜ˆìš”! í™”ì´íŒ…!" });
        }
        const periodText5 = data.isWeeklyMode ? `ì´ë²ˆ ì£¼ (${data.weekDateRange || ''})` : 'ì „ì²´';
        const sectionText5 = data.isWeeklyMode ? 'ì£¼ê°„ ì–´íœ˜ ì ìˆ˜ ë¶„ì„' : 'ì–´íœ˜ ì ìˆ˜ ë¶„ì„';
        userPrompt = `ë‹¤ìŒì€ ${grade} ${name} í•™ìƒì˜ ${periodText5} ì–´íœ˜ í€´ì¦ˆ ì ìˆ˜ ë°ì´í„°ì…ë‹ˆë‹¤.

ì–´íœ˜ ì ìˆ˜ í˜„í™©:
- ì´ ì–´íœ˜ í€´ì¦ˆ ê°œìˆ˜: ${data.summary?.totalCount || 0}ê°œ
- ì „ì²´ í‰ê·  ì ìˆ˜: ${data.summary?.avgScore || 0}ì 
- ê³¼ëª©ë³„ í‰ê·  ì´ìƒì¸ ë‹¨ì› ìˆ˜: ${data.summary?.aboveAvgCount || 0}ê°œ
- ê³¼ëª©ë³„ í‰ê·  ë¯¸ë§Œì¸ ë‹¨ì› ìˆ˜: ${data.summary?.belowAvgCount || 0}ê°œ
- í‰ê·  ì´ìƒ ë¹„ìœ¨: ${data.summary?.aboveAvgPercent || 0}%
- ë‹¨ì›ë³„ ì ìˆ˜: ${data.summary?.itemsList || "ì—†ìŒ"}

ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ "${sectionText5}" ì„¹ì…˜ì— ëŒ€í•œ ë”°ëœ»í•œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
${data.summary?.aboveAvgPercent >= 70 ? 'í‰ê·  ì´ìƒì¸ ë‹¨ì›ì´ ë§ìœ¼ë‹ˆ ì–´íœ˜ë ¥ì´ ë›°ì–´ë‚˜ë‹¤ê³  ì¹­ì°¬í•´ì£¼ì„¸ìš”!' :
  data.summary?.aboveAvgPercent >= 50 ? 'ê· í˜• ì¡íŒ ì–´íœ˜ ì‹¤ë ¥ì„ ì¹­ì°¬í•˜ê³ , ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆë‹¤ê³  ê²©ë ¤í•´ì£¼ì„¸ìš”.' :
  'ì–´íœ˜ í•™ìŠµì˜ ì¤‘ìš”ì„±ì„ ì–¸ê¸‰í•˜ë©°, ê¾¸ì¤€íˆ í•™ìŠµí•˜ë©´ ë¹ ë¥´ê²Œ ì„±ì¥í•  ìˆ˜ ìˆë‹¤ê³  ì‘ì›í•´ì£¼ì„¸ìš”.'}
êµ¬ì²´ì ì¸ ë‹¨ì›ëª…ê³¼ ì ìˆ˜ë¥¼ ì–¸ê¸‰í•˜ë©° í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.`;
        break;

      default:
        return res.status(400).json({ error: "ì•Œ ìˆ˜ ì—†ëŠ” ì„¹ì…˜ì…ë‹ˆë‹¤." });
    }

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt }
      ],
      max_tokens: 500,
      temperature: 0.8
    });

    let feedback = completion.choices[0].message.content;
    // ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í†µì¼ê° ìˆê²Œ í‘œì‹œ
    feedback = feedback.replace(/\n/g, ' ');

    // ì˜ëª»ëœ í˜¸ì¹­ ìˆ˜ì •: "ë‚˜ë„í•´ì•¼" -> "ë„í•´ì•¼", "ë‚˜ë„í•´ì•„" -> "ë„í•´ì•„" ë“±
    // í’€ë„¤ì„+ì•¼/ì•„ íŒ¨í„´ì„ ì´ë¦„ë§Œ+ì•¼/ì•„ë¡œ êµì²´
    if (name && name.length >= 2) {
      const fullNameWithYa = name + 'ì•¼';
      const fullNameWithA = name + 'ì•„';
      const friendlyNameOnly = name.slice(1);
      // ë°›ì¹¨ ìœ ë¬´ íŒë‹¨
      const lastChar = friendlyNameOnly.charAt(friendlyNameOnly.length - 1);
      const lastCharCode = lastChar.charCodeAt(0);
      const hasBatchim = (lastCharCode - 0xAC00) % 28 !== 0;
      const correctSuffix = hasBatchim ? 'ì•„' : 'ì•¼';
      const correctName = friendlyNameOnly + correctSuffix;

      feedback = feedback.replace(new RegExp(fullNameWithYa, 'g'), correctName);
      feedback = feedback.replace(new RegExp(fullNameWithA, 'g'), correctName);
    }

    console.log(`âœ… [AI í”¼ë“œë°±] ${section} í”¼ë“œë°± ìƒì„± ì™„ë£Œ`);

    res.json({ ok: true, feedback });
  } catch (err) {
    console.error("âŒ [AI í”¼ë“œë°±] ì˜¤ë¥˜:", err);
    res.status(500).json({ error: "í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ===== ì„œë²„ ì‹œì‘ =====
mongoose
  .connect(MONGO_URI, {
    minPoolSize: 5,                    // ìµœì†Œ 5ê°œ ì—°ê²° ìœ ì§€ (Cold Start ë°©ì§€)
    maxPoolSize: 50,                   // ìµœëŒ€ 50ê°œ ì—°ê²°
    serverSelectionTimeoutMS: 5000,    // ì„œë²„ ì„ íƒ íƒ€ì„ì•„ì›ƒ 5ì´ˆ
    socketTimeoutMS: 45000,            // ì†Œì¼“ íƒ€ì„ì•„ì›ƒ 45ì´ˆ
  })
  .then(async () => {
    console.log("âœ… MongoDB Atlas ì—°ê²° ì„±ê³µ");

    // ì¸ë±ìŠ¤ ë™ê¸°í™” (ì„±ëŠ¥ ìµœì í™”)
    try {
      await LearningLog.syncIndexes();
      console.log("âœ… LearningLog ì¸ë±ìŠ¤ ë™ê¸°í™” ì™„ë£Œ");
    } catch (indexErr) {
      console.error("âš ï¸ ì¸ë±ìŠ¤ ë™ê¸°í™” ì˜¤ë¥˜:", indexErr.message);
    }

    app.listen(PORT, () => {
      console.log(`âœ… ì„œë²„ ì‹¤í–‰ ì¤‘: ${PORT}`);
    });

// ============================================
// ğŸ“¢ í™œë™ í”¼ë“œ API (ë¡¤ë§ ë°°ë„ˆìš©)
// ============================================
app.get("/api/activity-feed", async (req, res) => {
  try {
    const feeds = [];

    // 1. GatePassì—ì„œ í˜•ì„±í‰ê°€ ê´€ë¬¸ í†µê³¼ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (í•™ìƒë³„ ìµœì‹  1ê±´ë§Œ)
    const GatePassModel = mongoose.model("GatePass");
    const recentGatePasses = await GatePassModel.aggregate([
      { $sort: { passedAt: -1 } },
      { $group: {
        _id: { grade: '$grade', name: '$name' },
        latestPass: { $first: '$$ROOT' }
      }},
      { $replaceRoot: { newRoot: '$latestPass' } },
      { $sort: { passedAt: -1 } }
    ]);

    recentGatePasses.forEach(gp => {
      // ì´ë¦„ ë§ˆìŠ¤í‚¹ (ì˜ˆ: ê¹€ë¯¼ìˆ˜ â†’ ê¹€â—‹ìˆ˜)
      const maskedName = gp.name ?
        gp.name.charAt(0) + 'â—‹' + gp.name.slice(-1) : 'í•™ìƒ';

      // ê´€ë¬¸ ë²ˆí˜¸ í‘œì‹œ (ì˜ˆ: 20ê´€ë¬¸)
      const gateNum = gp.gate ? String(gp.gate).padStart(2, '0') : '01';
      const gateText = `${gateNum}ê´€ë¬¸ `;

      feeds.push({
        type: 'learning',
        icon: 'ğŸ‰',
        message: `${gp.grade} ${maskedName} í•™ìƒì´ ${gp.series || 'BRAINì˜¨'} ${gateText}í˜•ì„±í‰ê°€ë¥¼ í†µê³¼í•˜ì˜€ìŠµë‹ˆë‹¤!`,
        series: gp.series || '',
        timestamp: gp.passedAt
      });
    });

    // 2. ìµœê·¼ ì–´íœ˜í€´ì¦ˆ ì½”ì¸ íšë“ ê¸°ë¡ (ë¬´ì œí•œ) - ì‚­ì œëœ í•™ìƒ ì œì™¸
    const recentCoins = await UserProgress.find({
      'vocabularyQuiz.totalCoins': { $gt: 0 },
      deleted: { $ne: true }
    })
    .sort({ 'vocabularyQuiz.lastRankUpdate': -1 })
    .lean();

    recentCoins.forEach(user => {
      const maskedName = user.name ?
        user.name.charAt(0) + 'â—‹' + user.name.slice(-1) : 'í•™ìƒ';
      const coins = user.vocabularyQuiz?.totalCoins || 0;

      if (coins > 0) {
        feeds.push({
          type: 'coin',
          icon: 'ğŸ³',
          message: `${user.grade} ${maskedName} í•™ìƒì´ ê³ ë˜ ë±ƒì§€ ${coins}ê°œë¥¼ íšë“í•˜ì˜€ìŠµë‹ˆë‹¤!`,
          timestamp: user.vocabularyQuiz?.lastRankUpdate || new Date()
        });
      }
    });

    // ì‹œê°„ìˆœ ì •ë ¬ (ë¬´ì œí•œ)
    feeds.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    res.json({ success: true, feeds });
  } catch (err) {
    console.error("í™œë™ í”¼ë“œ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ============================================
// ğŸ‰ í˜•ì„±í‰ê°€ í†µê³¼ í•™ìƒ ê´€ë¦¬ API (ê´€ë¦¬ììš©)
// ============================================

// í˜•ì„±í‰ê°€ í†µê³¼ í•™ìƒ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ììš© - ìµœê·¼ 32ê°œ)
app.get("/api/learning-log/admin/list", async (req, res) => {
  try {
    // ëª¨ë“  í†µê³¼ ê¸°ë¡ ì¡°íšŒ
    const allLogs = await LearningLog.find({
      completed: true,
      deleted: { $ne: true }
    })
    .sort({ timestamp: -1 })
    .lean();

    // í•™ìƒë³„ë¡œ ìµœì¢…(ê°€ì¥ ë†’ì€) í†µê³¼ ê´€ë¬¸ë§Œ ì¶”ì¶œ
    const studentMaxGate = {};

    allLogs.forEach(log => {
      const key = `${log.grade}_${log.name}`;

      // unitì—ì„œ ê´€ë¬¸ ë²ˆí˜¸ ì¶”ì¶œ (ë§ˆì§€ë§‰ ìˆ«ì)
      const gateMatch = (log.unit || '').match(/(\d+)$/);
      const gateNum = gateMatch ? parseInt(gateMatch[1], 10) : 0;

      // í•´ë‹¹ í•™ìƒì˜ ê¸°ì¡´ ìµœê³  ê´€ë¬¸ë³´ë‹¤ ë†’ìœ¼ë©´ êµì²´
      if (!studentMaxGate[key] || gateNum > studentMaxGate[key].gateNum) {
        studentMaxGate[key] = {
          ...log,
          _id: log._id.toString(), // _idë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
          gateNum
        };
      }
    });

    // Objectì—ì„œ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ìµœê·¼ ì—…ë°ì´íŠ¸ ìˆœìœ¼ë¡œ ì •ë ¬, 32ëª… ì œí•œ
    let logs = Object.values(studentMaxGate)
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      .slice(0, 32);

    // User ëª¨ë¸ì—ì„œ í•™êµ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê³ ë˜ ë±ƒì§€ì™€ ë™ì¼í•œ ë°©ì‹)
    const studentKeys = logs.map(log => ({ grade: log.grade, name: log.name }));
    const userList = await User.find({
      $or: studentKeys
    }).select('grade name school academyName').lean();

    // í•™êµ ì •ë³´ ë§¤í•‘
    const schoolMap = {};
    userList.forEach(user => {
      const key = `${user.grade}_${user.name}`;
      schoolMap[key] = user.school || user.academyName || '';
    });

    // logsì— í•™êµ ì •ë³´ ì¶”ê°€
    logs = logs.map(log => ({
      ...log,
      school: schoolMap[`${log.grade}_${log.name}`] || log.school || ''
    }));

    res.json({ success: true, logs });
  } catch (err) {
    console.error("í˜•ì„±í‰ê°€ í†µê³¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ ê°œë³„ ì‚­ì œ (í•´ë‹¹ í•™ìƒì˜ ëª¨ë“  ê¸°ë¡ ì†Œí”„íŠ¸ ì‚­ì œ)
app.delete("/api/learning-log/admin/delete/:id", async (req, res) => {
  try {
    const { id } = req.params;

    // ë¨¼ì € í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì•„ì„œ í•™ìƒ ì •ë³´ í™•ì¸
    const log = await LearningLog.findById(id);
    if (!log) {
      return res.status(404).json({ success: false, error: 'í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
    }

    // í•´ë‹¹ í•™ìƒì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œ ì²˜ë¦¬ (ê°™ì€ grade + name)
    const result = await LearningLog.updateMany(
      { grade: log.grade, name: log.name },
      { deleted: true }
    );

    res.json({ success: true, message: `${result.modifiedCount}ê°œ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ` });
  } catch (err) {
    console.error("í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ ì¼ê´„ ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ)
app.post("/api/learning-log/admin/bulk-delete", async (req, res) => {
  try {
    const { ids } = req.body;

    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ success: false, error: 'ì‚­ì œí•  ID ëª©ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤' });
    }

    const result = await LearningLog.updateMany(
      { _id: { $in: ids } },
      { deleted: true }
    );

    res.json({
      success: true,
      message: `${result.modifiedCount}ê±´ ì‚­ì œ ì™„ë£Œ`
    });
  } catch (err) {
    console.error("í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ ì¼ê´„ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ ìˆ˜ì •
app.put("/api/learning-log/admin/update/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const { grade, name, unit, series } = req.body;

    const result = await LearningLog.findByIdAndUpdate(
      id,
      {
        ...(grade && { grade }),
        ...(name && { name }),
        ...(unit && { unit }),
        ...(series && { series })
      },
      { new: true }
    );

    if (!result) {
      return res.status(404).json({ success: false, error: 'í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
    }

    res.json({ success: true, log: result });
  } catch (err) {
    console.error("í˜•ì„±í‰ê°€ í†µê³¼ ê¸°ë¡ ìˆ˜ì • ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ============================================
// ğŸ“¢ í™•ì„±ê¸° ë©”ì‹œì§€ API (ì‘ì› ë©”ì‹œì§€)
// ============================================

// í™•ì„±ê¸° ë©”ì‹œì§€ ë³´ë‚´ê¸° (ì½”ì¸ ì°¨ê°)
app.post("/api/megaphone/send", async (req, res) => {
  console.log("ğŸ“¢ í™•ì„±ê¸° API í˜¸ì¶œë¨:", req.body);
  try {
    const { phone, grade, name, school, message } = req.body;
    const MEGAPHONE_COST = 200; // í™•ì„±ê¸° ë¹„ìš©

    if (!grade || !name || !message) {
      return res.status(400).json({ success: false, error: 'í•™ë…„, ì´ë¦„, ë©”ì‹œì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤' });
    }

    if (message.length > 100) {
      return res.status(400).json({ success: false, error: 'ë©”ì‹œì§€ëŠ” 100ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”' });
    }

    // í•œêµ­ì–´ ë¹„ì†ì–´ ë³€í˜•ì–´ í•„í„° (ì´ˆì„±, ë³€í˜• íŒ¨í„´) - í™•ì¥íŒ
    const koreanBadWordPatterns = [
      // ===== ì¡´ë‚˜/ì¡¸ë¼/ì¡´ë‚´ =====
      /[ì¡´ì¡¸][ë‚˜ë¼ë‚´]/gi,
      /ã…ˆã„´/g,
      /[jJ][oO0][nN][nN]?[aA]/gi,

      // ===== ì‹œë°œ/ì”¨ë°œ/ì‹œë°”/ì”¨ë°” =====
      /[ì‹œì”¨ì‰¬ì‹€ìŠˆì“”][ë°œë¹¨ë²ŒíŒ”ë¶ˆ]/gi,
      /[ì‹œì”¨ì‰¬ì‹€ìŠˆì“”][ë°”ë¹ íŒŒë¶€]/gi,
      /[sS][iI1][bB][aA][lL]?/gi,
      /ã……ã…‚/g,
      /ã…†ã…‚/g,

      // ===== ë³‘ì‹  =====
      /[ë³‘ë¼ë²™][ì‹ ì”¬ì‹„sin]/gi,
      /ã…‚ã……/g,
      /ã…„/g,

      // ===== ì§€ë„ =====
      /[ì§€ì¥ì°Œ][ë„ë¼ëŸ´ë¡¤]/gi,
      /ã…ˆã„¹/g,

      // ===== ê°œìƒˆë¼/ê°œì†Œë¦¬/ê°œê°™ =====
      /ê°œ[ìƒˆìŒ”ì„¸ìŒ][ë¼í‚¤ë‚‘êº¼]/gi,
      /ê°œ[ì†Œì˜][ë¦¬ë¤¼]/gi,
      /ê°œ[ê°™ê°—]/gi,
      /ã„±ã……ã„²/g,

      // ===== ì¢†/ì¢‡ =====
      /[ì¢†ì¢ƒì¡·ì£³ì¢‡ë]/g,
      /ã…ˆã…‡ã…Œ/g,
      /ã…ˆã…/g,

      // ===== ì”¹/ì‹­ =====
      /[ì”¹ì”¨ì”Œì‹­][ìƒˆì„¸ìŒ”ìŒ]/gi,
      /[ì”¹ì‹­][ì°½ë•]/gi,
      /ã…†ã…‚/g,

      // ===== ëŠê¸ˆë§ˆ/ë‹ˆë¯¸/ì—ë¯¸ =====
      /ëŠ[ê¸ˆë”ê·¬][ë§ˆë¹ ]/gi,
      /ã„´ã„±ã…/g,
      /ë‹ˆ[ì• ì—][ë¯¸ë¹„]/gi,
      /ë‹ˆ[ì—„ì—…][ë§ˆë¹ ]/gi,
      /ì—[ë¯¸ë¹„]ì•¼/gi,
      /[ë‹ˆë„¤]ë¯¸[ëŸ´ë„]/gi,

      // ===== ì…/ìŒ =====
      /[ì…ìŒì”…]/g,

      // ===== êº¼ì ¸/ë‹¥ì³ =====
      /êº¼[ì ¸ì €ìª„ì£ ]/gi,
      /ë‹¥[ì³ì²˜ì³]/gi,
      /ì…ë‹¥/gi,

      // ===== ì£½ì–´/ë’¤ì ¸ =====
      /[ì£½ì¥¬ì¤˜][ì–´ì–´ë¼ì„]/gi,
      /ë’¤[ì ¸ì €ìª„ì§ˆ]/gi,
      /[ë””ë’ˆ]ì ¸/gi,

      // ===== ë¯¸ì¹œ =====
      /[ë¯¸]ì¹œ[ë†ˆë…„ìƒˆë¼]/gi,
      /ë¯¸[ì³¤ì¹œ][ì–´ëƒë‹ˆ]/gi,
      /ã…ã…Š/g,

      // ===== ë˜ë¼ì´/ëŒì•„ì´ =====
      /[ë˜ë˜ëŒ][ë¼ë¼ì•„][ì´ì´]/gi,
      /ã„¸ã„¹ã…‡/g,

      // ===== ì°ë”°/ì°ì°Œ =====
      /[ì°ì°][ë”°ë‹¤ë¹ ]/gi,
      /[ì°ì§„][ì°Œì§€]/gi,

      // ===== í•œë‚¨/í•œë…€ (í˜ì˜¤ í‘œí˜„) =====
      /í•œ[ë‚¨ë…€][ì¶©ë†ˆë…„]/gi,

      // ===== ë³´ì§€/ìì§€ =====
      /[ë³´ë½€][ì§€ì¥]/gi,
      /[ìì§œ][ì§€ì¥]/gi,

      // ===== ê±¸ë ˆ/ì°½ë…€ =====
      /[ê±¸ê²”][ë ˆë˜]/gi,
      /ì°½[ë…€ë†ˆ]/gi,

      // ===== ê¸°íƒ€ ìš•ì„¤ =====
      /[ì• ì—]ì/gi,
      /ì• [ë¹„ë¯¸]ì—†/gi,
      /í˜¸[êµ¬ëª¨]/gi,
      /ë¹¡[ì³ì¹˜ëŒ€]/gi,
      /ë¹¡ì¹˜[ë„¤ëƒê³ ëŠ”]/gi,
      /ë¹ [ê°€ê¾¸]/gi,
      /ë“±[ì‹ ë”±]/gi,
      /[ìƒˆìŒ”][ë¼í‚¤]ì•¼/gi,
      /[ë…„ë†ˆ]ì•„/gi,
      /[ë³‘ë¹™]ë”±/gi,
      /ë©[ì²­í……]/gi,
      /ë°”[ë³´ë´‰]/gi,
      /[ë¸…ë¹™]ì‹ /gi,
      /[ì— ì•°]ì°½/gi,
      /ì• [ë¯¸ë¹„]ë’¤/gi,
      /[ì„¹ì…ì…][ìŠ¤ì“°]/gi,
      /ã……ã……/g,
      /[fF][uU][cC][kK]/gi,
      /[sS][hH][iI][tT]/gi,
      /[bB][iI][tT][cC][hH]/gi,
      /[aA][sS][sS][hH]?[oO0]?[lL]?[eE]?/gi,
      /[dD][aA][mM][nN]/gi
    ];

    const messageNormalized = message.replace(/\s+/g, ''); // ê³µë°± ì œê±°í•˜ì—¬ ê²€ì‚¬
    for (const pattern of koreanBadWordPatterns) {
      if (pattern.test(messageNormalized)) {
        console.log("ğŸš« í•œêµ­ì–´ ë³€í˜• ë¹„ì†ì–´ ì°¨ë‹¨:", message);
        return res.status(400).json({
          success: false,
          error: 'ë¶€ì ì ˆí•œ í‘œí˜„ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.'
        });
      }
    }

    // OpenAI Moderation APIë¡œ ë¹„ì†ì–´/ë¶€ì ì ˆí•œ ë‚´ìš© ê²€ì‚¬
    try {
      const moderationResponse = await fetch('https://api.openai.com/v1/moderations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
        },
        body: JSON.stringify({ input: message })
      });

      const moderationResult = await moderationResponse.json();

      if (moderationResult.results && moderationResult.results[0]?.flagged) {
        console.log("ğŸš« ë¶€ì ì ˆí•œ ë©”ì‹œì§€ ì°¨ë‹¨:", message);
        return res.status(400).json({
          success: false,
          error: 'ë¶€ì ì ˆí•œ í‘œí˜„ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.'
        });
      }
    } catch (moderationError) {
      console.error("Moderation API ì˜¤ë¥˜:", moderationError);
      // API ì˜¤ë¥˜ ì‹œì—ë„ ê³„ì† ì§„í–‰ (ì„ íƒì ìœ¼ë¡œ ì°¨ë‹¨í•  ìˆ˜ë„ ìˆìŒ)
    }

    // ì‚¬ìš©ì ì¡°íšŒ (grade + nameìœ¼ë¡œ ê²€ìƒ‰)
    console.log("ğŸ“¢ ì‚¬ìš©ì ì¡°íšŒ ì‹œì‘:", { grade, name });
    const user = await UserProgress.findOne({ grade, name });
    console.log("ğŸ“¢ ì‚¬ìš©ì ì¡°íšŒ ê²°ê³¼:", user ? "ì°¾ìŒ" : "ì—†ìŒ");
    if (!user) {
      return res.status(404).json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
    }

    // ì½”ì¸ ì”ì•¡ í™•ì¸ (totalCoins - usedCoins = ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ì¸)
    const totalCoins = user.vocabularyQuiz?.totalCoins || 0;
    const usedCoins = user.vocabularyQuiz?.usedCoins || 0;
    const availableCoins = totalCoins - usedCoins;
    if (availableCoins < MEGAPHONE_COST) {
      return res.status(400).json({
        success: false,
        error: `ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬: ${availableCoins}ì½”ì¸, í•„ìš”: ${MEGAPHONE_COST}ì½”ì¸)`
      });
    }

    // 24ì‹œê°„ í›„ ë§Œë£Œ ì‹œê°„ ê³„ì‚°
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);

    // í™•ì„±ê¸° ë©”ì‹œì§€ ì €ì¥
    const megaphoneMsg = new MegaphoneMessage({
      senderPhone: phone || '',
      senderName: name || 'í•™ìƒ',
      senderSchool: school || user.school || '',
      senderGrade: grade || '',
      message: message,
      coinUsed: MEGAPHONE_COST,
      expiresAt: expiresAt
    });
    await megaphoneMsg.save();

    // ì½”ì¸ ì°¨ê° (usedCoins ì¦ê°€ ë°©ì‹)
    await UserProgress.updateOne(
      { grade, name },
      { $inc: { 'vocabularyQuiz.usedCoins': MEGAPHONE_COST } }
    );

    res.json({
      success: true,
      message: 'ì‘ì› ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!',
      remainingCoins: availableCoins - MEGAPHONE_COST,
      expiresAt: expiresAt
    });

  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// í™œì„± í™•ì„±ê¸° ë©”ì‹œì§€ ì¡°íšŒ (Live ë°°ë„ˆìš©)
app.get("/api/megaphone/active", async (req, res) => {
  try {
    // 24ì‹œê°„ ì´ë‚´ ìƒì„±ëœ ë©”ì‹œì§€ ì¡°íšŒ (ìµœì‹  1ê°œë§Œ)
    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
    const messages = await MegaphoneMessage.find({
      createdAt: { $gt: oneDayAgo }
    }).sort({ createdAt: -1 }).limit(1);

    const feeds = messages.map(msg => {
      // ì´ë¦„ ë§ˆìŠ¤í‚¹ (ì˜ˆ: ë°•ë¯¼ìˆ˜ â†’ ë°•â—‹ìˆ˜)
      const name = msg.senderName || 'í•™ìƒ';
      const maskedName = name.length >= 2
        ? name.charAt(0) + 'â—‹' + name.slice(-1)
        : name;

      return {
        type: 'megaphone',
        message: `â¤ï¸ ${msg.senderGrade} ${maskedName}: "${msg.message}"`,
        timestamp: msg.createdAt,
        expiresAt: msg.expiresAt
      };
    });

    res.json({ success: true, feeds });
  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ============================================
// ğŸ“¢ í™•ì„±ê¸° ê´€ë¦¬ì API (ìŠˆí¼ê´€ë¦¬ì ì „ìš©)
// ============================================

// í™•ì„±ê¸° ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ì)
app.get("/api/megaphone/admin/list", requireSuperAdmin, async (req, res) => {
  try {
    const messages = await MegaphoneMessage.find({ deleted: { $ne: true } })
      .sort({ createdAt: -1 })
      .lean();

    // í•„ë“œëª… ë³€í™˜ (senderGrade -> grade, senderName -> name ë“±)
    const formattedMessages = messages.map(msg => ({
      _id: msg._id,
      grade: msg.senderGrade || '',
      name: msg.senderName || '',
      message: msg.message,
      coinsUsed: msg.coinUsed || 0,
      type: msg.type || 'megaphone',
      expiresAt: msg.expiresAt,
      createdAt: msg.createdAt
    }));

    res.json({ ok: true, messages: formattedMessages });
  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// í™•ì„±ê¸° ë©”ì‹œì§€ ì¶”ê°€ (ê´€ë¦¬ì ê³µì§€ìš©)
app.post("/api/megaphone/admin/add", requireSuperAdmin, async (req, res) => {
  try {
    const { type, grade, name, message, coinsUsed } = req.body;

    if (!message || message.trim().length === 0) {
      return res.status(400).json({ ok: false, error: "ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    const newMessage = new MegaphoneMessage({
      senderGrade: grade || '',
      senderName: name || 'ê´€ë¦¬ì',
      message: message.trim(),
      coinUsed: coinsUsed || 0,
      type: type || 'notice',
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24ì‹œê°„ í›„
    });

    await newMessage.save();
    console.log("âœ… í™•ì„±ê¸° ë©”ì‹œì§€ ì¶”ê°€ ì™„ë£Œ:", newMessage._id);

    res.json({ ok: true, message: newMessage });
  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ì¶”ê°€ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// í™•ì„±ê¸° ë©”ì‹œì§€ ìˆ˜ì • (ê´€ë¦¬ì)
app.put("/api/megaphone/admin/:id", requireSuperAdmin, async (req, res) => {
  try {
    const { id } = req.params;
    const { type, grade, name, message, coinsUsed } = req.body;

    const updateData = {
      senderGrade: grade || '',
      senderName: name || '',
      message: message,
      coinUsed: coinsUsed || 0,
      type: type || 'megaphone'
    };

    const updated = await MegaphoneMessage.findByIdAndUpdate(id, updateData, { new: true });

    if (!updated) {
      return res.status(404).json({ ok: false, error: "ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    console.log("âœ… í™•ì„±ê¸° ë©”ì‹œì§€ ìˆ˜ì • ì™„ë£Œ:", id);
    res.json({ ok: true, message: updated });
  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ìˆ˜ì • ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// í™•ì„±ê¸° ë©”ì‹œì§€ ì¼ê´„ ì‚­ì œ (ê´€ë¦¬ì) - âš ï¸ :id ë¼ìš°íŠ¸ë³´ë‹¤ ë¨¼ì € ì •ì˜í•´ì•¼ í•¨
app.delete("/api/megaphone/admin/bulk-delete", requireSuperAdmin, async (req, res) => {
  try {
    const { ids } = req.body;

    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ ok: false, error: "ì‚­ì œí•  ë©”ì‹œì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”." });
    }

    // ì†Œí”„íŠ¸ ì‚­ì œ
    const result = await MegaphoneMessage.updateMany(
      { _id: { $in: ids } },
      { deleted: true }
    );

    console.log(`âœ… í™•ì„±ê¸° ë©”ì‹œì§€ ì¼ê´„ ì‚­ì œ ì™„ë£Œ: ${result.modifiedCount}ê°œ`);
    res.json({ ok: true, deletedCount: result.modifiedCount });
  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ì¼ê´„ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// í™•ì„±ê¸° ë©”ì‹œì§€ ì‚­ì œ (ê´€ë¦¬ì)
app.delete("/api/megaphone/admin/:id", requireSuperAdmin, async (req, res) => {
  try {
    const { id } = req.params;

    // ì†Œí”„íŠ¸ ì‚­ì œ
    const updated = await MegaphoneMessage.findByIdAndUpdate(id, { deleted: true }, { new: true });

    if (!updated) {
      return res.status(404).json({ ok: false, error: "ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    console.log("âœ… í™•ì„±ê¸° ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ:", id);
    res.json({ ok: true });
  } catch (err) {
    console.error("í™•ì„±ê¸° ë©”ì‹œì§€ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// ============================================
// ğŸ“¢ ê³µì§€ì‚¬í•­ API (Live í”¼ë“œ ë¡¤ë§ ë°°ë„ˆìš©)
// ============================================

// ê¸°ë³¸ ê³µì§€ì‚¬í•­ ëª©ë¡ (DBì— ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì´ˆê¸°í™”ìš©)
const defaultNotices = [
  { icon: 'ğŸ“š', message: '[ê³µì§€] ì–´íœ˜í•™ìŠµì€ ìµœì´ˆ 1íšŒ ì™„ë£Œ í›„ì— ì–´íœ˜ë ¥ ì§€ìˆ˜ê°€ ë°˜ì˜ë©ë‹ˆë‹¤!', order: 0 },
  { icon: 'ğŸ³', message: '[ê³µì§€] AIê³ ë˜ìŒ¤ í•˜ë£¨ ê³ ë˜ë±ƒì§€ëŠ” ë§¤ì¼ 10ë±ƒì§€ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤!', order: 1 },
  { icon: 'ğŸ¤–', message: '[ê³µì§€] í•™ìŠµì‹¤ì˜ AIì¶”ì²œê³¼ì œëŠ” ë¯¸í¡í•œ ë‹¨ì›ì„ AIê³ ë˜ìŒ¤ì´ í™•ì¸í•˜ì—¬ ë¶€ì—¬ë©ë‹ˆë‹¤!', order: 2 },
  { icon: 'ğŸ“–', message: '[ê³µì§€] ê³ ë˜ ë…ì„œ ê°ìƒë¬¸ì€ ìµœì†Œ ì›” 1íšŒ ì œì¶œì´ì§€ë§Œ ì¶”ê°€ ì œì¶œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤!', order: 3 },
  { icon: 'âœ…', message: '[ê³µì§€] ì™„ë£Œëœ í•™ìŠµê³¼ì œëŠ” ì„ ìƒë‹˜ í™•ì¸ í›„ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤!', order: 4 },
  { icon: 'ğŸ“Š', message: '[ê³µì§€] ì¢…í•©ë¦¬í¬íŠ¸ëŠ” ìµœì‹  ì™„ë£Œëœ ê³¼ì œ ìˆœìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤!', order: 5 }
];

// ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ (ê³µê°œ - ëª¨ë“  ì‚¬ìš©ì)
app.get("/api/notices", async (req, res) => {
  try {
    let notices = await Notice.find({ deleted: { $ne: true } })
      .sort({ order: 1 })
      .lean();

    // DBì— ê³µì§€ì‚¬í•­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ê³µì§€ì‚¬í•­ ìƒì„±
    if (notices.length === 0) {
      await Notice.insertMany(defaultNotices);
      notices = await Notice.find({ deleted: { $ne: true } })
        .sort({ order: 1 })
        .lean();
      console.log("âœ… ê¸°ë³¸ ê³µì§€ì‚¬í•­ ì´ˆê¸°í™” ì™„ë£Œ");
    }

    res.json({
      success: true,
      notices: notices.map(n => ({
        _id: n._id,
        icon: n.icon,
        message: n.message
      }))
    });
  } catch (err) {
    console.error("ê³µì§€ì‚¬í•­ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ììš© - ì „ì²´ ì •ë³´ í¬í•¨)
app.get("/api/notices/admin", requireSuperAdmin, async (req, res) => {
  try {
    let notices = await Notice.find({ deleted: { $ne: true } })
      .sort({ order: 1 })
      .lean();

    // DBì— ê³µì§€ì‚¬í•­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ê³µì§€ì‚¬í•­ ìƒì„±
    if (notices.length === 0) {
      await Notice.insertMany(defaultNotices);
      notices = await Notice.find({ deleted: { $ne: true } })
        .sort({ order: 1 })
        .lean();
    }

    res.json({ success: true, notices });
  } catch (err) {
    console.error("ê³µì§€ì‚¬í•­ ê´€ë¦¬ì ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ê³µì§€ì‚¬í•­ ì¶”ê°€ (ê´€ë¦¬ì)
app.post("/api/notices/admin", requireSuperAdmin, async (req, res) => {
  try {
    const { icon, message } = req.body;

    if (!icon || !message) {
      return res.status(400).json({ success: false, error: "ì•„ì´ì½˜ê³¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
    }

    // ìƒˆ ê³µì§€ì‚¬í•­ì˜ ìˆœì„œ ê³„ì‚°
    const maxOrderNotice = await Notice.findOne({ deleted: { $ne: true } })
      .sort({ order: -1 })
      .lean();
    const newOrder = maxOrderNotice ? maxOrderNotice.order + 1 : 0;

    const notice = new Notice({
      icon: icon.trim(),
      message: message.trim(),
      order: newOrder
    });

    await notice.save();
    console.log("âœ… ê³µì§€ì‚¬í•­ ì¶”ê°€ ì™„ë£Œ:", notice._id);
    res.json({ success: true, notice });
  } catch (err) {
    console.error("ê³µì§€ì‚¬í•­ ì¶”ê°€ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ê³µì§€ì‚¬í•­ ìˆ˜ì • (ê´€ë¦¬ì)
app.put("/api/notices/admin/:id", requireSuperAdmin, async (req, res) => {
  try {
    const { id } = req.params;
    const { icon, message } = req.body;

    const updated = await Notice.findByIdAndUpdate(
      id,
      { icon: icon.trim(), message: message.trim() },
      { new: true }
    );

    if (!updated) {
      return res.status(404).json({ success: false, error: "ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    console.log("âœ… ê³µì§€ì‚¬í•­ ìˆ˜ì • ì™„ë£Œ:", id);
    res.json({ success: true, notice: updated });
  } catch (err) {
    console.error("ê³µì§€ì‚¬í•­ ìˆ˜ì • ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ê³µì§€ì‚¬í•­ ì‚­ì œ (ê´€ë¦¬ì)
app.delete("/api/notices/admin/:id", requireSuperAdmin, async (req, res) => {
  try {
    const { id } = req.params;

    // ì†Œí”„íŠ¸ ì‚­ì œ
    const updated = await Notice.findByIdAndUpdate(id, { deleted: true }, { new: true });

    if (!updated) {
      return res.status(404).json({ success: false, error: "ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    console.log("âœ… ê³µì§€ì‚¬í•­ ì‚­ì œ ì™„ë£Œ:", id);
    res.json({ success: true });
  } catch (err) {
    console.error("ê³µì§€ì‚¬í•­ ì‚­ì œ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

// ============================================
// ğŸ“¢ ëª¨ì˜ê³ ì‚¬ í™œë™ í”¼ë“œ API (Live ë¡¤ë§ ë°°ë„ˆìš©)
// ============================================
app.get("/api/mock-exam-activity-feed", async (req, res) => {
  try {
    const feeds = [];

    // ì ìˆ˜ì—ì„œ ë“±ê¸‰ í…ìŠ¤íŠ¸ ê³„ì‚° í•¨ìˆ˜
    const getGradeText = (score) => {
      if (score >= 97) return '1ë“±ê¸‰ ìƒ';
      if (score >= 94) return '1ë“±ê¸‰ ì¤‘';
      if (score >= 91) return '1ë“±ê¸‰ í•˜';
      if (score >= 88) return '2ë“±ê¸‰ ìƒ';
      if (score >= 85) return '2ë“±ê¸‰ ì¤‘';
      if (score >= 82) return '2ë“±ê¸‰ í•˜';
      return null; // 2ë“±ê¸‰ í•˜ ë¯¸ë§Œì€ í‘œì‹œ ì•ˆí•¨
    };

    // ëª¨ì˜ê³ ì‚¬ ê²°ê³¼ - í•™ìƒë³„ ìµœì‹  1ê±´ë§Œ (2ë“±ê¸‰ í•˜ ì´ìƒë§Œ)
    const examResults = await MockExamResult.aggregate([
      { $match: { score: { $gte: 82 } } }, // 2ë“±ê¸‰ í•˜ ì´ìƒë§Œ
      { $sort: { createdAt: -1 } },
      { $group: {
        _id: '$studentInfo.phoneNumber',
        latestResult: { $first: '$$ROOT' }
      }},
      { $replaceRoot: { newRoot: '$latestResult' } },
      { $sort: { createdAt: -1 } }
    ]);

    examResults.forEach(result => {
      const gradeText = getGradeText(result.score);
      if (!gradeText) return; // 2ë“±ê¸‰ í•˜ ë¯¸ë§Œ ì œì™¸

      // ì´ë¦„ ë§ˆìŠ¤í‚¹ (ì˜ˆ: ë°•ë¯¼ìˆ˜ â†’ ë°•â—‹ìˆ˜)
      const studentName = result.studentInfo?.studentName || 'í•™ìƒ';
      const maskedName = studentName.length >= 2
        ? studentName.charAt(0) + 'â—‹' + studentName.slice(-1)
        : studentName;

      const schoolName = result.studentInfo?.schoolName || '';
      const grade = result.studentInfo?.grade || '';
      const examTitle = result.examTitle || 'ëª¨ì˜ê³ ì‚¬';

      feeds.push({
        type: 'grade',
        message: `${schoolName} ${grade} ${maskedName} í•™ìƒì´ ${examTitle} '${gradeText}' ì¶•í•˜í•©ë‹ˆë‹¤`,
        timestamp: result.createdAt
      });
    });

    // ì‹œê°„ìˆœ ì •ë ¬
    feeds.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    res.json({ success: true, feeds });
  } catch (err) {
    console.error("ëª¨ì˜ê³ ì‚¬ í™œë™ í”¼ë“œ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});
  })
  .catch((err) => {
    console.error("âŒ MongoDB ì—°ê²° ì‹¤íŒ¨:", err);
  });